{
  "domainNumber": "09",
  "domainName": "Notification Service",
  "manifestFile": "domain-09-notification.tasks",
  "promptPrefix": "d09",
  "modulePath": "apps/api/src/domains/notification",
  "sections": [
    {
      "title": "Domain 9: Notification Service — Shared Types & Constants",
      "tasks": [
        {
          "id": "D09-001",
          "description": "Notification constants: event types, priorities, channels, digest modes, delivery statuses, retry schedule, audit actions",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/notification.constants.ts` with all notification constants:",
            "",
            "**NotificationPriority enum:** URGENT, HIGH, MEDIUM, LOW",
            "",
            "**NotificationChannel enum:** IN_APP, EMAIL, PUSH (Push is Phase 2, include for forward compatibility)",
            "",
            "**DigestMode enum:** IMMEDIATE, DAILY_DIGEST, WEEKLY_DIGEST",
            "",
            "**EmailDeliveryStatus enum:** QUEUED, SENT, DELIVERED, BOUNCED, FAILED",
            "",
            "**Event catalogue — Claim Lifecycle (Domain 4, 13 events):**",
            "- CLAIM_VALIDATED (LOW, in-app only)",
            "- CLAIM_FLAGGED (MEDIUM, in-app only)",
            "- DEADLINE_7_DAY (MEDIUM, in-app + email)",
            "- DEADLINE_3_DAY (HIGH, in-app + email)",
            "- DEADLINE_1_DAY (URGENT, in-app + email)",
            "- DEADLINE_EXPIRED (HIGH, in-app + email)",
            "- BATCH_ASSEMBLED (LOW, in-app only)",
            "- BATCH_SUBMITTED (MEDIUM, in-app + email)",
            "- BATCH_ERROR (URGENT, in-app + email)",
            "- CLAIM_ASSESSED (LOW, in-app only)",
            "- CLAIM_REJECTED (HIGH, in-app + email)",
            "- CLAIM_PAID (LOW, in-app only)",
            "- DUPLICATE_DETECTED (MEDIUM, in-app only)",
            "",
            "**Intelligence Engine (Domain 7, 3 events):**",
            "- AI_SUGGESTION_READY (LOW, in-app only)",
            "- AI_HIGH_VALUE_SUGGESTION (HIGH, in-app + email)",
            "- SOMB_CHANGE_IMPACT (MEDIUM, in-app + email)",
            "",
            "**Provider Management (Domain 5, 5 events):**",
            "- DELEGATE_INVITED (MEDIUM, in-app + email)",
            "- DELEGATE_ACCEPTED (MEDIUM, in-app + email)",
            "- DELEGATE_REVOKED (HIGH, in-app + email)",
            "- BA_STATUS_CHANGED (HIGH, in-app + email)",
            "- RRNP_RATE_CHANGED (MEDIUM, in-app + email)",
            "",
            "**Platform Operations (5 events):**",
            "- PAYMENT_FAILED (URGENT, in-app + email)",
            "- PAYMENT_RECOVERED (HIGH, in-app + email)",
            "- ACCOUNT_SUSPENDED (URGENT, in-app + email)",
            "- ACCOUNT_REACTIVATED (HIGH, in-app + email)",
            "- MAINTENANCE_SCHEDULED (MEDIUM, in-app + email)",
            "",
            "**Analytics (Domain 8, 2 events):**",
            "- REPORT_READY (MEDIUM, in-app + email)",
            "- DATA_EXPORT_READY (MEDIUM, in-app + email)",
            "",
            "**Export EVENT_CATALOGUE:** frozen object mapping each event to { priority, defaultInApp, defaultEmail, category }.",
            "",
            "**Email retry schedule:** [0, 5*60*1000, 30*60*1000, 2*60*60*1000] (immediate, +5min, +30min, +2hr). Max 4 attempts.",
            "",
            "**Notification retention:** 90 days primary, 365 days archive.",
            "",
            "**Audit action identifiers:**",
            "- notification.created, notification.read, notification.read_all, notification.dismissed",
            "- notification.email_sent, notification.email_bounced, notification.email_failed",
            "- notification.preference_updated, notification.quiet_hours_updated",
            "- notification.digest_assembled, notification.event_emitted",
            "",
            "Export all as frozen objects / TypeScript enums."
          ],
          "frd": [
            "Domain 9 Section 3: Event catalogue with 28+ events across 5 categories. Each event has default in-app, email, and priority settings.",
            "Domain 9 Section 6.2: Retry schedule — 4 attempts at 0, +5min, +30min, +2hr. Hard bounces no retry. Soft bounces retry.",
            "Domain 9 Section 5.1: Notification retention 90 days primary."
          ]
        },
        {
          "id": "D09-002",
          "description": "Drizzle schema for notifications table",
          "verify": "pnpm --filter shared build",
          "depends": ["D09-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/notification.schema.ts` with the notifications table.",
            "",
            "**notifications table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| notification_id | UUID | PK | Default: gen_random_uuid() |",
            "| recipient_id | UUID FK | NOT NULL, FK → users | Physician or delegate |",
            "| physician_context_id | UUID FK | NULLABLE, FK → providers | For delegate notifications: which physician context. Null for system-wide. |",
            "| event_type | VARCHAR(50) | NOT NULL | Event type from catalogue (e.g., 'CLAIM_REJECTED') |",
            "| priority | VARCHAR(10) | NOT NULL | URGENT, HIGH, MEDIUM, LOW |",
            "| title | VARCHAR(200) | NOT NULL | Rendered from template |",
            "| body | TEXT | NOT NULL | Rendered from template |",
            "| action_url | VARCHAR(500) | NULLABLE | URL to navigate on click |",
            "| action_label | VARCHAR(50) | NULLABLE | Button label (e.g., 'View Claim') |",
            "| metadata | JSONB | NULLABLE | Event-specific data: claim_id, batch_id, etc. |",
            "| channels_delivered | JSONB | NOT NULL | { in_app: boolean, email: boolean, push: boolean } |",
            "| read_at | TIMESTAMPTZ | NULLABLE | When read in-app. Null if unread. |",
            "| dismissed_at | TIMESTAMPTZ | NULLABLE | When dismissed (hidden from feed, retained for audit). |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Indexes:** (recipient_id, read_at) for unread count, (recipient_id, created_at DESC) for feed, (event_type, created_at) for analytics.",
            "",
            "Export table and inferred types (InsertNotification, SelectNotification)."
          ],
          "frd": [
            "Domain 9 Section 5.1: notifications table with all columns, indexes, and 90-day retention."
          ]
        },
        {
          "id": "D09-003",
          "description": "Drizzle schema for email_delivery_log and notification_templates tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D09-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/notification.schema.ts`:",
            "",
            "**email_delivery_log table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| delivery_id | UUID | PK | Default: gen_random_uuid() |",
            "| notification_id | UUID FK | NOT NULL, FK → notifications | |",
            "| recipient_email | VARCHAR(100) | NOT NULL | Email address sent to |",
            "| template_id | VARCHAR(50) | NOT NULL | Email template used |",
            "| status | VARCHAR(20) | NOT NULL, DEFAULT 'QUEUED' | QUEUED, SENT, DELIVERED, BOUNCED, FAILED |",
            "| provider_message_id | VARCHAR(100) | NULLABLE | Email provider's message ID |",
            "| sent_at | TIMESTAMPTZ | NULLABLE | |",
            "| delivered_at | TIMESTAMPTZ | NULLABLE | |",
            "| bounced_at | TIMESTAMPTZ | NULLABLE | |",
            "| bounce_reason | TEXT | NULLABLE | |",
            "| retry_count | INTEGER | NOT NULL, DEFAULT 0 | Number of retries |",
            "| next_retry_at | TIMESTAMPTZ | NULLABLE | Scheduled retry time |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Indexes:** (notification_id), (status, next_retry_at) for retry queue, (recipient_email, created_at DESC).",
            "",
            "**notification_templates table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| template_id | VARCHAR(50) | PK | Matches event_type (e.g., 'CLAIM_REJECTED') |",
            "| in_app_title | VARCHAR(200) | NOT NULL | Title template with {{variable}} placeholders |",
            "| in_app_body | TEXT | NOT NULL | Body template |",
            "| email_subject | VARCHAR(200) | NULLABLE | Null if event never sends email |",
            "| email_html_body | TEXT | NULLABLE | HTML email body template |",
            "| email_text_body | TEXT | NULLABLE | Plain-text fallback |",
            "| action_url_template | VARCHAR(500) | NULLABLE | URL template with {{claim_id}}, etc. |",
            "| action_label | VARCHAR(50) | NULLABLE | Static action button label |",
            "| variables | JSONB | NOT NULL | Array of expected variable names |",
            "| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "Export tables and inferred types."
          ],
          "frd": [
            "Domain 9 Section 5.2: email_delivery_log with status tracking, retry count, bounce handling.",
            "Domain 9 Section 5.3: notification_templates with variable substitution using {{variable}} syntax. Templates managed by dev team."
          ]
        },
        {
          "id": "D09-004",
          "description": "Drizzle schema for digest_queue and notification_preferences tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D09-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/notification.schema.ts`:",
            "",
            "**digest_queue table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| queue_id | UUID | PK | Default: gen_random_uuid() |",
            "| recipient_id | UUID FK | NOT NULL, FK → users | |",
            "| notification_id | UUID FK | NOT NULL, FK → notifications | Already created with in-app delivery |",
            "| digest_type | VARCHAR(20) | NOT NULL | DAILY or WEEKLY |",
            "| digest_sent | BOOLEAN | NOT NULL, DEFAULT false | Whether included in a digest email |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Indexes:** (recipient_id, digest_sent, digest_type) for digest assembly, (created_at) for cleanup.",
            "",
            "**notification_preferences table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| preference_id | UUID | PK | Default: gen_random_uuid() |",
            "| provider_id | UUID FK | NOT NULL, FK → providers | |",
            "| event_category | VARCHAR(50) | NOT NULL | e.g., 'claim_rejection', 'deadline_approaching' |",
            "| in_app_enabled | BOOLEAN | NOT NULL, DEFAULT true | Cannot be disabled for URGENT events |",
            "| email_enabled | BOOLEAN | NOT NULL | Default per event catalogue |",
            "| digest_mode | VARCHAR(20) | NOT NULL, DEFAULT 'IMMEDIATE' | IMMEDIATE, DAILY_DIGEST, WEEKLY_DIGEST |",
            "| quiet_hours_start | TIME | NULLABLE | Start of quiet hours (global, not per-category) |",
            "| quiet_hours_end | TIME | NULLABLE | End of quiet hours |",
            "| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Constraints:** UNIQUE(provider_id, event_category).",
            "**Indexes:** (provider_id) for loading all preferences.",
            "",
            "Export tables and inferred types."
          ],
          "frd": [
            "Domain 9 Section 4.1: notification_preferences table — per-category channel and frequency config. URGENT in-app cannot be disabled.",
            "Domain 9 Section 5.4: digest_queue holds notifications awaiting digest assembly."
          ]
        },
        {
          "id": "D09-005",
          "description": "Zod validation schemas for notification feed, preferences, and event ingestion endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D09-001"],
          "build": [
            "Create `packages/shared/src/schemas/notification.schema.ts` with Zod schemas:",
            "",
            "**Notification feed:**",
            "- notificationFeedQuerySchema: { unread_only: boolean().optional().default(false), limit: number().int().min(1).max(100).default(20), offset: number().int().min(0).default(0) }",
            "- notificationIdParamSchema: { id: string().uuid() }",
            "",
            "**Preferences:**",
            "- updatePreferenceSchema: { in_app_enabled: boolean().optional(), email_enabled: boolean().optional(), digest_mode: enum(['IMMEDIATE', 'DAILY_DIGEST', 'WEEKLY_DIGEST']).optional() }",
            "- preferenceCategoryParamSchema: { category: string().min(1).max(50) }",
            "- quietHoursSchema: { quiet_hours_start: string().regex(/^\\d{2}:\\d{2}$/).nullable(), quiet_hours_end: string().regex(/^\\d{2}:\\d{2}$/).nullable() }",
            "- Refinement: if quiet_hours_start is set, quiet_hours_end is required and vice versa. Both null to clear.",
            "",
            "**Internal event ingestion:**",
            "- emitEventSchema: { event_type: string().min(1).max(50), physician_id: string().uuid(), metadata: record(string(), unknown()).optional() }",
            "- emitBatchEventSchema: { events: array(emitEventSchema).min(1).max(500) }",
            "",
            "**Response schemas:**",
            "- notificationResponseSchema: notification object with all public fields",
            "- unreadCountResponseSchema: { count: number().int().min(0) }",
            "- preferenceResponseSchema: preference object",
            "",
            "Export all schemas and inferred types."
          ],
          "frd": [
            "Domain 9 Section 8.1: Notification feed params — unread_only, limit, offset. Ordered by created_at DESC.",
            "Domain 9 Section 8.2: Preference endpoints — per-category update, quiet hours set.",
            "Domain 9 Section 8.3: Internal emit endpoint — event_type, physician_id, metadata."
          ]
        },
        {
          "id": "D09-006",
          "description": "Generate and apply database migration for notification tables",
          "verify": "cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1",
          "depends": ["D09-002", "D09-003", "D09-004"],
          "build": [
            "Run the Drizzle migration generator for the notification tables:",
            "",
            "```bash",
            "cd apps/api",
            "pnpm drizzle-kit generate",
            "pnpm drizzle-kit migrate",
            "```",
            "",
            "Verify that the migration file was created in `apps/api/drizzle/migrations/`.",
            "Verify that all 5 tables exist: notifications, email_delivery_log, notification_templates, digest_queue, notification_preferences.",
            "Verify all indexes, constraints, and FK references resolve correctly."
          ]
        }
      ]
    },
    {
      "title": "Domain 9: Notification Service — Repository Layer",
      "tasks": [
        {
          "id": "D09-010",
          "description": "Repository: notifications CRUD (feed, read, dismiss, unread count)",
          "verify": "pnpm --filter api vitest run src/domains/notification/notification.test.ts",
          "depends": ["D09-006"],
          "build": [
            "Create `apps/api/src/domains/notification/notification.repository.ts`:",
            "",
            "**Notification operations:**",
            "- `createNotification(data: InsertNotification)` — insert notification record. Return created notification.",
            "- `createNotificationsBatch(data: InsertNotification[])` — bulk insert for batch event emission. Return created count.",
            "- `findNotificationById(notificationId: string, recipientId: string)` — find notification scoped to recipient.",
            "- `listNotifications(recipientId: string, opts: { unreadOnly?: boolean, limit: number, offset: number })` — paginated feed in reverse chronological order. Exclude dismissed notifications from default feed.",
            "- `countUnread(recipientId: string)` — count notifications where read_at is null and dismissed_at is null.",
            "- `markRead(notificationId: string, recipientId: string)` — set read_at = now(). Scoped to recipient.",
            "- `markAllRead(recipientId: string)` — set read_at = now() on all unread notifications for recipient.",
            "- `dismiss(notificationId: string, recipientId: string)` — set dismissed_at = now(). Scoped to recipient.",
            "",
            "All queries scoped by recipient_id. No cross-user access."
          ],
          "security": [
            "All notification queries are strictly scoped to recipient_id — no cross-user notification access.",
            "markRead and dismiss verify ownership via recipient_id before updating.",
            "Dismissed notifications are retained for audit (soft-hide, not delete)."
          ],
          "tests": [
            "createNotification inserts with correct fields",
            "createNotificationsBatch inserts multiple notifications",
            "findNotificationById returns notification for correct recipient",
            "findNotificationById returns null for wrong recipient",
            "listNotifications returns reverse chronological order",
            "listNotifications with unreadOnly filters to unread",
            "listNotifications excludes dismissed notifications",
            "listNotifications paginates correctly",
            "countUnread returns correct count",
            "countUnread excludes dismissed notifications",
            "markRead sets read_at timestamp",
            "markRead scoped to recipient (fails silently for wrong recipient)",
            "markAllRead marks all unread as read",
            "dismiss sets dismissed_at timestamp"
          ]
        },
        {
          "id": "D09-011",
          "description": "Repository: email delivery log, notification templates",
          "verify": "pnpm --filter api vitest run src/domains/notification/notification.test.ts",
          "depends": ["D09-006"],
          "build": [
            "Add to `apps/api/src/domains/notification/notification.repository.ts`:",
            "",
            "**Email delivery log:**",
            "- `createDeliveryLog(data: InsertEmailDeliveryLog)` — insert delivery record.",
            "- `updateDeliveryStatus(deliveryId: string, status: string, details?: { providerMessageId?, sentAt?, deliveredAt?, bouncedAt?, bounceReason? })` — update status and relevant timestamps.",
            "- `findPendingRetries()` — find delivery records where status IN ('QUEUED', 'FAILED') AND next_retry_at <= now() AND retry_count < 4. For retry job.",
            "- `incrementRetry(deliveryId: string, nextRetryAt: Date)` — increment retry_count, set next_retry_at.",
            "- `listDeliveryLogByNotification(notificationId: string)` — return delivery attempts for a notification.",
            "",
            "**Notification templates:**",
            "- `findTemplateById(templateId: string)` — return template or null.",
            "- `listAllTemplates()` — return all templates (for admin/dev use).",
            "- `upsertTemplate(data: InsertNotificationTemplate)` — insert or update template by template_id."
          ],
          "security": [
            "Email delivery log contains recipient_email — access restricted to internal services and admin.",
            "Templates are managed by dev team only. No physician-facing mutation endpoints."
          ],
          "tests": [
            "createDeliveryLog inserts record with QUEUED status",
            "updateDeliveryStatus transitions from QUEUED to SENT",
            "updateDeliveryStatus sets bounced_at and bounce_reason on BOUNCED",
            "findPendingRetries returns records where retry is due",
            "findPendingRetries excludes records at max retry count",
            "incrementRetry increases count and sets next_retry_at",
            "findTemplateById returns template for valid ID",
            "findTemplateById returns null for unknown template",
            "upsertTemplate inserts new template",
            "upsertTemplate updates existing template"
          ]
        },
        {
          "id": "D09-012",
          "description": "Repository: digest queue and notification preferences",
          "verify": "pnpm --filter api vitest run src/domains/notification/notification.test.ts",
          "depends": ["D09-006"],
          "build": [
            "Add to `apps/api/src/domains/notification/notification.repository.ts`:",
            "",
            "**Digest queue:**",
            "- `addToDigestQueue(data: { recipientId, notificationId, digestType })` — insert queue entry.",
            "- `findPendingDigestItems(recipientId: string, digestType: string)` — find items where digest_sent = false for this recipient and type.",
            "- `findAllPendingDigestItems(digestType: string)` — find all unsent items for this digest type, grouped by recipient_id. For scheduled digest job.",
            "- `markDigestItemsSent(queueIds: string[])` — set digest_sent = true for batch of queue items.",
            "",
            "**Notification preferences:**",
            "- `findPreferencesByProvider(providerId: string)` — return all preferences for this provider.",
            "- `findPreference(providerId: string, eventCategory: string)` — return specific preference or null.",
            "- `upsertPreference(providerId: string, eventCategory: string, data: Partial<InsertNotificationPreference>)` — insert or update preference.",
            "- `createDefaultPreferences(providerId: string)` — bulk insert default preferences based on EVENT_CATALOGUE defaults. Called during onboarding.",
            "- `updateQuietHours(providerId: string, start: string | null, end: string | null)` — update quiet hours on all preferences for this provider."
          ],
          "security": [
            "Preferences are scoped to provider_id — no cross-physician preference access.",
            "createDefaultPreferences must enforce URGENT in-app cannot be disabled."
          ],
          "tests": [
            "addToDigestQueue inserts queue entry",
            "findPendingDigestItems returns unsent items for recipient",
            "findAllPendingDigestItems groups by recipient",
            "markDigestItemsSent sets digest_sent true",
            "findPreferencesByProvider returns all preferences for provider",
            "findPreference returns specific category preference",
            "upsertPreference creates new preference",
            "upsertPreference updates existing preference",
            "createDefaultPreferences creates entries for all event categories",
            "updateQuietHours sets start and end on all preferences"
          ]
        }
      ]
    },
    {
      "title": "Domain 9: Notification Service — Service Layer",
      "tasks": [
        {
          "id": "D09-020",
          "description": "Service: event processing pipeline — receive, resolve recipients, check preferences, render, create",
          "verify": "pnpm --filter api vitest run src/domains/notification/notification.test.ts",
          "depends": ["D09-010", "D09-011", "D09-012"],
          "build": [
            "Create `apps/api/src/domains/notification/notification.service.ts` with the event processing pipeline:",
            "",
            "- `processEvent(event: { eventType: string, physicianId: string, metadata?: Record<string, unknown> })` — main pipeline entry point. Orchestrates all steps below. Emit notification.event_emitted audit event.",
            "",
            "**Step 1 — Recipient resolution:**",
            "- `resolveRecipients(physicianId: string, eventType: string)` — primary recipient: the physician's user_id. Secondary: active delegates linked to this physician whose permissions include the relevant capability for this event type. Uses permission-to-event mapping (e.g., CLAIM_VIEW permission → receives claim events). Return array of { userId, isDelegate, physicianContextId }.",
            "",
            "**Step 2 — Preference check (per recipient):**",
            "- `checkPreferences(recipientProviderId: string, eventType: string)` — look up preferences for event category. Return { inAppEnabled, emailEnabled, digestMode }. For URGENT events: in_app always true regardless of preference.",
            "",
            "**Step 3 — Template rendering:**",
            "- `renderNotification(templateId: string, variables: Record<string, unknown>)` — load template by event_type. Substitute {{variables}} in title, body, email subject/body, and action_url_template. Escape all variable values to prevent template injection. Return rendered content.",
            "",
            "**Step 4 — Notification creation (per recipient):**",
            "- Create notification record via repository. Set channels_delivered based on preference check results.",
            "- If email enabled and digest mode IMMEDIATE: queue for email delivery.",
            "- If email enabled and digest mode DAILY_DIGEST or WEEKLY_DIGEST: add to digest queue.",
            "- Return created notification (for WebSocket push).",
            "",
            "- `processEventBatch(events: EmitEvent[])` — process multiple events efficiently (for batch submission)."
          ],
          "frd": [
            "Domain 9 Section 6.1: Pipeline steps — event received, recipient resolution, preference check, template rendering, notification creation, in-app delivery, email routing, delivery tracking.",
            "Domain 9 Section 4.3: Delegate notifications filtered by permissions. Permission-to-event mapping.",
            "Domain 9 Section 4.2: Default preferences — URGENT in-app always on, HIGH/MEDIUM email on, LOW email off with daily digest."
          ],
          "security": [
            "Template variables are escaped before rendering — prevents XSS via event metadata.",
            "Recipient resolution respects delegate permission boundaries — no notifications for capabilities outside delegate scope.",
            "URGENT in-app notifications cannot be suppressed by preferences — safety-critical events always visible."
          ],
          "tests": [
            "processEvent creates notification for physician",
            "processEvent creates notification for delegate with matching permission",
            "processEvent skips delegate without matching permission",
            "resolveRecipients returns physician and relevant delegates",
            "resolveRecipients excludes inactive delegates",
            "checkPreferences returns defaults for unconfigured category",
            "checkPreferences enforces URGENT in-app always enabled",
            "renderNotification substitutes variables correctly",
            "renderNotification escapes HTML in variable values",
            "renderNotification with missing variable throws error",
            "processEvent with IMMEDIATE digest mode queues email",
            "processEvent with DAILY_DIGEST mode adds to digest queue",
            "processEventBatch creates notifications for multiple events"
          ]
        },
        {
          "id": "D09-021",
          "description": "Service: email delivery, retry logic, quiet hours, bounce handling",
          "verify": "pnpm --filter api vitest run src/domains/notification/notification.test.ts",
          "depends": ["D09-011", "D09-020"],
          "build": [
            "Add to `apps/api/src/domains/notification/notification.service.ts`:",
            "",
            "**Email delivery:**",
            "- `sendEmail(notificationId: string, recipientEmail: string, rendered: RenderedEmail)` — create delivery log entry. Send via Postmark API. Update status to SENT. On success: update to DELIVERED when webhook confirms. On failure: schedule retry.",
            "",
            "**Quiet hours enforcement:**",
            "- `isInQuietHours(providerId: string)` — check if current time (MT timezone) falls within provider's quiet hours. Return boolean.",
            "- `scheduleAfterQuietHours(providerId: string)` — calculate next time after quiet hours end. Return Date.",
            "- Quiet hours check: if in quiet hours AND event priority is not URGENT → defer email until quiet hours end. URGENT events bypass quiet hours.",
            "",
            "**Retry logic:**",
            "- `retryFailedEmails()` — scheduled job. Find pending retries. For each: resend email, increment retry count. After 4 failures → status FAILED.",
            "- `handleBounce(providerMessageId: string, bounceType: 'hard' | 'soft', reason: string)` — webhook handler from email provider. Hard bounce: mark BOUNCED, no retry, create in-app notification to update email. Soft bounce: schedule retry per schedule.",
            "",
            "**Postmark integration:**",
            "- Use Postmark client. Sender: notifications@meritum.ca.",
            "- No PHI in email body. Links to authenticated pages only.",
            "- HTML email with plain-text fallback from template."
          ],
          "frd": [
            "Domain 9 Section 6.2: Retry schedule — 4 attempts. Hard bounce: no retry, notify to update email. Soft bounce: retry per schedule.",
            "Domain 9 Section 4.1: Quiet hours — non-urgent emails deferred. Start/end time configurable.",
            "Domain 9 Section 2.2: Email format — HTML with plain-text fallback. No PHI in email body.",
            "Domain 9 Section 9: No PHI in email. SPF/DKIM/DMARC for meritum.ca."
          ],
          "security": [
            "No PHI in email body — event summaries and links only. Patient names, PHNs, and claim details never in email.",
            "URGENT events bypass quiet hours — safety-critical emails always sent immediately.",
            "Postmark webhook endpoint must verify webhook signature to prevent spoofed bounce events."
          ],
          "tests": [
            "sendEmail creates delivery log with QUEUED status",
            "sendEmail updates to SENT on successful send",
            "isInQuietHours returns true during configured quiet hours",
            "isInQuietHours returns false outside quiet hours",
            "isInQuietHours returns false when no quiet hours configured",
            "non-URGENT email during quiet hours is deferred",
            "URGENT email during quiet hours is sent immediately",
            "retryFailedEmails processes pending retries",
            "retryFailedEmails marks FAILED after 4 attempts",
            "handleBounce hard bounce marks BOUNCED, creates in-app notification",
            "handleBounce soft bounce schedules retry"
          ]
        },
        {
          "id": "D09-022",
          "description": "Service: digest assembly and scheduled jobs",
          "verify": "pnpm --filter api vitest run src/domains/notification/notification.test.ts",
          "depends": ["D09-012", "D09-021"],
          "build": [
            "Add to `apps/api/src/domains/notification/notification.service.ts`:",
            "",
            "**Digest assembly:**",
            "- `assembleDailyDigest()` — scheduled job, runs at 08:00 MT daily. Find all pending DAILY digest items grouped by recipient. For each recipient: render digest email from summary template (groups notifications by category with counts). Send email. Mark items as sent. Emit notification.digest_assembled audit event.",
            "- `assembleWeeklyDigest()` — scheduled job, runs Monday at 08:00 MT. Same as daily but for WEEKLY items from past 7 days.",
            "- `renderDigestEmail(recipientId: string, items: DigestItem[])` — group items by event_type/category. Render summary template with counts and brief descriptions. Include 'View in Meritum' links. No PHI in digest email.",
            "",
            "**Thursday submission sequence:**",
            "- `sendWednesdayBatchReminder()` — scheduled job, Wednesday evening. For each physician with batch_review_reminder enabled: check if flagged claims exist. If yes: emit BATCH_REVIEW_REMINDER event with flagged claim count.",
            "- The remaining Thursday sequence events (cutoff, submitted, WCB ready, assessment, payment) are emitted by Domain 4 (Claim Lifecycle) — this service just processes them via the standard pipeline.",
            "",
            "**Job scheduling:** Use Fastify cron plugin or node-cron. Register jobs:",
            "- Daily digest: '0 8 * * *' (08:00 MT daily)",
            "- Weekly digest: '0 8 * * 1' (08:00 MT Monday)",
            "- Email retry: '*/5 * * * *' (every 5 minutes)",
            "- Wednesday reminder: '0 18 * * 3' (18:00 MT Wednesday)"
          ],
          "frd": [
            "Domain 9 Section 6.3: Daily digest at 08:00 MT, weekly digest Monday 08:00 MT. Groups by category with counts.",
            "Domain 9 Section 3.6: Thursday submission sequence — 6 coordinated notifications from Wednesday evening through Friday."
          ],
          "tests": [
            "assembleDailyDigest groups items by recipient",
            "assembleDailyDigest sends one email per recipient",
            "assembleDailyDigest marks items as sent",
            "assembleDailyDigest skips recipients with no pending items",
            "assembleWeeklyDigest processes WEEKLY items from past 7 days",
            "renderDigestEmail groups by category with counts",
            "renderDigestEmail contains no PHI",
            "sendWednesdayBatchReminder fires for physician with flagged claims and reminder enabled",
            "sendWednesdayBatchReminder skips physician with no flagged claims",
            "sendWednesdayBatchReminder skips physician with reminder disabled"
          ]
        },
        {
          "id": "D09-023",
          "description": "Service: WebSocket real-time notification delivery",
          "verify": "pnpm --filter api vitest run src/domains/notification/notification.test.ts",
          "depends": ["D09-010", "D09-020"],
          "build": [
            "Add to `apps/api/src/domains/notification/notification.service.ts`:",
            "",
            "**WebSocket manager:**",
            "- `registerConnection(userId: string, socket: WebSocket)` — add socket to connection map keyed by userId. One user may have multiple connections (multiple tabs).",
            "- `removeConnection(userId: string, socket: WebSocket)` — remove socket from connection map.",
            "- `pushToUser(userId: string, notification: NotificationPayload)` — send notification to all active WebSocket connections for this user. JSON payload with { type: 'notification', data: { notification_id, title, body, priority, action_url, event_type, metadata } }.",
            "- `pushUnreadCount(userId: string)` — send updated unread count to all connections. Payload: { type: 'unread_count', data: { count: number } }.",
            "",
            "**Integration with pipeline:**",
            "- After notification creation in processEvent: call pushToUser for each recipient who has an active WebSocket connection.",
            "- After markRead or markAllRead: call pushUnreadCount to update badge.",
            "- Notifications are always stored in DB regardless of WebSocket connection status.",
            "",
            "**WebSocket authentication:**",
            "- On connection: validate session token from cookie or query parameter.",
            "- On session expiry: disconnect WebSocket.",
            "- Heartbeat every 30 seconds to detect stale connections."
          ],
          "frd": [
            "Domain 9 Section 2.1: Real-time delivery via WebSocket. No page refresh required. Notifications stored regardless of connection.",
            "Domain 9 Section 8.1: WS /ws/notifications endpoint.",
            "Domain 9 Section 9: WebSocket connections require valid session token. Disconnected on session expiry."
          ],
          "security": [
            "WebSocket connections require valid session token — unauthenticated connections rejected immediately.",
            "WebSocket disconnected on session expiry — no stale connections receiving notifications.",
            "Notifications pushed only to connections belonging to the recipient_id — no cross-user WebSocket delivery.",
            "WebSocket payloads contain rendered content only, no raw database fields or internal IDs beyond notification_id."
          ],
          "tests": [
            "registerConnection adds socket to connection map",
            "registerConnection supports multiple connections per user",
            "removeConnection removes specific socket",
            "pushToUser delivers to all active connections for user",
            "pushToUser is no-op if user has no active connections",
            "pushUnreadCount sends updated count",
            "WebSocket rejects connection without valid session token",
            "WebSocket disconnects on session expiry"
          ]
        }
      ]
    },
    {
      "title": "Domain 9: Notification Service — Routes & Integration Tests",
      "tasks": [
        {
          "id": "D09-030",
          "description": "Routes: notification feed, read, dismiss, unread count",
          "verify": "pnpm --filter api vitest run test/integration/notification/",
          "depends": ["D09-020", "D09-023"],
          "build": [
            "Create `apps/api/src/domains/notification/notification.routes.ts` and `notification.handlers.ts`.",
            "",
            "**Routes:**",
            "",
            "| Method | Path | Auth | Description |",
            "|--------|------|------|-------------|",
            "| GET | /api/v1/notifications | Authenticated | Get notification feed. Query: unread_only, limit, offset. |",
            "| GET | /api/v1/notifications/unread-count | Authenticated | Get unread notification count (lightweight for badge). |",
            "| POST | /api/v1/notifications/:id/read | Authenticated | Mark notification as read. |",
            "| POST | /api/v1/notifications/read-all | Authenticated | Mark all notifications as read. |",
            "| POST | /api/v1/notifications/:id/dismiss | Authenticated | Dismiss notification (hide, retain for audit). |",
            "",
            "**Handler logic:**",
            "- GET /notifications: validate query params, call listNotifications scoped to authenticated user's recipient_id. For delegates: include notifications from their physician contexts.",
            "- GET /unread-count: call countUnread, return { count }.",
            "- POST /:id/read: validate UUID, call markRead scoped to recipient. Push updated unread count via WebSocket.",
            "- POST /read-all: call markAllRead. Push updated count via WebSocket.",
            "- POST /:id/dismiss: validate UUID, call dismiss scoped to recipient.",
            "",
            "Create integration tests in `apps/api/test/integration/notification/notification-feed.integration.ts`."
          ],
          "frd": [
            "Domain 9 Section 8.1: All notification feed endpoints with query params."
          ],
          "security": [
            "All feed endpoints scoped to authenticated user — no cross-user notification access.",
            "Delegates see notifications from their physician context(s) only."
          ],
          "tests": [
            "GET /notifications returns feed for authenticated user",
            "GET /notifications with unread_only=true filters unread",
            "GET /notifications respects limit and offset",
            "GET /notifications excludes dismissed notifications",
            "GET /unread-count returns correct count",
            "POST /:id/read marks notification as read",
            "POST /:id/read for other user's notification returns 404",
            "POST /read-all marks all unread as read",
            "POST /:id/dismiss hides notification from feed",
            "Delegate sees notifications from physician context"
          ]
        },
        {
          "id": "D09-031",
          "description": "Routes: notification preferences and quiet hours",
          "verify": "pnpm --filter api vitest run test/integration/notification/",
          "depends": ["D09-012"],
          "build": [
            "Add to `apps/api/src/domains/notification/notification.routes.ts`:",
            "",
            "| Method | Path | Auth | Description |",
            "|--------|------|------|-------------|",
            "| GET | /api/v1/notification-preferences | Physician | Get all preferences for the physician. |",
            "| PUT | /api/v1/notification-preferences/:category | Physician | Update preferences for a specific event category. |",
            "| PUT | /api/v1/notification-preferences/quiet-hours | Physician | Set quiet hours (start/end time or null to clear). |",
            "",
            "**Handler logic:**",
            "- GET /notification-preferences: load all preferences for authenticated physician's provider_id. Return with event catalogue defaults merged for unconfigured categories.",
            "- PUT /:category: validate category exists in EVENT_CATALOGUE. Validate body. Enforce URGENT in-app cannot be disabled (return 400). Upsert preference.",
            "- PUT /quiet-hours: validate body. Update quiet hours on all preferences for provider.",
            "",
            "**URGENT enforcement:** If request tries to set in_app_enabled = false for an URGENT event category, return 400 with error explaining URGENT in-app cannot be disabled.",
            "",
            "Create integration tests in `apps/api/test/integration/notification/notification-preferences.integration.ts`."
          ],
          "frd": [
            "Domain 9 Section 8.2: Preference endpoints.",
            "Domain 9 Section 4.2: URGENT in-app cannot be disabled."
          ],
          "security": [
            "Preferences are physician-only — delegates cannot modify notification preferences.",
            "URGENT in-app cannot be disabled — server-side enforcement regardless of client request."
          ],
          "tests": [
            "GET /notification-preferences returns all preferences",
            "GET /notification-preferences includes defaults for unconfigured categories",
            "PUT /:category updates email_enabled",
            "PUT /:category updates digest_mode",
            "PUT /:category rejects disabling in_app for URGENT event",
            "PUT /:category rejects unknown category",
            "PUT /quiet-hours sets start and end",
            "PUT /quiet-hours with null values clears quiet hours",
            "PUT /quiet-hours rejects start without end",
            "Delegate cannot access preference endpoints"
          ]
        },
        {
          "id": "D09-032",
          "description": "Routes: internal event ingestion, WebSocket endpoint, Postmark webhook",
          "verify": "pnpm --filter api vitest run test/integration/notification/",
          "depends": ["D09-020", "D09-021", "D09-023"],
          "build": [
            "Add to `apps/api/src/domains/notification/notification.routes.ts`:",
            "",
            "**Internal event ingestion (internal only, not exposed to clients):**",
            "",
            "| Method | Path | Auth | Description |",
            "|--------|------|------|-------------|",
            "| POST | /api/v1/internal/notifications/emit | Internal API key | Emit a single event. |",
            "| POST | /api/v1/internal/notifications/emit-batch | Internal API key | Emit multiple events at once. |",
            "",
            "**WebSocket endpoint:**",
            "",
            "| Method | Path | Auth | Description |",
            "|--------|------|------|-------------|",
            "| WS | /ws/notifications | Session token | Real-time notification push. |",
            "",
            "**Postmark webhook:**",
            "",
            "| Method | Path | Auth | Description |",
            "|--------|------|------|-------------|",
            "| POST | /api/v1/webhooks/postmark | Webhook signature | Handle delivery/bounce callbacks. |",
            "",
            "**Handler logic:**",
            "- POST /emit: validate body against emitEventSchema. Call processEvent. Return { notification_ids }.",
            "- POST /emit-batch: validate body. Call processEventBatch. Return { created_count }.",
            "- WS /ws/notifications: on upgrade, validate session token. Register connection. On close, remove connection. Send heartbeat every 30s.",
            "- POST /webhooks/postmark: verify webhook signature. Parse event type (delivered, bounced). Call handleBounce or update delivery status.",
            "",
            "**Internal API key auth:** emit endpoints protected by X-Internal-API-Key header, not session cookie. Key from environment variable.",
            "",
            "Create integration tests in `apps/api/test/integration/notification/notification-internal.integration.ts`."
          ],
          "frd": [
            "Domain 9 Section 8.3: Internal emit and emit-batch endpoints.",
            "Domain 9 Section 8.1: WS /ws/notifications endpoint.",
            "Domain 9 Section 6.2: Bounce handling from email provider webhooks."
          ],
          "security": [
            "Internal emit endpoints protected by API key — not accessible to client sessions.",
            "WebSocket requires valid session token — rejects unauthenticated upgrade requests.",
            "Postmark webhook verifies signature — prevents spoofed delivery/bounce events.",
            "Internal API key from environment variable — never exposed to clients."
          ],
          "tests": [
            "POST /emit with valid API key creates notification",
            "POST /emit without API key returns 401",
            "POST /emit with invalid event_type returns 400",
            "POST /emit-batch creates multiple notifications",
            "WS /ws/notifications connects with valid session",
            "WS /ws/notifications rejects without session token",
            "WS /ws/notifications receives pushed notifications",
            "POST /webhooks/postmark processes delivery confirmation",
            "POST /webhooks/postmark processes bounce event",
            "POST /webhooks/postmark rejects invalid signature"
          ]
        }
      ]
    },
    {
      "title": "Domain 9: Notification Service — Security Tests",
      "tasks": [
        {
          "id": "D09-040",
          "description": "Security: authentication enforcement on every notification route",
          "verify": "pnpm --filter api vitest run test/security/notification/notification.authn.security.ts",
          "depends": ["D09-030", "D09-031", "D09-032"],
          "build": [
            "Create `apps/api/test/security/notification/notification.authn.security.ts`.",
            "",
            "Test every authenticated route returns 401 without a valid session cookie:",
            "",
            "- GET /api/v1/notifications",
            "- GET /api/v1/notifications/unread-count",
            "- POST /api/v1/notifications/:id/read",
            "- POST /api/v1/notifications/read-all",
            "- POST /api/v1/notifications/:id/dismiss",
            "- GET /api/v1/notification-preferences",
            "- PUT /api/v1/notification-preferences/:category",
            "- PUT /api/v1/notification-preferences/quiet-hours",
            "",
            "Test internal endpoints return 401 without API key:",
            "- POST /api/v1/internal/notifications/emit without X-Internal-API-Key → 401",
            "- POST /api/v1/internal/notifications/emit-batch without X-Internal-API-Key → 401",
            "",
            "Test WebSocket rejects unauthenticated connections:",
            "- WS /ws/notifications without session token → connection rejected",
            "",
            "For each HTTP route: no cookie, expired cookie, tampered cookie. All return 401 with no data leakage."
          ],
          "security": [
            "401 responses contain only error object, no notification data.",
            "Internal API key endpoints return 401 without key, not 403.",
            "WebSocket upgrade without auth returns appropriate rejection."
          ]
        },
        {
          "id": "D09-041",
          "description": "Security: authorization and role enforcement for notification features",
          "verify": "pnpm --filter api vitest run test/security/notification/notification.authz.security.ts",
          "depends": ["D09-030", "D09-031", "D09-032"],
          "build": [
            "Create `apps/api/test/security/notification/notification.authz.security.ts`.",
            "",
            "**Preference management restricted to physicians:**",
            "- PUT /notification-preferences/:category as delegate → 403",
            "- PUT /notification-preferences/quiet-hours as delegate → 403",
            "- GET /notification-preferences as delegate → 403",
            "",
            "**Delegate notification access (positive tests):**",
            "- Delegate can access GET /notifications (sees notifications from their physician contexts)",
            "- Delegate can POST /:id/read on their own notifications",
            "- Delegate can POST /read-all on their own notifications",
            "",
            "**URGENT preference enforcement:**",
            "- PUT /notification-preferences/deadline_1_day with in_app_enabled: false → 400 (URGENT events cannot have in-app disabled)",
            "- PUT /notification-preferences/batch_error with in_app_enabled: false → 400",
            "",
            "**Internal endpoint authorization:**",
            "- POST /internal/notifications/emit with regular session cookie (no API key) → 401",
            "- POST /internal/notifications/emit with wrong API key → 401"
          ]
        },
        {
          "id": "D09-042",
          "description": "Security: cross-user notification isolation (tenant scoping)",
          "verify": "pnpm --filter api vitest run test/security/notification/notification.scoping.security.ts",
          "depends": ["D09-030", "D09-031", "D09-032"],
          "build": [
            "Create `apps/api/test/security/notification/notification.scoping.security.ts`.",
            "",
            "Create two physician accounts (physician1, physician2) using createSecurityPair fixture.",
            "",
            "**Notification feed isolation:**",
            "- Create notifications for both physicians",
            "- Physician1 GET /notifications returns only physician1's notifications",
            "- Physician1's feed never contains physician2's notifications",
            "",
            "**Read/dismiss isolation:**",
            "- Physician1 POST /:id/read on physician2's notification → 404 (not 403)",
            "- Physician1 POST /:id/dismiss on physician2's notification → 404 (not 403)",
            "",
            "**Unread count isolation:**",
            "- Physician1 unread count reflects only physician1's unread notifications",
            "",
            "**Preference isolation:**",
            "- Physician1 GET /notification-preferences returns only physician1's preferences",
            "- Physician1 updating preferences does not affect physician2's preferences",
            "",
            "**Delegate cross-context isolation:**",
            "- Delegate linked to physician1 only: receives notifications from physician1 context only",
            "- Delegate linked to both: physician1 context notifications do not leak into physician2 context",
            "",
            "**Important:** All cross-user access attempts return 404, not 403."
          ]
        },
        {
          "id": "D09-043",
          "description": "Security: input validation and injection prevention",
          "verify": "pnpm --filter api vitest run test/security/notification/notification.input.security.ts",
          "depends": ["D09-030", "D09-031", "D09-032"],
          "build": [
            "Create `apps/api/test/security/notification/notification.input.security.ts`.",
            "",
            "**SQL injection payloads:**",
            "- category param: `' OR 1=1--`",
            "- event_type in emit body: SQL injection payloads",
            "- notification_id param: SQL injection payloads",
            "",
            "**XSS payloads (template injection):**",
            "- event metadata containing `<script>alert(1)</script>` → must be escaped in rendered notification",
            "- event metadata containing `{{constructor.constructor('return this')()}}` → template injection prevention",
            "",
            "**Type coercion attacks:**",
            "- limit as string → 400 or coerced safely",
            "- offset as negative → 400",
            "- unread_only as non-boolean → 400 or coerced safely",
            "- Send array where string expected in category",
            "",
            "**UUID parameter validation:**",
            "- Non-UUID in notification id path param → 400",
            "- Non-UUID in ba_id for emit event → 400",
            "",
            "**Quiet hours validation:**",
            "- quiet_hours_start with invalid time format → 400",
            "- quiet_hours_start without quiet_hours_end → 400",
            "- quiet_hours_end: '25:00' → 400",
            "",
            "**Emit validation:**",
            "- event_type not in catalogue → 400",
            "- physician_id as non-UUID → 400",
            "- emit-batch with empty events array → 400",
            "- emit-batch with > 500 events → 400"
          ]
        },
        {
          "id": "D09-044",
          "description": "Security: data leakage prevention — no PHI in email, sanitised errors",
          "verify": "pnpm --filter api vitest run test/security/notification/notification.leakage.security.ts",
          "depends": ["D09-030", "D09-031", "D09-032"],
          "build": [
            "Create `apps/api/test/security/notification/notification.leakage.security.ts`.",
            "",
            "**No PHI in email notifications:**",
            "- Process CLAIM_REJECTED event → inspect rendered email body → no patient name, no PHN, no claim details",
            "- Process CLAIM_ASSESSED event → email body contains only summary and link",
            "- Process AI_HIGH_VALUE_SUGGESTION event → email contains no code details, only link to view in app",
            "- All email templates contain link to authenticated page, not inline claim data",
            "",
            "**Error response sanitisation:**",
            "- 401 response body contains only error object, no notification data",
            "- 404 for cross-user notification does not confirm notification exists",
            "- 500 error does not expose stack traces, SQL errors, or internal details",
            "",
            "**Header checks:**",
            "- No X-Powered-By header",
            "- No Server header revealing version",
            "- HSTS header present",
            "",
            "**WebSocket payload sanitisation:**",
            "- WebSocket notification payload contains rendered content only — no raw database internal fields",
            "- WebSocket payload does not include recipient_email or other PII beyond what's needed for display",
            "",
            "**Sensitive data not in responses:**",
            "- GET /notifications does not expose email_delivery_log details",
            "- GET /notification-preferences does not expose other physicians' preferences",
            "- Internal emit response does not leak recipient resolution details"
          ]
        },
        {
          "id": "D09-045",
          "description": "Security: audit trail completeness for notification actions",
          "verify": "pnpm --filter api vitest run test/security/notification/notification.audit.security.ts",
          "depends": ["D09-030", "D09-031", "D09-032"],
          "build": [
            "Create `apps/api/test/security/notification/notification.audit.security.ts`.",
            "",
            "Verify that each notification action produces an audit record:",
            "",
            "**Event processing:**",
            "- Emit event → notification.event_emitted with event_type, physician_id",
            "- Notification created → notification.created with notification_id, recipient_id, event_type",
            "",
            "**User actions:**",
            "- Mark notification read → notification.read with notification_id",
            "- Mark all read → notification.read_all with count",
            "- Dismiss notification → notification.dismissed with notification_id",
            "",
            "**Email delivery:**",
            "- Email sent → notification.email_sent with delivery_id, recipient_email (hashed)",
            "- Email bounced → notification.email_bounced with delivery_id, bounce_type",
            "- Email failed → notification.email_failed with delivery_id, retry_count",
            "",
            "**Preference changes:**",
            "- Preference updated → notification.preference_updated with category, old and new values",
            "- Quiet hours updated → notification.quiet_hours_updated with old and new values",
            "",
            "**Digest:**",
            "- Digest assembled → notification.digest_assembled with recipient_count, item_count",
            "",
            "**Audit log integrity:**",
            "- Audit entries for notifications are scoped to the acting user_id",
            "- Email delivery audit does not contain plaintext recipient_email (hash or redact)"
          ]
        }
      ]
    },
    {
      "title": "Domain 9: Notification Service — Final Validation",
      "tasks": [
        {
          "id": "D09-099",
          "description": "Full domain test suite: all unit + integration + security tests",
          "verify": "pnpm --filter api vitest run src/domains/notification/ test/integration/notification/ test/security/notification/",
          "depends": ["D09-040", "D09-041", "D09-042", "D09-043", "D09-044", "D09-045"],
          "build": [
            "Run the complete test suite for Domain 9 Notification Service. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/notification/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/notification/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/notification/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/notification/ test/integration/notification/ test/security/notification/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/notification/notification.authn.security.ts",
            "- test/security/notification/notification.authz.security.ts",
            "- test/security/notification/notification.scoping.security.ts",
            "- test/security/notification/notification.input.security.ts",
            "- test/security/notification/notification.leakage.security.ts",
            "- test/security/notification/notification.audit.security.ts"
          ]
        }
      ]
    }
  ]
}
