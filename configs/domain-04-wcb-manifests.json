{
  "domainNumber": "04W",
  "domainName": "WCB Claim Pathway (EIR)",
  "manifestFile": "domain-04-wcb.tasks",
  "promptPrefix": "d04w",
  "modulePath": "apps/api/src/domains/wcb",
  "sections": [
    {
      "title": "Domain 4.2: WCB Claim Pathway — Shared Types & Constants",
      "tasks": [
        {
          "id": "D04W-001",
          "description": "WCB constants: form types, role codes, facility types, timing tiers, validation checks, batch/payment statuses, OIS codes",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/wcb.constants.ts` with all WCB constants:",
            "",
            "**WCB Form Types enum:**",
            "- C050E (Physician First Report, 111 fields, 38 required)",
            "- C050S (OIS Physician First Report, 171 fields, 70 required)",
            "- C151 (Physician Progress Report, 136 fields, 39 required)",
            "- C151S (OIS Physician Progress Report, 153 fields, 39 required)",
            "- C568 (Medical Invoice, 61 fields, 17 required)",
            "- C568A (Medical Consultation Report, 69 fields, 19 required)",
            "- C569 (Medical Supplies Invoice, 37 fields, 18 required)",
            "- C570 (Medical Invoice Correction, 66 fields, 18 required)",
            "",
            "**Form type metadata:** initial vs follow-up, field count, required count, description.",
            "",
            "**Form Section Matrix (which sections appear per form):**",
            "Sections: General, Claimant, Practitioner, Employer, Accident, Injury, Treatment Plan, Return to Work, Attachments, Invoice.",
            "- C050E/C050S: all 10 sections",
            "- C151/C151S: all 10 sections",
            "- C568: General, Claimant, Practitioner, Accident, Injury, Invoice (no Employer, Treatment, RTW, Attachments)",
            "- C568A: General, Claimant, Practitioner, Accident, Injury, Treatment Plan, Invoice (no Employer, RTW, Attachments)",
            "- C569: General, Claimant, Practitioner, Accident, Invoice (no Employer, Injury, Treatment, RTW, Attachments)",
            "- C570: General, Claimant, Practitioner, Accident, Invoice (no Employer, Injury, Treatment, RTW, Attachments)",
            "",
            "**Contract ID / Role / Form ID permission matrix (initial reports):**",
            "- 000001 GP: C050E, C568",
            "- 000004 OR: C568A, C568",
            "- 000006 SP: C568A, C568",
            "- 000006 ERS: C050E, C568",
            "- 000006 ANE: C568A, C568",
            "- 000022 DP: C568",
            "- 000023 DP: C568",
            "- 000024 VSC: C568A, C568",
            "- 000025 VSCFAC: C568",
            "- 000052 DP: C568",
            "- 000053 OIS: C050S, C568",
            "- 000065 HP: C568",
            "- 000066 SP: C568A, C568",
            "- 000084 NP: C050E, C568",
            "",
            "**Follow-up form permission matrix (Contract/Role → progress forms + can-create-from):**",
            "- 000001 GP: C151, C568, C569, C570 from C050E/C151/C568",
            "- 000006 ERS: C151, C568, C569, C570 from C050E/C151/C568",
            "- 000006 SP: C568A, C568, C569, C570 from C568A/C568",
            "- 000006 ANE: C568A, C568, C569, C570 from C568A/C568",
            "- 000004 OR: C568A, C568, C569, C570 from C568A/C568",
            "- 000053 OIS: C151S, C568, C569, C570 from C050S/C151S/C568",
            "- 000084 NP: C151, C568, C570 from C050E/C151/C568",
            "",
            "**Practitioner Role Codes (10):** GP, OR, SP, ERS, ANE, DP, VSC, VSCFAC, OIS, NP",
            "",
            "**Facility Types (3):** C (Clinic), F (Facility Non-Hospital), H (Hospital)",
            "",
            "**WCB Batch Statuses:** ASSEMBLING, GENERATED, VALIDATED, UPLOADED, RETURN_RECEIVED, RECONCILED, ERROR",
            "",
            "**WCB Return Report Statuses:** COMPLETE, INVALID",
            "",
            "**WCB Payment Status Codes:** ISS (Issued), REQ (Requested), PAE (Pending Approval), PGA (Pending Approval), PGD (Pending Decision), REJ (Rejected), DEL (Deleted)",
            "",
            "**WCB Timing Tiers:** SAME_DAY, ON_TIME, LATE",
            "",
            "**WCB Fee Schedule (2025):**",
            "- C050E: same-day $94.15, on-time $85.80, late $54.08",
            "- C151: same-day $57.19, on-time $52.12, late $32.86",
            "- RF01E (Specialist Consultation): same-day $115.05, on-time $104.87, late $66.09",
            "- RF03E (Specialist Follow-up): same-day $57.19, on-time $52.12, late $32.86",
            "",
            "**Timing Deadline Rules per form type:**",
            "- C050E: same-day = exam day or next biz day by 10:00 MT; on-time = within 3 biz days (by 10:00 MT day 4)",
            "- C151: same-day = exam day or next biz day by 10:00 MT; on-time = within 4 biz days (by 10:00 MT day 5)",
            "- C568A: same-day = exam day or next biz day by 10:00 MT; on-time = within 4 biz days (by 10:00 MT day 5)",
            "",
            "**Alberta Statutory Holidays (10):** New Year's Day, Family Day, Good Friday, Victoria Day, Canada Day, Heritage Day, Labour Day, Truth and Reconciliation Day, Thanksgiving, Christmas Day.",
            "",
            "**Invoice Line Types:** STANDARD, DATED, SUPPLY, WAS, SHOULD_BE",
            "",
            "**Consultation Categories:** CONREF (Consultation/Referral), INVE (Investigation)",
            "",
            "**WCB Validation Check IDs (16 checks from Section 4.1 pipeline):**",
            "FORM_ID_VALID, CONTRACT_ROLE_FORM, REQUIRED_FIELDS, CONDITIONAL_LOGIC, DATA_TYPE_LENGTH, DATE_VALIDATION, POB_NOI_COMBINATION, SIDE_OF_BODY, CODE_TABLE_VALUES, SUBMITTER_TXN_FORMAT, PHN_LOGIC, INVOICE_LINE_INTEGRITY, ATTACHMENT_CONSTRAINTS, TIMING_DEADLINE, EXPEDITE_ELIGIBILITY, DUPLICATE_DETECTION",
            "",
            "**OIS-Specific Codes:**",
            "- Basic Work Restriction Codes: ABLE, UNABLE, LIMITED",
            "- Extended Work Restriction Codes: ABLE, UNABLE, LIMITEDTO",
            "- Fit For Work Codes: FIT, NOTFIT",
            "- Restriction Codes: NORESTRICT, RESTRICTFR",
            "- Work Level Codes: PREINJURY, LIMITATION",
            "- OIS Family Physician Codes: OIS, FAMILY",
            "",
            "Export all as frozen objects / TypeScript enums. Consumed by API and frontend."
          ],
          "frd": [
            "Domain 4.2 Section 2: 8 form types with field counts, section matrix, Contract/Role/Form permission matrices for initial and follow-up reports.",
            "Domain 4.2 Section 4.5: Timing tier rules and 2025 fee schedule. 10 Alberta statutory holidays for business day calculation.",
            "Domain 4.2 Section 5.6: Batch status lifecycle. Return file statuses. Payment status codes (7 values).",
            "Domain 4.2 Appendix C: OIS-specific reference code tables (7 code tables)."
          ]
        },
        {
          "id": "D04W-002",
          "description": "Drizzle schema for wcb_claim_details table — general, practitioner, and claimant fields",
          "verify": "pnpm --filter shared build",
          "depends": ["D04W-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/wcb.schema.ts` starting with the wcb_claim_details table (first portion).",
            "",
            "**wcb_claim_details table — General Fields:**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_claim_detail_id | UUID | No | PK, gen_random_uuid() |",
            "| claim_id | UUID FK | No | FK → claims.claim_id (Domain 4.0) |",
            "| form_id | VARCHAR(5) | No | C050E, C050S, C151, C151S, C568, C568A, C569, C570 |",
            "| submitter_txn_id | VARCHAR(16) | No | Unique. First 2 chars = vendor prefix |",
            "| wcb_claim_number | VARCHAR(7) | Yes | WCB-assigned 7-digit claim number |",
            "| report_completion_date | DATE | No | Date physician completed report |",
            "| additional_comments | TEXT | Yes | Max 2048 chars |",
            "| parent_wcb_claim_id | UUID FK | Yes | FK → wcb_claim_details for follow-up chain |",
            "",
            "**Practitioner Fields (immutable snapshot at claim creation):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| practitioner_billing_number | VARCHAR(8) | No | AH billing number |",
            "| contract_id | VARCHAR(10) | No | WCB Contract ID (e.g., 000001) |",
            "| role_code | VARCHAR(10) | No | GP, SP, ERS, ANE, OR, DP, VSC, VSCFAC, OIS, NP, HP |",
            "| practitioner_first_name | VARCHAR(11) | No | Max 11 chars per WCB spec |",
            "| practitioner_middle_name | VARCHAR(11) | Yes | |",
            "| practitioner_last_name | VARCHAR(21) | No | Max 21 chars per WCB spec |",
            "| skill_code | VARCHAR(10) | No | 141 valid values |",
            "| facility_type | VARCHAR(1) | No | C, F, or H |",
            "| clinic_reference_number | VARCHAR(8) | Yes | |",
            "| billing_contact_name | VARCHAR(30) | Yes | |",
            "| fax_country_code | VARCHAR(10) | Yes | |",
            "| fax_number | VARCHAR(24) | Yes | |",
            "",
            "**Claimant (Patient) Fields (immutable snapshot):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| patient_no_phn_flag | VARCHAR(1) | No | Y/N |",
            "| patient_phn | VARCHAR(9) | Yes | 9 digits. Required when no_phn_flag = N |",
            "| patient_gender | VARCHAR(1) | No | M, F, U |",
            "| patient_first_name | VARCHAR(11) | No | Max 11 chars |",
            "| patient_middle_name | VARCHAR(11) | Yes | |",
            "| patient_last_name | VARCHAR(21) | No | Max 21 chars |",
            "| patient_dob | DATE | No | |",
            "| patient_address_line1 | VARCHAR(30) | No | |",
            "| patient_address_line2 | VARCHAR(30) | Yes | |",
            "| patient_city | VARCHAR(20) | No | |",
            "| patient_province | VARCHAR(10) | Yes | |",
            "| patient_postal_code | VARCHAR(9) | Yes | |",
            "| patient_phone_country | VARCHAR(10) | Yes | |",
            "| patient_phone_number | VARCHAR(24) | Yes | |",
            "",
            "**Indexes:** UNIQUE on submitter_txn_id, index on claim_id (FK), index on (form_id, wcb_claim_number), index on parent_wcb_claim_id.",
            "",
            "Add standard timestamps: created_at, updated_at, deleted_at (soft delete), created_by (UUID FK), updated_by (UUID FK).",
            "",
            "Export table and inferred types (InsertWcbClaimDetail, SelectWcbClaimDetail)."
          ],
          "security": [
            "Patient PHN is PHI — stored encrypted or protected by column-level access. Never logged in plaintext.",
            "Practitioner and patient fields are immutable snapshots: values at time of claim creation, not live references. This ensures submitted data integrity."
          ],
          "frd": [
            "Domain 4.2 Section 3.1.1: General fields. Section 3.1.2: Practitioner fields (snapshot from Provider Management). Section 3.1.3: Claimant fields (snapshot from Patient Registry)."
          ]
        },
        {
          "id": "D04W-003",
          "description": "Drizzle schema for wcb_claim_details — employer, accident, injury assessment, treatment plan, and opioid fields",
          "verify": "pnpm --filter shared build",
          "depends": ["D04W-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/wcb.schema.ts` — additional columns on wcb_claim_details:",
            "",
            "**Employer Fields (required for C050E/S, C151/S only):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| employer_name | VARCHAR(50) | Yes | Required when form has Employer section |",
            "| employer_location | VARCHAR(100) | Yes | |",
            "| employer_city | VARCHAR(20) | Yes | |",
            "| employer_province | VARCHAR(10) | Yes | |",
            "| employer_phone_country | VARCHAR(10) | Yes | |",
            "| employer_phone_number | VARCHAR(24) | Yes | |",
            "| employer_phone_ext | VARCHAR(6) | Yes | |",
            "",
            "**Accident Fields:**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| worker_job_title | VARCHAR(50) | Yes | Required for C050E/S, C151/S |",
            "| injury_developed_over_time | VARCHAR(1) | Yes | Y/N. Required for C050E/S, C151/S, C568A |",
            "| date_of_injury | DATE | No | Required for all forms |",
            "| injury_description | TEXT | Yes | Max 1024 chars. Required for C050E/S, C151/S |",
            "",
            "**Injury Assessment Fields (scalar — repeating entries in wcb_injuries):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| date_of_examination | DATE | Yes | Required for forms with Injury section. Day 0 for timing |",
            "| symptoms | TEXT | Yes | Max 2048. Required for C050E/S, C151/S |",
            "| objective_findings | TEXT | Yes | Max 1024. Required for C050E/S, C151/S |",
            "| current_diagnosis | TEXT | Yes | Max 1024. Required for C050E/S |",
            "| previous_diagnosis | TEXT | Yes | Max 1024. Required for C151/S |",
            "| diagnosis_changed | VARCHAR(1) | Yes | Y/N. C151/S only |",
            "| diagnosis_changed_desc | TEXT | Yes | Max 1024. Required when diagnosis_changed = Y |",
            "| diagnostic_code_1 | VARCHAR(8) | Yes | Primary ICD code. Required for Injury section forms |",
            "| diagnostic_code_2 | VARCHAR(8) | Yes | Secondary |",
            "| diagnostic_code_3 | VARCHAR(8) | Yes | Tertiary |",
            "| additional_injuries_desc | TEXT | Yes | Max 1024. When >5 body parts |",
            "| dominant_hand | VARCHAR(10) | Yes | L, R, AMB. Conditional on upper extremity injury |",
            "| prior_conditions_flag | VARCHAR(1) | Yes | Y/N. Required for C050E/S, C151/S |",
            "| prior_conditions_desc | TEXT | Yes | Max 1024. Required when flag = Y |",
            "| referring_physician_name | VARCHAR(50) | Yes | C568, C568A only |",
            "| date_of_referral | DATE | Yes | C568, C568A only |",
            "",
            "**Treatment Plan Fields (scalar):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| narcotics_prescribed | VARCHAR(1) | Yes | Y/N. Required for Treatment Plan forms. Triggers prescriptions and opioid fields |",
            "| treatment_plan_text | TEXT | Yes | Max 1024. Required for C050E/S, C151/S |",
            "| case_conf_wcb_manager | VARCHAR(1) | Yes | Y/N. C050E/S, C151/S |",
            "| case_conf_wcb_physician | VARCHAR(1) | Yes | Y/N. C050E/S, C151/S |",
            "| referral_rtw_provider | VARCHAR(1) | Yes | Y/N. C050E/S, C151/S |",
            "| consultation_letter_format | VARCHAR(5) | Yes | ATTCH or TEXT. C568A |",
            "| consultation_letter_text | TEXT | Yes | Required when format = TEXT |",
            "",
            "**Opioid Management Fields (C151/C151S only — 23 columns):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| surgery_past_60_days | VARCHAR(1) | Yes | Conditional: narcotics = Y on C151/S |",
            "| treating_malignant_pain | VARCHAR(1) | Yes | |",
            "| wcb_advised_no_mmr | VARCHAR(1) | Yes | |",
            "| side_effect_nausea | VARCHAR(1) | Yes | 13 side-effect Y/N fields |",
            "| side_effect_sleep | VARCHAR(1) | Yes | |",
            "| side_effect_constipation | VARCHAR(1) | Yes | |",
            "| side_effect_endocrine | VARCHAR(1) | Yes | |",
            "| side_effect_sweating | VARCHAR(1) | Yes | |",
            "| side_effect_cognitive | VARCHAR(1) | Yes | |",
            "| side_effect_dry_mouth | VARCHAR(1) | Yes | |",
            "| side_effect_fatigue | VARCHAR(1) | Yes | |",
            "| side_effect_depression | VARCHAR(1) | Yes | |",
            "| side_effect_worsening_pain | VARCHAR(1) | Yes | |",
            "| abuse_social_deterioration | VARCHAR(1) | Yes | 6 abuse-indicator Y/N fields |",
            "| abuse_unsanctioned_use | VARCHAR(1) | Yes | |",
            "| abuse_altered_route | VARCHAR(1) | Yes | |",
            "| abuse_opioid_seeking | VARCHAR(1) | Yes | |",
            "| abuse_other_sources | VARCHAR(1) | Yes | |",
            "| abuse_withdrawal | VARCHAR(1) | Yes | |",
            "| patient_pain_estimate | SMALLINT | Yes | 0–10 scale |",
            "| opioid_reducing_pain | VARCHAR(1) | Yes | Y/N |",
            "| pain_reduction_desc | TEXT | Yes | Max 2048. Required when opioid_reducing_pain = Y |",
            "| clinician_function_estimate | SMALLINT | Yes | 0–10 scale |"
          ],
          "frd": [
            "Domain 4.2 Section 3.1.4: Employer fields (7 columns). Section 3.1.5: Accident fields (4 columns). Section 3.1.6: Injury assessment scalar fields (16 columns).",
            "Domain 4.2 Section 3.1.7: Treatment plan scalar fields (7 columns). Section 3.1.8: Opioid management fields (23 columns, C151/S only)."
          ]
        },
        {
          "id": "D04W-004",
          "description": "Drizzle schema for wcb_claim_details — RTW, invoice correction, and OIS-specific fields (~56 additional columns)",
          "verify": "pnpm --filter shared build",
          "depends": ["D04W-003"],
          "build": [
            "Add to wcb_claim_details in `packages/shared/src/schemas/db/wcb.schema.ts`:",
            "",
            "**Return to Work Fields (C050E/S, C151/S):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| missed_work_beyond_accident | VARCHAR(1) | Yes | Y/N. Triggers RTW cascade |",
            "| patient_returned_to_work | VARCHAR(1) | Yes | Required when missed_work = Y |",
            "| date_returned_to_work | DATE | Yes | Required when returned = Y |",
            "| modified_hours | VARCHAR(1) | Yes | Y/N. Required when returned = Y |",
            "| hours_capable_per_day | SMALLINT | Yes | Required when modified_hours = Y |",
            "| modified_duties | VARCHAR(1) | Yes | Y/N. Required when returned = Y |",
            "| rtw_hospitalized | VARCHAR(1) | Yes | |",
            "| rtw_self_reported_pain | VARCHAR(1) | Yes | |",
            "| rtw_opioid_side_effects | VARCHAR(1) | Yes | |",
            "| rtw_other_restrictions | TEXT | Yes | Max 2048 |",
            "| estimated_rtw_date | DATE | Yes | Required when missed_work = Y and returned = N |",
            "",
            "**Invoice Correction Fields (C570 Only):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| reassessment_comments | TEXT | Yes | Max 2048 |",
            "",
            "**OIS Hand Grasping Assessment (12 fields, C050S/C151S):**",
            "",
            "| Column | Type | Nullable |",
            "|--------|------|----------|",
            "| grasp_right_level | VARCHAR(10) | Yes* |",
            "| grasp_right_prolonged | VARCHAR(1) | Yes |",
            "| grasp_right_repetitive | VARCHAR(1) | Yes |",
            "| grasp_right_vibration | VARCHAR(1) | Yes |",
            "| grasp_right_specify | VARCHAR(1) | Yes |",
            "| grasp_right_specific_desc | TEXT | Yes |",
            "| grasp_left_level | VARCHAR(10) | Yes* |",
            "| grasp_left_prolonged | VARCHAR(1) | Yes |",
            "| grasp_left_repetitive | VARCHAR(1) | Yes |",
            "| grasp_left_vibration | VARCHAR(1) | Yes |",
            "| grasp_left_specify | VARCHAR(1) | Yes |",
            "| grasp_left_specific_desc | TEXT | Yes |",
            "",
            "**OIS Zone-Specific Lifting (6 fields):**",
            "",
            "| Column | Type | Nullable |",
            "|--------|------|----------|",
            "| lift_floor_to_waist | VARCHAR(10) | Yes* |",
            "| lift_floor_to_waist_max | VARCHAR(10) | Yes |",
            "| lift_waist_to_shoulder | VARCHAR(10) | Yes* |",
            "| lift_waist_to_shoulder_max | VARCHAR(10) | Yes |",
            "| lift_above_shoulder | VARCHAR(10) | Yes* |",
            "| lift_above_shoulder_max | VARCHAR(10) | Yes |",
            "",
            "**OIS Directional Reaching (4 fields):**",
            "reach_above_right_shoulder, reach_below_right_shoulder, reach_above_left_shoulder, reach_below_left_shoulder — all VARCHAR(10), Yes*.",
            "",
            "**OIS Environmental Restrictions (8 fields):**",
            "environment_restricted VARCHAR(1) No*; env_cold, env_hot, env_wet, env_dry, env_dust, env_lighting, env_noise — all VARCHAR(1) Yes* (required when environment_restricted = Y).",
            "",
            "**OIS Assessment Summary (~29 fields):**",
            "ois_reviewed_with_patient VARCHAR(1), ois_fitness_assessment VARCHAR(10) (FIT/NOTFIT), ois_estimated_rtw_date DATE, ois_rtw_level VARCHAR(10), ois_followup_required VARCHAR(1), ois_followup_date DATE,",
            "ois_emp_modified_work_required VARCHAR(1), ois_emp_modified_from_date DATE, ois_emp_modified_to_date DATE, ois_emp_modified_available VARCHAR(1), ois_emp_available_from_date DATE, ois_emp_available_to_date DATE, ois_emp_comments TEXT,",
            "ois_worker_rtw_date DATE, ois_worker_modified_duration VARCHAR(50), ois_worker_diagnosis_plan TEXT, ois_worker_self_care VARCHAR(1), ois_worker_comments TEXT,",
            "ois_has_family_physician VARCHAR(1), ois_family_physician_name VARCHAR(50), ois_family_physician_phone_country VARCHAR(10), ois_family_physician_phone VARCHAR(24), ois_family_physician_plan TEXT, ois_family_physician_support VARCHAR(10), ois_family_physician_rtw_date DATE, ois_family_physician_treatment VARCHAR(10), ois_family_physician_modified VARCHAR(10), ois_family_physician_comments TEXT.",
            "",
            "**C151S-specific:** rtw_status_changed VARCHAR(1) — gating question that makes entire expanded RTW section conditionally required.",
            "",
            "All OIS columns are nullable in the database; form_id-based validation enforces presence/absence."
          ],
          "frd": [
            "Domain 4.2 Section 3.1.9: Return to Work fields (11 columns). Section 3.1.10: Invoice Correction fields (1 column).",
            "Domain 4.2 Appendix C: OIS-specific fields — grasping (12), zone lifting (6), directional reaching (4), environmental (8), assessment summary (~29). Total ~45 additional columns."
          ]
        },
        {
          "id": "D04W-005",
          "description": "Drizzle schema for wcb_injuries, wcb_prescriptions, wcb_consultations, wcb_work_restrictions child tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D04W-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/wcb.schema.ts`:",
            "",
            "**wcb_injuries table (1–5 per claim with Injury section):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_injury_id | UUID | No | PK |",
            "| wcb_claim_detail_id | UUID FK | No | FK → wcb_claim_details |",
            "| ordinal | SMALLINT | No | Position 1–5 |",
            "| part_of_body_code | VARCHAR(10) | No | 30 valid POB codes |",
            "| side_of_body_code | VARCHAR(10) | Yes | L, R, B. Required per POB 'Side Required' flag |",
            "| nature_of_injury_code | VARCHAR(10) | No | 46 valid NOI codes |",
            "",
            "Constraint: UNIQUE(wcb_claim_detail_id, ordinal). CHECK ordinal BETWEEN 1 AND 5.",
            "Index: (wcb_claim_detail_id).",
            "",
            "**wcb_prescriptions table (1–5 when narcotics_prescribed = Y):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_prescription_id | UUID | No | PK |",
            "| wcb_claim_detail_id | UUID FK | No | FK → wcb_claim_details |",
            "| ordinal | SMALLINT | No | Position 1–5 |",
            "| prescription_name | VARCHAR(50) | No | |",
            "| strength | VARCHAR(30) | No | |",
            "| daily_intake | VARCHAR(30) | No | |",
            "",
            "Constraint: UNIQUE(wcb_claim_detail_id, ordinal). CHECK ordinal BETWEEN 1 AND 5.",
            "",
            "**wcb_consultations table (1–5 per claim with Treatment Plan):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_consultation_id | UUID | No | PK |",
            "| wcb_claim_detail_id | UUID FK | No | FK → wcb_claim_details |",
            "| ordinal | SMALLINT | No | Position 1–5 |",
            "| category | VARCHAR(10) | No | CONREF or INVE |",
            "| type_code | VARCHAR(10) | No | ORTHO, NEURO, PLASTIC, OTHER, XRAY, ULTRA, CT, MRI, EMG, OTHER |",
            "| details | VARCHAR(50) | No | |",
            "| expedite_requested | VARCHAR(1) | Yes | Y/N per Expedite Codes table |",
            "",
            "Constraint: UNIQUE(wcb_claim_detail_id, ordinal). CHECK ordinal BETWEEN 1 AND 5.",
            "",
            "**wcb_work_restrictions table (up to 11 activity types):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_restriction_id | UUID | No | PK |",
            "| wcb_claim_detail_id | UUID FK | No | FK → wcb_claim_details |",
            "| activity_type | VARCHAR(20) | No | SITTING, STANDING, WALKING, BENDING, TWISTING, KNEELING_SQUATTING, CLIMBING, LIFTING, PUSHING_PULLING, OVERHEAD_REACHING, DRIVING |",
            "| restriction_level | VARCHAR(10) | No | ABLE/UNABLE for standard; ABLE/UNABLE/LIMITEDTO for OIS |",
            "| hours_per_day | SMALLINT | Yes | For timed activities |",
            "| max_weight | VARCHAR(10) | Yes | Weight category for LIFTING |",
            "",
            "Constraint: UNIQUE(wcb_claim_detail_id, activity_type).",
            "",
            "Export all tables and inferred types."
          ],
          "frd": [
            "Domain 4.2 Section 3.2: wcb_injuries (POB/SOB/NOI, 1–5 entries, 382 exclusion matrix). Section 3.3: wcb_prescriptions (1–5 medication entries).",
            "Domain 4.2 Section 3.4: wcb_consultations (CONREF/INVE, expedite flag). Section 3.5: wcb_work_restrictions (11 activity types)."
          ]
        },
        {
          "id": "D04W-006",
          "description": "Drizzle schema for wcb_invoice_lines and wcb_attachments child tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D04W-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/wcb.schema.ts`:",
            "",
            "**wcb_invoice_lines table (1–25 per claim, all form types):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_invoice_line_id | UUID | No | PK |",
            "| wcb_claim_detail_id | UUID FK | No | FK → wcb_claim_details |",
            "| invoice_detail_id | SMALLINT | No | Sequential 1-based line number |",
            "| line_type | VARCHAR(10) | No | STANDARD, DATED, SUPPLY, WAS, SHOULD_BE |",
            "| health_service_code | VARCHAR(7) | Yes | Required for STANDARD, DATED |",
            "| diagnostic_code_1 | VARCHAR(8) | Yes | C568/A DATED lines |",
            "| diagnostic_code_2 | VARCHAR(8) | Yes | |",
            "| diagnostic_code_3 | VARCHAR(8) | Yes | |",
            "| modifier_1 | VARCHAR(6) | Yes | |",
            "| modifier_2 | VARCHAR(6) | Yes | |",
            "| modifier_3 | VARCHAR(6) | Yes | |",
            "| calls | SMALLINT | Yes | 0–7 |",
            "| encounters | SMALLINT | Yes | 0 or 1 |",
            "| date_of_service_from | DATE | Yes | C568/A DATED lines |",
            "| date_of_service_to | DATE | Yes | C568/A DATED lines |",
            "| facility_type_override | VARCHAR(1) | Yes | Per-line override C568/A |",
            "| skill_code_override | VARCHAR(10) | Yes | Per-line override C568/A |",
            "| invoice_detail_type_code | VARCHAR(10) | Yes | C568/A detail type |",
            "| invoice_detail_desc | VARCHAR(50) | Yes | C568/A detail description |",
            "| quantity | SMALLINT | Yes | C569 supply lines |",
            "| supply_description | VARCHAR(50) | Yes | C569 |",
            "| amount | DECIMAL(10,2) | Yes | Fee amount (C568/A, C569) |",
            "| adjustment_indicator | VARCHAR(10) | Yes | C570 Was/Should Be pairing |",
            "| billing_number_override | VARCHAR(8) | Yes | C570 per-line billing number |",
            "| correction_pair_id | SMALLINT | Yes | C570: links Was line to Should Be line |",
            "",
            "Constraint: UNIQUE(wcb_claim_detail_id, invoice_detail_id). Max 25 lines per claim.",
            "Index: (wcb_claim_detail_id).",
            "",
            "**wcb_attachments table (up to 3 per claim):**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_attachment_id | UUID | No | PK |",
            "| wcb_claim_detail_id | UUID FK | No | FK → wcb_claim_details |",
            "| ordinal | SMALLINT | No | Position 1–3 |",
            "| file_name | VARCHAR(255) | No | Original file name |",
            "| file_type | VARCHAR(10) | No | PDF, DOC, DOCX, JPG, PNG, TIF |",
            "| file_content_b64 | TEXT | No | Base64-encoded. Encrypted at rest |",
            "| file_description | VARCHAR(60) | No | |",
            "| file_size_bytes | INTEGER | No | For validation and display |",
            "",
            "Constraint: UNIQUE(wcb_claim_detail_id, ordinal). CHECK ordinal BETWEEN 1 AND 3.",
            "",
            "Export tables and inferred types."
          ],
          "security": [
            "file_content_b64 contains PHI (clinical documents). Must be encrypted at rest using AES-256.",
            "Attachment file type must be validated against permitted types for the form_id. Arbitrary file types are rejected.",
            "File size limits must be enforced before base64 encoding to prevent memory exhaustion."
          ],
          "frd": [
            "Domain 4.2 Section 3.6: wcb_invoice_lines — 5 line types with form-specific field requirements. C570 Was/Should Be pairing via correction_pair_id.",
            "Domain 4.2 Section 3.7: wcb_attachments — max 3 per form, base64-encoded for HL7 XML inclusion."
          ]
        },
        {
          "id": "D04W-007",
          "description": "Drizzle schema for wcb_batches, wcb_return_records, wcb_return_invoice_lines, wcb_remittance_records pipeline tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D04W-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/wcb.schema.ts`:",
            "",
            "**wcb_batches table:**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_batch_id | UUID | No | PK |",
            "| physician_id | UUID FK | No | FK → providers. Per-physician batches |",
            "| batch_control_id | VARCHAR(50) | No | BHS.11. For return file matching |",
            "| file_control_id | VARCHAR(50) | No | FHS.11 |",
            "| status | VARCHAR(20) | No | ASSEMBLING, GENERATED, VALIDATED, UPLOADED, RETURN_RECEIVED, RECONCILED, ERROR |",
            "| report_count | INTEGER | No | |",
            "| xml_file_path | VARCHAR(255) | Yes | Encrypted at rest |",
            "| xml_file_hash | VARCHAR(64) | Yes | SHA-256 |",
            "| xsd_validation_passed | BOOLEAN | Yes | |",
            "| xsd_validation_errors | JSONB | Yes | Array of errors |",
            "| uploaded_at | TIMESTAMPTZ | Yes | |",
            "| uploaded_by | UUID FK | Yes | |",
            "| return_file_received_at | TIMESTAMPTZ | Yes | |",
            "| return_file_path | VARCHAR(255) | Yes | |",
            "| created_at | TIMESTAMPTZ | No | |",
            "| created_by | UUID FK | No | |",
            "",
            "Indexes: (physician_id, status), UNIQUE(batch_control_id), UNIQUE(file_control_id).",
            "",
            "**wcb_return_records table:**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_return_record_id | UUID | No | PK |",
            "| wcb_batch_id | UUID FK | No | FK → wcb_batches |",
            "| wcb_claim_detail_id | UUID FK | Yes | Null if unable to match |",
            "| report_txn_id | VARCHAR(20) | No | WCB-assigned |",
            "| submitter_txn_id | VARCHAR(16) | No | For matching |",
            "| processed_claim_number | VARCHAR(7) | Yes | WCB-assigned claim number |",
            "| claim_decision | VARCHAR(20) | No | Accepted or empty |",
            "| report_status | VARCHAR(20) | No | Complete or Invalid |",
            "| txn_submission_date | DATE | No | |",
            "| errors | JSONB | Yes | Array of {error_number, error_description} |",
            "",
            "Index: (wcb_batch_id), (submitter_txn_id).",
            "",
            "**wcb_return_invoice_lines table:**",
            "",
            "| Column | Type | Nullable | Notes |",
            "|--------|------|----------|-------|",
            "| wcb_return_invoice_line_id | UUID | No | PK |",
            "| wcb_return_record_id | UUID FK | No | FK → wcb_return_records |",
            "| invoice_sequence | SMALLINT | No | |",
            "| service_date | DATE | Yes | |",
            "| health_service_code | VARCHAR(7) | Yes | |",
            "| invoice_status | VARCHAR(20) | Yes | |",
            "",
            "**wcb_remittance_records table:**",
            "",
            "| Column | Type | Null | Notes |",
            "|--------|------|------|-------|",
            "| wcb_remittance_id | UUID | No | PK |",
            "| remittance_import_id | UUID FK | No | FK to import batch |",
            "| wcb_claim_detail_id | UUID FK | Yes | Matched claim |",
            "| report_week_start | DATE | No | |",
            "| report_week_end | DATE | No | |",
            "| disbursement_number | VARCHAR(8) | Yes | |",
            "| disbursement_type | VARCHAR(3) | Yes | EFT or AUT |",
            "| disbursement_issue_date | DATE | Yes | |",
            "| disbursement_amount | DECIMAL(11,2) | Yes | |",
            "| disbursement_recipient_billing | VARCHAR(8) | Yes | |",
            "| disbursement_recipient_name | VARCHAR(40) | Yes | |",
            "| payment_payee_billing | VARCHAR(8) | No | |",
            "| payment_payee_name | VARCHAR(40) | No | |",
            "| payment_reason_code | VARCHAR(3) | No | |",
            "| payment_status | VARCHAR(3) | No | ISS, REQ, PAE, PGA, PGD, REJ, DEL |",
            "| payment_start_date | DATE | No | |",
            "| payment_end_date | DATE | No | |",
            "| payment_amount | DECIMAL(11,2) | No | |",
            "| billed_amount | DECIMAL(10,2) | Yes | |",
            "| electronic_report_txn_id | VARCHAR(20) | Yes | For matching chain |",
            "| claim_number | VARCHAR(7) | Yes | |",
            "| worker_phn | VARCHAR(11) | Yes | |",
            "| worker_first_name | VARCHAR(11) | Yes | |",
            "| worker_last_name | VARCHAR(21) | Yes | |",
            "| service_code | VARCHAR(7) | Yes | |",
            "| modifier_1 | VARCHAR(6) | Yes | |",
            "| modifier_2 | VARCHAR(6) | Yes | |",
            "| modifier_3 | VARCHAR(6) | Yes | |",
            "| number_of_calls | SMALLINT | Yes | |",
            "| encounter_number | SMALLINT | Yes | |",
            "| overpayment_recovery | DECIMAL(10,2) | Yes | |",
            "",
            "Index: (electronic_report_txn_id), (remittance_import_id), (claim_number).",
            "",
            "Export all tables and inferred types."
          ],
          "security": [
            "xml_file_path references AES-256 encrypted file on disk. Never store plaintext XML in database.",
            "Return files and remittance files stored encrypted for 7-year audit retention.",
            "worker_phn in remittance records is PHI — same protections as patient_phn."
          ],
          "frd": [
            "Domain 4.2 Section 3.8: wcb_batches (7 statuses). Section 3.9: wcb_return_records. Section 3.10: wcb_return_invoice_lines.",
            "Domain 4.2 Section 3.11: wcb_remittance_records (31 columns from PaymentRemittanceRecord XML schema)."
          ]
        },
        {
          "id": "D04W-008",
          "description": "Zod validation schemas for WCB claim CRUD, batch, return, remittance, and MVP endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D04W-001"],
          "build": [
            "Create `packages/shared/src/schemas/wcb.schema.ts` with Zod schemas:",
            "",
            "**WCB Claim CRUD:**",
            "- wcbClaimCreateSchema: { form_id: enum(WCB_FORM_TYPES), patient_id: uuid(), wcb_claim_number: string().max(7).optional(), parent_wcb_claim_id: uuid().optional(), ...form-section fields as optional (service layer enforces form-specific requirements) }",
            "- wcbClaimUpdateSchema: partial version of create schema (all fields optional, service validates)",
            "- wcbClaimIdParamSchema: { id: string().uuid() }",
            "- wcbClaimValidateResponseSchema: { errors: array, warnings: array, info: array, passed: boolean, timing_tier, deadline_info }",
            "- wcbFormSchemaResponseSchema: { form_id, sections: array of { name, active, fields: array of { name, required, conditional, type, maxLength } } }",
            "",
            "**Invoice line sub-schemas by line_type:**",
            "- wcbInvoiceLineStandardSchema: { health_service_code, modifier_1/2/3, calls, encounters }",
            "- wcbInvoiceLineDatedSchema: { ...standard + date_of_service_from, date_of_service_to, facility_type_override, skill_code_override, amount }",
            "- wcbInvoiceLineSupplySchema: { quantity, supply_description, amount }",
            "- wcbInvoiceLineCorrectionSchema: { line_type: enum(WAS, SHOULD_BE), correction_pair_id, adjustment_indicator, billing_number_override, ...standard fields }",
            "",
            "**Injury sub-schema:** { part_of_body_code: string(), side_of_body_code: string().optional(), nature_of_injury_code: string() }",
            "**Prescription sub-schema:** { prescription_name, strength, daily_intake }",
            "**Consultation sub-schema:** { category: enum(CONREF, INVE), type_code, details, expedite_requested: enum(Y, N).optional() }",
            "**Work restriction sub-schema:** { activity_type: enum(...), restriction_level, hours_per_day: number().optional(), max_weight: string().optional() }",
            "**Attachment sub-schema:** { file_name, file_type: enum(...), file_content_b64, file_description: string().max(60) }",
            "",
            "**WCB Batch Management:**",
            "- wcbBatchCreateSchema: {} (auto-selects queued claims for authenticated physician)",
            "- wcbBatchIdParamSchema: { id: string().uuid() }",
            "- wcbBatchConfirmUploadSchema: {} (just POST with auth — batch ID in URL)",
            "- wcbBatchListQuerySchema: { status: enum(BATCH_STATUSES).optional(), page: number().default(1), page_size: number().max(100).default(20) }",
            "",
            "**Return File / Remittance:**",
            "- wcbReturnFileUploadSchema: { file: binary/multipart (tab-delimited text file) }",
            "- wcbRemittanceUploadSchema: { file: binary/multipart (XML file) }",
            "- wcbRemittanceListQuerySchema: { start_date: date().optional(), end_date: date().optional(), page, page_size }",
            "- wcbRemittanceIdParamSchema: { id: string().uuid() }",
            "",
            "**MVP Endpoints:**",
            "- wcbManualOutcomeSchema: { wcb_claim_number: string().max(7).optional(), acceptance_status: enum(accepted, rejected), payment_amount: number().optional() }",
            "",
            "Export all schemas and inferred TypeScript types."
          ],
          "frd": [
            "Domain 4.2 Section 9: All 6 API endpoint groups — claim CRUD (6 endpoints), batch management (5 endpoints), return file (2 endpoints), remittance (3 endpoints), MVP (2 endpoints).",
            "Domain 4.2 Section 3: Child table cardinality constraints — injuries 1–5, prescriptions 1–5, consultations 1–5, invoice lines 1–25, attachments max 3."
          ]
        },
        {
          "id": "D04W-009",
          "description": "Generate and apply database migration for all WCB tables",
          "verify": "cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1",
          "depends": ["D04W-002", "D04W-003", "D04W-004", "D04W-005", "D04W-006", "D04W-007"],
          "build": [
            "Run the Drizzle migration generator for all WCB tables:",
            "",
            "```bash",
            "cd apps/api",
            "pnpm drizzle-kit generate",
            "pnpm drizzle-kit migrate",
            "```",
            "",
            "Verify migration created in `apps/api/drizzle/migrations/`.",
            "Verify all 11 tables exist: wcb_claim_details, wcb_injuries, wcb_prescriptions, wcb_consultations, wcb_work_restrictions, wcb_invoice_lines, wcb_attachments, wcb_batches, wcb_return_records, wcb_return_invoice_lines, wcb_remittance_records.",
            "Verify FK constraints to claims table (Domain 4.0) resolve correctly.",
            "Verify all UNIQUE constraints and CHECK constraints are applied.",
            "Verify all indexes are created."
          ]
        }
      ]
    },
    {
      "title": "Domain 4.2: WCB Claim Pathway — Repository Layer",
      "tasks": [
        {
          "id": "D04W-010",
          "description": "Repository: WCB claim CRUD operations (create, read, update, soft-delete)",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-009"],
          "build": [
            "Create `apps/api/src/domains/wcb/wcb.repository.ts` with WCB claim CRUD:",
            "",
            "- `createWcbClaim(data: CreateWcbClaimInput)` — insert into wcb_claim_details. Generate submitter_txn_id (vendor prefix + unique). Return wcb_claim_detail_id.",
            "- `getWcbClaim(wcbClaimDetailId: string, physicianId: string)` — fetch wcb_claim_details with ALL child records (injuries, prescriptions, consultations, restrictions, invoice_lines, attachments) via joins or subqueries. Scope to physician.",
            "- `updateWcbClaim(wcbClaimDetailId: string, physicianId: string, data: UpdateWcbClaimInput)` — partial update. Only allowed in draft state (check via join to claims table). Set updated_at, updated_by.",
            "- `softDeleteWcbClaim(wcbClaimDetailId: string, physicianId: string)` — set deleted_at. Only allowed in draft state.",
            "- `getWcbClaimBySubmitterTxnId(submitterTxnId: string)` — for return file matching.",
            "- `updateWcbClaimNumber(wcbClaimDetailId: string, claimNumber: string)` — store WCB-assigned claim number after return file processing.",
            "- `listWcbClaimsForPhysician(physicianId: string, filters: { status?, form_id?, page, page_size })` — paginated list with join to claims table for status."
          ],
          "security": [
            "All read/write operations scope to physicianId — no cross-physician access.",
            "getWcbClaim returns 11 tables of data — ensure no N+1 queries. Use efficient joins.",
            "submitter_txn_id generation must be cryptographically unique and include vendor prefix."
          ],
          "tests": [
            "createWcbClaim inserts claim with generated submitter_txn_id",
            "createWcbClaim submitter_txn_id starts with vendor prefix",
            "getWcbClaim returns all child records (injuries, prescriptions, consultations, restrictions, invoice_lines, attachments)",
            "getWcbClaim scoped to physician returns null for other physician's claim",
            "updateWcbClaim updates fields and sets updated_at",
            "updateWcbClaim rejects update when claim not in draft state",
            "softDeleteWcbClaim sets deleted_at",
            "softDeleteWcbClaim rejects when not in draft state",
            "getWcbClaimBySubmitterTxnId finds claim by txn ID",
            "listWcbClaimsForPhysician returns only this physician's claims"
          ]
        },
        {
          "id": "D04W-011",
          "description": "Repository: child table CRUD (injuries, prescriptions, consultations, work restrictions)",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-009"],
          "build": [
            "Add to `apps/api/src/domains/wcb/wcb.repository.ts`:",
            "",
            "**Injuries:**",
            "- `upsertInjuries(wcbClaimDetailId: string, injuries: InjuryInput[])` — delete existing and bulk insert 1–5 entries. Validate ordinal uniqueness.",
            "- `getInjuries(wcbClaimDetailId: string)` — return ordered by ordinal.",
            "",
            "**Prescriptions:**",
            "- `upsertPrescriptions(wcbClaimDetailId: string, prescriptions: PrescriptionInput[])` — delete and replace 1–5.",
            "- `getPrescriptions(wcbClaimDetailId: string)` — return ordered by ordinal.",
            "",
            "**Consultations:**",
            "- `upsertConsultations(wcbClaimDetailId: string, consultations: ConsultationInput[])` — delete and replace 1–5.",
            "- `getConsultations(wcbClaimDetailId: string)` — return ordered by ordinal.",
            "",
            "**Work Restrictions:**",
            "- `upsertWorkRestrictions(wcbClaimDetailId: string, restrictions: RestrictionInput[])` — delete and replace. Max 11 (one per activity type).",
            "- `getWorkRestrictions(wcbClaimDetailId: string)` — return all.",
            "",
            "All upsert operations use transaction: delete existing rows then bulk insert replacement set. This avoids partial updates."
          ],
          "tests": [
            "upsertInjuries inserts 3 injury entries",
            "upsertInjuries replaces existing entries",
            "upsertInjuries enforces max 5",
            "upsertPrescriptions inserts and replaces",
            "upsertConsultations inserts and replaces",
            "upsertWorkRestrictions inserts up to 11 activity types",
            "upsertWorkRestrictions rejects duplicate activity_type"
          ]
        },
        {
          "id": "D04W-012",
          "description": "Repository: invoice line and attachment operations",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-009"],
          "build": [
            "Add to `apps/api/src/domains/wcb/wcb.repository.ts`:",
            "",
            "**Invoice Lines:**",
            "- `upsertInvoiceLines(wcbClaimDetailId: string, lines: InvoiceLineInput[])` — delete and replace. Enforce sequential invoice_detail_id. Max 25 lines.",
            "- `getInvoiceLines(wcbClaimDetailId: string)` — return ordered by invoice_detail_id.",
            "- `validateC570Pairing(wcbClaimDetailId: string)` — verify every WAS line has exactly one SHOULD_BE pair with matching invoice_detail_id. Return validation result.",
            "",
            "**Attachments:**",
            "- `upsertAttachments(wcbClaimDetailId: string, attachments: AttachmentInput[])` — delete and replace. Max 3.",
            "- `getAttachments(wcbClaimDetailId: string)` — return ordered by ordinal.",
            "- `getAttachmentContent(wcbAttachmentId: string, physicianId: string)` — return single attachment with content. Scoped to physician.",
            "",
            "Note: file_content_b64 can be large. getWcbClaim (D04W-010) should NOT include file_content_b64 in the default join — only ordinal, file_name, file_type, file_description, file_size_bytes. Full content fetched separately."
          ],
          "security": [
            "Invoice line upsert must validate sequential numbering — no gaps in invoice_detail_id.",
            "C570 Was/Should Be pairing is a hard business rule. The repository provides a validation helper; the service layer enforces it.",
            "Attachment content is PHI — only served via getAttachmentContent with physician scoping."
          ],
          "tests": [
            "upsertInvoiceLines inserts sequential lines",
            "upsertInvoiceLines enforces max 25",
            "upsertInvoiceLines replaces existing lines in transaction",
            "validateC570Pairing returns valid for correct pairing",
            "validateC570Pairing returns errors for missing pair",
            "upsertAttachments inserts up to 3",
            "upsertAttachments enforces max 3",
            "getAttachmentContent scoped to physician"
          ]
        },
        {
          "id": "D04W-013",
          "description": "Repository: WCB batch operations (create, status transitions, download tracking)",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-009"],
          "build": [
            "Add to `apps/api/src/domains/wcb/wcb.repository.ts`:",
            "",
            "- `createBatch(physicianId: string, createdBy: string)` — insert wcb_batch with ASSEMBLING status. Generate batch_control_id (format: MER-B-{UUID short}) and file_control_id (format: MER-{YYYYMMDD}-{sequence}). Return wcb_batch_id.",
            "- `getBatch(wcbBatchId: string, physicianId: string)` — fetch batch with physician scoping. Include report_count.",
            "- `listBatches(physicianId: string, filters: { status?, page, page_size })` — paginated list, reverse chronological.",
            "- `updateBatchStatus(wcbBatchId: string, status: string, additionalFields?: Partial<WcbBatch>)` — transition status. Set xml_file_path, xml_file_hash, xsd_validation_passed, etc. as appropriate.",
            "- `setBatchUploaded(wcbBatchId: string, uploadedBy: string)` — set status UPLOADED, uploaded_at, uploaded_by. Only from VALIDATED.",
            "- `setBatchReturnReceived(wcbBatchId: string, returnFilePath: string)` — set status RETURN_RECEIVED.",
            "- `getQueuedClaimsForBatch(physicianId: string)` — fetch all queued WCB claims for physician (join claims table status = 'queued', claim_type = 'WCB').",
            "- `assignClaimsToBatch(wcbBatchId: string, claimIds: string[])` — link claims to batch (via batch_id on claims table or junction)."
          ],
          "security": [
            "All batch operations scoped to physicianId.",
            "Status transitions enforced: ASSEMBLING → GENERATED → VALIDATED → UPLOADED → RETURN_RECEIVED → RECONCILED. ERROR can occur from ASSEMBLING, GENERATED, or VALIDATED.",
            "batch_control_id and file_control_id must be globally unique."
          ],
          "tests": [
            "createBatch creates batch with ASSEMBLING status",
            "createBatch generates unique batch_control_id and file_control_id",
            "getBatch returns null for other physician's batch",
            "listBatches returns reverse chronological",
            "listBatches filters by status",
            "updateBatchStatus transitions correctly",
            "setBatchUploaded only from VALIDATED status",
            "getQueuedClaimsForBatch returns only queued WCB claims"
          ]
        },
        {
          "id": "D04W-014",
          "description": "Repository: return file and remittance record operations",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-009"],
          "build": [
            "Add to `apps/api/src/domains/wcb/wcb.repository.ts`:",
            "",
            "**Return Records:**",
            "- `createReturnRecords(wcbBatchId: string, records: ReturnRecordInput[])` — bulk insert return records for a batch.",
            "- `createReturnInvoiceLines(wcbReturnRecordId: string, lines: ReturnInvoiceLineInput[])` — bulk insert per-report invoice line results.",
            "- `getReturnRecordsByBatch(wcbBatchId: string)` — fetch all return records for a batch with invoice line sub-records.",
            "- `matchReturnToClaimBySubmitterTxnId(submitterTxnId: string)` — lookup wcb_claim_details by submitter_txn_id. Return wcb_claim_detail_id or null.",
            "",
            "**Remittance Records:**",
            "- `createRemittanceImport(physicianId: string)` — create remittance import batch record. Return remittance_import_id.",
            "- `createRemittanceRecords(remittanceImportId: string, records: RemittanceRecordInput[])` — bulk insert.",
            "- `matchRemittanceToClaimByTxnId(electronicReportTxnId: string)` — lookup via return_records chain: electronic_report_txn_id → wcb_return_records.report_txn_id → wcb_claim_detail_id.",
            "- `listRemittanceImports(physicianId: string, filters: { start_date?, end_date?, page, page_size })` — paginated list.",
            "- `getRemittanceDiscrepancies(remittanceImportId: string)` — return records where payment_amount != billed_amount or payment_status != 'ISS'."
          ],
          "tests": [
            "createReturnRecords inserts batch of return records",
            "createReturnInvoiceLines inserts per-report lines",
            "matchReturnToClaimBySubmitterTxnId finds correct claim",
            "matchReturnToClaimBySubmitterTxnId returns null for unknown txn ID",
            "createRemittanceRecords inserts records",
            "matchRemittanceToClaimByTxnId follows report_txn_id chain",
            "getRemittanceDiscrepancies returns only mismatched records"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.2: WCB Claim Pathway — Service Layer",
      "tasks": [
        {
          "id": "D04W-020",
          "description": "Service: WCB claim creation with form-type routing and practitioner snapshot",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-010", "D04W-011", "D04W-012"],
          "build": [
            "Create `apps/api/src/domains/wcb/wcb.service.ts` with claim lifecycle functions:",
            "",
            "- `createWcbClaim(physicianId: string, data: CreateWcbClaimInput)` — orchestrates claim creation:",
            "  1. Load practitioner from Provider Management (Domain 5) → snapshot billing number, contract_id, role_code, names, skill_code, facility_type.",
            "  2. Load patient from Patient Registry (Domain 6) → snapshot PHN, demographics, employer if applicable.",
            "  3. Validate Contract ID / Role / Form ID permission (gating check).",
            "  4. For follow-up forms: validate parent_wcb_claim_id exists, parent is in terminal state, parent form type is in 'Can Create From' list, parent practitioner matches.",
            "  5. Create base claim record in claims table (Domain 4.0) with claim_type = 'WCB'.",
            "  6. Create wcb_claim_details with snapshot fields + form data.",
            "  7. Create child records (injuries, prescriptions, consultations, restrictions, invoice_lines, attachments).",
            "  8. Emit audit event: wcb.claim_created.",
            "  Return { claim_id, wcb_claim_detail_id }.",
            "",
            "- `updateWcbClaim(physicianId: string, wcbClaimDetailId: string, data: UpdateWcbClaimInput)` — partial update including child table upserts. Triggers revalidation. Emit audit: wcb.claim_updated.",
            "",
            "- `deleteWcbClaim(physicianId: string, wcbClaimDetailId: string)` — soft delete. Only draft state. Emit audit: wcb.claim_deleted.",
            "",
            "- `getFormSchema(formId: string, existingData?: Partial<WcbClaimDetail>)` — return form field schema: active sections, field requirements (always required / conditionally required / optional), current conditional states based on existing data values."
          ],
          "security": [
            "Contract/Role/Form validation is a gating check — reject before any data is written.",
            "Follow-up chain validation prevents cross-practitioner claim chaining.",
            "Practitioner and patient snapshots ensure submitted data integrity even if source records change later."
          ],
          "tests": [
            "createWcbClaim with valid GP + C050E creates claim with snapshots",
            "createWcbClaim rejects invalid Contract/Role/Form combination",
            "createWcbClaim for C151 requires valid parent_wcb_claim_id",
            "createWcbClaim for C151 rejects parent in non-terminal state",
            "createWcbClaim for C151 rejects parent from different practitioner",
            "updateWcbClaim updates claim and child records",
            "updateWcbClaim rejects non-draft claim",
            "deleteWcbClaim soft-deletes draft claim",
            "getFormSchema returns correct sections for C050E vs C568 vs C569"
          ]
        },
        {
          "id": "D04W-021",
          "description": "Service: WCB validation engine — required fields, conditional logic, data type/length checks",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-020"],
          "build": [
            "Add to `apps/api/src/domains/wcb/wcb.service.ts` (or create `wcb.validation.ts`):",
            "",
            "- `validateWcbClaim(wcbClaimDetailId: string, physicianId: string)` — run full 16-check WCB validation pipeline:",
            "",
            "  **Error checks (blocking):**",
            "  1. Form ID valid (one of 8 types)",
            "  2. Contract ID / Role / Form ID permitted (per matrix)",
            "  3. Required fields present (form-type-specific 'Always Required' fields)",
            "  4. Conditional field logic (trigger field → dependent fields cascade)",
            "  5. Data type / length enforcement per field spec",
            "  6. Date validation (valid dates, exam >= injury, completion >= exam)",
            "  7. POB-NOI combination check (382 exclusion matrix)",
            "  8. Side of Body required check (per POB flag)",
            "  9. Code table value validation (all coded fields against reference tables)",
            "  10. Submitter txn ID format (prefix + length + uniqueness)",
            "  11. PHN logic (no_phn_flag = N → 9-digit PHN required; Y → blank)",
            "  12. Invoice line integrity (at least 1 line, sequential, form-specific fields)",
            "",
            "  **Warning checks (flagging):**",
            "  13. Attachment constraints (max 3, valid file types)",
            "  14. Timing deadline (tier calculation and warning)",
            "  15. Expedite eligibility (Category/Type permits expedite)",
            "  16. Duplicate detection (same patient + date of injury + form type)",
            "",
            "  Return: { errors: ValidationIssue[], warnings: ValidationIssue[], passed: boolean, timing_tier, validation_timestamp, reference_data_version }.",
            "",
            "**Conditional field engine:** Implement the trigger → dependent field map. Key chains:",
            "- narcotics_prescribed = Y → prescriptions required; on C151/S → 16 opioid + pain estimates",
            "- missed_work = Y → returned_to_work required → cascade to hours/duties/restrictions",
            "- patient_no_phn_flag = N → patient_phn required (9 digits)",
            "- prior_conditions_flag = Y → prior_conditions_desc required",
            "- diagnosis_changed = Y → diagnosis_changed_desc required",
            "- consultation_letter_format = TEXT → letter_text required; ATTCH → attachment required",
            "- OIS: grasp_X_level = LIMITED → sub-fields; environment_restricted = Y → 7 env fields"
          ],
          "frd": [
            "Domain 4.2 Section 4.1: 16-check validation pipeline with severity levels. Section 4.2: Conditional field optionality engine with trigger chains."
          ],
          "tests": [
            "validateWcbClaim passes for valid C050E with all required fields",
            "validateWcbClaim error for missing required field",
            "validateWcbClaim enforces conditional: narcotics=Y but no prescriptions → error",
            "validateWcbClaim enforces conditional: missed_work=Y → returned_to_work required",
            "validateWcbClaim enforces PHN logic: no_phn_flag=N, missing PHN → error",
            "validateWcbClaim enforces data type: alphabetic field with numbers → error",
            "validateWcbClaim enforces max length",
            "validateWcbClaim enforces date ordering: exam < injury → error",
            "validateWcbClaim returns timing tier as warning"
          ]
        },
        {
          "id": "D04W-022",
          "description": "Service: POB-NOI validation, Contract/Role/Form enforcement, and timing deadline calculations",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-021"],
          "build": [
            "Add specialised validation modules to WCB service:",
            "",
            "**POB-NOI Combination Validator:**",
            "- Load 382-entry exclusion matrix from Reference Data into in-memory Set<string> of 'NOI_code:POB_code' tuples.",
            "- For each injury entry on the claim, check if (NOI, POB) tuple is in exclusion set.",
            "- On match: error with 'The combination of [NOI description] and [POB description] is not permitted by WCB' referencing the injury ordinal.",
            "- Matrix is versioned in Reference Data. Cache and reload on version change.",
            "",
            "**Side of Body Required Enforcer:**",
            "- Reference the 30 POB codes with their 'Side of Body Required' flag (17 of 30 require side).",
            "- For each injury entry, if POB requires side and side_of_body_code is null → error.",
            "",
            "**Contract ID / Role / Form ID Enforcer:**",
            "- Load permission matrix from constants (D04W-001).",
            "- For initial reports: validate (contract_id, role_code) permits form_id.",
            "- For follow-up reports: additionally validate parent chain — parent exists, terminal state, form type in 'Can Create From', same practitioner billing number.",
            "",
            "**Timing Deadline Calculator:**",
            "- `calculateTimingTier(dateOfExamination: Date, currentTimestamp: Date, formId: string)` — returns { tier: SAME_DAY | ON_TIME | LATE, deadline: Date, hoursRemaining: number }.",
            "- Business day calculation: M–F excluding 10 Alberta statutory holidays.",
            "- Date of examination = Day 0 (not counted).",
            "- 10:00 MT cutoff on deadline day.",
            "- Form-specific deadlines: C050E = 3 biz days, C151/C568A = 4 biz days.",
            "- Helper: `getAlbertaStatutoryHolidays(year: number)` — compute floating holidays (Family Day, Good Friday, Victoria Day, Labour Day, Thanksgiving) and fixed holidays."
          ],
          "tests": [
            "POB-NOI rejects Sprain(02100) + Brain(01100)",
            "POB-NOI allows valid combination",
            "Side of Body required for Ankle(42000) — missing → error",
            "Side of Body not required for Head(00000) — missing → no error",
            "Contract/Role/Form rejects GP + C050S",
            "Contract/Role/Form allows GP + C050E",
            "Follow-up chain: C151 from C050E (valid)",
            "Follow-up chain: C151 from C568A for GP (invalid)",
            "Timing: exam today, submit today → SAME_DAY",
            "Timing: exam 3 biz days ago for C050E → ON_TIME",
            "Timing: exam 4 biz days ago for C050E → LATE",
            "Timing: holiday excluded from business day count",
            "Timing: 10:00 MT cutoff respected"
          ]
        },
        {
          "id": "D04W-023",
          "description": "Service: WCB fee calculation — timing tiers, 351 premium codes, expedited services, unbundling, RRNP",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-022"],
          "build": [
            "Add fee calculation module to WCB service:",
            "",
            "- `calculateWcbFees(wcbClaimDetailId: string)` — calculates total expected fee for a WCB claim:",
            "",
            "  **Report fee (timing-based):**",
            "  - Determine timing tier (same-day / on-time / late) from D04W-022.",
            "  - Look up report fee from schedule: C050E ($94.15/$85.80/$54.08), C151 ($57.19/$52.12/$32.86), RF01E specialist ($115.05/$104.87/$66.09), RF03E specialist follow-up ($57.19/$52.12/$32.86).",
            "  - Fee schedule versioned in Reference Data (Domain 2).",
            "",
            "  **Invoice line fees:**",
            "  - Each HSC is looked up in WCB fee schedule (subset of SOMB codes).",
            "  - **Premium code check:** If HSC is in the 351 premium code list → fee = SOMB_base × 2.",
            "  - **Premium exclusion:** Premium codes excluded when date_of_service within 4 calendar days of date_of_injury.",
            "  - **Premium limit:** One premium code per operative encounter.",
            "  - **Unbundling:** WCB pays 100% per distinct service — no bundling discounts. Do NOT apply AHCIP bundling rules.",
            "",
            "  **Expedited service fees:**",
            "  - If consultation has expedite_requested = Y:",
            "    - Completed within 15 business days → full expedited fee",
            "    - 16–25 business days → pro-rated",
            "    - After 25 business days → no expedited fee",
            "",
            "  **RRNP:**",
            "  - Rural/Remote Northern Physician flat fee: $32.77/claim when physician qualifies (from Provider Management).",
            "  - RRNP Variable Fee Premium: quarterly rate from Reference Data.",
            "",
            "  Return: { report_fee, report_fee_tier, invoice_line_fees: [{ line_id, hsc, base_rate, premium_applied, fee }], expedited_fees, rrnp_fee, total_expected_fee }."
          ],
          "frd": [
            "Domain 4.2 Section 8: Complete fee calculation rules — timing tiers (Section 8.1), 351 premium codes at 2× SOMB (Section 8.2), expedited service tiers (Section 8.3), unbundling at 100% (Section 8.4), RRNP flat fee and variable premium (Section 8.5)."
          ],
          "tests": [
            "Report fee: C050E same-day = $94.15",
            "Report fee: C050E on-time = $85.80",
            "Report fee: C050E late = $54.08",
            "Premium code: HSC in 351 list → 2× SOMB rate",
            "Premium exclusion: service within 4 days of injury → no premium",
            "Premium limit: only one premium per encounter",
            "Unbundling: two services same date → both at 100%",
            "Expedited fee: completed within 15 biz days → full fee",
            "Expedited fee: 20 biz days → pro-rated",
            "RRNP: qualifying physician → $32.77 added",
            "Total fee aggregation correct"
          ]
        },
        {
          "id": "D04W-024",
          "description": "Service: WCB batch assembly and HL7 v2.3.1 XML generation",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-013", "D04W-020"],
          "build": [
            "Add batch assembly and XML generation to WCB service:",
            "",
            "- `assembleAndGenerateBatch(physicianId: string, userId: string)` — end-to-end batch pipeline:",
            "  1. Create batch record (ASSEMBLING).",
            "  2. Fetch all queued WCB claims for physician.",
            "  3. For each claim: run validation. Skip claims that fail.",
            "  4. Assign validated claims to batch.",
            "  5. Generate HL7 v2.3.1 XML batch file.",
            "  6. Store encrypted XML file. Set xml_file_path, xml_file_hash.",
            "  7. Transition batch to GENERATED.",
            "  8. Emit audit: wcb.batch_generated.",
            "  Return wcb_batch_id.",
            "",
            "- `generateBatchXml(batchId: string, claims: WcbClaimDetail[])` — generate HL7 XML:",
            "  **Document structure (exact nesting order):**",
            "  - ZRPT_P03 (root, namespace urn:WCBhl7_v231-schema_modern_v100)",
            "    - FHS (file header: sending/receiving app+facility, timestamp, filename, file_control_id)",
            "    - ZRPT_P03.LST.6 > ZRPT_P03.GRP.4 (batch wrapper)",
            "      - BHS (batch header: batch_control_id)",
            "      - ZRPT_P03.LST.5 > ZRPT_P03.GRP.3 > ZRPT_P03.GRP.2 (per report)",
            "        - MSH (message header: submitter_txn_id)",
            "        - EVN (event: form_id, report_completion_date)",
            "        - PRD (provider: name, skill_code, fax)",
            "        - PID (patient: PHN, DOB, demographics)",
            "        - PV1 (visit: clinic_reference_number)",
            "        - FT1 (financial: billing number, contract_id, exam date, diagnosis, invoice lines — repeats per line)",
            "        - ACC (accident: date_of_injury)",
            "        - NTE (notes: additional_comments)",
            "        - OBX (observations: all clinical data — repeats per observation type)",
            "      - BTS (batch trailer: report count)",
            "    - FTS (file trailer: batch count = 1)",
            "",
            "  **Header values:** FHS.3/BHS.3/MSH.3 = vendor source ID (from secrets). FHS.5/BHS.5 = 'WCB-EDM'. FHS.6/BHS.6 = 'RAPID-RPT'. Timestamps in Mountain Time.",
            "  **OBX mapping:** Each clinical observation is a separate OBX with coded identifier (PRACTITIONER_ROLE, EMPNAME, JOBTITL, INJSYMP, OBJFIND, etc.).",
            "  **Special character encoding:** Escape &, <, >, \" in all free-text fields.",
            "  **Attachments:** Base64-encoded file content in OBX segments."
          ],
          "security": [
            "XML file contains PHI (PHN, name, DOB, diagnosis, employer). Encrypt at rest.",
            "Vendor source ID and submitter ID loaded from secrets management — never hardcoded.",
            "Batch generation audit-logged with actor, timestamp, batch reference."
          ],
          "tests": [
            "assembleAndGenerateBatch creates batch and assigns claims",
            "assembleAndGenerateBatch skips claims that fail validation",
            "generateBatchXml produces valid XML structure",
            "XML contains correct namespace",
            "XML header values match vendor credentials",
            "XML timestamps in Mountain Time format",
            "XML escapes special characters in free-text fields",
            "XML includes base64 attachments correctly",
            "XML FT1 segments repeat per invoice line",
            "XML OBX segments map clinical fields correctly"
          ]
        },
        {
          "id": "D04W-025",
          "description": "Service: XSD validation, batch download with signed URL, and upload confirmation",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-024"],
          "build": [
            "Add XSD validation and download services:",
            "",
            "- `validateBatchXsd(wcbBatchId: string)` — validate generated XML against both XSD schemas:",
            "  1. WCBhl7_v231_modern_v100.xsd (structural validation).",
            "  2. WCBhl7_v231_modern_v100_validate.xsd (data validation).",
            "  3. If passed: transition batch to VALIDATED, set xsd_validation_passed = true.",
            "  4. If failed: transition to ERROR, store errors in xsd_validation_errors JSONB. Map errors back to source claim/field where possible.",
            "  XSD files stored as versioned assets in Reference Data. Use server-side XML validation library.",
            "",
            "- `generateDownloadUrl(wcbBatchId: string, physicianId: string)` — generate a signed download URL for the batch XML:",
            "  - Requires batch status = VALIDATED.",
            "  - URL expires after 1 hour.",
            "  - Single-use (mark as downloaded, or use signed URL nonce).",
            "  - Emit audit: wcb.batch_downloaded.",
            "",
            "- `confirmBatchUpload(wcbBatchId: string, userId: string)` — confirm the physician/delegate uploaded to myWCB:",
            "  - Requires status = VALIDATED (or already downloaded).",
            "  - Transition to UPLOADED.",
            "  - Set uploaded_at, uploaded_by.",
            "  - Emit audit: wcb.batch_uploaded.",
            "  - Emit notification: WCB_BATCH_UPLOADED.",
            "",
            "XSD validation is Phase 2 only. In MVP mode, batch endpoints are not available."
          ],
          "security": [
            "Download URL is time-limited (1h), single-use, and authenticated. Cannot be shared.",
            "XSD files themselves are not sensitive but must be versioned to match current WCB schema.",
            "Upload confirmation requires WCB_BATCH_UPLOAD permission (RBAC from Domain 1)."
          ],
          "tests": [
            "validateBatchXsd passes for valid XML",
            "validateBatchXsd fails and stores errors for invalid XML",
            "validateBatchXsd transitions to ERROR on failure",
            "generateDownloadUrl requires VALIDATED status",
            "generateDownloadUrl returns signed URL with 1h expiry",
            "confirmBatchUpload transitions to UPLOADED",
            "confirmBatchUpload rejects if not VALIDATED"
          ]
        },
        {
          "id": "D04W-026",
          "description": "Service: WCB return file parsing, claim matching, and state transitions",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-014", "D04W-020"],
          "build": [
            "Add return file processing to WCB service:",
            "",
            "- `processReturnFile(physicianId: string, fileContent: string)` — parse and process WCB return file:",
            "  1. Parse tab-delimited text file:",
            "     - Batch header: BatchID, ReportCount, SubmitterID, SubmitDate.",
            "     - Per-report block: ReportTxnID, SubmitterTxnID, ProcessedClaim#, ClaimDecision, ReportStatus, TxnSubmissionDate.",
            "     - For Complete reports: per-invoice-line rows (InvoiceSequence#, ServiceDate, HSC, InvoiceStatus).",
            "     - For Invalid reports: error rows (ErrorNumber: ErrorDescription).",
            "  2. Match batch via BatchID → wcb_batches.batch_control_id.",
            "  3. For each report:",
            "     a. Match to claim via SubmitterTxnID → wcb_claim_details.submitter_txn_id.",
            "     b. Store in wcb_return_records.",
            "     c. If Complete: store invoice lines in wcb_return_invoice_lines. Transition claim to 'assessed' (Domain 4.0 state machine).",
            "     d. If Invalid: parse error format 'error_code: message'. Store errors JSONB. Map to Meritum fields. Transition claim to 'rejected'.",
            "     e. If ProcessedClaim# provided and claim has no wcb_claim_number: store it.",
            "  4. Emit notifications: WCB_RETURN_RECEIVED, WCB_CLAIM_ACCEPTED (per claim), WCB_CLAIM_REJECTED (per claim).",
            "  5. Update batch: RETURN_RECEIVED. If all reports processed → RECONCILED.",
            "  6. Emit audit: wcb.return_processed.",
            "",
            "  Handle unmatched SubmitterTxnIDs gracefully: store with wcb_claim_detail_id = null, emit WCB_RETURN_UNMATCHED alert.",
            "",
            "  Return: { matched_count, complete_count, invalid_count, unmatched_count, errors: [] }."
          ],
          "frd": [
            "Domain 4.2 Section 6: Return file format (tab-delimited, two sections per report), ingestion workflow (8 steps), error handling (error_code:message format, mapped_field, correction guidance)."
          ],
          "tests": [
            "processReturnFile parses valid return file",
            "processReturnFile matches batch by BatchID",
            "processReturnFile matches reports by SubmitterTxnID",
            "Complete report transitions claim to assessed",
            "Invalid report transitions claim to rejected with errors",
            "ProcessedClaim# stored on claim when provided",
            "Unmatched SubmitterTxnID stored with null claim reference",
            "Mixed Complete and Invalid handled independently",
            "Notifications emitted for each outcome",
            "Batch status updated to RETURN_RECEIVED"
          ]
        },
        {
          "id": "D04W-027",
          "description": "Service: WCB payment remittance XML parsing and reconciliation",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-014", "D04W-023"],
          "build": [
            "Add remittance processing to WCB service:",
            "",
            "- `processRemittanceFile(physicianId: string, xmlContent: string)` — parse and reconcile WCB remittance:",
            "  1. Parse XML against Schema_RRPaymentRemittanceReport_2_01_00.xsd (namespace http://www.wcb.ab.ca/schemas/RR/RRPaymentRemittanceReport-2.01.00).",
            "  2. Extract ReportWeek (StartDate, EndDate) and all PaymentRemittanceRecord elements.",
            "  3. Create remittance import record.",
            "  4. For each PaymentRemittanceRecord:",
            "     a. Store in wcb_remittance_records.",
            "     b. Match to claim: ElectronicReportTransactionID → wcb_return_records.report_txn_id → wcb_claim_details.",
            "     c. Compare payment_amount to expected fee (from D04W-023 fee calculator). Flag discrepancies.",
            "     d. Handle payment_status codes: ISS → claim to 'paid'. REQ/PAE/PGA/PGD → no state change, notify. REJ/DEL → flag for review.",
            "     e. Track overpayment_recovery amounts.",
            "  5. Emit: WCB_PAYMENT_RECEIVED notification with summary.",
            "  6. Emit audit: wcb.remittance_processed.",
            "",
            "  **Discrepancy detection reasons:**",
            "  - WCB applied different timing tier",
            "  - WCB disallowed modifier/premium code",
            "  - Overpayment recovery deducted",
            "  - Fee schedule change between submission and payment",
            "",
            "  Return: { import_id, record_count, matched_count, total_payment, discrepancy_count }."
          ],
          "frd": [
            "Domain 4.2 Section 7: Remittance XML schema (namespace, structure), reconciliation workflow (6 steps), 7 payment status codes, discrepancy detection causes."
          ],
          "tests": [
            "processRemittanceFile parses valid remittance XML",
            "Remittance records stored with all 31 fields",
            "Match via ElectronicReportTransactionID chain works",
            "ISS status transitions claim to paid",
            "REJ status flags claim for review",
            "Discrepancy detected when payment != expected",
            "Overpayment recovery tracked",
            "Unmatched records handled gracefully"
          ]
        },
        {
          "id": "D04W-028",
          "description": "Service: MVP export (pre-filled PDF) and manual outcome recording",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-020", "D04W-023"],
          "build": [
            "Add MVP-specific services:",
            "",
            "- `generateMvpExport(physicianId: string, wcbClaimDetailId: string)` — generate pre-filled export for manual portal entry:",
            "  1. Load full claim with all child records.",
            "  2. Run validation pipeline (Section 4). Warn on errors but allow export.",
            "  3. Calculate fees and timing tier.",
            "  4. Generate structured PDF/printable HTML that mirrors myWCB form layout.",
            "  5. Include: all form fields organised by section, calculated fees, timing tier indicator, deadline countdown.",
            "  6. Emit audit: wcb.mvp_export_generated.",
            "  Return: file buffer + content type.",
            "",
            "- `recordManualOutcome(physicianId: string, wcbClaimDetailId: string, data: ManualOutcomeInput)` — physician records WCB portal outcome:",
            "  1. Store wcb_claim_number if provided.",
            "  2. Update claim state: if accepted → 'assessed'. If rejected → 'rejected'.",
            "  3. Store payment_amount if provided.",
            "  4. Emit audit: wcb.manual_outcome_recorded.",
            "",
            "These endpoints are MVP-only and deprecated after vendor accreditation. The service should check a feature flag (WCB_PHASE) to determine availability.",
            "",
            "- `getTimingDashboard(physicianId: string)` — return all draft/queued WCB claims with their current timing tier, deadline, and fee difference to motivate timely submission. Key AI Coach integration point: 'Submit within [X hours] to earn [$Y] more.'"
          ],
          "tests": [
            "generateMvpExport produces PDF/HTML for C050E claim",
            "generateMvpExport includes all form sections",
            "generateMvpExport includes fee calculation and timing",
            "recordManualOutcome stores WCB claim number",
            "recordManualOutcome transitions claim state",
            "getTimingDashboard returns claims with deadline info",
            "MVP endpoints return 404 when WCB_PHASE = 2"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.2: WCB Claim Pathway — Routes & Integration Tests",
      "tasks": [
        {
          "id": "D04W-030",
          "description": "Routes and handlers for WCB claim CRUD + validation + form schema endpoints",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-020", "D04W-021"],
          "build": [
            "Create `apps/api/src/domains/wcb/wcb.routes.ts` and `wcb.handlers.ts`:",
            "",
            "Register under `/api/v1/wcb/` prefix. All routes require authentication (session cookie). All routes are physician-scoped.",
            "",
            "**Claim CRUD routes:**",
            "- POST /api/v1/wcb/claims — Create WCB claim. Body validated with wcbClaimCreateSchema. Permission: CLAIM_CREATE.",
            "- GET /api/v1/wcb/claims/:id — Retrieve claim + all child records. Permission: CLAIM_VIEW.",
            "- PUT /api/v1/wcb/claims/:id — Update claim (partial). Permission: CLAIM_EDIT.",
            "- DELETE /api/v1/wcb/claims/:id — Soft delete (draft only). Permission: CLAIM_DELETE.",
            "- POST /api/v1/wcb/claims/:id/validate — Run validation pipeline, return results. Permission: CLAIM_VIEW.",
            "- GET /api/v1/wcb/claims/:id/form-schema — Return form field schema for form_id. Permission: CLAIM_VIEW.",
            "",
            "**Handler pattern:** Thin handlers that extract params, call service, format response. Consistent error formatting.",
            "",
            "**Delegate support:** Delegates with appropriate permissions can access these routes. The physician context (from Domain 1 delegate context switch) determines scoping."
          ],
          "security": [
            "All routes require session cookie and permission checks per Domain 1 RBAC.",
            "UUID params validated with Zod before service call.",
            "Responses must not leak cross-physician data — service layer enforces scoping."
          ],
          "tests": [
            "POST /wcb/claims creates claim and returns IDs",
            "GET /wcb/claims/:id returns claim with child records",
            "PUT /wcb/claims/:id updates claim",
            "DELETE /wcb/claims/:id soft-deletes draft claim",
            "DELETE /wcb/claims/:id returns 400 for non-draft",
            "POST /wcb/claims/:id/validate returns validation results",
            "GET /wcb/claims/:id/form-schema returns schema"
          ]
        },
        {
          "id": "D04W-031",
          "description": "Routes and handlers for WCB batch management, return file, remittance, and MVP endpoints",
          "verify": "pnpm --filter api vitest run src/domains/wcb/wcb.test.ts",
          "depends": ["D04W-024", "D04W-025", "D04W-026", "D04W-027", "D04W-028"],
          "build": [
            "Add to `apps/api/src/domains/wcb/wcb.routes.ts`:",
            "",
            "**Batch Management routes:**",
            "- POST /api/v1/wcb/batches — Initiate batch generation. Permission: BATCH_APPROVE.",
            "- GET /api/v1/wcb/batches/:id — Retrieve batch details. Permission: BATCH_VIEW.",
            "- GET /api/v1/wcb/batches/:id/download — Download XML (signed URL). Permission: BATCH_VIEW + WCB_BATCH_UPLOAD.",
            "- POST /api/v1/wcb/batches/:id/confirm-upload — Confirm portal upload. Permission: WCB_BATCH_UPLOAD.",
            "- GET /api/v1/wcb/batches — List batches with filtering. Permission: BATCH_VIEW.",
            "",
            "**Return File routes:**",
            "- POST /api/v1/wcb/returns/upload — Upload return file (multipart). Permission: BATCH_VIEW.",
            "- GET /api/v1/wcb/returns/:batch_id — Get return results for batch. Permission: BATCH_VIEW.",
            "",
            "**Remittance routes:**",
            "- POST /api/v1/wcb/remittances/upload — Upload remittance XML (multipart). Permission: REPORT_VIEW.",
            "- GET /api/v1/wcb/remittances — List remittance imports. Permission: REPORT_VIEW.",
            "- GET /api/v1/wcb/remittances/:id/discrepancies — Get discrepancies. Permission: REPORT_VIEW.",
            "",
            "**MVP routes (feature-flagged):**",
            "- GET /api/v1/wcb/claims/:id/export — Generate pre-filled export. Permission: CLAIM_VIEW.",
            "- POST /api/v1/wcb/claims/:id/manual-outcome — Record manual outcome. Permission: CLAIM_EDIT.",
            "",
            "Total: 14 WCB-specific endpoints."
          ],
          "security": [
            "Batch download requires both BATCH_VIEW and WCB_BATCH_UPLOAD permissions.",
            "Return file upload must validate file format before processing.",
            "Remittance upload must validate XML against XSD before processing.",
            "MVP routes return 404 when WCB_PHASE != 'mvp'."
          ],
          "tests": [
            "POST /wcb/batches creates batch",
            "GET /wcb/batches/:id returns batch details",
            "GET /wcb/batches/:id/download returns signed URL when VALIDATED",
            "POST /wcb/batches/:id/confirm-upload transitions to UPLOADED",
            "POST /wcb/returns/upload processes return file",
            "GET /wcb/returns/:batch_id returns return results",
            "POST /wcb/remittances/upload processes remittance",
            "GET /wcb/remittances/:id/discrepancies returns discrepancies",
            "GET /wcb/claims/:id/export generates PDF (MVP mode)",
            "POST /wcb/claims/:id/manual-outcome records outcome (MVP mode)"
          ]
        },
        {
          "id": "D04W-032",
          "description": "Integration tests: WCB claim lifecycle (create, validate, submit, return, reconcile)",
          "verify": "pnpm --filter api vitest run test/integration/wcb/",
          "depends": ["D04W-030", "D04W-031"],
          "build": [
            "Create `apps/api/test/integration/wcb/wcb-lifecycle.integration.ts`:",
            "",
            "**End-to-end lifecycle scenarios:**",
            "",
            "1. **GP First Report (C050E) — happy path:**",
            "   Create physician → create C050E claim with injuries, invoice lines → validate (passes) → queue → batch assembly → XML generation → XSD validation → download → confirm upload → return file (Complete) → claim assessed → remittance → claim paid.",
            "",
            "2. **GP Progress Report (C151) chained from C050E:**",
            "   Create C050E (assessed) → create C151 linked to C050E → add opioid monitoring fields → validate → submit lifecycle.",
            "",
            "3. **OIS First Report (C050S) with expanded restrictions:**",
            "   Create OIS practitioner (000053/OIS) → create C050S → fill all grasping, zone lifting, reaching, environmental, assessment summary fields → validate → verify all OIS fields pass.",
            "",
            "4. **Specialist Consultation (C568A) with attachment:**",
            "   Create specialist → C568A with consultation_letter_format = ATTCH → add attachment → validate → batch → XML includes base64 attachment.",
            "",
            "5. **Invoice Correction (C570) with Was/Should Be pairing:**",
            "   Create C568 (assessed) → create C570 → add WAS line + SHOULD_BE line with matching pair → validate pairing → submit.",
            "",
            "6. **Rejected claim → correct → resubmit:**",
            "   Create claim → batch → return file (Invalid with errors) → claim rejected → physician corrects fields → revalidate → new batch → return file (Complete).",
            "",
            "7. **Batch with mixed form types:**",
            "   Queue C050E + C568 + C569 → single batch → XML with 3 reports → return file with mixed outcomes.",
            "",
            "8. **MVP flow:**",
            "   Create claim → validate → export PDF → manual outcome recording."
          ],
          "frd": [
            "Domain 4.2 Section 11.7: WCB billing scenarios — 10 end-to-end scenarios covering all form types, rejection recovery, mixed batches, and MVP flow."
          ]
        },
        {
          "id": "D04W-033",
          "description": "Integration tests: WCB validation engine (all 16 checks, conditional cascades, POB-NOI matrix)",
          "verify": "pnpm --filter api vitest run test/integration/wcb/",
          "depends": ["D04W-030"],
          "build": [
            "Create `apps/api/test/integration/wcb/wcb-validation.integration.ts`:",
            "",
            "**Form type validation:**",
            "- Each of 8 form types with minimum required fields → passes",
            "- Each form type with maximum fields (all conditionals triggered) → passes",
            "- Contract/Role not permitted for form type → error",
            "- Follow-up chain: C151 from C050E (valid), C151 from C568A for GP (invalid)",
            "",
            "**Conditional field cascades (via API):**",
            "- narcotics = Y but no prescriptions → error",
            "- narcotics = Y on C151 but missing opioid monitoring fields → error",
            "- missed_work = Y but returned_to_work missing → error",
            "- returned_to_work = Y but date/hours/duties missing → error",
            "- modified_duties = Y but no restriction entries → error",
            "- patient_no_phn_flag = N but PHN missing → error",
            "- prior_conditions_flag = Y but desc missing → error",
            "- consultation_letter_format = TEXT but text missing → error",
            "",
            "**POB-NOI matrix (representative set):**",
            "- Sprain(02100) + Brain(01100) → rejected",
            "- Fracture(01200) + Personal effects(91000) → rejected",
            "- Valid combination → passes",
            "- Side of Body required for Knee(41200) — missing → error",
            "",
            "**Data type and length:**",
            "- Alphabetic field with numbers → error",
            "- Field exceeding max length by 1 → error",
            "- Invalid date format → error",
            "- Date of exam before date of injury → error",
            "",
            "**Timing and fees (via validate endpoint):**",
            "- Same-day submission → correct tier in response",
            "- Near-deadline submission → warning with hours remaining"
          ]
        },
        {
          "id": "D04W-034",
          "description": "Integration tests: batch XML generation, XSD validation, return file and remittance processing",
          "verify": "pnpm --filter api vitest run test/integration/wcb/",
          "depends": ["D04W-031"],
          "build": [
            "Create `apps/api/test/integration/wcb/wcb-pipeline.integration.ts`:",
            "",
            "**XML Generation:**",
            "- Generate XML for each form type → validate structure against expected HL7 segments",
            "- Batch with multiple reports (mixed form types) → correct segment ordering",
            "- XML element ordering matches XSD requirements",
            "- Special character encoding (&, <, >, \") in free-text fields",
            "- Base64 encoding of file attachments in OBX segments",
            "- Batch with and without attachments",
            "- Header values: FHS/BHS/MSH contain correct vendor credentials",
            "",
            "**XSD Validation:**",
            "- Valid XML passes both XSD schemas",
            "- XML with missing required element fails structural XSD",
            "- XML with invalid data format fails validation XSD",
            "- Failed validation stores errors in xsd_validation_errors",
            "",
            "**Return File Processing:**",
            "- Parse successful return file: all claims matched, states → assessed",
            "- Parse error return file: errors extracted, claims → rejected",
            "- Unmatched SubmitterTxnID: graceful handling, alert emitted",
            "- Mixed Complete/Invalid: each handled independently",
            "- WCB claim number stored when provided",
            "",
            "**Remittance Processing:**",
            "- Parse remittance XML: all records stored",
            "- Match via ElectronicReportTransactionID chain",
            "- Detect payment discrepancy",
            "- Handle all 7 payment status codes",
            "- Overpayment recovery tracked"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.2: WCB Claim Pathway — Security Tests",
      "tasks": [
        {
          "id": "D04W-040",
          "description": "Security: authentication enforcement on every WCB route",
          "verify": "pnpm --filter api vitest run test/security/wcb/wcb.authn.security.ts",
          "depends": ["D04W-030", "D04W-031"],
          "build": [
            "Create `apps/api/test/security/wcb/wcb.authn.security.ts`.",
            "",
            "Test every authenticated WCB route returns 401 without a valid session cookie:",
            "",
            "- POST /api/v1/wcb/claims",
            "- GET /api/v1/wcb/claims/:id",
            "- PUT /api/v1/wcb/claims/:id",
            "- DELETE /api/v1/wcb/claims/:id",
            "- POST /api/v1/wcb/claims/:id/validate",
            "- GET /api/v1/wcb/claims/:id/form-schema",
            "- POST /api/v1/wcb/batches",
            "- GET /api/v1/wcb/batches/:id",
            "- GET /api/v1/wcb/batches/:id/download",
            "- POST /api/v1/wcb/batches/:id/confirm-upload",
            "- GET /api/v1/wcb/batches",
            "- POST /api/v1/wcb/returns/upload",
            "- GET /api/v1/wcb/returns/:batch_id",
            "- POST /api/v1/wcb/remittances/upload",
            "- GET /api/v1/wcb/remittances",
            "- GET /api/v1/wcb/remittances/:id/discrepancies",
            "- GET /api/v1/wcb/claims/:id/export",
            "- POST /api/v1/wcb/claims/:id/manual-outcome",
            "",
            "For each route: no cookie → 401, expired cookie → 401, tampered cookie → 401.",
            "All 401 responses must contain no data beyond the error object."
          ],
          "security": [
            "18 WCB endpoints × 3 auth failure modes = 54 test cases.",
            "401 responses must not leak any WCB claim data, batch info, or validation results."
          ]
        },
        {
          "id": "D04W-041",
          "description": "Security: authorization and role/permission enforcement for WCB routes",
          "verify": "pnpm --filter api vitest run test/security/wcb/wcb.authz.security.ts",
          "depends": ["D04W-030", "D04W-031"],
          "build": [
            "Create `apps/api/test/security/wcb/wcb.authz.security.ts`.",
            "",
            "**Permission enforcement:**",
            "- POST /wcb/claims without CLAIM_CREATE → 403",
            "- GET /wcb/claims/:id without CLAIM_VIEW → 403",
            "- PUT /wcb/claims/:id without CLAIM_EDIT → 403",
            "- DELETE /wcb/claims/:id without CLAIM_DELETE → 403",
            "- POST /wcb/batches without BATCH_APPROVE → 403",
            "- GET /wcb/batches/:id/download without WCB_BATCH_UPLOAD → 403",
            "",
            "**Delegate permission boundary:**",
            "- Delegate with CLAIM_VIEW only → cannot POST /wcb/claims (no CLAIM_CREATE) → 403",
            "- Delegate with CLAIM_VIEW + CLAIM_CREATE → can create WCB claims",
            "- Delegate without BATCH_APPROVE → cannot create batches",
            "- Delegate without BATCH_VIEW → cannot view batch details",
            "",
            "**Contract/Role validation as authz:**",
            "- Physician with Contract 000001/GP attempts to create C050S (requires 000053/OIS) → rejected at validation, not 403 (business rule, not authz)",
            "",
            "**Upload permission:**",
            "- Delegate without WCB_BATCH_UPLOAD → cannot download batch or confirm upload"
          ]
        },
        {
          "id": "D04W-042",
          "description": "Security: cross-physician tenant isolation (MOST CRITICAL)",
          "verify": "pnpm --filter api vitest run test/security/wcb/wcb.scoping.security.ts",
          "depends": ["D04W-030", "D04W-031"],
          "build": [
            "Create `apps/api/test/security/wcb/wcb.scoping.security.ts`.",
            "",
            "Create two physicians (physician1, physician2) using createSecurityPair fixture.",
            "",
            "**Claim isolation:**",
            "- Physician1 creates WCB claim → physician2 GET /wcb/claims/:id → 404 (not 403)",
            "- Physician1 creates WCB claim → physician2 PUT /wcb/claims/:id → 404",
            "- Physician1 creates WCB claim → physician2 DELETE /wcb/claims/:id → 404",
            "- Physician1's claim list does not include physician2's claims",
            "",
            "**Batch isolation:**",
            "- Physician1 creates batch → physician2 GET /wcb/batches/:id → 404",
            "- Physician1's batch → physician2 cannot download XML",
            "- Physician1's batch → physician2 cannot confirm upload",
            "- Physician1 batch list does not include physician2's batches",
            "",
            "**Return/remittance isolation:**",
            "- Physician2 cannot access physician1's return results",
            "- Physician2 cannot access physician1's remittance discrepancies",
            "",
            "**Child record isolation:**",
            "- Physician2 cannot access physician1's claim attachments",
            "",
            "**Delegate cross-context isolation:**",
            "- Delegate linked to physician1 only → cannot access physician2's WCB claims",
            "- Delegate linked to both → physician1 context shows only physician1's data",
            "",
            "**Important:** All cross-physician access attempts return 404, not 403 (do not confirm resource existence)."
          ]
        },
        {
          "id": "D04W-043",
          "description": "Security: input validation and injection prevention for WCB endpoints",
          "verify": "pnpm --filter api vitest run test/security/wcb/wcb.input.security.ts",
          "depends": ["D04W-030", "D04W-031"],
          "build": [
            "Create `apps/api/test/security/wcb/wcb.input.security.ts`.",
            "",
            "**SQL injection payloads on string inputs:**",
            "- patient_first_name: `' OR 1=1--`",
            "- employer_name: `'; DROP TABLE wcb_claim_details;--`",
            "- injury_description: SQL injection payloads",
            "- additional_comments: SQL injection payloads",
            "",
            "**XSS payloads on stored text fields:**",
            "- treatment_plan_text: `<script>alert(1)</script>`",
            "- objective_findings: `<img onerror=alert(1) src=x>`",
            "- consultation_letter_text: XSS payloads",
            "",
            "**Type coercion attacks:**",
            "- Send number where string expected for form_id",
            "- Send array where string expected for wcb_claim_number",
            "- Send null where required field expected",
            "- Send negative ordinal for injury entry",
            "- Send ordinal > 5 for injury entry",
            "- Send invoice_detail_id > 25",
            "",
            "**UUID parameter validation:**",
            "- Non-UUID in /wcb/claims/not-a-uuid → 400",
            "- Non-UUID in /wcb/batches/not-a-uuid → 400",
            "",
            "**WCB-specific validation attacks:**",
            "- form_id with invalid value (e.g., 'C999') → 400",
            "- patient_phn with 8 digits (below 9) → validation error",
            "- patient_phn with letters → validation error",
            "- Attachment file_content_b64 with invalid base64 → 400",
            "- Return file upload with binary content (not tab-delimited) → 400",
            "- Remittance upload with invalid XML → 400",
            "",
            "**Boundary values:**",
            "- Additional_comments at exactly 2048 chars → accepted",
            "- Additional_comments at 2049 chars → rejected",
            "- Patient_first_name at 11 chars → accepted",
            "- Patient_first_name at 12 chars → rejected"
          ]
        },
        {
          "id": "D04W-044",
          "description": "Security: PHI leakage prevention for WCB data",
          "verify": "pnpm --filter api vitest run test/security/wcb/wcb.leakage.security.ts",
          "depends": ["D04W-030", "D04W-031"],
          "build": [
            "Create `apps/api/test/security/wcb/wcb.leakage.security.ts`.",
            "",
            "**PHI not in error responses:**",
            "- 400 validation error does not include patient PHN or name in error message",
            "- 404 response does not confirm whether the WCB claim exists",
            "- 500 error does not expose stack traces, SQL errors, or internal details",
            "",
            "**PHI not in headers:**",
            "- No X-Powered-By header",
            "- No Server header revealing version",
            "- HSTS header present",
            "- CSP headers present",
            "",
            "**Sensitive WCB data not leaked:**",
            "- Vendor credentials (source ID, submitter ID) not exposed in API responses",
            "- Batch XML file path not exposed in API responses (only signed download URL)",
            "- Return file raw content not exposed in GET response (only parsed/structured data)",
            "- Base64 attachment content not included in claim list responses (only metadata)",
            "",
            "**WCB-specific PHI protection:**",
            "- Employer details (name, location, phone) not leaked to unauthorized users",
            "- Opioid prescription details not leaked in error messages",
            "- Injury descriptions not leaked in validation errors",
            "- Worker PHN in remittance records not exposed in discrepancy reports beyond what physician needs",
            "",
            "**Audit log sanitisation:**",
            "- Audit entries for WCB operations do not contain plaintext PHN, patient names, or clinical data in detail JSONB"
          ]
        },
        {
          "id": "D04W-045",
          "description": "Security: audit trail completeness for WCB operations",
          "verify": "pnpm --filter api vitest run test/security/wcb/wcb.audit.security.ts",
          "depends": ["D04W-030", "D04W-031"],
          "build": [
            "Create `apps/api/test/security/wcb/wcb.audit.security.ts`.",
            "",
            "Verify that each WCB state change produces an audit record:",
            "",
            "**Claim events:**",
            "- WCB claim created → wcb.claim_created with claim_id, form_id",
            "- WCB claim updated → wcb.claim_updated with changed fields",
            "- WCB claim deleted → wcb.claim_deleted with claim_id",
            "- WCB claim validated → wcb.claim_validated with passed/failed, error_count",
            "",
            "**Batch events:**",
            "- Batch generated → wcb.batch_generated with batch_id, report_count",
            "- Batch XSD validated → wcb.batch_xsd_validated with passed/failed",
            "- Batch downloaded → wcb.batch_downloaded with batch_id, actor",
            "- Batch upload confirmed → wcb.batch_uploaded with batch_id, actor, timestamp",
            "",
            "**Return/remittance events:**",
            "- Return file processed → wcb.return_processed with matched_count, error_count",
            "- Remittance processed → wcb.remittance_processed with record_count, total_payment",
            "",
            "**MVP events:**",
            "- MVP export generated → wcb.mvp_export_generated with claim_id",
            "- Manual outcome recorded → wcb.manual_outcome_recorded with outcome_type",
            "",
            "**Audit log integrity:**",
            "- No UPDATE operations on audit_log for WCB entries",
            "- No DELETE operations on audit_log for WCB entries",
            "- Audit entries contain correct actor (physician_id or delegate_id)"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.2: WCB Claim Pathway — Final Validation",
      "tasks": [
        {
          "id": "D04W-099",
          "description": "Full domain test suite: all unit + integration + security tests for WCB Pathway",
          "verify": "pnpm --filter api vitest run src/domains/wcb/ test/integration/wcb/ test/security/wcb/",
          "depends": ["D04W-040", "D04W-041", "D04W-042", "D04W-043", "D04W-044", "D04W-045"],
          "build": [
            "Run the complete test suite for Domain 4.2 WCB Claim Pathway. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/wcb/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/wcb/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/wcb/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/wcb/ test/integration/wcb/ test/security/wcb/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/wcb/wcb.authn.security.ts",
            "- test/security/wcb/wcb.authz.security.ts",
            "- test/security/wcb/wcb.scoping.security.ts",
            "- test/security/wcb/wcb.input.security.ts",
            "- test/security/wcb/wcb.leakage.security.ts",
            "- test/security/wcb/wcb.audit.security.ts",
            "",
            "Verify all 11 WCB tables have complete CRUD coverage.",
            "Verify all 18 API endpoints have integration test coverage.",
            "Verify all 8 form types have at least one validation test."
          ]
        }
      ]
    }
  ]
}
