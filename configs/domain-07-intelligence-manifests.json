{
  "domainNumber": "07",
  "domainName": "Intelligence Engine",
  "manifestFile": "domain-07-intelligence.tasks",
  "promptPrefix": "d07",
  "modulePath": "apps/api/src/domains/intelligence",
  "sections": [
    {
      "title": "Domain 7: Intelligence Engine — Shared Types & Constants",
      "tasks": [
        {
          "id": "D07-001",
          "description": "Intelligence Engine constants: tiers, suggestion categories, priorities, statuses, event types, learning thresholds",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/intelligence.constants.ts` with all Intelligence Engine constants:",
            "",
            "**Tiers enum:**",
            "- TIER_1 (Deterministic Rules Engine — zero LLM cost, ~80% of suggestions)",
            "- TIER_2 (Self-Hosted LLM — low cost, ~15% of suggestions)",
            "- TIER_3 (Review Recommended — human review, ~5% of cases)",
            "",
            "**Suggestion Categories (11 total):**",
            "- MODIFIER_ADD: suggest adding a modifier (Tier 1, 2)",
            "- MODIFIER_REMOVE: modifier is invalid or suboptimal (Tier 1)",
            "- CODE_ALTERNATIVE: different HSC code more appropriate (Tier 1, 2)",
            "- CODE_ADDITION: additional code billable for same encounter (Tier 1, 2)",
            "- MISSED_BILLING: billable service performed but not claimed (Tier 1, 2)",
            "- REJECTION_RISK: claim likely to be rejected (Tier 1)",
            "- DOCUMENTATION_GAP: required documentation missing (Tier 1)",
            "- FEE_OPTIMISATION: different billing approach yields more revenue (Tier 1, 2)",
            "- WCB_TIMING: WCB tier will downgrade if not submitted sooner (Tier 1)",
            "- WCB_COMPLETENESS: WCB form has fields that improve acceptance (Tier 1)",
            "- REVIEW_RECOMMENDED: case too complex for automated analysis (Tier 3)",
            "",
            "**Suggestion Priorities:** HIGH, MEDIUM, LOW",
            "",
            "**Priority thresholds (defaults, configurable per specialty):**",
            "- HIGH: revenue_impact > $20 OR rejection risk confidence > 0.80",
            "- MEDIUM: revenue_impact $5–$20 OR rejection risk 0.50–0.80",
            "- LOW: revenue_impact < $5, informational, or documentation",
            "",
            "**Suggestion Statuses:** PENDING, ACCEPTED, DISMISSED",
            "",
            "**Suggestion Event Types:** GENERATED, ACCEPTED, DISMISSED, SUPPRESSED, UNSUPPRESSED",
            "",
            "**Rule Claim Types:** AHCIP, WCB, BOTH",
            "",
            "**Learning Loop Constants:**",
            "- SUPPRESSION_THRESHOLD: 5 (consecutive dismissals before rule is suppressed)",
            "- MIN_COHORT_SIZE: 10 (minimum physicians per specialty cohort before aggregates used)",
            "- CALIBRATION_CLAIMS: 50 (claims before personalisation overrides specialty defaults)",
            "- ROLLING_WINDOW_DAYS: 90 (for seasonal pattern detection)",
            "- LLM_TIMEOUT_MS: 3000 (Tier 2 latency budget)",
            "- LLM_CONFIDENCE_THRESHOLD: 0.60 (below this → escalate to Tier 3)",
            "",
            "**MVP Rule Categories and approximate counts:**",
            "- Modifier Eligibility: ~30 rules",
            "- Rejection Prevention: ~40 rules",
            "- WCB-Specific: ~20 rules",
            "- Pattern-Based: ~15 rules",
            "- Total MVP: ~105 rules",
            "",
            "Export all as frozen objects / TypeScript enums."
          ],
          "frd": [
            "Domain 7 Section 1.2: Three-tier architecture with percentage breakdown. Section 2.2: 11 suggestion categories with tier applicability.",
            "Domain 7 Section 2.3: Priority thresholds. Section 6.2: Learning loop adaptation mechanisms (suppression=5, cohort min=10, 90-day rolling window).",
            "Domain 7 Section 4.3: LLM timeout 3s, confidence threshold 0.60."
          ]
        },
        {
          "id": "D07-002",
          "description": "Drizzle schema for ai_rules table",
          "verify": "pnpm --filter shared build",
          "depends": ["D07-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/intelligence.schema.ts` with the ai_rules table:",
            "",
            "**ai_rules table:**",
            "",
            "| Column | Type | Nullable | Description |",
            "|--------|------|----------|-------------|",
            "| rule_id | UUID | No | PK, gen_random_uuid() |",
            "| name | VARCHAR(100) | No | Human-readable (e.g., 'CMGP Modifier Eligibility') |",
            "| category | VARCHAR(30) | No | Maps to suggestion category enum |",
            "| claim_type | VARCHAR(10) | No | AHCIP, WCB, or BOTH |",
            "| conditions | JSONB | No | Structured condition tree evaluated against claim context |",
            "| suggestion_template | JSONB | No | Template: title, description (with placeholders), revenue_impact formula, source_reference |",
            "| specialty_filter | JSONB | Yes | Array of specialty codes. Null = all specialties |",
            "| priority_formula | VARCHAR(100) | No | Priority calculation expression (e.g., 'revenue_impact > 20 ? HIGH : MEDIUM') |",
            "| is_active | BOOLEAN | No | DEFAULT true. Inactive rules skipped |",
            "| somb_version | VARCHAR(20) | Yes | SOMB version this rule was derived from |",
            "| created_at | TIMESTAMPTZ | No | DEFAULT now() |",
            "| updated_at | TIMESTAMPTZ | No | DEFAULT now() |",
            "",
            "**Indexes:** index on (category, is_active), index on (claim_type, is_active), index on somb_version.",
            "",
            "**Condition tree JSONB structure (document as TypeScript interface):**",
            "```",
            "type Condition = {",
            "  type: 'field_compare' | 'existence' | 'set_membership' | 'temporal' | 'cross_claim' | 'and' | 'or' | 'not';",
            "  field?: string;  // dot-notation path into claim context",
            "  operator?: '==' | '!=' | '>' | '<' | '>=' | '<=' | 'IS NULL' | 'IS NOT NULL' | 'IN' | 'NOT IN';",
            "  value?: any;  // literal or ref.{reference_data_key}",
            "  children?: Condition[];  // for and/or/not combinators",
            "  query?: CrossClaimQuery;  // for cross_claim type",
            "}",
            "```",
            "",
            "**Suggestion template JSONB structure:**",
            "```",
            "type SuggestionTemplate = {",
            "  title: string;  // with {{field}} placeholders",
            "  description: string;  // with {{field}} placeholders",
            "  revenue_impact_formula?: string;  // expression or fixed value",
            "  source_reference: string;",
            "  source_url?: string;",
            "  suggested_changes?: { field: string; value_formula: string }[];",
            "}",
            "```",
            "",
            "Export table and inferred types."
          ],
          "frd": [
            "Domain 7 Section 7.1: ai_rules table (12 columns). Section 3.2: Rule structure with condition tree and suggestion template.",
            "Domain 7 Section 3.3: Rule condition language — 6 condition types (field compare, existence, set membership, temporal, cross-claim, combinators)."
          ]
        },
        {
          "id": "D07-003",
          "description": "Drizzle schema for ai_provider_learning and ai_specialty_cohorts tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D07-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/intelligence.schema.ts`:",
            "",
            "**ai_provider_learning table (per-physician per-rule learning state):**",
            "",
            "| Column | Type | Nullable | Description |",
            "|--------|------|----------|-------------|",
            "| learning_id | UUID | No | PK |",
            "| provider_id | UUID FK | No | FK → providers |",
            "| rule_id | UUID FK | No | FK → ai_rules |",
            "| times_shown | INTEGER | No | DEFAULT 0. Total times rule generated suggestion |",
            "| times_accepted | INTEGER | No | DEFAULT 0 |",
            "| times_dismissed | INTEGER | No | DEFAULT 0 |",
            "| consecutive_dismissals | INTEGER | No | DEFAULT 0. Resets on acceptance |",
            "| is_suppressed | BOOLEAN | No | DEFAULT false. True when consecutive_dismissals >= 5 |",
            "| priority_adjustment | INTEGER | No | DEFAULT 0. -1 demote, 0 no change, +1 promote |",
            "| last_shown_at | TIMESTAMPTZ | Yes | |",
            "| last_feedback_at | TIMESTAMPTZ | Yes | |",
            "| created_at | TIMESTAMPTZ | No | |",
            "| updated_at | TIMESTAMPTZ | No | |",
            "",
            "Constraint: UNIQUE(provider_id, rule_id). Created lazily on first suggestion.",
            "Indexes: (provider_id, is_suppressed), (rule_id).",
            "",
            "**ai_specialty_cohorts table (aggregate rates per specialty per rule):**",
            "",
            "| Column | Type | Nullable | Description |",
            "|--------|------|----------|-------------|",
            "| cohort_id | UUID | No | PK |",
            "| specialty_code | VARCHAR(10) | No | |",
            "| rule_id | UUID FK | No | FK → ai_rules |",
            "| physician_count | INTEGER | No | Min 10 for use |",
            "| acceptance_rate | DECIMAL(5,4) | No | 0.0000–1.0000 |",
            "| median_revenue_impact | DECIMAL(10,2) | Yes | |",
            "| updated_at | TIMESTAMPTZ | No | Last recalculation |",
            "",
            "Constraint: UNIQUE(specialty_code, rule_id).",
            "Index: (specialty_code).",
            "",
            "Export tables and inferred types."
          ],
          "frd": [
            "Domain 7 Section 7.2: ai_provider_learning (13 columns). Lazy creation, UNIQUE on provider+rule. Suppression at 5 consecutive dismissals.",
            "Domain 7 Section 7.3: ai_specialty_cohorts (7 columns). Nightly update. Minimum 10 physicians per cohort."
          ]
        },
        {
          "id": "D07-004",
          "description": "Drizzle schema for ai_suggestion_events audit table",
          "verify": "pnpm --filter shared build",
          "depends": ["D07-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/intelligence.schema.ts`:",
            "",
            "**ai_suggestion_events table (append-only audit log):**",
            "",
            "| Column | Type | Nullable | Description |",
            "|--------|------|----------|-------------|",
            "| event_id | UUID | No | PK |",
            "| claim_id | UUID FK | No | FK → claims |",
            "| suggestion_id | UUID | No | Suggestion ID from claim's JSONB |",
            "| rule_id | UUID FK | Yes | FK → ai_rules. Null for Tier 2/3 not from rule library |",
            "| provider_id | UUID FK | No | FK → providers |",
            "| event_type | VARCHAR(20) | No | GENERATED, ACCEPTED, DISMISSED, SUPPRESSED, UNSUPPRESSED |",
            "| tier | INTEGER | No | 1, 2, or 3 |",
            "| category | VARCHAR(30) | No | Suggestion category |",
            "| revenue_impact | DECIMAL(10,2) | Yes | Revenue impact at time of event |",
            "| dismissed_reason | TEXT | Yes | For DISMISSED events |",
            "| created_at | TIMESTAMPTZ | No | |",
            "",
            "**CRITICAL:** Append-only. No UPDATE or DELETE operations. Same pattern as Domain 1 audit_log.",
            "",
            "Indexes: (claim_id), (provider_id, created_at DESC), (rule_id, event_type), (category, created_at DESC).",
            "",
            "Export table and inferred types."
          ],
          "security": [
            "Append-only: the repository must NOT expose update or delete functions for this table.",
            "dismissed_reason is free-text from physician — must be sanitised before storage (no SQL/XSS).",
            "No PHI stored in this table — only billing metadata (suggestion IDs, categories, revenue impacts)."
          ],
          "frd": [
            "Domain 7 Section 7.4: ai_suggestion_events (11 columns). Append-only. Used for learning loop analysis and platform metrics."
          ]
        },
        {
          "id": "D07-005",
          "description": "Zod validation schemas for all Intelligence Engine API endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D07-001"],
          "build": [
            "Create `packages/shared/src/schemas/intelligence.schema.ts` with Zod schemas:",
            "",
            "**Suggestion Endpoints (consumed by Domain 4):**",
            "- analyseClaimSchema: { claim_id: uuid(), claim_context: object({ claim_type, health_service_code, modifiers, date_of_service, provider_specialty, patient_demographics_anonymised, ... }) }",
            "- claimSuggestionsParamSchema: { claim_id: uuid() }",
            "- suggestionIdParamSchema: { id: uuid() }",
            "- acceptSuggestionSchema: {} (suggestion ID in URL, no body needed)",
            "- dismissSuggestionSchema: { reason: string().max(500).optional() }",
            "",
            "**Suggestion response schema (for JSONB validation):**",
            "- suggestionSchema: { suggestion_id: uuid(), tier: number().int().min(1).max(3), category: enum(CATEGORIES), priority: enum(PRIORITIES), title: string().max(200), description: string(), revenue_impact: number().nullable(), confidence: number().min(0).max(1).nullable(), source_reference: string().max(200), source_url: string().url().max(500).optional(), suggested_changes: array(object({ field, current_value, suggested_value })).nullable(), status: enum(STATUSES), dismissed_reason: string().nullable(), created_at: datetime(), resolved_at: datetime().nullable(), resolved_by: uuid().nullable() }",
            "",
            "**Learning & Preferences:**",
            "- unsuppressRuleParamSchema: { rule_id: uuid() }",
            "- updatePreferencesSchema: { enabled_categories: array(enum(CATEGORIES)).optional(), disabled_categories: array(enum(CATEGORIES)).optional(), priority_thresholds: object({ high_revenue, medium_revenue }).optional() }",
            "",
            "**Rule Management (Admin):**",
            "- createRuleSchema: { name: string().max(100), category: enum(CATEGORIES), claim_type: enum(CLAIM_TYPES), conditions: object() (JSONB condition tree), suggestion_template: object() (JSONB template), specialty_filter: array(string()).nullable(), priority_formula: string().max(100), somb_version: string().max(20).optional() }",
            "- updateRuleSchema: partial of createRuleSchema",
            "- ruleIdParamSchema: { id: uuid() }",
            "- activateRuleSchema: { is_active: boolean() }",
            "- ruleListQuerySchema: { category: enum(CATEGORIES).optional(), claim_type: enum(CLAIM_TYPES).optional(), is_active: boolean().optional(), page: number().default(1), page_size: number().max(100).default(50) }",
            "",
            "**SOMB Change Analysis:**",
            "- sombChangeAnalysisSchema: { old_version: string(), new_version: string() }",
            "",
            "Export all schemas and inferred TypeScript types."
          ],
          "frd": [
            "Domain 7 Section 8: All 4 API endpoint groups — suggestion endpoints (4), learning/preferences (3), rule management (6), SOMB analysis (1). Total 14 endpoints.",
            "Domain 7 Section 2.1: Suggestion structure (16 fields)."
          ]
        },
        {
          "id": "D07-006",
          "description": "Generate and apply database migration for all Intelligence Engine tables",
          "verify": "cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1",
          "depends": ["D07-002", "D07-003", "D07-004"],
          "build": [
            "Run the Drizzle migration generator for all Intelligence Engine tables:",
            "",
            "```bash",
            "cd apps/api",
            "pnpm drizzle-kit generate",
            "pnpm drizzle-kit migrate",
            "```",
            "",
            "Verify migration created in `apps/api/drizzle/migrations/`.",
            "Verify all 4 tables exist: ai_rules, ai_provider_learning, ai_specialty_cohorts, ai_suggestion_events.",
            "Verify FK constraints to providers table (Domain 5) and claims table (Domain 4.0) resolve.",
            "Verify UNIQUE constraints: (provider_id, rule_id) on ai_provider_learning, (specialty_code, rule_id) on ai_specialty_cohorts.",
            "Verify all indexes created."
          ]
        }
      ]
    },
    {
      "title": "Domain 7: Intelligence Engine — Repository Layer",
      "tasks": [
        {
          "id": "D07-010",
          "description": "Repository: ai_rules CRUD operations (list, get, create, update, activate/deactivate)",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-006"],
          "build": [
            "Create `apps/api/src/domains/intelligence/intelligence.repository.ts`:",
            "",
            "**Rule operations:**",
            "- `listRules(filters: { category?, claim_type?, is_active?, specialty_code?, page, page_size })` — paginated list with optional filters. When specialty_code provided, include rules where specialty_filter IS NULL or contains the code.",
            "- `getRule(ruleId: string)` — single rule by ID.",
            "- `createRule(data: CreateRuleInput)` — insert new rule. Admin only (enforced at route level).",
            "- `updateRule(ruleId: string, data: UpdateRuleInput)` — partial update. Set updated_at.",
            "- `activateRule(ruleId: string, isActive: boolean)` — toggle is_active.",
            "- `getActiveRulesForClaim(claimType: string, specialtyCode: string)` — fetch all active rules matching claim_type (BOTH or specific) and specialty_filter (null or includes specialty). Optimised query for Tier 1 evaluation.",
            "- `getRuleStats(ruleId: string)` — aggregate stats: total_shown, total_accepted, total_dismissed, acceptance_rate, suppression_count across all physicians. Join ai_provider_learning.",
            "- `getRulesByVersion(sombVersion: string)` — fetch rules derived from a specific SOMB version. For change analysis."
          ],
          "tests": [
            "listRules returns paginated results",
            "listRules filters by category",
            "listRules filters by claim_type",
            "listRules filters by specialty (null filter matches all)",
            "getActiveRulesForClaim returns rules for AHCIP + BOTH",
            "getActiveRulesForClaim respects specialty_filter",
            "createRule inserts rule with condition tree",
            "updateRule updates conditions and template",
            "activateRule toggles is_active",
            "getRuleStats returns aggregate acceptance rate"
          ]
        },
        {
          "id": "D07-011",
          "description": "Repository: ai_provider_learning operations (get/upsert learning state, suppression management)",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-006"],
          "build": [
            "Add to `apps/api/src/domains/intelligence/intelligence.repository.ts`:",
            "",
            "**Provider learning state:**",
            "- `getLearningState(providerId: string, ruleId: string)` — get or return null (lazy creation).",
            "- `getOrCreateLearningState(providerId: string, ruleId: string)` — get existing or insert default state.",
            "- `incrementShown(providerId: string, ruleId: string)` — increment times_shown, set last_shown_at. Create if not exists.",
            "- `recordAcceptance(providerId: string, ruleId: string)` — increment times_accepted. Reset consecutive_dismissals to 0. If is_suppressed, set to false. Set last_feedback_at.",
            "- `recordDismissal(providerId: string, ruleId: string)` — increment times_dismissed and consecutive_dismissals. If consecutive_dismissals >= SUPPRESSION_THRESHOLD (5), set is_suppressed = true. Set last_feedback_at.",
            "- `unsuppressRule(providerId: string, ruleId: string)` — set is_suppressed = false, reset consecutive_dismissals to 0.",
            "- `getSuppressedRules(providerId: string)` — list all suppressed rules for physician.",
            "- `getLearningStateSummary(providerId: string)` — aggregate: suppressed_count, top_accepted_categories (top 3 by acceptance count), total_suggestions_shown, overall_acceptance_rate.",
            "- `getProviderLearningForRules(providerId: string, ruleIds: string[])` — batch fetch learning states for multiple rules. Used during Tier 1 evaluation to check suppression.",
            "",
            "**Priority adjustment:**",
            "- `updatePriorityAdjustment(providerId: string, ruleId: string, adjustment: -1 | 0 | 1)` — set priority_adjustment. Derived from acceptance rate thresholds (>70% accepted → +1, <30% accepted → -1, else 0)."
          ],
          "tests": [
            "getOrCreateLearningState creates on first call",
            "getOrCreateLearningState returns existing on second call",
            "incrementShown increments counter and sets timestamp",
            "recordAcceptance resets consecutive_dismissals",
            "recordAcceptance unsuppresses if suppressed",
            "recordDismissal increments consecutive_dismissals",
            "recordDismissal auto-suppresses at threshold 5",
            "unsuppressRule clears suppression and resets counter",
            "getSuppressedRules returns only suppressed",
            "getProviderLearningForRules batch fetches correctly"
          ]
        },
        {
          "id": "D07-012",
          "description": "Repository: ai_specialty_cohorts and ai_suggestion_events operations",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-006"],
          "build": [
            "Add to `apps/api/src/domains/intelligence/intelligence.repository.ts`:",
            "",
            "**Specialty cohort operations:**",
            "- `getCohortDefaults(specialtyCode: string, ruleId: string)` — get aggregate for specialty+rule. Return null if physician_count < MIN_COHORT_SIZE (10).",
            "- `upsertCohortAggregate(specialtyCode: string, ruleId: string, data: CohortAggregateInput)` — insert or update aggregate. Called by nightly recalculation job.",
            "- `recalculateAllCohorts()` — compute aggregates for every (specialty, rule) pair from ai_provider_learning. Group by specialty (from provider table join), calculate acceptance_rate = times_accepted / times_shown, median_revenue_impact from ai_suggestion_events. Only include cohorts with physician_count >= 10.",
            "- `listCohorts(filters: { specialty_code?, rule_id? })` — for admin review.",
            "",
            "**Suggestion events (append-only):**",
            "- `appendSuggestionEvent(event: SuggestionEventInput)` — insert single event. The ONLY write operation.",
            "- `getSuggestionEventsForClaim(claimId: string)` — all events for a claim, chronological.",
            "- `getSuggestionEventsForProvider(providerId: string, filters: { category?, tier?, event_type?, start_date?, end_date?, page, page_size })` — paginated, reverse chronological.",
            "- `getRulePerformanceEvents(ruleId: string, filters: { event_type?, start_date?, end_date? })` — for rule stats dashboard.",
            "",
            "**CRITICAL:** ai_suggestion_events has NO update or delete functions. Append-only."
          ],
          "security": [
            "ai_suggestion_events is append-only. No UPDATE, no DELETE. Hard requirement.",
            "Cohort aggregation requires physician_count >= 10. Smaller cohorts are excluded to prevent de-identification.",
            "Specialty cohort data contains no PHI — only billing pattern aggregates."
          ],
          "tests": [
            "getCohortDefaults returns null when physician_count < 10",
            "getCohortDefaults returns data when physician_count >= 10",
            "recalculateAllCohorts computes correct acceptance_rate",
            "recalculateAllCohorts excludes small cohorts",
            "appendSuggestionEvent inserts event",
            "getSuggestionEventsForClaim returns chronological",
            "getSuggestionEventsForProvider filters by category",
            "ai_suggestion_events has no update function",
            "ai_suggestion_events has no delete function"
          ]
        }
      ]
    },
    {
      "title": "Domain 7: Intelligence Engine — Service Layer",
      "tasks": [
        {
          "id": "D07-020",
          "description": "Service: Tier 1 deterministic rules engine — condition evaluator and claim context builder",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-010", "D07-011"],
          "build": [
            "Create `apps/api/src/domains/intelligence/intelligence.service.ts` with the Tier 1 rules engine:",
            "",
            "**Claim context builder:**",
            "- `buildClaimContext(claimId: string, providerId: string)` — assemble the context object from:",
            "  - Claim fields (Domain 4.0): HSC, modifiers, DI codes, dates, time_spent, etc.",
            "  - Patient demographics (anonymised — no PHN, no name, just age/gender for rule evaluation)",
            "  - Provider context (specialty, practice location, billing patterns from Domain 5)",
            "  - Reference Data lookups (SOMB code details, governing rules, modifier eligibility lists)",
            "  - Claim history for cross-claim queries (same patient, same period)",
            "",
            "**Condition evaluator:**",
            "- `evaluateCondition(condition: Condition, context: ClaimContext)` — recursive evaluator for condition tree:",
            "  - field_compare: extract field value from context via dot-notation path, compare with operator",
            "  - existence: check IS NULL / IS NOT NULL",
            "  - set_membership: check if value is IN or NOT IN a reference set (resolved from ref.{key})",
            "  - temporal: evaluate time-based conditions (weekday, time ranges, date arithmetic)",
            "  - cross_claim: execute pre-fetched cross-claim aggregation (COUNT/SUM with filters)",
            "  - and/or/not: recursive evaluation of children array",
            "  Return boolean.",
            "",
            "**IMPORTANT:** The evaluator operates on a pre-fetched context object, NOT raw database queries. This prevents SQL injection from condition JSONB. All Reference Data lookups are resolved during context building, not during evaluation."
          ],
          "security": [
            "Condition evaluator NEVER executes raw SQL. All data is pre-fetched into the context object.",
            "Cross-claim queries are parameterised and scoped to the current physician's data.",
            "Patient PHN and name are excluded from claim context — only age/gender for demographic rules."
          ],
          "tests": [
            "buildClaimContext assembles claim, provider, and reference data",
            "buildClaimContext anonymises patient (no PHN, no name)",
            "evaluateCondition: field_compare == returns true for match",
            "evaluateCondition: field_compare > returns true for greater",
            "evaluateCondition: existence IS NULL returns true for null field",
            "evaluateCondition: set_membership IN returns true for member",
            "evaluateCondition: temporal weekday check works",
            "evaluateCondition: cross_claim COUNT returns correct count",
            "evaluateCondition: AND combinator short-circuits on false",
            "evaluateCondition: OR combinator short-circuits on true",
            "evaluateCondition: nested conditions evaluate correctly"
          ]
        },
        {
          "id": "D07-021",
          "description": "Service: Tier 1 rule execution — evaluate all rules, generate suggestions, apply learning state",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-020"],
          "build": [
            "Add Tier 1 rule execution to `intelligence.service.ts`:",
            "",
            "- `evaluateTier1Rules(claimId: string, providerId: string)` — main Tier 1 entry point:",
            "  1. Build claim context (D07-020).",
            "  2. Determine claim_type (AHCIP or WCB) and provider specialty.",
            "  3. Fetch active rules for this claim_type and specialty (D07-010).",
            "  4. Batch-fetch learning states for provider + all candidate rules (D07-011).",
            "  5. For each rule:",
            "     a. Check if suppressed for this provider → skip if suppressed.",
            "     b. Evaluate condition tree against context → skip if false.",
            "     c. Render suggestion from template: interpolate placeholders, calculate revenue_impact, determine priority (base formula + provider's priority_adjustment).",
            "     d. Set confidence = 1.00 (deterministic), tier = 1.",
            "     e. Record GENERATED event in ai_suggestion_events.",
            "     f. Increment times_shown in learning state.",
            "  6. Deduplicate: if multiple rules produce suggestions for the same field/modifier, keep highest priority.",
            "  7. Sort by priority (HIGH first), then by revenue_impact descending.",
            "  Return: Suggestion[].",
            "",
            "- `renderSuggestion(template: SuggestionTemplate, context: ClaimContext, priorityAdjustment: number)` — interpolate template placeholders ({{hsc}}, {{modifier}}, {{fee_difference}}, etc.) with context values. Calculate priority from formula with adjustment.",
            "",
            "**Performance:** Tier 1 must complete synchronously within the claim save flow. Target: <100ms for 105 rules against one claim. Rules with cross_claim conditions are the bottleneck — pre-fetch claim history in context builder."
          ],
          "frd": [
            "Domain 7 Section 3.1: Tier 1 runs synchronously, zero latency, zero LLM cost. Section 3.4: MVP rule library ~105 rules across 4 categories.",
            "Domain 7 Section 6.2: Suppression threshold, priority adjustment, specialty calibration."
          ],
          "tests": [
            "evaluateTier1Rules returns suggestions for matching rules",
            "evaluateTier1Rules skips suppressed rules",
            "evaluateTier1Rules skips inactive rules",
            "evaluateTier1Rules skips rules not matching claim_type",
            "evaluateTier1Rules skips rules not matching specialty",
            "evaluateTier1Rules deduplicates same-field suggestions",
            "evaluateTier1Rules sorts by priority then revenue_impact",
            "evaluateTier1Rules records GENERATED events",
            "evaluateTier1Rules increments times_shown",
            "renderSuggestion interpolates placeholders correctly",
            "renderSuggestion applies priority adjustment"
          ]
        },
        {
          "id": "D07-022",
          "description": "Service: Tier 2 LLM integration — prompt building, PHI stripping, response processing, hallucination guard",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-020"],
          "build": [
            "Add Tier 2 LLM integration to intelligence service (or create `intelligence.llm.ts`):",
            "",
            "- `analyseTier2(claimId: string, providerId: string, tier1Results: Suggestion[])` — Tier 2 LLM analysis (async):",
            "  1. Build anonymised claim context (PHI stripped — PHN replaced with 'XXXNNNNNN', patient name replaced with 'PATIENT').",
            "  2. Construct structured prompt:",
            "     - System prompt: billing domain expert instructions, constraints (never fabricate, always cite SOMB/GR, acknowledge uncertainty).",
            "     - Context block: anonymised claim data, provider specialty, relevant SOMB rules from Reference Data, Tier 1 results.",
            "     - Task instruction: specific analysis request.",
            "  3. Call self-hosted LLM with 3-second timeout.",
            "  4. Process response:",
            "     a. Parse JSON response (explanation, confidence, source_reference).",
            "     b. If confidence < 0.60 → route to Tier 3 instead of Tier 2.",
            "     c. **Hallucination guard:** validate source_reference against Reference Data. If LLM cites non-existent SOMB section or GR → suppress suggestion, log for rule library improvement.",
            "     d. Convert to Suggestion structure with tier = 2.",
            "  5. If LLM timeout → return empty array. Tier 1 suggestions already delivered synchronously.",
            "  6. If LLM instance unavailable → graceful fallback (no Tier 2, Tier 3 flags for complex cases).",
            "",
            "- `stripPhi(claimContext: ClaimContext)` — replace patient PHN with placeholder, remove patient name. Keep billing structure (codes, modifiers, dates, clinical codes).",
            "",
            "- `validateLlmSourceReference(reference: string)` — check if cited SOMB section or GR number exists in Reference Data. Return boolean.",
            "",
            "**Infrastructure:** LLM HTTP endpoint on DigitalOcean Toronto. Single inference endpoint. Model loaded at startup."
          ],
          "security": [
            "PHI is NEVER sent to LLM. Patient PHN, name are replaced with placeholders before prompt construction.",
            "Self-hosted LLM: no data leaves Meritum infrastructure. Canadian data residency maintained.",
            "Hallucination guard prevents displaying suggestions based on non-existent rules.",
            "LLM timeout prevents blocking the claim save flow."
          ],
          "tests": [
            "stripPhi replaces PHN with placeholder",
            "stripPhi removes patient name",
            "stripPhi preserves billing codes and dates",
            "analyseTier2 constructs correct prompt structure",
            "analyseTier2 respects 3-second timeout",
            "analyseTier2 returns empty on timeout",
            "analyseTier2 routes low-confidence to Tier 3",
            "hallucination guard suppresses invalid SOMB reference",
            "hallucination guard allows valid SOMB reference",
            "analyseTier2 graceful fallback when LLM unavailable"
          ]
        },
        {
          "id": "D07-023",
          "description": "Service: Tier 3 review flagging and suggestion lifecycle (accept/dismiss)",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-021", "D07-022"],
          "build": [
            "Add Tier 3 and lifecycle management to intelligence service:",
            "",
            "**Tier 3 Review Flagging:**",
            "- `generateTier3Suggestion(trigger: string, context: ClaimContext, sourceReference: string, sourceUrl?: string)` — create Tier 3 suggestion:",
            "  - tier = 3, category = REVIEW_RECOMMENDED",
            "  - suggested_changes = null (no one-click accept)",
            "  - revenue_impact = null (cannot calculate for ambiguous)",
            "  - confidence = null (explicitly null — human review needed)",
            "  - title: describes area of concern",
            "  - description: plain-language explanation of ambiguity",
            "  - source_reference + source_url populated",
            "",
            "**Tier 3 triggers:** LLM confidence < 0.60, complex GR interactions, novel code combinations, conflicting rules, complex SOMB change impact.",
            "",
            "**Suggestion Lifecycle:**",
            "- `acceptSuggestion(claimId: string, suggestionId: string, providerId: string)` —",
            "  1. Find suggestion in claim's ai_coach_suggestions JSONB.",
            "  2. Apply suggested_changes to the claim (call Domain 4 update).",
            "  3. Set suggestion status = ACCEPTED, resolved_at, resolved_by.",
            "  4. Record ACCEPTED event in ai_suggestion_events.",
            "  5. Update learning state: recordAcceptance (resets consecutive_dismissals).",
            "  6. Trigger claim revalidation (Domain 4.0).",
            "",
            "- `dismissSuggestion(claimId: string, suggestionId: string, providerId: string, reason?: string)` —",
            "  1. Set suggestion status = DISMISSED, dismissed_reason, resolved_at, resolved_by.",
            "  2. Record DISMISSED event with reason.",
            "  3. Update learning state: recordDismissal (increment consecutive, check suppression threshold).",
            "",
            "- `getClaimSuggestions(claimId: string)` — read from claim's ai_coach_suggestions JSONB. Fast read, no analysis."
          ],
          "frd": [
            "Domain 7 Section 5: Tier 3 triggers, review suggestion format (no suggested_changes, no revenue_impact, no confidence).",
            "Domain 7 Section 2.1: Suggestion lifecycle — PENDING → ACCEPTED or DISMISSED."
          ],
          "tests": [
            "generateTier3Suggestion has null confidence and suggested_changes",
            "generateTier3Suggestion has REVIEW_RECOMMENDED category",
            "acceptSuggestion applies changes to claim",
            "acceptSuggestion sets status ACCEPTED",
            "acceptSuggestion records ACCEPTED event",
            "acceptSuggestion updates learning state (resets dismissals)",
            "acceptSuggestion triggers claim revalidation",
            "dismissSuggestion sets status DISMISSED with reason",
            "dismissSuggestion records DISMISSED event",
            "dismissSuggestion increments consecutive_dismissals",
            "dismissSuggestion auto-suppresses at threshold 5",
            "getClaimSuggestions reads from JSONB"
          ]
        },
        {
          "id": "D07-024",
          "description": "Service: main analyse endpoint — orchestrate Tier 1 sync + Tier 2 async + store on claim",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-021", "D07-022", "D07-023"],
          "build": [
            "Add main analysis orchestrator to intelligence service:",
            "",
            "- `analyseClaim(claimId: string, providerId: string)` — full analysis pipeline:",
            "  1. **Tier 1 (synchronous):** evaluateTier1Rules → immediate Suggestion[].",
            "  2. **Store Tier 1 results:** write suggestions to claim's ai_coach_suggestions JSONB (Domain 4.0 update).",
            "  3. **Return Tier 1 results** to caller immediately.",
            "  4. **Tier 2 (asynchronous):** fire-and-forget analyseTier2 call:",
            "     - On completion: append Tier 2 suggestions to claim's JSONB.",
            "     - Notify via WebSocket (if connected) or make available via polling.",
            "     - On timeout or failure: no degradation — Tier 1 results already delivered.",
            "  5. **Tier 3:** any Tier 3 flags generated during Tier 1 evaluation or Tier 2 low-confidence are included in the suggestion set.",
            "",
            "- `reanalyseClaim(claimId: string, providerId: string)` — re-run analysis after claim update. Clear previous PENDING suggestions, run full pipeline. Preserve ACCEPTED/DISMISSED suggestions.",
            "",
            "**WebSocket integration:**",
            "Use @fastify/websocket for real-time Tier 2 result delivery. Channel: `intelligence:claim:{claim_id}`. Event: `tier2_complete` with new suggestions.",
            "",
            "**Audit:** all analyse calls logged: intelligence.claim_analysed with claim_id, tier1_count, tier2_triggered, tier3_count."
          ],
          "tests": [
            "analyseClaim returns Tier 1 suggestions synchronously",
            "analyseClaim stores suggestions on claim JSONB",
            "analyseClaim triggers Tier 2 asynchronously",
            "analyseClaim includes Tier 3 flags in results",
            "Tier 2 results appended to claim JSONB on completion",
            "Tier 2 timeout does not affect Tier 1 delivery",
            "reanalyseClaim clears PENDING but preserves ACCEPTED/DISMISSED",
            "reanalyseClaim runs full pipeline"
          ]
        },
        {
          "id": "D07-025",
          "description": "Service: learning loop — priority adjustment, rejection feedback, specialty cohort recalculation",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-011", "D07-012"],
          "build": [
            "Add learning loop services to intelligence service:",
            "",
            "**Priority adjustment (called after each accept/dismiss):**",
            "- `recalculatePriorityAdjustment(providerId: string, ruleId: string)` —",
            "  Read learning state. Calculate acceptance_rate = times_accepted / times_shown.",
            "  If acceptance_rate > 0.70 and times_shown >= 5 → priority_adjustment = +1 (promote).",
            "  If acceptance_rate < 0.30 and times_shown >= 5 → priority_adjustment = -1 (demote).",
            "  Else → priority_adjustment = 0.",
            "  Priority never promoted above rule-defined maximum.",
            "",
            "**Rejection feedback (called when AHCIP/WCB returns rejection):**",
            "- `processRejectionFeedback(claimId: string, rejectionReason: string)` —",
            "  1. Find dismissed REJECTION_RISK suggestions for this claim.",
            "  2. If a dismissed suggestion predicted this rejection:",
            "     a. Re-enable the rule (unsuppress if suppressed).",
            "     b. Set priority_adjustment = +1 permanently.",
            "     c. Log feedback event for learning analysis.",
            "",
            "**Specialty cohort recalculation (nightly job):**",
            "- `recalculateSpecialtyCohorts()` — callable from admin endpoint or scheduled job:",
            "  1. For each (specialty, rule) combination in ai_provider_learning:",
            "     a. Count distinct providers (physician_count).",
            "     b. If physician_count >= 10: calculate aggregate acceptance_rate, median_revenue_impact.",
            "     c. Upsert into ai_specialty_cohorts.",
            "  2. Cohorts with < 10 physicians are not created or are deleted if previously existing.",
            "",
            "**New physician initialisation:**",
            "- `getDefaultPriorityForNewProvider(specialtyCode: string, ruleId: string)` — check specialty cohort. If exists and physician_count >= 10, use cohort's acceptance_rate to set initial priority_adjustment. Otherwise use default (0)."
          ],
          "frd": [
            "Domain 7 Section 6.1: Learning signals (acceptance, dismissal, rejection history, billing patterns, specialty cohort).",
            "Domain 7 Section 6.2: Adaptation mechanisms — priority adjustment, suppression, specialty calibration, rejection feedback, seasonal patterns.",
            "Domain 7 Section 6.3: Privacy — billing patterns only, min 10 physicians per cohort."
          ],
          "tests": [
            "recalculatePriorityAdjustment promotes at >70% acceptance",
            "recalculatePriorityAdjustment demotes at <30% acceptance",
            "recalculatePriorityAdjustment requires min 5 times_shown",
            "processRejectionFeedback re-enables suppressed rule",
            "processRejectionFeedback increases priority permanently",
            "processRejectionFeedback ignores claims without dismissed REJECTION_RISK",
            "recalculateSpecialtyCohorts computes correct aggregates",
            "recalculateSpecialtyCohorts excludes cohorts < 10 physicians",
            "getDefaultPriorityForNewProvider uses cohort when available",
            "getDefaultPriorityForNewProvider returns 0 when no cohort"
          ]
        },
        {
          "id": "D07-026",
          "description": "Service: SOMB change impact analysis and contextual help",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-010", "D07-021"],
          "build": [
            "Add SOMB change analysis and contextual help services:",
            "",
            "**SOMB Change Impact Analysis:**",
            "- `analyseSombChange(oldVersion: string, newVersion: string)` — compare SOMB versions and generate per-physician impact:",
            "  1. Fetch rules with somb_version = oldVersion.",
            "  2. Identify changed codes/rules between versions (from Reference Data version diff).",
            "  3. For each affected rule:",
            "     a. Identify physicians who have used this rule (from ai_provider_learning, times_shown > 0).",
            "     b. Assess impact: rule still valid? conditions changed? revenue impact changed?",
            "  4. Generate per-physician impact summary:",
            "     - affected_rules: list of rules with change type (updated, deprecated, new)",
            "     - affected_codes: list of HSC codes that changed",
            "     - estimated_revenue_impact: aggregate across affected rules",
            "     - plain_language_summary: use Tier 2 LLM to generate physician-friendly summary (or template if LLM unavailable)",
            "  5. Emit notification events per Domain 9 (Notification Service): SOMB_CHANGE_IMPACT per affected physician.",
            "  Return: { physician_impacts: PhysicianImpact[], total_affected_physicians, total_affected_rules }.",
            "",
            "**Contextual Help (consumed by frontend):**",
            "- `getFieldHelp(fieldName: string, context?: { hsc?, modifier?, form_id? })` — return help content from Reference Data: help_text, source_reference, source_url. Context narrows to specific code/modifier if provided.",
            "- `getGoverningRuleSummary(grNumber: string)` — return plain-language GR summary with official link.",
            "- `getCodeHelp(hscCode: string)` — return code description, fee, eligible modifiers, applicable GRs, tips.",
            "",
            "Help content is read-only from Reference Data — Intelligence Engine does NOT generate it."
          ],
          "frd": [
            "Domain 7 Section 9: Contextual help system — 5 content types (field tooltips, validation help, GR summaries, WCB guidance, SOMB change alerts). Content from Reference Data help_text fields.",
            "Domain 7 Section 8.4: SOMB change analysis endpoint. Impact analysis per physician."
          ],
          "tests": [
            "analyseSombChange identifies affected rules by version",
            "analyseSombChange generates per-physician impact",
            "analyseSombChange skips physicians with no usage of affected rules",
            "analyseSombChange emits notification events",
            "getFieldHelp returns help text from Reference Data",
            "getFieldHelp narrows by HSC context",
            "getGoverningRuleSummary returns summary with link",
            "getCodeHelp returns fee, modifiers, and GRs"
          ]
        },
        {
          "id": "D07-027",
          "description": "Service: MVP rule seeding — initial ~105 rules for modifier eligibility, rejection prevention, WCB, and patterns",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-021"],
          "build": [
            "Create `apps/api/src/domains/intelligence/intelligence.seed.ts` with MVP rule definitions:",
            "",
            "**Modifier Eligibility Rules (~30):**",
            "- CMGP eligibility: HSC in CMGP-eligible list AND modifier_1/2/3 not CMGP → suggest MODIFIER_ADD, revenue = CMGP_fee_addition",
            "- After-hours (AFHR): DOS time > 17:00 or < 08:00 or weekend AND no AFHR modifier → suggest",
            "- RRNP eligibility: provider location in RRNP-qualified list AND RRNP not applied → note",
            "- Shadow billing (TM): ARP physician AND no TM modifier → suggest",
            "- Time-based code: HSC is time-based AND time_spent missing/below threshold → DOCUMENTATION_GAP",
            "- Additional modifier rules per specialty patterns",
            "",
            "**Rejection Prevention Rules (~40):**",
            "- GR 3 visit limits: COUNT same patient + same code + same period >= limit → REJECTION_RISK HIGH",
            "- GR 8 referral: specialist consultation without referring practitioner → REJECTION_RISK HIGH",
            "- DI code required: HSC requires diagnostic code AND none present → REJECTION_RISK",
            "- Modifier conflicts: mutually exclusive modifiers both present → REJECTION_RISK",
            "- 90-day window: DOS within 7 days of deadline → timing WARNING",
            "- Sex mismatch: procedure code sex-specific but patient gender doesn't match → REJECTION_RISK",
            "- Age limit: HSC has age restriction AND patient age outside range → REJECTION_RISK",
            "",
            "**WCB-Specific Rules (~20):**",
            "- WCB timing tier: calculate current tier, show deadline for next → WCB_TIMING",
            "- Form completeness: optional fields that improve acceptance rates → WCB_COMPLETENESS",
            "- Premium code eligible: HSC in 351 list AND not excluded by 4-day rule AND not claimed → suggest",
            "- Follow-up reminder: parent claim assessed but follow-up not created within expected window → MISSED_BILLING",
            "",
            "**Pattern-Based Rules (~15):**",
            "- Missed billing: physician consistently bills Code A but never Code B (commonly paired) → MISSED_BILLING LOW",
            "- Under-utilised modifiers: physician modifier usage below specialty average → FEE_OPTIMISATION LOW",
            "- High rejection code: physician >20% rejection on specific HSC → REJECTION_RISK MEDIUM",
            "",
            "Create a `seedMvpRules()` function that idempotently inserts all rules (skip if name already exists). Each rule includes conditions JSONB, suggestion_template JSONB, claim_type, specialty_filter, and priority_formula.",
            "",
            "Export the seed function for use in setup scripts."
          ],
          "frd": [
            "Domain 7 Section 3.4: MVP rule library — modifier eligibility (~30), rejection prevention (~40), WCB-specific (~20), pattern-based (~15). Total ~105 rules."
          ],
          "tests": [
            "seedMvpRules inserts ~105 rules",
            "seedMvpRules is idempotent (second run inserts 0)",
            "CMGP rule conditions parse and evaluate correctly",
            "GR 3 rule uses cross_claim condition type",
            "WCB timing rule produces correct fee values",
            "Pattern rules use specialty_filter correctly"
          ]
        }
      ]
    },
    {
      "title": "Domain 7: Intelligence Engine — Routes & Integration Tests",
      "tasks": [
        {
          "id": "D07-030",
          "description": "Routes and handlers for suggestion endpoints and learning/preferences endpoints",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-024", "D07-025"],
          "build": [
            "Create `apps/api/src/domains/intelligence/intelligence.routes.ts` and `intelligence.handlers.ts`:",
            "",
            "Register under `/api/v1/intelligence/` prefix. All routes require authentication.",
            "",
            "**Suggestion Endpoints (consumed by Domain 4):**",
            "- POST /api/v1/intelligence/analyse — submit claim context for analysis. Returns Tier 1 suggestions synchronously. Triggers Tier 2 async. Permission: AI_COACH_VIEW.",
            "- GET /api/v1/intelligence/claims/:claim_id/suggestions — get all suggestions for a claim (from JSONB). Permission: AI_COACH_VIEW.",
            "- POST /api/v1/intelligence/suggestions/:id/accept — accept suggestion, apply changes. Permission: AI_COACH_MANAGE.",
            "- POST /api/v1/intelligence/suggestions/:id/dismiss — dismiss suggestion with optional reason. Permission: AI_COACH_MANAGE.",
            "",
            "**Learning & Preferences (Physician-facing):**",
            "- GET /api/v1/intelligence/me/learning-state — get learning summary (suppressed rules, top categories). Permission: AI_COACH_VIEW.",
            "- POST /api/v1/intelligence/me/rules/:rule_id/unsuppress — un-suppress a rule. Permission: AI_COACH_MANAGE.",
            "- PUT /api/v1/intelligence/me/preferences — set AI Coach preferences. Permission: AI_COACH_MANAGE.",
            "",
            "**WebSocket route for Tier 2 real-time delivery:**",
            "- WS /api/v1/intelligence/ws — authenticate via session cookie. Subscribe to claim analysis channels.",
            "",
            "Total: 7 HTTP endpoints + 1 WebSocket endpoint."
          ],
          "security": [
            "AI_COACH_VIEW permission required for read endpoints.",
            "AI_COACH_MANAGE permission required for accept/dismiss/unsuppress/preferences.",
            "Delegates with AI_COACH_MANAGE can accept/dismiss suggestions in physician context.",
            "WebSocket requires session authentication."
          ],
          "tests": [
            "POST /intelligence/analyse returns Tier 1 suggestions",
            "GET /intelligence/claims/:id/suggestions returns suggestions",
            "POST /intelligence/suggestions/:id/accept applies changes",
            "POST /intelligence/suggestions/:id/dismiss updates status",
            "GET /intelligence/me/learning-state returns summary",
            "POST /intelligence/me/rules/:id/unsuppress clears suppression",
            "PUT /intelligence/me/preferences updates preferences"
          ]
        },
        {
          "id": "D07-031",
          "description": "Routes and handlers for admin rule management and SOMB change analysis",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/intelligence.test.ts",
          "depends": ["D07-010", "D07-026"],
          "build": [
            "Add to `apps/api/src/domains/intelligence/intelligence.routes.ts`:",
            "",
            "**Rule Management (Admin only):**",
            "- GET /api/v1/intelligence/rules — list rules with status and stats. Permission: AI_COACH_VIEW (viewable by physicians for transparency) + ADMIN for full stats.",
            "- POST /api/v1/intelligence/rules — create rule. Permission: ADMIN only.",
            "- PUT /api/v1/intelligence/rules/:id — update rule. Permission: ADMIN only.",
            "- PUT /api/v1/intelligence/rules/:id/activate — activate/deactivate. Permission: ADMIN only.",
            "- GET /api/v1/intelligence/rules/:id/stats — rule performance stats. Permission: ADMIN only.",
            "- POST /api/v1/intelligence/cohorts/recalculate — trigger cohort recalculation. Permission: ADMIN only.",
            "",
            "**SOMB Change Analysis:**",
            "- POST /api/v1/intelligence/somb-change-analysis — generate per-physician impact. Permission: ADMIN only.",
            "",
            "**Physician rule list (transparency):**",
            "- GET /intelligence/rules for non-admin: returns rule name, category, description only. No conditions JSONB. No stats.",
            "",
            "Total additional: 7 HTTP endpoints."
          ],
          "security": [
            "Rule creation/modification is ADMIN only. Physicians can view rules (name + category) for transparency but not modify.",
            "Rule conditions JSONB not exposed to non-admin users (prevents reverse-engineering of billing rules).",
            "SOMB change analysis is ADMIN only — triggers notifications to many physicians."
          ],
          "tests": [
            "GET /intelligence/rules returns rules for physician (name+category only)",
            "POST /intelligence/rules creates rule as admin",
            "POST /intelligence/rules as non-admin → 403",
            "PUT /intelligence/rules/:id updates rule",
            "PUT /intelligence/rules/:id/activate toggles active",
            "GET /intelligence/rules/:id/stats returns aggregate metrics",
            "POST /intelligence/cohorts/recalculate triggers recalc",
            "POST /intelligence/somb-change-analysis generates impact"
          ]
        },
        {
          "id": "D07-032",
          "description": "Integration tests: full analysis pipeline (Tier 1 + Tier 2 + Tier 3 + learning loop)",
          "verify": "pnpm --filter api vitest run test/integration/intelligence/",
          "depends": ["D07-030", "D07-031"],
          "build": [
            "Create `apps/api/test/integration/intelligence/intelligence-pipeline.integration.ts`:",
            "",
            "**End-to-end scenarios:**",
            "",
            "1. **AHCIP claim → Tier 1 suggestions → accept → claim updated:**",
            "   Create AHCIP claim without CMGP modifier → analyse → CMGP suggestion returned → accept → modifier added to claim → revalidation passes.",
            "",
            "2. **WCB claim approaching deadline → WCB_TIMING suggestion:**",
            "   Create WCB C050E claim with date_of_examination 2 business days ago → analyse → WCB_TIMING suggestion with correct fee tiers ($94.15 vs $85.80 vs $54.08).",
            "",
            "3. **GR 3 rejection risk → dismiss → later rejection → feedback loop:**",
            "   Create claim exceeding GR 3 limit → REJECTION_RISK suggestion → physician dismisses → claim submitted → rejection returned → processRejectionFeedback → rule re-enabled.",
            "",
            "4. **Learning loop suppression:**",
            "   Dismiss same rule 5 consecutive times → rule suppressed → new claim does not generate that suggestion → un-suppress → suggestion appears again.",
            "",
            "5. **Tier 2 LLM analysis (mock):**",
            "   Create claim needing nuanced analysis → Tier 1 returns base suggestions → Tier 2 async returns additional CODE_ALTERNATIVE suggestion with explanation → appended to claim JSONB.",
            "",
            "6. **Tier 2 timeout fallback:**",
            "   Mock LLM timeout → Tier 1 suggestions delivered → no Tier 2 suggestions → no error.",
            "",
            "7. **Tier 3 escalation:**",
            "   Mock LLM confidence 0.45 → suggestion routed to Tier 3 → REVIEW_RECOMMENDED with source link, no suggested_changes.",
            "",
            "8. **Specialty cohort:**",
            "   Create 10+ physicians of same specialty with learning data → recalculate cohorts → new physician inherits defaults.",
            "",
            "9. **SOMB version change:**",
            "   Update SOMB version in Reference Data → trigger analysis → affected physicians identified → impact summaries generated.",
            "",
            "10. **Multiple rules on same claim:**",
            "    Claim triggers CMGP + GR 3 + missing DI code → 3 suggestions returned in priority order, no duplicates."
          ],
          "frd": [
            "Domain 7 Section 11: Testing requirements — Tier 1 tests (rule evaluation), Tier 2 tests (timeout, confidence, hallucination), learning loop tests (acceptance, suppression, feedback), integration tests (end-to-end scenarios)."
          ]
        },
        {
          "id": "D07-033",
          "description": "Integration tests: Tier 1 rule evaluation with MVP rules (modifier, rejection, WCB, patterns)",
          "verify": "pnpm --filter api vitest run test/integration/intelligence/",
          "depends": ["D07-027", "D07-030"],
          "build": [
            "Create `apps/api/test/integration/intelligence/intelligence-rules.integration.ts`:",
            "",
            "**Modifier Eligibility Tests:**",
            "- CMGP eligible claim without CMGP → suggestion generated",
            "- CMGP claim already with CMGP → no suggestion",
            "- AFHR eligible (after 17:00 weekday) → suggestion generated",
            "- AFHR on weekend → suggestion generated",
            "- AFHR during normal hours → no suggestion",
            "- RRNP eligible provider → RRNP suggestion",
            "- Shadow billing ARP physician → TM modifier suggestion",
            "- Time-based code without time_spent → DOCUMENTATION_GAP",
            "",
            "**Rejection Prevention Tests:**",
            "- GR 3 limit exceeded → HIGH priority REJECTION_RISK",
            "- GR 3 at limit (not exceeded) → MEDIUM warning",
            "- GR 8 specialist without referral → REJECTION_RISK",
            "- Missing DI code for category requiring it → REJECTION_RISK",
            "- Mutually exclusive modifiers → REJECTION_RISK",
            "",
            "**WCB-Specific Tests:**",
            "- C050E same-day tier → WCB_TIMING with correct fees",
            "- C050E approaching on-time deadline → WCB_TIMING with hours remaining",
            "- WCB premium code eligible but not claimed → MODIFIER_ADD",
            "- WCB follow-up not created within window → MISSED_BILLING",
            "",
            "**Specialty Filter Tests:**",
            "- Rule with specialty_filter = ['GP'] fires for GP",
            "- Rule with specialty_filter = ['GP'] does NOT fire for specialist",
            "- Rule with specialty_filter = null fires for all specialties",
            "",
            "**Priority and Deduplication:**",
            "- Multiple suggestions sorted by priority then revenue_impact",
            "- Same modifier suggested by two rules → highest priority kept"
          ]
        }
      ]
    },
    {
      "title": "Domain 7: Intelligence Engine — Security Tests",
      "tasks": [
        {
          "id": "D07-040",
          "description": "Security: authentication enforcement on every Intelligence Engine route",
          "verify": "pnpm --filter api vitest run test/security/intelligence/intelligence.authn.security.ts",
          "depends": ["D07-030", "D07-031"],
          "build": [
            "Create `apps/api/test/security/intelligence/intelligence.authn.security.ts`.",
            "",
            "Test every authenticated Intelligence Engine route returns 401 without valid session cookie:",
            "",
            "- POST /api/v1/intelligence/analyse",
            "- GET /api/v1/intelligence/claims/:claim_id/suggestions",
            "- POST /api/v1/intelligence/suggestions/:id/accept",
            "- POST /api/v1/intelligence/suggestions/:id/dismiss",
            "- GET /api/v1/intelligence/me/learning-state",
            "- POST /api/v1/intelligence/me/rules/:rule_id/unsuppress",
            "- PUT /api/v1/intelligence/me/preferences",
            "- GET /api/v1/intelligence/rules",
            "- POST /api/v1/intelligence/rules",
            "- PUT /api/v1/intelligence/rules/:id",
            "- PUT /api/v1/intelligence/rules/:id/activate",
            "- GET /api/v1/intelligence/rules/:id/stats",
            "- POST /api/v1/intelligence/cohorts/recalculate",
            "- POST /api/v1/intelligence/somb-change-analysis",
            "",
            "For each: no cookie → 401, expired cookie → 401, tampered cookie → 401.",
            "All 401 responses contain no data beyond error object."
          ],
          "security": [
            "14 HTTP endpoints × 3 auth failure modes = 42 test cases.",
            "401 responses must not leak rule conditions, suggestions, or learning state."
          ]
        },
        {
          "id": "D07-041",
          "description": "Security: authorization and role/permission enforcement",
          "verify": "pnpm --filter api vitest run test/security/intelligence/intelligence.authz.security.ts",
          "depends": ["D07-030", "D07-031"],
          "build": [
            "Create `apps/api/test/security/intelligence/intelligence.authz.security.ts`.",
            "",
            "**Permission enforcement:**",
            "- POST /intelligence/analyse without AI_COACH_VIEW → 403",
            "- POST /intelligence/suggestions/:id/accept without AI_COACH_MANAGE → 403",
            "- POST /intelligence/suggestions/:id/dismiss without AI_COACH_MANAGE → 403",
            "- PUT /intelligence/me/preferences without AI_COACH_MANAGE → 403",
            "",
            "**Admin-only enforcement:**",
            "- POST /intelligence/rules as non-admin → 403",
            "- PUT /intelligence/rules/:id as non-admin → 403",
            "- PUT /intelligence/rules/:id/activate as non-admin → 403",
            "- GET /intelligence/rules/:id/stats as non-admin → 403",
            "- POST /intelligence/cohorts/recalculate as non-admin → 403",
            "- POST /intelligence/somb-change-analysis as non-admin → 403",
            "",
            "**Physician transparency (non-admin sees limited rule data):**",
            "- GET /intelligence/rules as physician → returns name + category only, no conditions JSONB",
            "- GET /intelligence/rules as admin → returns full rule including conditions",
            "",
            "**Delegate permissions:**",
            "- Delegate with AI_COACH_VIEW → can view suggestions",
            "- Delegate without AI_COACH_MANAGE → cannot accept/dismiss suggestions"
          ]
        },
        {
          "id": "D07-042",
          "description": "Security: cross-physician tenant isolation for suggestions and learning state",
          "verify": "pnpm --filter api vitest run test/security/intelligence/intelligence.scoping.security.ts",
          "depends": ["D07-030", "D07-031"],
          "build": [
            "Create `apps/api/test/security/intelligence/intelligence.scoping.security.ts`.",
            "",
            "Create two physicians (physician1, physician2).",
            "",
            "**Suggestion isolation:**",
            "- Physician1 analyses claim → physician2 GET /intelligence/claims/:claim_id/suggestions → 404",
            "- Physician1's suggestions cannot be accepted/dismissed by physician2 → 404",
            "",
            "**Learning state isolation:**",
            "- Physician1 GET /intelligence/me/learning-state → only physician1's state",
            "- Physician2 cannot access physician1's learning state",
            "- Physician1 unsuppress rule → only affects physician1's suppression",
            "",
            "**Claim analysis isolation:**",
            "- Physician2 cannot trigger analysis on physician1's claim → 404",
            "",
            "**Delegate isolation:**",
            "- Delegate in physician1 context → sees physician1's suggestions only",
            "- Delegate switches to physician2 context → sees physician2's suggestions only",
            "",
            "**All cross-physician access returns 404, not 403.**"
          ]
        },
        {
          "id": "D07-043",
          "description": "Security: input validation and injection prevention",
          "verify": "pnpm --filter api vitest run test/security/intelligence/intelligence.input.security.ts",
          "depends": ["D07-030", "D07-031"],
          "build": [
            "Create `apps/api/test/security/intelligence/intelligence.input.security.ts`.",
            "",
            "**SQL injection payloads:**",
            "- dismissed_reason field: `' OR 1=1--`",
            "- rule name field: `'; DROP TABLE ai_rules;--`",
            "- conditions JSONB: attempt to embed SQL in condition values",
            "",
            "**XSS payloads:**",
            "- dismissed_reason: `<script>alert(1)</script>`",
            "- rule suggestion_template title: `<img onerror=alert(1) src=x>`",
            "- preferences JSON: XSS in category names",
            "",
            "**Type coercion:**",
            "- Send string where number expected for tier",
            "- Send array where string expected for dismissed_reason",
            "- Send null where required",
            "- Send negative value for priority_thresholds",
            "",
            "**UUID validation:**",
            "- Non-UUID in /intelligence/suggestions/not-a-uuid/accept → 400",
            "- Non-UUID in /intelligence/rules/not-a-uuid → 400",
            "- Non-UUID in /intelligence/claims/not-a-uuid/suggestions → 400",
            "",
            "**Condition tree injection prevention:**",
            "- Rule with condition containing SQL injection in value field → condition evaluator operates on pre-fetched context, not raw SQL. Verify no SQL executed.",
            "- Rule with cross_claim condition attempting to access other physician's data → scoped to current physician."
          ]
        },
        {
          "id": "D07-044",
          "description": "Security: PHI leakage prevention (especially LLM context isolation)",
          "verify": "pnpm --filter api vitest run test/security/intelligence/intelligence.leakage.security.ts",
          "depends": ["D07-030", "D07-031"],
          "build": [
            "Create `apps/api/test/security/intelligence/intelligence.leakage.security.ts`.",
            "",
            "**LLM PHI isolation (MOST CRITICAL):**",
            "- Verify stripPhi replaces patient PHN with 'XXXNNNNNN' in LLM prompt",
            "- Verify stripPhi removes patient name from LLM prompt",
            "- Verify LLM prompt contains billing codes but no patient identity",
            "- Verify LLM response processing does not re-inject PHI",
            "",
            "**Suggestion responses do not leak PHI:**",
            "- Suggestion description does not contain patient PHN",
            "- Suggestion description does not contain patient name",
            "- Suggestion JSONB on claim does not store raw LLM prompts",
            "",
            "**Error responses:**",
            "- 500 error from LLM does not expose patient data in error body",
            "- 400 validation error does not include claim PHI",
            "- 404 does not confirm claim existence",
            "",
            "**Headers:**",
            "- No X-Powered-By, no Server version, HSTS present, CSP present",
            "",
            "**Learning data does not contain PHI:**",
            "- ai_provider_learning contains no patient data (only rule IDs and counters)",
            "- ai_suggestion_events contains no PHI (only suggestion IDs, categories, revenue impacts)",
            "- ai_specialty_cohorts contains no PHI (only aggregate rates)",
            "- dismissed_reason field: verify no PHI stored even if physician types it (sanitise)",
            "",
            "**Rule conditions JSONB not exposed to non-admin:**",
            "- GET /intelligence/rules as physician → conditions field absent"
          ]
        },
        {
          "id": "D07-045",
          "description": "Security: audit trail completeness for Intelligence Engine operations",
          "verify": "pnpm --filter api vitest run test/security/intelligence/intelligence.audit.security.ts",
          "depends": ["D07-030", "D07-031"],
          "build": [
            "Create `apps/api/test/security/intelligence/intelligence.audit.security.ts`.",
            "",
            "**Suggestion lifecycle events (ai_suggestion_events, append-only):**",
            "- Claim analysed → GENERATED events for each suggestion",
            "- Suggestion accepted → ACCEPTED event with revenue_impact",
            "- Suggestion dismissed → DISMISSED event with dismissed_reason",
            "- Rule suppressed → SUPPRESSED event",
            "- Rule unsuppressed → UNSUPPRESSED event",
            "",
            "**Domain audit log (Domain 1 audit_log):**",
            "- Claim analysed → intelligence.claim_analysed with claim_id, suggestion_count",
            "- Suggestion accepted → intelligence.suggestion_accepted",
            "- Suggestion dismissed → intelligence.suggestion_dismissed",
            "- Rule created → intelligence.rule_created (admin)",
            "- Rule updated → intelligence.rule_updated (admin)",
            "- Rule activated/deactivated → intelligence.rule_toggled",
            "- SOMB change analysis → intelligence.somb_analysis_triggered",
            "- Cohort recalculation → intelligence.cohorts_recalculated",
            "",
            "**Audit log integrity:**",
            "- No UPDATE on ai_suggestion_events",
            "- No DELETE on ai_suggestion_events",
            "- Events contain correct provider_id (physician or delegate acting in context)"
          ]
        }
      ]
    },
    {
      "title": "Domain 7: Intelligence Engine — Final Validation",
      "tasks": [
        {
          "id": "D07-099",
          "description": "Full domain test suite: all unit + integration + security tests for Intelligence Engine",
          "verify": "pnpm --filter api vitest run src/domains/intelligence/ test/integration/intelligence/ test/security/intelligence/",
          "depends": ["D07-040", "D07-041", "D07-042", "D07-043", "D07-044", "D07-045"],
          "build": [
            "Run the complete test suite for Domain 7 Intelligence Engine. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/intelligence/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/intelligence/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/intelligence/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/intelligence/ test/integration/intelligence/ test/security/intelligence/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/intelligence/intelligence.authn.security.ts",
            "- test/security/intelligence/intelligence.authz.security.ts",
            "- test/security/intelligence/intelligence.scoping.security.ts",
            "- test/security/intelligence/intelligence.input.security.ts",
            "- test/security/intelligence/intelligence.leakage.security.ts",
            "- test/security/intelligence/intelligence.audit.security.ts",
            "",
            "Verify all 4 Intelligence Engine tables have CRUD coverage.",
            "Verify all 14 API endpoints have integration test coverage.",
            "Verify MVP rule seed runs successfully with ~105 rules.",
            "Verify LLM PHI isolation tests pass."
          ]
        }
      ]
    }
  ]
}
