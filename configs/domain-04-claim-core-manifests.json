{
  "domainNumber": "04",
  "domainName": "Claim Lifecycle Core",
  "manifestFile": "domain-04-claim-core.tasks",
  "promptPrefix": "d04",
  "modulePath": "apps/api/src/domains/claim",
  "sections": [
    {
      "title": "Domain 4.0: Claim Lifecycle Core — Shared Types & Constants",
      "tasks": [
        {
          "id": "D04-001",
          "description": "Claim state machine constants, import sources, auto-submission modes, validation check IDs, audit actions",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/claim.constants.ts` with all Claim Lifecycle constants:",
            "",
            "**ClaimState enum (11 states):**",
            "- DRAFT, VALIDATED, QUEUED, SUBMITTED, ASSESSED, PAID, REJECTED, ADJUSTED, WRITTEN_OFF, EXPIRED, DELETED",
            "",
            "**Terminal states set:** PAID, ADJUSTED, WRITTEN_OFF, EXPIRED, DELETED",
            "",
            "**State transitions map (From → allowed To[]):**",
            "- (new) → DRAFT",
            "- DRAFT → VALIDATED, DELETED",
            "- VALIDATED → DRAFT, QUEUED",
            "- QUEUED → VALIDATED, SUBMITTED",
            "- SUBMITTED → ASSESSED, REJECTED",
            "- ASSESSED → PAID, ADJUSTED",
            "- REJECTED → DRAFT, QUEUED, WRITTEN_OFF",
            "- any non-terminal → EXPIRED (system-initiated)",
            "",
            "**ClaimType enum:** AHCIP, WCB",
            "",
            "**ImportSource enum:** MANUAL, EMR_IMPORT, ED_SHIFT",
            "",
            "**AutoSubmissionMode enum:**",
            "- AUTO_CLEAN — clean claims auto-included, flagged claims require approval",
            "- AUTO_ALL — both clean and flagged auto-included",
            "- REQUIRE_APPROVAL — all claims require explicit approval",
            "",
            "**ImportBatchStatus enum:** PENDING, PROCESSING, COMPLETED, FAILED",
            "",
            "**ShiftStatus enum:** IN_PROGRESS, COMPLETED, SUBMITTED",
            "",
            "**ClaimAuditAction enum (15 actions):**",
            "- CREATED, EDITED, VALIDATED, QUEUED, UNQUEUED, SUBMITTED, ASSESSED, REJECTED, RESUBMITTED, WRITTEN_OFF, DELETED, EXPIRED, AI_SUGGESTION_ACCEPTED, AI_SUGGESTION_DISMISSED, DUPLICATE_ACKNOWLEDGED",
            "",
            "**ActorContext enum:** PHYSICIAN, DELEGATE, SYSTEM",
            "",
            "**Shared validation check IDs:**",
            "- S1_CLAIM_TYPE_VALID, S2_REQUIRED_BASE_FIELDS, S3_PATIENT_EXISTS, S4_PHYSICIAN_ACTIVE, S5_DOS_VALID, S6_SUBMISSION_WINDOW, S7_DUPLICATE_DETECTION",
            "",
            "**ValidationSeverity enum:** ERROR, WARNING, INFO",
            "",
            "**Notification events:**",
            "- CLAIM_VALIDATED, CLAIM_FLAGGED, DEADLINE_APPROACHING, DEADLINE_EXPIRED, BATCH_ASSEMBLED, BATCH_SUBMITTED, CLAIM_ASSESSED, CLAIM_REJECTED, CLAIM_PAID, DUPLICATE_DETECTED, AI_SUGGESTION_READY",
            "",
            "Export all as frozen objects / TypeScript enums. These are consumed by the API and frontend."
          ],
          "frd": [
            "Domain 4.0 Section 2.1: 11 claim states with 5 terminal states (paid, adjusted, written_off, expired, deleted).",
            "Domain 4.0 Section 2.2: State transition table defining all valid From → To pairs with triggers.",
            "Domain 4.0 Section 2.4: Three auto-submission modes — Auto Clean (default), Auto All, Require Approval.",
            "Domain 4.0 Section 4.3: Shared validation checks S1–S7 with severity levels.",
            "Domain 4.0 Section 7.5: 11 notification events emitted at key lifecycle moments."
          ]
        },
        {
          "id": "D04-002",
          "description": "Drizzle schema for claims table",
          "verify": "pnpm --filter shared build",
          "depends": ["D04-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/claim.schema.ts` starting with the claims table.",
            "",
            "**claims table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| claim_id | UUID | PK | Default: gen_random_uuid() |",
            "| physician_id | UUID FK | NOT NULL, FK → providers | HIA custodian |",
            "| patient_id | UUID FK | NOT NULL, FK → patients | |",
            "| claim_type | VARCHAR(10) | NOT NULL | AHCIP or WCB |",
            "| state | VARCHAR(20) | NOT NULL, DEFAULT 'draft' | Current state per state machine |",
            "| is_clean | BOOLEAN | NULLABLE | Null until queued. True = clean, False = flagged |",
            "| import_source | VARCHAR(20) | NOT NULL | MANUAL, EMR_IMPORT, ED_SHIFT |",
            "| import_batch_id | UUID FK | NULLABLE | FK → import_batches |",
            "| shift_id | UUID FK | NULLABLE | FK → shifts |",
            "| date_of_service | DATE | NOT NULL | Central to validation, fees, deadlines |",
            "| submission_deadline | DATE | NOT NULL | AHCIP: DOS + 90 days. WCB: form-specific |",
            "| submitted_batch_id | UUID FK | NULLABLE | FK to pathway-specific batch table |",
            "| validation_result | JSONB | NULLABLE | Structured validation result (errors, warnings, info, passed) |",
            "| validation_timestamp | TIMESTAMPTZ | NULLABLE | When validation was last run |",
            "| reference_data_version | VARCHAR(20) | NULLABLE | SOMB/WCB version used for validation |",
            "| ai_coach_suggestions | JSONB | NULLABLE | Array of suggestions with status |",
            "| duplicate_alert | JSONB | NULLABLE | Duplicate detection result |",
            "| flags | JSONB | NULLABLE | Array of active flags |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "| created_by | UUID FK | NOT NULL | Creator (physician or delegate) |",
            "| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "| updated_by | UUID FK | NOT NULL | Last updater |",
            "| deleted_at | TIMESTAMPTZ | NULLABLE | Soft-delete timestamp |",
            "",
            "**Indexes:**",
            "- (physician_id, state) for dashboard queries",
            "- (patient_id, date_of_service) for duplicate detection",
            "- (state, claim_type, is_clean) for batch assembly",
            "- (submission_deadline) for expiry monitoring",
            "",
            "Export the table and its inferred types (InsertClaim, SelectClaim) from the schema file."
          ],
          "frd": [
            "Domain 4.0 Section 3.1: Claims table — one row per claim regardless of pathway. claim_type determines extension tables. 22 columns with 4 indexes."
          ],
          "security": [
            "Claims contain PHI (patient PHN via patient_id, diagnoses via extension tables, services). All claim data encrypted at rest and in transit.",
            "physician_id establishes the HIA custodian. All access is scoped through this — tenant isolation is critical.",
            "Soft delete (deleted_at) retains data for audit. Only allowed from draft state."
          ]
        },
        {
          "id": "D04-003",
          "description": "Drizzle schema for import_batches and field_mapping_templates tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D04-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/claim.schema.ts`:",
            "",
            "**import_batches table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| import_batch_id | UUID | PK | |",
            "| physician_id | UUID FK | NOT NULL, FK → providers | |",
            "| file_name | VARCHAR(255) | NOT NULL | Original uploaded filename |",
            "| file_hash | VARCHAR(64) | NOT NULL | SHA-256 for deduplication |",
            "| field_mapping_template_id | UUID FK | NULLABLE | FK → field_mapping_templates |",
            "| total_rows | INTEGER | NOT NULL | Total rows in import file |",
            "| success_count | INTEGER | NOT NULL | Rows successfully imported |",
            "| error_count | INTEGER | NOT NULL | Rows that failed |",
            "| error_details | JSONB | NULLABLE | Per-row error details |",
            "| status | VARCHAR(20) | NOT NULL | PENDING, PROCESSING, COMPLETED, FAILED |",
            "| created_at | TIMESTAMPTZ | NOT NULL | Upload timestamp |",
            "| created_by | UUID FK | NOT NULL | Uploader |",
            "",
            "Index: (physician_id, created_at DESC), unique on (physician_id, file_hash) for dedup.",
            "",
            "**field_mapping_templates table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| template_id | UUID | PK | |",
            "| physician_id | UUID FK | NOT NULL, FK → providers | Templates are physician-scoped |",
            "| name | VARCHAR(100) | NOT NULL | E.g. 'Wolf EMR Export', 'Med Access Format' |",
            "| emr_type | VARCHAR(50) | NULLABLE | EMR system identifier |",
            "| mappings | JSONB | NOT NULL | Array of {source_column, target_field, transform?} |",
            "| delimiter | VARCHAR(5) | NULLABLE | CSV/TSV delimiter. Auto-detected if null. |",
            "| has_header_row | BOOLEAN | NOT NULL | Whether file has header row |",
            "| date_format | VARCHAR(20) | NULLABLE | Expected date format. Auto-detected if null. |",
            "| created_at | TIMESTAMPTZ | NOT NULL | |",
            "| updated_at | TIMESTAMPTZ | NOT NULL | |",
            "",
            "Index: (physician_id) for listing templates.",
            "",
            "Export tables and inferred types."
          ],
          "frd": [
            "Domain 4.0 Section 3.2: Import batches table for EMR import traceability with SHA-256 file deduplication.",
            "Domain 4.0 Section 3.3: Field mapping templates — per-physician column-to-field mappings reusable across imports."
          ]
        },
        {
          "id": "D04-004",
          "description": "Drizzle schema for shifts and claim_audit_history tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D04-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/claim.schema.ts`:",
            "",
            "**shifts table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| shift_id | UUID | PK | |",
            "| physician_id | UUID FK | NOT NULL, FK → providers | |",
            "| facility_id | UUID FK | NOT NULL | FK → provider's functional centre |",
            "| shift_date | DATE | NOT NULL | Date of ED shift |",
            "| start_time | TIME | NULLABLE | For after-hours premium calculation |",
            "| end_time | TIME | NULLABLE | |",
            "| status | VARCHAR(20) | NOT NULL | IN_PROGRESS, COMPLETED, SUBMITTED |",
            "| encounter_count | INTEGER | NOT NULL, DEFAULT 0 | Number of encounters |",
            "| created_at | TIMESTAMPTZ | NOT NULL | |",
            "| updated_at | TIMESTAMPTZ | NOT NULL | |",
            "",
            "Index: (physician_id, shift_date DESC).",
            "",
            "**claim_audit_history table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| audit_id | UUID | PK | |",
            "| claim_id | UUID FK | NOT NULL, FK → claims | |",
            "| action | VARCHAR(30) | NOT NULL | CREATED, EDITED, VALIDATED, etc. |",
            "| previous_state | VARCHAR(20) | NULLABLE | Null for CREATED |",
            "| new_state | VARCHAR(20) | NULLABLE | State after the action |",
            "| changes | JSONB | NULLABLE | For EDITED: field-level diff. For AI actions: suggestion details. |",
            "| actor_id | UUID FK | NOT NULL | Who performed the action |",
            "| actor_context | VARCHAR(20) | NOT NULL | PHYSICIAN, DELEGATE, SYSTEM |",
            "| reason | TEXT | NULLABLE | Write-off justification, dismissal reason |",
            "| created_at | TIMESTAMPTZ | NOT NULL | When the action occurred |",
            "",
            "Indexes: (claim_id, created_at DESC), (actor_id, created_at DESC).",
            "",
            "**CRITICAL:** Claim audit history is append-only. No UPDATE or DELETE operations. Retention: claim lifetime + 10 years (HIA custodian requirement).",
            "",
            "Export tables and inferred types."
          ],
          "frd": [
            "Domain 4.0 Section 3.4: Shifts table for ED workflow. Encounters are claims with import_source = ED_SHIFT and shift_id FK.",
            "Domain 4.0 Section 3.5: Claim audit history — every state change and significant edit recorded. Separate from system-wide audit log. Retention: claim lifetime + 10 years."
          ],
          "security": [
            "Claim audit history is append-only. Repository must NOT expose update or delete functions.",
            "actor_context distinguishes physician, delegate, and system actions for accountability.",
            "JSONB changes field must not contain PHI beyond what is necessary for the diff (e.g., old/new field values)."
          ]
        },
        {
          "id": "D04-005",
          "description": "Zod validation schemas for claim CRUD and state transition endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D04-001"],
          "build": [
            "Create `packages/shared/src/schemas/claim.schema.ts` with Zod schemas for request/response validation:",
            "",
            "**Claim creation:**",
            "- createClaimSchema: { claim_type: enum('AHCIP','WCB'), patient_id: uuid(), date_of_service: date string, import_source: enum('MANUAL','EMR_IMPORT','ED_SHIFT').default('MANUAL') }",
            "",
            "**Claim update:**",
            "- updateClaimSchema: partial object with allowed editable fields. claim_type is NOT editable after creation.",
            "",
            "**Claim query/list:**",
            "- listClaimsSchema: { state: enum(ClaimState).optional(), claim_type: enum('AHCIP','WCB').optional(), date_from: date.optional(), date_to: date.optional(), patient_id: uuid().optional(), is_clean: boolean().optional(), page: number().int().min(1).default(1), page_size: number().int().min(1).max(100).default(25) }",
            "",
            "**State transitions:**",
            "- queueClaimSchema: { } (no body, claim_id from path)",
            "- writeOffClaimSchema: { reason: string().min(1).max(500) }",
            "- resubmitClaimSchema: { } (no body, revalidates and requeues)",
            "",
            "**AI Coach:**",
            "- dismissSuggestionSchema: { reason: string().max(500).optional() }",
            "",
            "**Param schemas:**",
            "- claimIdParamSchema: { id: uuid() }",
            "- suggestionIdParamSchema: { sug_id: uuid() }",
            "",
            "Export all schemas AND their inferred TypeScript types (z.infer<typeof schema>)."
          ],
          "frd": [
            "Domain 4.0 Section 6.1: Claim CRUD API contracts — POST create, GET retrieve, PUT update, DELETE soft-delete, GET list with filtering.",
            "Domain 4.0 Section 6.5: Rejection management — resubmit endpoint.",
            "Domain 4.0 Section 6.6: AI Coach interactions — accept/dismiss suggestion."
          ]
        },
        {
          "id": "D04-006",
          "description": "Zod validation schemas for import, template, shift, export, and preferences endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D04-001", "D04-005"],
          "build": [
            "Add to `packages/shared/src/schemas/claim.schema.ts`:",
            "",
            "**EMR Import:**",
            "- createImportSchema: { field_mapping_template_id: uuid().optional() } (file uploaded separately via multipart)",
            "- commitImportSchema: { } (no body, import_batch_id from path)",
            "- importIdParamSchema: { id: uuid() }",
            "",
            "**Field mapping templates:**",
            "- createTemplateSchema: { name: string().min(1).max(100), emr_type: string().max(50).optional(), mappings: array of {source_column: string(), target_field: string(), transform: string().optional()}.min(1), delimiter: string().max(5).optional(), has_header_row: boolean(), date_format: string().max(20).optional() }",
            "- updateTemplateSchema: same as create but all fields optional",
            "- templateIdParamSchema: { id: uuid() }",
            "",
            "**ED Shift:**",
            "- createShiftSchema: { facility_id: uuid(), shift_date: date string, start_time: time string optional, end_time: time string optional }",
            "- addEncounterSchema: { patient_id: uuid(), date_of_service: date string, claim_type: enum('AHCIP','WCB') } (plus pathway-specific fields)",
            "- shiftIdParamSchema: { id: uuid() }",
            "",
            "**Data export:**",
            "- createExportSchema: { date_from: date string, date_to: date string, claim_type: enum('AHCIP','WCB').optional(), format: enum('CSV','JSON').default('CSV') }",
            "- exportIdParamSchema: { id: uuid() }",
            "",
            "**Submission preferences:**",
            "- updatePreferencesSchema: { mode: enum('AUTO_CLEAN','AUTO_ALL','REQUIRE_APPROVAL') }",
            "",
            "Export all schemas and inferred types."
          ],
          "frd": [
            "Domain 4.0 Section 6.2: EMR import endpoints — upload, preview, commit.",
            "Domain 4.0 Section 6.3: Field mapping template CRUD.",
            "Domain 4.0 Section 6.4: ED shift workflow — create shift, add encounter, complete, get details.",
            "Domain 4.0 Section 6.7: Data export — request export, check status/download.",
            "Domain 4.0 Section 6.8: Submission preferences — get/update auto-submission mode."
          ]
        },
        {
          "id": "D04-007",
          "description": "Generate and apply database migration for all claim tables",
          "verify": "cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1",
          "depends": ["D04-002", "D04-003", "D04-004"],
          "build": [
            "Run the Drizzle migration generator to create the migration for all Claim Lifecycle tables:",
            "",
            "```bash",
            "cd apps/api",
            "pnpm drizzle-kit generate",
            "pnpm drizzle-kit migrate",
            "```",
            "",
            "Verify that the migration file was created in `apps/api/drizzle/migrations/`.",
            "Verify that all 5 tables exist in the test database: claims, import_batches, field_mapping_templates, shifts, claim_audit_history.",
            "Verify all indexes and constraints are applied.",
            "Verify FKs to providers (Domain 5) and patients (Domain 6) resolve correctly."
          ]
        }
      ]
    },
    {
      "title": "Domain 4.0: Claim Lifecycle Core — Repository Layer",
      "tasks": [
        {
          "id": "D04-010",
          "description": "Repository: claims CRUD (create, read, update, soft-delete, list with filters)",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-007"],
          "build": [
            "Create `apps/api/src/domains/claim/claim.repository.ts`:",
            "",
            "- `createClaim(data: InsertClaim)` — insert claim with state = DRAFT, import_source from input. Return claim_id.",
            "- `findClaimById(claimId: string, physicianId: string)` — find claim scoped to physician. Return null if not found or different physician.",
            "- `updateClaim(claimId: string, physicianId: string, data: Partial<InsertClaim>)` — update claim fields. Verify physician ownership. Return updated claim.",
            "- `softDeleteClaim(claimId: string, physicianId: string)` — set deleted_at. Only allowed when state = DRAFT. Return boolean.",
            "- `listClaims(physicianId: string, filters: ListClaimsFilters)` — paginated list with filters: state, claim_type, date range, patient_id, is_clean. Reverse chronological.",
            "- `countClaimsByState(physicianId: string)` — count claims grouped by state for dashboard.",
            "- `findClaimsApproachingDeadline(physicianId: string, daysThreshold: number)` — claims within N days of submission_deadline."
          ],
          "security": [
            "Every query function takes physicianId and scopes results — this is the primary tenant isolation mechanism.",
            "softDeleteClaim must verify state === DRAFT before allowing delete.",
            "findClaimById returns null (not 403) for wrong physician — do not confirm resource existence."
          ],
          "tests": [
            "createClaim inserts with draft state and correct import_source",
            "findClaimById returns claim for owning physician",
            "findClaimById returns null for different physician",
            "updateClaim updates allowed fields",
            "updateClaim rejects update for wrong physician",
            "softDeleteClaim sets deleted_at when state is draft",
            "softDeleteClaim rejects delete when state is not draft",
            "listClaims filters by state correctly",
            "listClaims filters by claim_type correctly",
            "listClaims paginates correctly",
            "countClaimsByState returns grouped counts",
            "findClaimsApproachingDeadline returns claims within threshold"
          ]
        },
        {
          "id": "D04-011",
          "description": "Repository: claim state transitions and clean/flagged classification",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-007", "D04-010"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.repository.ts`:",
            "",
            "- `transitionState(claimId: string, physicianId: string, fromState: string, toState: string)` — atomic state transition. Verify current state matches fromState (optimistic concurrency). Return updated claim or throw on state mismatch.",
            "- `classifyClaim(claimId: string, isClean: boolean)` — set is_clean flag. Called when claim enters queued state.",
            "- `updateValidationResult(claimId: string, result: ValidationResult, version: string)` — set validation_result, validation_timestamp, reference_data_version.",
            "- `updateAiSuggestions(claimId: string, suggestions: any)` — set ai_coach_suggestions JSONB.",
            "- `updateDuplicateAlert(claimId: string, alert: any)` — set duplicate_alert JSONB.",
            "- `updateFlags(claimId: string, flags: any)` — set flags JSONB.",
            "- `findClaimsForBatchAssembly(physicianId: string, claimType: string, includeClean: boolean, includeFlagged: boolean)` — query claims in QUEUED state matching criteria for batch assembly.",
            "- `bulkTransitionState(claimIds: string[], fromState: string, toState: string, batchId: string)` — batch state transition for submission. Sets submitted_batch_id."
          ],
          "security": [
            "transitionState uses optimistic concurrency — verifying fromState prevents race conditions.",
            "bulkTransitionState must be atomic (single transaction) to prevent partial batch assembly.",
            "All state transitions are physician-scoped through the calling service layer."
          ],
          "tests": [
            "transitionState succeeds with correct fromState",
            "transitionState rejects incorrect fromState (optimistic lock)",
            "transitionState rejects invalid transition per state machine",
            "classifyClaim sets is_clean flag",
            "updateValidationResult stores structured result with timestamp and version",
            "findClaimsForBatchAssembly returns only queued claims matching criteria",
            "findClaimsForBatchAssembly respects clean/flagged filter",
            "bulkTransitionState transitions all claims atomically",
            "bulkTransitionState sets submitted_batch_id on all claims"
          ]
        },
        {
          "id": "D04-012",
          "description": "Repository: import batches and duplicate file detection",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-007"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.repository.ts`:",
            "",
            "- `createImportBatch(data: InsertImportBatch)` — insert import batch record. Return import_batch_id.",
            "- `findImportBatchById(batchId: string, physicianId: string)` — physician-scoped lookup.",
            "- `updateImportBatchStatus(batchId: string, status: string, counts?: { successCount, errorCount, errorDetails })` — update status and counts after processing.",
            "- `findDuplicateImportByHash(physicianId: string, fileHash: string)` — check if this file was already imported (SHA-256 hash match).",
            "- `listImportBatches(physicianId: string, page: number, pageSize: number)` — paginated list, reverse chronological."
          ],
          "security": [
            "Import batches are physician-scoped. No cross-physician access.",
            "File hash deduplication prevents re-importing the same file (SHA-256).",
            "error_details JSONB must not contain PHI beyond row-level error descriptions."
          ],
          "tests": [
            "createImportBatch creates record with PENDING status",
            "findImportBatchById returns batch for owning physician",
            "findImportBatchById returns null for different physician",
            "updateImportBatchStatus updates status and counts",
            "findDuplicateImportByHash detects duplicate file",
            "findDuplicateImportByHash returns null for new file",
            "listImportBatches paginates correctly"
          ]
        },
        {
          "id": "D04-013",
          "description": "Repository: field mapping templates CRUD",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-007"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.repository.ts`:",
            "",
            "- `createTemplate(data: InsertFieldMappingTemplate)` — insert template. Return template_id.",
            "- `findTemplateById(templateId: string, physicianId: string)` — physician-scoped lookup.",
            "- `updateTemplate(templateId: string, physicianId: string, data: Partial<InsertFieldMappingTemplate>)` — update template fields.",
            "- `deleteTemplate(templateId: string, physicianId: string)` — hard delete (templates are not PHI). Verify physician ownership.",
            "- `listTemplates(physicianId: string)` — list all templates for physician."
          ],
          "security": [
            "Templates are physician-scoped. A physician can only see and manage their own templates.",
            "deleteTemplate verifies physician ownership before deletion."
          ],
          "tests": [
            "createTemplate creates template for physician",
            "findTemplateById returns template for owning physician",
            "findTemplateById returns null for different physician",
            "updateTemplate updates mapping fields",
            "updateTemplate rejects update for wrong physician",
            "deleteTemplate removes template for owning physician",
            "deleteTemplate rejects delete for wrong physician",
            "listTemplates returns only physician's templates"
          ]
        },
        {
          "id": "D04-014",
          "description": "Repository: shifts (ED workflow)",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-007"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.repository.ts`:",
            "",
            "- `createShift(data: InsertShift)` — insert shift with status = IN_PROGRESS. Return shift_id.",
            "- `findShiftById(shiftId: string, physicianId: string)` — physician-scoped lookup with encounter count.",
            "- `updateShiftStatus(shiftId: string, physicianId: string, status: string)` — update shift status (IN_PROGRESS → COMPLETED → SUBMITTED).",
            "- `updateShiftTimes(shiftId: string, physicianId: string, startTime: string, endTime: string)` — update shift start/end times.",
            "- `incrementEncounterCount(shiftId: string)` — increment encounter_count.",
            "- `listShifts(physicianId: string, page: number, pageSize: number)` — paginated list, reverse chronological.",
            "- `findClaimsByShift(shiftId: string, physicianId: string)` — list all claims linked to this shift."
          ],
          "security": [
            "Shifts are physician-scoped. No cross-physician access.",
            "Shift times are used for after-hours premium calculation — must be validated as valid time values."
          ],
          "tests": [
            "createShift creates shift with IN_PROGRESS status",
            "findShiftById returns shift for owning physician",
            "findShiftById returns null for different physician",
            "updateShiftStatus transitions status correctly",
            "incrementEncounterCount increments counter",
            "listShifts paginates correctly",
            "findClaimsByShift returns only claims linked to shift"
          ]
        },
        {
          "id": "D04-015",
          "description": "Repository: claim audit history (append-only)",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-007"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.repository.ts`:",
            "",
            "- `appendClaimAudit(entry: InsertClaimAuditHistory)` — insert audit entry. This is the ONLY write operation on claim_audit_history.",
            "- `getClaimAuditHistory(claimId: string, physicianId: string)` — return all audit entries for a claim, reverse chronological. Verify claim belongs to physician before returning.",
            "- `getClaimAuditHistoryPaginated(claimId: string, physicianId: string, page: number, pageSize: number)` — paginated version.",
            "",
            "**CRITICAL: Do NOT create update or delete functions for claim_audit_history. The table is append-only.**"
          ],
          "security": [
            "Claim audit history is append-only. No update, no delete. Hard requirement.",
            "getClaimAuditHistory must verify claim ownership (physician_id) before returning entries.",
            "Retention: claim lifetime + 10 years (HIA custodian requirement)."
          ],
          "tests": [
            "appendClaimAudit inserts entry with correct fields",
            "getClaimAuditHistory returns entries for owned claim",
            "getClaimAuditHistory returns empty for different physician's claim",
            "getClaimAuditHistory returns reverse chronological order",
            "getClaimAuditHistoryPaginated paginates correctly",
            "claim_audit_history has no update function",
            "claim_audit_history has no delete function"
          ]
        },
        {
          "id": "D04-016",
          "description": "Repository: submission preferences and data export records",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-007"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.repository.ts`:",
            "",
            "Note: Submission preferences are stored on the provider profile (Domain 5). This repository provides claim-scoped export record tracking.",
            "",
            "**Data exports:**",
            "- `createExportRecord(data: { physicianId, dateFrom, dateTo, claimType?, format, status })` — insert export record. Return export_id.",
            "- `findExportById(exportId: string, physicianId: string)` — physician-scoped lookup.",
            "- `updateExportStatus(exportId: string, status: string, filePath?: string)` — update status to PROCESSING, COMPLETED (with file path), or FAILED.",
            "",
            "Note: The actual submission preferences are managed via the Provider Management domain (Domain 5). The claim domain reads them via the provider service interface."
          ],
          "tests": [
            "createExportRecord creates record with pending status",
            "findExportById returns record for owning physician",
            "findExportById returns null for different physician",
            "updateExportStatus updates status and file path"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.0: Claim Lifecycle Core — Service Layer",
      "tasks": [
        {
          "id": "D04-020",
          "description": "Service: claim creation (manual entry, from EMR import, from ED shift)",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-010", "D04-015"],
          "build": [
            "Create `apps/api/src/domains/claim/claim.service.ts` with claim creation functions:",
            "",
            "- `createClaim(physicianId: string, actorId: string, actorContext: string, data: CreateClaimInput)` — create claim with state DRAFT. Calculate submission_deadline based on claim_type (AHCIP: DOS + 90 days, WCB: form-specific from Domain 4.2). Append CREATED audit entry. Return claim_id.",
            "- `createClaimFromImport(physicianId: string, actorId: string, importBatchId: string, rowData: MappedRow)` — create claim with import_source = EMR_IMPORT and import_batch_id set. Same validation as manual creation.",
            "- `createClaimFromShift(physicianId: string, actorId: string, shiftId: string, encounterData: EncounterInput)` — create claim with import_source = ED_SHIFT and shift_id set. Increment shift encounter count.",
            "",
            "**Interface contracts (consumed):**",
            "- Call Provider Management (D05) to verify physician is active with valid BA",
            "- Call Patient Registry (D06) to verify patient exists",
            "- Submission deadline calculation: AHCIP = DOS + 90 calendar days. WCB = delegated to Domain 4.2 for form-specific deadlines.",
            "",
            "**Audit:** Every creation appends a claim_audit_history entry with action = CREATED, actor_id, actor_context."
          ],
          "security": [
            "Claim creation verifies the physician is active and has a valid billing arrangement via Provider Management.",
            "Patient existence check via Patient Registry prevents orphaned claims.",
            "actor_context (PHYSICIAN, DELEGATE, SYSTEM) recorded on every creation for accountability.",
            "Delegates create claims in physician context — the physician_id (HIA custodian) is always the physician's, not the delegate's."
          ],
          "tests": [
            "createClaim creates draft claim with correct deadline",
            "createClaim appends CREATED audit entry",
            "createClaim calculates AHCIP deadline as DOS + 90 days",
            "createClaimFromImport sets import_source and batch_id",
            "createClaimFromShift sets import_source and shift_id",
            "createClaimFromShift increments shift encounter count",
            "createClaim records actor_context correctly for delegate"
          ]
        },
        {
          "id": "D04-021",
          "description": "Service: validation engine (pipeline structure, shared checks S1–S7, result format)",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-010", "D04-011"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.service.ts`:",
            "",
            "- `validateClaim(claimId: string, physicianId: string)` — run full validation pipeline. Store result on claim. Return structured ValidationResult.",
            "",
            "**Pipeline structure (ordered):**",
            "1. S1: Claim type valid — claim_type is AHCIP or WCB. If fails, short-circuit all subsequent checks.",
            "2. S2: Required base fields — physician_id, patient_id, date_of_service present.",
            "3. S3: Patient exists — patient_id resolves to a valid patient record (call Patient Registry).",
            "4. S4: Physician active — physician_id resolves to active provider with valid BA (call Provider Management).",
            "5. S5: DOS valid — date_of_service is valid date, not future, not before physician registration date.",
            "6. S6: Submission window — check deadline. Error if expired. Warning if within 7 days.",
            "7. S7: Duplicate detection — same patient + same DOS + same primary service code in existing non-deleted claims. Warning, not error.",
            "",
            "**After shared checks:** delegate to AHCIP module (Domain 4.1) or WCB module (Domain 4.2) based on claim_type. For now, create the delegation hook as an interface — pathway modules will implement it.",
            "",
            "**After validation:** send claim context to Intelligence Engine (Domain 7) for AI Coach analysis (non-blocking). Store suggestions on claim.",
            "",
            "**ValidationResult format:**",
            "- errors: Array<{ check, rule_reference, message, help_text, field_affected }>",
            "- warnings: Array<same structure>",
            "- info: Array<{ check, rule_reference, message, help_text }>",
            "- passed: boolean (true if zero errors)",
            "- validation_timestamp: ISO timestamp",
            "- reference_data_version: string",
            "",
            "**State effect:** If zero errors and current state is DRAFT → transition to VALIDATED."
          ],
          "frd": [
            "Domain 4.0 Section 4.1: Validation pipeline — ordered checks with short-circuit. Shared checks then pathway delegation.",
            "Domain 4.0 Section 4.2: Validation result structure — errors, warnings, info, passed, timestamp, reference_data_version.",
            "Domain 4.0 Section 4.3: Seven shared checks (S1–S7) with severity assignments.",
            "Domain 4.0 Section 4.4: Validation runs on save, on queue, and pre-batch. Always uses current reference data version."
          ],
          "security": [
            "reference_data_version is recorded for audit traceability — if rules change, the audit shows which version was in effect.",
            "Duplicate detection is a warning, not an error — intentional duplicates are valid in some scenarios (e.g., radiology).",
            "Validation always uses current reference data version. No caching stale rules."
          ],
          "tests": [
            "validateClaim runs all 7 shared checks in order",
            "S1 failure short-circuits all subsequent checks",
            "S2 returns error for missing required fields",
            "S3 returns error for non-existent patient",
            "S4 returns error for inactive physician",
            "S5 returns error for future date_of_service",
            "S6 returns error for expired submission window",
            "S6 returns warning for claim within 7 days of deadline",
            "S7 returns warning for duplicate match",
            "validateClaim stores result with reference_data_version",
            "validateClaim transitions DRAFT → VALIDATED on pass",
            "validateClaim does not transition on errors"
          ]
        },
        {
          "id": "D04-022",
          "description": "Service: state machine enforcement, clean/flagged classification, auto-submission logic",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-010", "D04-011", "D04-015"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.service.ts`:",
            "",
            "- `queueClaim(claimId: string, physicianId: string, actorId: string, actorContext: string)` — verify claim is in VALIDATED state. Re-validate (full pipeline). Classify as clean or flagged. Transition to QUEUED. Emit CLAIM_FLAGGED notification if flagged. Append audit entry.",
            "- `unqueueClaim(claimId: string, physicianId: string, actorId: string)` — verify QUEUED state. Transition to VALIDATED. Append audit entry.",
            "- `approveFlaggedClaim(claimId: string, physicianId: string, actorId: string, actorContext: string)` — for delegates with CLAIM_APPROVE permission. Mark flagged claim as approved for batch inclusion. Append audit entry.",
            "- `writeOffClaim(claimId: string, physicianId: string, actorId: string, reason: string)` — verify REJECTED state. Transition to WRITTEN_OFF. Record reason in audit. Terminal.",
            "- `expireClaim(claimId: string)` — system-initiated. Transition any non-terminal claim past deadline to EXPIRED. Emit DEADLINE_EXPIRED notification.",
            "",
            "**Clean/flagged classification (applied at queue time):**",
            "Clean when ALL true: zero validation warnings, zero pending AI suggestions, zero unresolved flags, zero duplicate alerts.",
            "Flagged otherwise. Re-evaluated when claim is updated while in QUEUED state.",
            "",
            "**Auto-submission logic (called by batch assembly):**",
            "Read physician's submission preference (from Provider Management):",
            "- AUTO_CLEAN: include clean claims, exclude flagged",
            "- AUTO_ALL: include both clean and flagged",
            "- REQUIRE_APPROVAL: include none without explicit approval"
          ],
          "frd": [
            "Domain 4.0 Section 2.2: State transition table with triggers and conditions.",
            "Domain 4.0 Section 2.3: Clean vs flagged classification — clean when zero warnings, zero pending AI suggestions, zero flags, zero duplicate alerts.",
            "Domain 4.0 Section 2.4: Tiered auto-submission model — three modes (Auto Clean default, Auto All, Require Approval)."
          ],
          "security": [
            "State transitions validated against the allowed transitions map — invalid transitions rejected with 409 Conflict.",
            "Delegate approval of flagged claims requires CLAIM_APPROVE permission (checked at service level).",
            "expireClaim is system-initiated only — no user-facing endpoint for this action.",
            "Every state change appends to claim_audit_history with actor_id and actor_context."
          ],
          "tests": [
            "queueClaim re-validates before queuing",
            "queueClaim classifies clean claim correctly",
            "queueClaim classifies flagged claim correctly (pending AI suggestions)",
            "queueClaim classifies flagged claim correctly (validation warnings)",
            "queueClaim emits CLAIM_FLAGGED notification for flagged claims",
            "unqueueClaim transitions QUEUED → VALIDATED",
            "approveFlaggedClaim requires CLAIM_APPROVE permission",
            "writeOffClaim only from REJECTED state",
            "writeOffClaim records reason in audit",
            "expireClaim transitions non-terminal claims past deadline",
            "auto-submission respects AUTO_CLEAN mode",
            "auto-submission respects AUTO_ALL mode",
            "auto-submission respects REQUIRE_APPROVAL mode",
            "clean/flagged re-evaluation on queued claim update"
          ]
        },
        {
          "id": "D04-023",
          "description": "Service: EMR import flow (upload, preview, commit, field mapping)",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-010", "D04-012", "D04-013"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.service.ts`:",
            "",
            "- `uploadImport(physicianId: string, actorId: string, file: UploadedFile, templateId?: string)` — compute SHA-256 hash. Check for duplicate file. Parse file (CSV/TSV with auto-detected or template-specified delimiter). Create import_batch record with PENDING status. Return import_batch_id.",
            "- `previewImport(importBatchId: string, physicianId: string)` — apply field mapping template (or manual mapping). Return preview: mapped rows, unmapped columns, validation warnings per row. Do NOT create claims yet.",
            "- `commitImport(importBatchId: string, physicianId: string, actorId: string)` — create claims from successfully mapped rows. Skip failed rows. Update import batch with counts and error details. Set status to COMPLETED. Return { success_count, error_count, error_details }.",
            "",
            "**File parsing:**",
            "- Detect delimiter (comma, tab, pipe) if not specified in template",
            "- Handle header row vs no header row per template config",
            "- Parse multiple date formats (YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY) per template config or auto-detection",
            "",
            "**Field mapping:**",
            "- Apply field_mapping_templates.mappings array: {source_column → target_field, optional transform}",
            "- Validate each mapped row against claim creation requirements",
            "- Report per-row errors with row number and field details"
          ],
          "frd": [
            "Domain 4.0 Section 6.2: EMR import endpoints — upload, preview, commit. Preview before commit.",
            "Domain 4.0 Section 3.2: Import batches track file hash for dedup, per-row error details.",
            "Domain 4.0 Section 3.3: Field mapping templates with source_column → target_field + optional transform.",
            "Domain 4.0 Section 9.4: EMR import tests — various delimiters, header handling, date formats, partial failures, template reuse, duplicate file detection."
          ],
          "security": [
            "EMR import files are processed in memory where possible. Uploaded files stored temporarily (encrypted), processed, deleted after import confirmation.",
            "File hash deduplication prevents duplicate imports (SHA-256).",
            "Import error details must not leak PHI beyond row-level error descriptions."
          ],
          "tests": [
            "uploadImport computes SHA-256 hash",
            "uploadImport detects duplicate file by hash",
            "uploadImport parses CSV with comma delimiter",
            "uploadImport parses TSV with tab delimiter",
            "previewImport applies field mapping template",
            "previewImport reports unmapped columns",
            "previewImport validates each row",
            "commitImport creates claims for valid rows",
            "commitImport skips failed rows with error details",
            "commitImport updates batch counts",
            "commitImport handles partial failures correctly"
          ]
        },
        {
          "id": "D04-024",
          "description": "Service: ED shift workflow (create shift, add encounters, complete, after-hours calculation)",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-010", "D04-014", "D04-015"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.service.ts`:",
            "",
            "- `createShift(physicianId: string, data: CreateShiftInput)` — create shift with IN_PROGRESS status. Verify facility_id belongs to physician (via Provider Management). Return shift_id.",
            "- `addEncounter(physicianId: string, actorId: string, shiftId: string, data: EncounterInput)` — verify shift is IN_PROGRESS. Create claim with import_source = ED_SHIFT, shift_id set. Increment encounter count. Return claim_id.",
            "- `completeShift(physicianId: string, shiftId: string)` — verify shift is IN_PROGRESS. Set status to COMPLETED. Calculate after-hours premiums for all encounters based on shift start_time/end_time. Return shift with all encounters.",
            "- `getShiftDetails(physicianId: string, shiftId: string)` — return shift with all linked claims.",
            "",
            "**After-hours calculation:** Uses shift start_time and end_time to determine which encounters qualify for after-hours premiums. Delegates the actual premium calculation to the pathway-specific module (AHCIP or WCB).",
            "",
            "**Shift lifecycle:** IN_PROGRESS → COMPLETED (physician finishes shift) → SUBMITTED (all encounters queued/submitted)."
          ],
          "frd": [
            "Domain 4.0 Section 3.4: Shifts table for ED workflow. Individual encounters are claims with import_source = ED_SHIFT.",
            "Domain 4.0 Section 6.4: ED shift API — create shift, add encounter, complete shift, get details.",
            "Domain 4.0 CLM-003: ED physician bills entire shift as batch. After-hours premiums auto-calculated."
          ],
          "tests": [
            "createShift creates shift with IN_PROGRESS status",
            "createShift verifies facility belongs to physician",
            "addEncounter creates claim linked to shift",
            "addEncounter increments encounter count",
            "addEncounter rejects if shift is not IN_PROGRESS",
            "completeShift sets status to COMPLETED",
            "completeShift triggers after-hours calculation",
            "getShiftDetails returns shift with all encounters"
          ]
        },
        {
          "id": "D04-025",
          "description": "Service: rejection management, resubmission, and write-off",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-010", "D04-011", "D04-015"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.service.ts`:",
            "",
            "- `listRejectedClaims(physicianId: string, page: number, pageSize: number)` — list claims in REJECTED state with explanatory codes and corrective guidance.",
            "- `getRejectionDetails(claimId: string, physicianId: string)` — return rejection codes, human-readable descriptions, system-generated corrective guidance, resubmission eligibility.",
            "- `resubmitClaim(claimId: string, physicianId: string, actorId: string)` — verify REJECTED state. Re-validate claim. If valid: transition to QUEUED (one-click resubmit). Append RESUBMITTED audit entry. Emit notification.",
            "",
            "**Corrective guidance:** Generated from explanatory code lookup (Reference Data, Domain 2). Maps rejection codes to human-readable descriptions and suggested corrections.",
            "",
            "**Resubmission flow:** REJECTED → edit → DRAFT → validate → VALIDATED → queue, OR REJECTED → one-click resubmit → QUEUED (if claim still validates after correction)."
          ],
          "frd": [
            "Domain 4.0 Section 6.5: Rejection management API — list rejected, get rejection details, one-click resubmit.",
            "Domain 4.0 CLM-011: Rejected claims show explanatory codes, descriptions, corrective guidance, one-click resubmit.",
            "Domain 4.0 CLM-012: Write-off action on rejected claims with reason. Terminal state."
          ],
          "tests": [
            "listRejectedClaims returns only REJECTED state claims",
            "getRejectionDetails returns codes and corrective guidance",
            "getRejectionDetails returns null for different physician's claim",
            "resubmitClaim re-validates before requeuing",
            "resubmitClaim transitions REJECTED → QUEUED on valid",
            "resubmitClaim appends RESUBMITTED audit entry",
            "resubmitClaim rejects if validation fails after correction"
          ]
        },
        {
          "id": "D04-026",
          "description": "Service: AI Coach interactions, duplicate handling, submission preferences, data export",
          "verify": "pnpm --filter api vitest run src/domains/claim/claim.test.ts",
          "depends": ["D04-010", "D04-011", "D04-015", "D04-016"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.service.ts`:",
            "",
            "**AI Coach interactions:**",
            "- `getClaimSuggestions(claimId: string, physicianId: string)` — return AI Coach suggestions for this claim from ai_coach_suggestions JSONB.",
            "- `acceptSuggestion(claimId: string, suggestionId: string, physicianId: string, actorId: string)` — mark suggestion as accepted. Apply suggested change to claim. Re-validate. Append AI_SUGGESTION_ACCEPTED audit entry. Re-evaluate clean/flagged if queued.",
            "- `dismissSuggestion(claimId: string, suggestionId: string, physicianId: string, actorId: string, reason?: string)` — mark suggestion as dismissed. Append AI_SUGGESTION_DISMISSED audit entry with reason. Re-evaluate clean/flagged if queued.",
            "",
            "**Duplicate handling:**",
            "- `acknowledgeDuplicate(claimId: string, physicianId: string, actorId: string)` — clear duplicate_alert. Append DUPLICATE_ACKNOWLEDGED audit. Re-evaluate clean/flagged.",
            "",
            "**Submission preferences (reads from Provider Management):**",
            "- `getSubmissionPreferences(physicianId: string)` — read from Provider Management (Domain 5).",
            "- `updateSubmissionPreferences(physicianId: string, mode: string)` — update via Provider Management. Audit log the change.",
            "",
            "**Data export:**",
            "- `requestExport(physicianId: string, params: ExportParams)` — create export record. Queue background job to generate file. Return export_id.",
            "- `getExportStatus(exportId: string, physicianId: string)` — return status and download URL if complete.",
            "- `generateExportFile(exportId: string)` — background job: query claims, generate CSV/JSON, store to DigitalOcean Spaces, update record with file path."
          ],
          "frd": [
            "Domain 4.0 Section 6.6: AI Coach interaction API — get suggestions, accept, dismiss.",
            "Domain 4.0 Section 6.7: Data export API — request, check status, download.",
            "Domain 4.0 Section 6.8: Submission preferences API — get/update mode.",
            "Domain 4.0 CLM-007: AI Coach suggestions as actionable cards with revenue impact and confidence.",
            "Domain 4.0 CLM-015: Duplicate detection with acknowledge or merge."
          ],
          "security": [
            "AI Coach suggestions are advisory — never block submission.",
            "acceptSuggestion applies changes to the claim and re-validates — the suggestion is not blindly applied.",
            "Data export files are generated on Meritum infrastructure (DigitalOcean Toronto) and delivered via authenticated download. Not emailed.",
            "Export requests require date range — no unbounded exports."
          ],
          "tests": [
            "getClaimSuggestions returns suggestions for owned claim",
            "acceptSuggestion marks suggestion accepted and applies change",
            "acceptSuggestion re-validates claim after applying",
            "acceptSuggestion re-evaluates clean/flagged if queued",
            "dismissSuggestion marks dismissed with optional reason",
            "dismissSuggestion re-evaluates clean/flagged if queued",
            "acknowledgeDuplicate clears duplicate alert",
            "getSubmissionPreferences reads from provider management",
            "updateSubmissionPreferences updates mode and audits",
            "requestExport creates export record",
            "getExportStatus returns status for owned export",
            "getExportStatus returns null for different physician"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.0: Claim Lifecycle Core — Middleware & Routes",
      "tasks": [
        {
          "id": "D04-030",
          "description": "Routes: claim CRUD, state transitions, validation, AI Coach, rejection management",
          "verify": "pnpm --filter api vitest run test/integration/claim/",
          "depends": ["D04-020", "D04-021", "D04-022", "D04-025", "D04-026"],
          "build": [
            "Create `apps/api/src/domains/claim/claim.routes.ts` and `apps/api/src/domains/claim/claim.handlers.ts`.",
            "",
            "**Claim CRUD (auth required, physician-scoped):**",
            "- POST /api/v1/claims → createClaimHandler (body: createClaimSchema)",
            "- GET /api/v1/claims → listClaimsHandler (query: listClaimsSchema)",
            "- GET /api/v1/claims/:id → getClaimHandler (params: claimIdParamSchema)",
            "- PUT /api/v1/claims/:id → updateClaimHandler (body: updateClaimSchema)",
            "- DELETE /api/v1/claims/:id → deleteClaimHandler (soft delete, draft only)",
            "",
            "**State transitions:**",
            "- POST /api/v1/claims/:id/validate → validateClaimHandler",
            "- POST /api/v1/claims/:id/queue → queueClaimHandler",
            "- POST /api/v1/claims/:id/unqueue → unqueueClaimHandler",
            "- POST /api/v1/claims/:id/write-off → writeOffHandler (body: writeOffClaimSchema)",
            "- POST /api/v1/claims/:id/resubmit → resubmitHandler",
            "",
            "**AI Coach:**",
            "- GET /api/v1/claims/:id/suggestions → getSuggestionsHandler",
            "- POST /api/v1/claims/:id/suggestions/:sug_id/accept → acceptSuggestionHandler",
            "- POST /api/v1/claims/:id/suggestions/:sug_id/dismiss → dismissSuggestionHandler (body: dismissSuggestionSchema)",
            "",
            "**Rejection management:**",
            "- GET /api/v1/claims/rejected → listRejectedHandler",
            "- GET /api/v1/claims/:id/rejection-details → rejectionDetailsHandler",
            "",
            "**Claim audit:**",
            "- GET /api/v1/claims/:id/audit → claimAuditHandler",
            "",
            "**Handlers are thin:** validate input via Zod schema on route, call service function, format response.",
            "",
            "Also create `apps/api/test/integration/claim/claims.integration.ts` with request/response integration tests."
          ],
          "security": [
            "All endpoints require authentication (authenticate middleware from Domain 1).",
            "All endpoints are physician-scoped via request.authContext.physicianId (or delegate's physician context).",
            "CLAIM_CREATE, CLAIM_VIEW, CLAIM_EDIT, CLAIM_DELETE, CLAIM_SUBMIT permissions checked per route.",
            "Delegates require explicit CLAIM_APPROVE permission to approve flagged claims."
          ],
          "tests": [
            "POST /claims creates draft claim and returns 201",
            "GET /claims lists physician's claims with filtering",
            "GET /claims/:id returns claim for owning physician",
            "GET /claims/:id returns 404 for different physician",
            "PUT /claims/:id updates claim fields",
            "DELETE /claims/:id soft-deletes draft claim",
            "DELETE /claims/:id returns 409 for non-draft claim",
            "POST /claims/:id/validate returns validation result",
            "POST /claims/:id/queue queues validated claim",
            "POST /claims/:id/unqueue returns claim to validated",
            "POST /claims/:id/write-off transitions rejected to written_off",
            "POST /claims/:id/resubmit revalidates and requeues",
            "GET /claims/:id/suggestions returns AI suggestions",
            "POST /claims/:id/suggestions/:sug_id/accept applies suggestion"
          ]
        },
        {
          "id": "D04-031",
          "description": "Routes: EMR import, field mapping templates, ED shifts, data export, submission preferences",
          "verify": "pnpm --filter api vitest run test/integration/claim/",
          "depends": ["D04-023", "D04-024", "D04-026"],
          "build": [
            "Add to `apps/api/src/domains/claim/claim.routes.ts` and handlers:",
            "",
            "**EMR Import (auth required):**",
            "- POST /api/v1/imports → uploadImportHandler (multipart file + optional template_id)",
            "- GET /api/v1/imports/:id → getImportHandler (params: importIdParamSchema)",
            "- GET /api/v1/imports/:id/preview → previewImportHandler",
            "- POST /api/v1/imports/:id/commit → commitImportHandler",
            "",
            "**Field mapping templates (auth required):**",
            "- POST /api/v1/field-mapping-templates → createTemplateHandler (body: createTemplateSchema)",
            "- GET /api/v1/field-mapping-templates → listTemplatesHandler",
            "- PUT /api/v1/field-mapping-templates/:id → updateTemplateHandler (body: updateTemplateSchema)",
            "- DELETE /api/v1/field-mapping-templates/:id → deleteTemplateHandler",
            "",
            "**ED Shifts (auth required):**",
            "- POST /api/v1/shifts → createShiftHandler (body: createShiftSchema)",
            "- POST /api/v1/shifts/:id/encounters → addEncounterHandler (body: addEncounterSchema)",
            "- PUT /api/v1/shifts/:id/complete → completeShiftHandler",
            "- GET /api/v1/shifts/:id → getShiftHandler",
            "",
            "**Data Export (auth required):**",
            "- POST /api/v1/exports → requestExportHandler (body: createExportSchema)",
            "- GET /api/v1/exports/:id → getExportHandler",
            "",
            "**Submission preferences (auth required):**",
            "- GET /api/v1/submission-preferences → getPreferencesHandler",
            "- PUT /api/v1/submission-preferences → updatePreferencesHandler (body: updatePreferencesSchema)",
            "",
            "Create `apps/api/test/integration/claim/imports.integration.ts`, `shifts.integration.ts`, and `exports.integration.ts`."
          ],
          "security": [
            "Import upload endpoint rate-limited at 5 req/min per user (file upload rate limit).",
            "Export download requires authenticated session — files not accessible via unauthenticated URL.",
            "Field mapping templates are physician-scoped — CRUD operations verify ownership.",
            "Submission preference changes are audit-logged."
          ],
          "tests": [
            "POST /imports uploads file and returns import_batch_id",
            "POST /imports rejects duplicate file (same hash)",
            "GET /imports/:id/preview returns mapped preview",
            "POST /imports/:id/commit creates claims and returns counts",
            "POST /field-mapping-templates creates template",
            "GET /field-mapping-templates lists physician's templates",
            "DELETE /field-mapping-templates/:id deletes owned template",
            "POST /shifts creates shift with IN_PROGRESS status",
            "POST /shifts/:id/encounters adds encounter to shift",
            "PUT /shifts/:id/complete completes shift",
            "POST /exports creates export request",
            "GET /exports/:id returns status and download URL",
            "PUT /submission-preferences updates mode"
          ]
        },
        {
          "id": "D04-032",
          "description": "Integration tests: full claim lifecycle (create → validate → queue → submit → assess → paid)",
          "verify": "pnpm --filter api vitest run test/integration/claim/",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/integration/claim/lifecycle.integration.ts`.",
            "",
            "**Full lifecycle test (happy path):**",
            "1. Create physician via IAM, create patient via Patient Registry",
            "2. POST /claims — create AHCIP claim → draft state",
            "3. POST /claims/:id/validate — validate → passes → validated state",
            "4. POST /claims/:id/queue — queue → classified as clean → queued state",
            "5. Simulate batch assembly → submitted state (batch assembly is pathway-specific, mock for core)",
            "6. Simulate assessment response → assessed state",
            "7. Simulate payment confirmation → paid state (terminal)",
            "8. Verify full claim_audit_history chain: CREATED → VALIDATED → QUEUED → SUBMITTED → ASSESSED → PAID",
            "",
            "**Rejection lifecycle:**",
            "1. Submit claim → rejected state",
            "2. GET /claims/:id/rejection-details — verify codes and guidance",
            "3. PUT /claims/:id — edit claim to fix rejection",
            "4. POST /claims/:id/resubmit — revalidate and requeue",
            "5. Verify audit trail includes REJECTED → RESUBMITTED entries",
            "",
            "**Invalid transitions:**",
            "- draft → submitted (skip queue) → 409",
            "- paid → draft (terminal state) → 409",
            "- deleted → validated (terminal state) → 409"
          ],
          "frd": [
            "Domain 4.0 Section 9.1: State machine tests — all valid transitions, invalid transitions rejected, terminal states.",
            "Domain 4.0 Section 9.5: Integration tests — full lifecycle, rejection lifecycle."
          ],
          "tests": [
            "Full lifecycle: create → validate → queue → submit → assess → paid",
            "Rejection lifecycle: submit → reject → review → resubmit → paid",
            "Invalid transition draft → submitted returns 409",
            "Invalid transition from terminal state returns 409",
            "Audit trail records every state change",
            "Claim audit history chain is complete and ordered"
          ]
        },
        {
          "id": "D04-033",
          "description": "Integration tests: EMR import, ED shift workflow, auto-submission modes, deadline expiry",
          "verify": "pnpm --filter api vitest run test/integration/claim/",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/integration/claim/import.integration.ts`, `shift.integration.ts`, `auto-submission.integration.ts`.",
            "",
            "**EMR import tests:**",
            "- Upload CSV with comma delimiter → parse → preview → commit → claims created",
            "- Upload with header row and without header row",
            "- Upload with multiple date formats",
            "- Partial failure: some rows succeed, some fail → correct counts",
            "- Duplicate file detection via SHA-256",
            "- Field mapping template reuse across imports",
            "",
            "**ED shift tests:**",
            "- Create shift → add encounters → complete → verify after-hours calculation triggered",
            "- Add encounter to completed shift → rejected",
            "- Shift encounter count matches actual claims",
            "",
            "**Auto-submission mode tests:**",
            "- Auto Clean: clean claim auto-included, flagged excluded",
            "- Auto All: both clean and flagged included",
            "- Require Approval: no claims without explicit approval",
            "- Delegate approval of flagged claim: included in next batch",
            "",
            "**Deadline expiry test:**",
            "- Create claim with old DOS (past 90 days) → verify EXPIRED transition",
            "- Claim within 7 days of deadline → verify DEADLINE_APPROACHING notification emitted"
          ],
          "frd": [
            "Domain 4.0 Section 9.2: Auto-submission mode tests for all three modes plus delegate approval.",
            "Domain 4.0 Section 9.4: EMR import tests — delimiters, headers, date formats, partial failures, template reuse, hash dedup.",
            "Domain 4.0 Section 9.5: ED shift workflow integration test, 90-day expiry test."
          ],
          "tests": [
            "EMR import: CSV comma delimiter parses correctly",
            "EMR import: partial failure reports correct counts",
            "EMR import: duplicate file rejected by hash",
            "EMR import: template reuse across imports",
            "ED shift: create → encounters → complete lifecycle",
            "ED shift: reject encounter on completed shift",
            "Auto-submission: Auto Clean includes clean only",
            "Auto-submission: Auto All includes both",
            "Auto-submission: Require Approval blocks all without approval",
            "Deadline expiry transitions claim to EXPIRED",
            "Deadline approaching emits notification"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.0: Claim Lifecycle Core — Security Tests",
      "tasks": [
        {
          "id": "D04-040",
          "description": "Security: authentication enforcement on every route",
          "verify": "pnpm --filter api vitest run test/security/claim/claim.authn.security.ts",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/security/claim/claim.authn.security.ts`.",
            "",
            "Test every authenticated route in the Claim domain returns 401 without a valid session cookie. This includes:",
            "",
            "- POST /api/v1/claims",
            "- GET /api/v1/claims",
            "- GET /api/v1/claims/:id",
            "- PUT /api/v1/claims/:id",
            "- DELETE /api/v1/claims/:id",
            "- POST /api/v1/claims/:id/validate",
            "- POST /api/v1/claims/:id/queue",
            "- POST /api/v1/claims/:id/unqueue",
            "- POST /api/v1/claims/:id/write-off",
            "- POST /api/v1/claims/:id/resubmit",
            "- GET /api/v1/claims/:id/suggestions",
            "- POST /api/v1/claims/:id/suggestions/:sug_id/accept",
            "- POST /api/v1/claims/:id/suggestions/:sug_id/dismiss",
            "- GET /api/v1/claims/rejected",
            "- GET /api/v1/claims/:id/rejection-details",
            "- GET /api/v1/claims/:id/audit",
            "- POST /api/v1/imports",
            "- GET /api/v1/imports/:id",
            "- GET /api/v1/imports/:id/preview",
            "- POST /api/v1/imports/:id/commit",
            "- POST /api/v1/field-mapping-templates",
            "- GET /api/v1/field-mapping-templates",
            "- PUT /api/v1/field-mapping-templates/:id",
            "- DELETE /api/v1/field-mapping-templates/:id",
            "- POST /api/v1/shifts",
            "- POST /api/v1/shifts/:id/encounters",
            "- PUT /api/v1/shifts/:id/complete",
            "- GET /api/v1/shifts/:id",
            "- POST /api/v1/exports",
            "- GET /api/v1/exports/:id",
            "- GET /api/v1/submission-preferences",
            "- PUT /api/v1/submission-preferences",
            "",
            "For each route: send request with no cookie, with expired cookie, and with tampered cookie. All must return 401 with no data leakage."
          ],
          "security": [
            "401 responses must not contain any data in the response body beyond the error object.",
            "Tampered cookies must be rejected (invalid signature / hash mismatch).",
            "Expired sessions must return 401 (not 200 with stale data)."
          ]
        },
        {
          "id": "D04-041",
          "description": "Security: authorization and permission enforcement",
          "verify": "pnpm --filter api vitest run test/security/claim/claim.authz.security.ts",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/security/claim/claim.authz.security.ts`.",
            "",
            "**Delegate permission boundary tests:**",
            "- Delegate with CLAIM_VIEW only cannot POST /claims (requires CLAIM_CREATE) → 403",
            "- Delegate with CLAIM_VIEW only cannot PUT /claims/:id (requires CLAIM_EDIT) → 403",
            "- Delegate with CLAIM_VIEW only cannot DELETE /claims/:id (requires CLAIM_DELETE) → 403",
            "- Delegate with CLAIM_VIEW only cannot POST /claims/:id/queue (requires CLAIM_SUBMIT) → 403",
            "- Delegate without CLAIM_APPROVE cannot approve flagged claims → 403",
            "",
            "**Delegate with correct permissions:**",
            "- Delegate with CLAIM_CREATE can POST /claims → 201",
            "- Delegate with CLAIM_VIEW can GET /claims → 200",
            "- Delegate with CLAIM_EDIT can PUT /claims/:id → 200",
            "- Delegate with CLAIM_SUBMIT can POST /claims/:id/queue → 200",
            "",
            "**Role enforcement:**",
            "- Physician can access all claim routes (full permissions)",
            "- Admin cannot view individual claim data without explicit PHI access grant"
          ]
        },
        {
          "id": "D04-042",
          "description": "Security: physician tenant isolation (MOST CRITICAL)",
          "verify": "pnpm --filter api vitest run test/security/claim/claim.scoping.security.ts",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/security/claim/claim.scoping.security.ts`.",
            "",
            "Create two physician accounts (physician1, physician2) using createSecurityPair fixture. Each physician creates claims, imports, templates, shifts.",
            "",
            "**Claim isolation:**",
            "- Physician1 cannot see physician2's claims via GET /claims → empty list",
            "- Physician1 cannot view physician2's claim via GET /claims/:id → 404",
            "- Physician1 cannot edit physician2's claim via PUT /claims/:id → 404",
            "- Physician1 cannot delete physician2's claim → 404",
            "- Physician1 cannot validate/queue/write-off physician2's claim → 404",
            "",
            "**Import isolation:**",
            "- Physician1 cannot view physician2's import batch → 404",
            "- Physician1 cannot preview/commit physician2's import → 404",
            "",
            "**Template isolation:**",
            "- Physician1 cannot view physician2's templates → empty list",
            "- Physician1 cannot update/delete physician2's template → 404",
            "",
            "**Shift isolation:**",
            "- Physician1 cannot view physician2's shift → 404",
            "- Physician1 cannot add encounters to physician2's shift → 404",
            "",
            "**Export isolation:**",
            "- Physician1 cannot view physician2's export → 404",
            "",
            "**Claim audit isolation:**",
            "- Physician1 cannot view physician2's claim audit history → 404",
            "",
            "**Delegate cross-context:**",
            "- Delegate linked to physician1 cannot access physician2's claims in physician1 context",
            "- Delegate context switch: claims in physician1 context do not appear in physician2 context",
            "",
            "**IMPORTANT:** All cross-physician access attempts return 404, not 403 (do not confirm resource existence)."
          ]
        },
        {
          "id": "D04-043",
          "description": "Security: input validation and injection prevention",
          "verify": "pnpm --filter api vitest run test/security/claim/claim.input.security.ts",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/security/claim/claim.input.security.ts`.",
            "",
            "**SQL injection payloads on string inputs:**",
            "- claim_type field: `' OR 1=1--`, `AHCIP'; DROP TABLE claims;--`",
            "- state filter: SQL injection payloads",
            "- write-off reason: SQL injection payloads",
            "- template name: SQL injection payloads",
            "",
            "**XSS payloads on stored text fields:**",
            "- write-off reason: `<script>alert(1)</script>`",
            "- template name: `<img onerror=alert(1) src=x>`",
            "- AI suggestion dismissal reason: XSS payload",
            "",
            "**Type coercion attacks:**",
            "- Send number where string expected, array where string expected, null where required",
            "- Send negative page_size to list claims → 400",
            "- Send page_size > 100 to list claims → capped at 100",
            "",
            "**UUID parameter validation:**",
            "- Non-UUID in claim_id path param → 400",
            "- Non-UUID in patient_id body field → 400",
            "- Non-UUID in shift_id path param → 400",
            "- Non-UUID in suggestion_id path param → 400",
            "",
            "**Date validation:**",
            "- Invalid date format in date_of_service → 400",
            "- Future date in date_of_service → validation error (not 400, but S5 check)",
            "",
            "**claim_type validation:**",
            "- Invalid claim_type (not AHCIP or WCB) → 400",
            "",
            "**File upload validation (imports):**",
            "- Oversized file → 413",
            "- Non-CSV/TSV file → 400",
            "- Malicious filename (path traversal) → sanitised"
          ]
        },
        {
          "id": "D04-044",
          "description": "Security: data leakage prevention (PHI protection)",
          "verify": "pnpm --filter api vitest run test/security/claim/claim.leakage.security.ts",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/security/claim/claim.leakage.security.ts`.",
            "",
            "**PHI not in error responses:**",
            "- 400 validation error does not include patient PHN or DOB in error message",
            "- 404 response for cross-physician claim does not reveal claim exists",
            "- 409 state transition error does not leak claim details to wrong physician",
            "- 500 error does not expose stack traces, SQL errors, or internal details",
            "",
            "**PHI not in headers:**",
            "- No X-Powered-By header",
            "- No Server header revealing version",
            "- HSTS header present",
            "- CSP headers present",
            "- No claim data in response headers",
            "",
            "**PHI not in logs (verify log output):**",
            "- Patient PHN does not appear in application logs",
            "- Validation errors logged without PHI details",
            "",
            "**Sensitive fields stripped from responses:**",
            "- Claim response does not expose internal fields (e.g., raw JSONB internals that could leak provider setup)",
            "- Import error_details do not expose other patients' data",
            "- Export download URL is authenticated — not guessable",
            "",
            "**Data export security:**",
            "- Export file download requires valid session",
            "- Export file URL expires after download or timeout",
            "- Export files not accessible via direct URL without auth"
          ]
        },
        {
          "id": "D04-045",
          "description": "Security: audit trail completeness for all claim actions",
          "verify": "pnpm --filter api vitest run test/security/claim/claim.audit.security.ts",
          "depends": ["D04-030", "D04-031"],
          "build": [
            "Create `apps/api/test/security/claim/claim.audit.security.ts`.",
            "",
            "Verify that each state change and significant action produces an audit record in claim_audit_history. Run the action, then query the audit history and verify the entry.",
            "",
            "**State change events:**",
            "- Claim created → action = CREATED with import_source, actor_id, actor_context",
            "- Claim edited → action = EDITED with field-level changes diff",
            "- Claim validated → action = VALIDATED with validation_result summary",
            "- Claim queued → action = QUEUED with is_clean classification",
            "- Claim unqueued → action = UNQUEUED",
            "- Claim submitted → action = SUBMITTED with batch_id",
            "- Claim assessed → action = ASSESSED",
            "- Claim rejected → action = REJECTED with rejection codes",
            "- Claim resubmitted → action = RESUBMITTED",
            "- Claim written off → action = WRITTEN_OFF with reason",
            "- Claim deleted → action = DELETED",
            "- Claim expired → action = EXPIRED (system-initiated)",
            "",
            "**AI Coach events:**",
            "- Suggestion accepted → action = AI_SUGGESTION_ACCEPTED with suggestion details",
            "- Suggestion dismissed → action = AI_SUGGESTION_DISMISSED with reason",
            "",
            "**Duplicate event:**",
            "- Duplicate acknowledged → action = DUPLICATE_ACKNOWLEDGED",
            "",
            "**Audit log integrity:**",
            "- Verify no UPDATE endpoints exist for claim_audit_history",
            "- Verify no DELETE endpoints exist for claim_audit_history",
            "- Verify actor_context correctly records PHYSICIAN, DELEGATE, or SYSTEM",
            "- Verify delegate actions record both delegate identity and physician context"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.0: Claim Lifecycle Core — Final Validation",
      "tasks": [
        {
          "id": "D04-099",
          "description": "Full domain test suite: all unit + integration + security tests",
          "verify": "pnpm --filter api vitest run src/domains/claim/ test/integration/claim/ test/security/claim/",
          "depends": ["D04-040", "D04-041", "D04-042", "D04-043", "D04-044", "D04-045"],
          "build": [
            "Run the complete test suite for Domain 4.0 Claim Lifecycle Core. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/claim/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/claim/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/claim/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/claim/ test/integration/claim/ test/security/claim/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/claim/claim.authn.security.ts",
            "- test/security/claim/claim.authz.security.ts",
            "- test/security/claim/claim.scoping.security.ts",
            "- test/security/claim/claim.input.security.ts",
            "- test/security/claim/claim.leakage.security.ts",
            "- test/security/claim/claim.audit.security.ts"
          ]
        }
      ]
    }
  ]
}
