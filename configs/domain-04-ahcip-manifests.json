{
  "domainNumber": "04",
  "domainName": "AHCIP Claim Pathway",
  "manifestFile": "domain-04-ahcip.tasks",
  "promptPrefix": "d04a",
  "modulePath": "apps/api/src/domains/ahcip",
  "sections": [
    {
      "title": "Domain 4.1: AHCIP Claim Pathway — Shared Types & Constants",
      "tasks": [
        {
          "id": "D04A-001",
          "description": "AHCIP constants: batch statuses, validation check IDs (A1–A19), encounter types, after-hours types, modifier codes, cycle timeline",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/ahcip.constants.ts` with all AHCIP-specific constants:",
            "",
            "**AhcipBatchStatus enum:**",
            "- ASSEMBLING, GENERATED, SUBMITTED, RESPONSE_RECEIVED, RECONCILED, ERROR",
            "",
            "**AHCIP validation check IDs (19 checks):**",
            "- A1_HSC_CODE_VALID, A2_HSC_ACTIVE_ON_DOS, A3_BA_NUMBER_VALID",
            "- A4_GOVERNING_RULES, A5_MODIFIER_ELIGIBILITY, A6_MODIFIER_COMBINATION",
            "- A7_DIAGNOSTIC_CODE_REQUIRED, A8_FACILITY_REQUIRED, A9_REFERRAL_REQUIRED",
            "- A10_DI_SURCHARGE_ELIGIBILITY, A11_PCPCM_ROUTING, A12_AFTER_HOURS_ELIGIBILITY",
            "- A13_90_DAY_WINDOW, A14_TIME_BASED_DURATION, A15_CALL_COUNT_VALID",
            "- A16_SHADOW_BILLING_CONSISTENCY, A17_RRNP_ELIGIBILITY, A18_PREMIUM_ELIGIBILITY_351",
            "- A19_BUNDLING_CHECK",
            "",
            "**Check severities map:** A1–A9,A13(expired),A14,A15 = Error; A10–A12,A13(warning),A16,A19 = Warning; A17,A18 = Info",
            "",
            "**AfterHoursType enum:** EVENING, WEEKEND, NIGHT, STAT_HOLIDAY",
            "",
            "**After-hours time slot definitions:**",
            "- Standard: Mon–Fri 08:00–17:00 (excl. holidays)",
            "- Evening: Mon–Fri 17:00–23:00",
            "- Night: 23:00–08:00 any day",
            "- Weekend: Sat/Sun full day",
            "- Stat holiday: 10 named Alberta statutory holidays",
            "",
            "**EncounterType enum:** CONSULTATION, FOLLOW_UP, PROCEDURE, SURGICAL, DIAGNOSTIC_IMAGING, OBSTETRIC, CDM, VIRTUAL, OTHER",
            "",
            "**Well-known modifier codes:** TM (shadow billing), AFHR (after-hours), CMGP (comprehensive care), LOCI (locum), 13.99H (ED surcharge), BMI (body mass index)",
            "",
            "**GoverningRule enum:** GR_1, GR_3, GR_5, GR_8, GR_10, GR_14, GR_18 (representative set)",
            "",
            "**Batch cycle constants:**",
            "- CUTOFF_DAY: 4 (Thursday)",
            "- CUTOFF_HOUR: 12 (MT)",
            "- RETRY_INTERVALS: [60, 300, 900, 3600] seconds (exponential backoff)",
            "- MAX_RETRIES: 4",
            "",
            "Export all as frozen objects / TypeScript enums."
          ],
          "frd": [
            "Domain 4.1 Section 5.1: 19 AHCIP validation checks (A1–A19) with severity assignments.",
            "Domain 4.1 Section 3.1: Thursday batch cycle timeline — 12:00 MT cutoff, assembly, transmission, assessment Friday.",
            "Domain 4.1 Section 6.5: After-hours time slot definitions — standard, evening, night, weekend, stat holiday.",
            "Domain 4.1 Section 5.2: Governing rules GR 1,3,5,8,10,14,18.",
            "Domain 4.1 Table 8: Modifier codes and fee impact."
          ]
        },
        {
          "id": "D04A-002",
          "description": "Drizzle schema for ahcip_claim_details table",
          "verify": "pnpm --filter shared build",
          "depends": ["D04A-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/ahcip.schema.ts` starting with the ahcip_claim_details table.",
            "",
            "**ahcip_claim_details table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| ahcip_detail_id | UUID | PK | Default: gen_random_uuid() |",
            "| claim_id | UUID FK | NOT NULL, UNIQUE, FK → claims.claim_id | 1:1 with base claim |",
            "| ba_number | VARCHAR(10) | NOT NULL | Resolved from Provider Mgmt based on PCPCM routing |",
            "| functional_centre | VARCHAR(10) | NOT NULL | Hospital, clinic, community code |",
            "| health_service_code | VARCHAR(10) | NOT NULL | Primary HSC code from SOMB |",
            "| modifier_1 | VARCHAR(6) | NULLABLE | Primary modifier (AFHR, TM, CMGP, etc.) |",
            "| modifier_2 | VARCHAR(6) | NULLABLE | Secondary modifier |",
            "| modifier_3 | VARCHAR(6) | NULLABLE | Tertiary modifier |",
            "| diagnostic_code | VARCHAR(8) | NULLABLE | ICD-9, required for certain HSC categories |",
            "| facility_number | VARCHAR(10) | NULLABLE | Required for hospital-based claims |",
            "| referral_practitioner | VARCHAR(10) | NULLABLE | Referring physician billing # (GR 8) |",
            "| encounter_type | VARCHAR(10) | NOT NULL | Consultation, follow-up, procedure, etc. |",
            "| calls | SMALLINT | NOT NULL, DEFAULT 1 | Number of calls billed |",
            "| time_spent | SMALLINT | NULLABLE | Minutes for time-based HSC codes |",
            "| patient_location | VARCHAR(10) | NULLABLE | Inpatient, outpatient, community, virtual |",
            "| shadow_billing_flag | BOOLEAN | NOT NULL, DEFAULT false | True for ARP claims with TM modifier |",
            "| pcpcm_basket_flag | BOOLEAN | NOT NULL, DEFAULT false | True = PCPCM BA, False = FFS BA |",
            "| after_hours_flag | BOOLEAN | NOT NULL, DEFAULT false | Auto-calculated from service time |",
            "| after_hours_type | VARCHAR(20) | NULLABLE | EVENING, WEEKEND, NIGHT, STAT_HOLIDAY |",
            "| submitted_fee | DECIMAL(10,2) | NULLABLE | Calculated fee at submission |",
            "| assessed_fee | DECIMAL(10,2) | NULLABLE | Fee from assessment response |",
            "| assessment_explanatory_codes | JSONB | NULLABLE | Array of explanatory codes |",
            "",
            "**Indexes:** unique on claim_id (1:1), (ba_number, health_service_code), (pcpcm_basket_flag).",
            "",
            "Export table and inferred types (InsertAhcipClaimDetail, SelectAhcipClaimDetail)."
          ],
          "frd": [
            "Domain 4.1 Section 2.1: ahcip_claim_details table — 22 columns. One row per AHCIP claim, linked 1:1 to base claims table. Contains all H-Link file fields."
          ],
          "security": [
            "ahcip_claim_details contain PHI (diagnostic codes, service details). Encrypted at rest.",
            "claim_id FK enforces 1:1 with base claims — no orphaned AHCIP details.",
            "assessment_explanatory_codes JSONB may contain payer-specific rejection details — treat as sensitive."
          ]
        },
        {
          "id": "D04A-003",
          "description": "Drizzle schema for ahcip_batches table",
          "verify": "pnpm --filter shared build",
          "depends": ["D04A-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/ahcip.schema.ts`:",
            "",
            "**ahcip_batches table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| ahcip_batch_id | UUID | PK | |",
            "| physician_id | UUID FK | NOT NULL, FK → providers | |",
            "| ba_number | VARCHAR(10) | NOT NULL | BA for this batch. PCPCM may have 2 batches. |",
            "| batch_week | DATE | NOT NULL | Thursday date for this batch cycle |",
            "| status | VARCHAR(20) | NOT NULL | ASSEMBLING, GENERATED, SUBMITTED, RESPONSE_RECEIVED, RECONCILED, ERROR |",
            "| claim_count | INTEGER | NOT NULL | Number of claims in batch |",
            "| total_submitted_value | DECIMAL(12,2) | NOT NULL | Sum of submitted fees |",
            "| file_path | VARCHAR(255) | NULLABLE | Path to generated H-Link file (encrypted) |",
            "| file_hash | VARCHAR(64) | NULLABLE | SHA-256 of generated file |",
            "| submission_reference | VARCHAR(50) | NULLABLE | H-Link submission reference |",
            "| submitted_at | TIMESTAMPTZ | NULLABLE | When transmitted to AHCIP |",
            "| response_received_at | TIMESTAMPTZ | NULLABLE | When assessment processed |",
            "| created_at | TIMESTAMPTZ | NOT NULL | |",
            "| created_by | UUID FK | NOT NULL | SYSTEM for auto, user for manual |",
            "",
            "**Indexes:** (physician_id, batch_week DESC), (status), unique on (physician_id, ba_number, batch_week).",
            "",
            "Export table and inferred types."
          ],
          "frd": [
            "Domain 4.1 Section 2.2: ahcip_batches table — 14 columns. Batches grouped by physician_id + ba_number per week.",
            "Domain 4.1 Section 3.2: Batch assembly rules — grouped by physician + BA, PCPCM dual-BA generates two batches."
          ],
          "security": [
            "file_path points to an AES-256 encrypted H-Link file. Never serve raw file content via API.",
            "submission_reference is sensitive — used for H-Link tracking. Do not expose in logs.",
            "Unique constraint on (physician_id, ba_number, batch_week) prevents duplicate batches per cycle."
          ]
        },
        {
          "id": "D04A-004",
          "description": "Zod validation schemas for AHCIP claim details, batch, fee, and assessment endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D04A-001"],
          "build": [
            "Create `packages/shared/src/schemas/ahcip.schema.ts` with Zod schemas:",
            "",
            "**AHCIP claim detail creation (extends base claim):**",
            "- createAhcipDetailSchema: { health_service_code: string().min(1).max(10), functional_centre: string().min(1).max(10), encounter_type: enum(EncounterTypes), modifier_1: string().max(6).optional(), modifier_2: string().max(6).optional(), modifier_3: string().max(6).optional(), diagnostic_code: string().max(8).optional(), facility_number: string().max(10).optional(), referral_practitioner: string().max(10).optional(), calls: number().int().min(1).default(1), time_spent: number().int().min(1).optional(), patient_location: string().max(10).optional() }",
            "",
            "**AHCIP claim detail update:**",
            "- updateAhcipDetailSchema: partial of createAhcipDetailSchema. health_service_code is editable.",
            "",
            "**Batch endpoints:**",
            "- listBatchesSchema: { status: enum(AhcipBatchStatus).optional(), date_from: date.optional(), date_to: date.optional(), page: number().int().min(1).default(1), page_size: number().int().min(1).max(50).default(20) }",
            "- batchIdParamSchema: { id: uuid() }",
            "",
            "**Fee calculation:**",
            "- feeCalculateSchema: same as createAhcipDetailSchema + { date_of_service: date, patient_id: uuid() } (for preview without saving)",
            "",
            "**Assessment query:**",
            "- batchAssessmentParamSchema: { batch_id: uuid() }",
            "",
            "Export all schemas and inferred types."
          ],
          "frd": [
            "Domain 4.1 Section 2.1: AHCIP claim detail fields with types and constraints.",
            "Domain 4.1 Section 8.1: Batch management endpoints.",
            "Domain 4.1 Section 8.3: Fee calculation endpoint."
          ]
        },
        {
          "id": "D04A-005",
          "description": "Generate and apply database migration for AHCIP tables",
          "verify": "cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1",
          "depends": ["D04A-002", "D04A-003"],
          "build": [
            "Run the Drizzle migration generator for AHCIP tables:",
            "",
            "```bash",
            "cd apps/api",
            "pnpm drizzle-kit generate",
            "pnpm drizzle-kit migrate",
            "```",
            "",
            "Verify migration file created in `apps/api/drizzle/migrations/`.",
            "Verify tables exist: ahcip_claim_details, ahcip_batches.",
            "Verify FK from ahcip_claim_details.claim_id → claims.claim_id (Domain 4.0).",
            "Verify unique constraint on (physician_id, ba_number, batch_week) for ahcip_batches.",
            "Verify unique constraint on claim_id for ahcip_claim_details."
          ]
        }
      ]
    },
    {
      "title": "Domain 4.1: AHCIP Claim Pathway — Repository Layer",
      "tasks": [
        {
          "id": "D04A-010",
          "description": "Repository: AHCIP claim details CRUD (create, read, update with base claim join)",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts",
          "depends": ["D04A-005"],
          "build": [
            "Create `apps/api/src/domains/ahcip/ahcip.repository.ts`:",
            "",
            "- `createAhcipDetail(data: InsertAhcipClaimDetail)` — insert AHCIP extension row linked to base claim. Return ahcip_detail_id.",
            "- `findAhcipDetailByClaimId(claimId: string, physicianId: string)` — join ahcip_claim_details with claims to get full claim + AHCIP detail. Scoped to physician via claims.physician_id. Return null if not found or wrong physician.",
            "- `updateAhcipDetail(claimId: string, physicianId: string, data: Partial<InsertAhcipClaimDetail>)` — update AHCIP-specific fields. Verify physician ownership via join.",
            "- `findAhcipClaimWithDetails(claimId: string, physicianId: string)` — full claim + AHCIP details + patient info (name, PHN, DOB) via joins. For display/validation.",
            "- `listAhcipClaimsForBatch(physicianId: string, baNumber: string, isClean?: boolean)` — find queued AHCIP claims for batch assembly. Filtered by BA number for PCPCM dual-BA routing.",
            "- `updateAssessmentResult(claimId: string, assessedFee: number, explanatoryCodes: any)` — set assessed_fee and assessment_explanatory_codes after assessment ingestion."
          ],
          "security": [
            "All queries join through claims.physician_id for tenant isolation. Never query ahcip_claim_details without physician scoping.",
            "findAhcipDetailByClaimId returns null (not 403) for wrong physician.",
            "listAhcipClaimsForBatch must verify claims are in QUEUED state and claim_type = AHCIP."
          ],
          "tests": [
            "createAhcipDetail creates extension row linked to base claim",
            "findAhcipDetailByClaimId returns detail for owning physician",
            "findAhcipDetailByClaimId returns null for different physician",
            "updateAhcipDetail updates AHCIP fields",
            "updateAhcipDetail rejects update for wrong physician",
            "findAhcipClaimWithDetails returns joined claim + detail + patient",
            "listAhcipClaimsForBatch returns only queued AHCIP claims for BA",
            "listAhcipClaimsForBatch filters by ba_number for PCPCM routing",
            "updateAssessmentResult stores assessed fee and explanatory codes"
          ]
        },
        {
          "id": "D04A-011",
          "description": "Repository: AHCIP batches (create, status updates, query, claim-batch linking)",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts",
          "depends": ["D04A-005"],
          "build": [
            "Add to `apps/api/src/domains/ahcip/ahcip.repository.ts`:",
            "",
            "- `createAhcipBatch(data: InsertAhcipBatch)` — insert batch with ASSEMBLING status. Return ahcip_batch_id.",
            "- `findBatchById(batchId: string, physicianId: string)` — physician-scoped batch lookup.",
            "- `updateBatchStatus(batchId: string, status: string, extraFields?: Partial<InsertAhcipBatch>)` — update status and optional fields (file_path, file_hash, submission_reference, submitted_at, response_received_at).",
            "- `listBatches(physicianId: string, filters: ListBatchesFilters)` — paginated list with status and date range filters. Reverse chronological.",
            "- `findNextBatchPreview(physicianId: string)` — preview what the next Thursday batch would contain: list queued AHCIP claims grouped by BA number with counts and total values.",
            "- `findBatchesAwaitingResponse(physicianId: string)` — batches in SUBMITTED status (awaiting assessment).",
            "- `findBatchByWeek(physicianId: string, baNumber: string, batchWeek: string)` — find batch for a specific Thursday cycle + BA.",
            "- `linkClaimsToBatch(claimIds: string[], batchId: string)` — update claims.submitted_batch_id for all claims in the batch."
          ],
          "security": [
            "All batch queries scoped to physician_id. No cross-physician batch access.",
            "Unique constraint on (physician_id, ba_number, batch_week) enforced at DB level.",
            "linkClaimsToBatch must run in same transaction as batch assembly."
          ],
          "tests": [
            "createAhcipBatch creates batch with ASSEMBLING status",
            "findBatchById returns batch for owning physician",
            "findBatchById returns null for different physician",
            "updateBatchStatus transitions status correctly",
            "listBatches filters by status and date range",
            "listBatches paginates correctly",
            "findNextBatchPreview returns queued claims grouped by BA",
            "findBatchesAwaitingResponse returns only SUBMITTED batches",
            "findBatchByWeek returns batch for specific cycle",
            "findBatchByWeek rejects duplicate (unique constraint)",
            "linkClaimsToBatch sets submitted_batch_id on all claims"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.1: AHCIP Claim Pathway — Service Layer",
      "tasks": [
        {
          "id": "D04A-020",
          "description": "Service: AHCIP claim creation with extension data, BA resolution, and PCPCM routing",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts",
          "depends": ["D04A-010"],
          "build": [
            "Create `apps/api/src/domains/ahcip/ahcip.service.ts`:",
            "",
            "- `createAhcipClaim(physicianId: string, actorId: string, actorContext: string, baseData: CreateClaimInput, ahcipData: CreateAhcipDetailInput)` — call Domain 4.0 createClaim for base, then create AHCIP extension row. Resolve BA number via Provider Management (PCPCM routing if applicable). Set submission_deadline = DOS + 90 calendar days. Determine pcpcm_basket_flag from Reference Data basket classification. Determine after_hours_flag from service time context.",
            "",
            "**BA resolution logic:**",
            "- If physician is NOT PCPCM-enrolled: use their single FFS BA number.",
            "- If physician IS PCPCM-enrolled: lookup HSC basket classification from Reference Data. In-basket → PCPCM BA. Out-of-basket → FFS BA.",
            "",
            "**After-hours auto-detection:**",
            "- For ED shift claims: derive from shift start_time/end_time.",
            "- For manual claims: if service time provided, classify per time slot definitions.",
            "- Stat holiday check: call Reference Data for stat holiday list.",
            "",
            "**Shadow billing:** If modifier_1 = TM, set shadow_billing_flag = true."
          ],
          "frd": [
            "Domain 4.1 Section 6.4: PCPCM fee routing — in-basket to PCPCM BA, out-of-basket to FFS BA.",
            "Domain 4.1 Section 6.5: After-hours auto-calculation from service time and stat holiday check.",
            "Domain 4.1 Table 8: TM modifier = shadow billing, fee $0."
          ],
          "security": [
            "BA resolution must come from Provider Management — physician cannot specify arbitrary BA numbers.",
            "pcpcm_basket_flag derived from Reference Data, not user input — prevents misrouting.",
            "Shadow billing detection is automatic from TM modifier — cannot be manually overridden to bypass."
          ],
          "tests": [
            "createAhcipClaim creates base claim + AHCIP detail",
            "createAhcipClaim resolves FFS BA for non-PCPCM physician",
            "createAhcipClaim resolves PCPCM BA for in-basket code",
            "createAhcipClaim resolves FFS BA for out-of-basket code on PCPCM physician",
            "createAhcipClaim sets submission_deadline to DOS + 90 days",
            "createAhcipClaim auto-detects after-hours from shift times",
            "createAhcipClaim detects stat holiday after-hours",
            "createAhcipClaim sets shadow_billing_flag for TM modifier"
          ]
        },
        {
          "id": "D04A-021",
          "description": "Service: AHCIP validation module (A1–A19 checks, pathway delegation interface)",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts",
          "depends": ["D04A-010"],
          "build": [
            "Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:",
            "",
            "- `validateAhcipClaim(claimId: string, physicianId: string)` — implements the pathway delegation interface from Domain 4.0. Runs AHCIP-specific validation checks A1–A19 after shared checks have passed.",
            "",
            "**AHCIP validation pipeline (ordered):**",
            "A1: HSC code valid — exists in current SOMB schedule (version-aware by DOS). Calls Reference Data.",
            "A2: HSC active on DOS — code was active on date_of_service. Check effective date ranges.",
            "A3: BA number valid — ba_number is valid, active BA for physician. Calls Provider Management.",
            "A4: Governing rules — evaluate all applicable GRs for the HSC code. Calls Reference Data for GR definitions.",
            "A5: Modifier eligibility — each modifier valid for the HSC code and context.",
            "A6: Modifier combination — modifier pairs are valid (no mutually exclusive combinations).",
            "A7: Diagnostic code required — if HSC category requires ICD-9, validate present and valid.",
            "A8: Facility required — hospital-based encounters need facility_number.",
            "A9: Referral required (GR 8) — specialist consultations need referring practitioner.",
            "A10: DI surcharge eligibility — DI code surcharge conditions met (Warning).",
            "A11: PCPCM routing — basket classification correct for PCPCM physicians (Warning).",
            "A12: After-hours eligibility — HSC permits after-hours premium and time qualifies (Warning).",
            "A13: 90-day window — error if expired, warning if within 7 days (shared S6 overlap, AHCIP-specific).",
            "A14: Time-based code duration — time_spent present and within valid range for time-based codes.",
            "A15: Call count valid — calls within valid range for HSC code.",
            "A16: Shadow billing consistency — TM modifier ↔ shadow_billing_flag consistency (Warning).",
            "A17: RRNP eligibility — calculate and note RRNP premium if physician qualifies (Info).",
            "A18: Premium eligibility (351) — check 351 premium code list (Info).",
            "A19: Bundling check — potential bundling with other claims, same patient same DOS (Warning).",
            "",
            "Return AHCIP-specific ValidationResult entries to merge with shared results."
          ],
          "frd": [
            "Domain 4.1 Section 5.1: AHCIP validation pipeline — 19 checks with severity assignments.",
            "Domain 4.1 Section 5.2: Governing rules overview — GR 1,3,5,8,10,14,18.",
            "Domain 4.1 Table 6: Full check table with severity and descriptions."
          ],
          "security": [
            "Validation always uses current Reference Data version — no caching stale SOMB rules.",
            "reference_data_version recorded for audit traceability on every validation run.",
            "Governing rule evaluation must be deterministic — same input always produces same result."
          ],
          "tests": [
            "A1: valid HSC code passes",
            "A1: invalid HSC code returns error",
            "A2: HSC active on DOS passes",
            "A2: retired HSC code on DOS returns error",
            "A3: valid BA number passes",
            "A3: invalid BA number returns error",
            "A4: GR 3 visit limit exceeded returns error",
            "A4: GR 8 referral missing returns error",
            "A5: valid modifier for HSC passes",
            "A5: invalid modifier for HSC returns error",
            "A6: mutually exclusive modifiers returns error",
            "A7: missing required diagnostic code returns error",
            "A8: missing facility for hospital claim returns error",
            "A9: missing referral for specialist consultation returns error",
            "A13: expired 90-day window returns error",
            "A13: within 7 days of deadline returns warning",
            "A14: missing time_spent for time-based code returns error",
            "A16: shadow billing inconsistency returns warning",
            "A19: potential bundling returns warning"
          ]
        },
        {
          "id": "D04A-022",
          "description": "Service: AHCIP fee calculation engine (base fee, modifiers, premiums, RRNP, PCPCM, shadow billing)",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts",
          "depends": ["D04A-010"],
          "build": [
            "Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:",
            "",
            "- `calculateFee(claimId: string, physicianId: string)` — calculate submitted_fee for an AHCIP claim. Store result on ahcip_claim_details.submitted_fee.",
            "- `calculateFeePreview(physicianId: string, data: FeeCalculateInput)` — calculate fee without saving. For UI preview/estimation.",
            "- `getFeeBreakdown(claimId: string, physicianId: string)` — return detailed breakdown: { base_fee, calls, modifier_adjustments: [{modifier, effect, amount}], premiums: [{type, amount}], rrnp_premium, total_fee }.",
            "",
            "**Fee formula:**",
            "submitted_fee = (base_fee × calls) + modifier_adjustments + premiums",
            "",
            "**Steps:**",
            "1. Look up base_fee from SOMB schedule for HSC code (version-aware by DOS). Calls Reference Data.",
            "2. Apply modifier adjustments in SOMB-defined priority order. Each modifier: percentage-based or additive. Calls Reference Data for modifier fee impact matrix.",
            "3. Calculate premiums independently:",
            "   - CMGP premium: if CMGP modifier present and HSC qualifies",
            "   - After-hours premium: based on after_hours_type and HSC category",
            "   - RRNP premium: flat addition if physician qualifies (from Provider Mgmt) and community rate (from Reference Data)",
            "   - ED surcharge (13.99H): if applicable",
            "4. Shadow billing override: if shadow_billing_flag = true (TM modifier), set total to $0.00.",
            "5. PCPCM in-basket: for capitated codes, fee is calculated for tracking but may be $0 depending on billing arrangement."
          ],
          "frd": [
            "Domain 4.1 Section 6.1: Fee formula — base_fee × calls + modifier_adjustments + premiums.",
            "Domain 4.1 Section 6.2: Modifier fee impact matrix — from Reference Data.",
            "Domain 4.1 Section 6.3: RRNP premium — flat addition by community code, quarterly rates.",
            "Domain 4.1 Section 6.4: PCPCM fee routing — in-basket vs out-of-basket.",
            "Domain 4.1 Section 6.5: After-hours premium by time slot.",
            "Domain 4.1 Table 8: Modifier codes and fee impacts."
          ],
          "tests": [
            "calculateFee returns correct base fee from SOMB",
            "calculateFee applies modifier adjustments in priority order",
            "calculateFee adds CMGP premium for qualifying code",
            "calculateFee adds after-hours premium for evening",
            "calculateFee adds after-hours premium for weekend",
            "calculateFee adds after-hours premium for stat holiday",
            "calculateFee adds RRNP premium for qualifying physician",
            "calculateFee returns $0 for shadow billing (TM modifier)",
            "calculateFee handles multiple calls correctly",
            "calculateFeePreview returns result without saving",
            "getFeeBreakdown returns itemised breakdown",
            "calculateFee applies ED surcharge (13.99H)",
            "calculateFee handles PCPCM in-basket code"
          ]
        },
        {
          "id": "D04A-023",
          "description": "Service: Thursday batch cycle (assembly, H-Link file generation, transmission, retry logic)",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts",
          "depends": ["D04A-010", "D04A-011", "D04A-022"],
          "build": [
            "Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:",
            "",
            "- `assembleBatch(physicianId: string, batchWeek: string)` — group queued AHCIP claims by BA number. For PCPCM physicians, create separate batches per BA. Run pre-submission validation on every claim. Remove failed claims (return to validated, notify). Calculate fee for each claim. Create ahcip_batch record with ASSEMBLING status. Link claims to batch. Transition claims to SUBMITTED. Emit BATCH_ASSEMBLED notification.",
            "- `generateHlinkFile(batchId: string)` — generate H-Link file per Electronic Claims Submission Specifications Manual format. File structure: header (submitter prefix, batch date, record count, vendor ID), claim records (ordered by DOS ascending), trailer (record count, total value checksum). Store encrypted file, set file_path and file_hash. Update batch status to GENERATED.",
            "- `transmitBatch(batchId: string)` — transmit H-Link file via secure channel (SFTP/API). Log transmission result. Update batch status to SUBMITTED with submitted_at timestamp and submission_reference. On failure: retry with exponential backoff (1m, 5m, 15m, 1h). After 4 failures: status = ERROR, emit notification.",
            "- `previewNextBatch(physicianId: string)` — preview what next Thursday's batch will contain without actually assembling.",
            "- `retryFailedBatch(batchId: string, physicianId: string)` — retry transmission for ERROR status batch.",
            "",
            "**Batch assembly rules:**",
            "- Claims grouped by physician_id + ba_number",
            "- Only QUEUED + AHCIP claims included",
            "- Auto-submission mode respected (clean/flagged per physician preference)",
            "- Claims ordered by date_of_service ascending within file",
            "- Pre-submission validation runs final time; failed claims removed with notification",
            "",
            "**No off-cycle submissions.** Claims queued after Thursday 12:00 MT wait until next Thursday."
          ],
          "frd": [
            "Domain 4.1 Section 3.1: Cycle timeline — Thursday 12:00 cutoff, assembly 12:00–14:00, transmission 14:00+.",
            "Domain 4.1 Section 3.2: Batch assembly rules — grouped by physician + BA, PCPCM dual-BA, pre-submission validation, DOS ordering.",
            "Domain 4.1 Section 3.3: No off-cycle submission. Retry with exponential backoff on transmission failure.",
            "Domain 4.1 Section 4.1: H-Link file structure — header, claim records, trailer.",
            "Domain 4.1 Section 4.3: Transmission — secure channel, credentials in secrets, retry logic, file stored encrypted."
          ],
          "security": [
            "H-Link credentials (submitter prefix, transmission credentials) from secrets management — never in code or DB.",
            "Generated files encrypted at rest (AES-256). Stored with batch record for audit and resubmission.",
            "Transmission via secure channel (SFTP with key auth or TLS 1.3).",
            "Transmission logged: timestamp, file reference, record count, result.",
            "Pre-submission validation prevents sending invalid claims to AHCIP."
          ],
          "tests": [
            "assembleBatch groups claims by BA number",
            "assembleBatch creates separate batches for PCPCM dual-BA",
            "assembleBatch removes claims failing pre-submission validation",
            "assembleBatch calculates fee for each claim",
            "assembleBatch transitions claims to SUBMITTED",
            "assembleBatch emits BATCH_ASSEMBLED notification",
            "generateHlinkFile creates correct header structure",
            "generateHlinkFile orders claims by DOS ascending",
            "generateHlinkFile creates correct trailer with count and checksum",
            "generateHlinkFile stores encrypted file with hash",
            "transmitBatch updates status to SUBMITTED on success",
            "transmitBatch retries with exponential backoff on failure",
            "transmitBatch sets ERROR after max retries",
            "previewNextBatch returns preview without assembly",
            "retryFailedBatch retransmits ERROR status batch"
          ]
        },
        {
          "id": "D04A-024",
          "description": "Service: assessment response ingestion (file parsing, claim matching, state transitions, payment reconciliation)",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts",
          "depends": ["D04A-010", "D04A-011"],
          "build": [
            "Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:",
            "",
            "- `ingestAssessmentFile(batchId: string)` — retrieve assessment file from H-Link (SFTP pull / API). Parse per H-Link response format. Match each record to submitted claims by submission reference. Process results.",
            "- `processAssessmentRecord(record: AssessmentRecord)` — for each record in the assessment file:",
            "  - Accepted: transition claim SUBMITTED → ASSESSED. Store assessed_fee. If assessed_fee === submitted_fee, clean acceptance.",
            "  - Rejected: transition claim SUBMITTED → REJECTED. Store assessment_explanatory_codes. Resolve codes to descriptions via Reference Data. Emit CLAIM_REJECTED notification.",
            "  - Adjusted: transition claim SUBMITTED → ASSESSED. Store assessed_fee (differs from submitted_fee). Flag for physician review. Emit notification.",
            "- `reconcilePayment(batchId: string)` — when payment confirmed (Friday deposit): transition ASSESSED claims to PAID. Update batch status to RECONCILED. Emit CLAIM_PAID notifications.",
            "- `getAssessmentResults(batchId: string, physicianId: string)` — return batch assessment results with per-claim status.",
            "- `listBatchesAwaitingResponse(physicianId: string)` — list SUBMITTED batches.",
            "",
            "**Explanatory code resolution:** Lookup each code in Reference Data to get human-readable description and corrective guidance. For common rejections, generate one-click corrective actions.",
            "",
            "**Unmatched records:** If an assessment record cannot be matched to a submitted claim, log as anomaly and alert for manual resolution."
          ],
          "frd": [
            "Domain 4.1 Section 7.1: Assessment file retrieval — SFTP pull or API per H-Link spec.",
            "Domain 4.1 Section 7.2: Ingestion workflow — parse, match, accepted/rejected/adjusted transitions, notifications, batch status update.",
            "Domain 4.1 Section 7.3: Explanatory codes — resolved via Reference Data, corrective guidance, one-click actions."
          ],
          "security": [
            "Assessment files retrieved via secure channel. Raw files retained encrypted for audit.",
            "Assessment files contain PHI — processed on Meritum infrastructure within Canadian data residency.",
            "Unmatched records logged for manual review — no silent data loss.",
            "Payment reconciliation is final — paid claims enter terminal state."
          ],
          "tests": [
            "ingestAssessmentFile parses assessment file correctly",
            "processAssessmentRecord transitions accepted claim to ASSESSED",
            "processAssessmentRecord stores assessed_fee on accepted claim",
            "processAssessmentRecord transitions rejected claim to REJECTED",
            "processAssessmentRecord stores explanatory codes on rejected claim",
            "processAssessmentRecord handles adjusted claim (different fee)",
            "processAssessmentRecord resolves explanatory codes via Reference Data",
            "ingestAssessmentFile handles unmatched records gracefully",
            "ingestAssessmentFile handles mixed results (accepted + rejected + adjusted)",
            "reconcilePayment transitions ASSESSED claims to PAID",
            "reconcilePayment updates batch status to RECONCILED",
            "getAssessmentResults returns per-claim results for physician",
            "listBatchesAwaitingResponse returns only SUBMITTED batches"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.1: AHCIP Claim Pathway — Middleware & Routes",
      "tasks": [
        {
          "id": "D04A-030",
          "description": "Routes: AHCIP batch management, assessment, fee calculation endpoints",
          "verify": "pnpm --filter api vitest run test/integration/ahcip/",
          "depends": ["D04A-020", "D04A-021", "D04A-022", "D04A-023", "D04A-024"],
          "build": [
            "Create `apps/api/src/domains/ahcip/ahcip.routes.ts` and `apps/api/src/domains/ahcip/ahcip.handlers.ts`.",
            "",
            "**Batch management (auth required, physician-scoped):**",
            "- GET /api/v1/ahcip/batches → listBatchesHandler (query: listBatchesSchema)",
            "- GET /api/v1/ahcip/batches/next → previewNextBatchHandler",
            "- GET /api/v1/ahcip/batches/:id → getBatchHandler (params: batchIdParamSchema)",
            "- POST /api/v1/ahcip/batches/:id/retry → retryBatchHandler (ERROR status only)",
            "",
            "**Assessment (auth required, physician-scoped):**",
            "- GET /api/v1/ahcip/assessments/:batch_id → getAssessmentResultsHandler (params: batchAssessmentParamSchema)",
            "- GET /api/v1/ahcip/assessments/pending → listPendingAssessmentsHandler",
            "",
            "**Fee calculation (auth required):**",
            "- POST /api/v1/ahcip/fee-calculate → feeCalculateHandler (body: feeCalculateSchema)",
            "- GET /api/v1/ahcip/claims/:id/fee-breakdown → feeBreakdownHandler (params: claimIdParamSchema)",
            "",
            "**Handlers are thin:** validate input via Zod schema on route, call service function, format response.",
            "",
            "Create `apps/api/test/integration/ahcip/batches.integration.ts`, `assessment.integration.ts`, and `fee.integration.ts`."
          ],
          "security": [
            "All endpoints require authentication and are physician-scoped.",
            "Batch retry only from ERROR status — prevent duplicate submissions.",
            "Fee calculation preview does not save data — safe for estimation.",
            "Assessment results contain PHI — scoped to physician."
          ],
          "tests": [
            "GET /ahcip/batches lists physician's batches",
            "GET /ahcip/batches/next previews next Thursday batch",
            "GET /ahcip/batches/:id returns batch details",
            "GET /ahcip/batches/:id returns 404 for different physician",
            "POST /ahcip/batches/:id/retry retries ERROR batch",
            "POST /ahcip/batches/:id/retry rejects non-ERROR batch",
            "GET /ahcip/assessments/:batch_id returns assessment results",
            "GET /ahcip/assessments/pending returns SUBMITTED batches",
            "POST /ahcip/fee-calculate returns fee preview",
            "GET /ahcip/claims/:id/fee-breakdown returns itemised breakdown"
          ]
        },
        {
          "id": "D04A-031",
          "description": "Integration tests: AHCIP billing scenarios end-to-end",
          "verify": "pnpm --filter api vitest run test/integration/ahcip/",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/integration/ahcip/billing-scenarios.integration.ts`.",
            "",
            "**End-to-end billing scenarios (each is a full lifecycle: create → validate → queue → batch → assess → paid):**",
            "",
            "1. FFS clinic visit with CMGP + after-hours + RRNP premium",
            "2. Shadow billing (ARP with TM modifier) — fee = $0, claim recorded, tracked",
            "3. PCPCM hybrid dual-BA — in-basket code → PCPCM BA batch, out-of-basket → FFS BA batch",
            "4. ED shift with surcharge (13.99H) + after-hours (AFHR) + CMGP",
            "5. Hospital inpatient with GR 3 visit limits — test limit exceeded rejection",
            "6. Specialist consultation with GR 8 referral — test missing referral rejection",
            "7. Virtual care visit — correct encounter_type and modifiers",
            "8. Rejected claim → correct → resubmit → paid lifecycle",
            "",
            "**Batch cycle tests:**",
            "- Claims queued before Thursday cutoff included in batch",
            "- Claims queued after cutoff held until next Thursday",
            "- PCPCM physician gets two separate batches (FFS BA + PCPCM BA)",
            "- Pre-submission validation removes invalid claims from batch",
            "",
            "**Assessment ingestion:**",
            "- Mixed results batch: some accepted, some rejected, some adjusted",
            "- Explanatory codes resolved to descriptions",
            "- Payment reconciliation transitions to PAID"
          ],
          "frd": [
            "Domain 4.1 Section 10.5: 13 billing scenario tests — FFS, shadow billing, PCPCM, ED shift, hospital, specialist, obstetric, virtual, reciprocal, locum, radiologist, rejection, deadline."
          ],
          "tests": [
            "Scenario: FFS clinic visit with CMGP + after-hours + RRNP",
            "Scenario: Shadow billing produces $0 fee",
            "Scenario: PCPCM dual-BA creates two batches",
            "Scenario: ED shift with surcharge + after-hours",
            "Scenario: GR 3 visit limit rejection",
            "Scenario: GR 8 missing referral rejection",
            "Scenario: Virtual care visit",
            "Scenario: Rejected → correct → resubmit → paid",
            "Batch: cutoff enforcement",
            "Batch: pre-submission validation removes invalid",
            "Assessment: mixed results processing",
            "Assessment: payment reconciliation"
          ]
        },
        {
          "id": "D04A-032",
          "description": "Integration tests: validation pipeline, fee calculation, and H-Link file generation",
          "verify": "pnpm --filter api vitest run test/integration/ahcip/",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/integration/ahcip/validation.integration.ts`, `fee-calculation.integration.ts`, `hlink-file.integration.ts`.",
            "",
            "**Validation pipeline tests:**",
            "- Each AHCIP check A1–A19 with positive and negative cases",
            "- GR 3 visit limit: boundary cases (at limit, over limit)",
            "- GR 8 referral: present vs missing",
            "- Modifier eligibility: valid and invalid for representative codes",
            "- Modifier combinations: valid pairs and mutually exclusive pairs",
            "- 90-day window: exactly 90 days, 91 days, DST transition dates",
            "- PCPCM routing: in-basket and out-of-basket codes",
            "- After-hours: standard, evening, weekend, stat holiday, DST transition",
            "",
            "**Fee calculation tests:**",
            "- Base fee from SOMB for representative HSC codes",
            "- Each modifier type's fee impact (TM=$0, AFHR=premium, CMGP=premium)",
            "- RRNP premium for qualifying vs non-qualifying community",
            "- PCPCM in-basket vs out-of-basket fee handling",
            "- Shadow billing: TM produces $0 total",
            "- Bundling discount per governing rules",
            "",
            "**H-Link file generation tests:**",
            "- File header: correct submitter prefix, date, count, vendor ID",
            "- File trailer: record count matches header, total value checksum correct",
            "- Claim records ordered by DOS ascending",
            "- Special character handling in patient names",
            "- Empty optional fields correctly handled"
          ],
          "frd": [
            "Domain 4.1 Section 10.1: Validation tests — each A1–A19 check, governing rules, modifiers, 90-day window, PCPCM, after-hours, DI surcharge.",
            "Domain 4.1 Section 10.2: Fee calculation tests — base fee, modifier impacts, RRNP, PCPCM, shadow billing, bundling.",
            "Domain 4.1 Section 10.3: H-Link file tests — format, header/trailer, field positioning, special chars, empty fields."
          ],
          "tests": [
            "Validation: A1–A19 positive and negative cases",
            "Validation: GR 3 visit limit boundary",
            "Validation: modifier combination validity",
            "Validation: 90-day window boundary including DST",
            "Fee: base fee from SOMB schedule",
            "Fee: modifier adjustments applied in order",
            "Fee: RRNP premium added for qualifying community",
            "Fee: shadow billing produces $0",
            "Fee: PCPCM routing fee handling",
            "H-Link: header structure correct",
            "H-Link: trailer checksum correct",
            "H-Link: claim ordering by DOS"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.1: AHCIP Claim Pathway — Security Tests",
      "tasks": [
        {
          "id": "D04A-040",
          "description": "Security: authentication enforcement on every AHCIP route",
          "verify": "pnpm --filter api vitest run test/security/ahcip/ahcip.authn.security.ts",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/security/ahcip/ahcip.authn.security.ts`.",
            "",
            "Test every authenticated AHCIP route returns 401 without a valid session cookie:",
            "",
            "- GET /api/v1/ahcip/batches",
            "- GET /api/v1/ahcip/batches/next",
            "- GET /api/v1/ahcip/batches/:id",
            "- POST /api/v1/ahcip/batches/:id/retry",
            "- GET /api/v1/ahcip/assessments/:batch_id",
            "- GET /api/v1/ahcip/assessments/pending",
            "- POST /api/v1/ahcip/fee-calculate",
            "- GET /api/v1/ahcip/claims/:id/fee-breakdown",
            "",
            "For each route: no cookie, expired cookie, tampered cookie → 401 with no data leakage."
          ],
          "security": [
            "401 responses must not contain any data beyond the error object.",
            "Tampered cookies rejected. Expired sessions return 401."
          ]
        },
        {
          "id": "D04A-041",
          "description": "Security: authorization and permission enforcement for AHCIP routes",
          "verify": "pnpm --filter api vitest run test/security/ahcip/ahcip.authz.security.ts",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/security/ahcip/ahcip.authz.security.ts`.",
            "",
            "**Delegate permission tests:**",
            "- Delegate with CLAIM_VIEW can GET /ahcip/batches → 200",
            "- Delegate with CLAIM_VIEW can GET /ahcip/batches/:id → 200",
            "- Delegate without BATCH_VIEW cannot GET /ahcip/batches → 403",
            "- Delegate without BATCH_APPROVE cannot POST /ahcip/batches/:id/retry → 403",
            "- Delegate with CLAIM_VIEW can GET /ahcip/assessments/:batch_id → 200",
            "- Delegate with CLAIM_CREATE can POST /ahcip/fee-calculate → 200",
            "",
            "**Role enforcement:**",
            "- Physician can access all AHCIP routes",
            "- Admin cannot view AHCIP batch details without explicit PHI access"
          ]
        },
        {
          "id": "D04A-042",
          "description": "Security: physician tenant isolation for AHCIP data (MOST CRITICAL)",
          "verify": "pnpm --filter api vitest run test/security/ahcip/ahcip.scoping.security.ts",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/security/ahcip/ahcip.scoping.security.ts`.",
            "",
            "Create two physician accounts (physician1, physician2) using createSecurityPair fixture. Each creates AHCIP claims and batches.",
            "",
            "**AHCIP claim detail isolation:**",
            "- Physician1 cannot view physician2's AHCIP claim details → 404",
            "- Physician1 cannot view physician2's fee breakdown → 404",
            "",
            "**Batch isolation:**",
            "- Physician1 cannot see physician2's batches via GET /ahcip/batches → empty",
            "- Physician1 cannot view physician2's batch details → 404",
            "- Physician1 cannot retry physician2's failed batch → 404",
            "",
            "**Assessment isolation:**",
            "- Physician1 cannot view physician2's assessment results → 404",
            "- Physician1's pending assessments query never returns physician2's batches",
            "",
            "**Next batch preview isolation:**",
            "- Physician1's next batch preview contains only physician1's queued claims",
            "",
            "**IMPORTANT:** All cross-physician access returns 404, not 403."
          ]
        },
        {
          "id": "D04A-043",
          "description": "Security: input validation and injection prevention for AHCIP endpoints",
          "verify": "pnpm --filter api vitest run test/security/ahcip/ahcip.input.security.ts",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/security/ahcip/ahcip.input.security.ts`.",
            "",
            "**SQL injection payloads:**",
            "- health_service_code: `' OR 1=1--`, `03.03A'; DROP TABLE ahcip_claim_details;--`",
            "- ba_number: SQL injection payloads",
            "- diagnostic_code: SQL injection payloads",
            "- referral_practitioner: SQL injection payloads",
            "- functional_centre: SQL injection payloads",
            "",
            "**XSS payloads:**",
            "- health_service_code: `<script>alert(1)</script>`",
            "- facility_number: `<img onerror=alert(1) src=x>`",
            "",
            "**Type coercion:**",
            "- calls as string where number expected → 400",
            "- calls as negative number → 400",
            "- calls as 0 → 400",
            "- time_spent as negative → 400",
            "- modifier fields exceeding max length → 400",
            "",
            "**UUID validation:**",
            "- Non-UUID in batch_id path param → 400",
            "- Non-UUID in claim_id for fee breakdown → 400",
            "",
            "**Enum validation:**",
            "- Invalid encounter_type → 400",
            "- Invalid batch status filter → 400"
          ]
        },
        {
          "id": "D04A-044",
          "description": "Security: data leakage prevention for AHCIP (PHI in claims, files, assessments)",
          "verify": "pnpm --filter api vitest run test/security/ahcip/ahcip.leakage.security.ts",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/security/ahcip/ahcip.leakage.security.ts`.",
            "",
            "**PHI not in error responses:**",
            "- Validation errors do not expose patient PHN or DOB",
            "- 404 for cross-physician AHCIP claim does not confirm existence",
            "- Fee calculation errors do not leak internal SOMB data structure",
            "- 500 errors expose no internals",
            "",
            "**H-Link file security:**",
            "- Generated H-Link files not accessible via direct URL",
            "- file_path not exposed in batch API responses",
            "- H-Link submission_reference not exposed in client-facing API (internal tracking only)",
            "",
            "**Assessment data:**",
            "- Assessment results scoped to physician — no cross-physician leakage",
            "- Explanatory codes resolved to descriptions — raw AHCIP response codes not leaked",
            "",
            "**Header checks:**",
            "- No X-Powered-By, no Server version",
            "- HSTS and CSP headers present",
            "",
            "**H-Link credentials:**",
            "- Submitter prefix and transmission credentials never in API responses",
            "- Credentials never in logs or error messages"
          ]
        },
        {
          "id": "D04A-045",
          "description": "Security: audit trail completeness for AHCIP batch lifecycle",
          "verify": "pnpm --filter api vitest run test/security/ahcip/ahcip.audit.security.ts",
          "depends": ["D04A-030"],
          "build": [
            "Create `apps/api/test/security/ahcip/ahcip.audit.security.ts`.",
            "",
            "Verify every significant AHCIP action produces audit records.",
            "",
            "**Batch lifecycle audit:**",
            "- Batch assembled → audit entry with claim count and total value",
            "- Batch generated (H-Link file) → audit entry with file_hash",
            "- Batch submitted (transmitted) → audit entry with submission_reference and timestamp",
            "- Batch transmission failed → audit entry with error details",
            "- Batch retry initiated → audit entry",
            "- Assessment ingested → audit entry with accepted/rejected/adjusted counts",
            "- Payment reconciled → audit entry with batch total",
            "",
            "**Claim-level audit (via Domain 4.0 claim_audit_history):**",
            "- AHCIP claim created → CREATED with claim_type = AHCIP",
            "- AHCIP detail updated → EDITED with field-level changes",
            "- Fee calculated → audit entry with fee breakdown",
            "- Assessment result applied → ASSESSED/REJECTED with details",
            "",
            "**Submission preference audit:**",
            "- Auto-submission mode change → audit entry with old and new mode",
            "",
            "**Audit log integrity:**",
            "- No UPDATE/DELETE operations on audit entries",
            "- H-Link transmission logs contain no PHI (no patient data, only batch references)"
          ]
        }
      ]
    },
    {
      "title": "Domain 4.1: AHCIP Claim Pathway — Final Validation",
      "tasks": [
        {
          "id": "D04A-099",
          "description": "Full domain test suite: all unit + integration + security tests",
          "verify": "pnpm --filter api vitest run src/domains/ahcip/ test/integration/ahcip/ test/security/ahcip/",
          "depends": ["D04A-040", "D04A-041", "D04A-042", "D04A-043", "D04A-044", "D04A-045"],
          "build": [
            "Run the complete test suite for Domain 4.1 AHCIP Claim Pathway. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/ahcip/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/ahcip/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/ahcip/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/ahcip/ test/integration/ahcip/ test/security/ahcip/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/ahcip/ahcip.authn.security.ts",
            "- test/security/ahcip/ahcip.authz.security.ts",
            "- test/security/ahcip/ahcip.scoping.security.ts",
            "- test/security/ahcip/ahcip.input.security.ts",
            "- test/security/ahcip/ahcip.leakage.security.ts",
            "- test/security/ahcip/ahcip.audit.security.ts"
          ]
        }
      ]
    }
  ]
}
