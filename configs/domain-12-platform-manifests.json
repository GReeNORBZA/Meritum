{
  "domainNumber": "12",
  "domainName": "Platform Operations",
  "manifestFile": "domain-12-platform.tasks",
  "promptPrefix": "d12",
  "modulePath": "apps/api/src/domains/platform",
  "sections": [
    {
      "title": "Domain 12: Platform Operations — Shared Types & Constants",
      "tasks": [
        {
          "id": "D12-001",
          "description": "Subscription constants, plan enums, dunning step definitions, webhook event types",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/platform.constants.ts` with all Platform Operations constants:",
            "",
            "**Subscription plans enum:**",
            "- STANDARD_MONTHLY ($279/month)",
            "- STANDARD_ANNUAL ($2,790/year)",
            "- EARLY_BIRD_MONTHLY ($199/month, first 100 physicians, first 12 months)",
            "",
            "**Subscription statuses enum:**",
            "- TRIAL, ACTIVE, PAST_DUE, SUSPENDED, CANCELLED",
            "",
            "**Payment statuses enum:**",
            "- PAID, FAILED, REFUNDED",
            "",
            "**Dunning steps (5 steps):**",
            "- STEP_1: Day 0 — payment failed notification, Stripe auto-retry in 3 days",
            "- STEP_2: Day 3 — second notification if retry fails",
            "- STEP_3: Day 7 — warning: suspension in 7 days",
            "- STEP_4: Day 14 — account SUSPENDED, submission blocked, read-only access",
            "- STEP_5: Day 30 — subscription cancelled, 30-day deletion grace period",
            "",
            "**Stripe webhook events enum:**",
            "- INVOICE_PAID, INVOICE_PAYMENT_FAILED, INVOICE_CREATED",
            "- SUBSCRIPTION_UPDATED, SUBSCRIPTION_DELETED",
            "- CHECKOUT_SESSION_COMPLETED",
            "",
            "**Feature access matrix (frozen object):**",
            "Map each subscription status to allowed features:",
            "- ACTIVE: all features",
            "- PAST_DUE: all features (full access during grace)",
            "- SUSPENDED: no claim_create, no batch_submit, no ai_coach, dashboards read-only, settings payment-only",
            "- CANCELLED: no access except data export for 30 days",
            "",
            "**Incident statuses enum:**",
            "- INVESTIGATING, IDENTIFIED, MONITORING, RESOLVED",
            "",
            "**Status component names:**",
            "- WEB_APP, API, HLINK_SUBMISSION, WCB_SUBMISSION, AI_COACH, EMAIL_DELIVERY, DATABASE, PAYMENT_PROCESSING",
            "",
            "**Component health statuses:**",
            "- OPERATIONAL, DEGRADED, PARTIAL_OUTAGE, MAJOR_OUTAGE, MAINTENANCE",
            "",
            "**GST rate:** 0.05 (5%)",
            "**Early bird cap:** 100 physicians",
            "**Deletion grace period:** 30 days",
            "**Dunning suspension day:** 14",
            "**Dunning cancellation day:** 30",
            "",
            "Export all as frozen objects / TypeScript enums."
          ],
          "frd": [
            "Domain 12 Section 2.1: Three pricing tiers — standard monthly ($279), standard annual ($2,790), early bird monthly ($199 for first 100 physicians). All CAD, GST-exclusive.",
            "Domain 12 Section 2.4: Six Stripe webhook events. Domain 12 Section 2.5: Five dunning steps over 30 days.",
            "Domain 12 Section 3.1: Five subscription states (TRIAL, ACTIVE, PAST_DUE, SUSPENDED, CANCELLED). Domain 12 Section 3.2: Feature access matrix per status.",
            "Domain 12 Section 5.1: Eight monitored components. Section 5.2: Four incident states."
          ]
        },
        {
          "id": "D12-002",
          "description": "Drizzle schema for subscriptions table",
          "verify": "pnpm --filter shared build",
          "depends": ["D12-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/platform.schema.ts` starting with the subscriptions table.",
            "",
            "**subscriptions table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| subscription_id | UUID | PK | Default: gen_random_uuid() |",
            "| provider_id | UUID FK | NOT NULL, UNIQUE, FK → users | One subscription per physician |",
            "| stripe_customer_id | VARCHAR(50) | NOT NULL | Stripe customer reference |",
            "| stripe_subscription_id | VARCHAR(50) | NOT NULL | Stripe subscription reference |",
            "| plan | VARCHAR(30) | NOT NULL | STANDARD_MONTHLY, STANDARD_ANNUAL, EARLY_BIRD_MONTHLY |",
            "| status | VARCHAR(20) | NOT NULL, DEFAULT 'trial' | TRIAL, ACTIVE, PAST_DUE, SUSPENDED, CANCELLED |",
            "| current_period_start | TIMESTAMPTZ | NOT NULL | Current billing period start |",
            "| current_period_end | TIMESTAMPTZ | NOT NULL | Current billing period end |",
            "| trial_end | TIMESTAMPTZ | NULLABLE | Trial period end if applicable |",
            "| failed_payment_count | INTEGER | NOT NULL, DEFAULT 0 | Consecutive failures, reset on success |",
            "| suspended_at | TIMESTAMPTZ | NULLABLE | When account was suspended |",
            "| cancelled_at | TIMESTAMPTZ | NULLABLE | When subscription was cancelled |",
            "| deletion_scheduled_at | TIMESTAMPTZ | NULLABLE | 30 days after cancellation |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Indexes:** unique on provider_id, index on stripe_customer_id, index on stripe_subscription_id, index on status, index on deletion_scheduled_at (for cleanup job).",
            "",
            "Export the table and inferred types (InsertSubscription, SelectSubscription)."
          ],
          "security": [
            "Stripe IDs (customer_id, subscription_id) are references only — no payment card data stored in Meritum.",
            "provider_id is UNIQUE — each physician has exactly one subscription record.",
            "No PHI is stored in the subscriptions table. This table contains only billing metadata."
          ],
          "frd": [
            "Domain 12 Section 8.1: Subscriptions table with 14 columns. One-to-one with provider."
          ]
        },
        {
          "id": "D12-003",
          "description": "Drizzle schema for payment_history, status_components, status_incidents, incident_updates tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D12-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/platform.schema.ts`:",
            "",
            "**payment_history table:**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| payment_id | UUID | PK |",
            "| subscription_id | UUID FK | NOT NULL, FK → subscriptions |",
            "| stripe_invoice_id | VARCHAR(50) | NOT NULL |",
            "| amount_cad | DECIMAL(10,2) | NOT NULL (pre-GST amount) |",
            "| gst_amount | DECIMAL(10,2) | NOT NULL (5% of amount_cad) |",
            "| total_cad | DECIMAL(10,2) | NOT NULL (amount_cad + gst_amount) |",
            "| status | VARCHAR(20) | NOT NULL (PAID, FAILED, REFUNDED) |",
            "| paid_at | TIMESTAMPTZ | NULLABLE |",
            "| created_at | TIMESTAMPTZ | NOT NULL |",
            "",
            "Index: (subscription_id, created_at DESC), index on stripe_invoice_id.",
            "",
            "**status_components table:**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| component_id | UUID | PK |",
            "| name | VARCHAR(50) | NOT NULL, UNIQUE |",
            "| display_name | VARCHAR(100) | NOT NULL |",
            "| status | VARCHAR(20) | NOT NULL, DEFAULT 'operational' |",
            "| description | TEXT | NULLABLE |",
            "| sort_order | INTEGER | NOT NULL, DEFAULT 0 |",
            "| updated_at | TIMESTAMPTZ | NOT NULL |",
            "",
            "**status_incidents table:**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| incident_id | UUID | PK |",
            "| title | VARCHAR(200) | NOT NULL |",
            "| status | VARCHAR(20) | NOT NULL (investigating, identified, monitoring, resolved) |",
            "| severity | VARCHAR(20) | NOT NULL (minor, major, critical) |",
            "| affected_components | JSONB | NOT NULL (array of component_ids) |",
            "| resolved_at | TIMESTAMPTZ | NULLABLE |",
            "| created_at | TIMESTAMPTZ | NOT NULL |",
            "| updated_at | TIMESTAMPTZ | NOT NULL |",
            "",
            "Index: (status, created_at DESC), (created_at DESC).",
            "",
            "**incident_updates table:**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| update_id | UUID | PK |",
            "| incident_id | UUID FK | NOT NULL, FK → status_incidents |",
            "| status | VARCHAR(20) | NOT NULL |",
            "| message | TEXT | NOT NULL |",
            "| created_at | TIMESTAMPTZ | NOT NULL |",
            "",
            "Index: (incident_id, created_at DESC).",
            "",
            "Export all tables and inferred types."
          ],
          "frd": [
            "Domain 12 Section 8.2: Payment history table with 9 columns. GST is 5% of base amount.",
            "Domain 12 Section 5: Status page at status.meritum.ca. Eight monitored components. Incident states: Investigating, Identified, Monitoring, Resolved."
          ]
        },
        {
          "id": "D12-004",
          "description": "Drizzle schema for referral_codes and referral_redemptions tables (MVP accommodation)",
          "verify": "pnpm --filter shared build",
          "depends": ["D12-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/platform.schema.ts`:",
            "",
            "**referral_codes table (MVP accommodation — schema defined, not actively used):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| referral_code_id | UUID | PK |",
            "| physician_user_id | UUID FK | NOT NULL, FK → users |",
            "| code | VARCHAR(20) | NOT NULL, UNIQUE |",
            "| redemption_count | INTEGER | NOT NULL, DEFAULT 0 |",
            "| max_redemptions | INTEGER | NOT NULL, DEFAULT 10 |",
            "| is_active | BOOLEAN | NOT NULL, DEFAULT false (disabled at MVP) |",
            "| created_at | TIMESTAMPTZ | NOT NULL |",
            "",
            "**referral_redemptions table (MVP accommodation):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| redemption_id | UUID | PK |",
            "| referral_code_id | UUID FK | NOT NULL, FK → referral_codes |",
            "| referred_user_id | UUID FK | NOT NULL, FK → users |",
            "| credit_amount_cad | DECIMAL(10,2) | NOT NULL, DEFAULT 50.00 |",
            "| credit_applied | BOOLEAN | NOT NULL, DEFAULT false |",
            "| created_at | TIMESTAMPTZ | NOT NULL |",
            "",
            "These tables are created in migration but not populated at MVP. The referral program activates post-PMF.",
            "",
            "Export all tables and inferred types."
          ],
          "frd": [
            "Domain 12 Section 7: Referral program post-PMF. $50 credit per referral. Max 10 per physician per year ($500/year cap). MVP: schema defined, code field hidden/disabled."
          ]
        },
        {
          "id": "D12-005",
          "description": "Zod validation schemas for subscription, billing, and status page endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D12-001"],
          "build": [
            "Create `packages/shared/src/schemas/platform.schema.ts` with Zod schemas:",
            "",
            "**Subscription:**",
            "- createCheckoutSessionSchema: { plan: enum('STANDARD_MONTHLY', 'STANDARD_ANNUAL', 'EARLY_BIRD_MONTHLY'), success_url: string().url(), cancel_url: string().url() }",
            "- createPortalSessionSchema: { return_url: string().url() }",
            "",
            "**Webhook:**",
            "- stripeWebhookHeaderSchema: { 'stripe-signature': string() }",
            "",
            "**Status page (public):**",
            "- statusPageQuerySchema: no required fields (returns all components + active incidents)",
            "- incidentHistoryQuerySchema: { page: number().int().min(1).default(1), page_size: number().int().min(1).max(50).default(20) }",
            "",
            "**Admin — incident management:**",
            "- createIncidentSchema: { title: string().min(1).max(200), severity: enum('minor', 'major', 'critical'), affected_components: array(string().uuid()).min(1), message: string().min(1) }",
            "- updateIncidentSchema: { status: enum('investigating', 'identified', 'monitoring', 'resolved'), message: string().min(1) }",
            "- updateComponentStatusSchema: { status: enum('operational', 'degraded', 'partial_outage', 'major_outage', 'maintenance') }",
            "",
            "**Admin — subscription management:**",
            "- adminSubscriptionQuerySchema: { status: enum(SUBSCRIPTION_STATUSES).optional(), page: number().int().min(1).default(1), page_size: number().int().min(1).max(100).default(50) }",
            "",
            "Export all schemas and inferred TypeScript types."
          ],
          "frd": [
            "Domain 12 Section 2.6: Stripe Customer Portal for self-service billing. Section 5.2: Incident management with 4 states."
          ]
        },
        {
          "id": "D12-006",
          "description": "Generate and apply database migration for Platform Operations tables",
          "verify": "cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1",
          "depends": ["D12-002", "D12-003", "D12-004"],
          "build": [
            "Run the Drizzle migration generator for all Platform Operations tables:",
            "",
            "```bash",
            "cd apps/api",
            "pnpm drizzle-kit generate",
            "pnpm drizzle-kit migrate",
            "```",
            "",
            "Verify migration file created in `apps/api/drizzle/migrations/`.",
            "Verify all tables exist: subscriptions, payment_history, status_components, status_incidents, incident_updates, referral_codes, referral_redemptions.",
            "Verify all indexes and constraints applied.",
            "Verify provider_id UNIQUE constraint on subscriptions.",
            "Verify FK relationships are correct."
          ]
        }
      ]
    },
    {
      "title": "Domain 12: Platform Operations — Repository Layer",
      "tasks": [
        {
          "id": "D12-010",
          "description": "Repository: subscription CRUD operations",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-006"],
          "build": [
            "Create `apps/api/src/domains/platform/platform.repository.ts` with subscription operations:",
            "",
            "- `createSubscription(data: InsertSubscription)` — insert new subscription record.",
            "- `findSubscriptionByProviderId(providerId: string)` — find subscription for physician.",
            "- `findSubscriptionByStripeCustomerId(stripeCustomerId: string)` — find by Stripe reference (for webhook processing).",
            "- `findSubscriptionByStripeSubscriptionId(stripeSubId: string)` — find by Stripe subscription ID.",
            "- `updateSubscriptionStatus(subscriptionId: string, status: string, metadata?: { suspended_at?, cancelled_at?, deletion_scheduled_at? })` — update status with optional timestamps.",
            "- `updateSubscriptionPeriod(subscriptionId: string, periodStart: Date, periodEnd: Date)` — update billing period from webhook.",
            "- `updateSubscriptionPlan(subscriptionId: string, plan: string)` — update plan after portal change.",
            "- `incrementFailedPaymentCount(subscriptionId: string)` — increment failed_payment_count.",
            "- `resetFailedPaymentCount(subscriptionId: string)` — set to 0 on successful payment.",
            "- `findSubscriptionsDueForSuspension()` — find PAST_DUE subscriptions where failed_payment_count >= threshold and first failure was 14+ days ago.",
            "- `findSubscriptionsDueForCancellation()` — find SUSPENDED subscriptions suspended 16+ days ago (30 total from first failure).",
            "- `findSubscriptionsDueForDeletion()` — find CANCELLED subscriptions where deletion_scheduled_at <= now().",
            "- `countEarlyBirdSubscriptions()` — count subscriptions with plan = EARLY_BIRD_MONTHLY for cap enforcement.",
            "",
            "Create `apps/api/src/domains/platform/platform.test.ts` with unit tests for each function."
          ],
          "security": [
            "findSubscriptionByProviderId only returns the subscription for the specified provider — physician-scoped.",
            "Webhook-facing queries (by Stripe IDs) are used only by the webhook handler, never exposed to user-facing routes.",
            "countEarlyBirdSubscriptions must be accurate for the 100-physician cap (race condition: use SELECT FOR UPDATE or similar)."
          ],
          "tests": [
            "createSubscription inserts record with correct defaults",
            "findSubscriptionByProviderId returns correct subscription",
            "findSubscriptionByProviderId returns null for non-existent provider",
            "findSubscriptionByStripeCustomerId returns correct subscription",
            "updateSubscriptionStatus updates status and timestamps",
            "incrementFailedPaymentCount increments correctly",
            "resetFailedPaymentCount resets to 0",
            "findSubscriptionsDueForSuspension returns overdue subscriptions",
            "findSubscriptionsDueForCancellation returns long-suspended subscriptions",
            "findSubscriptionsDueForDeletion returns expired-grace subscriptions",
            "countEarlyBirdSubscriptions returns accurate count"
          ]
        },
        {
          "id": "D12-011",
          "description": "Repository: payment history",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-006"],
          "build": [
            "Add to `apps/api/src/domains/platform/platform.repository.ts` — payment history operations:",
            "",
            "- `recordPayment(data: InsertPayment)` — insert payment record.",
            "- `findPaymentByStripeInvoiceId(stripeInvoiceId: string)` — find payment by Stripe invoice reference (idempotency check for webhooks).",
            "- `listPaymentsForSubscription(subscriptionId: string, pagination: { page, pageSize })` — paginated payment history, reverse chronological.",
            "- `updatePaymentStatus(paymentId: string, status: string, paidAt?: Date)` — update payment status (e.g., FAILED → PAID on retry success).",
            "- `getPaymentSummary(subscriptionId: string)` — aggregate: total paid, total GST, payment count, last payment date."
          ],
          "security": [
            "listPaymentsForSubscription scopes to the subscription — no cross-user payment leakage.",
            "findPaymentByStripeInvoiceId is used for webhook idempotency — prevents duplicate payment records.",
            "No card numbers or payment method details stored. Only Stripe invoice reference."
          ],
          "tests": [
            "recordPayment inserts payment with GST calculation",
            "findPaymentByStripeInvoiceId returns correct payment",
            "findPaymentByStripeInvoiceId returns null for unknown invoice",
            "listPaymentsForSubscription returns paginated results",
            "listPaymentsForSubscription returns reverse chronological",
            "updatePaymentStatus updates status and paid_at",
            "getPaymentSummary returns correct aggregates"
          ]
        },
        {
          "id": "D12-012",
          "description": "Repository: status page components and incidents",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-006"],
          "build": [
            "Add to `apps/api/src/domains/platform/platform.repository.ts`:",
            "",
            "**Status components:**",
            "- `listComponents()` — return all components ordered by sort_order.",
            "- `updateComponentStatus(componentId: string, status: string)` — update component health status.",
            "- `seedComponents(components: Array<{ name, displayName, sortOrder }>)` — idempotent seed for the 8 monitored components.",
            "",
            "**Incidents:**",
            "- `createIncident(data: { title, severity, affectedComponents, initialMessage })` — create incident + first update entry.",
            "- `updateIncident(incidentId: string, status: string, message: string)` — add update to incident, change incident status. Set resolved_at if status is 'resolved'.",
            "- `listActiveIncidents()` — return non-resolved incidents with their updates, ordered by created_at DESC.",
            "- `listIncidentHistory(pagination: { page, pageSize })` — all incidents (including resolved) paginated.",
            "- `findIncidentById(incidentId: string)` — single incident with all updates."
          ],
          "tests": [
            "listComponents returns all components in sort order",
            "updateComponentStatus changes status",
            "seedComponents is idempotent (running twice creates no duplicates)",
            "createIncident creates incident with first update",
            "updateIncident adds update and changes status",
            "updateIncident sets resolved_at when resolving",
            "listActiveIncidents excludes resolved incidents",
            "listIncidentHistory includes all incidents paginated",
            "findIncidentById returns incident with all updates"
          ]
        }
      ]
    },
    {
      "title": "Domain 12: Platform Operations — Service Layer",
      "tasks": [
        {
          "id": "D12-020",
          "description": "Service: Stripe Checkout session creation and subscription provisioning",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-010"],
          "build": [
            "Create `apps/api/src/domains/platform/platform.service.ts` with Stripe Checkout functions:",
            "",
            "- `createCheckoutSession(userId: string, plan: string, successUrl: string, cancelUrl: string)` —",
            "  1. Check if user already has active subscription → error if so.",
            "  2. If plan is EARLY_BIRD_MONTHLY: check countEarlyBirdSubscriptions() < 100. If at cap, reject with EARLY_BIRD_SOLD_OUT.",
            "  3. Create or retrieve Stripe Customer (stripe.customers.create with email, name from user).",
            "  4. Create Stripe Checkout Session with: mode 'subscription', correct Price ID for plan, GST as tax rate (5%), success/cancel URLs.",
            "  5. Return { checkout_url: session.url }.",
            "",
            "- `createPortalSession(userId: string, returnUrl: string)` —",
            "  1. Find subscription for userId.",
            "  2. Create Stripe Billing Portal session with stripe_customer_id and return_url.",
            "  3. Return { portal_url: session.url }.",
            "",
            "**Stripe SDK:** Use `stripe` npm package. API key from environment variable STRIPE_SECRET_KEY.",
            "**Price IDs:** From environment variables: STRIPE_PRICE_STANDARD_MONTHLY, STRIPE_PRICE_STANDARD_ANNUAL, STRIPE_PRICE_EARLY_BIRD_MONTHLY.",
            "**Tax:** Use Stripe Tax Rate object (5% GST, inclusive=false) or manual tax line item."
          ],
          "security": [
            "Stripe secret key stored in environment variable, never in code or logs.",
            "No PHI sent to Stripe. Only physician name and email.",
            "Early bird cap enforced server-side. Race condition: use transaction or SELECT FOR UPDATE when checking count.",
            "Checkout session URL is single-use and time-limited (Stripe manages this)."
          ],
          "tests": [
            "createCheckoutSession returns checkout URL for valid plan",
            "createCheckoutSession rejects if active subscription exists",
            "createCheckoutSession rejects EARLY_BIRD_MONTHLY when cap reached",
            "createCheckoutSession creates Stripe customer with correct email",
            "createPortalSession returns portal URL for active subscriber",
            "createPortalSession rejects if no subscription found"
          ]
        },
        {
          "id": "D12-021",
          "description": "Service: Stripe webhook event processing",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-010", "D12-011"],
          "build": [
            "Add to `apps/api/src/domains/platform/platform.service.ts`:",
            "",
            "- `processWebhookEvent(rawBody: string, signature: string)` —",
            "  1. Verify webhook signature using STRIPE_WEBHOOK_SECRET. Reject if invalid.",
            "  2. Parse event. Dispatch to handler by event type.",
            "",
            "- `handleCheckoutCompleted(event)` —",
            "  Link Stripe customer_id and subscription_id to Meritum user. Create subscription record with status ACTIVE. Record initial payment. Emit SUBSCRIPTION_CREATED event for notification service.",
            "",
            "- `handleInvoicePaid(event)` —",
            "  Record payment in payment_history (idempotent: check stripe_invoice_id). Reset failed_payment_count. If status was PAST_DUE: update to ACTIVE. Clear any dunning state. Emit PAYMENT_SUCCEEDED event.",
            "",
            "- `handleInvoicePaymentFailed(event)` —",
            "  Increment failed_payment_count. Record failed payment. Emit PAYMENT_FAILED notification event. If count hits dunning thresholds, escalate (handled by dunning service).",
            "",
            "- `handleInvoiceCreated(event)` —",
            "  Verify GST line item present. If missing, add via Stripe API (stripe.invoiceItems.create with tax).",
            "",
            "- `handleSubscriptionUpdated(event)` —",
            "  Sync status, plan, billing period from Stripe. Update local record.",
            "",
            "- `handleSubscriptionDeleted(event)` —",
            "  Set status to CANCELLED. Set cancelled_at = now(). Set deletion_scheduled_at = now() + 30 days. Emit SUBSCRIPTION_CANCELLED event.",
            "",
            "**CRITICAL:** All webhook handlers must be idempotent. Stripe may deliver the same event multiple times."
          ],
          "security": [
            "Webhook signature verification is mandatory. Reject unsigned or tampered payloads with 400.",
            "STRIPE_WEBHOOK_SECRET stored in environment variable.",
            "Idempotency: check if event has already been processed (by stripe_invoice_id or event ID). Skip if duplicate.",
            "Webhook endpoint is unauthenticated (Stripe calls it directly) but signature-verified."
          ],
          "tests": [
            "processWebhookEvent rejects invalid signature",
            "processWebhookEvent rejects missing signature",
            "handleCheckoutCompleted creates subscription record",
            "handleCheckoutCompleted links Stripe IDs to user",
            "handleInvoicePaid records payment and clears past_due",
            "handleInvoicePaid is idempotent (duplicate invoice_id ignored)",
            "handleInvoicePaymentFailed increments failure count",
            "handleInvoicePaymentFailed emits notification event",
            "handleSubscriptionUpdated syncs status and period",
            "handleSubscriptionDeleted sets cancelled status and schedules deletion",
            "handleInvoiceCreated verifies GST presence"
          ]
        },
        {
          "id": "D12-022",
          "description": "Service: dunning sequence and subscription lifecycle jobs",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-010", "D12-021"],
          "build": [
            "Add to `apps/api/src/domains/platform/platform.service.ts`:",
            "",
            "- `runDunningCheck()` — scheduled job (daily) that processes the dunning sequence:",
            "  1. Find PAST_DUE subscriptions with failed_payment_count > 0.",
            "  2. For each, calculate days since first failure.",
            "  3. Day 3: emit PAYMENT_RETRY_FAILED notification if Stripe retry also failed.",
            "  4. Day 7: emit PAYMENT_SUSPENSION_WARNING notification.",
            "  5. Day 14: update status to SUSPENDED. Set suspended_at. Emit ACCOUNT_SUSPENDED notification. Update user.subscription_status to 'suspended'.",
            "  6. Log each dunning action to audit trail.",
            "",
            "- `runCancellationCheck()` — scheduled job (daily):",
            "  1. Find SUSPENDED subscriptions where suspended_at + 16 days <= now() (30 total from first failure).",
            "  2. Cancel Stripe subscription via API.",
            "  3. Update status to CANCELLED. Set cancelled_at, deletion_scheduled_at = now() + 30 days.",
            "  4. Emit SUBSCRIPTION_CANCELLED notification.",
            "",
            "- `runDeletionCheck()` — scheduled job (daily):",
            "  1. Find CANCELLED subscriptions where deletion_scheduled_at <= now().",
            "  2. Execute data deletion: remove all PHI (claims, patients, reports). Strip PII from audit logs (retain for 10 years). Delete Stripe customer data via API.",
            "  3. Deactivate user account. Emit ACCOUNT_DATA_DELETED event.",
            "",
            "- `getSubscriptionStatus(userId: string)` — return current subscription with access level for middleware use.",
            "",
            "**Data retention after deletion (per FRD):**",
            "- Claims, patients, provider profile: deleted",
            "- Audit logs: retained 10 years, PII stripped (provider_id hashed, PHN removed)",
            "- IMA records: retained 10 years",
            "- AI learning data: anonymised, retained for cohort aggregates",
            "- Stripe references: deleted"
          ],
          "security": [
            "Data deletion must be thorough: no PHI residue in any table. Use a deletion checklist.",
            "Audit logs retained for HIA compliance but PII-stripped (hash provider_id, remove patient PHN).",
            "IMA records retained as contractual evidence for 10 years.",
            "Scheduled jobs must be idempotent — safe to run multiple times.",
            "Stripe customer data deletion via API (remove payment methods, redact metadata)."
          ],
          "tests": [
            "runDunningCheck emits Day 7 warning for 7-day overdue",
            "runDunningCheck suspends account at Day 14",
            "runDunningCheck updates user.subscription_status on suspension",
            "runCancellationCheck cancels Stripe subscription at Day 30",
            "runCancellationCheck schedules deletion 30 days out",
            "runDeletionCheck deletes PHI data",
            "runDeletionCheck strips PII from audit logs",
            "runDeletionCheck retains IMA records",
            "runDeletionCheck deletes Stripe customer data",
            "getSubscriptionStatus returns correct access level per status",
            "All scheduled jobs are idempotent"
          ]
        },
        {
          "id": "D12-023",
          "description": "Service: status page and incident management",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-012"],
          "build": [
            "Add to `apps/api/src/domains/platform/platform.service.ts`:",
            "",
            "**Public status page:**",
            "- `getStatusPage()` — return all components with their current status + active incidents with latest update. No auth required.",
            "- `getIncidentHistory(page: number, pageSize: number)` — paginated incident history including resolved. No auth required.",
            "",
            "**Admin incident management:**",
            "- `createIncident(adminUserId: string, data: CreateIncidentInput)` — create incident, update affected component statuses, emit MAINTENANCE_SCHEDULED notification. Audit log: incident.created.",
            "- `updateIncident(adminUserId: string, incidentId: string, status: string, message: string)` — post update to incident. If resolving: set resolved_at, restore component statuses to operational. Emit incident update notification. Audit log: incident.updated.",
            "- `updateComponentStatus(adminUserId: string, componentId: string, status: string)` — manual component status override. Audit log: component.status_updated.",
            "",
            "**System health seed:**",
            "- `seedStatusComponents()` — idempotent seed of the 8 monitored components: Web Application, API, H-Link Submission, WCB Submission, AI Coach, Email Delivery, Database, Payment Processing."
          ],
          "tests": [
            "getStatusPage returns all components and active incidents",
            "getStatusPage excludes resolved incidents",
            "getIncidentHistory includes resolved incidents paginated",
            "createIncident creates incident and updates component statuses",
            "createIncident emits notification event",
            "updateIncident posts update to incident",
            "updateIncident restores components on resolution",
            "updateComponentStatus changes component health",
            "seedStatusComponents is idempotent"
          ]
        }
      ]
    },
    {
      "title": "Domain 12: Platform Operations — Middleware & Routes",
      "tasks": [
        {
          "id": "D12-030",
          "description": "Stripe webhook middleware and signature verification plugin",
          "verify": "pnpm --filter api vitest run src/domains/platform/platform.test.ts",
          "depends": ["D12-021"],
          "build": [
            "Create `apps/api/src/plugins/stripe-webhook.plugin.ts` as a Fastify plugin:",
            "",
            "**Raw body parsing:**",
            "The Stripe webhook endpoint needs the raw request body (not parsed JSON) for signature verification. Configure Fastify to preserve raw body for the webhook route.",
            "",
            "Options:",
            "- Use Fastify's `addContentTypeParser` to capture raw body for the webhook path",
            "- Or use `fastify-raw-body` plugin scoped to the webhook route",
            "",
            "**Signature verification middleware:**",
            "- Extract `stripe-signature` header",
            "- Call `stripe.webhooks.constructEvent(rawBody, signature, STRIPE_WEBHOOK_SECRET)`",
            "- If verification fails: return 400 with generic error (no details about what failed)",
            "- If verification succeeds: attach parsed event to request",
            "",
            "**Rate limiting:**",
            "- Stripe webhook endpoint: exempt from standard rate limiting (Stripe controls call frequency)",
            "- But add a reasonable ceiling (e.g., 100 req/min) to prevent abuse if endpoint is discovered"
          ],
          "security": [
            "Webhook signature verification is the ONLY authentication for this endpoint. It must never be bypassed.",
            "Raw body must be preserved exactly — any modification breaks signature verification.",
            "STRIPE_WEBHOOK_SECRET must be in environment variables, never hardcoded.",
            "Error responses on the webhook endpoint must be generic — do not reveal verification failure details."
          ],
          "tests": [
            "Webhook plugin preserves raw body for signature verification",
            "Valid signature passes verification",
            "Invalid signature returns 400",
            "Missing signature header returns 400",
            "Tampered body with valid header returns 400"
          ]
        },
        {
          "id": "D12-031",
          "description": "Routes: subscription and billing endpoints + integration tests",
          "verify": "pnpm --filter api vitest run test/integration/platform/",
          "depends": ["D12-020", "D12-021", "D12-022", "D12-030"],
          "build": [
            "Create `apps/api/src/domains/platform/platform.routes.ts` and `apps/api/src/domains/platform/platform.handlers.ts`.",
            "",
            "**Webhook route (no auth — Stripe signature only):**",
            "- POST /api/v1/webhooks/stripe → stripeWebhookHandler (raw body, signature verification)",
            "",
            "**Subscription routes (auth required, physician role):**",
            "- POST /api/v1/subscriptions/checkout → createCheckoutHandler (body: createCheckoutSessionSchema)",
            "- POST /api/v1/subscriptions/portal → createPortalHandler (body: createPortalSessionSchema)",
            "- GET /api/v1/subscriptions/current → getCurrentSubscriptionHandler",
            "- GET /api/v1/subscriptions/payments → listPaymentsHandler (query: pagination)",
            "",
            "**Admin routes (auth required, admin role):**",
            "- GET /api/v1/admin/subscriptions → listAllSubscriptionsHandler (query: adminSubscriptionQuerySchema)",
            "- PATCH /api/v1/admin/subscriptions/:id/status → adminUpdateStatusHandler (for manual intervention)",
            "",
            "**Handlers are thin:** validate input, call service, format response.",
            "",
            "Create `apps/api/test/integration/platform/subscriptions.integration.ts` with full integration tests.",
            "Use Stripe test mode / mock Stripe SDK for integration tests."
          ],
          "security": [
            "Webhook route has NO auth middleware — only Stripe signature verification.",
            "All subscription routes require physician role (delegates cannot manage subscriptions).",
            "Admin routes require admin role.",
            "getCurrentSubscriptionHandler must scope to the authenticated user's subscription only.",
            "listPaymentsHandler must scope to the authenticated user's subscription only."
          ],
          "tests": [
            "POST /webhooks/stripe with valid signature processes event",
            "POST /webhooks/stripe with invalid signature returns 400",
            "POST /subscriptions/checkout returns checkout URL",
            "POST /subscriptions/checkout rejects delegate role",
            "POST /subscriptions/portal returns portal URL for active subscriber",
            "GET /subscriptions/current returns subscription for authenticated user",
            "GET /subscriptions/payments returns paginated payment history",
            "GET /admin/subscriptions returns all subscriptions for admin",
            "GET /admin/subscriptions rejects non-admin"
          ]
        },
        {
          "id": "D12-032",
          "description": "Routes: status page (public) and admin incident management + integration tests",
          "verify": "pnpm --filter api vitest run test/integration/platform/",
          "depends": ["D12-023", "D12-030"],
          "build": [
            "Add to `apps/api/src/domains/platform/platform.routes.ts` and handlers:",
            "",
            "**Public status page routes (no auth required):**",
            "- GET /api/v1/status → getStatusPageHandler (returns components + active incidents)",
            "- GET /api/v1/status/incidents → getIncidentHistoryHandler (query: incidentHistoryQuerySchema)",
            "- GET /api/v1/status/incidents/:id → getIncidentDetailHandler",
            "",
            "**Admin incident management routes (auth required, admin role):**",
            "- POST /api/v1/admin/incidents → createIncidentHandler (body: createIncidentSchema)",
            "- POST /api/v1/admin/incidents/:id/updates → updateIncidentHandler (body: updateIncidentSchema)",
            "- PATCH /api/v1/admin/components/:id/status → updateComponentStatusHandler (body: updateComponentStatusSchema)",
            "",
            "Create `apps/api/test/integration/platform/status.integration.ts`."
          ],
          "security": [
            "Status page routes are public — no authentication required.",
            "Incident management routes require admin role.",
            "Public status page must NOT expose any internal system details (no stack traces, no DB connection strings, no config).",
            "Incident messages are admin-authored free text — sanitise for XSS before storage."
          ],
          "tests": [
            "GET /status returns all components and active incidents without auth",
            "GET /status/incidents returns paginated incident history",
            "GET /status/incidents/:id returns incident with updates",
            "POST /admin/incidents creates incident (admin only)",
            "POST /admin/incidents rejects non-admin",
            "POST /admin/incidents/:id/updates posts update",
            "PATCH /admin/components/:id/status updates component status",
            "PATCH /admin/components/:id/status rejects non-admin"
          ]
        }
      ]
    },
    {
      "title": "Domain 12: Platform Operations — Security Tests",
      "tasks": [
        {
          "id": "D12-040",
          "description": "Security: authentication enforcement on every protected route",
          "verify": "pnpm --filter api vitest run test/security/platform/platform.authn.security.ts",
          "depends": ["D12-031", "D12-032"],
          "build": [
            "Create `apps/api/test/security/platform/platform.authn.security.ts`.",
            "",
            "Test every authenticated route in Platform Operations returns 401 without a valid session cookie:",
            "",
            "- POST /api/v1/subscriptions/checkout",
            "- POST /api/v1/subscriptions/portal",
            "- GET /api/v1/subscriptions/current",
            "- GET /api/v1/subscriptions/payments",
            "- GET /api/v1/admin/subscriptions",
            "- PATCH /api/v1/admin/subscriptions/:id/status",
            "- POST /api/v1/admin/incidents",
            "- POST /api/v1/admin/incidents/:id/updates",
            "- PATCH /api/v1/admin/components/:id/status",
            "",
            "For each route: send request with no cookie, with expired cookie, and with tampered cookie. All must return 401.",
            "",
            "**Also verify public routes DO NOT require auth:**",
            "- GET /api/v1/status → 200 without cookie",
            "- GET /api/v1/status/incidents → 200 without cookie",
            "- GET /api/v1/status/incidents/:id → 200 without cookie",
            "- POST /api/v1/webhooks/stripe → does not return 401 (uses signature verification instead)"
          ],
          "security": [
            "401 responses must not contain any data beyond the error object.",
            "Public routes must genuinely be accessible without authentication.",
            "Webhook route must not return 401 — it has its own signature-based authentication."
          ]
        },
        {
          "id": "D12-041",
          "description": "Security: authorization and role enforcement",
          "verify": "pnpm --filter api vitest run test/security/platform/platform.authz.security.ts",
          "depends": ["D12-031", "D12-032"],
          "build": [
            "Create `apps/api/test/security/platform/platform.authz.security.ts`.",
            "",
            "**Delegate cannot access subscription management:**",
            "- POST /subscriptions/checkout as delegate → 403",
            "- POST /subscriptions/portal as delegate → 403",
            "- GET /subscriptions/current as delegate → 403 (delegates don't have subscriptions)",
            "",
            "**Non-admin cannot access admin routes:**",
            "- GET /admin/subscriptions as physician → 403",
            "- PATCH /admin/subscriptions/:id/status as physician → 403",
            "- POST /admin/incidents as physician → 403",
            "- POST /admin/incidents/:id/updates as physician → 403",
            "- PATCH /admin/components/:id/status as physician → 403",
            "",
            "**Subscription-gated access (using checkSubscription middleware from D01-030):**",
            "- SUSPENDED user: verify claim creation blocked (403 or 402)",
            "- CANCELLED user: verify all feature access blocked except data export"
          ]
        },
        {
          "id": "D12-042",
          "description": "Security: cross-user isolation (tenant scoping)",
          "verify": "pnpm --filter api vitest run test/security/platform/platform.scoping.security.ts",
          "depends": ["D12-031", "D12-032"],
          "build": [
            "Create `apps/api/test/security/platform/platform.scoping.security.ts`.",
            "",
            "Create two physician accounts (physician1, physician2) using createSecurityPair fixture.",
            "",
            "**Subscription isolation:**",
            "- GET /subscriptions/current as physician1 returns only physician1's subscription",
            "- GET /subscriptions/current as physician2 returns only physician2's subscription",
            "- Physician1 cannot see physician2's payment history via GET /subscriptions/payments",
            "",
            "**Admin override verified:**",
            "- Admin CAN see all subscriptions via GET /admin/subscriptions",
            "- Admin CAN update any subscription status (but this is admin-only)",
            "",
            "**Webhook isolation:**",
            "- Webhook event for physician1's Stripe customer only affects physician1's subscription",
            "",
            "**Important:** Cross-user access attempts return 404, not 403."
          ]
        },
        {
          "id": "D12-043",
          "description": "Security: input validation and injection prevention",
          "verify": "pnpm --filter api vitest run test/security/platform/platform.input.security.ts",
          "depends": ["D12-031", "D12-032"],
          "build": [
            "Create `apps/api/test/security/platform/platform.input.security.ts`.",
            "",
            "**SQL injection payloads on string inputs:**",
            "- plan field: `' OR 1=1--`",
            "- success_url field: SQL injection payloads",
            "- Incident title: SQL injection payloads",
            "- Incident message: SQL injection payloads",
            "",
            "**XSS payloads on stored text fields:**",
            "- Incident title: `<script>alert(1)</script>`",
            "- Incident message: `<img onerror=alert(1) src=x>`",
            "- Component status: XSS payloads",
            "",
            "**Type coercion attacks:**",
            "- Send number where string expected, array where string expected",
            "- Send negative page_size to payment history → 400",
            "- Send page_size > 100 to admin subscriptions → capped at 100",
            "",
            "**UUID parameter validation:**",
            "- Non-UUID in path params (e.g., PATCH /admin/subscriptions/not-a-uuid) → 400",
            "",
            "**URL validation:**",
            "- success_url with javascript: protocol → 400",
            "- success_url with data: protocol → 400",
            "- cancel_url with non-HTTP URL → 400",
            "",
            "**Plan validation:**",
            "- Invalid plan name → 400",
            "- Empty plan → 400",
            "",
            "**Webhook body tampering:**",
            "- Valid signature but modified body → 400 (signature mismatch)",
            "- Oversized webhook body → 400"
          ]
        },
        {
          "id": "D12-044",
          "description": "Security: data leakage prevention (Stripe secrets, PHI isolation)",
          "verify": "pnpm --filter api vitest run test/security/platform/platform.leakage.security.ts",
          "depends": ["D12-031", "D12-032"],
          "build": [
            "Create `apps/api/test/security/platform/platform.leakage.security.ts`.",
            "",
            "**Stripe data isolation:**",
            "- GET /subscriptions/current does NOT return stripe_customer_id in response",
            "- GET /subscriptions/current does NOT return stripe_subscription_id in response",
            "- GET /subscriptions/payments does NOT return stripe_invoice_id in response",
            "- Payment responses contain only amount, GST, total, status, date — no Stripe internals",
            "",
            "**PHI isolation verification:**",
            "- Verify no PHI (patient data, claim data, billing codes) appears in any Platform Operations response",
            "- Verify Stripe webhook handler does not log PHI",
            "",
            "**Error response sanitisation:**",
            "- 500 errors on subscription endpoints do not expose Stripe API keys or webhook secrets",
            "- 500 errors do not expose database connection strings",
            "- Webhook verification failures return generic 400, not the expected signature",
            "",
            "**Header checks:**",
            "- No X-Powered-By header",
            "- No Server header revealing version",
            "- Status page responses include cache headers (public, short TTL)",
            "",
            "**Admin responses:**",
            "- Admin subscription list includes Stripe IDs (admin needs these for debugging)",
            "- Non-admin responses never include Stripe IDs"
          ]
        },
        {
          "id": "D12-045",
          "description": "Security: audit trail completeness for billing and subscription events",
          "verify": "pnpm --filter api vitest run test/security/platform/platform.audit.security.ts",
          "depends": ["D12-031", "D12-032"],
          "build": [
            "Create `apps/api/test/security/platform/platform.audit.security.ts`.",
            "",
            "Verify each billing/subscription action produces an audit record:",
            "",
            "**Subscription events:**",
            "- Checkout session created → subscription.checkout_initiated with plan",
            "- Subscription created (via webhook) → subscription.created with plan, stripe_subscription_id",
            "- Subscription status changed → subscription.status_changed with old_status, new_status",
            "- Plan changed → subscription.plan_changed with old_plan, new_plan",
            "",
            "**Payment events:**",
            "- Payment succeeded → payment.succeeded with amount, total_cad",
            "- Payment failed → payment.failed with amount",
            "",
            "**Dunning events:**",
            "- Account suspended → subscription.suspended with reason",
            "- Account cancelled → subscription.cancelled with reason",
            "",
            "**Deletion events:**",
            "- Deletion scheduled → account.deletion_scheduled with deletion_date",
            "- Data deleted → account.data_deleted",
            "",
            "**Incident events:**",
            "- Incident created → incident.created with title, severity",
            "- Incident updated → incident.updated with new_status",
            "- Component status changed → component.status_updated with old_status, new_status",
            "",
            "**Audit log integrity:**",
            "- No UPDATE endpoints exist for payment_history",
            "- No DELETE endpoints exist for payment_history (financial records are immutable)",
            "- Audit entries do not contain Stripe API keys or webhook secrets"
          ]
        }
      ]
    },
    {
      "title": "Domain 12: Platform Operations — Final Validation",
      "tasks": [
        {
          "id": "D12-099",
          "description": "Full domain test suite: all unit + integration + security tests",
          "verify": "pnpm --filter api vitest run src/domains/platform/ test/integration/platform/ test/security/platform/",
          "depends": ["D12-040", "D12-041", "D12-042", "D12-043", "D12-044", "D12-045"],
          "build": [
            "Run the complete test suite for Domain 12 Platform Operations. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/platform/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/platform/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/platform/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/platform/ test/integration/platform/ test/security/platform/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/platform/platform.authn.security.ts",
            "- test/security/platform/platform.authz.security.ts",
            "- test/security/platform/platform.scoping.security.ts",
            "- test/security/platform/platform.input.security.ts",
            "- test/security/platform/platform.leakage.security.ts",
            "- test/security/platform/platform.audit.security.ts",
            "",
            "Verify integration test files exist:",
            "- test/integration/platform/subscriptions.integration.ts",
            "- test/integration/platform/status.integration.ts"
          ]
        }
      ]
    }
  ]
}
