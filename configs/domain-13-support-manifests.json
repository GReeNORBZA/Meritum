{
  "domainNumber": "13",
  "domainName": "Support System",
  "manifestFile": "domain-13-support.tasks",
  "promptPrefix": "d13",
  "modulePath": "apps/api/src/domains/support",
  "sections": [
    {
      "title": "Domain 13: Support System — Shared Types, Schemas & Migration",
      "tasks": [
        {
          "id": "D13-001",
          "description": "Support system constants, enums, and shared types",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/support.constants.ts` with all Domain 13 constants:",
            "",
            "**Ticket statuses:**",
            "- OPEN, IN_PROGRESS, WAITING_ON_CUSTOMER, RESOLVED, CLOSED",
            "",
            "**Ticket priorities:**",
            "- LOW, MEDIUM, HIGH, URGENT",
            "- Default: MEDIUM",
            "- URGENT auto-assigned for batch submission failures (context_metadata contains batch_error)",
            "",
            "**Ticket categories:**",
            "- BILLING, TECHNICAL, ACCOUNT, FEATURE_REQUEST",
            "- null initially — assigned by support team during triage",
            "",
            "**SLA targets (business hours Mon–Fri 08:00–18:00 MT, Thursday 06:00–22:00 MT):**",
            "- URGENT: first response < 2 hours, resolution < 4 hours",
            "- HIGH: first response < 4 hours, resolution < 1 business day",
            "- MEDIUM: first response < 1 business day, resolution < 3 business days",
            "- LOW: first response < 2 business days, resolution < 5 business days",
            "",
            "**Help centre article categories:**",
            "- GETTING_STARTED, AHCIP_BILLING, WCB_BILLING, MODIFIERS_AND_RULES, AI_COACH, ACCOUNT_AND_BILLING, TROUBLESHOOTING",
            "",
            "**Article feedback values:**",
            "- HELPFUL, NOT_HELPFUL",
            "",
            "**Satisfaction rating range:**",
            "- 1–5 (integer)",
            "",
            "**Context-aware help mapping (page URL pattern → help category):**",
            "- /claims/new, /claims/*/edit → AHCIP_BILLING",
            "- /claims/*/rejected → search by rejection code from context_metadata",
            "- /wcb/* → WCB_BILLING",
            "- /settings/* → ACCOUNT_AND_BILLING",
            "- /analytics/* → GETTING_STARTED (analytics help)",
            "- /onboarding/* → GETTING_STARTED",
            "- default → search page",
            "",
            "**Audit action identifiers:**",
            "- support.ticket_created, support.ticket_updated, support.ticket_resolved",
            "- support.ticket_closed, support.ticket_rated",
            "- support.article_viewed, support.article_feedback",
            "- support.help_searched",
            "",
            "**Phase 1.5 AI chat constants (placeholders):**",
            "- CONFIDENCE_THRESHOLD: 0.70 (below this, escalate to email)",
            "- CHAT_ENABLED: false (set true at Phase 1.5 launch)",
            "",
            "Export all as frozen objects / TypeScript enums."
          ],
          "frd": [
            "Domain 13 Section 3.2: Ticket statuses — OPEN, IN_PROGRESS, WAITING_ON_CUSTOMER, RESOLVED, CLOSED.",
            "Domain 13 Section 3.2: Ticket priorities — LOW, MEDIUM, HIGH, URGENT. Table 3 for SLA targets.",
            "Domain 13 Section 2.1: Help centre categories (Table 1).",
            "Domain 13 Section 2.3: Context-aware help mapping — page URL to help category.",
            "Domain 13 Section 4.1: AI chat confidence threshold 0.70 for escalation."
          ]
        },
        {
          "id": "D13-002",
          "description": "Drizzle schema for support_tickets table",
          "verify": "pnpm --filter shared build",
          "depends": ["D13-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/support.schema.ts` starting with support_tickets table.",
            "",
            "**support_tickets table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| ticket_id | UUID | PK | Default: gen_random_uuid() |",
            "| provider_id | UUID FK | NOT NULL | FK to providers. Indexed. |",
            "| subject | VARCHAR(200) | NOT NULL | Auto-generated from context or physician-entered |",
            "| description | TEXT | NOT NULL | Physician's description of the issue |",
            "| context_url | VARCHAR(500) | NULLABLE | Page URL where 'Help' was clicked |",
            "| context_metadata | JSONB | NULLABLE | Auto-captured: claim_id, batch_id, error codes, browser info |",
            "| category | VARCHAR(50) | NULLABLE | Assigned by support team: BILLING, TECHNICAL, ACCOUNT, FEATURE_REQUEST |",
            "| priority | VARCHAR(10) | NOT NULL, DEFAULT 'MEDIUM' | LOW, MEDIUM, HIGH, URGENT |",
            "| status | VARCHAR(20) | NOT NULL, DEFAULT 'OPEN' | OPEN, IN_PROGRESS, WAITING_ON_CUSTOMER, RESOLVED, CLOSED |",
            "| assigned_to | VARCHAR(100) | NULLABLE | Support team member handling the ticket |",
            "| resolution_notes | TEXT | NULLABLE | How the issue was resolved |",
            "| resolved_at | TIMESTAMPTZ | NULLABLE | When the ticket was resolved |",
            "| satisfaction_rating | INTEGER | NULLABLE | 1–5 star rating from physician |",
            "| satisfaction_comment | TEXT | NULLABLE | Optional comment with rating |",
            "| screenshot_path | VARCHAR(255) | NULLABLE | Path to uploaded screenshot (encrypted at rest) |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Indexes:**",
            "- Index on (provider_id, status) for physician's ticket list filtered by status",
            "- Index on (provider_id, created_at DESC) for recent tickets",
            "- Index on (status, priority) for support team triage queue",
            "- Index on (assigned_to, status) for agent workload",
            "",
            "**Note:** Added satisfaction_comment and screenshot_path beyond FRD Table 2 spec to support user stories SUP-003 (screenshot upload) and SUP-005 (optional comment with rating).",
            "",
            "Export table and inferred types (InsertSupportTicket, SelectSupportTicket)."
          ],
          "frd": [
            "Domain 13 Section 3.2: support_tickets table schema (Table 2).",
            "Domain 13 Section 5: SUP-003 screenshot upload, SUP-005 optional comment with rating."
          ],
          "security": [
            "provider_id scoping — physician can only see their own tickets.",
            "context_metadata may contain claim_id or batch_id — PHI-adjacent. Encrypted at rest.",
            "screenshot_path points to encrypted storage. Never expose in API responses.",
            "description may contain PHI if physician describes a specific patient issue — treat as sensitive."
          ]
        },
        {
          "id": "D13-003",
          "description": "Drizzle schema for help_articles table",
          "verify": "pnpm --filter shared build",
          "depends": ["D13-001"],
          "build": [
            "Add to `packages/shared/src/schemas/db/support.schema.ts` the help_articles table.",
            "",
            "**help_articles table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| article_id | UUID | PK | Default: gen_random_uuid() |",
            "| slug | VARCHAR(200) | NOT NULL, UNIQUE | URL-friendly identifier (e.g., 'understanding-thursday-batch') |",
            "| title | VARCHAR(200) | NOT NULL | Article title |",
            "| category | VARCHAR(50) | NOT NULL | One of HELP_CENTRE_CATEGORIES constants |",
            "| content | TEXT | NOT NULL | Article body in Markdown format |",
            "| summary | VARCHAR(500) | NULLABLE | Short description for search results |",
            "| search_vector | TSVECTOR | NOT NULL | PostgreSQL full-text search vector, generated from title + content |",
            "| related_codes | JSONB | NULLABLE | Array of related HSC codes, explanatory codes, or error codes for code-specific lookups |",
            "| somb_version | VARCHAR(20) | NULLABLE | SOMB version this article references (for versioning) |",
            "| is_published | BOOLEAN | NOT NULL, DEFAULT false | Only published articles visible to physicians |",
            "| helpful_count | INTEGER | NOT NULL, DEFAULT 0 | Count of 'helpful' feedback |",
            "| not_helpful_count | INTEGER | NOT NULL, DEFAULT 0 | Count of 'not helpful' feedback |",
            "| sort_order | INTEGER | NOT NULL, DEFAULT 0 | Display order within category |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Indexes:**",
            "- UNIQUE on slug",
            "- GIN index on search_vector for full-text search",
            "- Index on (category, is_published, sort_order) for category listing",
            "- GIN index on related_codes for code-specific lookups",
            "",
            "**Full-text search trigger:** Create a trigger or generated column that updates search_vector from title and content using `to_tsvector('english', title || ' ' || content)`.",
            "",
            "Export table and inferred types (InsertHelpArticle, SelectHelpArticle)."
          ],
          "frd": [
            "Domain 13 Section 2.1: Help centre structured by category (Table 1).",
            "Domain 13 Section 2.2: Full-text search, versioned, feedback loop ('Was this helpful?').",
            "Domain 13 Section 2.3: Context-aware help — related_codes enables rejection code lookups."
          ],
          "security": [
            "Help articles are NOT PHI — they are public knowledge base content.",
            "is_published controls visibility — draft articles hidden from physicians.",
            "No provider_id scoping needed — articles are shared across all physicians."
          ]
        },
        {
          "id": "D13-004",
          "description": "Drizzle schema for article_feedback table",
          "verify": "pnpm --filter shared build",
          "depends": ["D13-003"],
          "build": [
            "Add to `packages/shared/src/schemas/db/support.schema.ts` the article_feedback table.",
            "",
            "**article_feedback table:**",
            "",
            "| Column | Type | Constraints | Notes |",
            "|--------|------|-------------|-------|",
            "| feedback_id | UUID | PK | Default: gen_random_uuid() |",
            "| article_id | UUID FK | NOT NULL | FK to help_articles |",
            "| provider_id | UUID FK | NOT NULL | FK to providers (who gave feedback) |",
            "| is_helpful | BOOLEAN | NOT NULL | true = helpful, false = not helpful |",
            "| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |",
            "",
            "**Indexes:**",
            "- UNIQUE on (article_id, provider_id) — one feedback per physician per article",
            "- Index on (article_id) for aggregate counts",
            "",
            "Export table and inferred types."
          ],
          "frd": [
            "Domain 13 Section 2.2: 'Was this helpful?' on every article. Low-rated articles prioritised for rewrite."
          ]
        },
        {
          "id": "D13-005",
          "description": "Zod validation schemas for all support API inputs",
          "verify": "pnpm --filter shared build",
          "depends": ["D13-001"],
          "build": [
            "Create `packages/shared/src/schemas/validation/support.validation.ts` with Zod schemas:",
            "",
            "**Help centre:**",
            "- ArticleListQuerySchema: { category?: enum(HELP_CATEGORIES), search?: string(max 200), limit?: number(1-50, default 20), offset?: number }",
            "- ArticleSlugParamSchema: { slug: string(max 200, alphanumeric + hyphens only) }",
            "- ArticleFeedbackSchema: { is_helpful: boolean }",
            "",
            "**Support tickets:**",
            "- CreateTicketSchema: { subject: string(max 200), description: string(max 5000), context_url?: string(max 500, valid URL), context_metadata?: object, priority?: enum(PRIORITIES, default MEDIUM) }. Screenshot handled as multipart file upload, not in JSON body.",
            "- TicketListQuerySchema: { status?: enum(TICKET_STATUSES), limit?: number(1-50, default 20), offset?: number }",
            "- TicketIdParamSchema: { id: UUID }",
            "- TicketRatingSchema: { rating: integer(1-5), comment?: string(max 1000) }",
            "",
            "**Internal/admin ticket updates (support team only):**",
            "- UpdateTicketSchema: { status?: enum(TICKET_STATUSES), category?: enum(TICKET_CATEGORIES), priority?: enum(PRIORITIES), assigned_to?: string(max 100), resolution_notes?: string(max 5000) }. At least one field required.",
            "",
            "All UUIDs validated as v4. context_url validated as HTTPS URL. description sanitised for XSS.",
            "",
            "Export all schemas."
          ],
          "frd": [
            "Domain 13 Section 6: API contracts (Table 5).",
            "Domain 13 Section 3.1: Support form — subject, description, context, screenshot.",
            "Domain 13 Section 5: SUP-005 satisfaction rating 1–5 with optional comment."
          ],
          "security": [
            "description max 5000 chars — prevent unbounded text storage.",
            "context_url validated as HTTPS — prevent javascript: or data: URI injection.",
            "context_metadata validated as object — prevent arbitrary type injection.",
            "Screenshot upload handled separately via multipart — size and type validation at route level."
          ]
        },
        {
          "id": "D13-006",
          "description": "Database migration for all Domain 13 tables",
          "verify": "pnpm --filter api drizzle-kit generate && pnpm --filter api drizzle-kit migrate",
          "depends": ["D13-002", "D13-003", "D13-004"],
          "build": [
            "Generate and run Drizzle migration for Domain 13 tables.",
            "",
            "The migration should create:",
            "1. support_tickets table with all columns, indexes, FK to providers",
            "2. help_articles table with all columns, indexes, full-text search vector and trigger",
            "3. article_feedback table with all columns, indexes, FKs to help_articles and providers",
            "",
            "**Full-text search setup:**",
            "Create trigger on help_articles:",
            "```sql",
            "CREATE OR REPLACE FUNCTION update_article_search_vector() RETURNS trigger AS $$",
            "BEGIN",
            "  NEW.search_vector := to_tsvector('english', COALESCE(NEW.title, '') || ' ' || COALESCE(NEW.content, ''));",
            "  RETURN NEW;",
            "END",
            "$$ LANGUAGE plpgsql;",
            "",
            "CREATE TRIGGER articles_search_vector_update",
            "  BEFORE INSERT OR UPDATE ON help_articles",
            "  FOR EACH ROW EXECUTE FUNCTION update_article_search_vector();",
            "```",
            "",
            "Run `pnpm --filter api drizzle-kit generate` then `pnpm --filter api drizzle-kit migrate`.",
            "Verify all tables exist, full-text search trigger fires on article insert."
          ],
          "frd": [
            "Domain 13 Section 2.2: Full-text search across all articles.",
            "Domain 13 Section 3.2: support_tickets table.",
            "Domain 13 Section 2.2: Feedback loop — article_feedback table."
          ],
          "security": [
            "FK constraints ensure referential integrity.",
            "Full-text search uses built-in PostgreSQL tsvector — no external search engine required at MVP."
          ]
        }
      ]
    },
    {
      "title": "Domain 13: Support System — Repository Layer",
      "tasks": [
        {
          "id": "D13-010",
          "description": "Help articles repository — search, category listing, feedback",
          "verify": "pnpm --filter api vitest run src/domains/support/repos/help-articles.repo.test.ts",
          "depends": ["D13-006"],
          "build": [
            "Create `apps/api/src/domains/support/repos/help-articles.repo.ts` and test file.",
            "",
            "**Methods:**",
            "",
            "- `search(query, limit?, offset?)` — full-text search using `to_tsquery('english', query)` against search_vector. Rank results using `ts_rank`. Only return published articles. Return: article_id, slug, title, category, summary, rank score.",
            "- `getBySlug(slug)` — fetch full article by slug. Only if is_published = true. Return null if not found or unpublished.",
            "- `listByCategory(category, limit?, offset?)` — list published articles in a category, ordered by sort_order. Return article_id, slug, title, summary.",
            "- `findByRelatedCode(code)` — search related_codes JSONB array for the given code. Returns articles where related_codes @> code. For rejection/explanatory code lookups.",
            "- `incrementFeedback(articleId, isHelpful)` — atomically increment helpful_count or not_helpful_count.",
            "- `createFeedback(articleId, providerId, isHelpful)` — insert into article_feedback. On conflict (article_id, provider_id) update the is_helpful value (physician can change their feedback).",
            "",
            "**Admin methods (for content management — support team/admin only):**",
            "- `create(data: InsertHelpArticle)` — create new article. Slug auto-generated from title if not provided.",
            "- `update(articleId, data: Partial)` — update article content. search_vector auto-updated by trigger.",
            "- `publish(articleId)` — set is_published = true.",
            "- `unpublish(articleId)` — set is_published = false.",
            "",
            "Unit tests: full-text search returns ranked results, category listing, slug lookup, related code search, feedback increment, unpublished articles hidden."
          ],
          "frd": [
            "Domain 13 Section 2.2: Searchable full-text, feedback loop, versioned.",
            "Domain 13 Section 2.3: Context-aware help — findByRelatedCode for rejection code lookups.",
            "Domain 13 Section 6: GET /help/articles and GET /help/articles/{slug} endpoints."
          ],
          "security": [
            "Only published articles returned to physicians — draft content hidden.",
            "Full-text search uses parameterised tsquery — no raw SQL injection.",
            "Feedback limited to one per physician per article — prevents vote manipulation."
          ]
        },
        {
          "id": "D13-011",
          "description": "Support tickets repository — CRUD, status tracking, SLA queries",
          "verify": "pnpm --filter api vitest run src/domains/support/repos/support-tickets.repo.test.ts",
          "depends": ["D13-006"],
          "build": [
            "Create `apps/api/src/domains/support/repos/support-tickets.repo.ts` and test file.",
            "",
            "**Methods (physician-facing — require providerId):**",
            "",
            "- `create(data: InsertSupportTicket)` — create new ticket with status OPEN. Auto-set priority to URGENT if context_metadata contains batch failure indicators.",
            "- `getById(ticketId, providerId)` — fetch ticket by ID scoped to provider. Return null for wrong provider (404 pattern).",
            "- `listByProvider(providerId, filters?)` — list tickets with optional status filter. Paginated. Ordered by created_at DESC.",
            "- `addRating(ticketId, providerId, rating, comment?)` — set satisfaction_rating and satisfaction_comment. Only if status is RESOLVED or CLOSED. Return null for wrong provider.",
            "",
            "**Admin methods (support team — no provider scoping):**",
            "- `updateTicket(ticketId, data: Partial)` — update status, category, priority, assigned_to, resolution_notes, resolved_at. Set updated_at.",
            "- `listAllTickets(filters?)` — list all tickets with status/priority/category/assigned_to filters. For support team triage queue.",
            "- `getSlaBreach()` — return tickets that have exceeded their SLA first-response or resolution targets based on priority and created_at/resolved_at.",
            "",
            "**Screenshot handling:**",
            "- `setScreenshotPath(ticketId, providerId, path)` — store screenshot file path after upload processing.",
            "",
            "Unit tests: create sets OPEN status, auto-URGENT for batch failures, provider scoping returns null for wrong provider, status transitions, rating only on resolved tickets, SLA breach detection."
          ],
          "frd": [
            "Domain 13 Section 3.2: support_tickets table and status lifecycle.",
            "Domain 13 Section 3.3: SLA targets by priority (Table 3).",
            "Domain 13 Section 6: Ticket CRUD endpoints (Table 5).",
            "Domain 13 Section 5: SUP-005 satisfaction rating after resolution."
          ],
          "security": [
            "Physician-facing methods require providerId — no cross-physician ticket access.",
            "getById returns null for wrong provider — 404 pattern, don't confirm existence.",
            "Admin methods used by support team only — access controlled at route level.",
            "screenshot_path never returned in physician-facing API responses.",
            "Rating only allowed on RESOLVED or CLOSED tickets — prevents premature rating."
          ]
        }
      ]
    },
    {
      "title": "Domain 13: Support System — Service Layer",
      "tasks": [
        {
          "id": "D13-020",
          "description": "Help centre service — search, context-aware routing, feedback",
          "verify": "pnpm --filter api vitest run src/domains/support/services/help-centre.service.test.ts",
          "depends": ["D13-010"],
          "build": [
            "Create `apps/api/src/domains/support/services/help-centre.service.ts` and test file.",
            "",
            "**Methods:**",
            "",
            "- `searchArticles(query, limit?, offset?)` — sanitise search query (strip special tsquery characters), execute full-text search via repo. Audit log: support.help_searched (rate-limited, max 1 per minute per provider). Return ranked results.",
            "- `getArticle(slug)` — fetch article by slug. Audit log: support.article_viewed (rate-limited). Return article content.",
            "- `listByCategory(category, limit?, offset?)` — list published articles in category.",
            "- `getContextualHelp(contextUrl, contextMetadata?)` — resolve page context to help content:",
            "  1. Match contextUrl against context-aware help mapping from constants.",
            "  2. If matched to a category → return articles in that category.",
            "  3. If contextMetadata contains a rejection/explanatory code → search by related_codes.",
            "  4. If no match → return search page URL.",
            "- `submitFeedback(articleSlug, providerId, isHelpful)` — resolve slug to article_id, create/update feedback, increment article feedback counter. Audit log: support.article_feedback.",
            "",
            "**Search query sanitisation:**",
            "- Strip tsquery special characters: & | ! ( ) : * < >",
            "- Trim whitespace, limit to 200 chars.",
            "- Convert to websearch_to_tsquery for natural language input (allows 'common rejection codes' without manual AND/OR).",
            "",
            "Unit tests: search returns ranked results, empty query returns empty, context-aware mapping resolves categories, rejection code context finds related articles, feedback recorded and counters updated."
          ],
          "frd": [
            "Domain 13 Section 2.2: Full-text search, feedback loop.",
            "Domain 13 Section 2.3: Context-aware help — page URL to category mapping, rejection code search.",
            "Domain 13 Section 5: SUP-001 search, SUP-002 context-aware help, SUP-006 rejection code lookup."
          ],
          "security": [
            "Search query sanitised to prevent tsquery injection.",
            "Rate-limited audit logging for searches and article views to avoid noise.",
            "Articles are non-PHI but access patterns are logged for analytics."
          ]
        },
        {
          "id": "D13-021",
          "description": "Support ticket service — creation, lifecycle, notifications, SLA",
          "verify": "pnpm --filter api vitest run src/domains/support/services/support-ticket.service.test.ts",
          "depends": ["D13-011"],
          "build": [
            "Create `apps/api/src/domains/support/services/support-ticket.service.ts` and test file.",
            "",
            "**Methods:**",
            "",
            "- `createTicket(providerId, data, screenshotFile?)` — create support ticket. Auto-detect priority: if context_metadata contains batch_error or error codes, set URGENT. If screenshotFile provided, validate file type (png, jpg, webp, max 5MB), store to encrypted storage, set screenshot_path. Send confirmation email to physician. Send notification via Domain 6. Audit log: support.ticket_created. Return created ticket (without screenshot_path).",
            "- `getTicket(providerId, ticketId)` — fetch ticket scoped to provider. Return ticket details without screenshot_path. Return null for wrong provider.",
            "- `listTickets(providerId, filters)` — list physician's tickets. Paginated.",
            "- `rateTicket(providerId, ticketId, rating, comment?)` — submit satisfaction rating. Validate ticket status is RESOLVED or CLOSED. Validate rating 1–5. Update ticket. Audit log: support.ticket_rated. Return updated ticket.",
            "",
            "**Admin methods (support team only):**",
            "- `updateTicket(ticketId, data, actorId)` — update ticket fields (status, category, priority, assigned_to, resolution_notes). On status change to RESOLVED: set resolved_at = now(). Send notification to physician on status changes. Audit log: support.ticket_updated. On RESOLVED: audit log: support.ticket_resolved.",
            "- `closeTicket(ticketId, actorId)` — set status = CLOSED. Audit log: support.ticket_closed. Only if current status is RESOLVED.",
            "- `getTriageQueue(filters)` — list all open/in-progress tickets for support team. Sorted by priority then created_at.",
            "- `getSlaBreach()` — tickets exceeding SLA targets.",
            "",
            "**SLA calculation logic:**",
            "Business hours: Mon–Fri 08:00–18:00 MT, Thursday 06:00–22:00 MT.",
            "SLA clock only runs during business hours. Calculate elapsed business hours between created_at and now (for first response) or resolved_at (for resolution).",
            "",
            "**Notification triggers:**",
            "- Ticket created → confirmation email + in-app notification to physician.",
            "- Status changed → in-app notification + email to physician.",
            "- Ticket resolved → notification with resolution_notes summary.",
            "",
            "Unit tests: create with auto-URGENT, screenshot upload validation, status transitions, rating only on resolved/closed, SLA business hours calculation, notification dispatch."
          ],
          "frd": [
            "Domain 13 Section 3.1: Support email flow — form, context pre-fill, screenshot, confirmation, resolution notification.",
            "Domain 13 Section 3.2: Ticket lifecycle — OPEN → IN_PROGRESS → RESOLVED → CLOSED.",
            "Domain 13 Section 3.3: SLA targets by priority (Table 3). Business hours definition.",
            "Domain 13 Section 5: SUP-003 ticket creation, SUP-004 status notifications, SUP-005 rating."
          ],
          "security": [
            "Screenshot validated: max 5MB, image types only (png, jpg, webp). No executable uploads.",
            "screenshot_path never returned in API responses — only used server-side.",
            "description and context_metadata may contain PHI-adjacent info — encrypted at rest.",
            "Confirmation email contains ticket_id and subject only — no description or context in email body (PHI protection).",
            "SLA calculation runs during business hours only — ensures fair SLA tracking."
          ]
        }
      ]
    },
    {
      "title": "Domain 13: Support System — Routes, Handlers & Integration Tests",
      "tasks": [
        {
          "id": "D13-030",
          "description": "Help centre routes — article search, category listing, feedback",
          "verify": "pnpm --filter api vitest run src/domains/support/routes/help.routes.test.ts",
          "depends": ["D13-020", "D13-005"],
          "build": [
            "Create `apps/api/src/domains/support/routes/help.routes.ts` and test file.",
            "",
            "Register Fastify routes. Article listing and search are public (no auth required for help.meritum.ca). Feedback requires authentication.",
            "",
            "**Routes:**",
            "",
            "1. `GET /api/v1/help/articles` — query validated by ArticleListQuerySchema. Search or list articles. Public endpoint (no auth). If search param provided → full-text search. If category param → category listing. Returns article list with slug, title, category, summary.",
            "2. `GET /api/v1/help/articles/:slug` — param validated by ArticleSlugParamSchema. Get full article content. Public endpoint. 404 if slug not found or unpublished.",
            "3. `POST /api/v1/help/articles/:slug/feedback` — body validated by ArticleFeedbackSchema. Submit feedback. **Requires authentication.** Permission: any authenticated user. 404 if article not found.",
            "",
            "Route-level unit tests: search returns results, category filter works, slug lookup, feedback requires auth, 404 for unknown slug."
          ],
          "frd": [
            "Domain 13 Section 6: Help centre endpoints (Table 5 rows 1–3).",
            "Domain 13 Section 2.2: Searchable, feedback loop.",
            "Domain 13 Open Questions #1: Hybrid approach — help articles publicly accessible for SEO."
          ],
          "security": [
            "Article listing and viewing are public — no auth required (supports help.meritum.ca public access).",
            "Feedback requires authentication — prevents anonymous vote manipulation.",
            "Public endpoints must not leak any user data or session info."
          ]
        },
        {
          "id": "D13-031",
          "description": "Support ticket routes — creation, listing, detail, rating, screenshot upload",
          "verify": "pnpm --filter api vitest run src/domains/support/routes/ticket.routes.test.ts",
          "depends": ["D13-021", "D13-005"],
          "build": [
            "Create `apps/api/src/domains/support/routes/ticket.routes.ts` and test file.",
            "",
            "Register Fastify routes. All require authentication.",
            "",
            "**Physician-facing routes:**",
            "",
            "1. `POST /api/v1/support/tickets` — multipart form: JSON body validated by CreateTicketSchema + optional screenshot file upload. Creates ticket. Returns ticket (without screenshot_path). Permission: any authenticated physician/delegate.",
            "2. `GET /api/v1/support/tickets` — query validated by TicketListQuerySchema. List physician's tickets. Permission: any authenticated physician/delegate.",
            "3. `GET /api/v1/support/tickets/:id` — param validated by TicketIdParamSchema. Get ticket details. 404 for wrong provider. Permission: any authenticated physician/delegate.",
            "4. `POST /api/v1/support/tickets/:id/rating` — body validated by TicketRatingSchema. Submit rating. 400 if ticket not RESOLVED/CLOSED. 404 for wrong provider. Permission: any authenticated physician/delegate.",
            "",
            "**Screenshot upload handling:**",
            "- Accept multipart/form-data on POST /support/tickets.",
            "- Validate file: max 5MB, content-type must be image/png, image/jpeg, or image/webp.",
            "- Store file to encrypted storage.",
            "- Set screenshot_path on ticket record.",
            "- Never return screenshot_path in response — support team accesses via admin interface.",
            "",
            "Route-level unit tests: ticket CRUD, screenshot upload validation (size, type), rating validation, provider scoping."
          ],
          "frd": [
            "Domain 13 Section 6: Ticket endpoints (Table 5 rows 4–7).",
            "Domain 13 Section 3.1: Support form with context pre-fill and screenshot upload.",
            "Domain 13 Section 5: SUP-003 ticket creation, SUP-005 rating."
          ],
          "security": [
            "All ticket endpoints require authentication — no anonymous ticket creation.",
            "Provider scoping on all physician-facing endpoints.",
            "Screenshot upload: max 5MB, image types only, content-type validated server-side (not just from client header).",
            "Multipart parsing with size limits to prevent DoS.",
            "screenshot_path never in response body."
          ]
        },
        {
          "id": "D13-032",
          "description": "Integration tests — end-to-end support workflows",
          "verify": "pnpm --filter api vitest run test/integration/support/",
          "depends": ["D13-030", "D13-031"],
          "build": [
            "Create integration test files in `apps/api/test/integration/support/`:",
            "",
            "**File: support.help-centre.integration.ts**",
            "- Seed help articles across categories.",
            "- Search 'thursday batch' → returns AHCIP_BILLING articles about batch cycle.",
            "- Search 'explanatory code 101' → returns article with related_codes containing '101'.",
            "- Search nonsense string → empty results.",
            "- List by category TROUBLESHOOTING → returns only troubleshooting articles.",
            "- Get article by slug → full content returned.",
            "- Get unpublished article → 404.",
            "- Submit feedback (helpful) → article helpful_count incremented.",
            "- Submit feedback again → updates existing feedback (doesn't double-count).",
            "",
            "**File: support.tickets.integration.ts**",
            "- Create ticket with context → ticket created with OPEN status. Confirmation notification sent.",
            "- Create ticket with batch failure context → auto-URGENT priority.",
            "- List tickets → shows created tickets, ordered by recency.",
            "- Get ticket by ID → full details without screenshot_path.",
            "- Rate ticket before resolution → 400.",
            "- Admin resolves ticket → physician notified. Status = RESOLVED. resolved_at set.",
            "- Rate resolved ticket → rating stored. 1–5 valid. 0 or 6 → 400.",
            "- Admin closes ticket → status = CLOSED.",
            "",
            "**File: support.context-aware.integration.ts**",
            "- Simulate help button from claim page → articles in AHCIP_BILLING category returned.",
            "- Simulate help from rejected claim with explanatory code → article for that code returned.",
            "- Simulate help from settings page → ACCOUNT_AND_BILLING articles.",
            "- Simulate help with no context → search page fallback.",
            "",
            "**File: support.delegate.integration.ts**",
            "- Delegate can create support tickets on behalf of physician.",
            "- Delegate can view physician's tickets.",
            "- Delegate-created tickets are linked to the physician's provider_id (not the delegate's)."
          ],
          "frd": [
            "Domain 13 Section 7: All testing requirements.",
            "Domain 13 Section 5: User stories and acceptance criteria (Table 4).",
            "SUP-001 through SUP-006 coverage."
          ],
          "tests": [
            "Help centre search returns ranked results for 'thursday batch'.",
            "Rejection code search finds articles with matching related_codes.",
            "Context-aware help maps claim page to AHCIP_BILLING category.",
            "Ticket creation captures context and sends confirmation notification.",
            "Batch failure context auto-sets URGENT priority.",
            "Ticket lifecycle: OPEN → IN_PROGRESS → RESOLVED → CLOSED with notifications at each step.",
            "Rating only allowed on RESOLVED or CLOSED tickets.",
            "Screenshot upload stores file securely, path not in API response.",
            "Feedback limited to one per physician per article."
          ]
        }
      ]
    },
    {
      "title": "Domain 13: Support System — Security Tests",
      "tasks": [
        {
          "id": "D13-040",
          "description": "Security: authentication enforcement on every protected route",
          "verify": "pnpm --filter api vitest run test/security/support/support.authn.security.ts",
          "depends": ["D13-030", "D13-031"],
          "build": [
            "Create `apps/api/test/security/support/support.authn.security.ts`.",
            "",
            "Test every authenticated route in Domain 13 returns 401 without a valid session cookie:",
            "",
            "**Authenticated routes:**",
            "- POST /api/v1/help/articles/:slug/feedback",
            "- POST /api/v1/support/tickets",
            "- GET /api/v1/support/tickets",
            "- GET /api/v1/support/tickets/:id",
            "- POST /api/v1/support/tickets/:id/rating",
            "",
            "**Public routes (verify they work WITHOUT auth):**",
            "- GET /api/v1/help/articles → 200 without cookie",
            "- GET /api/v1/help/articles/:slug → 200 without cookie (for published articles)",
            "",
            "For each authenticated route (5 total): send request with no cookie, with expired cookie, and with tampered cookie. All must return 401 with no data leakage.",
            "",
            "For public routes: verify they return valid data WITHOUT any cookie. Verify they do NOT return any user-specific data or session info in response.",
            "",
            "Total assertions: 5 authenticated routes × 3 failure modes = 15 + 2 public route verifications."
          ],
          "security": [
            "401 responses must not contain any data beyond the error object.",
            "Public help routes must not leak session info or user data.",
            "Public routes return same content regardless of auth status — no personalisation leakage."
          ]
        },
        {
          "id": "D13-041",
          "description": "Security: authorization and permission enforcement",
          "verify": "pnpm --filter api vitest run test/security/support/support.authz.security.ts",
          "depends": ["D13-030", "D13-031"],
          "build": [
            "Create `apps/api/test/security/support/support.authz.security.ts`.",
            "",
            "Test permission-based access control:",
            "",
            "**Any authenticated user can:**",
            "- Create support tickets (no specific permission required beyond authentication)",
            "- View their own tickets",
            "- Rate their own resolved tickets",
            "- Submit article feedback",
            "",
            "**Delegate context:**",
            "- Delegate creates ticket → ticket linked to physician's provider_id from active context, not delegate's user_id.",
            "- Delegate views tickets → sees physician's tickets (scoped to active physician context).",
            "- Delegate rates ticket → rating on physician's ticket (delegate acting on behalf).",
            "",
            "**Admin-only operations (if admin endpoints implemented):**",
            "- Non-admin cannot update ticket status, category, priority, or assigned_to.",
            "- Non-admin cannot access triage queue or SLA breach reports.",
            "",
            "**No special permissions required for support access** — support is available to all authenticated users regardless of role/permissions. This is intentional: even a delegate with minimal permissions should be able to seek help."
          ],
          "security": [
            "Support is universally accessible to all authenticated users — no permission gating.",
            "Delegate tickets linked to physician context — ensures support team sees physician's account, not delegate's.",
            "Admin operations restricted — physicians cannot self-triage or manipulate ticket status."
          ]
        },
        {
          "id": "D13-042",
          "description": "Security: cross-physician tenant isolation (MOST CRITICAL)",
          "verify": "pnpm --filter api vitest run test/security/support/support.scoping.security.ts",
          "depends": ["D13-030", "D13-031"],
          "build": [
            "Create `apps/api/test/security/support/support.scoping.security.ts`.",
            "",
            "**MOST CRITICAL security test for Domain 13.** Support tickets may contain PHI-adjacent information (claim IDs, error details, physician descriptions of patient issues).",
            "",
            "Setup: Create two physicians (Physician A and Physician B) each with support tickets.",
            "",
            "**Ticket isolation:**",
            "- Physician A lists tickets → sees ONLY their own tickets.",
            "- Physician B lists tickets → sees ONLY their own tickets.",
            "- Physician A calls GET /support/tickets/:id with Physician B's ticket_id → 404 (not 403).",
            "- Physician A calls POST /support/tickets/:id/rating with Physician B's ticket_id → 404 (not 403).",
            "",
            "**Screenshot isolation:**",
            "- Physician A's screenshot is not accessible to Physician B (file path not exposed, but verify at storage level).",
            "",
            "**Article feedback isolation:**",
            "- Article feedback is per-physician. Physician A's feedback does not appear as Physician B's.",
            "- Both can submit feedback on the same article independently.",
            "",
            "**Delegate cross-physician:**",
            "- Delegate of Physician A in Physician A's context → sees Physician A's tickets.",
            "- Delegate cannot access Physician B's tickets if not linked to Physician B.",
            "",
            "**Help articles are NOT tenant-scoped** — they are shared knowledge base content. Verify this is intentional and no physician-specific data leaks through article endpoints.",
            "",
            "All cross-physician access attempts MUST return 404, NEVER 403."
          ],
          "security": [
            "MOST CRITICAL: All cross-physician ticket access returns 404 not 403.",
            "Ticket descriptions may contain PHI-adjacent data — strict isolation required.",
            "Help articles are intentionally shared — no tenant isolation needed on articles.",
            "Screenshot files isolated per physician — storage-level access control."
          ]
        },
        {
          "id": "D13-043",
          "description": "Security: input validation — injection, file upload, boundary values",
          "verify": "pnpm --filter api vitest run test/security/support/support.input.security.ts",
          "depends": ["D13-030", "D13-031"],
          "build": [
            "Create `apps/api/test/security/support/support.input.security.ts`.",
            "",
            "**SQL injection attempts:**",
            "- search query: `'; DROP TABLE help_articles; --` → 400 or sanitised (tsquery special chars stripped)",
            "- subject: injection payload → 400",
            "- article slug: `../../../etc/passwd` → 400 (slug validated: alphanumeric + hyphens only)",
            "- ticket_id param: injection payload → 400",
            "",
            "**XSS attempts:**",
            "- description: `<script>alert('xss')</script>` → 400 or stored safely (HTML escaped on output)",
            "- subject: HTML injection → 400 or sanitised",
            "- search query: `<img onerror=alert(1)>` → sanitised before tsquery",
            "- satisfaction_comment: script tags → 400 or sanitised",
            "",
            "**File upload attacks:**",
            "- Screenshot > 5MB → 400",
            "- Screenshot with executable extension (.exe, .sh, .js) → 400",
            "- Screenshot with valid image extension but executable content → validate content-type server-side",
            "- Screenshot with path traversal filename (../../evil.png) → filename sanitised",
            "- No screenshot (optional field) → valid, ticket created without screenshot",
            "- Multiple screenshots → only first accepted (single file upload)",
            "",
            "**Type coercion:**",
            "- rating: 0 → 400 (must be 1–5)",
            "- rating: 6 → 400",
            "- rating: 'five' → 400",
            "- rating: 3.5 → 400 (must be integer)",
            "- is_helpful: 'true' as string → should be boolean",
            "",
            "**Boundary values:**",
            "- subject: 201 chars → 400 (max 200)",
            "- description: 5001 chars → 400 (max 5000)",
            "- context_url: non-HTTPS URL → 400",
            "- context_url: javascript:alert(1) → 400",
            "- slug: special characters → 400 (alphanumeric + hyphens only)",
            "- search: 201 chars → 400 (max 200)",
            "",
            "All invalid inputs return 400 with generic error messages."
          ],
          "security": [
            "tsquery injection prevented by sanitising special characters before search.",
            "File upload validation must check content-type server-side, not rely on client-provided extension.",
            "Path traversal in filenames sanitised — filename stripped to safe characters.",
            "context_url must be HTTPS — prevents javascript: and data: URI injection."
          ]
        },
        {
          "id": "D13-044",
          "description": "Security: PHI leakage prevention in errors, headers, and logs",
          "verify": "pnpm --filter api vitest run test/security/support/support.leakage.security.ts",
          "depends": ["D13-030", "D13-031"],
          "build": [
            "Create `apps/api/test/security/support/support.leakage.security.ts`.",
            "",
            "**Error responses must not contain PHI:**",
            "- 404 on ticket access → no ticket description, no context_metadata.",
            "- 400 on invalid input → validation error only.",
            "- 500 (simulated) → generic error, no stack trace, no PHI.",
            "",
            "**Response headers:**",
            "- No X-Powered-By header.",
            "- No server version info.",
            "- screenshot_path NEVER in any API response.",
            "",
            "**Logs must not contain PHI:**",
            "- Ticket creation logs ticket_id and provider_id but NOT description content.",
            "- Search query logs the query but NOT search results content.",
            "- Error logs are generic — no ticket descriptions or context_metadata.",
            "",
            "**Support-specific leakage vectors:**",
            "- GET /support/tickets/:id → returns description and context_metadata (intentional — physician's own data). Verify screenshot_path is excluded.",
            "- GET /support/tickets → list view returns subject and status only, NOT full description (minimize PHI in list responses).",
            "- Confirmation email contains ticket_id and subject only — NOT description or context_metadata.",
            "- Status change notification contains ticket_id and new status — NOT resolution_notes in email.",
            "",
            "**Public help endpoint leakage:**",
            "- GET /help/articles → returns article content only. No user data, no session data, no feedback attribution.",
            "- Article feedback endpoint response confirms action but doesn't reveal other physicians' feedback."
          ],
          "security": [
            "Ticket list returns minimal data (subject, status) — full description only in detail view.",
            "Emails contain ticket reference only — no PHI in email body.",
            "screenshot_path is the most sensitive field — never exposed in any response.",
            "Public help endpoints must not leak any user or session data."
          ]
        },
        {
          "id": "D13-045",
          "description": "Security: audit trail completeness — all events logged, append-only",
          "verify": "pnpm --filter api vitest run test/security/support/support.audit.security.ts",
          "depends": ["D13-030", "D13-031"],
          "build": [
            "Create `apps/api/test/security/support/support.audit.security.ts`.",
            "",
            "**Verify all audit events are logged:**",
            "",
            "1. support.ticket_created: Create ticket → audit entry with ticket_id, provider_id, priority, actor identity.",
            "2. support.ticket_updated: Admin updates ticket → audit entry with ticket_id, changed fields, actor identity.",
            "3. support.ticket_resolved: Ticket resolved → audit entry with ticket_id, resolved_at, actor identity.",
            "4. support.ticket_closed: Ticket closed → audit entry with ticket_id, actor identity.",
            "5. support.ticket_rated: Submit rating → audit entry with ticket_id, rating value, provider_id.",
            "6. support.article_viewed: View article → audit entry with article slug, provider_id. Rate-limited.",
            "7. support.article_feedback: Submit feedback → audit entry with article_id, is_helpful, provider_id.",
            "8. support.help_searched: Search help → audit entry with search query (sanitised), provider_id. Rate-limited.",
            "",
            "**Audit integrity:**",
            "- Audit entries are append-only. No UPDATE or DELETE on audit log table.",
            "- Each audit entry includes actor_id, actor_role, action, resource_id, timestamp, and details JSONB.",
            "",
            "**Delegate audit:**",
            "- Delegate creates ticket → audit shows delegate as actor, physician as context.",
            "- Delegate submits article feedback → audit shows delegate identity.",
            "",
            "**Rate-limited audit:**",
            "- article_viewed: max 1 per article per physician per 5 minutes.",
            "- help_searched: max 1 per physician per minute.",
            "",
            "**Audit must NOT contain:**",
            "- Ticket description content (PHI risk).",
            "- Screenshot file content.",
            "- Search result content."
          ],
          "security": [
            "Append-only audit log — no UPDATE or DELETE.",
            "Audit entries reference ticket_id, not ticket content — avoids PHI in audit logs.",
            "Rate-limited help search and article view audits prevent noise.",
            "Search queries logged but sanitised — no raw user input with injection payloads."
          ]
        }
      ]
    },
    {
      "title": "Domain 13: Support System — Final Validation",
      "tasks": [
        {
          "id": "D13-099",
          "description": "Full domain test suite: all unit + integration + security tests",
          "verify": "pnpm --filter api vitest run src/domains/support/ test/integration/support/ test/security/support/",
          "depends": [
            "D13-040",
            "D13-041",
            "D13-042",
            "D13-043",
            "D13-044",
            "D13-045"
          ],
          "build": [
            "Run the complete test suite for Domain 13 Support System. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/support/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/support/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/support/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/support/ test/integration/support/ test/security/support/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/support/support.authn.security.ts",
            "- test/security/support/support.authz.security.ts",
            "- test/security/support/support.scoping.security.ts",
            "- test/security/support/support.input.security.ts",
            "- test/security/support/support.leakage.security.ts",
            "- test/security/support/support.audit.security.ts",
            "",
            "Verify all Domain 13 API endpoints are registered and reachable:",
            "- 2 public help endpoints (GET articles, GET article by slug)",
            "- 1 authenticated help endpoint (POST feedback)",
            "- 4 ticket endpoints (POST create, GET list, GET detail, POST rating)",
            "",
            "Total: 7 routes (2 public + 5 authenticated), 3 DB tables, 6 security test suites.",
            "",
            "This is the FINAL domain in the Meritum build. All 14 domains are now complete."
          ]
        }
      ]
    }
  ]
}
