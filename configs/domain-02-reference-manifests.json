{
  "domainNumber": "02",
  "domainName": "Reference Data",
  "manifestFile": "domain-02-reference.tasks",
  "promptPrefix": "d02",
  "modulePath": "apps/api/src/domains/reference",
  "sections": [
    {
      "title": "Domain 2: Reference Data — Shared Types & Constants",
      "tasks": [
        {
          "id": "D02-001",
          "description": "Reference data constants: data set enums, fee types, rule categories, modifier types, facility types",
          "verify": "pnpm --filter shared build",
          "build": [
            "Create `packages/shared/src/constants/reference.constants.ts` with all Reference Data constants:",
            "",
            "**Data set identifiers enum:**",
            "- SOMB, WCB, MODIFIERS, GOVERNING_RULES, FUNCTIONAL_CENTRES, DI_CODES, RRNP, PCPCM, EXPLANATORY_CODES",
            "",
            "**Fee types enum:** fixed, calculated, time_based, unit_based, report_based",
            "**Modifier types enum:** explicit, implicit, semi_implicit",
            "**Modifier calculation methods enum:** percentage, fixed_amount, time_based_units, multiplier, none",
            "",
            "**Rule categories enum:** visit_limits, code_combinations, modifier_rules, referral_rules, facility_rules, surcharge_rules, time_rules, general",
            "**Rule severities enum:** error, warning, info",
            "",
            "**Facility types enum:** office, hospital_inpatient, hospital_outpatient, emergency, auxiliary_hospital, nursing_home, telehealth, community_health, other",
            "**PCPCM basket types enum:** in_basket, out_of_basket, facility, not_applicable",
            "**Holiday jurisdictions enum:** provincial, federal, both",
            "**Explanatory code severities enum:** paid, adjusted, rejected",
            "",
            "**Staging statuses enum:** UPLOADED, VALIDATED, DIFF_GENERATED, PUBLISHED, DISCARDED",
            "",
            "**Version event types:** VERSION_PUBLISHED, CODE_DEPRECATED, HOLIDAY_CALENDAR_REMINDER",
            "",
            "**Audit action identifiers for Reference Data:**",
            "- ref.version_staged, ref.version_diff_reviewed, ref.version_published, ref.version_rolled_back",
            "- ref.staging_discarded, ref.rule_dry_run",
            "- ref.holiday_created, ref.holiday_updated, ref.holiday_deleted",
            "",
            "Export all as frozen objects / TypeScript enums."
          ],
          "frd": [
            "Domain 2 Section 2: Nine versioned data sets. Section 2.3: Three modifier types, five calculation methods. Section 2.4: Eight rule categories, three severities.",
            "Domain 2 Section 8.2: Nine audit action types for reference data operations."
          ]
        },
        {
          "id": "D02-002",
          "description": "Drizzle schema for reference_data_versions and hsc_codes tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D02-001"],
          "build": [
            "Create `packages/shared/src/schemas/db/reference.schema.ts` with version management and SOMB tables.",
            "",
            "**reference_data_versions table:**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| version_id | UUID | PK |",
            "| data_set | VARCHAR(30) | NOT NULL (enum) |",
            "| version_label | VARCHAR(50) | NOT NULL |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE (NULL = current) |",
            "| published_by | UUID FK | NOT NULL, FK → users |",
            "| published_at | TIMESTAMPTZ | NOT NULL |",
            "| source_document | TEXT | NULLABLE |",
            "| change_summary | TEXT | NULLABLE |",
            "| records_added | INTEGER | NOT NULL, DEFAULT 0 |",
            "| records_modified | INTEGER | NOT NULL, DEFAULT 0 |",
            "| records_deprecated | INTEGER | NOT NULL, DEFAULT 0 |",
            "| is_active | BOOLEAN | NOT NULL, DEFAULT false |",
            "",
            "Indexes: (data_set, is_active), (data_set, effective_from DESC). Constraint: at most one is_active=true per data_set.",
            "",
            "**hsc_codes table (~6,000+ records):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| hsc_code | VARCHAR(10) | NOT NULL |",
            "| description | TEXT | NOT NULL |",
            "| base_fee | DECIMAL(10,2) | NULLABLE (NULL for calculated codes) |",
            "| fee_type | VARCHAR(20) | NOT NULL (fixed, calculated, time_based, unit_based) |",
            "| specialty_restrictions | JSONB | NOT NULL, DEFAULT '[]' |",
            "| facility_restrictions | JSONB | NOT NULL, DEFAULT '[]' |",
            "| max_per_day | INTEGER | NULLABLE |",
            "| max_per_visit | INTEGER | NULLABLE |",
            "| requires_referral | BOOLEAN | NOT NULL, DEFAULT false |",
            "| referral_validity_days | INTEGER | NULLABLE |",
            "| combination_group | VARCHAR(20) | NULLABLE |",
            "| modifier_eligibility | JSONB | NOT NULL, DEFAULT '[]' |",
            "| surcharge_eligible | BOOLEAN | NOT NULL, DEFAULT false |",
            "| pcpcm_basket | VARCHAR(20) | NOT NULL, DEFAULT 'not_applicable' |",
            "| shadow_billing_eligible | BOOLEAN | NOT NULL, DEFAULT false |",
            "| notes | TEXT | NULLABLE |",
            "| help_text | TEXT | NULLABLE |",
            "| version_id | UUID FK | NOT NULL, FK → reference_data_versions |",
            "| effective_from | DATE | NOT NULL (denormalised) |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (hsc_code, version_id), (version_id), GIN index on description for full-text search, pg_trgm index on hsc_code and description for fuzzy search.",
            "",
            "Export tables and inferred types."
          ],
          "security": [
            "reference_data_versions enforces single active version per data_set via partial unique index or application-level check.",
            "Published versions are immutable — records cannot be edited after publication. Corrections require a new version."
          ],
          "frd": [
            "Domain 2 Section 1.5: Effective-date versioning. Each data set has versions table. Queries filter by version effective on date of service.",
            "Domain 2 Section 2.1: SOMB fee schedule with 20 fields per HSC record. ~6,000+ records."
          ]
        },
        {
          "id": "D02-003",
          "description": "Drizzle schema for wcb_codes and modifier_definitions tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D02-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/reference.schema.ts`:",
            "",
            "**wcb_codes table (~500–1,000 records):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| wcb_code | VARCHAR(10) | NOT NULL |",
            "| description | TEXT | NOT NULL |",
            "| base_fee | DECIMAL(10,2) | NOT NULL |",
            "| fee_type | VARCHAR(20) | NOT NULL |",
            "| requires_claim_number | BOOLEAN | NOT NULL, DEFAULT true |",
            "| requires_employer | BOOLEAN | NOT NULL, DEFAULT false |",
            "| documentation_requirements | TEXT | NULLABLE |",
            "| help_text | TEXT | NULLABLE |",
            "| version_id | UUID FK | NOT NULL, FK → reference_data_versions |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (wcb_code, version_id), pg_trgm on wcb_code and description.",
            "",
            "**modifier_definitions table (~15–20 modifiers):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| modifier_code | VARCHAR(10) | NOT NULL |",
            "| name | VARCHAR(100) | NOT NULL |",
            "| description | TEXT | NOT NULL |",
            "| type | VARCHAR(20) | NOT NULL (explicit, implicit, semi_implicit) |",
            "| calculation_method | VARCHAR(20) | NOT NULL |",
            "| calculation_params | JSONB | NOT NULL, DEFAULT '{}' |",
            "| applicable_hsc_filter | JSONB | NOT NULL, DEFAULT '{}' |",
            "| requires_time_documentation | BOOLEAN | NOT NULL, DEFAULT false |",
            "| requires_facility | BOOLEAN | NOT NULL, DEFAULT false |",
            "| combinable_with | JSONB | NOT NULL, DEFAULT '[]' |",
            "| exclusive_with | JSONB | NOT NULL, DEFAULT '[]' |",
            "| governing_rule_reference | VARCHAR(20) | NULLABLE |",
            "| help_text | TEXT | NULLABLE |",
            "| version_id | UUID FK | NOT NULL, FK → reference_data_versions |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (modifier_code, version_id).",
            "",
            "Export all tables and inferred types."
          ],
          "frd": [
            "Domain 2 Section 2.2: WCB fee schedule with 11 fields. ~500–1,000 records.",
            "Domain 2 Section 2.3: Modifier definitions with 16 fields. ~15–20 modifiers including CMGP, LSCD, AFHR, BCP, RRNP, TM, ANE, AST, age modifiers."
          ]
        },
        {
          "id": "D02-004",
          "description": "Drizzle schema for governing_rules and functional_centres tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D02-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/reference.schema.ts`:",
            "",
            "**governing_rules table (~50–80 rules):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| rule_id | VARCHAR(20) | NOT NULL (e.g., GR3, GR5_3b, SURCHG_1399H) |",
            "| rule_name | VARCHAR(200) | NOT NULL |",
            "| rule_category | VARCHAR(30) | NOT NULL (enum) |",
            "| description | TEXT | NOT NULL |",
            "| rule_logic | JSONB | NOT NULL (machine-readable rule definition) |",
            "| severity | VARCHAR(10) | NOT NULL (error, warning, info) |",
            "| error_message | TEXT | NOT NULL |",
            "| help_text | TEXT | NULLABLE |",
            "| source_reference | VARCHAR(100) | NULLABLE |",
            "| source_url | TEXT | NULLABLE |",
            "| version_id | UUID FK | NOT NULL, FK → reference_data_versions |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (rule_id, version_id), (rule_category, version_id).",
            "",
            "**functional_centres table (~2,000–3,000 records):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| code | VARCHAR(10) | NOT NULL |",
            "| name | VARCHAR(200) | NOT NULL |",
            "| facility_type | VARCHAR(30) | NOT NULL (enum) |",
            "| location_city | VARCHAR(100) | NULLABLE |",
            "| location_region | VARCHAR(50) | NULLABLE |",
            "| rrnp_community_id | UUID | NULLABLE, FK → rrnp_communities |",
            "| active | BOOLEAN | NOT NULL, DEFAULT true |",
            "| version_id | UUID FK | NOT NULL, FK → reference_data_versions |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (code, version_id), (facility_type, version_id).",
            "",
            "Export all tables and inferred types."
          ],
          "frd": [
            "Domain 2 Section 2.4: Governing rules with 12 fields. ~50–80 rules across GR 1–13 + surcharge rules. Rule_logic JSONB follows strict schema per rule_category.",
            "Domain 2 Section 2.5: Functional centres with 10 fields. ~2,000–3,000 codes."
          ]
        },
        {
          "id": "D02-005",
          "description": "Drizzle schema for di_codes, rrnp_communities, and pcpcm_baskets tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D02-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/reference.schema.ts`:",
            "",
            "**di_codes table (~14,000 records):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| di_code | VARCHAR(10) | NOT NULL |",
            "| description | TEXT | NOT NULL |",
            "| category | VARCHAR(100) | NOT NULL |",
            "| subcategory | VARCHAR(100) | NULLABLE |",
            "| qualifies_surcharge | BOOLEAN | NOT NULL, DEFAULT false (Attachment G) |",
            "| qualifies_bcp | BOOLEAN | NOT NULL, DEFAULT false |",
            "| common_in_specialty | JSONB | NOT NULL, DEFAULT '[]' |",
            "| help_text | TEXT | NULLABLE |",
            "| version_id | UUID FK | NOT NULL |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (di_code, version_id), pg_trgm on di_code and description, GIN on description.",
            "",
            "**rrnp_communities table (~100–200 records):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| community_id | UUID | PK |",
            "| community_name | VARCHAR(200) | NOT NULL |",
            "| rrnp_percentage | DECIMAL(5,2) | NOT NULL |",
            "| rrnp_tier | VARCHAR(20) | NULLABLE |",
            "| region | VARCHAR(100) | NULLABLE |",
            "| version_id | UUID FK | NOT NULL |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (community_name, version_id).",
            "",
            "**pcpcm_baskets table (~3,000–4,000 records):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| hsc_code | VARCHAR(10) | NOT NULL |",
            "| basket | VARCHAR(20) | NOT NULL (in_basket, out_of_basket, facility) |",
            "| notes | TEXT | NULLABLE |",
            "| version_id | UUID FK | NOT NULL |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (hsc_code, version_id).",
            "",
            "Export all tables and inferred types."
          ],
          "frd": [
            "Domain 2 Section 2.6: DI codes ~14,000 with surcharge/BCP flags. Section 2.7: RRNP ~100–200 communities with percentage rates. Section 2.8: PCPCM ~3,000–4,000 HSC classifications."
          ]
        },
        {
          "id": "D02-006",
          "description": "Drizzle schema for statutory_holidays, explanatory_codes, and reference_data_staging tables",
          "verify": "pnpm --filter shared build",
          "depends": ["D02-002"],
          "build": [
            "Add to `packages/shared/src/schemas/db/reference.schema.ts`:",
            "",
            "**statutory_holidays table (not versioned — date-specific):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| holiday_id | UUID | PK |",
            "| date | DATE | NOT NULL |",
            "| name | VARCHAR(100) | NOT NULL |",
            "| jurisdiction | VARCHAR(20) | NOT NULL (provincial, federal, both) |",
            "| affects_billing_premiums | BOOLEAN | NOT NULL, DEFAULT true |",
            "| year | INTEGER | NOT NULL |",
            "",
            "Indexes: unique on date, (year).",
            "",
            "**explanatory_codes table (~100–200 records):**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| id | UUID | PK |",
            "| expl_code | VARCHAR(10) | NOT NULL |",
            "| description | TEXT | NOT NULL |",
            "| severity | VARCHAR(10) | NOT NULL (paid, adjusted, rejected) |",
            "| common_cause | TEXT | NULLABLE (Meritum-authored) |",
            "| suggested_action | TEXT | NULLABLE (Meritum-authored) |",
            "| help_text | TEXT | NULLABLE |",
            "| version_id | UUID FK | NOT NULL |",
            "| effective_from | DATE | NOT NULL |",
            "| effective_to | DATE | NULLABLE |",
            "",
            "Indexes: (expl_code, version_id).",
            "",
            "**reference_data_staging table:**",
            "",
            "| Column | Type | Constraints |",
            "|--------|------|-------------|",
            "| staging_id | UUID | PK |",
            "| data_set | VARCHAR(30) | NOT NULL |",
            "| status | VARCHAR(20) | NOT NULL, DEFAULT 'uploaded' |",
            "| uploaded_by | UUID FK | NOT NULL, FK → users |",
            "| uploaded_at | TIMESTAMPTZ | NOT NULL |",
            "| file_hash | VARCHAR(64) | NOT NULL (SHA-256 of uploaded file) |",
            "| record_count | INTEGER | NOT NULL |",
            "| validation_result | JSONB | NULLABLE |",
            "| diff_result | JSONB | NULLABLE |",
            "| staged_data | JSONB | NOT NULL (the parsed records) |",
            "| created_at | TIMESTAMPTZ | NOT NULL |",
            "",
            "Indexes: (data_set, status).",
            "",
            "Export all tables and inferred types."
          ],
          "frd": [
            "Domain 2 Section 2.9: Statutory holidays — 11 Alberta holidays. Not versioned, date-specific.",
            "Domain 2 Section 2.10: Explanatory codes with severity, common cause, suggested action.",
            "Domain 2 Section 6.2: Staging workflow — data uploaded to staging, validated, diff generated, then published or discarded."
          ]
        },
        {
          "id": "D02-007",
          "description": "Zod validation schemas for search, lookup, and public endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D02-001"],
          "build": [
            "Create `packages/shared/src/schemas/reference.schema.ts` with Zod schemas for user-facing endpoints:",
            "",
            "**HSC search:** hscSearchSchema: { q: string().min(1).max(100), specialty: string().optional(), facility: string().optional(), date: string().date().optional(), limit: number().int().min(1).max(50).default(10) }",
            "**HSC detail:** hscDetailParamSchema: { code: string().max(10) }, hscDetailQuerySchema: { date: string().date().optional() }",
            "**HSC favourites:** no params",
            "",
            "**DI search:** diSearchSchema: { q: string().min(1).max(100), specialty: string().optional(), limit: number().int().min(1).max(50).default(10) }",
            "**DI detail:** diDetailParamSchema: { code: string().max(10) }",
            "",
            "**Modifier lookup:** modifierLookupSchema: { hsc: string().max(10).optional(), date: string().date().optional() }",
            "**Modifier detail:** modifierDetailParamSchema: { code: string().max(10) }",
            "",
            "**Functional centres:** fcListSchema: { facility_type: string().optional() }",
            "**Explanatory code:** explCodeParamSchema: { code: string().max(10) }",
            "**RRNP lookup:** rrnpLookupSchema: { date: string().date().optional() }, rrnpParamSchema: { community_id: string().uuid() }",
            "**PCPCM lookup:** pcpcmLookupSchema: { date: string().date().optional() }, pcpcmParamSchema: { hsc_code: string().max(10) }",
            "**Holiday list:** holidayListSchema: { year: number().int().min(2020).max(2100) }",
            "**Holiday check:** holidayCheckSchema: { date: string().date() }",
            "",
            "**Change summaries:** changeListSchema: { dataset: string().optional(), since: string().date().optional() }",
            "**Change detail:** changeDetailParamSchema: { version_id: string().uuid() }, changeDetailQuerySchema: { specialty: string().optional() }",
            "",
            "Export all schemas and inferred TypeScript types."
          ],
          "frd": [
            "Domain 2 Section 4.1: 13 search/lookup endpoints. Section 4.4: 3 change summary endpoints. All require date-of-service parameter for version awareness."
          ]
        },
        {
          "id": "D02-008",
          "description": "Zod validation schemas for admin data management and internal validation endpoints",
          "verify": "pnpm --filter shared build",
          "depends": ["D02-001"],
          "build": [
            "Add to `packages/shared/src/schemas/reference.schema.ts`:",
            "",
            "**Admin upload:** adminUploadParamSchema: { dataset: enum(DATA_SETS) }",
            "**Admin staging:** adminStagingParamSchema: { dataset: enum(DATA_SETS), id: string().uuid() }",
            "**Admin publish:** adminPublishSchema: { version_label: string().min(1).max(50), effective_from: string().date(), source_document: string().optional(), change_summary: string().optional() }",
            "**Admin version list:** adminVersionListSchema: { dataset: enum(DATA_SETS) }",
            "",
            "**Admin holidays:**",
            "- createHolidaySchema: { date: string().date(), name: string().min(1).max(100), jurisdiction: enum('provincial', 'federal', 'both'), affects_billing_premiums: boolean().default(true) }",
            "- updateHolidaySchema: { date: string().date().optional(), name: string().min(1).max(100).optional(), jurisdiction: enum('provincial', 'federal', 'both').optional(), affects_billing_premiums: boolean().optional() }",
            "- holidayParamSchema: { id: string().uuid() }",
            "",
            "**Admin dry-run:** dryRunSchema: { updated_rule_logic: object() }, dryRunParamSchema: { rule_id: string().max(20) }",
            "",
            "**Internal validation:**",
            "- validateContextSchema: { hsc: array(string()).min(1), di: string().optional(), facility: string().optional(), date: string().date(), modifiers: array(string()).optional() }",
            "- evaluateBatchSchema: { claims: array(object()).min(1).max(500) }",
            "- ruleDetailSchema: { rule_id: string().max(20) }, ruleDetailQuerySchema: { date: string().date().optional() }",
            "- versionQuerySchema: { date: string().date() }",
            "",
            "Export all schemas and inferred types."
          ],
          "frd": [
            "Domain 2 Section 4.2: 4 internal validation endpoints. Section 4.3: 9 admin data management endpoints."
          ]
        },
        {
          "id": "D02-009",
          "description": "Generate and apply database migration for all Reference Data tables",
          "verify": "cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1",
          "depends": ["D02-002", "D02-003", "D02-004", "D02-005", "D02-006"],
          "build": [
            "Run the Drizzle migration generator for all Reference Data tables:",
            "",
            "```bash",
            "cd apps/api",
            "pnpm drizzle-kit generate",
            "pnpm drizzle-kit migrate",
            "```",
            "",
            "Verify migration file created in `apps/api/drizzle/migrations/`.",
            "Verify all 11 tables exist: reference_data_versions, hsc_codes, wcb_codes, modifier_definitions, governing_rules, functional_centres, di_codes, rrnp_communities, pcpcm_baskets, statutory_holidays, explanatory_codes, reference_data_staging.",
            "Verify pg_trgm extension is enabled (CREATE EXTENSION IF NOT EXISTS pg_trgm).",
            "Verify GIN and pg_trgm indexes on hsc_codes.description, di_codes.description.",
            "Verify all FK relationships and constraints.",
            "Verify partial unique index or constraint for single active version per data_set."
          ]
        }
      ]
    },
    {
      "title": "Domain 2: Reference Data — Repository Layer",
      "tasks": [
        {
          "id": "D02-010",
          "description": "Repository: version management and HSC code queries (version-aware)",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-009"],
          "build": [
            "Create `apps/api/src/domains/reference/reference.repository.ts` with version and HSC operations:",
            "",
            "**Version management:**",
            "- `findActiveVersion(dataSet: string)` — find the currently active version for a data set.",
            "- `findVersionForDate(dataSet: string, date: Date)` — find the version effective on a specific date (effective_from <= date AND (effective_to IS NULL OR effective_to > date)).",
            "- `listVersions(dataSet: string)` — list all versions for a data set, reverse chronological.",
            "- `createVersion(data: InsertVersion)` — insert new version record.",
            "- `activateVersion(versionId: string, previousVersionId?: string)` — set is_active=true, set previous version's effective_to. Atomic transaction.",
            "- `deactivateVersion(versionId: string)` — rollback: set is_active=false.",
            "",
            "**HSC code queries:**",
            "- `searchHscCodes(query: string, versionId: string, filters?: { specialty?, facility? }, limit: number)` — full-text + pg_trgm search. Return: code, description, base_fee, help_text, deprecated flag.",
            "- `findHscByCode(hscCode: string, versionId: string)` — full detail including modifiers, restrictions, combination rules.",
            "- `listHscByVersion(versionId: string, pagination)` — all codes for a version (admin use).",
            "",
            "Create `apps/api/src/domains/reference/reference.test.ts` with unit tests."
          ],
          "security": [
            "findVersionForDate is the critical function — incorrect version selection means incorrect claim validation. Must handle boundary conditions precisely: claim on effective_from date uses new version, claim on day before uses old.",
            "activateVersion must be atomic: at no point should two versions be active simultaneously for the same data set."
          ],
          "tests": [
            "findActiveVersion returns the active version for data set",
            "findVersionForDate returns correct version for date within range",
            "findVersionForDate returns correct version at boundary (effective_from date)",
            "findVersionForDate returns previous version for day before effective_from",
            "activateVersion atomically swaps active version",
            "activateVersion sets previous version's effective_to",
            "searchHscCodes returns results for code prefix match",
            "searchHscCodes returns results for keyword match",
            "searchHscCodes filters by specialty",
            "searchHscCodes respects version_id (different versions return different results)",
            "findHscByCode returns full detail with modifiers"
          ]
        },
        {
          "id": "D02-011",
          "description": "Repository: WCB codes, modifier definitions, and governing rules queries",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-009"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.repository.ts`:",
            "",
            "**WCB codes:**",
            "- `searchWcbCodes(query: string, versionId: string, limit: number)` — full-text + pg_trgm search.",
            "- `findWcbByCode(wcbCode: string, versionId: string)` — full detail.",
            "",
            "**Modifier definitions:**",
            "- `findModifiersForHsc(hscCode: string, versionId: string)` — applicable modifiers based on applicable_hsc_filter matching.",
            "- `findModifierByCode(modifierCode: string, versionId: string)` — full detail.",
            "- `listAllModifiers(versionId: string)` — all modifiers for a version.",
            "",
            "**Governing rules:**",
            "- `findRulesForContext(hscCodes: string[], diCode: string | null, facilityType: string | null, versionId: string)` — return all rules applicable to a claim context. Filter by rule_category and code patterns in rule_logic.",
            "- `findRuleById(ruleId: string, versionId: string)` — full detail with rule_logic.",
            "- `listRulesByCategory(category: string, versionId: string)` — all rules in a category."
          ],
          "security": [
            "Rule_logic JSONB is data only — it is never evaluated in the Reference Data domain. The Claim Lifecycle validation engine evaluates it.",
            "Modifier applicability filtering must be accurate — incorrect modifiers on claims lead to rejections."
          ],
          "tests": [
            "searchWcbCodes returns results for code prefix",
            "searchWcbCodes returns results for keyword",
            "findModifiersForHsc returns applicable modifiers only",
            "findModifiersForHsc excludes incompatible modifiers",
            "findRulesForContext returns relevant rules for HSC codes",
            "findRulesForContext filters by category",
            "findRuleById returns full rule_logic JSON",
            "All queries respect version_id parameter"
          ]
        },
        {
          "id": "D02-012",
          "description": "Repository: DI codes, RRNP communities, PCPCM baskets, holidays, explanatory codes",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-009"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.repository.ts`:",
            "",
            "**DI codes:**",
            "- `searchDiCodes(query: string, versionId: string, filters?: { specialty? }, limit: number)` — search with specialty weighting.",
            "- `findDiByCode(diCode: string, versionId: string)` — full detail.",
            "",
            "**RRNP communities:**",
            "- `findRrnpRate(communityId: string, versionId: string)` — return community name and percentage.",
            "- `listRrnpCommunities(versionId: string)` — all communities.",
            "",
            "**PCPCM baskets:**",
            "- `findPcpcmBasket(hscCode: string, versionId: string)` — return basket classification.",
            "",
            "**Functional centres:**",
            "- `listFunctionalCentres(versionId: string, facilityType?: string)` — optionally filter by type.",
            "- `findFunctionalCentre(code: string, versionId: string)` — single centre detail.",
            "",
            "**Statutory holidays:**",
            "- `listHolidaysByYear(year: number)` — return all holidays for a year.",
            "- `isHoliday(date: Date)` — check if specific date is a holiday. Return { is_holiday, holiday_name? }.",
            "- `createHoliday(data)` — insert holiday. `updateHoliday(id, data)` — update. `deleteHoliday(id)` — remove.",
            "",
            "**Explanatory codes:**",
            "- `findExplanatoryCode(code: string, versionId: string)` — full detail with common_cause and suggested_action."
          ],
          "tests": [
            "searchDiCodes returns results weighted by specialty",
            "searchDiCodes flags surcharge and BCP qualifying codes",
            "findRrnpRate returns correct percentage for community",
            "findPcpcmBasket returns correct basket for HSC",
            "listFunctionalCentres filters by facility_type",
            "listHolidaysByYear returns all holidays for year",
            "isHoliday returns true for statutory holiday",
            "isHoliday returns false for regular day",
            "createHoliday inserts holiday",
            "findExplanatoryCode returns full detail"
          ]
        },
        {
          "id": "D02-013",
          "description": "Repository: admin staging operations (upload, diff, publish, rollback)",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-009", "D02-010"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.repository.ts`:",
            "",
            "**Staging operations:**",
            "- `createStagingRecord(data: { dataSet, uploadedBy, fileHash, recordCount, stagedData })` — insert staging record.",
            "- `findStagingById(stagingId: string)` — find staging record.",
            "- `updateStagingStatus(stagingId: string, status: string, result?: { validation_result?, diff_result? })` — update staging status and results.",
            "- `deleteStagingRecord(stagingId: string)` — discard staged data.",
            "- `listStagingByDataSet(dataSet: string)` — list pending staging records.",
            "",
            "**Bulk data operations (for publishing):**",
            "- `bulkInsertHscCodes(records: Array, versionId: string)` — batch insert HSC codes for a version.",
            "- `bulkInsertWcbCodes(records: Array, versionId: string)` — batch insert WCB codes.",
            "- `bulkInsertModifiers(records: Array, versionId: string)` — batch insert modifiers.",
            "- `bulkInsertRules(records: Array, versionId: string)` — batch insert governing rules.",
            "- `bulkInsertFunctionalCentres(records: Array, versionId: string)` — batch insert FCs.",
            "- `bulkInsertDiCodes(records: Array, versionId: string)` — batch insert DI codes.",
            "- `bulkInsertRrnpCommunities(records: Array, versionId: string)` — batch insert RRNP.",
            "- `bulkInsertPcpcmBaskets(records: Array, versionId: string)` — batch insert PCPCM.",
            "- `bulkInsertExplanatoryCodes(records: Array, versionId: string)` — batch insert.",
            "",
            "All bulk inserts run within a transaction. If any insert fails, the entire batch rolls back."
          ],
          "security": [
            "Staging data is isolated from live data — staged records are stored in JSONB, not the live tables.",
            "Bulk inserts must be transactional — partial publication is not acceptable.",
            "File hash (SHA-256) stored for integrity verification and deduplication."
          ],
          "tests": [
            "createStagingRecord stores staged data",
            "updateStagingStatus transitions correctly",
            "deleteStagingRecord removes record",
            "bulkInsertHscCodes inserts all records in transaction",
            "bulkInsertHscCodes rolls back on failure",
            "bulkInsertDiCodes handles 14,000+ records efficiently"
          ]
        }
      ]
    },
    {
      "title": "Domain 2: Reference Data — Service Layer",
      "tasks": [
        {
          "id": "D02-020",
          "description": "Service: HSC code search with version resolution and frequency weighting",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-010"],
          "build": [
            "Create `apps/api/src/domains/reference/reference.service.ts` with search functions:",
            "",
            "- `resolveVersion(dataSet: string, dateOfService?: Date)` — if date provided, find version effective on that date. If not, find active version. Throw if no version found.",
            "",
            "- `searchHscCodes(query: string, options: { specialty?, facility?, dateOfService?, limit? })` —",
            "  1. Resolve SOMB version for date of service.",
            "  2. Execute search via repository.",
            "  3. If physician context available: boost results by usage frequency (join to claim stats).",
            "  4. Mark deprecated codes (code exists in previous version but not current).",
            "  5. Return results: code, description, base_fee, help_text, deprecated flag with replacement suggestion.",
            "",
            "- `getHscDetail(hscCode: string, dateOfService?: Date)` — resolve version, return full HSC detail with applicable modifiers, restrictions, combination group, and help text.",
            "",
            "- `getHscFavourites(userId: string)` — return physician's top-N favourite codes by billing frequency. Recalculated from claim history.",
            "",
            "- `searchDiCodes(query: string, options: { specialty?, limit? })` — search DI codes with specialty weighting. Flag surcharge and BCP qualifiers.",
            "",
            "- `getDiDetail(diCode: string)` — full DI code detail.",
            "",
            "**Performance target:** <200ms for first page of search results."
          ],
          "security": [
            "Version resolution must use date of service, not current date. This is critical for correct claim validation across version boundaries.",
            "Search results must not leak data from versions the user shouldn't see (e.g., unpublished staging data)."
          ],
          "tests": [
            "resolveVersion returns correct version for date of service",
            "resolveVersion returns active version when no date specified",
            "resolveVersion throws when no version exists",
            "searchHscCodes returns version-appropriate results",
            "searchHscCodes marks deprecated codes with replacement",
            "searchHscCodes filters by specialty",
            "getHscDetail returns full detail with modifiers",
            "getHscFavourites returns frequency-ranked codes",
            "searchDiCodes flags surcharge and BCP qualifiers"
          ]
        },
        {
          "id": "D02-021",
          "description": "Service: modifier lookup, validation support, and governing rule queries",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-010", "D02-011"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.service.ts`:",
            "",
            "- `getModifiersForHsc(hscCode: string, dateOfService?: Date)` — resolve modifier version, return applicable modifiers with calculation details and help text.",
            "",
            "- `getModifierDetail(modifierCode: string)` — full modifier detail including combinable_with, exclusive_with.",
            "",
            "- `getValidationContext(hscCodes: string[], diCode: string | null, facilityCode: string | null, dateOfService: Date, modifiers?: string[])` — resolve all relevant versions. Return: applicable governing rules (with rule_logic), modifier applicability, combination restrictions, facility validation. This is the primary interface for Claim Lifecycle's validation engine.",
            "",
            "- `getRuleDetail(ruleId: string, dateOfService?: Date)` — full rule detail with rule_logic JSON.",
            "",
            "- `evaluateRulesBatch(claims: Array<ClaimContext>)` — for batch import: resolve versions and return all applicable rules per claim. Does NOT evaluate rules — just returns the rule data for Claim Lifecycle to evaluate.",
            "",
            "- `getRrnpRate(communityId: string, dateOfService?: Date)` — resolve version, return rate.",
            "- `getPcpcmBasket(hscCode: string, dateOfService?: Date)` — resolve version, return basket.",
            "- `isHoliday(date: Date)` — check statutory holiday calendar.",
            "- `getExplanatoryCode(code: string)` — return full detail with common cause and suggested action."
          ],
          "tests": [
            "getModifiersForHsc returns applicable modifiers only",
            "getModifiersForHsc excludes incompatible modifiers",
            "getValidationContext returns all rules for claim context",
            "getValidationContext resolves correct version for date",
            "evaluateRulesBatch handles multiple claims with different dates",
            "getRrnpRate returns correct rate for community and date",
            "getPcpcmBasket returns correct basket classification",
            "isHoliday correctly identifies Alberta statutory holidays",
            "getExplanatoryCode returns common cause and suggested action"
          ]
        },
        {
          "id": "D02-022",
          "description": "Service: admin data ingestion (upload, schema validation, diff generation)",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-010", "D02-013"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.service.ts`:",
            "",
            "- `uploadDataSet(adminUserId: string, dataSet: string, fileBuffer: Buffer, fileName: string)` —",
            "  1. Parse file (CSV or JSON). Determine format from content/extension.",
            "  2. Schema-validate each record against expected fields for the data set. Collect validation errors.",
            "  3. Compute SHA-256 hash of file for integrity.",
            "  4. Store in staging table with status=UPLOADED.",
            "  5. If validation errors: return errors with line numbers. Status=VALIDATED with errors.",
            "  6. If clean: auto-generate diff against active version. Status=DIFF_GENERATED.",
            "  7. Audit log: ref.version_staged.",
            "  8. Return { staging_id, validation_result, record_count }.",
            "",
            "- `getStagingDiff(adminUserId: string, dataSet: string, stagingId: string)` —",
            "  Generate or retrieve diff: { added: [...], modified: [...], deprecated: [...], summary_stats }.",
            "  Modified records include field-level changes highlighted.",
            "  Audit log: ref.version_diff_reviewed.",
            "",
            "- `discardStaging(adminUserId: string, dataSet: string, stagingId: string)` —",
            "  Delete staging record. Audit log: ref.staging_discarded.",
            "",
            "**Schema validation rules per data set:** Validate required fields, data types, code formats, non-negative fees, valid enums. Generate clear error messages with field and line number."
          ],
          "security": [
            "Uploaded files must be validated thoroughly — reject invalid data before it reaches staging.",
            "File hash prevents duplicate uploads and supports integrity verification.",
            "All staging operations are admin-only and audit-logged."
          ],
          "tests": [
            "uploadDataSet parses CSV correctly",
            "uploadDataSet parses JSON correctly",
            "uploadDataSet rejects invalid schema with line-specific errors",
            "uploadDataSet rejects negative fees",
            "uploadDataSet computes correct file hash",
            "getStagingDiff generates correct diff",
            "getStagingDiff highlights field-level changes",
            "discardStaging removes staging record",
            "All operations create audit log entries"
          ]
        },
        {
          "id": "D02-023",
          "description": "Service: admin publishing (stage → publish, rollback, event emission)",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-010", "D02-013", "D02-022"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.service.ts`:",
            "",
            "- `publishVersion(adminUserId: string, dataSet: string, stagingId: string, metadata: { versionLabel, effectiveFrom, sourceDocument?, changeSummary? })` —",
            "  1. Verify staging record exists and status is DIFF_GENERATED.",
            "  2. Create new version in reference_data_versions.",
            "  3. Bulk insert records from staging into live table (transactional).",
            "  4. Activate new version (set is_active, set previous version's effective_to).",
            "  5. Delete staging record.",
            "  6. Emit reference_data.version_published event for Notification Service.",
            "  7. If any deprecated codes were billed by physicians in last 12 months: emit reference_data.code_deprecated event.",
            "  8. Audit log: ref.version_published.",
            "  9. Return { version_id }.",
            "",
            "- `rollbackVersion(adminUserId: string, versionId: string, reason: string)` —",
            "  1. Deactivate current version.",
            "  2. Re-activate previous version (set previous effective_to back to NULL).",
            "  3. Audit log: ref.version_rolled_back.",
            "",
            "- `dryRunRule(adminUserId: string, ruleId: string, updatedRuleLogic: object)` —",
            "  Run updated rule logic against a sample of recent claims. Return { claims_affected, sample_results }.",
            "  Audit log: ref.rule_dry_run.",
            "",
            "**Large change safety gate:** If diff shows >500 modified records or >100 deprecated codes, require additional confirmation flag in publish request."
          ],
          "security": [
            "Publication is atomic — all records go live simultaneously or none do.",
            "Published versions are immutable. No editing individual records after publication.",
            "Rollback does not delete the erroneous version — it deactivates it and re-activates the previous version. Audit trail is preserved.",
            "Large change safety gate prevents accidental publication of corrupted data."
          ],
          "tests": [
            "publishVersion creates version and inserts all records",
            "publishVersion activates new version and deactivates old",
            "publishVersion emits version_published event",
            "publishVersion emits code_deprecated for billed codes",
            "publishVersion requires large-change confirmation when threshold exceeded",
            "rollbackVersion re-activates previous version",
            "rollbackVersion preserves deactivated version for audit",
            "dryRunRule returns affected claims count",
            "Publication is atomic — failure rolls back all inserts"
          ]
        },
        {
          "id": "D02-024",
          "description": "Service: holiday management, change summaries, and contextual help",
          "verify": "pnpm --filter api vitest run src/domains/reference/reference.test.ts",
          "depends": ["D02-012"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.service.ts`:",
            "",
            "**Holiday management (admin):**",
            "- `createHoliday(adminUserId: string, data)` — create holiday. Audit log: ref.holiday_created.",
            "- `updateHoliday(adminUserId: string, holidayId: string, data)` — update. Audit log: ref.holiday_updated.",
            "- `deleteHoliday(adminUserId: string, holidayId: string)` — delete. Audit log: ref.holiday_deleted.",
            "- `listHolidays(year: number)` — list holidays for year.",
            "- `checkHolidayCalendarPopulated(nextYear: number)` — return boolean. Used by annual November reminder.",
            "",
            "**Change summaries:**",
            "- `getChangeSummaries(dataSet?: string, sinceDate?: Date)` — list version publications with change stats.",
            "- `getChangeDetail(versionId: string, specialty?: string)` — detailed diff filtered by specialty. Show relevant code changes.",
            "- `getPhysicianImpact(versionId: string, userId: string)` — personalised impact: deprecated codes the physician has billed, fee changes on frequently-used codes, new relevant codes.",
            "",
            "**Contextual help:**",
            "- Help text is served as part of existing endpoints (included in HSC detail, modifier detail, rule detail, etc.). No separate help endpoint needed.",
            "- All help_text fields are included in search results and detail responses."
          ],
          "tests": [
            "createHoliday inserts holiday with audit log",
            "updateHoliday modifies holiday fields",
            "deleteHoliday removes holiday with audit log",
            "listHolidays returns correct holidays for year",
            "checkHolidayCalendarPopulated detects missing next year",
            "getChangeSummaries filters by data set and date",
            "getChangeDetail filters by specialty",
            "getPhysicianImpact highlights deprecated codes the physician used"
          ]
        }
      ]
    },
    {
      "title": "Domain 2: Reference Data — Middleware & Routes",
      "tasks": [
        {
          "id": "D02-030",
          "description": "Routes: search and lookup endpoints (13 public user-facing routes)",
          "verify": "pnpm --filter api vitest run test/integration/reference/",
          "depends": ["D02-020", "D02-021", "D02-024"],
          "build": [
            "Create `apps/api/src/domains/reference/reference.routes.ts` and `apps/api/src/domains/reference/reference.handlers.ts`.",
            "",
            "**Search & lookup routes (auth required, active subscription):**",
            "- GET /api/v1/ref/hsc/search → searchHscHandler (query: hscSearchSchema)",
            "- GET /api/v1/ref/hsc/favourites → hscFavouritesHandler",
            "- GET /api/v1/ref/hsc/:code → hscDetailHandler (params: hscDetailParamSchema, query: hscDetailQuerySchema)",
            "- GET /api/v1/ref/di/search → searchDiHandler (query: diSearchSchema)",
            "- GET /api/v1/ref/di/:code → diDetailHandler",
            "- GET /api/v1/ref/modifiers → modifierListHandler (query: modifierLookupSchema)",
            "- GET /api/v1/ref/modifiers/:code → modifierDetailHandler",
            "- GET /api/v1/ref/functional-centres → fcListHandler (query: fcListSchema)",
            "- GET /api/v1/ref/explanatory-codes/:code → explCodeHandler",
            "- GET /api/v1/ref/rrnp/:community_id → rrnpHandler (query with date)",
            "- GET /api/v1/ref/pcpcm/:hsc_code → pcpcmHandler (query with date)",
            "- GET /api/v1/ref/holidays → holidayListHandler (query: holidayListSchema)",
            "- GET /api/v1/ref/holidays/check → holidayCheckHandler (query: holidayCheckSchema)",
            "",
            "Create `apps/api/test/integration/reference/search.integration.ts`."
          ],
          "security": [
            "All search/lookup routes require authentication and active subscription.",
            "Version-aware routes must use the date query parameter, not the current date.",
            "Search results must not include data from unpublished staging versions."
          ],
          "tests": [
            "GET /ref/hsc/search returns HSC results for keyword",
            "GET /ref/hsc/search returns version-appropriate results for date param",
            "GET /ref/hsc/:code returns full HSC detail",
            "GET /ref/di/search returns DI results with surcharge flags",
            "GET /ref/modifiers returns applicable modifiers for HSC",
            "GET /ref/rrnp/:id returns RRNP rate for community",
            "GET /ref/pcpcm/:code returns basket classification",
            "GET /ref/holidays returns holidays for year",
            "GET /ref/holidays/check correctly identifies holiday",
            "All routes return 401 without auth"
          ]
        },
        {
          "id": "D02-031",
          "description": "Routes: admin data management endpoints (upload, diff, publish, holidays)",
          "verify": "pnpm --filter api vitest run test/integration/reference/",
          "depends": ["D02-022", "D02-023", "D02-024"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.routes.ts` and handlers:",
            "",
            "**Admin data management routes (admin role required):**",
            "- POST /api/v1/admin/ref/:dataset/upload → uploadHandler (multipart file)",
            "- GET /api/v1/admin/ref/:dataset/staging/:id/diff → diffHandler",
            "- POST /api/v1/admin/ref/:dataset/staging/:id/publish → publishHandler (body: adminPublishSchema)",
            "- DELETE /api/v1/admin/ref/:dataset/staging/:id → discardStagingHandler",
            "- GET /api/v1/admin/ref/:dataset/versions → listVersionsHandler",
            "- POST /api/v1/admin/ref/holidays → createHolidayHandler (body: createHolidaySchema)",
            "- PUT /api/v1/admin/ref/holidays/:id → updateHolidayHandler (body: updateHolidaySchema)",
            "- DELETE /api/v1/admin/ref/holidays/:id → deleteHolidayHandler",
            "- POST /api/v1/admin/ref/rules/:rule_id/dry-run → dryRunHandler (body: dryRunSchema)",
            "",
            "**File upload:** Use @fastify/multipart for file uploads. Accept CSV and JSON. Max file size: 50MB.",
            "",
            "Create `apps/api/test/integration/reference/admin.integration.ts`."
          ],
          "security": [
            "All admin routes require admin role. Physician and delegate roles get 403.",
            "File uploads validated for size (50MB max), content type, and schema before staging.",
            "Publication requires diff review step — cannot publish directly from upload."
          ],
          "tests": [
            "POST /admin/ref/somb/upload accepts CSV file",
            "POST /admin/ref/somb/upload accepts JSON file",
            "POST /admin/ref/somb/upload rejects invalid schema",
            "GET /admin/ref/somb/staging/:id/diff returns diff",
            "POST /admin/ref/somb/staging/:id/publish creates live version",
            "DELETE /admin/ref/somb/staging/:id discards staged data",
            "POST /admin/ref/holidays creates holiday",
            "POST /admin/ref/rules/:id/dry-run returns affected claims",
            "All admin routes reject non-admin users"
          ]
        },
        {
          "id": "D02-032",
          "description": "Routes: internal validation endpoints and change summary endpoints",
          "verify": "pnpm --filter api vitest run test/integration/reference/",
          "depends": ["D02-021", "D02-024"],
          "build": [
            "Add to `apps/api/src/domains/reference/reference.routes.ts` and handlers:",
            "",
            "**Internal validation routes (internal service-to-service, auth required):**",
            "- GET /api/v1/ref/rules/validate-context → validateContextHandler (query: validateContextSchema)",
            "- GET /api/v1/ref/rules/:rule_id → ruleDetailHandler (query: ruleDetailQuerySchema)",
            "- GET /api/v1/ref/somb/version → sombVersionHandler (query: versionQuerySchema)",
            "- POST /api/v1/ref/rules/evaluate-batch → evaluateBatchHandler (body: evaluateBatchSchema)",
            "",
            "**Change summary routes (auth required, active subscription):**",
            "- GET /api/v1/ref/changes → changeSummaryListHandler (query: changeListSchema)",
            "- GET /api/v1/ref/changes/:version_id/detail → changeDetailHandler (query: changeDetailQuerySchema)",
            "- GET /api/v1/ref/changes/:version_id/physician-impact → physicianImpactHandler",
            "",
            "Create `apps/api/test/integration/reference/validation.integration.ts` and `changes.integration.ts`."
          ],
          "security": [
            "Internal validation routes are authenticated but available to all roles (consumed by other domains).",
            "evaluate-batch limited to 500 claims per request to prevent DoS.",
            "physician-impact endpoint scoped to the authenticated user — no cross-user data."
          ],
          "tests": [
            "GET /ref/rules/validate-context returns applicable rules for claim",
            "GET /ref/rules/:id returns full rule with rule_logic",
            "GET /ref/somb/version returns version for date",
            "POST /ref/rules/evaluate-batch handles multiple claims",
            "POST /ref/rules/evaluate-batch rejects > 500 claims",
            "GET /ref/changes returns version publications",
            "GET /ref/changes/:id/detail filters by specialty",
            "GET /ref/changes/:id/physician-impact returns personalised data"
          ]
        }
      ]
    },
    {
      "title": "Domain 2: Reference Data — Security Tests",
      "tasks": [
        {
          "id": "D02-040",
          "description": "Security: authentication enforcement on every route",
          "verify": "pnpm --filter api vitest run test/security/reference/reference.authn.security.ts",
          "depends": ["D02-030", "D02-031", "D02-032"],
          "build": [
            "Create `apps/api/test/security/reference/reference.authn.security.ts`.",
            "",
            "Test every route in Reference Data returns 401 without valid session cookie:",
            "",
            "**User-facing routes (13 search/lookup + 3 change summary):**",
            "- GET /api/v1/ref/hsc/search, GET /ref/hsc/favourites, GET /ref/hsc/:code",
            "- GET /ref/di/search, GET /ref/di/:code",
            "- GET /ref/modifiers, GET /ref/modifiers/:code",
            "- GET /ref/functional-centres, GET /ref/explanatory-codes/:code",
            "- GET /ref/rrnp/:id, GET /ref/pcpcm/:code",
            "- GET /ref/holidays, GET /ref/holidays/check",
            "- GET /ref/changes, GET /ref/changes/:id/detail, GET /ref/changes/:id/physician-impact",
            "",
            "**Internal validation routes (4):**",
            "- GET /ref/rules/validate-context, GET /ref/rules/:id, GET /ref/somb/version, POST /ref/rules/evaluate-batch",
            "",
            "**Admin routes (9):**",
            "- All admin/ref/* routes",
            "",
            "For each: no cookie → 401, expired cookie → 401, tampered cookie → 401."
          ]
        },
        {
          "id": "D02-041",
          "description": "Security: authorization and role enforcement",
          "verify": "pnpm --filter api vitest run test/security/reference/reference.authz.security.ts",
          "depends": ["D02-030", "D02-031", "D02-032"],
          "build": [
            "Create `apps/api/test/security/reference/reference.authz.security.ts`.",
            "",
            "**Admin routes reject non-admin users:**",
            "- POST /admin/ref/somb/upload as physician → 403",
            "- POST /admin/ref/somb/staging/:id/publish as physician → 403",
            "- DELETE /admin/ref/somb/staging/:id as physician → 403",
            "- POST /admin/ref/holidays as physician → 403",
            "- PUT /admin/ref/holidays/:id as physician → 403",
            "- DELETE /admin/ref/holidays/:id as physician → 403",
            "- POST /admin/ref/rules/:id/dry-run as physician → 403",
            "- All admin routes as delegate → 403",
            "",
            "**Search routes allow delegate with appropriate permissions:**",
            "- Delegate with CLAIM_VIEW can access GET /ref/hsc/search",
            "- Delegate without CLAIM_VIEW cannot access search routes",
            "",
            "**Subscription-gated access:**",
            "- SUSPENDED user: read-only access to reference data (search allowed, no write ops)",
            "- CANCELLED user: no access"
          ]
        },
        {
          "id": "D02-042",
          "description": "Security: cross-user isolation (tenant scoping)",
          "verify": "pnpm --filter api vitest run test/security/reference/reference.scoping.security.ts",
          "depends": ["D02-030", "D02-031", "D02-032"],
          "build": [
            "Create `apps/api/test/security/reference/reference.scoping.security.ts`.",
            "",
            "Create two physician accounts using createSecurityPair fixture.",
            "",
            "**Reference data is shared (read-only) — no tenant isolation needed for code lookups:**",
            "- Both physicians see the same HSC codes, DI codes, governing rules (this is correct — reference data is global)",
            "",
            "**Physician-specific data IS isolated:**",
            "- GET /ref/hsc/favourites for physician1 returns physician1's favourites only",
            "- GET /ref/hsc/favourites for physician2 returns physician2's favourites only",
            "- GET /ref/changes/:id/physician-impact for physician1 returns physician1's impact only",
            "",
            "**Admin actions are scoped:**",
            "- Staging records created by admin1 are visible to admin2 (admin-level collaboration is acceptable)",
            "",
            "**Important:** Cross-user access to personalised endpoints returns 404, not 403."
          ]
        },
        {
          "id": "D02-043",
          "description": "Security: input validation and injection prevention",
          "verify": "pnpm --filter api vitest run test/security/reference/reference.input.security.ts",
          "depends": ["D02-030", "D02-031", "D02-032"],
          "build": [
            "Create `apps/api/test/security/reference/reference.input.security.ts`.",
            "",
            "**SQL injection payloads on search queries:**",
            "- q parameter: `' OR 1=1--`, `'; DROP TABLE hsc_codes;--`",
            "- specialty parameter: SQL injection payloads",
            "- date parameter: SQL injection payloads",
            "",
            "**XSS payloads on admin-authored text fields:**",
            "- change_summary: `<script>alert(1)</script>`",
            "- Holiday name: `<img onerror=alert(1) src=x>`",
            "- help_text in uploaded data: XSS payloads",
            "",
            "**Type coercion attacks:**",
            "- Send number where string expected, array where string expected",
            "- Negative limit on search → 400",
            "- limit > 50 on search → capped at 50",
            "- Invalid date format in date params → 400",
            "",
            "**UUID parameter validation:**",
            "- Non-UUID in path params → 400",
            "",
            "**File upload attacks:**",
            "- Upload file > 50MB → 400",
            "- Upload executable disguised as CSV → 400",
            "- Upload with mismatched content type → 400",
            "- Upload malformed CSV (unterminated quotes, wrong encoding) → descriptive error",
            "",
            "**Rule_logic JSON validation:**",
            "- Invalid JSON in dry-run body → 400",
            "- rule_logic with unexpected keys → validation warning"
          ]
        },
        {
          "id": "D02-044",
          "description": "Security: data leakage prevention",
          "verify": "pnpm --filter api vitest run test/security/reference/reference.leakage.security.ts",
          "depends": ["D02-030", "D02-031", "D02-032"],
          "build": [
            "Create `apps/api/test/security/reference/reference.leakage.security.ts`.",
            "",
            "**Staging data isolation:**",
            "- Unpublished staging data does NOT appear in search results",
            "- Unpublished staging data does NOT appear in version lists (non-admin)",
            "- Discarded staging data is completely removed",
            "",
            "**Version isolation:**",
            "- Search with date parameter returns only data from the correct version",
            "- Future-dated versions do not appear in current searches",
            "",
            "**Error response sanitisation:**",
            "- 404 for unknown HSC code does not reveal which codes exist",
            "- 500 errors do not expose SQL queries or database details",
            "- Schema validation errors do not expose internal table structure",
            "",
            "**Header checks:**",
            "- No X-Powered-By header",
            "- HSTS header present",
            "",
            "**Sensitive fields not leaked:**",
            "- Internal version_id is included (needed for version tracking) but staging JSONB data is not in user responses",
            "- Admin-authored change summaries are sanitised for XSS before display"
          ]
        },
        {
          "id": "D02-045",
          "description": "Security: audit trail completeness for all reference data operations",
          "verify": "pnpm --filter api vitest run test/security/reference/reference.audit.security.ts",
          "depends": ["D02-030", "D02-031", "D02-032"],
          "build": [
            "Create `apps/api/test/security/reference/reference.audit.security.ts`.",
            "",
            "Verify each reference data action produces an audit record:",
            "",
            "**Data management events:**",
            "- Version staged → ref.version_staged with admin_id, data_set, staging_id, record_count, file_hash",
            "- Diff reviewed → ref.version_diff_reviewed with admin_id, staging_id, diff_stats",
            "- Version published → ref.version_published with admin_id, version_id, data_set, effective_from",
            "- Version rolled back → ref.version_rolled_back with admin_id, version_id, data_set, reason",
            "- Staging discarded → ref.staging_discarded with admin_id, staging_id, data_set",
            "- Rule dry-run → ref.rule_dry_run with admin_id, rule_id, claims_sampled",
            "",
            "**Holiday events:**",
            "- Holiday created → ref.holiday_created with admin_id, date, name",
            "- Holiday updated → ref.holiday_updated with admin_id, old_values, new_values",
            "- Holiday deleted → ref.holiday_deleted with admin_id, holiday_id, date",
            "",
            "**Audit log integrity:**",
            "- Published versions cannot be edited (immutability enforced)",
            "- Audit entries do not contain full staged data (only metadata)"
          ]
        }
      ]
    },
    {
      "title": "Domain 2: Reference Data — Final Validation",
      "tasks": [
        {
          "id": "D02-099",
          "description": "Full domain test suite: all unit + integration + security tests",
          "verify": "pnpm --filter api vitest run src/domains/reference/ test/integration/reference/ test/security/reference/",
          "depends": ["D02-040", "D02-041", "D02-042", "D02-043", "D02-044", "D02-045"],
          "build": [
            "Run the complete test suite for Domain 2 Reference Data. Do NOT write new code unless tests fail.",
            "",
            "1. Run all unit tests: `pnpm --filter api vitest run src/domains/reference/`",
            "2. Run all integration tests: `pnpm --filter api vitest run test/integration/reference/`",
            "3. Run all security tests: `pnpm --filter api vitest run test/security/reference/`",
            "",
            "If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.",
            "",
            "After all pass, run the full suite one final time:",
            "```bash",
            "pnpm --filter api vitest run src/domains/reference/ test/integration/reference/ test/security/reference/",
            "```",
            "",
            "Verify these security test files exist and are non-empty:",
            "- test/security/reference/reference.authn.security.ts",
            "- test/security/reference/reference.authz.security.ts",
            "- test/security/reference/reference.scoping.security.ts",
            "- test/security/reference/reference.input.security.ts",
            "- test/security/reference/reference.leakage.security.ts",
            "- test/security/reference/reference.audit.security.ts",
            "",
            "Verify integration test files exist:",
            "- test/integration/reference/search.integration.ts",
            "- test/integration/reference/admin.integration.ts",
            "- test/integration/reference/validation.integration.ts",
            "- test/integration/reference/changes.integration.ts"
          ]
        }
      ]
    }
  ]
}
