# Task D09-041: Security â€” authorization and role enforcement for notification features

## What to Build

Create `apps/api/test/security/notification/notification.authz.security.ts`.

Set up test fixtures: create a physician user and a delegate user linked to that physician.

**Preference management restricted to physicians:**
- PUT /api/v1/notification-preferences/:category as delegate -> 403
- PUT /api/v1/notification-preferences/quiet-hours as delegate -> 403
- GET /api/v1/notification-preferences as delegate -> 403
- Verify 403 response body contains only error message, no preference data

**Delegate notification access (positive tests):**
- Delegate can access GET /api/v1/notifications (sees notifications from their physician contexts) -> 200
- Delegate can POST /api/v1/notifications/:id/read on their own notifications -> 200
- Delegate can POST /api/v1/notifications/read-all on their own notifications -> 200
- Delegate can POST /api/v1/notifications/:id/dismiss on their own notifications -> 200
- Delegate can access GET /api/v1/notifications/unread-count -> 200

**URGENT preference enforcement:**
- PUT /api/v1/notification-preferences/deadline_1_day with `{ in_app_enabled: false }` -> 400 with error explaining URGENT in-app cannot be disabled
- PUT /api/v1/notification-preferences/batch_error with `{ in_app_enabled: false }` -> 400 with error explaining URGENT in-app cannot be disabled
- PUT /api/v1/notification-preferences/payment_failed with `{ in_app_enabled: false }` -> 400
- PUT /api/v1/notification-preferences/account_suspended with `{ in_app_enabled: false }` -> 400
- Verify that email_enabled CAN be changed for URGENT events (only in-app is forced)
- Verify that non-URGENT events CAN have in_app_enabled set to false

**Internal endpoint authorization:**
- POST /api/v1/internal/notifications/emit with regular session cookie (no API key) -> 401
- POST /api/v1/internal/notifications/emit with wrong API key -> 401
- POST /api/v1/internal/notifications/emit-batch with regular session cookie -> 401

**Test structure:**
Use `describe` blocks to group related authorization tests. Each test should:
1. Authenticate as the appropriate user role
2. Make the request
3. Assert the correct status code
4. Assert the response body contains no unauthorized data

## Critical Security Rules

- Delegates cannot modify notification preferences -- physician-only feature.
- URGENT in-app cannot be disabled at the API level, regardless of what the client sends.
- Internal endpoints require API key, not session cookies -- different auth mechanism.

## Prerequisites

- D09-030 must be complete (notification feed routes).
- D09-031 must be complete (preference routes).
- D09-032 must be complete (internal routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/notification/notification.authz.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
