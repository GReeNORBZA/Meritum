# Task D09-042: Security â€” cross-user notification isolation (tenant scoping)

## What to Build

Create `apps/api/test/security/notification/notification.scoping.security.ts`.

Create two physician accounts (physician1, physician2) using `createSecurityPair` fixture or by creating two separate test users with physician roles.

**Notification feed isolation:**
- Create notifications for both physicians (use the repository directly or the internal emit endpoint)
- Physician1 GET /api/v1/notifications returns only physician1's notifications
- Verify physician1's feed never contains physician2's notifications (check every notification_id in the response)
- Physician2 GET /api/v1/notifications returns only physician2's notifications

**Read/dismiss isolation:**
- Create a notification for physician2
- Physician1 POST /api/v1/notifications/:physician2NotificationId/read -> 404 (not 403)
- Physician1 POST /api/v1/notifications/:physician2NotificationId/dismiss -> 404 (not 403)
- Verify physician2's notification remains unread and not dismissed after physician1's attempts

**Unread count isolation:**
- Create 3 notifications for physician1, 5 notifications for physician2
- Physician1 GET /api/v1/notifications/unread-count returns `{ count: 3 }`
- Physician2 GET /api/v1/notifications/unread-count returns `{ count: 5 }`
- Mark 1 of physician1's as read -> physician1 count becomes 2, physician2 count stays 5

**Preference isolation:**
- Physician1 GET /api/v1/notification-preferences returns only physician1's preferences
- Update physician1's claim_rejection preference to email_enabled: false
- Physician2 GET /api/v1/notification-preferences still shows email_enabled: true for claim_rejection (or default)
- Physician1's preference change does not appear in physician2's response

**Delegate cross-context isolation:**
- Create delegate1 linked to physician1 only
- Create delegate2 linked to physician2 only
- Create notifications for both physicians
- Delegate1 GET /api/v1/notifications sees only notifications from physician1's context
- Delegate1 does NOT see physician2's notifications
- If a delegate is linked to both physicians: create separate notifications for each context, verify physician1 context notifications do not leak into physician2 context view

**Important:** All cross-user access attempts return 404, not 403. This is a security design choice to prevent information disclosure (attacker cannot determine whether a notification exists for another user).

## Critical Security Rules

- Cross-user notification access returns 404, never 403 -- prevents enumeration.
- Unread counts are isolated per user -- no count leakage.
- Preference changes are isolated per provider -- no cross-provider contamination.
- Delegate isolation respects physician context boundaries.

## Prerequisites

- D09-030 must be complete (notification feed routes).
- D09-031 must be complete (preference routes).
- D09-032 must be complete (internal routes for creating test notifications).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/notification/notification.scoping.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
