# Task D09-031: Routes â€” notification preferences and quiet hours

## What to Build

Add to `apps/api/src/domains/notification/notification.routes.ts`:

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | /api/v1/notification-preferences | Physician | Get all preferences for the physician. |
| PUT | /api/v1/notification-preferences/:category | Physician | Update preferences for a specific event category. |
| PUT | /api/v1/notification-preferences/quiet-hours | Physician | Set quiet hours (start/end time or null to clear). |

All three routes require the `authenticate` preHandler AND must verify the user has the `physician` role. Delegates cannot access preference endpoints -- return 403.

**Handler logic:**

`GET /api/v1/notification-preferences`:
- Load all preferences for authenticated physician's provider_id via `findPreferencesByProvider`
- Merge with EVENT_CATALOGUE defaults for any categories that don't have a preference entry yet
- Return a complete list of all event categories with their current settings:
```json
{
  "preferences": [
    {
      "event_category": "claim_rejection",
      "in_app_enabled": true,
      "email_enabled": true,
      "digest_mode": "IMMEDIATE",
      "is_urgent": false
    }
  ],
  "quiet_hours": {
    "start": "22:00",
    "end": "07:00"
  }
}
```

`PUT /api/v1/notification-preferences/:category`:
- Validate category param against `preferenceCategoryParamSchema`
- Validate category exists in EVENT_CATALOGUE (return 400 if unknown)
- Validate body against `updatePreferenceSchema`
- **URGENT enforcement:** If the event category maps to an URGENT priority event and the request tries to set `in_app_enabled: false`, return 400 with error: `"Cannot disable in-app notifications for urgent events"`
- Call `upsertPreference(providerId, category, data)`
- Emit `notification.preference_updated` audit event with category, old values, and new values
- Return updated preference

`PUT /api/v1/notification-preferences/quiet-hours`:
- Validate body against `quietHoursSchema` (with refinement: both start and end required, or both null)
- Call `updateQuietHours(providerId, start, end)`
- Emit `notification.quiet_hours_updated` audit event with old and new values
- Return `{ success: true, quiet_hours: { start, end } }`

**Add handlers** to `apps/api/src/domains/notification/notification.handlers.ts`.

**Integration tests:**
Create `apps/api/test/integration/notification/notification-preferences.integration.ts`.

## Critical Security Rules

- Preferences are physician-only -- delegates cannot modify notification preferences.
- URGENT in-app cannot be disabled -- server-side enforcement regardless of client request.
- Preference changes are audited with old and new values for compliance.

## Prerequisites

- D09-012 must be complete (preference repository).
- D09-001 must be complete (EVENT_CATALOGUE for validation and URGENT enforcement).
- Domain 1 auth middleware must exist for role checking.

## Tests to Write

Create `apps/api/test/integration/notification/notification-preferences.integration.ts`:

- GET /notification-preferences returns all preferences
- GET /notification-preferences includes defaults for unconfigured categories
- PUT /:category updates email_enabled
- PUT /:category updates digest_mode
- PUT /:category rejects disabling in_app for URGENT event
- PUT /:category rejects unknown category
- PUT /quiet-hours sets start and end
- PUT /quiet-hours with null values clears quiet hours
- PUT /quiet-hours rejects start without end
- Delegate cannot access preference endpoints

## FRD Reference

- Domain 9 Section 8.2: Preference endpoints.
- Domain 9 Section 4.2: URGENT in-app cannot be disabled.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/notification/
```

All tests must pass before outputting [TASK_COMPLETE].
