# Task D09-010: Repository â€” notifications CRUD (feed, read, dismiss, unread count)

## What to Build

Create `apps/api/src/domains/notification/notification.repository.ts`:

**Notification operations:**
- `createNotification(data: InsertNotification)` -- insert notification record. Return created notification.
- `createNotificationsBatch(data: InsertNotification[])` -- bulk insert for batch event emission. Return created count.
- `findNotificationById(notificationId: string, recipientId: string)` -- find notification scoped to recipient.
- `listNotifications(recipientId: string, opts: { unreadOnly?: boolean, limit: number, offset: number })` -- paginated feed in reverse chronological order. Exclude dismissed notifications from default feed.
- `countUnread(recipientId: string)` -- count notifications where read_at is null and dismissed_at is null.
- `markRead(notificationId: string, recipientId: string)` -- set read_at = now(). Scoped to recipient.
- `markAllRead(recipientId: string)` -- set read_at = now() on all unread notifications for recipient.
- `dismiss(notificationId: string, recipientId: string)` -- set dismissed_at = now(). Scoped to recipient.

All queries scoped by recipient_id. No cross-user access.

Use Drizzle ORM query builder with the notification table schema from `packages/shared/src/schemas/db/notification.schema.ts`. Accept a Drizzle database instance via dependency injection (constructor parameter or function parameter). Follow existing repository patterns in the codebase (check `apps/api/src/domains/iam/` for reference).

For `listNotifications`:
- Default ordering: `created_at DESC`
- When `unreadOnly` is true, filter to `read_at IS NULL`
- Always exclude dismissed notifications (`dismissed_at IS NULL`) from the feed
- Apply `limit` and `offset` for pagination

For `createNotificationsBatch`, use a single INSERT with multiple values for efficiency.

## Critical Security Rules

- All notification queries are strictly scoped to recipient_id -- no cross-user notification access.
- markRead and dismiss verify ownership via recipient_id before updating.
- Dismissed notifications are retained for audit (soft-hide, not delete).
- Never return notifications belonging to a different recipient_id, even if the notification_id is known.

## Prerequisites

- D09-006 must be complete (database migration applied, notifications table exists).
- Drizzle database connection must be available (set up in app bootstrap).

## Tests to Write

Create tests in `apps/api/src/domains/notification/notification.test.ts`:

- createNotification inserts with correct fields
- createNotificationsBatch inserts multiple notifications
- findNotificationById returns notification for correct recipient
- findNotificationById returns null for wrong recipient
- listNotifications returns reverse chronological order
- listNotifications with unreadOnly filters to unread
- listNotifications excludes dismissed notifications
- listNotifications paginates correctly
- countUnread returns correct count
- countUnread excludes dismissed notifications
- markRead sets read_at timestamp
- markRead scoped to recipient (fails silently for wrong recipient)
- markAllRead marks all unread as read
- dismiss sets dismissed_at timestamp

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/notification/notification.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
