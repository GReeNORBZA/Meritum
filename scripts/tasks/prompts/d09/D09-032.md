# Task D09-032: Routes â€” internal event ingestion, WebSocket endpoint, Postmark webhook

## What to Build

Add to `apps/api/src/domains/notification/notification.routes.ts`:

**Internal event ingestion (internal only, not exposed to clients):**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| POST | /api/v1/internal/notifications/emit | Internal API key | Emit a single event. |
| POST | /api/v1/internal/notifications/emit-batch | Internal API key | Emit multiple events at once. |

**WebSocket endpoint:**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| WS | /ws/notifications | Session token | Real-time notification push. |

**Postmark webhook:**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| POST | /api/v1/webhooks/postmark | Webhook signature | Handle delivery/bounce callbacks. |

**Handler logic:**

`POST /api/v1/internal/notifications/emit`:
- Check `X-Internal-API-Key` header against `process.env.INTERNAL_API_KEY`. If missing or wrong, return 401.
- Validate body against `emitEventSchema`
- Call `processEvent(body)` from the notification service
- Return `{ notification_ids: string[] }` (array of created notification IDs for all recipients)

`POST /api/v1/internal/notifications/emit-batch`:
- Same API key auth as emit
- Validate body against `emitBatchEventSchema`
- Call `processEventBatch(body.events)`
- Return `{ created_count: number }`

`WS /ws/notifications`:
- Use `@fastify/websocket` route handler
- On upgrade: extract session token from cookie or query parameter `?token=`
- Validate session via Domain 1 session repository
- If invalid: reject connection with close code 4001
- If valid: call `registerConnection(userId, socket)`
- On socket close: call `removeConnection(userId, socket)`
- On socket error: call `removeConnection(userId, socket)` and log error
- Send heartbeat ping every 30 seconds
- Client messages are ignored (this is a push-only WebSocket)

`POST /api/v1/webhooks/postmark`:
- Verify Postmark webhook signature. The signature is in the `X-Postmark-Signature` header. Compute HMAC-SHA256 of the raw request body using the webhook secret (`process.env.POSTMARK_WEBHOOK_SECRET`). Compare signatures securely (constant-time comparison).
- If signature invalid: return 401
- Parse the webhook payload for event type:
  - `Delivery` event: call `updateDeliveryStatus(deliveryId, 'DELIVERED', { deliveredAt })` using the `MessageID` to look up the delivery record
  - `Bounce` event: call `handleBounce(MessageID, bounceType, description)` where bounceType is 'hard' or 'soft' based on the Postmark bounce type code
- Return 200 OK (Postmark expects 200 to acknowledge receipt)

**Internal API key middleware:**
Create a `verifyInternalApiKey` preHandler that checks the `X-Internal-API-Key` header. This should be a simple comparison against `process.env.INTERNAL_API_KEY`. Do NOT use session-based auth for these endpoints.

**Add handlers** to `apps/api/src/domains/notification/notification.handlers.ts`.

**Integration tests:**
Create `apps/api/test/integration/notification/notification-internal.integration.ts`.

## Critical Security Rules

- Internal emit endpoints protected by API key -- not accessible to client sessions.
- WebSocket requires valid session token -- rejects unauthenticated upgrade requests.
- Postmark webhook verifies signature -- prevents spoofed delivery/bounce events.
- Internal API key from environment variable -- never exposed to clients.
- Use constant-time comparison for API key and webhook signature verification (use `crypto.timingSafeEqual`).

## Prerequisites

- D09-020 must be complete (processEvent and processEventBatch service functions).
- D09-021 must be complete (handleBounce and updateDeliveryStatus).
- D09-023 must be complete (WebSocket manager for connection registration).
- `@fastify/websocket` must be installed.

## Tests to Write

Create `apps/api/test/integration/notification/notification-internal.integration.ts`:

- POST /emit with valid API key creates notification
- POST /emit without API key returns 401
- POST /emit with invalid event_type returns 400
- POST /emit-batch creates multiple notifications
- WS /ws/notifications connects with valid session
- WS /ws/notifications rejects without session token
- WS /ws/notifications receives pushed notifications
- POST /webhooks/postmark processes delivery confirmation
- POST /webhooks/postmark processes bounce event
- POST /webhooks/postmark rejects invalid signature

## FRD Reference

- Domain 9 Section 8.3: Internal emit and emit-batch endpoints.
- Domain 9 Section 8.1: WS /ws/notifications endpoint.
- Domain 9 Section 6.2: Bounce handling from email provider webhooks.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/notification/
```

All tests must pass before outputting [TASK_COMPLETE].
