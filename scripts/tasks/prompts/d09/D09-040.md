# Task D09-040: Security â€” authentication enforcement on every notification route

## What to Build

Create `apps/api/test/security/notification/notification.authn.security.ts`.

Test every authenticated route returns 401 without a valid session cookie:

**Client-facing routes (session cookie auth):**
- GET /api/v1/notifications -- no cookie -> 401
- GET /api/v1/notifications -- expired cookie -> 401
- GET /api/v1/notifications -- tampered cookie -> 401
- GET /api/v1/notifications/unread-count -- no cookie -> 401
- GET /api/v1/notifications/unread-count -- expired cookie -> 401
- POST /api/v1/notifications/:id/read -- no cookie -> 401
- POST /api/v1/notifications/:id/read -- expired cookie -> 401
- POST /api/v1/notifications/read-all -- no cookie -> 401
- POST /api/v1/notifications/read-all -- expired cookie -> 401
- POST /api/v1/notifications/:id/dismiss -- no cookie -> 401
- POST /api/v1/notifications/:id/dismiss -- expired cookie -> 401
- GET /api/v1/notification-preferences -- no cookie -> 401
- GET /api/v1/notification-preferences -- expired cookie -> 401
- PUT /api/v1/notification-preferences/:category -- no cookie -> 401
- PUT /api/v1/notification-preferences/quiet-hours -- no cookie -> 401

**Internal endpoints (API key auth):**
- POST /api/v1/internal/notifications/emit without X-Internal-API-Key -> 401
- POST /api/v1/internal/notifications/emit with wrong API key -> 401
- POST /api/v1/internal/notifications/emit-batch without X-Internal-API-Key -> 401
- POST /api/v1/internal/notifications/emit-batch with wrong API key -> 401

**WebSocket:**
- WS /ws/notifications without session token -> connection rejected
- WS /ws/notifications with expired session token -> connection rejected
- WS /ws/notifications with tampered session token -> connection rejected

**Verification for each test:**
1. Response status is 401 (or connection rejected for WebSocket)
2. Response body contains only an error object (e.g., `{ error: "Unauthorized" }`)
3. Response body does NOT contain any notification data, preference data, or internal details
4. No `Set-Cookie` header in 401 responses (don't create sessions for unauthenticated requests)

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference).

## Critical Security Rules

- 401 responses contain only error object, no notification data.
- Internal API key endpoints return 401 without key, not 403.
- WebSocket upgrade without auth returns appropriate rejection.
- Tampered cookies must be detected and rejected -- do not fall through to a default user.

## Prerequisites

- D09-030 must be complete (notification feed routes).
- D09-031 must be complete (preference routes).
- D09-032 must be complete (internal and WebSocket routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/notification/notification.authn.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
