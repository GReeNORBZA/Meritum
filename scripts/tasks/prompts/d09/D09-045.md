# Task D09-045: Security â€” audit trail completeness for notification actions

## What to Build

Create `apps/api/test/security/notification/notification.audit.security.ts`.

Verify that each notification action produces an audit record. Query the audit_log table (from Domain 1) after each action to verify the audit entry exists with the correct fields.

**Event processing:**
- Emit event via POST /api/v1/internal/notifications/emit -> verify audit record `notification.event_emitted` with { event_type, physician_id }
- Notification created (as part of emit) -> verify audit record `notification.created` with { notification_id, recipient_id, event_type }

**User actions:**
- POST /api/v1/notifications/:id/read -> verify audit record `notification.read` with { notification_id }
- POST /api/v1/notifications/read-all -> verify audit record `notification.read_all` with { count } (number of notifications marked as read)
- POST /api/v1/notifications/:id/dismiss -> verify audit record `notification.dismissed` with { notification_id }

**Email delivery:**
- Process an event that triggers email -> verify audit record `notification.email_sent` with { delivery_id, recipient_email_hash } (email should be hashed, not plaintext)
- Process a bounce webhook -> verify audit record `notification.email_bounced` with { delivery_id, bounce_type }
- After max retries exhausted -> verify audit record `notification.email_failed` with { delivery_id, retry_count }

**Preference changes:**
- PUT /api/v1/notification-preferences/:category -> verify audit record `notification.preference_updated` with { category, changes } showing old and new values
- PUT /api/v1/notification-preferences/quiet-hours -> verify audit record `notification.quiet_hours_updated` with { old_start, old_end, new_start, new_end }

**Digest:**
- Trigger daily digest assembly -> verify audit record `notification.digest_assembled` with { recipient_count, item_count }

**Audit log integrity:**
- Verify all audit entries contain the acting user_id (the user who performed the action)
- Verify email delivery audit entries do NOT contain plaintext recipient_email (must be hashed or redacted)
- Verify audit entries contain a timestamp
- Verify audit entries contain the correct action identifier string

**Test approach:**
For each test:
1. Perform the action (via HTTP request or direct service call)
2. Query the audit_log table for the most recent entry matching the expected action
3. Assert the action identifier matches
4. Assert the metadata/details contain the expected fields
5. Assert no sensitive data (plaintext email, PHI) is in the audit record

Use the audit log repository from Domain 1 to query audit records, or query the audit_log table directly via Drizzle.

## Critical Security Rules

- Audit entries for notifications are scoped to the acting user_id.
- Email delivery audit does not contain plaintext recipient_email (hash or redact).
- Audit trail must be complete -- every mutation action produces an audit record.
- Audit records are append-only -- verify they cannot be modified or deleted.

## Prerequisites

- D09-030 must be complete (notification feed routes that emit audit events).
- D09-031 must be complete (preference routes that emit audit events).
- D09-032 must be complete (internal routes that emit audit events).
- Domain 1 audit log infrastructure must exist.

## Run After Completion

```bash
pnpm --filter api vitest run test/security/notification/notification.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
