# Task D09-030: Routes â€” notification feed, read, dismiss, unread count

## What to Build

Create `apps/api/src/domains/notification/notification.routes.ts` and `apps/api/src/domains/notification/notification.handlers.ts`.

**Routes:**

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | /api/v1/notifications | Authenticated | Get notification feed. Query: unread_only, limit, offset. |
| GET | /api/v1/notifications/unread-count | Authenticated | Get unread notification count (lightweight for badge). |
| POST | /api/v1/notifications/:id/read | Authenticated | Mark notification as read. |
| POST | /api/v1/notifications/read-all | Authenticated | Mark all notifications as read. |
| POST | /api/v1/notifications/:id/dismiss | Authenticated | Dismiss notification (hide, retain for audit). |

**Route registration:**
In `notification.routes.ts`, export a Fastify plugin function that registers all routes. Use the `authenticate` preHandler hook from Domain 1 middleware on all routes. Follow the route registration pattern used by other domains (check `apps/api/src/domains/iam/` for reference).

**Handler logic:**

`GET /api/v1/notifications`:
- Validate query params against `notificationFeedQuerySchema`
- Get the authenticated user's ID from `request.user.userId`
- Call `listNotifications(recipientId, { unreadOnly, limit, offset })`
- For delegates: include notifications from their physician contexts (the repository already scopes by recipient_id which works for both physicians and delegates)
- Return `{ notifications: NotificationResponse[], total: number }`
- Emit no audit event (read-only feed access)

`GET /api/v1/notifications/unread-count`:
- Call `countUnread(recipientId)`
- Return `{ count: number }`
- This endpoint should be fast -- used for badge updates

`POST /api/v1/notifications/:id/read`:
- Validate UUID param against `notificationIdParamSchema`
- Call `markRead(notificationId, recipientId)` -- scoped to recipient
- Push updated unread count via WebSocket: `pushUnreadCount(recipientId)`
- Emit `notification.read` audit event
- Return `{ success: true }`

`POST /api/v1/notifications/read-all`:
- Call `markAllRead(recipientId)`
- Push updated count via WebSocket: `pushUnreadCount(recipientId)`
- Emit `notification.read_all` audit event with count of notifications marked
- Return `{ success: true, count: number }`

`POST /api/v1/notifications/:id/dismiss`:
- Validate UUID param
- Call `dismiss(notificationId, recipientId)` -- scoped to recipient
- Emit `notification.dismissed` audit event
- Return `{ success: true }`

**Error handling:**
- If notification not found (or belongs to different user): return 404
- Invalid UUID format: return 400
- Invalid query params: return 400

**Integration tests:**
Create `apps/api/test/integration/notification/notification-feed.integration.ts`:
- Use the test helpers/fixtures from the project (check existing integration tests for patterns)
- Create test users, generate notifications via the repository, then test each endpoint

## Critical Security Rules

- All feed endpoints scoped to authenticated user -- no cross-user notification access.
- Delegates see notifications from their physician context(s) only.
- Cross-user notification access returns 404 (not 403) to prevent information disclosure.

## Prerequisites

- D09-020 must be complete (notification service with processEvent).
- D09-023 must be complete (WebSocket manager for pushing unread count updates).
- Domain 1 auth middleware must exist for route authentication.

## Tests to Write

Create `apps/api/test/integration/notification/notification-feed.integration.ts`:

- GET /notifications returns feed for authenticated user
- GET /notifications with unread_only=true filters unread
- GET /notifications respects limit and offset
- GET /notifications excludes dismissed notifications
- GET /unread-count returns correct count
- POST /:id/read marks notification as read
- POST /:id/read for other user's notification returns 404
- POST /read-all marks all unread as read
- POST /:id/dismiss hides notification from feed
- Delegate sees notifications from physician context

## FRD Reference

- Domain 9 Section 8.1: All notification feed endpoints with query params.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/notification/
```

All tests must pass before outputting [TASK_COMPLETE].
