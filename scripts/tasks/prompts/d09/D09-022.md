# Task D09-022: Service â€” digest assembly and scheduled jobs

## What to Build

Add to `apps/api/src/domains/notification/notification.service.ts`:

**Digest assembly:**
- `assembleDailyDigest()` -- scheduled job, runs at 08:00 MT daily. Find all pending DAILY digest items grouped by recipient via `findAllPendingDigestItems('DAILY')`. For each recipient: render digest email from summary template (groups notifications by category with counts). Send email via `sendEmail`. Mark items as sent via `markDigestItemsSent`. Emit notification.digest_assembled audit event with recipient_count and item_count.

- `assembleWeeklyDigest()` -- scheduled job, runs Monday at 08:00 MT. Same as daily but for WEEKLY items from past 7 days. Uses `findAllPendingDigestItems('WEEKLY')`.

- `renderDigestEmail(recipientId: string, items: DigestItem[])` -- group items by event_type/category. Build a summary object: `{ category: string, count: number, latestTitle: string }[]`. Render the digest email template with these grouped summaries. Include 'View in Meritum' link pointing to the notification feed page. No PHI in digest email -- only counts and category names.

The digest email template should produce something like:
```
Subject: Your [Daily/Weekly] Meritum Summary

You have X new notifications:
- Claim Lifecycle: Y notifications
- Deadline Approaching: Z notifications
- ...

View all notifications: [link to /notifications]
```

**Thursday submission sequence:**
- `sendWednesdayBatchReminder()` -- scheduled job, Wednesday evening. For each physician with batch_review_reminder preference enabled: check if flagged claims exist (query Domain 4 claim repository for flagged/unreviewed claims). If yes: emit BATCH_REVIEW_REMINDER event type with metadata `{ flagged_count: number }` via `processEvent`.
- The remaining Thursday sequence events (cutoff, submitted, WCB ready, assessment, payment) are emitted by Domain 4 (Claim Lifecycle) -- this service just processes them via the standard pipeline.

**Job scheduling:**
Use Fastify cron plugin (`fastify-cron`) or `node-cron`. Create a `registerNotificationJobs(app: FastifyInstance)` function that registers all scheduled jobs:
- Daily digest: `'0 8 * * *'` (08:00 MT daily)
- Weekly digest: `'0 8 * * 1'` (08:00 MT Monday)
- Email retry: `'*/5 * * * *'` (every 5 minutes)
- Wednesday reminder: `'0 18 * * 3'` (18:00 MT Wednesday)

All cron expressions should be evaluated in the `America/Edmonton` timezone.

Each job should:
1. Log when it starts
2. Execute the handler in a try/catch
3. Log success or error
4. Not crash the application if the handler throws

## Critical Security Rules

- No PHI in digest emails -- only notification counts and category labels.
- Digest email links point to authenticated pages only.
- Wednesday batch reminder checks claim data but does not include claim details in the notification -- only the flagged count.

## Prerequisites

- D09-012 must be complete (digest queue repository).
- D09-021 must be complete (sendEmail function for sending digest emails).
- Domain 4 claim repository should be available for Wednesday reminder flagged claim check.

## Tests to Write

Add tests to `apps/api/src/domains/notification/notification.test.ts`:

- assembleDailyDigest groups items by recipient
- assembleDailyDigest sends one email per recipient
- assembleDailyDigest marks items as sent
- assembleDailyDigest skips recipients with no pending items
- assembleWeeklyDigest processes WEEKLY items from past 7 days
- renderDigestEmail groups by category with counts
- renderDigestEmail contains no PHI
- sendWednesdayBatchReminder fires for physician with flagged claims and reminder enabled
- sendWednesdayBatchReminder skips physician with no flagged claims
- sendWednesdayBatchReminder skips physician with reminder disabled

## FRD Reference

- Domain 9 Section 6.3: Daily digest at 08:00 MT, weekly digest Monday 08:00 MT. Groups by category with counts.
- Domain 9 Section 3.6: Thursday submission sequence -- 6 coordinated notifications from Wednesday evening through Friday.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/notification/notification.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
