# Task D09-043: Security â€” input validation and injection prevention

## What to Build

Create `apps/api/test/security/notification/notification.input.security.ts`.

**SQL injection payloads:**
- PUT /api/v1/notification-preferences/:category with category param: `' OR 1=1--` -> 400
- POST /api/v1/internal/notifications/emit with event_type: `'; DROP TABLE notifications;--` -> 400
- POST /api/v1/notifications/:id/read with id: `' OR '1'='1` -> 400
- GET /api/v1/notifications with limit: `1; DROP TABLE notifications` -> 400
- PUT /api/v1/notification-preferences/:category with category: `' UNION SELECT * FROM users--` -> 400

**XSS payloads (template injection):**
- POST /api/v1/internal/notifications/emit with metadata containing `<script>alert(1)</script>` -> notification created but rendered title/body has HTML escaped (verify by reading the created notification)
- POST /api/v1/internal/notifications/emit with metadata containing `{{constructor.constructor('return this')()}}` -> template injection prevention (variable not resolved, treated as literal or escaped)
- POST /api/v1/internal/notifications/emit with metadata containing `<img src=x onerror=alert(1)>` -> HTML escaped in rendered output

**Type coercion attacks:**
- GET /api/v1/notifications with limit as string "abc" -> 400 or coerced safely
- GET /api/v1/notifications with offset as negative number (-1) -> 400
- GET /api/v1/notifications with unread_only as non-boolean ("yes") -> 400 or coerced safely
- PUT /api/v1/notification-preferences/:category with category as array -> 400
- GET /api/v1/notifications with limit: 0 -> 400 (min is 1)
- GET /api/v1/notifications with limit: 101 -> 400 (max is 100)

**UUID parameter validation:**
- POST /api/v1/notifications/not-a-uuid/read -> 400
- POST /api/v1/notifications/12345/dismiss -> 400
- POST /api/v1/internal/notifications/emit with physician_id: "not-a-uuid" -> 400
- POST /api/v1/notifications/../admin/read -> 400 (path traversal attempt)

**Quiet hours validation:**
- PUT /api/v1/notification-preferences/quiet-hours with `{ quiet_hours_start: "25:00", quiet_hours_end: "07:00" }` -> 400
- PUT /api/v1/notification-preferences/quiet-hours with `{ quiet_hours_start: "22:00" }` (missing end) -> 400
- PUT /api/v1/notification-preferences/quiet-hours with `{ quiet_hours_end: "07:00" }` (missing start) -> 400
- PUT /api/v1/notification-preferences/quiet-hours with `{ quiet_hours_start: "abc", quiet_hours_end: "def" }` -> 400
- PUT /api/v1/notification-preferences/quiet-hours with `{ quiet_hours_start: "22:00:00", quiet_hours_end: "07:00:00" }` -> 400 (wrong format, should be HH:MM)

**Emit validation:**
- POST /api/v1/internal/notifications/emit with event_type: "" -> 400
- POST /api/v1/internal/notifications/emit with missing physician_id -> 400
- POST /api/v1/internal/notifications/emit-batch with empty events array -> 400
- POST /api/v1/internal/notifications/emit-batch with > 500 events -> 400
- POST /api/v1/internal/notifications/emit with extra unknown fields -> either 400 or fields stripped (not stored)

**For each test:**
1. Authenticate appropriately (session cookie for client routes, API key for internal routes)
2. Send the malicious payload
3. Assert the response is 400 (not 500 -- a 500 would indicate the payload reached the database layer)
4. Assert the response body contains a validation error message, not a stack trace

## Critical Security Rules

- All input validation happens at the route/handler layer before reaching the service or repository.
- SQL injection payloads must be caught by Zod validation and Drizzle parameterized queries.
- XSS payloads in metadata must be escaped during template rendering.
- A 500 response to any of these payloads indicates a security vulnerability -- the payload bypassed validation.

## Prerequisites

- D09-030 must be complete (notification feed routes).
- D09-031 must be complete (preference routes).
- D09-032 must be complete (internal routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/notification/notification.input.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
