# Task D09-021: Service â€” email delivery, retry logic, quiet hours, bounce handling

## What to Build

Add to `apps/api/src/domains/notification/notification.service.ts`:

**Email delivery:**
- `sendEmail(notificationId: string, recipientEmail: string, rendered: RenderedEmail)` -- create delivery log entry with QUEUED status. Send via Postmark API client. On success: update status to SENT and set sent_at. On failure: schedule retry using the retry schedule. Return delivery_id.

The `RenderedEmail` type should contain: `{ subject: string, htmlBody: string, textBody: string }`.

**Quiet hours enforcement:**
- `isInQuietHours(providerId: string)` -- check if current time (MT timezone, America/Edmonton) falls within provider's quiet hours. Load quiet_hours_start and quiet_hours_end from preferences. Return boolean.
- `scheduleAfterQuietHours(providerId: string)` -- calculate next time after quiet hours end. Return Date.
- Quiet hours check: if in quiet hours AND event priority is not URGENT -> defer email until quiet hours end (set next_retry_at to quiet hours end time). URGENT events bypass quiet hours.

**Retry logic:**
- `retryFailedEmails()` -- scheduled job handler. Find pending retries via repository. For each: attempt resend, update delivery status. After 4 failures -> status FAILED, emit notification.email_failed audit event.
- The retry schedule is defined in notification constants: [0, 5min, 30min, 2hr]. The next_retry_at for attempt N is `now() + RETRY_SCHEDULE[N]`.
- After each retry attempt, increment retry_count and calculate next_retry_at based on the schedule.

**Bounce handling:**
- `handleBounce(providerMessageId: string, bounceType: 'hard' | 'soft', reason: string)` -- webhook handler from email provider. Look up delivery log by provider_message_id.
  - Hard bounce: mark BOUNCED with bounced_at and bounce_reason. No retry. Create an in-app notification to the user telling them to update their email address. Emit notification.email_bounced audit event.
  - Soft bounce: schedule retry per the retry schedule (if retries remain). Emit notification.email_bounced audit event.

**Postmark integration:**
- Use Postmark client (`postmark` npm package). Initialize with server token from environment variable `POSTMARK_SERVER_TOKEN`.
- Sender address: `notifications@meritum.ca`
- No PHI in email body. Links to authenticated pages only.
- HTML email with plain-text fallback from template.
- Set `MessageStream` to "outbound" for transactional emails.

## Critical Security Rules

- No PHI in email body -- event summaries and links only. Patient names, PHNs, and claim details never in email.
- URGENT events bypass quiet hours -- safety-critical emails always sent immediately.
- Postmark webhook endpoint must verify webhook signature to prevent spoofed bounce events.
- Postmark server token must come from environment variable, never hardcoded.

## Prerequisites

- D09-011 must be complete (email delivery log repository).
- D09-020 must be complete (event processing pipeline that calls sendEmail).
- Postmark npm package must be available (`postmark` in dependencies).

## Tests to Write

Add tests to `apps/api/src/domains/notification/notification.test.ts`:

- sendEmail creates delivery log with QUEUED status
- sendEmail updates to SENT on successful send
- isInQuietHours returns true during configured quiet hours
- isInQuietHours returns false outside quiet hours
- isInQuietHours returns false when no quiet hours configured
- non-URGENT email during quiet hours is deferred
- URGENT email during quiet hours is sent immediately
- retryFailedEmails processes pending retries
- retryFailedEmails marks FAILED after 4 attempts
- handleBounce hard bounce marks BOUNCED, creates in-app notification
- handleBounce soft bounce schedules retry

Mock the Postmark client in tests -- do not make real API calls.

## FRD Reference

- Domain 9 Section 6.2: Retry schedule -- 4 attempts. Hard bounce: no retry, notify to update email. Soft bounce: retry per schedule.
- Domain 9 Section 4.1: Quiet hours -- non-urgent emails deferred. Start/end time configurable.
- Domain 9 Section 2.2: Email format -- HTML with plain-text fallback. No PHI in email body.
- Domain 9 Section 9: No PHI in email. SPF/DKIM/DMARC for meritum.ca.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/notification/notification.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
