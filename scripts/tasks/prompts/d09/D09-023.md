# Task D09-023: Service â€” WebSocket real-time notification delivery

## What to Build

Add to `apps/api/src/domains/notification/notification.service.ts`:

**WebSocket manager:**
Create a `NotificationWebSocketManager` class or module:

- `registerConnection(userId: string, socket: WebSocket)` -- add socket to connection map keyed by userId. One user may have multiple connections (multiple browser tabs). Use a `Map<string, Set<WebSocket>>` to track connections.

- `removeConnection(userId: string, socket: WebSocket)` -- remove socket from connection map. If the user's Set becomes empty, delete the map entry.

- `pushToUser(userId: string, notification: NotificationPayload)` -- send notification to all active WebSocket connections for this user. JSON payload:
```json
{
  "type": "notification",
  "data": {
    "notification_id": "uuid",
    "title": "Claim Rejected",
    "body": "Your claim for Dr. Smith has been rejected.",
    "priority": "HIGH",
    "action_url": "/claims/abc123",
    "event_type": "CLAIM_REJECTED",
    "metadata": {},
    "created_at": "2026-02-17T10:00:00Z"
  }
}
```

- `pushUnreadCount(userId: string)` -- query current unread count via `countUnread`, then send to all connections. Payload:
```json
{
  "type": "unread_count",
  "data": { "count": 5 }
}
```

**Integration with pipeline:**
- After notification creation in processEvent: call `pushToUser` for each recipient who has an active WebSocket connection.
- After markRead or markAllRead: call `pushUnreadCount` to update badge.
- Notifications are always stored in DB regardless of WebSocket connection status. WebSocket is a best-effort real-time delivery layer.

**WebSocket authentication:**
- On connection upgrade: extract session token from cookie (`session_id`) or query parameter (`?token=`).
- Validate the session token against the session store (Domain 1 session repository).
- If session is invalid or expired, reject the connection immediately with appropriate close code (4001).
- On session expiry during an active connection: send a close frame with code 4001 and disconnect.

**Heartbeat mechanism:**
- Server sends a ping frame every 30 seconds to each connected socket.
- If no pong is received within 10 seconds, consider the connection stale and close it.
- Use `setInterval` per connection or a global sweep interval.

**Fastify WebSocket integration:**
- Use `@fastify/websocket` plugin.
- Register the WebSocket route at `/ws/notifications`.
- The route handler should authenticate, register the connection, set up heartbeat, and handle close/error events.

## Critical Security Rules

- WebSocket connections require valid session token -- unauthenticated connections rejected immediately.
- WebSocket disconnected on session expiry -- no stale connections receiving notifications.
- Notifications pushed only to connections belonging to the recipient_id -- no cross-user WebSocket delivery.
- WebSocket payloads contain rendered content only, no raw database fields or internal IDs beyond notification_id.
- Do not include recipient_email or other PII in WebSocket payloads.

## Prerequisites

- D09-010 must be complete (notification repository for countUnread).
- D09-020 must be complete (event processing pipeline to integrate WebSocket push after notification creation).
- Domain 1 session management must exist for WebSocket authentication.
- `@fastify/websocket` must be installed.

## Tests to Write

Add tests to `apps/api/src/domains/notification/notification.test.ts`:

- registerConnection adds socket to connection map
- registerConnection supports multiple connections per user
- removeConnection removes specific socket
- pushToUser delivers to all active connections for user
- pushToUser is no-op if user has no active connections
- pushUnreadCount sends updated count
- WebSocket rejects connection without valid session token
- WebSocket disconnects on session expiry

Use mock WebSocket objects in unit tests. For integration tests, use a WebSocket client to connect to the test server.

## FRD Reference

- Domain 9 Section 2.1: Real-time delivery via WebSocket. No page refresh required. Notifications stored regardless of connection.
- Domain 9 Section 8.1: WS /ws/notifications endpoint.
- Domain 9 Section 9: WebSocket connections require valid session token. Disconnected on session expiry.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/notification/notification.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
