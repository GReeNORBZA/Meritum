# Task D09-012: Repository â€” digest queue and notification preferences

## What to Build

Add to `apps/api/src/domains/notification/notification.repository.ts`:

**Digest queue:**
- `addToDigestQueue(data: { recipientId: string, notificationId: string, digestType: string })` -- insert queue entry.
- `findPendingDigestItems(recipientId: string, digestType: string)` -- find items where digest_sent = false for this recipient and type.
- `findAllPendingDigestItems(digestType: string)` -- find all unsent items for this digest type, grouped by recipient_id. For scheduled digest job. Return a map or grouped structure: `Map<string, DigestQueueItem[]>` keyed by recipient_id.
- `markDigestItemsSent(queueIds: string[])` -- set digest_sent = true for batch of queue items.

**Notification preferences:**
- `findPreferencesByProvider(providerId: string)` -- return all preferences for this provider.
- `findPreference(providerId: string, eventCategory: string)` -- return specific preference or null.
- `upsertPreference(providerId: string, eventCategory: string, data: Partial<InsertNotificationPreference>)` -- insert or update preference. Use Drizzle's `onConflictDoUpdate` targeting the UNIQUE(provider_id, event_category) constraint.
- `createDefaultPreferences(providerId: string)` -- bulk insert default preferences based on EVENT_CATALOGUE defaults. Called during onboarding. For each event category in the catalogue, create a preference entry with the catalogue's default settings. URGENT events must have in_app_enabled = true always.
- `updateQuietHours(providerId: string, start: string | null, end: string | null)` -- update quiet_hours_start and quiet_hours_end on all preferences for this provider.

Use the digest_queue and notification_preferences table schemas from `packages/shared/src/schemas/db/notification.schema.ts`.

For `findAllPendingDigestItems`:
- Query all items where `digest_sent = false` and `digest_type` matches
- Join with notifications table to get notification details for rendering the digest
- Group results by recipient_id in the application layer

For `createDefaultPreferences`:
- Import EVENT_CATALOGUE from notification constants
- Derive unique event categories from the catalogue
- Set email_enabled based on the catalogue's defaultEmail for each event
- Set digest_mode to 'IMMEDIATE' as the default for all categories

## Critical Security Rules

- Preferences are scoped to provider_id -- no cross-physician preference access.
- createDefaultPreferences must enforce URGENT in-app cannot be disabled.
- updateQuietHours affects all preferences for a provider atomically.

## Prerequisites

- D09-006 must be complete (database migration applied, digest_queue and notification_preferences tables exist).
- D09-001 must be complete (EVENT_CATALOGUE for default preference generation).

## Tests to Write

Add tests to `apps/api/src/domains/notification/notification.test.ts`:

- addToDigestQueue inserts queue entry
- findPendingDigestItems returns unsent items for recipient
- findAllPendingDigestItems groups by recipient
- markDigestItemsSent sets digest_sent true
- findPreferencesByProvider returns all preferences for provider
- findPreference returns specific category preference
- upsertPreference creates new preference
- upsertPreference updates existing preference
- createDefaultPreferences creates entries for all event categories
- updateQuietHours sets start and end on all preferences

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/notification/notification.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
