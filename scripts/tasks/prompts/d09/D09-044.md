# Task D09-044: Security â€” data leakage prevention (no PHI in email, sanitised errors)

## What to Build

Create `apps/api/test/security/notification/notification.leakage.security.ts`.

**No PHI in email notifications:**
- Process a CLAIM_REJECTED event with metadata containing claim details (patient name, PHN, etc.) -> inspect the rendered email body -> verify it does NOT contain patient name, PHN, or claim details. The email should contain only a summary message and a link.
- Process a CLAIM_ASSESSED event -> email body contains only summary text and a link to view in app
- Process an AI_HIGH_VALUE_SUGGESTION event -> email body contains no billing code details, only a link to view in app
- All email templates contain a link to an authenticated page, not inline claim/patient data
- Verify rendered email subject lines contain no PHI

To test email content, mock the email sending function and capture the rendered email body passed to it, then inspect the content.

**Error response sanitisation:**
- Make a request without authentication -> verify 401 response body contains ONLY `{ error: "Unauthorized" }` or similar, no notification data, no stack traces
- Make a request for another user's notification -> verify 404 response body does NOT confirm the notification exists (no "notification belongs to another user" message -- just "Not found")
- Trigger a server error (e.g., temporarily break a database query if possible) -> verify 500 response body does not expose stack traces, SQL error messages, database table names, or internal file paths

**Header checks:**
- Make any authenticated request -> verify response does NOT contain `X-Powered-By` header
- Make any authenticated request -> verify response does NOT contain `Server` header revealing version info
- Make any authenticated request -> verify response contains `Strict-Transport-Security` (HSTS) header
- Verify `Content-Type` is set correctly on all responses

**WebSocket payload sanitisation:**
- Create a notification via the internal emit endpoint
- Connect via WebSocket and receive the pushed notification
- Verify the WebSocket payload contains only: notification_id, title, body, priority, action_url, event_type, metadata, created_at
- Verify the payload does NOT contain: recipient_email, recipient_id, physician_context_id, dismissed_at, or other internal database fields
- Verify metadata does not leak raw database column values

**Sensitive data not in responses:**
- GET /api/v1/notifications does NOT expose email_delivery_log details (no delivery_id, recipient_email, retry_count, etc. in the notification response)
- GET /api/v1/notification-preferences does NOT expose other physicians' preferences
- POST /api/v1/internal/notifications/emit response does NOT leak recipient resolution details (does not reveal how many delegates received the notification or their user IDs)

## Critical Security Rules

- PHI (patient names, PHNs, clinical data) must never appear in emails. This is a healthcare compliance requirement.
- Error messages must be generic -- no internal details that could help an attacker.
- WebSocket payloads are rendered content only -- no raw database internals.
- HTTP headers must not reveal technology stack details.

## Prerequisites

- D09-030 must be complete (notification feed routes).
- D09-031 must be complete (preference routes).
- D09-032 must be complete (internal routes and WebSocket endpoint).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/notification/notification.leakage.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
