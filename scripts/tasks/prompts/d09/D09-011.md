# Task D09-011: Repository â€” email delivery log, notification templates

## What to Build

Add to `apps/api/src/domains/notification/notification.repository.ts`:

**Email delivery log:**
- `createDeliveryLog(data: InsertEmailDeliveryLog)` -- insert delivery record.
- `updateDeliveryStatus(deliveryId: string, status: string, details?: { providerMessageId?, sentAt?, deliveredAt?, bouncedAt?, bounceReason? })` -- update status and relevant timestamps.
- `findPendingRetries()` -- find delivery records where status IN ('QUEUED', 'FAILED') AND next_retry_at <= now() AND retry_count < 4. For retry job.
- `incrementRetry(deliveryId: string, nextRetryAt: Date)` -- increment retry_count, set next_retry_at.
- `listDeliveryLogByNotification(notificationId: string)` -- return delivery attempts for a notification.

**Notification templates:**
- `findTemplateById(templateId: string)` -- return template or null.
- `listAllTemplates()` -- return all templates (for admin/dev use).
- `upsertTemplate(data: InsertNotificationTemplate)` -- insert or update template by template_id. Use Drizzle's `onConflictDoUpdate` targeting the template_id primary key.

Use the email_delivery_log and notification_templates table schemas from `packages/shared/src/schemas/db/notification.schema.ts`.

For `findPendingRetries`:
- Filter: `status IN ('QUEUED', 'FAILED')`
- Filter: `next_retry_at <= now()` OR `next_retry_at IS NULL` (for initial QUEUED entries)
- Filter: `retry_count < 4` (max 4 attempts per retry schedule)
- Order by: `next_retry_at ASC` (process oldest retries first)

For `updateDeliveryStatus`:
- Only update the timestamp fields that are relevant to the status transition
- SENT: set sent_at
- DELIVERED: set delivered_at
- BOUNCED: set bounced_at, bounce_reason
- FAILED: no additional timestamp needed

## Critical Security Rules

- Email delivery log contains recipient_email -- access restricted to internal services and admin.
- Templates are managed by dev team only. No physician-facing mutation endpoints.
- findPendingRetries must never expose recipient_email to unauthorized callers.

## Prerequisites

- D09-006 must be complete (database migration applied, email_delivery_log and notification_templates tables exist).

## Tests to Write

Add tests to `apps/api/src/domains/notification/notification.test.ts`:

- createDeliveryLog inserts record with QUEUED status
- updateDeliveryStatus transitions from QUEUED to SENT
- updateDeliveryStatus sets bounced_at and bounce_reason on BOUNCED
- findPendingRetries returns records where retry is due
- findPendingRetries excludes records at max retry count
- incrementRetry increases count and sets next_retry_at
- findTemplateById returns template for valid ID
- findTemplateById returns null for unknown template
- upsertTemplate inserts new template
- upsertTemplate updates existing template

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/notification/notification.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
