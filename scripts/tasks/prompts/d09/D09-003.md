# Task D09-003: Drizzle schema for email_delivery_log and notification_templates tables

## What to Build

Add to `packages/shared/src/schemas/db/notification.schema.ts`:

**email_delivery_log table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| delivery_id | UUID | PK | Default: gen_random_uuid() |
| notification_id | UUID FK | NOT NULL, FK -> notifications | |
| recipient_email | VARCHAR(100) | NOT NULL | Email address sent to |
| template_id | VARCHAR(50) | NOT NULL | Email template used |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'QUEUED' | QUEUED, SENT, DELIVERED, BOUNCED, FAILED |
| provider_message_id | VARCHAR(100) | NULLABLE | Email provider's message ID |
| sent_at | TIMESTAMPTZ | NULLABLE | |
| delivered_at | TIMESTAMPTZ | NULLABLE | |
| bounced_at | TIMESTAMPTZ | NULLABLE | |
| bounce_reason | TEXT | NULLABLE | |
| retry_count | INTEGER | NOT NULL, DEFAULT 0 | Number of retries |
| next_retry_at | TIMESTAMPTZ | NULLABLE | Scheduled retry time |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |

**Indexes:** (notification_id), (status, next_retry_at) for retry queue, (recipient_email, created_at DESC).

**notification_templates table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| template_id | VARCHAR(50) | PK | Matches event_type (e.g., 'CLAIM_REJECTED') |
| in_app_title | VARCHAR(200) | NOT NULL | Title template with {{variable}} placeholders |
| in_app_body | TEXT | NOT NULL | Body template |
| email_subject | VARCHAR(200) | NULLABLE | Null if event never sends email |
| email_html_body | TEXT | NULLABLE | HTML email body template |
| email_text_body | TEXT | NULLABLE | Plain-text fallback |
| action_url_template | VARCHAR(500) | NULLABLE | URL template with {{claim_id}}, etc. |
| action_label | VARCHAR(50) | NULLABLE | Static action button label |
| variables | JSONB | NOT NULL | Array of expected variable names |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |

Export tables and inferred types (InsertEmailDeliveryLog, SelectEmailDeliveryLog, InsertNotificationTemplate, SelectNotificationTemplate).

## Critical Security Rules

- Email delivery log contains recipient_email -- access restricted to internal services and admin only.
- Templates are managed by the dev team only. No physician-facing mutation endpoints.
- No PHI should ever be stored in templates. Templates contain placeholders, not actual patient data.

## Prerequisites

- D09-002 must be complete (notifications table must exist for FK reference from email_delivery_log).

## FRD Reference

- Domain 9 Section 5.2: email_delivery_log with status tracking, retry count, bounce handling.
- Domain 9 Section 5.3: notification_templates with variable substitution using {{variable}} syntax. Templates managed by dev team.

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
