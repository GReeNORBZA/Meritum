# Task D01-021: Service: MFA setup and recovery codes

## What to Build

Add to `apps/api/src/domains/iam/iam.service.ts`:

- `initiateMfaSetup(userId: string)` — generate TOTP secret, encrypt with AES-256-GCM, store encrypted secret. Return { qr_code_uri, manual_key } for the user to scan.
- `confirmMfaSetup(userId: string, totpCode: string)` — verify TOTP code against stored secret. If valid: set mfa_configured = true, generate 10 recovery codes, hash each with Argon2id, store hashes, return plaintext codes (shown once). Emit auth.mfa_setup audit event.
- `regenerateRecoveryCodes(userId: string, totpCode: string)` — verify current TOTP first. Generate new 10 codes, replace old ones. Emit account.recovery_codes_regenerated. Return plaintext codes.
- `reconfigureMfa(userId: string, currentTotpCode: string)` — verify current TOTP. Generate new secret and QR. Emit account.mfa_reconfigured.

**TOTP library:** Use otplib. Issuer: 'Meritum'. Algorithm: SHA1. Digits: 6. Period: 30 seconds.
**Recovery code format:** 10 codes, each 8 alphanumeric characters, grouped as XXXX-XXXX for readability.
**Encryption:** Use crypto.createCipheriv with AES-256-GCM. Key from TOTP_ENCRYPTION_KEY env var.

## Critical Security Rules

- TOTP secret is encrypted at rest with AES-256-GCM. Encryption key is from environment variable, never in database.
- Recovery codes are shown exactly once (at generation). Only Argon2id hashes are stored.
- MFA reconfiguration requires current TOTP code to prevent an attacker with session access from disabling MFA.

## Prerequisites

This task depends on the following completed tasks: D01-010, D01-012

## Tests to Write

```typescript
  it('initiateMfaSetup generates and encrypts TOTP secret');
  it('confirmMfaSetup accepts valid TOTP code');
  it('confirmMfaSetup rejects invalid TOTP code');
  it('confirmMfaSetup generates 10 recovery codes');
  it('confirmMfaSetup stores hashed (not plaintext) recovery codes');
  it('regenerateRecoveryCodes requires valid current TOTP');
  it('regenerateRecoveryCodes replaces old codes');
  it('reconfigureMfa requires valid current TOTP');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].