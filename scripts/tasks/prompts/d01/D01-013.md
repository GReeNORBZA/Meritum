# Task D01-013: Repository: delegate linkages

## What to Build

Add to `apps/api/src/domains/iam/iam.repository.ts`:

- `createDelegateLinkage(data: { physicianUserId, delegateUserId, permissions, canApproveBatches })` — insert linkage.
- `findLinkage(physicianUserId: string, delegateUserId: string)` — find active linkage.
- `listDelegatesForPhysician(physicianUserId: string)` — list active delegates with user info (name, email, last login).
- `listPhysiciansForDelegate(delegateUserId: string)` — list physicians the delegate serves, with permissions per physician.
- `updateLinkagePermissions(linkageId: string, permissions: string[], canApproveBatches: boolean)` — update permissions JSONB.
- `deactivateLinkage(linkageId: string)` — set is_active = false.

## Critical Security Rules

- UNIQUE constraint on (physician_user_id, delegate_user_id) prevents duplicate linkages.
- listDelegatesForPhysician only returns delegates for the specified physician — physician-scoped.
- Deactivating a linkage must also trigger session revocation for the delegate's sessions in this physician context (handled by service layer).

## Prerequisites

This task depends on the following completed tasks: D01-007

## Tests to Write

```typescript
  it('createDelegateLinkage creates active linkage');
  it('createDelegateLinkage rejects duplicate physician-delegate pair');
  it('listDelegatesForPhysician returns only this physician's delegates');
  it('listPhysiciansForDelegate returns only this delegate's physicians');
  it('updateLinkagePermissions replaces permission set');
  it('deactivateLinkage sets is_active false');
  it('findLinkage returns null for inactive linkage');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].