# Task D01-004: Drizzle schema for delegate_linkages and audit_log tables

## What to Build

Add to `packages/shared/src/schemas/db/iam.schema.ts`:

**delegate_linkages table:**

| Column | Type | Constraints |
|--------|------|-------------|
| linkage_id | UUID | PK |
| physician_user_id | UUID FK | NOT NULL, FK → users |
| delegate_user_id | UUID FK | NOT NULL, FK → users |
| permissions | JSONB | NOT NULL (array of permission keys) |
| can_approve_batches | BOOLEAN | NOT NULL, DEFAULT false |
| is_active | BOOLEAN | NOT NULL, DEFAULT true |
| created_at | TIMESTAMPTZ | NOT NULL |
| updated_at | TIMESTAMPTZ | NOT NULL |

Constraints: UNIQUE(physician_user_id, delegate_user_id). Index on (delegate_user_id, is_active).

**audit_log table:**

| Column | Type | Constraints |
|--------|------|-------------|
| log_id | UUID | PK |
| user_id | UUID FK | NULLABLE (null for system actions) |
| action | VARCHAR(50) | NOT NULL |
| category | VARCHAR(20) | NOT NULL |
| resource_type | VARCHAR(50) | NULLABLE |
| resource_id | UUID | NULLABLE |
| detail | JSONB | NULLABLE (action-specific metadata) |
| ip_address | VARCHAR(45) | NULLABLE |
| user_agent | TEXT | NULLABLE |
| created_at | TIMESTAMPTZ | NOT NULL |

Indexes: (user_id, created_at DESC), (action, created_at DESC), (resource_type, resource_id, created_at DESC). Partition by month for query performance.

**CRITICAL:** Audit log is append-only. No UPDATE or DELETE operations. 7-year retention.

## Critical Security Rules

- Audit log must be append-only. The repository must NOT expose update or delete functions.
- Audit log queries are themselves logged (action: audit.queried).
- JSONB detail field must never contain plaintext passwords, TOTP secrets, or session tokens.

## Prerequisites

This task depends on the following completed tasks: D01-002

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].