# Task D01-025: Service: account management and deletion

## What to Build

Add to `apps/api/src/domains/iam/iam.service.ts`:

- `getAccount(userId: string)` — return account info (name, email, role, subscription_status, mfa_configured).
- `updateAccount(userId: string, data: AccountUpdateInput)` — update name, phone. Email change is not supported via this endpoint (requires re-verification flow, deferred).
- `requestAccountDeletion(userId: string, password: string, totpCode: string, confirmation: string)` — verify password, verify TOTP, verify confirmation === 'DELETE'. Cancel Stripe subscription. Invalidate all sessions. Deactivate all delegate linkages (notify delegates). Schedule data deletion in 30 days. Emit account.deletion_requested.
- `checkSubscriptionAccess(userId: string)` — return subscription status and access level (full, read_only, suspended). Used by auth middleware.

## Critical Security Rules

- Account deletion requires three-factor confirmation: password + TOTP + typed 'DELETE'.
- Deletion is soft for 30 days (grace period). Data portability export must be available during grace period.
- All delegate linkages deactivated on deletion — delegates lose access immediately.
- Subscription cancellation via Stripe must happen synchronously before marking deletion.

## Prerequisites

This task depends on the following completed tasks: D01-010, D01-013

## Tests to Write

```typescript
  it('getAccount returns account info without sensitive fields');
  it('updateAccount updates name and phone');
  it('updateAccount does not update email or password');
  it('requestAccountDeletion requires correct password');
  it('requestAccountDeletion requires valid TOTP');
  it('requestAccountDeletion requires 'DELETE' confirmation');
  it('requestAccountDeletion invalidates all sessions');
  it('requestAccountDeletion deactivates delegate linkages');
  it('requestAccountDeletion schedules deletion in 30 days');
  it('checkSubscriptionAccess returns correct access level for each status');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].