# Task D01-023: Service: session management and password reset

## What to Build

Add to `apps/api/src/domains/iam/iam.service.ts`:

**Session management:**
- `validateSession(tokenHash: string)` — find session, check expiry, refresh idle timer. Return AuthContext object or null.
- `listSessions(userId: string)` — return active sessions (id, ip, user_agent, created_at, last_active_at).
- `revokeSession(userId: string, sessionId: string)` — revoke specific session. Verify it belongs to userId. Emit auth.session_revoked.
- `revokeAllSessions(userId: string, currentSessionId: string)` — revoke all except current. Emit auth.session_revoked_all.
- `logout(sessionId: string)` — revoke with reason 'logout'. Emit auth.logout.

**Password reset:**
- `requestPasswordReset(email: string)` — always return success (anti-enumeration). If user exists: generate reset token (UUID), store SHA-256 hash with 1-hour expiry, emit USER_PASSWORD_RESET_REQUESTED event for notification.
- `resetPassword(token: string, newPassword: string)` — verify token hash, check expiry. Hash new password. Update user. Invalidate ALL sessions (force re-login). Emit auth.password_reset_completed.

## Critical Security Rules

- validateSession must check BOTH absolute expiry (24h) and idle expiry (60min). Either exceeded → session invalid.
- revokeSession must verify the session belongs to the requesting userId — no cross-user session revocation.
- requestPasswordReset: anti-enumeration. Same response whether email exists or not. Same response time.
- resetPassword invalidates ALL sessions — attacker with stolen session is forced out when password changes.

## Prerequisites

This task depends on the following completed tasks: D01-011

## Tests to Write

```typescript
  it('validateSession returns AuthContext for valid session');
  it('validateSession returns null for expired session (absolute)');
  it('validateSession returns null for expired session (idle)');
  it('validateSession refreshes idle timer on success');
  it('revokeSession revokes session belonging to user');
  it('revokeSession rejects session belonging to different user');
  it('revokeAllSessions keeps current session active');
  it('requestPasswordReset always returns success');
  it('resetPassword with valid token updates password');
  it('resetPassword invalidates all sessions');
  it('resetPassword with expired token returns error');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].