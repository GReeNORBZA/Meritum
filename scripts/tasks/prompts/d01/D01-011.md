# Task D01-011: Repository: session management

## What to Build

Add to `apps/api/src/domains/iam/iam.repository.ts` — session operations:

- `createSession(data: { userId, tokenHash, ipAddress, userAgent })` — insert session.
- `findSessionByTokenHash(tokenHash: string)` — find non-revoked session. Join with users to get role, subscription_status.
- `refreshSession(sessionId: string)` — update last_active_at to now().
- `revokeSession(sessionId: string, reason: RevokeReason)` — set revoked = true, revoked_reason.
- `revokeAllUserSessions(userId: string, exceptSessionId?: string, reason: RevokeReason)` — revoke all sessions for user except optionally the current one.
- `listActiveSessions(userId: string)` — list non-revoked sessions with ip, user_agent, created_at, last_active_at.
- `isSessionExpired(session)` — check absolute (24h from created_at) and idle (60min from last_active_at) expiry.
- `cleanupExpiredSessions()` — delete sessions where revoked=true AND created_at < 30 days ago (housekeeping).

## Critical Security Rules

- findSessionByTokenHash must check revoked = false AND not expired (both absolute and idle).
- Session validation must be constant-time to prevent timing attacks on token_hash comparison (use database WHERE clause, not application-level comparison).
- listActiveSessions only returns sessions for the specified userId — no cross-user leakage.

## Prerequisites

This task depends on the following completed tasks: D01-007

## Tests to Write

```typescript
  it('createSession stores session with hashed token');
  it('findSessionByTokenHash returns session with user data');
  it('findSessionByTokenHash returns null for revoked session');
  it('findSessionByTokenHash returns null for expired session (absolute)');
  it('findSessionByTokenHash returns null for expired session (idle)');
  it('refreshSession updates last_active_at');
  it('revokeSession sets revoked flag and reason');
  it('revokeAllUserSessions revokes all except current');
  it('listActiveSessions returns only non-revoked sessions');
  it('cleanupExpiredSessions removes old revoked sessions');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].