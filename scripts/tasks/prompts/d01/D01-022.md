# Task D01-022: Service: login flow (password + MFA + session creation)

## What to Build

Add to `apps/api/src/domains/iam/iam.service.ts`:

- `loginStep1(email: string, password: string, ipAddress: string)` — find user by email. Verify password with Argon2id. Check account not locked. If valid: generate MFA session token (short-lived, 5 min), emit auth.login_success audit event, return { mfa_required: true, mfa_session_token }. If invalid: increment failed login, emit auth.login_failed, return generic error.
- `loginStep2Mfa(mfaSessionToken: string, totpCode: string, ipAddress: string, userAgent: string)` — validate MFA session token, verify TOTP code. If valid: create session, generate session token, reset failed login count. Return session token (to be set as cookie by handler).
- `loginStep2Recovery(mfaSessionToken: string, recoveryCode: string, ipAddress: string, userAgent: string)` — validate MFA session token, compare recovery code against all unused hashes. If match: mark used, create session, emit auth.login_recovery_used. Return session token + remaining_codes count.

**MFA session token:** Short-lived JWT (5 min expiry) containing user_id. Signs with SESSION_SECRET. Only used to bridge the two login steps.
**Session token:** Generate 32 random bytes, hex-encode. Store SHA-256 hash in sessions table. Set as HTTP-only cookie.
**Anti-enumeration:** Same error message for wrong email and wrong password ('Invalid credentials').

## Critical Security Rules

- Anti-enumeration: 'Invalid credentials' for both wrong email and wrong password. Same response time (use constant-time comparison even when user not found).
- Account lockout: 10 failed attempts → 30 minute lock. Failed MFA attempts also count.
- MFA session token expires after 5 minutes — prevents indefinite MFA bypass window.
- Session token: 32 random bytes. Only SHA-256 hash stored in DB. Plaintext only in cookie.
- Recovery code comparison: load all unused hashes, Argon2id verify each. This is intentionally slow for security.

## Prerequisites

This task depends on the following completed tasks: D01-010, D01-011, D01-012

## Tests to Write

```typescript
  it('loginStep1 with valid credentials returns mfa_session_token');
  it('loginStep1 with wrong password returns generic error');
  it('loginStep1 with non-existent email returns same generic error');
  it('loginStep1 with locked account returns locked error');
  it('loginStep1 increments failed count on failure');
  it('loginStep2Mfa with valid TOTP creates session');
  it('loginStep2Mfa with invalid TOTP returns error');
  it('loginStep2Mfa with expired mfa_session_token returns error');
  it('loginStep2Recovery with valid recovery code creates session');
  it('loginStep2Recovery marks code as used');
  it('loginStep2Recovery returns remaining code count');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].