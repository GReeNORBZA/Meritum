# Task D01-010: Repository: user CRUD operations

## What to Build

Create `apps/api/src/domains/iam/iam.repository.ts` with user operations:

- `createUser(data: InsertUser)` — insert new user. Lowercase email before insert.
- `findUserByEmail(email: string)` — find by normalised email. Include is_active check.
- `findUserById(userId: string)` — find by UUID.
- `updateUser(userId: string, data: Partial<UpdateUser>)` — update allowed fields. Set updated_at.
- `incrementFailedLogin(userId: string)` — increment failed_login_count. If >= 10, set locked_until to now + 30 minutes.
- `resetFailedLogin(userId: string)` — set failed_login_count to 0, clear locked_until.
- `isAccountLocked(userId: string)` — return true if locked_until > now.
- `setMfaSecret(userId: string, encryptedSecret: string)` — store encrypted TOTP secret.
- `setMfaConfigured(userId: string)` — set mfa_configured = true.
- `deactivateUser(userId: string)` — set is_active = false (soft delete).

Create `apps/api/src/domains/iam/iam.test.ts` with unit tests for each function.

## Critical Security Rules

- findUserByEmail normalises email to lowercase before query.
- updateUser must NOT allow updating email, password_hash, or totp_secret_encrypted through this function (separate dedicated functions).
- isAccountLocked must use database time (now()), not application time, to prevent clock skew bypass.

## Prerequisites

This task depends on the following completed tasks: D01-007

## Tests to Write

```typescript
  it('createUser stores user with lowercase email');
  it('createUser rejects duplicate email');
  it('findUserByEmail is case-insensitive');
  it('findUserByEmail excludes inactive users');
  it('incrementFailedLogin locks account after 10 failures');
  it('resetFailedLogin clears lock');
  it('isAccountLocked returns true during lock period');
  it('isAccountLocked returns false after lock expires');
  it('deactivateUser sets is_active to false');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].