# Task D01-030: Auth middleware: authenticate, authorize, checkSubscription, auditLog plugins

## What to Build

Create `apps/api/src/plugins/auth.plugin.ts` as a Fastify plugin that decorates requests with auth context:

**authenticate(request, reply):**
- Extract session token from HTTP-only cookie
- SHA-256 hash the token
- Call validateSession to check expiry and get user data
- If invalid: reply 401
- If valid: populate request.authContext with AuthContext object

**authorize(...requiredPermissions: string[]):**
- Returns a preHandler function
- If role is physician: all permissions granted (pass)
- If role is delegate: check delegateContext.permissions includes all required permissions
- If role is admin: all permissions granted
- If insufficient: reply 403

**checkSubscription(...allowedStatuses: string[]):**
- Returns a preHandler function
- Check request.authContext.subscriptionStatus is in allowedStatuses
- If suspended: return 402 with ACCOUNT_SUSPENDED
- If cancelled: return 402 with SUBSCRIPTION_REQUIRED

**auditLog plugin:**
- Fastify onResponse hook that logs every request: userId, action (derived from route), ip, user_agent
- Only logs state-changing requests (POST, PUT, PATCH, DELETE) by default
- Configurable per route via route metadata

Also create `apps/api/src/plugins/rate-limit.plugin.ts`:
- Use @fastify/rate-limit
- Default: 100 req/min per user
- Auth endpoints: 10 req/min per IP
- File uploads: 5 req/min per user

## Critical Security Rules

- Session token extracted from cookie only (never from Authorization header or query parameter).
- authorize must handle missing delegateContext gracefully (delegate without active physician context gets 403).
- Rate limiting on auth endpoints is per-IP, not per-user (unauthenticated requests).
- Audit log hook must not log sensitive request body fields (password, totp_code, recovery_code).

## Prerequisites

This task depends on the following completed tasks: D01-023

## Tests to Write

```typescript
  it('authenticate rejects request without cookie');
  it('authenticate rejects request with invalid token');
  it('authenticate populates authContext on valid session');
  it('authorize allows physician for any permission');
  it('authorize allows delegate with matching permission');
  it('authorize rejects delegate without matching permission');
  it('checkSubscription allows active status');
  it('checkSubscription returns 402 for suspended');
  it('rate limiting blocks after threshold exceeded');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].