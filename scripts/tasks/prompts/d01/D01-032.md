# Task D01-032: Routes: session, delegate, and account endpoints

## What to Build

Add to `apps/api/src/domains/iam/iam.routes.ts` and handlers:

**Session routes (auth required):**
- GET /api/v1/sessions → listSessionsHandler
- DELETE /api/v1/sessions/:id → revokeSessionHandler (params: sessionIdParamSchema)
- DELETE /api/v1/sessions → revokeAllSessionsHandler

**Delegate routes (auth required, physician role):**
- POST /api/v1/delegates/invite → inviteHandler (body: delegateInviteSchema)
- GET /api/v1/delegates → listDelegatesHandler
- PATCH /api/v1/delegates/:id/permissions → updatePermissionsHandler (body: delegateUpdatePermissionsSchema)
- DELETE /api/v1/delegates/:id → revokeHandler
- POST /api/v1/delegates/accept → acceptHandler (body: delegateAcceptSchema, no auth required)
- GET /api/v1/delegates/physicians → listPhysiciansHandler (delegate role)

**Account routes (auth required):**
- GET /api/v1/account → getAccountHandler
- PATCH /api/v1/account → updateAccountHandler (body: accountUpdateSchema)
- POST /api/v1/account/mfa/regenerate-codes → regenerateCodesHandler (body: mfaConfirmSchema)
- POST /api/v1/account/mfa/reconfigure → reconfigureMfaHandler (body: mfaReconfigureSchema)
- POST /api/v1/account/delete → deleteAccountHandler (body: accountDeleteSchema)
- GET /api/v1/account/audit-log → auditLogHandler (query: auditLogQuerySchema)

Create `apps/api/test/integration/iam/sessions.integration.ts`, `delegates.integration.ts`, and `account.integration.ts`.

## Critical Security Rules

- Delegate management routes require physician role (except /delegates/accept and /delegates/physicians).
- /delegates/physicians requires delegate role.
- Account delete route requires physician role (delegates cannot delete physician accounts).
- Audit log route requires physician or admin role.

## Prerequisites

This task depends on the following completed tasks: D01-023, D01-024, D01-025, D01-030

## Tests to Write

```typescript
  it('GET /sessions returns active sessions for authenticated user');
  it('DELETE /sessions/:id revokes specific session');
  it('POST /delegates/invite creates invitation');
  it('POST /delegates/invite as delegate returns 403');
  it('POST /delegates/accept with valid token creates linkage');
  it('GET /delegates/physicians returns linked physicians for delegate');
  it('PATCH /delegates/:id/permissions updates permissions');
  it('DELETE /delegates/:id revokes delegate');
  it('GET /account returns account info');
  it('POST /account/delete with valid 3-factor confirmation succeeds');
  it('GET /account/audit-log returns paginated log');
```

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/iam/
```

All tests must pass before outputting [TASK_COMPLETE].