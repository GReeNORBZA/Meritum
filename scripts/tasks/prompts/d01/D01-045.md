# Task D01-045: Security: audit trail completeness

## What to Build

Create `apps/api/test/security/iam/iam.audit.security.ts`.

Verify that each security-relevant action produces an audit record. Run the action, then query the audit log and verify the entry exists with correct fields.

**Authentication events:**
- Successful login → auth.login_success with ip_address
- Failed login → auth.login_failed with ip_address
- MFA success → auth.login_mfa_success
- Recovery code used → auth.login_recovery_used with remaining count
- Logout → auth.logout
- Session revoked → auth.session_revoked

**Delegate events:**
- Delegate invited → delegate.invited with delegate_email
- Invitation accepted → delegate.accepted
- Permissions updated → delegate.permissions_updated with old and new permissions
- Delegate revoked → delegate.revoked

**Account events:**
- Account updated → account.updated with changed fields
- MFA reconfigured → account.mfa_reconfigured
- Recovery codes regenerated → account.recovery_codes_regenerated
- Account deletion requested → account.deletion_requested

**Audit log integrity:**
- Verify no UPDATE endpoints exist for audit_log
- Verify no DELETE endpoints exist for audit_log
- Verify querying the audit log produces audit.queried entry

## Prerequisites

This task depends on the following completed tasks: D01-031, D01-032

## Run After Completion

```bash
pnpm --filter api vitest run test/security/iam/iam.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].