# Task D01-020: Service: registration and email verification

## What to Build

Create `apps/api/src/domains/iam/iam.service.ts` with registration functions:

- `registerUser(data: RegisterInput)` — hash password with Argon2id, create user, generate email verification token, emit auth.registered audit event, emit USER_REGISTERED event for notification service. Return user_id.
- `verifyEmail(token: string)` — validate token, set email_verified = true, emit auth.email_verified audit event. Return { mfa_setup_required: true }.

**Password hashing:** Use @node-rs/argon2 with parameters from CLAUDE.md (memory 19456, iterations 2, parallelism 1).
**Email verification token:** Generate UUID, store SHA-256 hash in a verification_tokens record (or reuse invitation_tokens with a type field). Token expires after 24 hours.
**Anti-enumeration:** Registration always succeeds from the client's perspective. If email exists, send a 'someone tried to register with your email' notification instead of an error.

## Critical Security Rules

- Anti-enumeration: never reveal whether an email is already registered. Return the same response regardless.
- Password is hashed before any database write. Plaintext password must not appear in logs or error messages.
- Email verification token is stored as SHA-256 hash, not plaintext.

## Prerequisites

This task depends on the following completed tasks: D01-010

## Tests to Write

```typescript
  it('registerUser hashes password with Argon2id');
  it('registerUser normalises email to lowercase');
  it('registerUser emits audit event');
  it('registerUser with existing email does not reveal email exists');
  it('verifyEmail with valid token sets email_verified true');
  it('verifyEmail with expired token returns error');
  it('verifyEmail with invalid token returns error');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].