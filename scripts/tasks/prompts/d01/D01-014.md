# Task D01-014: Repository: audit log (append-only)

## What to Build

Add to `apps/api/src/domains/iam/iam.repository.ts`:

- `appendAuditLog(entry: AuditLogEntry)` — insert a single audit entry. This is the ONLY write operation on the audit_log table.
- `queryAuditLog(userId: string, filters: AuditLogFilters)` — paginated query filtered by action, category, date range. Returns in reverse chronological order. Max 200 per page.
- `querySystemAuditLog(filters: AuditLogFilters)` — admin-only: query across all users.
- `exportAuditLog(userId: string, filters: AuditLogFilters)` — return all matching entries as an array for CSV export (no pagination limit, but date range required).

**CRITICAL: Do NOT create update or delete functions for audit_log. The table is append-only.**

## Critical Security Rules

- Audit log is append-only. No update, no delete. This is a hard requirement.
- queryAuditLog scopes to the specified userId — a physician can only see their own audit trail.
- querySystemAuditLog is for admin role only. The route guard (not the repository) enforces this.
- The audit log repository itself logs audit.queried when queryAuditLog is called (via the service layer).
- JSONB detail field must be sanitised before storage: no plaintext passwords, tokens, or TOTP secrets.

## Prerequisites

This task depends on the following completed tasks: D01-007

## Tests to Write

```typescript
  it('appendAuditLog inserts entry with correct fields');
  it('queryAuditLog returns only entries for specified user');
  it('queryAuditLog respects date range filter');
  it('queryAuditLog respects action filter');
  it('queryAuditLog paginates correctly (50 default, max 200)');
  it('queryAuditLog returns reverse chronological order');
  it('exportAuditLog requires date range');
  it('audit_log has no update function');
  it('audit_log has no delete function');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].