# Task D01-024: Service: delegate management

## What to Build

Add to `apps/api/src/domains/iam/iam.service.ts`:

- `inviteDelegate(physicianUserId: string, email: string, permissions: string[])` — validate permissions are a subset of allowed delegate permissions. Generate invitation token. Store hash. Send DELEGATE_INVITED event for notification. Emit delegate.invited audit.
- `acceptInvitation(token: string, registrationData?: { fullName, password })` — verify invitation token. If delegate email matches existing user: create linkage. If new user: create account + linkage. Emit delegate.accepted. Return linkage_id.
- `listDelegates(physicianUserId: string)` — return delegates with permissions, last login, active status.
- `updateDelegatePermissions(physicianUserId: string, linkageId: string, permissions: string[], canApproveBatches: boolean)` — verify linkage belongs to physician. Update. Emit delegate.permissions_updated.
- `revokeDelegate(physicianUserId: string, linkageId: string)` — deactivate linkage. Revoke delegate's sessions for this physician context. Emit delegate.revoked.
- `listPhysiciansForDelegate(delegateUserId: string)` — return physician list with permissions per physician.
- `switchPhysicianContext(delegateUserId: string, physicianUserId: string)` — verify active linkage exists. Return updated AuthContext with delegateContext populated. Emit delegate.context_switched.

## Critical Security Rules

- Delegate permissions must be validated against the allowed set — delegates cannot be granted DELEGATE_MANAGE, SUBSCRIPTION_MANAGE, or DATA_EXPORT.
- Revoking a delegate must immediately invalidate their sessions for this physician context.
- switchPhysicianContext must verify an active linkage exists — delegate cannot access an unlinked physician.
- Invitation token is hashed before storage. Plaintext only in email.

## Prerequisites

This task depends on the following completed tasks: D01-012, D01-013

## Tests to Write

```typescript
  it('inviteDelegate generates invitation and emits event');
  it('inviteDelegate rejects invalid permissions');
  it('acceptInvitation creates linkage for existing user');
  it('acceptInvitation creates new user account for new delegate');
  it('acceptInvitation rejects expired invitation');
  it('acceptInvitation rejects already-accepted invitation');
  it('updateDelegatePermissions rejects if linkage belongs to different physician');
  it('revokeDelegate deactivates linkage');
  it('revokeDelegate revokes delegate sessions');
  it('switchPhysicianContext succeeds with active linkage');
  it('switchPhysicianContext fails without active linkage');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/iam/iam.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].