# Task D01-031: Routes: authentication endpoints (register, login, MFA, password reset)

## What to Build

Create `apps/api/src/domains/iam/iam.routes.ts` and `apps/api/src/domains/iam/iam.handlers.ts`.

**Auth routes (no auth required):**
- POST /api/v1/auth/register → registerHandler (body: registerSchema)
- POST /api/v1/auth/verify-email → verifyEmailHandler (body: verifyEmailSchema)
- POST /api/v1/auth/login → loginStep1Handler (body: loginSchema)
- POST /api/v1/auth/login/mfa → loginStep2MfaHandler (body: loginMfaSchema)
- POST /api/v1/auth/login/recovery → loginStep2RecoveryHandler (body: loginRecoverySchema)
- POST /api/v1/auth/password/reset-request → passwordResetRequestHandler (body: passwordResetRequestSchema)
- POST /api/v1/auth/password/reset → passwordResetHandler (body: passwordResetSchema)

**Auth routes (auth required):**
- POST /api/v1/auth/mfa/setup → mfaSetupHandler (requires email-verified session)
- POST /api/v1/auth/mfa/confirm → mfaConfirmHandler (body: mfaConfirmSchema)
- POST /api/v1/auth/logout → logoutHandler

**Handlers are thin:** validate input (via Zod schema on route), call service function, format response.

Also create `apps/api/test/integration/iam/auth.integration.ts` with full request/response integration tests.

## Critical Security Rules

- Login handlers set session cookie: HttpOnly, Secure, SameSite=Lax, Path=/, maxAge=86400.
- Logout handler clears the cookie.
- All auth endpoints rate-limited at 10 req/min per IP.
- Registration and password reset always return 200 (anti-enumeration).

## Prerequisites

This task depends on the following completed tasks: D01-020, D01-021, D01-022, D01-023, D01-030

## Tests to Write

```typescript
  it('POST /auth/register with valid data returns 201');
  it('POST /auth/register with invalid email returns 400');
  it('POST /auth/register with weak password returns 400');
  it('POST /auth/login with valid credentials returns mfa_session_token');
  it('POST /auth/login/mfa with valid TOTP sets session cookie');
  it('POST /auth/login/recovery with valid code sets session cookie');
  it('POST /auth/logout clears session cookie');
  it('POST /auth/password/reset-request always returns 200');
```

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/iam/
```

All tests must pass before outputting [TASK_COMPLETE].