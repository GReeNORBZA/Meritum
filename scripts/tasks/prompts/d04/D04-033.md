# Task D04-033: Integration tests — EMR import, ED shift workflow, auto-submission modes, deadline expiry

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/integration/claim/import.integration.ts`, `shift.integration.ts`, `auto-submission.integration.ts`.

**EMR import tests:**
- Upload CSV with comma delimiter -> parse -> preview -> commit -> claims created
- Upload with header row and without header row
- Upload with multiple date formats
- Partial failure: some rows succeed, some fail -> correct counts
- Duplicate file detection via SHA-256
- Field mapping template reuse across imports

**ED shift tests:**
- Create shift -> add encounters -> complete -> verify after-hours calculation triggered
- Add encounter to completed shift -> rejected
- Shift encounter count matches actual claims

**Auto-submission mode tests:**
- Auto Clean: clean claim auto-included, flagged excluded
- Auto All: both clean and flagged included
- Require Approval: no claims without explicit approval
- Delegate approval of flagged claim: included in next batch

**Deadline expiry test:**
- Create claim with old DOS (past 90 days) -> verify EXPIRED transition
- Claim within 7 days of deadline -> verify DEADLINE_APPROACHING notification emitted

## FRD References

- Domain 4.0 Section 9.2: Auto-submission mode tests for all three modes plus delegate approval.
- Domain 4.0 Section 9.4: EMR import tests — delimiters, headers, date formats, partial failures, template reuse, hash dedup.
- Domain 4.0 Section 9.5: ED shift workflow integration test, 90-day expiry test.

## Required Tests

Create integration tests across the test files:

- EMR import: CSV comma delimiter parses correctly
- EMR import: partial failure reports correct counts
- EMR import: duplicate file rejected by hash
- EMR import: template reuse across imports
- ED shift: create -> encounters -> complete lifecycle
- ED shift: reject encounter on completed shift
- Auto-submission: Auto Clean includes clean only
- Auto-submission: Auto All includes both
- Auto-submission: Require Approval blocks all without approval
- Deadline expiry transitions claim to EXPIRED
- Deadline approaching emits notification

## Dependencies

- D04-030 must be complete (claim routes).
- D04-031 must be complete (import, shift, export routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/claim/
```

All tests must pass before outputting [TASK_COMPLETE].
