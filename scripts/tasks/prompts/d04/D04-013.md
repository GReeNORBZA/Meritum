# Task D04-013: Repository — field mapping templates CRUD

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.repository.ts`:

- `createTemplate(data: InsertFieldMappingTemplate)` — insert template. Return template_id.
- `findTemplateById(templateId: string, physicianId: string)` — physician-scoped lookup.
- `updateTemplate(templateId: string, physicianId: string, data: Partial<InsertFieldMappingTemplate>)` — update template fields.
- `deleteTemplate(templateId: string, physicianId: string)` — hard delete (templates are not PHI). Verify physician ownership.
- `listTemplates(physicianId: string)` — list all templates for physician.

## Security Requirements

- Templates are physician-scoped. A physician can only see and manage their own templates.
- deleteTemplate verifies physician ownership before deletion.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- createTemplate creates template for physician
- findTemplateById returns template for owning physician
- findTemplateById returns null for different physician
- updateTemplate updates mapping fields
- updateTemplate rejects update for wrong physician
- deleteTemplate removes template for owning physician
- deleteTemplate rejects delete for wrong physician
- listTemplates returns only physician's templates

## Dependencies

- D04-007 must be complete (database migration applied, field_mapping_templates table exists).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
