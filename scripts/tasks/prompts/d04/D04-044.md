# Task D04-044: Security — data leakage prevention (PHI protection)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/security/claim/claim.leakage.security.ts`.

**PHI not in error responses:**
- 400 validation error does not include patient PHN or DOB in error message
- 404 response for cross-physician claim does not reveal claim exists
- 409 state transition error does not leak claim details to wrong physician
- 500 error does not expose stack traces, SQL errors, or internal details

**PHI not in headers:**
- No X-Powered-By header
- No Server header revealing version
- HSTS header present
- CSP headers present
- No claim data in response headers

**PHI not in logs (verify log output):**
- Patient PHN does not appear in application logs
- Validation errors logged without PHI details

**Sensitive fields stripped from responses:**
- Claim response does not expose internal fields (e.g., raw JSONB internals that could leak provider setup)
- Import error_details do not expose other patients' data
- Export download URL is authenticated — not guessable

**Data export security:**
- Export file download requires valid session
- Export file URL expires after download or timeout
- Export files not accessible via direct URL without auth

Use the test helpers/fixtures from the project. Follow security test patterns from Domain 1 and Domain 5. See `CLAUDE.md` for coding conventions.

## Dependencies

- D04-030 must be complete (claim CRUD and state transition routes).
- D04-031 must be complete (import, template, shift, export routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/claim/claim.leakage.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
