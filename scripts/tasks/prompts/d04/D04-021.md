# Task D04-021: Service — validation engine (pipeline structure, shared checks S1-S7, result format)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.service.ts`:

- `validateClaim(claimId: string, physicianId: string)` — run full validation pipeline. Store result on claim. Return structured ValidationResult.

**Pipeline structure (ordered):**
1. S1: Claim type valid — claim_type is AHCIP or WCB. If fails, short-circuit all subsequent checks.
2. S2: Required base fields — physician_id, patient_id, date_of_service present.
3. S3: Patient exists — patient_id resolves to a valid patient record (call Patient Registry).
4. S4: Physician active — physician_id resolves to active provider with valid BA (call Provider Management).
5. S5: DOS valid — date_of_service is valid date, not future, not before physician registration date.
6. S6: Submission window — check deadline. Error if expired. Warning if within 7 days.
7. S7: Duplicate detection — same patient + same DOS + same primary service code in existing non-deleted claims. Warning, not error.

**After shared checks:** delegate to AHCIP module (Domain 4.1) or WCB module (Domain 4.2) based on claim_type. For now, create the delegation hook as an interface — pathway modules will implement it.

**After validation:** send claim context to Intelligence Engine (Domain 7) for AI Coach analysis (non-blocking). Store suggestions on claim.

**ValidationResult format:**
- errors: Array<{ check, rule_reference, message, help_text, field_affected }>
- warnings: Array<same structure>
- info: Array<{ check, rule_reference, message, help_text }>
- passed: boolean (true if zero errors)
- validation_timestamp: ISO timestamp
- reference_data_version: string

**State effect:** If zero errors and current state is DRAFT -> transition to VALIDATED.

## FRD References

- Domain 4.0 Section 4.1: Validation pipeline — ordered checks with short-circuit. Shared checks then pathway delegation.
- Domain 4.0 Section 4.2: Validation result structure — errors, warnings, info, passed, timestamp, reference_data_version.
- Domain 4.0 Section 4.3: Seven shared checks (S1-S7) with severity assignments.
- Domain 4.0 Section 4.4: Validation runs on save, on queue, and pre-batch. Always uses current reference data version.

## Security Requirements

- reference_data_version is recorded for audit traceability — if rules change, the audit shows which version was in effect.
- Duplicate detection is a warning, not an error — intentional duplicates are valid in some scenarios (e.g., radiology).
- Validation always uses current reference data version. No caching stale rules.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- validateClaim runs all 7 shared checks in order
- S1 failure short-circuits all subsequent checks
- S2 returns error for missing required fields
- S3 returns error for non-existent patient
- S4 returns error for inactive physician
- S5 returns error for future date_of_service
- S6 returns error for expired submission window
- S6 returns warning for claim within 7 days of deadline
- S7 returns warning for duplicate match
- validateClaim stores result with reference_data_version
- validateClaim transitions DRAFT -> VALIDATED on pass
- validateClaim does not transition on errors

## Dependencies

- D04-010 must be complete (claim repository CRUD).
- D04-011 must be complete (state transition and validation result repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
