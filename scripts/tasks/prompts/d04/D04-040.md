# Task D04-040: Security — authentication enforcement on every route

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/security/claim/claim.authn.security.ts`.

Test every authenticated route in the Claim domain returns 401 without a valid session cookie. This includes:

- POST /api/v1/claims
- GET /api/v1/claims
- GET /api/v1/claims/:id
- PUT /api/v1/claims/:id
- DELETE /api/v1/claims/:id
- POST /api/v1/claims/:id/validate
- POST /api/v1/claims/:id/queue
- POST /api/v1/claims/:id/unqueue
- POST /api/v1/claims/:id/write-off
- POST /api/v1/claims/:id/resubmit
- GET /api/v1/claims/:id/suggestions
- POST /api/v1/claims/:id/suggestions/:sug_id/accept
- POST /api/v1/claims/:id/suggestions/:sug_id/dismiss
- GET /api/v1/claims/rejected
- GET /api/v1/claims/:id/rejection-details
- GET /api/v1/claims/:id/audit
- POST /api/v1/imports
- GET /api/v1/imports/:id
- GET /api/v1/imports/:id/preview
- POST /api/v1/imports/:id/commit
- POST /api/v1/field-mapping-templates
- GET /api/v1/field-mapping-templates
- PUT /api/v1/field-mapping-templates/:id
- DELETE /api/v1/field-mapping-templates/:id
- POST /api/v1/shifts
- POST /api/v1/shifts/:id/encounters
- PUT /api/v1/shifts/:id/complete
- GET /api/v1/shifts/:id
- POST /api/v1/exports
- GET /api/v1/exports/:id
- GET /api/v1/submission-preferences
- PUT /api/v1/submission-preferences

For each route: send request with no cookie, with expired cookie, and with tampered cookie. All must return 401 with no data leakage.

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference) and Domain 5 (check `apps/api/test/security/provider/` for reference). See `CLAUDE.md` for coding conventions.

## Security Requirements

- 401 responses must not contain any data in the response body beyond the error object.
- Tampered cookies must be rejected (invalid signature / hash mismatch).
- Expired sessions must return 401 (not 200 with stale data).

## Dependencies

- D04-030 must be complete (claim CRUD and state transition routes).
- D04-031 must be complete (import, template, shift, export, preferences routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/claim/claim.authn.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
