# Task D04-015: Repository — claim audit history (append-only)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.repository.ts`:

- `appendClaimAudit(entry: InsertClaimAuditHistory)` — insert audit entry. This is the ONLY write operation on claim_audit_history.
- `getClaimAuditHistory(claimId: string, physicianId: string)` — return all audit entries for a claim, reverse chronological. Verify claim belongs to physician before returning.
- `getClaimAuditHistoryPaginated(claimId: string, physicianId: string, page: number, pageSize: number)` — paginated version.

**CRITICAL: Do NOT create update or delete functions for claim_audit_history. The table is append-only.**

## Security Requirements

- Claim audit history is append-only. No update, no delete. Hard requirement.
- getClaimAuditHistory must verify claim ownership (physician_id) before returning entries.
- Retention: claim lifetime + 10 years (HIA custodian requirement).

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- appendClaimAudit inserts entry with correct fields
- getClaimAuditHistory returns entries for owned claim
- getClaimAuditHistory returns empty for different physician's claim
- getClaimAuditHistory returns reverse chronological order
- getClaimAuditHistoryPaginated paginates correctly
- claim_audit_history has no update function
- claim_audit_history has no delete function

## Dependencies

- D04-007 must be complete (database migration applied, claim_audit_history table exists).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
