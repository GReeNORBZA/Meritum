# Task D04-023: Service — EMR import flow (upload, preview, commit, field mapping)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.service.ts`:

- `uploadImport(physicianId: string, actorId: string, file: UploadedFile, templateId?: string)` — compute SHA-256 hash. Check for duplicate file. Parse file (CSV/TSV with auto-detected or template-specified delimiter). Create import_batch record with PENDING status. Return import_batch_id.
- `previewImport(importBatchId: string, physicianId: string)` — apply field mapping template (or manual mapping). Return preview: mapped rows, unmapped columns, validation warnings per row. Do NOT create claims yet.
- `commitImport(importBatchId: string, physicianId: string, actorId: string)` — create claims from successfully mapped rows. Skip failed rows. Update import batch with counts and error details. Set status to COMPLETED. Return { success_count, error_count, error_details }.

**File parsing:**
- Detect delimiter (comma, tab, pipe) if not specified in template
- Handle header row vs no header row per template config
- Parse multiple date formats (YYYY-MM-DD, DD/MM/YYYY, MM/DD/YYYY) per template config or auto-detection

**Field mapping:**
- Apply field_mapping_templates.mappings array: {source_column -> target_field, optional transform}
- Validate each mapped row against claim creation requirements
- Report per-row errors with row number and field details

## FRD References

- Domain 4.0 Section 6.2: EMR import endpoints — upload, preview, commit. Preview before commit.
- Domain 4.0 Section 3.2: Import batches track file hash for dedup, per-row error details.
- Domain 4.0 Section 3.3: Field mapping templates with source_column -> target_field + optional transform.
- Domain 4.0 Section 9.4: EMR import tests — various delimiters, header handling, date formats, partial failures, template reuse, duplicate file detection.

## Security Requirements

- EMR import files are processed in memory where possible. Uploaded files stored temporarily (encrypted), processed, deleted after import confirmation.
- File hash deduplication prevents duplicate imports (SHA-256).
- Import error details must not leak PHI beyond row-level error descriptions.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- uploadImport computes SHA-256 hash
- uploadImport detects duplicate file by hash
- uploadImport parses CSV with comma delimiter
- uploadImport parses TSV with tab delimiter
- previewImport applies field mapping template
- previewImport reports unmapped columns
- previewImport validates each row
- commitImport creates claims for valid rows
- commitImport skips failed rows with error details
- commitImport updates batch counts
- commitImport handles partial failures correctly

## Dependencies

- D04-010 must be complete (claim repository CRUD for creating claims).
- D04-012 must be complete (import batch repository).
- D04-013 must be complete (field mapping template repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
