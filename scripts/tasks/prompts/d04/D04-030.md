# Task D04-030: Routes — claim CRUD, state transitions, validation, AI Coach, rejection management

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/src/domains/claim/claim.routes.ts` and `apps/api/src/domains/claim/claim.handlers.ts`.

**Claim CRUD (auth required, physician-scoped):**
- POST /api/v1/claims -> createClaimHandler (body: createClaimSchema)
- GET /api/v1/claims -> listClaimsHandler (query: listClaimsSchema)
- GET /api/v1/claims/:id -> getClaimHandler (params: claimIdParamSchema)
- PUT /api/v1/claims/:id -> updateClaimHandler (body: updateClaimSchema)
- DELETE /api/v1/claims/:id -> deleteClaimHandler (soft delete, draft only)

**State transitions:**
- POST /api/v1/claims/:id/validate -> validateClaimHandler
- POST /api/v1/claims/:id/queue -> queueClaimHandler
- POST /api/v1/claims/:id/unqueue -> unqueueClaimHandler
- POST /api/v1/claims/:id/write-off -> writeOffHandler (body: writeOffClaimSchema)
- POST /api/v1/claims/:id/resubmit -> resubmitHandler

**AI Coach:**
- GET /api/v1/claims/:id/suggestions -> getSuggestionsHandler
- POST /api/v1/claims/:id/suggestions/:sug_id/accept -> acceptSuggestionHandler
- POST /api/v1/claims/:id/suggestions/:sug_id/dismiss -> dismissSuggestionHandler (body: dismissSuggestionSchema)

**Rejection management:**
- GET /api/v1/claims/rejected -> listRejectedHandler
- GET /api/v1/claims/:id/rejection-details -> rejectionDetailsHandler

**Claim audit:**
- GET /api/v1/claims/:id/audit -> claimAuditHandler

**Handlers are thin:** validate input via Zod schema on route, call service function, format response.

Also create `apps/api/test/integration/claim/claims.integration.ts` with request/response integration tests.

## Security Requirements

- All endpoints require authentication (authenticate middleware from Domain 1).
- All endpoints are physician-scoped via request.authContext.physicianId (or delegate's physician context).
- CLAIM_CREATE, CLAIM_VIEW, CLAIM_EDIT, CLAIM_DELETE, CLAIM_SUBMIT permissions checked per route.
- Delegates require explicit CLAIM_APPROVE permission to approve flagged claims.

## Required Tests

Create tests in `apps/api/test/integration/claim/claims.integration.ts`:

- POST /claims creates draft claim and returns 201
- GET /claims lists physician's claims with filtering
- GET /claims/:id returns claim for owning physician
- GET /claims/:id returns 404 for different physician
- PUT /claims/:id updates claim fields
- DELETE /claims/:id soft-deletes draft claim
- DELETE /claims/:id returns 409 for non-draft claim
- POST /claims/:id/validate returns validation result
- POST /claims/:id/queue queues validated claim
- POST /claims/:id/unqueue returns claim to validated
- POST /claims/:id/write-off transitions rejected to written_off
- POST /claims/:id/resubmit revalidates and requeues
- GET /claims/:id/suggestions returns AI suggestions
- POST /claims/:id/suggestions/:sug_id/accept applies suggestion

## Dependencies

- D04-020 must be complete (claim creation service).
- D04-021 must be complete (validation engine service).
- D04-022 must be complete (state machine enforcement service).
- D04-025 must be complete (rejection management service).
- D04-026 must be complete (AI Coach and export service).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/claim/
```

All tests must pass before outputting [TASK_COMPLETE].
