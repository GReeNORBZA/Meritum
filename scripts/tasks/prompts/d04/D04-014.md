# Task D04-014: Repository — shifts (ED workflow)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.repository.ts`:

- `createShift(data: InsertShift)` — insert shift with status = IN_PROGRESS. Return shift_id.
- `findShiftById(shiftId: string, physicianId: string)` — physician-scoped lookup with encounter count.
- `updateShiftStatus(shiftId: string, physicianId: string, status: string)` — update shift status (IN_PROGRESS -> COMPLETED -> SUBMITTED).
- `updateShiftTimes(shiftId: string, physicianId: string, startTime: string, endTime: string)` — update shift start/end times.
- `incrementEncounterCount(shiftId: string)` — increment encounter_count.
- `listShifts(physicianId: string, page: number, pageSize: number)` — paginated list, reverse chronological.
- `findClaimsByShift(shiftId: string, physicianId: string)` — list all claims linked to this shift.

## Security Requirements

- Shifts are physician-scoped. No cross-physician access.
- Shift times are used for after-hours premium calculation — must be validated as valid time values.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- createShift creates shift with IN_PROGRESS status
- findShiftById returns shift for owning physician
- findShiftById returns null for different physician
- updateShiftStatus transitions status correctly
- incrementEncounterCount increments counter
- listShifts paginates correctly
- findClaimsByShift returns only claims linked to shift

## Dependencies

- D04-007 must be complete (database migration applied, shifts table exists).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
