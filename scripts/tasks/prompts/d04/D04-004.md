# Task D04-004: Drizzle schema for shifts and claim_audit_history tables

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `packages/shared/src/schemas/db/claim.schema.ts`:

**shifts table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| shift_id | UUID | PK | |
| physician_id | UUID FK | NOT NULL, FK -> providers | |
| facility_id | UUID FK | NOT NULL | FK -> provider's functional centre |
| shift_date | DATE | NOT NULL | Date of ED shift |
| start_time | TIME | NULLABLE | For after-hours premium calculation |
| end_time | TIME | NULLABLE | |
| status | VARCHAR(20) | NOT NULL | IN_PROGRESS, COMPLETED, SUBMITTED |
| encounter_count | INTEGER | NOT NULL, DEFAULT 0 | Number of encounters |
| created_at | TIMESTAMPTZ | NOT NULL | |
| updated_at | TIMESTAMPTZ | NOT NULL | |

Index: (physician_id, shift_date DESC).

**claim_audit_history table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| audit_id | UUID | PK | |
| claim_id | UUID FK | NOT NULL, FK -> claims | |
| action | VARCHAR(30) | NOT NULL | CREATED, EDITED, VALIDATED, etc. |
| previous_state | VARCHAR(20) | NULLABLE | Null for CREATED |
| new_state | VARCHAR(20) | NULLABLE | State after the action |
| changes | JSONB | NULLABLE | For EDITED: field-level diff. For AI actions: suggestion details. |
| actor_id | UUID FK | NOT NULL | Who performed the action |
| actor_context | VARCHAR(20) | NOT NULL | PHYSICIAN, DELEGATE, SYSTEM |
| reason | TEXT | NULLABLE | Write-off justification, dismissal reason |
| created_at | TIMESTAMPTZ | NOT NULL | When the action occurred |

Indexes: (claim_id, created_at DESC), (actor_id, created_at DESC).

**CRITICAL:** Claim audit history is append-only. No UPDATE or DELETE operations. Retention: claim lifetime + 10 years (HIA custodian requirement).

Export tables and inferred types.

## FRD References

- Domain 4.0 Section 3.4: Shifts table for ED workflow. Encounters are claims with import_source = ED_SHIFT and shift_id FK.
- Domain 4.0 Section 3.5: Claim audit history — every state change and significant edit recorded. Separate from system-wide audit log. Retention: claim lifetime + 10 years.

## Security Requirements

- Claim audit history is append-only. Repository must NOT expose update or delete functions.
- actor_context distinguishes physician, delegate, and system actions for accountability.
- JSONB changes field must not contain PHI beyond what is necessary for the diff (e.g., old/new field values).

## Dependencies

- D04-002 must be complete (claims table schema exists in claim.schema.ts).

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
