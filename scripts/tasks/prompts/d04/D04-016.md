# Task D04-016: Repository — submission preferences and data export records

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.repository.ts`:

Note: Submission preferences are stored on the provider profile (Domain 5). This repository provides claim-scoped export record tracking.

**Data exports:**
- `createExportRecord(data: { physicianId, dateFrom, dateTo, claimType?, format, status })` — insert export record. Return export_id.
- `findExportById(exportId: string, physicianId: string)` — physician-scoped lookup.
- `updateExportStatus(exportId: string, status: string, filePath?: string)` — update status to PROCESSING, COMPLETED (with file path), or FAILED.

Note: The actual submission preferences are managed via the Provider Management domain (Domain 5). The claim domain reads them via the provider service interface.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- createExportRecord creates record with pending status
- findExportById returns record for owning physician
- findExportById returns null for different physician
- updateExportStatus updates status and file path

## Dependencies

- D04-007 must be complete (database migration applied).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
