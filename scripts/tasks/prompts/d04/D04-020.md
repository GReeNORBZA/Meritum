# Task D04-020: Service — claim creation (manual entry, from EMR import, from ED shift)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/src/domains/claim/claim.service.ts` with claim creation functions:

- `createClaim(physicianId: string, actorId: string, actorContext: string, data: CreateClaimInput)` — create claim with state DRAFT. Calculate submission_deadline based on claim_type (AHCIP: DOS + 90 days, WCB: form-specific from Domain 4.2). Append CREATED audit entry. Return claim_id.
- `createClaimFromImport(physicianId: string, actorId: string, importBatchId: string, rowData: MappedRow)` — create claim with import_source = EMR_IMPORT and import_batch_id set. Same validation as manual creation.
- `createClaimFromShift(physicianId: string, actorId: string, shiftId: string, encounterData: EncounterInput)` — create claim with import_source = ED_SHIFT and shift_id set. Increment shift encounter count.

**Interface contracts (consumed):**
- Call Provider Management (D05) to verify physician is active with valid BA
- Call Patient Registry (D06) to verify patient exists
- Submission deadline calculation: AHCIP = DOS + 90 calendar days. WCB = delegated to Domain 4.2 for form-specific deadlines.

**Audit:** Every creation appends a claim_audit_history entry with action = CREATED, actor_id, actor_context.

## Security Requirements

- Claim creation verifies the physician is active and has a valid billing arrangement via Provider Management.
- Patient existence check via Patient Registry prevents orphaned claims.
- actor_context (PHYSICIAN, DELEGATE, SYSTEM) recorded on every creation for accountability.
- Delegates create claims in physician context — the physician_id (HIA custodian) is always the physician's, not the delegate's.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- createClaim creates draft claim with correct deadline
- createClaim appends CREATED audit entry
- createClaim calculates AHCIP deadline as DOS + 90 days
- createClaimFromImport sets import_source and batch_id
- createClaimFromShift sets import_source and shift_id
- createClaimFromShift increments shift encounter count
- createClaim records actor_context correctly for delegate

## Dependencies

- D04-010 must be complete (claim repository CRUD).
- D04-015 must be complete (claim audit history repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
