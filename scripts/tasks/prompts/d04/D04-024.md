# Task D04-024: Service — ED shift workflow (create shift, add encounters, complete, after-hours calculation)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.service.ts`:

- `createShift(physicianId: string, data: CreateShiftInput)` — create shift with IN_PROGRESS status. Verify facility_id belongs to physician (via Provider Management). Return shift_id.
- `addEncounter(physicianId: string, actorId: string, shiftId: string, data: EncounterInput)` — verify shift is IN_PROGRESS. Create claim with import_source = ED_SHIFT, shift_id set. Increment encounter count. Return claim_id.
- `completeShift(physicianId: string, shiftId: string)` — verify shift is IN_PROGRESS. Set status to COMPLETED. Calculate after-hours premiums for all encounters based on shift start_time/end_time. Return shift with all encounters.
- `getShiftDetails(physicianId: string, shiftId: string)` — return shift with all linked claims.

**After-hours calculation:** Uses shift start_time and end_time to determine which encounters qualify for after-hours premiums. Delegates the actual premium calculation to the pathway-specific module (AHCIP or WCB).

**Shift lifecycle:** IN_PROGRESS -> COMPLETED (physician finishes shift) -> SUBMITTED (all encounters queued/submitted).

## FRD References

- Domain 4.0 Section 3.4: Shifts table for ED workflow. Individual encounters are claims with import_source = ED_SHIFT.
- Domain 4.0 Section 6.4: ED shift API — create shift, add encounter, complete shift, get details.
- Domain 4.0 CLM-003: ED physician bills entire shift as batch. After-hours premiums auto-calculated.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- createShift creates shift with IN_PROGRESS status
- createShift verifies facility belongs to physician
- addEncounter creates claim linked to shift
- addEncounter increments encounter count
- addEncounter rejects if shift is not IN_PROGRESS
- completeShift sets status to COMPLETED
- completeShift triggers after-hours calculation
- getShiftDetails returns shift with all encounters

## Dependencies

- D04-010 must be complete (claim repository CRUD for creating claims).
- D04-014 must be complete (shift repository).
- D04-015 must be complete (claim audit history repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
