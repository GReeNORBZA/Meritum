# Task D04-042: Security — physician tenant isolation (MOST CRITICAL)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/security/claim/claim.scoping.security.ts`.

Create two physician accounts (physician1, physician2) using createSecurityPair fixture. Each physician creates claims, imports, templates, shifts.

**Claim isolation:**
- Physician1 cannot see physician2's claims via GET /claims -> empty list
- Physician1 cannot view physician2's claim via GET /claims/:id -> 404
- Physician1 cannot edit physician2's claim via PUT /claims/:id -> 404
- Physician1 cannot delete physician2's claim -> 404
- Physician1 cannot validate/queue/write-off physician2's claim -> 404

**Import isolation:**
- Physician1 cannot view physician2's import batch -> 404
- Physician1 cannot preview/commit physician2's import -> 404

**Template isolation:**
- Physician1 cannot view physician2's templates -> empty list
- Physician1 cannot update/delete physician2's template -> 404

**Shift isolation:**
- Physician1 cannot view physician2's shift -> 404
- Physician1 cannot add encounters to physician2's shift -> 404

**Export isolation:**
- Physician1 cannot view physician2's export -> 404

**Claim audit isolation:**
- Physician1 cannot view physician2's claim audit history -> 404

**Delegate cross-context:**
- Delegate linked to physician1 cannot access physician2's claims in physician1 context
- Delegate context switch: claims in physician1 context do not appear in physician2 context

**IMPORTANT:** All cross-physician access attempts return 404, not 403 (do not confirm resource existence).

Use the test helpers/fixtures from the project. Follow security test patterns from Domain 1 and Domain 5. See `CLAUDE.md` for coding conventions.

## Dependencies

- D04-030 must be complete (claim CRUD and state transition routes).
- D04-031 must be complete (import, template, shift, export routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/claim/claim.scoping.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
