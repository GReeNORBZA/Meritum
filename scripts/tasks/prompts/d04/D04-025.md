# Task D04-025: Service — rejection management, resubmission, and write-off

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.service.ts`:

- `listRejectedClaims(physicianId: string, page: number, pageSize: number)` — list claims in REJECTED state with explanatory codes and corrective guidance.
- `getRejectionDetails(claimId: string, physicianId: string)` — return rejection codes, human-readable descriptions, system-generated corrective guidance, resubmission eligibility.
- `resubmitClaim(claimId: string, physicianId: string, actorId: string)` — verify REJECTED state. Re-validate claim. If valid: transition to QUEUED (one-click resubmit). Append RESUBMITTED audit entry. Emit notification.

**Corrective guidance:** Generated from explanatory code lookup (Reference Data, Domain 2). Maps rejection codes to human-readable descriptions and suggested corrections.

**Resubmission flow:** REJECTED -> edit -> DRAFT -> validate -> VALIDATED -> queue, OR REJECTED -> one-click resubmit -> QUEUED (if claim still validates after correction).

## FRD References

- Domain 4.0 Section 6.5: Rejection management API — list rejected, get rejection details, one-click resubmit.
- Domain 4.0 CLM-011: Rejected claims show explanatory codes, descriptions, corrective guidance, one-click resubmit.
- Domain 4.0 CLM-012: Write-off action on rejected claims with reason. Terminal state.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- listRejectedClaims returns only REJECTED state claims
- getRejectionDetails returns codes and corrective guidance
- getRejectionDetails returns null for different physician's claim
- resubmitClaim re-validates before requeuing
- resubmitClaim transitions REJECTED -> QUEUED on valid
- resubmitClaim appends RESUBMITTED audit entry
- resubmitClaim rejects if validation fails after correction

## Dependencies

- D04-010 must be complete (claim repository CRUD).
- D04-011 must be complete (state transition repository).
- D04-015 must be complete (claim audit history repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
