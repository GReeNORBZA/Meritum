# Task D04-002: Drizzle schema for claims table

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `packages/shared/src/schemas/db/claim.schema.ts` starting with the claims table.

**claims table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| claim_id | UUID | PK | Default: gen_random_uuid() |
| physician_id | UUID FK | NOT NULL, FK -> providers | HIA custodian |
| patient_id | UUID FK | NOT NULL, FK -> patients | |
| claim_type | VARCHAR(10) | NOT NULL | AHCIP or WCB |
| state | VARCHAR(20) | NOT NULL, DEFAULT 'draft' | Current state per state machine |
| is_clean | BOOLEAN | NULLABLE | Null until queued. True = clean, False = flagged |
| import_source | VARCHAR(20) | NOT NULL | MANUAL, EMR_IMPORT, ED_SHIFT |
| import_batch_id | UUID FK | NULLABLE | FK -> import_batches |
| shift_id | UUID FK | NULLABLE | FK -> shifts |
| date_of_service | DATE | NOT NULL | Central to validation, fees, deadlines |
| submission_deadline | DATE | NOT NULL | AHCIP: DOS + 90 days. WCB: form-specific |
| submitted_batch_id | UUID FK | NULLABLE | FK to pathway-specific batch table |
| validation_result | JSONB | NULLABLE | Structured validation result (errors, warnings, info, passed) |
| validation_timestamp | TIMESTAMPTZ | NULLABLE | When validation was last run |
| reference_data_version | VARCHAR(20) | NULLABLE | SOMB/WCB version used for validation |
| ai_coach_suggestions | JSONB | NULLABLE | Array of suggestions with status |
| duplicate_alert | JSONB | NULLABLE | Duplicate detection result |
| flags | JSONB | NULLABLE | Array of active flags |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |
| created_by | UUID FK | NOT NULL | Creator (physician or delegate) |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |
| updated_by | UUID FK | NOT NULL | Last updater |
| deleted_at | TIMESTAMPTZ | NULLABLE | Soft-delete timestamp |

**Indexes:**
- (physician_id, state) for dashboard queries
- (patient_id, date_of_service) for duplicate detection
- (state, claim_type, is_clean) for batch assembly
- (submission_deadline) for expiry monitoring

Export the table and its inferred types (InsertClaim, SelectClaim) from the schema file.

## FRD References

- Domain 4.0 Section 3.1: Claims table — one row per claim regardless of pathway. claim_type determines extension tables. 22 columns with 4 indexes.

## Security Requirements

- Claims contain PHI (patient PHN via patient_id, diagnoses via extension tables, services). All claim data encrypted at rest and in transit.
- physician_id establishes the HIA custodian. All access is scoped through this — tenant isolation is critical.
- Soft delete (deleted_at) retains data for audit. Only allowed from draft state.

## Dependencies

- D04-001 must be complete (claim constants defined).

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
