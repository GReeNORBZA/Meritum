# Task D04-031: Routes — EMR import, field mapping templates, ED shifts, data export, submission preferences

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.routes.ts` and handlers:

**EMR Import (auth required):**
- POST /api/v1/imports -> uploadImportHandler (multipart file + optional template_id)
- GET /api/v1/imports/:id -> getImportHandler (params: importIdParamSchema)
- GET /api/v1/imports/:id/preview -> previewImportHandler
- POST /api/v1/imports/:id/commit -> commitImportHandler

**Field mapping templates (auth required):**
- POST /api/v1/field-mapping-templates -> createTemplateHandler (body: createTemplateSchema)
- GET /api/v1/field-mapping-templates -> listTemplatesHandler
- PUT /api/v1/field-mapping-templates/:id -> updateTemplateHandler (body: updateTemplateSchema)
- DELETE /api/v1/field-mapping-templates/:id -> deleteTemplateHandler

**ED Shifts (auth required):**
- POST /api/v1/shifts -> createShiftHandler (body: createShiftSchema)
- POST /api/v1/shifts/:id/encounters -> addEncounterHandler (body: addEncounterSchema)
- PUT /api/v1/shifts/:id/complete -> completeShiftHandler
- GET /api/v1/shifts/:id -> getShiftHandler

**Data Export (auth required):**
- POST /api/v1/exports -> requestExportHandler (body: createExportSchema)
- GET /api/v1/exports/:id -> getExportHandler

**Submission preferences (auth required):**
- GET /api/v1/submission-preferences -> getPreferencesHandler
- PUT /api/v1/submission-preferences -> updatePreferencesHandler (body: updatePreferencesSchema)

Create `apps/api/test/integration/claim/imports.integration.ts`, `shifts.integration.ts`, and `exports.integration.ts`.

## Security Requirements

- Import upload endpoint rate-limited at 5 req/min per user (file upload rate limit).
- Export download requires authenticated session — files not accessible via unauthenticated URL.
- Field mapping templates are physician-scoped — CRUD operations verify ownership.
- Submission preference changes are audit-logged.

## Required Tests

Create integration tests:

- POST /imports uploads file and returns import_batch_id
- POST /imports rejects duplicate file (same hash)
- GET /imports/:id/preview returns mapped preview
- POST /imports/:id/commit creates claims and returns counts
- POST /field-mapping-templates creates template
- GET /field-mapping-templates lists physician's templates
- DELETE /field-mapping-templates/:id deletes owned template
- POST /shifts creates shift with IN_PROGRESS status
- POST /shifts/:id/encounters adds encounter to shift
- PUT /shifts/:id/complete completes shift
- POST /exports creates export request
- GET /exports/:id returns status and download URL
- PUT /submission-preferences updates mode

## Dependencies

- D04-023 must be complete (EMR import service).
- D04-024 must be complete (ED shift service).
- D04-026 must be complete (export and preferences service).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/claim/
```

All tests must pass before outputting [TASK_COMPLETE].
