# Task D04-032: Integration tests — full claim lifecycle (create -> validate -> queue -> submit -> assess -> paid)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/integration/claim/lifecycle.integration.ts`.

**Full lifecycle test (happy path):**
1. Create physician via IAM, create patient via Patient Registry
2. POST /claims — create AHCIP claim -> draft state
3. POST /claims/:id/validate — validate -> passes -> validated state
4. POST /claims/:id/queue — queue -> classified as clean -> queued state
5. Simulate batch assembly -> submitted state (batch assembly is pathway-specific, mock for core)
6. Simulate assessment response -> assessed state
7. Simulate payment confirmation -> paid state (terminal)
8. Verify full claim_audit_history chain: CREATED -> VALIDATED -> QUEUED -> SUBMITTED -> ASSESSED -> PAID

**Rejection lifecycle:**
1. Submit claim -> rejected state
2. GET /claims/:id/rejection-details — verify codes and guidance
3. PUT /claims/:id — edit claim to fix rejection
4. POST /claims/:id/resubmit — revalidate and requeue
5. Verify audit trail includes REJECTED -> RESUBMITTED entries

**Invalid transitions:**
- draft -> submitted (skip queue) -> 409
- paid -> draft (terminal state) -> 409
- deleted -> validated (terminal state) -> 409

## FRD References

- Domain 4.0 Section 9.1: State machine tests — all valid transitions, invalid transitions rejected, terminal states.
- Domain 4.0 Section 9.5: Integration tests — full lifecycle, rejection lifecycle.

## Required Tests

Create tests in `apps/api/test/integration/claim/lifecycle.integration.ts`:

- Full lifecycle: create -> validate -> queue -> submit -> assess -> paid
- Rejection lifecycle: submit -> reject -> review -> resubmit -> paid
- Invalid transition draft -> submitted returns 409
- Invalid transition from terminal state returns 409
- Audit trail records every state change
- Claim audit history chain is complete and ordered

## Dependencies

- D04-030 must be complete (claim CRUD and state transition routes).
- D04-031 must be complete (supporting routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/claim/
```

All tests must pass before outputting [TASK_COMPLETE].
