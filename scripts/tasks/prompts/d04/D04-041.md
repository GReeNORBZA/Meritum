# Task D04-041: Security — authorization and permission enforcement

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/security/claim/claim.authz.security.ts`.

**Delegate permission boundary tests:**
- Delegate with CLAIM_VIEW only cannot POST /claims (requires CLAIM_CREATE) -> 403
- Delegate with CLAIM_VIEW only cannot PUT /claims/:id (requires CLAIM_EDIT) -> 403
- Delegate with CLAIM_VIEW only cannot DELETE /claims/:id (requires CLAIM_DELETE) -> 403
- Delegate with CLAIM_VIEW only cannot POST /claims/:id/queue (requires CLAIM_SUBMIT) -> 403
- Delegate without CLAIM_APPROVE cannot approve flagged claims -> 403

**Delegate with correct permissions:**
- Delegate with CLAIM_CREATE can POST /claims -> 201
- Delegate with CLAIM_VIEW can GET /claims -> 200
- Delegate with CLAIM_EDIT can PUT /claims/:id -> 200
- Delegate with CLAIM_SUBMIT can POST /claims/:id/queue -> 200

**Role enforcement:**
- Physician can access all claim routes (full permissions)
- Admin cannot view individual claim data without explicit PHI access grant

Use the test helpers/fixtures from the project. Follow security test patterns from Domain 1 and Domain 5. See `CLAUDE.md` for coding conventions.

## Dependencies

- D04-030 must be complete (claim CRUD and state transition routes).
- D04-031 must be complete (supporting routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/claim/claim.authz.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
