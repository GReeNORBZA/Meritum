# Task D04-012: Repository — import batches and duplicate file detection

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.repository.ts`:

- `createImportBatch(data: InsertImportBatch)` — insert import batch record. Return import_batch_id.
- `findImportBatchById(batchId: string, physicianId: string)` — physician-scoped lookup.
- `updateImportBatchStatus(batchId: string, status: string, counts?: { successCount, errorCount, errorDetails })` — update status and counts after processing.
- `findDuplicateImportByHash(physicianId: string, fileHash: string)` — check if this file was already imported (SHA-256 hash match).
- `listImportBatches(physicianId: string, page: number, pageSize: number)` — paginated list, reverse chronological.

## Security Requirements

- Import batches are physician-scoped. No cross-physician access.
- File hash deduplication prevents re-importing the same file (SHA-256).
- error_details JSONB must not contain PHI beyond row-level error descriptions.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- createImportBatch creates record with PENDING status
- findImportBatchById returns batch for owning physician
- findImportBatchById returns null for different physician
- updateImportBatchStatus updates status and counts
- findDuplicateImportByHash detects duplicate file
- findDuplicateImportByHash returns null for new file
- listImportBatches paginates correctly

## Dependencies

- D04-007 must be complete (database migration applied, import_batches table exists).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
