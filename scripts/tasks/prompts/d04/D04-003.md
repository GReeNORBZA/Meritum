# Task D04-003: Drizzle schema for import_batches and field_mapping_templates tables

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `packages/shared/src/schemas/db/claim.schema.ts`:

**import_batches table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| import_batch_id | UUID | PK | |
| physician_id | UUID FK | NOT NULL, FK -> providers | |
| file_name | VARCHAR(255) | NOT NULL | Original uploaded filename |
| file_hash | VARCHAR(64) | NOT NULL | SHA-256 for deduplication |
| field_mapping_template_id | UUID FK | NULLABLE | FK -> field_mapping_templates |
| total_rows | INTEGER | NOT NULL | Total rows in import file |
| success_count | INTEGER | NOT NULL | Rows successfully imported |
| error_count | INTEGER | NOT NULL | Rows that failed |
| error_details | JSONB | NULLABLE | Per-row error details |
| status | VARCHAR(20) | NOT NULL | PENDING, PROCESSING, COMPLETED, FAILED |
| created_at | TIMESTAMPTZ | NOT NULL | Upload timestamp |
| created_by | UUID FK | NOT NULL | Uploader |

Index: (physician_id, created_at DESC), unique on (physician_id, file_hash) for dedup.

**field_mapping_templates table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| template_id | UUID | PK | |
| physician_id | UUID FK | NOT NULL, FK -> providers | Templates are physician-scoped |
| name | VARCHAR(100) | NOT NULL | E.g. 'Wolf EMR Export', 'Med Access Format' |
| emr_type | VARCHAR(50) | NULLABLE | EMR system identifier |
| mappings | JSONB | NOT NULL | Array of {source_column, target_field, transform?} |
| delimiter | VARCHAR(5) | NULLABLE | CSV/TSV delimiter. Auto-detected if null. |
| has_header_row | BOOLEAN | NOT NULL | Whether file has header row |
| date_format | VARCHAR(20) | NULLABLE | Expected date format. Auto-detected if null. |
| created_at | TIMESTAMPTZ | NOT NULL | |
| updated_at | TIMESTAMPTZ | NOT NULL | |

Index: (physician_id) for listing templates.

Export tables and inferred types.

## FRD References

- Domain 4.0 Section 3.2: Import batches table for EMR import traceability with SHA-256 file deduplication.
- Domain 4.0 Section 3.3: Field mapping templates — per-physician column-to-field mappings reusable across imports.

## Dependencies

- D04-002 must be complete (claims table schema exists in claim.schema.ts).

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
