# Task D04-026: Service — AI Coach interactions, duplicate handling, submission preferences, data export

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.service.ts`:

**AI Coach interactions:**
- `getClaimSuggestions(claimId: string, physicianId: string)` — return AI Coach suggestions for this claim from ai_coach_suggestions JSONB.
- `acceptSuggestion(claimId: string, suggestionId: string, physicianId: string, actorId: string)` — mark suggestion as accepted. Apply suggested change to claim. Re-validate. Append AI_SUGGESTION_ACCEPTED audit entry. Re-evaluate clean/flagged if queued.
- `dismissSuggestion(claimId: string, suggestionId: string, physicianId: string, actorId: string, reason?: string)` — mark suggestion as dismissed. Append AI_SUGGESTION_DISMISSED audit entry with reason. Re-evaluate clean/flagged if queued.

**Duplicate handling:**
- `acknowledgeDuplicate(claimId: string, physicianId: string, actorId: string)` — clear duplicate_alert. Append DUPLICATE_ACKNOWLEDGED audit. Re-evaluate clean/flagged.

**Submission preferences (reads from Provider Management):**
- `getSubmissionPreferences(physicianId: string)` — read from Provider Management (Domain 5).
- `updateSubmissionPreferences(physicianId: string, mode: string)` — update via Provider Management. Audit log the change.

**Data export:**
- `requestExport(physicianId: string, params: ExportParams)` — create export record. Queue background job to generate file. Return export_id.
- `getExportStatus(exportId: string, physicianId: string)` — return status and download URL if complete.
- `generateExportFile(exportId: string)` — background job: query claims, generate CSV/JSON, store to DigitalOcean Spaces, update record with file path.

## FRD References

- Domain 4.0 Section 6.6: AI Coach interaction API — get suggestions, accept, dismiss.
- Domain 4.0 Section 6.7: Data export API — request, check status, download.
- Domain 4.0 Section 6.8: Submission preferences API — get/update mode.
- Domain 4.0 CLM-007: AI Coach suggestions as actionable cards with revenue impact and confidence.
- Domain 4.0 CLM-015: Duplicate detection with acknowledge or merge.

## Security Requirements

- AI Coach suggestions are advisory — never block submission.
- acceptSuggestion applies changes to the claim and re-validates — the suggestion is not blindly applied.
- Data export files are generated on Meritum infrastructure (DigitalOcean Toronto) and delivered via authenticated download. Not emailed.
- Export requests require date range — no unbounded exports.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- getClaimSuggestions returns suggestions for owned claim
- acceptSuggestion marks suggestion accepted and applies change
- acceptSuggestion re-validates claim after applying
- acceptSuggestion re-evaluates clean/flagged if queued
- dismissSuggestion marks dismissed with optional reason
- dismissSuggestion re-evaluates clean/flagged if queued
- acknowledgeDuplicate clears duplicate alert
- getSubmissionPreferences reads from provider management
- updateSubmissionPreferences updates mode and audits
- requestExport creates export record
- getExportStatus returns status for owned export
- getExportStatus returns null for different physician

## Dependencies

- D04-010 must be complete (claim repository CRUD).
- D04-011 must be complete (state transition and JSONB update repository).
- D04-015 must be complete (claim audit history repository).
- D04-016 must be complete (export record repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
