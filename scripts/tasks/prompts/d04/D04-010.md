# Task D04-010: Repository — claims CRUD (create, read, update, soft-delete, list with filters)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/src/domains/claim/claim.repository.ts`:

- `createClaim(data: InsertClaim)` — insert claim with state = DRAFT, import_source from input. Return claim_id.
- `findClaimById(claimId: string, physicianId: string)` — find claim scoped to physician. Return null if not found or different physician.
- `updateClaim(claimId: string, physicianId: string, data: Partial<InsertClaim>)` — update claim fields. Verify physician ownership. Return updated claim.
- `softDeleteClaim(claimId: string, physicianId: string)` — set deleted_at. Only allowed when state = DRAFT. Return boolean.
- `listClaims(physicianId: string, filters: ListClaimsFilters)` — paginated list with filters: state, claim_type, date range, patient_id, is_clean. Reverse chronological.
- `countClaimsByState(physicianId: string)` — count claims grouped by state for dashboard.
- `findClaimsApproachingDeadline(physicianId: string, daysThreshold: number)` — claims within N days of submission_deadline.

Use Drizzle ORM query builder with the claim schema from `packages/shared/src/schemas/db/claim.schema.ts`. Accept a Drizzle database instance via dependency injection (constructor parameter or function parameter). Follow existing repository patterns in the codebase (check `apps/api/src/domains/iam/` for reference).

Create `apps/api/src/domains/claim/claim.test.ts` with unit tests.

## Security Requirements

- Every query function takes physicianId and scopes results — this is the primary tenant isolation mechanism.
- softDeleteClaim must verify state === DRAFT before allowing delete.
- findClaimById returns null (not 403) for wrong physician — do not confirm resource existence.

## Required Tests

Create tests in `apps/api/src/domains/claim/claim.test.ts`:

- createClaim inserts with draft state and correct import_source
- findClaimById returns claim for owning physician
- findClaimById returns null for different physician
- updateClaim updates allowed fields
- updateClaim rejects update for wrong physician
- softDeleteClaim sets deleted_at when state is draft
- softDeleteClaim rejects delete when state is not draft
- listClaims filters by state correctly
- listClaims filters by claim_type correctly
- listClaims paginates correctly
- countClaimsByState returns grouped counts
- findClaimsApproachingDeadline returns claims within threshold

## Dependencies

- D04-007 must be complete (database migration applied, all tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
