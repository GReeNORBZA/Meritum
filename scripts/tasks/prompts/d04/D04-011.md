# Task D04-011: Repository — claim state transitions and clean/flagged classification

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.repository.ts`:

- `transitionState(claimId: string, physicianId: string, fromState: string, toState: string)` — atomic state transition. Verify current state matches fromState (optimistic concurrency). Return updated claim or throw on state mismatch.
- `classifyClaim(claimId: string, isClean: boolean)` — set is_clean flag. Called when claim enters queued state.
- `updateValidationResult(claimId: string, result: ValidationResult, version: string)` — set validation_result, validation_timestamp, reference_data_version.
- `updateAiSuggestions(claimId: string, suggestions: any)` — set ai_coach_suggestions JSONB.
- `updateDuplicateAlert(claimId: string, alert: any)` — set duplicate_alert JSONB.
- `updateFlags(claimId: string, flags: any)` — set flags JSONB.
- `findClaimsForBatchAssembly(physicianId: string, claimType: string, includeClean: boolean, includeFlagged: boolean)` — query claims in QUEUED state matching criteria for batch assembly.
- `bulkTransitionState(claimIds: string[], fromState: string, toState: string, batchId: string)` — batch state transition for submission. Sets submitted_batch_id.

## Security Requirements

- transitionState uses optimistic concurrency — verifying fromState prevents race conditions.
- bulkTransitionState must be atomic (single transaction) to prevent partial batch assembly.
- All state transitions are physician-scoped through the calling service layer.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- transitionState succeeds with correct fromState
- transitionState rejects incorrect fromState (optimistic lock)
- transitionState rejects invalid transition per state machine
- classifyClaim sets is_clean flag
- updateValidationResult stores structured result with timestamp and version
- findClaimsForBatchAssembly returns only queued claims matching criteria
- findClaimsForBatchAssembly respects clean/flagged filter
- bulkTransitionState transitions all claims atomically
- bulkTransitionState sets submitted_batch_id on all claims

## Dependencies

- D04-007 must be complete (database migration applied).
- D04-010 must be complete (base claim repository with CRUD).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
