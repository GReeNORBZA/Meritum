# Task D04-022: Service — state machine enforcement, clean/flagged classification, auto-submission logic

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Add to `apps/api/src/domains/claim/claim.service.ts`:

- `queueClaim(claimId: string, physicianId: string, actorId: string, actorContext: string)` — verify claim is in VALIDATED state. Re-validate (full pipeline). Classify as clean or flagged. Transition to QUEUED. Emit CLAIM_FLAGGED notification if flagged. Append audit entry.
- `unqueueClaim(claimId: string, physicianId: string, actorId: string)` — verify QUEUED state. Transition to VALIDATED. Append audit entry.
- `approveFlaggedClaim(claimId: string, physicianId: string, actorId: string, actorContext: string)` — for delegates with CLAIM_APPROVE permission. Mark flagged claim as approved for batch inclusion. Append audit entry.
- `writeOffClaim(claimId: string, physicianId: string, actorId: string, reason: string)` — verify REJECTED state. Transition to WRITTEN_OFF. Record reason in audit. Terminal.
- `expireClaim(claimId: string)` — system-initiated. Transition any non-terminal claim past deadline to EXPIRED. Emit DEADLINE_EXPIRED notification.

**Clean/flagged classification (applied at queue time):**
Clean when ALL true: zero validation warnings, zero pending AI suggestions, zero unresolved flags, zero duplicate alerts.
Flagged otherwise. Re-evaluated when claim is updated while in QUEUED state.

**Auto-submission logic (called by batch assembly):**
Read physician's submission preference (from Provider Management):
- AUTO_CLEAN: include clean claims, exclude flagged
- AUTO_ALL: include both clean and flagged
- REQUIRE_APPROVAL: include none without explicit approval

## FRD References

- Domain 4.0 Section 2.2: State transition table with triggers and conditions.
- Domain 4.0 Section 2.3: Clean vs flagged classification — clean when zero warnings, zero pending AI suggestions, zero flags, zero duplicate alerts.
- Domain 4.0 Section 2.4: Tiered auto-submission model — three modes (Auto Clean default, Auto All, Require Approval).

## Security Requirements

- State transitions validated against the allowed transitions map — invalid transitions rejected with 409 Conflict.
- Delegate approval of flagged claims requires CLAIM_APPROVE permission (checked at service level).
- expireClaim is system-initiated only — no user-facing endpoint for this action.
- Every state change appends to claim_audit_history with actor_id and actor_context.

## Required Tests

Add tests to `apps/api/src/domains/claim/claim.test.ts`:

- queueClaim re-validates before queuing
- queueClaim classifies clean claim correctly
- queueClaim classifies flagged claim correctly (pending AI suggestions)
- queueClaim classifies flagged claim correctly (validation warnings)
- queueClaim emits CLAIM_FLAGGED notification for flagged claims
- unqueueClaim transitions QUEUED -> VALIDATED
- approveFlaggedClaim requires CLAIM_APPROVE permission
- writeOffClaim only from REJECTED state
- writeOffClaim records reason in audit
- expireClaim transitions non-terminal claims past deadline
- auto-submission respects AUTO_CLEAN mode
- auto-submission respects AUTO_ALL mode
- auto-submission respects REQUIRE_APPROVAL mode
- clean/flagged re-evaluation on queued claim update

## Dependencies

- D04-010 must be complete (claim repository CRUD).
- D04-011 must be complete (state transition repository).
- D04-015 must be complete (claim audit history repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/claim/claim.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
