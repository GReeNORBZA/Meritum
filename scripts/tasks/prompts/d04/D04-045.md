# Task D04-045: Security — audit trail completeness for all claim actions

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/security/claim/claim.audit.security.ts`.

Verify that each state change and significant action produces an audit record in claim_audit_history. Run the action, then query the audit history and verify the entry.

**State change events:**
- Claim created -> action = CREATED with import_source, actor_id, actor_context
- Claim edited -> action = EDITED with field-level changes diff
- Claim validated -> action = VALIDATED with validation_result summary
- Claim queued -> action = QUEUED with is_clean classification
- Claim unqueued -> action = UNQUEUED
- Claim submitted -> action = SUBMITTED with batch_id
- Claim assessed -> action = ASSESSED
- Claim rejected -> action = REJECTED with rejection codes
- Claim resubmitted -> action = RESUBMITTED
- Claim written off -> action = WRITTEN_OFF with reason
- Claim deleted -> action = DELETED
- Claim expired -> action = EXPIRED (system-initiated)

**AI Coach events:**
- Suggestion accepted -> action = AI_SUGGESTION_ACCEPTED with suggestion details
- Suggestion dismissed -> action = AI_SUGGESTION_DISMISSED with reason

**Duplicate event:**
- Duplicate acknowledged -> action = DUPLICATE_ACKNOWLEDGED

**Audit log integrity:**
- Verify no UPDATE endpoints exist for claim_audit_history
- Verify no DELETE endpoints exist for claim_audit_history
- Verify actor_context correctly records PHYSICIAN, DELEGATE, or SYSTEM
- Verify delegate actions record both delegate identity and physician context

Use the test helpers/fixtures from the project. Follow security test patterns from Domain 1 and Domain 5. See `CLAUDE.md` for coding conventions.

## Dependencies

- D04-030 must be complete (claim CRUD and state transition routes).
- D04-031 must be complete (import, template, shift, export routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/claim/claim.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
