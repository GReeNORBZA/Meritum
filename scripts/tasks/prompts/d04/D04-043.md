# Task D04-043: Security — input validation and injection prevention

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- State machine: 11 states, 5 terminal. Transitions enforced at service layer.

## What to Build

Create `apps/api/test/security/claim/claim.input.security.ts`.

**SQL injection payloads on string inputs:**
- claim_type field: `' OR 1=1--`, `AHCIP'; DROP TABLE claims;--`
- state filter: SQL injection payloads
- write-off reason: SQL injection payloads
- template name: SQL injection payloads

**XSS payloads on stored text fields:**
- write-off reason: `<script>alert(1)</script>`
- template name: `<img onerror=alert(1) src=x>`
- AI suggestion dismissal reason: XSS payload

**Type coercion attacks:**
- Send number where string expected, array where string expected, null where required
- Send negative page_size to list claims -> 400
- Send page_size > 100 to list claims -> capped at 100

**UUID parameter validation:**
- Non-UUID in claim_id path param -> 400
- Non-UUID in patient_id body field -> 400
- Non-UUID in shift_id path param -> 400
- Non-UUID in suggestion_id path param -> 400

**Date validation:**
- Invalid date format in date_of_service -> 400
- Future date in date_of_service -> validation error (not 400, but S5 check)

**claim_type validation:**
- Invalid claim_type (not AHCIP or WCB) -> 400

**File upload validation (imports):**
- Oversized file -> 413
- Non-CSV/TSV file -> 400
- Malicious filename (path traversal) -> sanitised

Use the test helpers/fixtures from the project. Follow security test patterns from Domain 1 and Domain 5. See `CLAUDE.md` for coding conventions.

## Dependencies

- D04-030 must be complete (claim CRUD and state transition routes).
- D04-031 must be complete (import, template, shift, export routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/claim/claim.input.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
