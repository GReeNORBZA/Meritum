# D08-043: Security: input validation — injection, type coercion, boundary values

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-030** (dashboard routes), **D08-031** (report routes), **D08-032** (subscription routes).

## What to Build
Create `apps/api/test/security/analytics/analytics.input.security.ts`.

**SQL injection attempts:**
- period param: `'; DROP TABLE claims; --` -> 400 validation error
- ba_number filter: `1 OR 1=1` -> 400
- hsc_code filter: `03.03A'; DELETE FROM analytics_cache; --` -> 400
- report_id param: `'; DROP TABLE generated_reports; --` -> 400
- subscription_id param: injection payload -> 400

**XSS attempts:**
- period params with `<script>` tags -> 400
- filter values with HTML injection -> 400
- report format with script payload -> 400

**Type coercion attacks:**
- period: integer instead of string -> 400
- claim_type: array instead of string -> 400
- ba_number: object instead of string -> 400
- report format: unsupported value (e.g., 'exe') -> 400

**UUID validation:**
- report_id: 'not-a-uuid' -> 400
- subscription_id: malformed UUID -> 400
- location_id in filter: invalid UUID -> 400

**Boundary values:**
- Custom date range: end_date before start_date -> 400
- Custom date range: span > 2 years -> 400
- Custom date range: future end_date -> 400 (can't query future analytics)
- Report list: limit=0, limit=-1, limit=1000 -> 400
- compare_locations: more than 2 locations -> 400
- Data portability password: less than 12 chars -> 400

All invalid inputs return 400 with generic error messages (no internal details).

## Security Considerations
- All database queries use parameterised queries via Drizzle — no string concatenation.
- Validation at route level before any DB access.
- Error messages must not reveal internal schema or query structure.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/analytics/analytics.input.security.ts
```
Fix any errors before finishing.
