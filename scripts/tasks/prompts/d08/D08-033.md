# D08-033: Integration tests — end-to-end analytics workflows

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-030** (dashboard routes), **D08-031** (report routes), **D08-032** (subscription routes).

## What to Build
Create integration test files in `apps/api/test/integration/analytics/`:

**File: analytics.dashboard.integration.ts**
- Seed physician with known claim data (mix of paid, rejected, adjusted, submitted AHCIP + WCB claims across multiple months).
- GET /analytics/revenue -> verify KPI values match expected calculations.
- GET /analytics/rejections -> verify rejection rate formula: rejected / (assessed + rejected + adjusted).
- GET /analytics/aging -> verify bracket assignment by days since DOS.
- GET /analytics/kpis -> verify all KPI card values in single response.
- Period comparison: THIS_MONTH -> verify delta values against known prior month data.
- Filter: claim_type=AHCIP -> verify only AHCIP claims in results.
- PCPCM dual-BA physician: revenue by BA correctly splits.

**File: analytics.reports.integration.ts**
- POST /reports/accountant with format=csv -> poll status -> download -> verify CSV format and row count.
- POST /reports/accountant with format=pdf_summary -> poll -> download -> verify PDF is valid.
- POST /reports/data-portability -> poll -> download -> verify ZIP contains expected CSVs and README.
- GET /reports -> list shows generated reports.
- Download expired report -> 410 Gone.

**File: analytics.subscriptions.integration.ts**
- Create subscription -> list shows it -> update frequency -> verify update -> delete -> list empty.
- Duplicate subscription for same report_type -> 409.

**File: analytics.delegate.integration.ts**
- Delegate with REPORT_VIEW: can view dashboards and list reports. Cannot generate/download.
- Delegate with REPORT_EXPORT: can generate and download reports.
- Delegate without REPORT_VIEW: denied on all analytics endpoints.
- Delegate cannot access DATA_EXPORT (data portability) without explicit DATA_EXPORT permission.

## FRD References
- Domain 8 Section 12: All testing requirements.
- Domain 8 Section 8: User stories and acceptance criteria (Table 14).
- ANL-010: Delegate with REPORT_VIEW can view. REPORT_EXPORT required for downloads.

## Test Specifications
- Revenue KPI matches sum of assessed_fee for paid claims in period.
- Rejection rate = rejected / (assessed + rejected + adjusted) — not rejected / total.
- Aging brackets: 0-30, 31-60, 61-90, 90+ days from DOS.
- Accountant CSV: one row per paid claim, correct columns.
- Data portability: ZIP contains claims.csv, patients.csv, audit_history.csv, ai_suggestions.csv, batches.csv, provider_profile.csv, README.txt.
- Delegate permissions enforce view vs export distinction.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/integration/analytics/
```
Fix any errors before finishing.
