# D08-022: Report generation service — accountant exports, data portability, PDF/CSV generation

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-011** (generated reports repo), **D08-013** (dashboard query repo).

## What to Build
Create `apps/api/src/domains/analytics/services/report-generation.service.ts` and test file `apps/api/src/domains/analytics/services/report-generation.service.test.ts`.

**Responsibilities:**
Generate report files asynchronously. Caller creates a generated_reports record with status 'pending', then this service processes it.

**Methods:**

- `generateAccountantCsv(reportId, providerId, periodStart, periodEnd)` — query all paid claims in period. Write CSV with columns: date_of_service, hsc_code, modifiers, submitted_fee, assessed_fee, payment_date, ba_number, location, claim_type. One row per paid claim. Set report status to 'ready'.
- `generateAccountantPdfSummary(reportId, providerId, periodStart, periodEnd)` — generate PDF with: physician name, BA numbers, period, total revenue, revenue by BA, revenue by location, AHCIP vs WCB revenue, claim count, RRNP premium, adjustments, written-off total, GST-exempt note. Use pdf-lib or similar. Set status 'ready'.
- `generateAccountantPdfDetail(reportId, providerId, periodStart, periodEnd)` — PDF with per-claim detail rows. Suitable for audit.
- `generateDataPortabilityExport(reportId, providerId, password?)` — ZIP containing CSV files: claims.csv (all claims, all states, full fields), patients.csv (complete registry), audit_history.csv (all state changes), ai_suggestions.csv (all suggestions with status), batches.csv (AHCIP + WCB batches), provider_profile.csv (BA numbers, locations, WCB config). Include README.txt explaining schema. Optionally encrypt ZIP with password. Set status 'ready'.
- `processReport(reportId, providerId)` — dispatcher. Read report record, determine type, call appropriate generator. Update status to 'generating' at start, 'ready' on success, 'failed' on error with error_message.

**File storage:** Write to configured storage path (local filesystem or object storage). File path stored in generated_reports.file_path. All files encrypted at rest.

**Accountant CSV fields (Table 9):**
date_of_service, hsc_code, modifier(s), submitted_fee, assessed_fee, payment_date, ba_number, location, claim_type

**PDF Summary fields (Table 9):**
Period, Physician Name, BA Number(s), Total Revenue, Revenue by BA, Revenue by Location, AHCIP Revenue, WCB Revenue, Claim Count, RRNP Premium Total, Adjustments, Written Off, GST Note

**Performance targets (Table 18):**
- Accountant CSV (monthly ~500 rows): < 5 seconds
- Accountant PDF summary (2-4 pages): < 10 seconds
- Accountant PDF detailed (annual ~6,000 rows): < 60 seconds
- Data portability (all data): < 5 minutes

**Unit tests:** CSV output format validation, PDF generation produces valid file, data portability includes all expected CSVs and README, password encryption works, status transitions on success/failure.

## FRD References
- Domain 8 Section 4.1: Export formats — CSV, PDF Summary, PDF Detailed (Table 8).
- Domain 8 Section 4.2: Accountant export fields (Table 9).
- Domain 8 Section 5.1: Data portability export contents — all claims, patients, audit history, AI suggestions, batches, provider profile.
- Domain 8 Section 5.2: Export process — async, notification when ready, authenticated time-limited link, optional password encryption.
- Domain 8 Section 10.2: Report generation time targets (Table 18).

## Security Considerations
- All queries scoped to providerId — data portability export must not leak other physicians' data.
- Data portability is the most sensitive output. Optional password encryption with minimum 12 chars.
- Generated files encrypted at rest. File paths never exposed in API responses.
- CSV exports contain PHN — treat as PHI. PDF exports contain patient data.
- On failure, error_message must not contain PHI or query details — generic error only.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/services/report-generation.service.test.ts
```
Fix any errors before finishing.
