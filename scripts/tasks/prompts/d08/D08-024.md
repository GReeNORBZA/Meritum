# D08-024: Download service — authenticated download links, streaming, expiry enforcement

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-011** (generated reports repo).

## What to Build
Create `apps/api/src/domains/analytics/services/download.service.ts` and test file `apps/api/src/domains/analytics/services/download.service.test.ts`.

**Responsibilities:**
Manage secure file downloads for generated reports.

**Methods:**

- `getDownloadStream(reportId, providerId)` — verify report exists, belongs to provider, status is 'ready', download link not expired. Return file read stream with correct Content-Type and Content-Disposition headers. Mark report as downloaded. Audit log the download event.
- `isDownloadAvailable(reportId, providerId)` — check availability without initiating download. Returns { available: boolean, expires_at?, file_size_bytes? }.
- `cleanupExpiredFiles()` — delete physical files for expired reports. Called by cleanup cron. Delete both the file on disk and update DB record status to 'expired'.

**Content-Type mapping:**
- CSV -> text/csv
- PDF -> application/pdf
- ZIP -> application/zip

**Expiry enforcement:**
- If download_link_expires_at < now(), return 410 Gone.
- If report belongs to different provider, return 404 (not 403).
- If report not in 'ready' status, return 404.

**Unit tests:** successful download streams file, expired link returns 410, wrong provider returns 404, download marks report as downloaded, cleanup deletes files.

## FRD References
- Domain 8 Section 5.2: Download via authenticated, time-limited link.
- Domain 8 Section 4.3: Download link expires in 30 days (accountant reports).
- Domain 8 Section 7.2: Retention — 90 days scheduled, 30 days on-demand, 72 hours data portability.

## Security Considerations
- Provider scoping on every download — wrong provider gets 404 not 403.
- Expired links return 410 Gone — client should not retry.
- File streaming — never load entire file into memory. Stream from disk.
- Audit log every download event including actor identity.
- cleanupExpiredFiles must securely delete physical files — not just DB records.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/services/download.service.test.ts
```
Fix any errors before finishing.
