# D08-031: Report routes — generation, status, download, listing

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-022** (report generation service), **D08-024** (download service), **D08-005** (Zod validation schemas).

## What to Build
Create `apps/api/src/domains/analytics/routes/report.routes.ts` and test file `apps/api/src/domains/analytics/routes/report.routes.test.ts`.

Register Fastify routes. All require authentication.

**Routes:**

1. `POST /api/v1/reports/accountant` — body validated by AccountantReportSchema. Creates generated_reports record, queues async generation. Returns { report_id, status: 'pending' }. Permission: REPORT_EXPORT. Audit log: REPORT_GENERATED.
2. `POST /api/v1/reports/data-portability` — body validated by DataPortabilitySchema. Creates record, queues async generation. Returns { report_id, status: 'pending' }. Permission: DATA_EXPORT. Audit log: DATA_PORTABILITY_REQUESTED (flagged as sensitive action).
3. `GET /api/v1/reports/:id` — param validated by ReportIdParamSchema. Returns report status, file_size_bytes (if ready), download_link_expires_at. Does NOT return file_path. Permission: REPORT_VIEW.
4. `GET /api/v1/reports/:id/download` — stream file download. Permission: REPORT_EXPORT. Audit log: REPORT_DOWNLOADED or DATA_PORTABILITY_DOWNLOADED.
5. `GET /api/v1/reports` — query validated by ReportListQuerySchema. List physician's reports. Paginated. Permission: REPORT_VIEW.

**Async generation:**
Report generation runs asynchronously. POST endpoints return immediately with report_id. Client polls GET /reports/:id for status. Consider using Fastify's task queue or a simple setImmediate-based worker for MVP.

**Route-level unit tests:** validation, permission enforcement, 404 for wrong provider, download streaming.

## FRD References
- Domain 8 Section 9.2: Report endpoints (Table 16).
- Domain 8 Section 4: Accountant export flow.
- Domain 8 Section 5: Data portability export flow.
- Domain 8 Section 11.2: Audit trail — REPORT_GENERATED, REPORT_DOWNLOADED, DATA_PORTABILITY_REQUESTED/DOWNLOADED.

## Security Considerations
- REPORT_EXPORT required for generation and download. REPORT_VIEW sufficient for status check and listing.
- DATA_EXPORT permission required for data portability (separate from REPORT_EXPORT).
- file_path NEVER returned in GET /reports/:id response.
- Download endpoint streams file — never loads into memory.
- Data portability download flagged as sensitive action in audit.
- Expired download links return 410 Gone.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/routes/report.routes.test.ts
```
Fix any errors before finishing.
