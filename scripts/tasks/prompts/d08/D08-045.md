# D08-045: Security: audit trail completeness — all events logged, append-only

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-030** (dashboard routes), **D08-031** (report routes), **D08-032** (subscription routes).

## What to Build
Create `apps/api/test/security/analytics/analytics.audit.security.ts`.

**Verify all audit events are logged (Table 20):**

1. DASHBOARD_VIEWED: View any dashboard -> audit entry with dashboard type, period, filters, actor identity. Verify rate-limited logging (max 1 per dashboard type per 5 minutes per physician).
2. REPORT_GENERATED: Generate accountant report -> audit entry with report type, period, format, actor identity.
3. REPORT_DOWNLOADED: Download a report -> audit entry with report_id, actor identity, timestamp.
4. DATA_PORTABILITY_REQUESTED: Request data export -> audit entry with actor identity, timestamp. Verify flagged as sensitive action.
5. DATA_PORTABILITY_DOWNLOADED: Download data export -> audit entry with actor identity, timestamp. Verify flagged as sensitive action.
6. REPORT_SUBSCRIPTION_CREATED: Create subscription -> audit entry with subscription details, actor identity.
7. REPORT_SUBSCRIPTION_UPDATED: Update subscription -> audit entry with old and new values, actor identity.
8. REPORT_SUBSCRIPTION_CANCELLED: Delete subscription -> audit entry with subscription details, actor identity.

**Audit integrity:**
- Audit entries are append-only. No UPDATE or DELETE on audit log table.
- Verify no audit API allows modification of existing entries.
- Each audit entry includes actor_id, actor_role, action, resource_id, timestamp, and details JSONB.

**Delegate audit trail:**
- When delegate views dashboard -> audit shows delegate as actor, physician as context.
- When delegate downloads report -> audit shows delegate identity clearly.

**Rate-limited audit (DASHBOARD_VIEWED):**
- View revenue dashboard 3 times in 1 minute -> only 1 audit entry.
- View revenue dashboard, then rejection dashboard -> 2 audit entries (different dashboard types).
- Wait 6 minutes, view revenue again -> new audit entry.

## Security Considerations
- Append-only audit log — no UPDATE or DELETE operations permitted.
- Data portability events flagged as sensitive — these are the highest-risk actions.
- Delegate actions clearly attributed to delegate actor with physician context.
- Rate-limited DASHBOARD_VIEWED prevents audit noise while maintaining access pattern visibility.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/analytics/analytics.audit.security.ts
```
Fix any errors before finishing.
