# D08-030: Dashboard routes — all 7 GET endpoints for analytics data

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-020** (dashboard service), **D08-005** (Zod validation schemas).

## What to Build
Create `apps/api/src/domains/analytics/routes/dashboard.routes.ts` and test file `apps/api/src/domains/analytics/routes/dashboard.routes.test.ts`.

Register Fastify routes. All require authentication (Domain 1 middleware). Delegates require ANALYTICS_VIEW or REPORT_VIEW permission.

**Routes:**

1. `GET /api/v1/analytics/revenue` — query params validated by RevenueQuerySchema. Returns RevenueOverviewResponse. Permission: ANALYTICS_VIEW.
2. `GET /api/v1/analytics/rejections` — query params validated by RejectionQuerySchema. Returns RejectionAnalysisResponse. Permission: ANALYTICS_VIEW.
3. `GET /api/v1/analytics/aging` — query params validated by AgingQuerySchema. Returns ClaimAgingResponse. Permission: ANALYTICS_VIEW.
4. `GET /api/v1/analytics/wcb` — query params validated by WcbQuerySchema. Returns WcbAnalyticsResponse. 404 if physician has no WCB config. Permission: ANALYTICS_VIEW.
5. `GET /api/v1/analytics/ai-coach` — query params validated by AiCoachQuerySchema. Returns AiCoachPerformanceResponse. Permission: ANALYTICS_VIEW.
6. `GET /api/v1/analytics/multi-site` — query params validated by MultiSiteQuerySchema. Returns MultiSiteResponse. 404 if physician has only one location. Permission: ANALYTICS_VIEW.
7. `GET /api/v1/analytics/kpis` — query params validated by KpiQuerySchema. Returns KpiCardsResponse. Single call for dashboard init. Permission: ANALYTICS_VIEW.

**All handlers:**
- Extract providerId from authenticated session (or delegate's active physician context).
- Pass validated params to dashboard.service.
- Return JSON response. Include `cache_stale` flag if applicable.
- Audit log DASHBOARD_VIEWED with rate limiting (max 1 log per dashboard type per 5 minutes per physician to avoid audit noise).

**Route-level unit tests:** param validation rejects invalid input, correct service methods called, provider scoping from session.

## FRD References
- Domain 8 Section 9.1: Dashboard data endpoints (Table 15).
- Domain 8 Section 9: All endpoints require authentication, scoped to physician or delegate's active physician context.
- Domain 8 Section 11.2: DASHBOARD_VIEWED audit action — rate-limited to avoid audit noise.

## Security Considerations
- ProviderId extracted from session — never from request params.
- ANALYTICS_VIEW permission enforced for delegates.
- Audit logging rate-limited to avoid noise but still captures access patterns.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/routes/dashboard.routes.test.ts
```
Fix any errors before finishing.
