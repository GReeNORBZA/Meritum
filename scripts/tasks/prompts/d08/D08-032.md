# D08-032: Subscription routes — CRUD for report subscriptions

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-012** (report subscriptions repo), **D08-005** (Zod validation schemas).

## What to Build
Create `apps/api/src/domains/analytics/routes/subscription.routes.ts` and test file `apps/api/src/domains/analytics/routes/subscription.routes.test.ts`.

Register Fastify routes. All require authentication.

**Routes:**

1. `GET /api/v1/report-subscriptions` — list all subscriptions for physician. Permission: REPORT_VIEW.
2. `POST /api/v1/report-subscriptions` — body validated by CreateSubscriptionSchema. Create new subscription. 409 if subscription for that report_type already exists. Permission: REPORT_EXPORT. Audit log: REPORT_SUBSCRIPTION_CREATED.
3. `PUT /api/v1/report-subscriptions/:id` — body validated by UpdateSubscriptionSchema. Update subscription. 404 if not found or wrong provider. Permission: REPORT_EXPORT. Audit log: REPORT_SUBSCRIPTION_UPDATED.
4. `DELETE /api/v1/report-subscriptions/:id` — cancel subscription. 404 if not found or wrong provider. Permission: REPORT_EXPORT. Audit log: REPORT_SUBSCRIPTION_CANCELLED.

**Route-level unit tests:** CRUD operations, 409 on duplicate, 404 for wrong provider, permission enforcement.

## FRD References
- Domain 8 Section 9.3: Subscription endpoints (Table 17).
- Domain 8 Section 6.2: Physician configures which reports and delivery preferences in settings.
- Domain 8 Section 11.2: REPORT_SUBSCRIPTION_CREATED/UPDATED/CANCELLED audit actions.

## Security Considerations
- Provider scoping — subscriptions only accessible by owning physician.
- Wrong provider returns 404 not 403.
- Audit log all subscription changes.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/routes/subscription.routes.test.ts
```
Fix any errors before finishing.
