# D08-040: Security: authentication enforcement on every route

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-030** (dashboard routes), **D08-031** (report routes), **D08-032** (subscription routes).

## What to Build
Create `apps/api/test/security/analytics/analytics.authn.security.ts`.

Test every authenticated route in Domain 8 returns 401 without a valid session cookie:

**Dashboard routes:**
- GET /api/v1/analytics/revenue
- GET /api/v1/analytics/rejections
- GET /api/v1/analytics/aging
- GET /api/v1/analytics/wcb
- GET /api/v1/analytics/ai-coach
- GET /api/v1/analytics/multi-site
- GET /api/v1/analytics/kpis

**Report routes:**
- POST /api/v1/reports/accountant
- POST /api/v1/reports/data-portability
- GET /api/v1/reports/:id
- GET /api/v1/reports/:id/download
- GET /api/v1/reports

**Subscription routes:**
- GET /api/v1/report-subscriptions
- POST /api/v1/report-subscriptions
- PUT /api/v1/report-subscriptions/:id
- DELETE /api/v1/report-subscriptions/:id

For each route (17 total): send request with no cookie, with expired cookie, and with tampered cookie. All must return 401 with no data leakage in the response body.

Total assertions: 17 routes x 3 failure modes = 51 test cases.

## Security Considerations
- 401 responses must not contain any data in the response body beyond the error object.
- Tampered cookies must be rejected (invalid signature / hash mismatch).
- Expired sessions must return 401 (not 200 with stale data).

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/analytics/analytics.authn.security.ts
```
Fix any errors before finishing.
