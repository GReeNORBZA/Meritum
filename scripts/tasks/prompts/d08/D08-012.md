# D08-012: Report subscriptions repository — CRUD, schedule queries

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-006** (migration must be applied first).

## What to Build
Create `apps/api/src/domains/analytics/repos/report-subscriptions.repo.ts` and test file `apps/api/src/domains/analytics/repos/report-subscriptions.repo.test.ts`.

**Methods:**

- `create(data: InsertReportSubscription)` — create subscription. Enforce unique (provider_id, report_type) at repo level too.
- `getById(subscriptionId, providerId)` — fetch by ID scoped to provider. Null for wrong provider (404 pattern).
- `update(subscriptionId, providerId, data: Partial)` — update frequency, delivery_method, is_active. Set updated_at.
- `delete(subscriptionId, providerId)` — hard delete. Return boolean success.
- `listByProvider(providerId)` — list all subscriptions (active + inactive) for a provider.
- `getDueSubscriptions(frequency, dayOfWeek?, dayOfMonth?, quarter?)` — used by scheduler. Returns all active subscriptions matching the given frequency and schedule criteria. Joins provider data for report generation context.

**Unit tests:** create enforces unique constraint, CRUD operations work, getDueSubscriptions filters correctly, provider scoping.

## FRD References
- Domain 8 Section 7.3: report_subscriptions table schema.
- Domain 8 Section 6.1: Scheduled report types and frequencies (Table 10).
- Domain 8 Section 9.3: CRUD API for subscriptions.

## Security Considerations
- delete is a hard delete (subscriptions are not PHI). Audit logged.
- getDueSubscriptions used by system scheduler — returns minimal data needed for generation.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/repos/report-subscriptions.repo.test.ts
```
Fix any errors before finishing.
