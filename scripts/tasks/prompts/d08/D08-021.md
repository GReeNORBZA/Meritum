# D08-021: Cache refresh service — nightly batch, event-driven incremental, stale detection

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-010** (analytics cache repo), **D08-013** (dashboard query repo).

## What to Build
Create `apps/api/src/domains/analytics/services/cache-refresh.service.ts` and test file `apps/api/src/domains/analytics/services/cache-refresh.service.test.ts`.

**Responsibilities:**

1. **Nightly batch refresh:** Compute all metrics for all active providers for all completed periods (trailing 12 months). Called by cron job. Process providers in batches to limit DB load.
2. **Event-driven incremental:** When a claim state changes (paid, rejected, adjusted, etc.), refresh affected metrics for that provider. Called via event handler. Only refresh metrics affected by the state change (e.g., claim paid -> refresh revenue, claims_paid, avg_fee_per_claim).
3. **Stale cache detection:** Check if provider's cache entries are older than threshold (default 60 minutes). Called on dashboard open.
4. **Cleanup:** Delete cache entries for periods >24 months old.

**Methods:**
- `refreshAllProviders()` — nightly batch. Iterate active providers, compute all metric_keys, bulkUpsert.
- `refreshProviderMetrics(providerId, metricKeys?)` — refresh specific metrics for one provider. If metricKeys omitted, refresh all.
- `handleClaimStateChange(providerId, claimType, newState)` — map state change to affected metric_keys and trigger incremental refresh.
- `isStale(providerId, maxAgeMinutes?)` — check if any cached metric is older than threshold.
- `cleanupOldEntries()` — delete entries with period_end >24 months ago.

**Claim state -> metric mapping:**
- paid -> revenue_monthly, claims_paid, avg_fee_per_claim, revenue_by_ba, revenue_by_location, top_hsc_codes, pending_pipeline
- rejected -> rejection_rate_monthly, rejection_by_code, rejection_by_hsc, claims_rejected
- submitted -> claims_submitted, pending_pipeline
- adjusted -> claims_adjusted, rejection_resolution_funnel

**Unit tests:** nightly refresh populates cache, incremental refresh updates only affected metrics, stale detection threshold, cleanup removes old entries.

## FRD References
- Domain 8 Section 7.1: Cache refresh strategy — (1) nightly for all metrics, (2) on-demand when claim state changes, (3) when physician opens dashboard and cache >1 hour old.
- Domain 8 Section 10.3: ~500 cache entries per physician (12 months x ~40 metric_keys).

## Security Considerations
- Nightly batch iterates providers one at a time — never cross-contaminate cache entries.
- Event-driven refresh validates providerId matches the claim's provider before refreshing.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/services/cache-refresh.service.test.ts
```
Fix any errors before finishing.
