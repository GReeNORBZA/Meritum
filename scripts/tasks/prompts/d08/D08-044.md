# D08-044: Security: PHI leakage prevention in errors, headers, and logs

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-030** (dashboard routes), **D08-031** (report routes), **D08-032** (subscription routes).

## What to Build
Create `apps/api/test/security/analytics/analytics.leakage.security.ts`.

**Error responses must not contain PHI:**
- Trigger 404 on report access -> response body contains only error code and generic message, no claim data, no patient info, no file paths.
- Trigger 400 on invalid input -> response contains validation error, no claim details.
- Trigger 500 (simulate internal error) -> response contains generic 'Internal Server Error', no stack trace, no query details, no PHI.

**Response headers must not leak information:**
- No X-Powered-By header (Fastify default removal).
- No server version info in headers.
- file_path field NEVER appears in any API response body.
- Content-Disposition on downloads uses generic filename, not internal file_path.

**Logs must not contain PHI:**
- Dashboard query logs contain provider_id and metric_key but NOT patient data.
- Report generation logs contain report_id and status but NOT file contents or patient data.
- Error logs contain error type and report_id but NOT PHI from the report.

**Analytics-specific leakage vectors:**
- GET /analytics/revenue -> response includes aggregate values only, never individual patient claims.
- GET /reports/:id -> response includes status, file_size, expiry — NOT file_path, NOT report content.
- Accountant CSV download -> Content-Type: text/csv, filename: 'accountant-export-{period}.csv' — not internal path.
- Data portability download -> filename: 'meritum-data-export-{date}.zip' — not internal path.

**Generated report error paths:**
- Failed report generation -> error_message in DB is generic (no PHI). API response shows 'Report generation failed' only.

## Security Considerations
- Analytics aggregates may still derive from PHI — ensure aggregates don't identify individual patients (min cohort sizes in future benchmarking).
- file_path is the most critical field to protect — it reveals internal storage structure.
- Download filenames must be user-friendly, not internal paths.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/analytics/analytics.leakage.security.ts
```
Fix any errors before finishing.
