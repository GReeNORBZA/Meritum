# D08-010: Analytics cache repository — read, upsert, stale detection

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-006** (migration must be applied first).

## What to Build
Create `apps/api/src/domains/analytics/repos/analytics-cache.repo.ts` and test file `apps/api/src/domains/analytics/repos/analytics-cache.repo.test.ts`.

**Methods:**

- `getMetrics(providerId, metricKeys[], periodStart, periodEnd, dimensions?)` — fetch cached metrics for a provider. Filter by metric_key IN metricKeys. Optionally filter by dimensions JSONB containment (@>).
- `upsertMetric(providerId, metricKey, periodStart, periodEnd, dimensions, value)` — insert or update on (provider_id, metric_key, period_start, period_end, dimensions). Update computed_at on upsert.
- `bulkUpsert(entries[])` — batch upsert for nightly refresh. Use Drizzle's onConflictDoUpdate.
- `getStaleEntries(providerId, maxAgeMinutes)` — return metrics where computed_at < now() - maxAgeMinutes. Used to detect when cache needs refresh on dashboard open.
- `deleteExpiredEntries(olderThan: Date)` — cleanup entries for periods no longer relevant (>24 months old).

**All queries MUST include provider_id in WHERE clause.** No method accepts queries without provider_id.

**Unit tests:** upsert creates new entry, upsert updates existing entry and sets computed_at, getMetrics filters correctly, stale detection works, bulk upsert handles conflicts.

## FRD References
- Domain 8 Section 7.1: Cache refresh strategy — nightly for all metrics, on-demand on claim state change, stale detection when cache >1 hour old on dashboard open.
- Domain 8 Section 10.1: Dashboard load < 2 seconds — cache enables this.

## Security Considerations
- Every method requires provider_id parameter. No cross-provider cache access.
- bulkUpsert validates all entries belong to the same provider_id.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/repos/analytics-cache.repo.test.ts
```
Fix any errors before finishing.
