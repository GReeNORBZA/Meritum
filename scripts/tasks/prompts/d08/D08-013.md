# D08-013: Dashboard query repository — complex read queries against claim and provider tables

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-006** (migration must be applied first).

## What to Build
Create `apps/api/src/domains/analytics/repos/dashboard-query.repo.ts` and test file `apps/api/src/domains/analytics/repos/dashboard-query.repo.test.ts`.

This repository performs read-only queries against Domain 4 (claims), Domain 5 (providers), and Domain 7 (intelligence_engine) tables to compute real-time metrics for the current day and to refresh the cache. It does NOT write to those tables.

**Methods (all require providerId):**

- `computeRevenueMetrics(providerId, periodStart, periodEnd, filters?)` — sum assessed_fee for paid claims. Group by month for trend. Group by BA for dual-BA breakdown. Group by HSC code for top-10. Compute pending pipeline (queued + submitted value).
- `computeRejectionMetrics(providerId, periodStart, periodEnd, filters?)` — rejection rate: rejected / (assessed + rejected + adjusted). Group by explanatory code. Group by HSC code. Compute resolution funnel: rejected -> resubmitted -> paid_on_resubmission -> written_off. Corrective action effectiveness by rejection code.
- `computeAgingMetrics(providerId, filters?)` — unresolved claims by age bracket from DOS. Approaching deadline (within 7 days). Expired claims in period. Average resolution time. Stale claims (draft/validated >14 days).
- `computeWcbMetrics(providerId, periodStart, periodEnd, filters?)` — claims by form type. Timing tier distribution. Fee per timing tier. WCB revenue trend. WCB rejection rate.
- `computeAiCoachMetrics(providerId, periodStart, periodEnd)` — acceptance rate from suggestion events. Revenue recovered from accepted suggestions. By category. Top accepted rules. Suppressed rules.
- `computeMultiSiteMetrics(providerId, periodStart, periodEnd, locationIds?)` — revenue, claims, rejection rate per location. RRNP premium per location.
- `computeKpis(providerId, periodStart, periodEnd, filters?)` — all KPI card values in a single query set: total revenue, claims submitted, rejection rate, avg fee per claim, pending pipeline. Plus prior-period values for delta calculation.

Each method returns typed result objects. All queries are parameterised — no string concatenation.

**Unit tests with seeded claim data:** revenue calculation correctness, rejection rate formula, aging bracket assignment, period comparison deltas.

## FRD References
- Domain 8 Section 2.1-2.6: All dashboard widget specifications (Tables 1-6).
- Domain 8 Section 3: Period selection and filter application.
- Domain 8 Section 10.1: Dashboard load < 2 seconds — queries optimised for cache population.

## Security Considerations
- All queries MUST include provider_id in WHERE clause. This is the primary tenant isolation mechanism for analytics.
- Read-only access to Domain 4/5/7 tables. Never INSERT/UPDATE/DELETE claim or provider records.
- All queries parameterised via Drizzle — no raw SQL string concatenation.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/repos/dashboard-query.repo.test.ts
```
Fix any errors before finishing.
