# D08-020: Dashboard service — aggregation, caching, and period comparison logic

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-010** (analytics cache repo), **D08-013** (dashboard query repo).

## What to Build
Create `apps/api/src/domains/analytics/services/dashboard.service.ts` and test file `apps/api/src/domains/analytics/services/dashboard.service.test.ts`.

**Responsibilities:**
1. Resolve period params (THIS_WEEK, THIS_MONTH, etc.) into concrete date ranges + comparison date ranges per Table 7 mapping.
2. Check analytics_cache for completed-period data. If cache hit and fresh (<1 hour), return cached. If stale, trigger background refresh and return stale data with `cache_stale: true` flag.
3. For current-day data, always compute in real-time via dashboard-query.repo.
4. Merge cached completed-period data with real-time current-day data.
5. Compute period-over-period deltas (absolute and percentage).

**Methods:**
- `getRevenueDashboard(providerId, params)` -> RevenueOverviewResponse
- `getRejectionDashboard(providerId, params)` -> RejectionAnalysisResponse
- `getAgingDashboard(providerId, params)` -> ClaimAgingResponse
- `getWcbDashboard(providerId, params)` -> WcbAnalyticsResponse (only if physician has WCB config)
- `getAiCoachDashboard(providerId, params)` -> AiCoachPerformanceResponse
- `getMultiSiteDashboard(providerId, params)` -> MultiSiteResponse (only if physician has multiple locations)
- `getKpis(providerId, params)` -> KpiCardsResponse (all KPI card values in single call)

**Period resolution logic:**
- THIS_WEEK: Monday of current week to today. Comparison: same days (Mon to same weekday) of prior week.
- THIS_MONTH: 1st of month to today. Comparison: 1st to same day of prior month.
- LAST_MONTH: full prior calendar month. Comparison: month before that.
- THIS_QUARTER: quarter start to today. Comparison: same quarter prior year.
- THIS_YEAR: Jan 1 to today. Comparison: Jan 1 to same day prior year.
- CUSTOM_RANGE: user dates. Comparison: same-length period immediately prior.
- TRAILING_12_MONTHS: today - 12 months. Comparison: 12 months before that.

**Unit tests:** period resolution for each period type, cache hit vs real-time fallback, delta calculation (positive/negative/zero), WCB dashboard hidden for non-WCB physicians.

## FRD References
- Domain 8 Section 2: All dashboard specifications with widget details.
- Domain 8 Section 3.1: Time periods and comparison mapping (Table 7).
- Domain 8 Section 3.2: Filter specification — combinable, applied globally.
- Domain 8 Section 7.1: Cache refresh strategy — nightly, event-driven, stale detection >1 hour.
- Domain 8 Section 10.1: Dashboard load < 2 seconds target.

## Security Considerations
- providerId passed through to all repo calls — never omitted.
- WCB dashboard gated on physician WCB configuration from Domain 5.
- Stale data returned with flag — never silently serve outdated data without indication.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/services/dashboard.service.test.ts
```
Fix any errors before finishing.
