# D08-023: Scheduled reports service — subscription processing and scheduling logic

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-012** (report subscriptions repo), **D08-022** (report generation service).

## What to Build
Create `apps/api/src/domains/analytics/services/scheduled-reports.service.ts` and test file `apps/api/src/domains/analytics/services/scheduled-reports.service.test.ts`.

**Responsibilities:**
Process report subscriptions on schedule. Called by cron jobs at appropriate intervals.

**Methods:**

- `processDailySubscriptions()` — find active DAILY subscriptions, generate reports. Currently only REJECTION_DIGEST is daily. Skip if no rejections in past 24 hours (FRD: 'Daily (if any)').
- `processWeeklySubscriptions(dayOfWeek)` — find active WEEKLY subscriptions. WEEKLY_SUMMARY runs on Monday, WCB_TIMING runs on Wednesday.
- `processMonthlySubscriptions()` — find active MONTHLY subscriptions. MONTHLY_PERFORMANCE generated on 3rd business day of month. ACCOUNTANT reports on same schedule.
- `processQuarterlySubscriptions()` — find active QUARTERLY subscriptions. RRNP_QUARTERLY after each quarter end.

**For each due subscription:**
1. Determine period covered (prior week/month/quarter).
2. Create generated_reports record with scheduled=true.
3. Call report-generation.service.processReport().
4. On success, send notification via Domain 6 (Notification Service) with download link.
5. If delivery_method is EMAIL or BOTH, also send email notification with authenticated download link (no report content in email body).

**Schedule details (Table 10):**
- Weekly Billing Summary: every Monday, covers prior week
- Monthly Performance: 1st week of month (3rd business day), covers prior month
- RRNP Quarterly: after each quarter end
- WCB Timing: weekly Wednesday, covers upcoming 7-day tier downgrades
- Rejection Alert Digest: daily if any rejections in past 24 hours

**Unit tests:** subscription filtering by frequency, daily skip logic (no rejections), business day calculation for monthly, notification dispatch on completion.

## FRD References
- Domain 8 Section 6.1: Available scheduled reports and frequencies (Table 10).
- Domain 8 Section 6.2: Report delivery — in-app notification with link, optional email with authenticated download link (no content in email body).
- Domain 8 Section 4.3: Monthly accountant report — 3rd business day, PDF + CSV, notification with download link expiring 30 days.

## Security Considerations
- Email notifications contain download link only — never attach report or include PHI in email body.
- Download links are authenticated and time-limited per report type retention.
- Scheduled generation runs as system process — still scoped to individual provider_id per subscription.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/services/scheduled-reports.service.test.ts
```
Fix any errors before finishing.
