# D08-041: Security: authorization and permission enforcement

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-030** (dashboard routes), **D08-031** (report routes), **D08-032** (subscription routes).

## What to Build
Create `apps/api/test/security/analytics/analytics.authz.security.ts`.

Test permission-based access control:

**Delegate without ANALYTICS_VIEW / REPORT_VIEW:**
- GET /analytics/* -> 403 for all 7 dashboard endpoints
- GET /reports -> 403
- GET /report-subscriptions -> 403

**Delegate with REPORT_VIEW but without REPORT_EXPORT:**
- GET /analytics/* -> 200 (allowed)
- GET /reports -> 200 (allowed, can list)
- GET /reports/:id -> 200 (allowed, can check status)
- POST /reports/accountant -> 403 (cannot generate)
- GET /reports/:id/download -> 403 (cannot download)
- POST /report-subscriptions -> 403 (cannot create)
- PUT /report-subscriptions/:id -> 403 (cannot update)
- DELETE /report-subscriptions/:id -> 403 (cannot delete)

**Delegate with REPORT_EXPORT but without DATA_EXPORT:**
- POST /reports/accountant -> 200 (allowed)
- POST /reports/data-portability -> 403 (DATA_EXPORT required)

**Permission escalation prevention:**
- Delegate cannot modify their own permissions to gain REPORT_EXPORT or DATA_EXPORT.

## Security Considerations
- REPORT_VIEW vs REPORT_EXPORT distinction is critical — view allows dashboards and report listing but not generation or download.
- DATA_EXPORT is a separate, higher-privilege permission for data portability.
- Permission enforcement at route level via Domain 1 middleware.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/analytics/analytics.authz.security.ts
```
Fix any errors before finishing.
