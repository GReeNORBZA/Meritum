# D08-003: Drizzle schema for generated_reports table

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-001** (analytics constants must exist first).

## What to Build
Add to `packages/shared/src/schemas/db/analytics.schema.ts` the generated_reports table.

**generated_reports table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| report_id | UUID | PK | Default: gen_random_uuid() |
| provider_id | UUID FK | NOT NULL | FK to providers. Indexed. |
| report_type | VARCHAR(50) | NOT NULL | One of REPORT_TYPES constants |
| format | VARCHAR(10) | NOT NULL | PDF, CSV, or ZIP |
| period_start | DATE | NULLABLE | Period covered. Null for data portability. |
| period_end | DATE | NULLABLE | |
| file_path | VARCHAR(255) | NOT NULL | Path to generated file (encrypted at rest) |
| file_size_bytes | BIGINT | NOT NULL | For download progress indication |
| download_link_expires_at | TIMESTAMPTZ | NOT NULL | When the download link expires |
| downloaded | BOOLEAN | NOT NULL, DEFAULT false | Whether physician has downloaded |
| scheduled | BOOLEAN | NOT NULL, DEFAULT false | True if from scheduled report |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'pending' | pending, generating, ready, failed, expired |
| error_message | TEXT | NULLABLE | Error details if generation failed |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |

**Indexes:**
- Index on (provider_id, report_type) for listing reports
- Index on (provider_id, created_at DESC) for recent reports
- Index on download_link_expires_at for cleanup job
- Index on (status) for processing queue

Note: Added 'status' and 'error_message' columns beyond FRD spec to support async generation workflow. Status tracks: pending -> generating -> ready | failed. Expired set by cleanup.

Export table and inferred types (InsertGeneratedReport, SelectGeneratedReport).

## FRD References
- Domain 8 Section 7.2: generated_reports table schema (Table 12).
- Domain 8 Section 7.2: Retention — 90 days scheduled, 30 days on-demand, 72 hours data portability.
- Domain 8 Section 10.2: Report generation is asynchronous. Physician receives notification when ready.

## Security Considerations
- file_path points to encrypted-at-rest storage. Never expose file_path in API responses.
- download_link_expires_at enforced server-side. Expired links return 410 Gone.
- Generated reports contain PHI (patient PHN in CSV exports). Treat as sensitive.

## Tests
No specific unit tests for this task — verified by build command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter shared build
```
Fix any errors before finishing.
