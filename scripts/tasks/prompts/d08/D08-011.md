# D08-011: Generated reports repository — CRUD, status tracking, expiry

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-006** (migration must be applied first).

## What to Build
Create `apps/api/src/domains/analytics/repos/generated-reports.repo.ts` and test file `apps/api/src/domains/analytics/repos/generated-reports.repo.test.ts`.

**Methods:**

- `create(data: InsertGeneratedReport)` — create a new report record with status 'pending'.
- `getById(reportId, providerId)` — fetch report by ID scoped to provider. Return null if not found or wrong provider (404 pattern, not 403).
- `updateStatus(reportId, providerId, status, filePath?, fileSizeBytes?, errorMessage?)` — update report status. Used by generation worker.
- `markDownloaded(reportId, providerId)` — set downloaded = true.
- `listByProvider(providerId, filters?)` — list reports with optional type/date filters. Paginated (limit, offset). Ordered by created_at DESC.
- `deleteExpired()` — delete reports where download_link_expires_at < now(). Returns count of deleted.
- `getReadyForDownload(reportId, providerId)` — fetch report only if status = 'ready' and download_link_expires_at > now(). Null otherwise.

**All read/write methods require providerId.** getById and getReadyForDownload return null (not error) for wrong provider — 404 pattern.

**Unit tests:** create sets pending, status transitions work, expired reports excluded from downloads, list pagination, provider scoping returns null for wrong provider.

## FRD References
- Domain 8 Section 7.2: generated_reports table and retention rules.
- Domain 8 Section 9.2: GET /reports/{id} — check status and download link. GET /reports/{id}/download — authenticated, time-limited.
- Domain 8 Section 5.2: Download via authenticated, time-limited link (72-hour expiry for data portability).

## Security Considerations
- getById returns null for wrong providerId — never confirm resource existence to wrong provider (404 not 403).
- file_path is never returned in API responses. Only used server-side for download streaming.
- deleteExpired cleans up PHI-containing files — must also delete the physical file, not just the DB record.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/analytics/repos/generated-reports.repo.test.ts
```
Fix any errors before finishing.
