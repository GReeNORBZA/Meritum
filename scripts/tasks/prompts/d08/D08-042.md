# D08-042: Security: cross-physician tenant isolation (MOST CRITICAL)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D08-030** (dashboard routes), **D08-031** (report routes), **D08-032** (subscription routes).

## What to Build
Create `apps/api/test/security/analytics/analytics.scoping.security.ts`.

**This is the MOST CRITICAL security test for Domain 8.** Analytics data is derived from PHI. Cross-physician leakage would expose patient data.

Setup: Create two physicians (Physician A and Physician B) each with distinct claim data, reports, and subscriptions.

**Dashboard isolation:**
- Physician A views revenue dashboard -> sees ONLY their claims' revenue, not Physician B's.
- Physician A views rejection dashboard -> sees ONLY their rejection data.
- Physician A views aging dashboard -> sees ONLY their unresolved claims.
- Verify KPI values for Physician A match Physician A's data exclusively.
- Repeat all for Physician B to confirm bidirectional isolation.

**Report isolation:**
- Physician A generates accountant report -> CSV contains ONLY Physician A's claims.
- Physician A attempts GET /reports/:id with Physician B's report_id -> 404 (not 403).
- Physician A attempts GET /reports/:id/download with Physician B's report_id -> 404 (not 403).
- Physician A's data portability export contains ONLY Physician A's data across all tables.

**Subscription isolation:**
- Physician A lists subscriptions -> sees ONLY their own.
- Physician A attempts PUT /report-subscriptions/:id with Physician B's subscription_id -> 404 (not 403).
- Physician A attempts DELETE /report-subscriptions/:id with Physician B's subscription_id -> 404 (not 403).

**Cache isolation:**
- Verify analytics_cache entries for Physician A are never returned for Physician B's dashboard queries.

**Delegate cross-physician:**
- Delegate of Physician A in Physician A's context -> sees Physician A's data.
- Delegate switches to Physician B's context (if linked) -> sees Physician B's data, NOT Physician A's.
- Delegate NOT linked to Physician B -> cannot access Physician B's analytics.

All cross-physician access attempts MUST return 404, NEVER 403. Do not confirm resource existence.

## Security Considerations
- MOST CRITICAL: All cross-physician access returns 404 not 403.
- Analytics data is PHI-derived. Cross-physician leakage = patient data breach.
- Verify at every layer: dashboard queries, report access, subscription access, cache entries.
- Data portability export is the highest-risk — must verify complete isolation.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/analytics/analytics.scoping.security.ts
```
Fix any errors before finishing.
