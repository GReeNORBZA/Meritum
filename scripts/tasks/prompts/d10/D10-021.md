# D10-021 â€” Favourite codes service -- management, seeding, sync with desktop

## Task ID
D10-021

## Description
Create the favourite codes service handling CRUD operations, reorder, and auto-seeding from claim history or specialty defaults.

## Dependencies
- D10-011 (favourite codes repository)

## Build Instructions

Create `apps/api/src/domains/mobile/services/favourite-codes.service.ts` and test file `apps/api/src/domains/mobile/services/favourite-codes.service.test.ts`.

**Methods:**

- `addFavourite(providerId, data)` -- validate HSC code exists in Reference Data (Domain 2). Validate count < 30. Validate modifiers are known codes. Create favourite. Audit log: mobile.favourite_added. Return created favourite with resolved HSC description.
- `updateFavourite(providerId, favouriteId, data)` -- validate ownership. Update fields. Return updated favourite.
- `removeFavourite(providerId, favouriteId)` -- validate ownership. Delete. Audit log: mobile.favourite_removed.
- `reorderFavourites(providerId, items)` -- validate all IDs belong to provider. Bulk update sort_order. Audit log: mobile.favourite_reordered.
- `listFavourites(providerId)` -- list favourites in sort order. Join with Reference Data to include HSC code description, fee schedule amount. Return enriched list.
- `seedFavourites(providerId)` -- called on first mobile use or when favourites list is empty. If physician has claim history: query top 10 most frequently billed HSC codes and bulk-create as favourites. If no claim history: query specialty-typical codes from Reference Data (Domain 2) and seed from those. Return seeded count.

**Seeding logic detail:**
1. Check if physician has any favourites -> if yes, skip seeding (already initialised).
2. Query claims table for this provider, GROUP BY health_service_code, ORDER BY COUNT DESC, LIMIT 10.
3. If results found -> bulk-create favourites with sort_order 1-N and no custom display_name or default_modifiers.
4. If no claim history -> query reference_data for specialty-typical codes based on physician's specialty (from Domain 5 provider profile).
5. Bulk-create from specialty defaults.

**Unit tests:** add validates HSC code, max 30 enforcement, reorder validates ownership, seeding from claim history, seeding from specialty defaults, seeding skip when favourites exist.

## FRD References
- Domain 10 Section 4.1: Seeding -- auto-seed from top 10 billed codes or specialty-typical codes.
- Domain 10 Section 4.2: Add/remove, reorder, max 30, default modifiers, sync across mobile and desktop.

## Security Requirements
- HSC code validated against Reference Data -- prevent injection of invalid codes.
- Modifiers validated against known modifier list.
- Seeding queries claim history scoped to provider_id -- no cross-physician claim data access.

## Codebase Context
- Service files go in `apps/api/src/domains/mobile/services/`.
- Test pattern: unit tests co-located as `*.test.ts`.
- Reference Data from D02 (`src/domains/reference-data/`) includes health service codes with fee schedule amounts.
- Claims from D04 (`src/domains/claims/`) provide claim history for seeding.
- Provider profiles from D05 (`src/domains/providers/`) provide specialty information for default seeding.
- Audit events: use the existing audit logging infrastructure from D12.
- Favourites max 30 per physician, auto-seed from top 10 billed codes (AUTO_SEED_COUNT from constants).

## Verification
```bash
pnpm --filter api vitest run src/domains/mobile/services/favourite-codes.service.test.ts
```
