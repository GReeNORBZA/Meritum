# D10-010 â€” ED shifts repository -- start, end, active lookup, history

## Task ID
D10-010

## Description
Create the ED shifts repository with all CRUD operations for shift lifecycle management.

## Dependencies
- D10-005 (migration must be applied first)

## Build Instructions

Create `apps/api/src/domains/mobile/repos/ed-shifts.repo.ts` and test file `apps/api/src/domains/mobile/repos/ed-shifts.repo.test.ts`.

**Methods (all require providerId):**

- `create(data: InsertEdShift)` -- create new shift with status ACTIVE. Will throw on unique constraint violation if physician already has an active shift.
- `getActive(providerId)` -- get the active shift (status = 'ACTIVE') for this provider. Returns null if none. Uses the partial unique index.
- `getById(shiftId, providerId)` -- fetch shift by ID scoped to provider. Return null for wrong provider (404 pattern).
- `endShift(shiftId, providerId)` -- set shift_end = now(), status = 'ENDED'. Recalculate patient_count and estimated_value from linked claims. Return updated shift.
- `markReviewed(shiftId, providerId)` -- set status = 'REVIEWED'. Called when physician reviews all shift claims on desktop.
- `list(providerId, filters?)` -- list shifts with optional status filter. Paginated by limit. Ordered by created_at DESC.
- `incrementPatientCount(shiftId, providerId, feeAmount)` -- atomically increment patient_count by 1 and add feeAmount to estimated_value. Called after logging a patient encounter.
- `getSummary(shiftId, providerId)` -- return shift details plus list of claim IDs and basic claim data (patient name, HSC code, fee) linked to this shift.

**Unit tests:** create with active shift throws, getActive returns correct shift, endShift sets timestamp and recalculates, incrementPatientCount is atomic, provider scoping returns null for wrong provider.

## FRD References
- Domain 10 Section 2.1: Shift lifecycle -- start, log patients, end, review (Table 0).
- Domain 10 Section 2.2: ed_shifts table fields and shift session management.
- Domain 10 Section 8.1: Shift API endpoints (Table 6).

## Security Requirements
- One active shift per physician enforced at DB level (unique partial index) and repo level.
- All methods require providerId -- no cross-physician shift access.
- getById returns null for wrong provider -- 404 pattern.
- incrementPatientCount uses atomic SQL (SET patient_count = patient_count + 1) to prevent race conditions.

## Codebase Context
- Monorepo: `apps/api` (Fastify 5 + Vitest).
- Repository files go in `apps/api/src/domains/mobile/repos/`.
- Test pattern: unit tests co-located as `*.test.ts`.
- DB: PostgreSQL via Drizzle ORM. The ed_shifts schema is in `packages/shared/src/schemas/db/mobile.schema.ts`.
- ED shifts use a unique partial index `WHERE status = 'ACTIVE'` to enforce one active shift per physician at DB level.
- Claims from D04 have a shift_id FK that links claims to shifts.
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`.

## Verification
```bash
pnpm --filter api vitest run src/domains/mobile/repos/ed-shifts.repo.test.ts
```
