# D10-044 â€” Security: PHI leakage prevention in errors, headers, and logs

## Task ID
D10-044

## Description
Create security tests verifying that PHI is not leaked through error responses, HTTP headers, application logs, or summary endpoints.

## Dependencies
- D10-030 (shift routes)
- D10-031 (favourite routes)
- D10-032 (mobile routes)

## Build Instructions

Create `apps/api/test/security/mobile/mobile.leakage.security.ts`.

**Error responses must not contain PHI:**
- 404 on shift access -> no shift data, no patient data in response.
- 400 on invalid input -> validation error only, no claim/patient data.
- 500 (simulated) -> generic error, no stack trace, no PHI.
- 409 on duplicate active shift -> error message, no shift details of existing shift.
- 409 on duplicate favourite -> error message, no details of existing favourite.

**Response headers:**
- No X-Powered-By header.
- No server version info.

**Logs must not contain PHI:**
- Shift logging captures shift_id and provider_id but NOT patient names or PHN.
- Quick claim logging captures claim_id but NOT patient data.
- Error logs contain generic error type but NOT PHI.

**Mobile-specific leakage vectors:**
- GET /mobile/summary -> counts only, no patient names, no claim details.
- GET /mobile/recent-patients -> returns patient first_name, last_name, PHN (intentional PHI in response -- but only for the authenticated physician's patients).
- Shift summary -> includes patient names and HSC codes (intentional PHI -- but only for the authenticated physician's shift).
- After-hours detection flag -> boolean only, no patient data.

**Quick note handling:**
- quick_note stored on claim for physician reference. Not included in AHCIP submission data. Verify it does not appear in batch submission payloads.

## Security Requirements
- Mobile summary is PHI-free (counts only).
- Recent patients response intentionally contains PHI (names, PHN) -- scoped to authenticated physician.
- quick_note is physician-private -- never transmitted in AHCIP batch data.

## Codebase Context
- Security tests go in `apps/api/test/security/mobile/`.
- PHN masking: display as `123******` in contexts where full PHN is not needed.
- See existing leakage security tests in `test/security/` from other domains for test patterns.
- Fastify 5 + Vitest test framework.

## Verification
```bash
pnpm --filter api vitest run test/security/mobile/mobile.leakage.security.ts
```
