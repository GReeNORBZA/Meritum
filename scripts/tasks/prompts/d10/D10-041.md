# D10-041 â€” Security: authorization and role enforcement

## Task ID
D10-041

## Description
Create security tests verifying role-based and permission-based access control on all Domain 10 routes.

## Dependencies
- D10-030 (shift routes)
- D10-031 (favourite routes)
- D10-032 (mobile routes)

## Build Instructions

Create `apps/api/test/security/mobile/mobile.authz.security.ts`.

Test role and permission-based access control:

**Delegate cannot manage shifts (physician-only):**
- POST /shifts as delegate -> 403
- POST /shifts/:id/end as delegate -> 403
- POST /shifts/:id/patients as delegate -> 403 (or allowed if delegate has CLAIM_CREATE -- clarify per business rule)

**Delegate without CLAIM_VIEW:**
- GET /shifts/active -> 403
- GET /shifts -> 403
- GET /favourites -> 403
- GET /mobile/summary -> 403
- GET /mobile/recent-patients -> 403

**Delegate with CLAIM_VIEW but without CLAIM_CREATE:**
- GET /shifts/active -> 200 (allowed)
- POST /mobile/quick-claim -> 403 (cannot create claims)
- POST /favourites -> 403 (cannot modify favourites)

**Delegate without PATIENT_CREATE:**
- POST /mobile/patients -> 403

**Permission escalation prevention:**
- Delegate cannot use shift management to create claims under the physician's identity without CLAIM_CREATE.

## Security Requirements
- Shift start/end is physician-only -- delegates observe shifts but don't manage them.
- CLAIM_CREATE required for quick claims, patient logging, and favourite modifications.
- PATIENT_CREATE required for mobile patient creation.

## Codebase Context
- Security tests go in `apps/api/test/security/mobile/`.
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. Roles: physician, delegate, admin.
- See existing security test patterns in `test/security/` from other domains for role-based test setup.
- Fastify 5 + Vitest test framework.

## Verification
```bash
pnpm --filter api vitest run test/security/mobile/mobile.authz.security.ts
```
