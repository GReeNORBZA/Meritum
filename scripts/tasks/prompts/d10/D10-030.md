# D10-030 â€” Shift management routes -- start, end, active, summary, list

## Task ID
D10-030

## Description
Create Fastify routes for ED shift management including start, end, active lookup, summary, listing, and patient logging within a shift.

## Dependencies
- D10-020 (ED shift service)
- D10-004 (Zod validation schemas)

## Build Instructions

Create `apps/api/src/domains/mobile/routes/shift.routes.ts` and test file `apps/api/src/domains/mobile/routes/shift.routes.test.ts`.

Register Fastify routes. All require authentication. Physician role only (delegates cannot manage shifts).

**Routes:**

1. `POST /api/v1/shifts` -- body validated by StartShiftSchema. Start new shift. Returns shift. 409 if active shift already exists. Permission: CLAIM_CREATE.
2. `GET /api/v1/shifts/active` -- no params. Returns active shift or 204 No Content if none. Permission: CLAIM_VIEW.
3. `POST /api/v1/shifts/:id/end` -- param validated by ShiftIdParamSchema. End active shift. Returns shift summary. 404 if shift not found or wrong provider. 400 if shift not active. Permission: CLAIM_CREATE.
4. `GET /api/v1/shifts/:id/summary` -- param validated by ShiftIdParamSchema. Returns shift summary with linked claims. Permission: CLAIM_VIEW.
5. `GET /api/v1/shifts` -- query validated by ListShiftsQuerySchema. List recent shifts. Permission: CLAIM_VIEW.

**Patient logging within shift (uses existing claim creation with shift context):**
6. `POST /api/v1/shifts/:id/patients` -- body validated by LogPatientSchema. Log patient encounter in active shift. Creates draft claim linked to shift. Returns claim with after_hours_eligible flag. Permission: CLAIM_CREATE.

**Route-level unit tests:** param validation, 409 on duplicate active shift, 404 for wrong provider, 400 for ending non-active shift.

## FRD References
- Domain 10 Section 8.1: Shift management endpoints (Table 6).
- Domain 10 Section 2.1: Shift lifecycle steps.
- Domain 10 Section 7: User stories MOB-001, MOB-002, MOB-003.

## Security Requirements
- Physician role only -- delegates cannot start or manage ED shifts.
- Provider scoping from session -- shift operations only on own shifts.
- 409 on duplicate active shift reveals existence -- acceptable since it's the same physician.
- Wrong provider on shift access returns 404 not 403.

## Codebase Context
- Route files go in `apps/api/src/domains/mobile/routes/`.
- Test pattern: unit tests co-located as `*.test.ts`.
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. Roles: physician, delegate, admin.
- Zod validation schemas from `packages/shared/src/schemas/validation/mobile.validation.ts` (D10-004).
- See existing route patterns in other domains (D04 claims, D05 providers) for Fastify route registration, middleware usage, and error handling.
- ED shifts use a unique partial index `WHERE status = 'ACTIVE'` to enforce one active shift per physician at DB level.

## Verification
```bash
pnpm --filter api vitest run src/domains/mobile/routes/shift.routes.test.ts
```
