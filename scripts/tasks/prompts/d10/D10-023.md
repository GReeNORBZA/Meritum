# D10-023 â€” Mobile summary service -- lightweight KPI aggregation for home screen

## Task ID
D10-023

## Description
Create the mobile summary service providing lightweight KPI aggregation for the mobile home screen.

## Dependencies
- D10-010 (ED shifts repository)

## Build Instructions

Create `apps/api/src/domains/mobile/services/mobile-summary.service.ts` and test file `apps/api/src/domains/mobile/services/mobile-summary.service.test.ts`.

**Methods:**

- `getSummary(providerId)` -- single lightweight query returning:
  - today_claims_count: count of claims created today by this physician
  - pending_queue_count: count of claims in 'queued' state awaiting submission
  - unread_notifications_count: count from Domain 6 notification service
  - active_shift: { shift_id, shift_start, patient_count, estimated_value } or null

**Performance requirement:** Response < 100ms. This endpoint is called on every mobile home screen load.

**Optimisation strategy:**
- Use COUNT queries with indexed columns -- no full table scans.
- today_claims_count: WHERE provider_id = $1 AND created_at >= today_start
- pending_queue_count: WHERE provider_id = $1 AND state = 'queued'
- unread_notifications_count: call Domain 6 unread count method
- active_shift: use the ed_shifts active shift lookup (already indexed)
- Consider caching this response for 30 seconds per provider if DB latency is a concern.

Audit log: mobile.summary_viewed (rate-limited, max 1 per 10 minutes per physician).

**Unit tests:** summary returns correct counts with seeded data, no active shift returns null, performance under 100ms with indexed queries.

## FRD References
- Domain 10 Section 8.3: GET /api/v1/mobile/summary -- today_claims_count, pending_queue_count, unread_notifications_count, active_shift_id (Table 8).
- Domain 10 Section 5.2: Home tab shows today's claims logged, pending queue count, unread notifications count.
- Domain 10 Section 9.4: Mobile summary endpoint < 100ms response time.

## Security Requirements
- providerId scoped -- summary only includes this physician's data.
- unread_notifications_count comes from Domain 6 scoped to physician.
- Lightweight response -- no PHI in summary (counts only, no patient data).

## Codebase Context
- Service files go in `apps/api/src/domains/mobile/services/`.
- Test pattern: unit tests co-located as `*.test.ts`.
- Notifications from D09 (`src/domains/notifications/`) provide the unread count method.
- Claims from D04 (`src/domains/claims/`) provide claim count queries.
- ED shifts repository from D10-010 provides active shift lookup.
- Audit events: use the existing audit logging infrastructure from D12. Summary viewed audit is rate-limited (max 1 per 10 minutes per physician).
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`.

## Verification
```bash
pnpm --filter api vitest run src/domains/mobile/services/mobile-summary.service.test.ts
```
