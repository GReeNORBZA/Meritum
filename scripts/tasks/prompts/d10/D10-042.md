# D10-042 â€” Security: cross-physician tenant isolation (MOST CRITICAL)

## Task ID
D10-042

## Description
Create security tests verifying complete cross-physician tenant isolation for all Domain 10 resources. This is the MOST CRITICAL security test -- shifts and claims contain PHI.

## Dependencies
- D10-030 (shift routes)
- D10-031 (favourite routes)
- D10-032 (mobile routes)

## Build Instructions

Create `apps/api/test/security/mobile/mobile.scoping.security.ts`.

**MOST CRITICAL security test for Domain 10.** Shifts and claims contain PHI.

Setup: Create two physicians (Physician A and Physician B) each with shifts, favourites, and claims. Use the `createSecurityPair()` helper.

**Shift isolation:**
- Physician A starts shift. Physician B calls GET /shifts/active -> null (not Physician A's shift).
- Physician A ends shift. Physician B calls GET /shifts/:id/summary with Physician A's shift_id -> 404 (not 403).
- Physician B calls POST /shifts/:id/patients with Physician A's shift_id -> 404 (not 403).
- Physician B calls POST /shifts/:id/end with Physician A's shift_id -> 404 (not 403).
- Physician A lists shifts -> sees only their shifts. Physician B lists shifts -> sees only their shifts.

**Favourite isolation:**
- Physician A's favourites list contains only their codes.
- Physician B calls PUT /favourites/:id with Physician A's favourite_id -> 404.
- Physician B calls DELETE /favourites/:id with Physician A's favourite_id -> 404.
- Physician B calls PUT /favourites/reorder with Physician A's favourite_ids -> validation failure (IDs don't belong to Physician B).

**Quick claim isolation:**
- Physician A creates quick claim -> appears in Physician A's claim list only.
- Physician A's recent patients list contains only patients they've billed.

**Mobile summary isolation:**
- Physician A's summary shows only their counts. Physician B's summary shows only their counts.

**Delegate cross-physician:**
- Delegate of Physician A in Physician A's context -> sees Physician A's shifts, favourites, summary.
- Delegate cannot access Physician B's data if not linked to Physician B.

All cross-physician access attempts MUST return 404, NEVER 403.

## Security Requirements
- MOST CRITICAL: All cross-physician access returns 404 not 403.
- Shift data is PHI-adjacent -- shift contains patient encounters.
- Favourite codes are non-PHI but still physician-specific.
- reorder endpoint must validate ALL IDs in the batch belong to the calling physician.

## Codebase Context
- Security tests go in `apps/api/test/security/mobile/`.
- Security test helper: `createSecurityPair()` creates two physician accounts for cross-tenant isolation testing.
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`.
- See existing scoping security tests in `test/security/` from other domains for the 404-not-403 pattern.
- Fastify 5 + Vitest test framework.

## Verification
```bash
pnpm --filter api vitest run test/security/mobile/mobile.scoping.security.ts
```
