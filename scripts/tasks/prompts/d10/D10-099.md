# D10-099 â€” Full domain test suite: all unit + integration + security tests

## Task ID
D10-099

## Description
Run the complete test suite for Domain 10 Mobile Companion. Fix any failures in source code (not tests). Validate all endpoints are registered and all security test files exist.

## Dependencies
- D10-040 (authn security tests)
- D10-041 (authz security tests)
- D10-042 (scoping security tests)
- D10-043 (input security tests)
- D10-044 (leakage security tests)
- D10-045 (audit security tests)

## Build Instructions

Run the complete test suite for Domain 10 Mobile Companion. Do NOT write new code unless tests fail.

1. Run all unit tests: `pnpm --filter api vitest run src/domains/mobile/`
2. Run all integration tests: `pnpm --filter api vitest run test/integration/mobile/`
3. Run all security tests: `pnpm --filter api vitest run test/security/mobile/`

If any tests fail: read the failure, fix the source code (not the tests unless the test is wrong), re-run.

After all pass, run the full suite one final time:
```bash
pnpm --filter api vitest run src/domains/mobile/ test/integration/mobile/ test/security/mobile/
```

Verify these security test files exist and are non-empty:
- test/security/mobile/mobile.authn.security.ts
- test/security/mobile/mobile.authz.security.ts
- test/security/mobile/mobile.scoping.security.ts
- test/security/mobile/mobile.input.security.ts
- test/security/mobile/mobile.leakage.security.ts
- test/security/mobile/mobile.audit.security.ts

Verify all Domain 10 API endpoints are registered and reachable:
- 6 shift management endpoints (2 POST, 4 GET including patient log POST)
- 5 favourite codes endpoints (1 GET, 1 POST, 2 PUT, 1 DELETE)
- 5 mobile endpoints (2 POST, 2 GET, 1 sync placeholder)

Total: 16 authenticated routes + 1 unauthenticated (sync 501), 2 DB tables, 6 security test suites.

## Codebase Context
- Monorepo: `apps/api` (Fastify 5 + Vitest), `packages/shared` (Drizzle + Zod), `apps/web` (Next.js 15).
- All unit tests co-located as `*.test.ts` in `src/domains/mobile/`.
- Integration tests in `test/integration/mobile/`.
- Security tests in `test/security/mobile/`.
- DB: PostgreSQL via Drizzle ORM.
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. Roles: physician, delegate, admin.
- Security test helper: `createSecurityPair()` creates two physician accounts for cross-tenant isolation testing.

## Verification
```bash
pnpm --filter api vitest run src/domains/mobile/ test/integration/mobile/ test/security/mobile/
```
