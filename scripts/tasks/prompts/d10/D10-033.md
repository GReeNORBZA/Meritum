# D10-033 â€” Integration tests -- end-to-end mobile workflows

## Task ID
D10-033

## Description
Create comprehensive integration tests covering end-to-end mobile workflows for shifts, quick entry, favourites, summary, and delegate access.

## Dependencies
- D10-030 (shift routes)
- D10-031 (favourite routes)
- D10-032 (mobile routes)

## Build Instructions

Create integration test files in `apps/api/test/integration/mobile/`:

**File: mobile.shift.integration.ts**
- Start shift at location -> verify shift active -> log 3 patients with favourite codes -> verify patient_count = 3 -> end shift -> verify summary matches 3 patients.
- After-hours: start shift, log patient at 19:00 -> verify AFHR eligible flag. Log patient at 23:30 -> verify NGHR eligible flag.
- Active shift persistence: start shift -> reload (new request with same session) -> GET /shifts/active returns the shift.
- One active shift: start shift -> attempt second start -> 409.
- Shift claims appear in desktop claim list (GET /api/v1/claims with shift_id filter).

**File: mobile.quick-entry.integration.ts**
- Quick entry flow: create minimal patient -> quick claim with patient -> verify draft claim in desktop list.
- Recent patients: create 3 claims for different patients -> GET /recent-patients returns them ordered by recency.
- Quick entry creates AHCIP only: attempt WCB -> rejected.
- Quick entry claim has source='mobile_quick_entry'.

**File: mobile.favourites.integration.ts**
- First GET triggers seeding (seed physician with known claim history first) -> favourites list populated from top billed codes.
- Add favourite -> appears in list -> update display_name -> verify -> delete -> removed.
- Max 30: add 30 favourites -> attempt 31st -> 400.
- Reorder: create 5 favourites -> reorder -> verify new sort_order.
- Duplicate HSC code -> 409.

**File: mobile.summary.integration.ts**
- Seed claims and active shift -> GET /mobile/summary -> verify all counts correct.
- No active shift -> summary.active_shift is null.
- GET /sync/claims -> 501.

**File: mobile.delegate.integration.ts**
- Delegate with CLAIM_VIEW can view shifts, favourites, summary.
- Delegate cannot start/end shifts (physician-only operation).
- Delegate with CLAIM_CREATE can create quick claims on behalf of physician.

## FRD References
- Domain 10 Section 9: All testing requirements -- responsive design, ED shift, quick entry, performance.
- Domain 10 Section 7: User stories and acceptance criteria (Table 5).
- MOB-002: < 5 taps for repeat patient + favourite code.
- MOB-004: Quick entry under 30 seconds.
- MOB-008: TTI < 3s, code search < 200ms, claim save < 1s.

## Test Specifications
- Start shift -> log patients -> end shift -> summary shows correct count and estimated value.
- After-hours detection: 18:00 weekday -> AFHR, 23:30 weekday -> NGHR, Saturday -> WKND.
- One active shift constraint: second start attempt -> 409.
- Quick claim creates AHCIP draft with source='mobile_quick_entry'.
- Favourites auto-seed from top 10 billed codes on first access.
- Max 30 favourites enforced. Duplicate HSC code -> 409.
- Mobile summary returns correct counts under 100ms.
- Sync endpoint returns 501 Not Implemented.

## Codebase Context
- Integration tests go in `apps/api/test/integration/mobile/`.
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. Roles: physician, delegate, admin.
- Security test helper: `createSecurityPair()` creates two physician accounts for cross-tenant isolation testing.
- Existing integration test patterns in `test/integration/` from other domains provide test setup patterns.
- Claims from D04 have state machine: draft -> validated -> queued -> submitted -> accepted/rejected.
- ED shifts use a unique partial index `WHERE status = 'ACTIVE'` to enforce one active shift per physician at DB level.
- Quick claims are AHCIP-only, always draft state, source='mobile_quick_entry'.
- After-hours detection is suggestion-only (AFHR/NGHR/WKND modifiers), never auto-applied.

## Verification
```bash
pnpm --filter api vitest run test/integration/mobile/
```
