# D10-045 â€” Security: audit trail completeness -- all events logged, append-only

## Task ID
D10-045

## Description
Create security tests verifying that all Domain 10 audit events are logged correctly, the audit log is append-only, and rate-limited summary audit works as expected.

## Dependencies
- D10-030 (shift routes)
- D10-031 (favourite routes)
- D10-032 (mobile routes)

## Build Instructions

Create `apps/api/test/security/mobile/mobile.audit.security.ts`.

**Verify all audit events are logged:**

1. mobile.shift_started: Start shift -> audit entry with shift_id, location_id, provider_id, timestamp.
2. mobile.shift_ended: End shift -> audit entry with shift_id, patient_count, estimated_value, provider_id.
3. mobile.patient_logged: Log patient in shift -> audit entry with shift_id, claim_id, provider_id. NO patient name or PHN in audit entry.
4. mobile.quick_claim_created: Quick claim -> audit entry with claim_id, health_service_code, provider_id. NO patient data.
5. mobile.favourite_added: Add favourite -> audit entry with favourite_id, health_service_code, provider_id.
6. mobile.favourite_removed: Remove favourite -> audit entry with favourite_id, provider_id.
7. mobile.favourite_reordered: Reorder -> audit entry with provider_id, count of items reordered.
8. mobile.summary_viewed: View summary -> audit entry rate-limited (max 1 per 10 minutes per physician).

**Audit integrity:**
- Audit entries are append-only. No UPDATE or DELETE on audit log table.
- Each audit entry includes actor_id, actor_role, action, resource_id, timestamp, and details JSONB.

**Delegate audit:**
- Delegate viewing summary -> audit shows delegate as actor, physician as context.
- Delegate creating quick claim -> audit shows delegate identity.

**Rate-limited audit (mobile.summary_viewed):**
- View summary 5 times in 1 minute -> only 1 audit entry.
- Wait 11 minutes, view again -> new audit entry.

## Security Requirements
- Append-only audit log -- no UPDATE or DELETE.
- Patient logging audit MUST NOT contain patient name or PHN -- only claim_id reference.
- Rate-limited summary audit prevents noise from frequent mobile home screen loads.

## Codebase Context
- Security tests go in `apps/api/test/security/mobile/`.
- Audit events: use the existing audit logging infrastructure from D12 (`src/domains/platform/`).
- All audit action identifiers are defined in `packages/shared/src/constants/mobile.constants.ts` (D10-001).
- See existing audit security tests in `test/security/` from other domains for test patterns.
- Fastify 5 + Vitest test framework.

## Verification
```bash
pnpm --filter api vitest run test/security/mobile/mobile.audit.security.ts
```
