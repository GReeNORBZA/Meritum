# D10-020 â€” ED shift service -- shift lifecycle, patient logging, after-hours detection

## Task ID
D10-020

## Description
Create the ED shift service handling shift lifecycle, patient logging during shifts, and after-hours auto-detection logic.

## Dependencies
- D10-010 (ED shifts repository)

## Build Instructions

Create `apps/api/src/domains/mobile/services/ed-shift.service.ts` and test file `apps/api/src/domains/mobile/services/ed-shift.service.test.ts`.

**Methods:**

- `startShift(providerId, locationId)` -- validate location belongs to physician (via Domain 5 provider-locations). Check no active shift exists. Create shift. Audit log: mobile.shift_started. Return shift.
- `getActiveShift(providerId)` -- return active shift or null.
- `logPatient(providerId, shiftId, logData)` -- validate shift is active and belongs to provider. Create a draft AHCIP claim (via Domain 4 claim service) with shift_id populated. Set claim.date_of_service to today. Set encounter_start to now(). Detect after-hours eligibility based on current time. Increment shift patient_count and estimated_value. Audit log: mobile.patient_logged. Return created claim with after_hours_eligible flag.
- `endShift(providerId, shiftId)` -- validate shift is active and belongs to provider. End shift. Return summary: patient_count, estimated_value, claim list with after-hours flags. Audit log: mobile.shift_ended.
- `getShiftSummary(providerId, shiftId)` -- return shift details + linked claims summary.
- `listShifts(providerId, filters)` -- list physician's shifts.

**After-hours auto-detection logic:**
Given an encounter timestamp and the physician's location timezone:
1. Convert encounter time to local time.
2. Check if day is a weekend (Sat/Sun) -> WKND modifier eligible.
3. Check if day is an Alberta statutory holiday -> WKND modifier eligible.
4. If weekday, check time bracket: 17:00-23:00 -> AFHR, 23:00-08:00 -> NGHR.
5. Check if the HSC code is eligible for the detected modifier (some codes exclude after-hours).
6. Return { modifier: 'AFHR'|'NGHR'|'WKND'|null, eligible: boolean }.
7. This is a suggestion only -- not auto-applied. Shown as indicator on mobile, confirmed on desktop.

**Alberta statutory holidays (for auto-detection):**
New Year's Day, Family Day (3rd Monday Feb), Good Friday, Victoria Day, Canada Day, Heritage Day (1st Monday Aug), Labour Day, Truth and Reconciliation Day (Sept 30), Thanksgiving, Remembrance Day, Christmas Day.
Note: Some are fixed dates, some are relative. Use a holiday calculation library or compute programmatically.

**Unit tests:** start shift succeeds, start shift with active shift fails, log patient creates draft claim with shift_id, after-hours detection for each time bracket, end shift returns summary, location validation.

## FRD References
- Domain 10 Section 2.1: Shift lifecycle -- 7 steps from start to desktop review (Table 0).
- Domain 10 Section 2.2: Each claim created during shift has shift_id populated.
- Domain 10 Section 2.3: After-hours auto-detection -- AFHR, NGHR, WKND modifiers as suggestions.
- Domain 10 Section 2.1 Step 6: End shift shows patient count, estimated total value, flagged items.

## Security Requirements
- Location validated against physician's practice locations -- cannot start shift at another physician's location.
- Shift ownership validated before logging patient or ending shift.
- Claims created via logPatient inherit provider_id scoping from the shift -- no cross-physician claim creation.
- After-hours detection is suggestion-only -- never auto-applied. Physician confirms on desktop.

## Codebase Context
- Service files go in `apps/api/src/domains/mobile/services/`.
- Test pattern: unit tests co-located as `*.test.ts`.
- Existing domains: providers (D05 `src/domains/providers/`), claims (D04 `src/domains/claims/`), audit logging (D12 `src/domains/platform/`).
- Auth pattern: session cookie auth with `request.session.user` containing `{ id, role, physician_id }`.
- Audit events: use the existing audit logging infrastructure from D12.
- Claims from D04 have state machine: draft -> validated -> queued -> submitted -> accepted/rejected.
- Provider locations from D05 include the practice_locations table.
- After-hours detection is suggestion-only (AFHR/NGHR/WKND modifiers), never auto-applied.

## Verification
```bash
pnpm --filter api vitest run src/domains/mobile/services/ed-shift.service.test.ts
```
