# Task D06-043: Security — input validation and injection prevention

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/test/security/patient/patient.input.security.ts`.

**SQL injection payloads on all string inputs:**
- phn field: `' OR 1=1--`, `'; DROP TABLE patients;--`
- first_name, last_name: SQL injection payloads
- search name query: SQL injection payloads (must be rejected or safely parameterised)

**XSS payloads on all stored text fields:**
- first_name: `<script>alert(1)</script>`
- notes: `<img onerror=alert(1) src=x>`
- address_line_1: XSS payloads

**Type coercion attacks:**
- Send number where string expected, array where string expected
- Send negative page_size to search -> rejected or capped
- Send page_size > 100 to search -> capped at 100

**PHN validation:**
- PHN with 8 digits -> 400
- PHN with 10 digits -> 400
- PHN with letters -> 400
- PHN with valid format but invalid Luhn check digit -> 400

**Gender validation:**
- Gender value 'Z' -> 400
- Gender value 'Male' (must be M) -> 400

**UUID parameter validation:**
- Non-UUID in path params (e.g., GET /patients/not-a-uuid) -> 400

**Import file validation:**
- Upload non-CSV file -> 400
- Upload file exceeding 10MB -> 413
- CSV with malicious content in cells (formula injection: =CMD|') -> sanitised

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 5 (check `apps/api/test/security/provider/provider.input.security.ts` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D06-030 must be complete (patient CRUD and search routes).
- D06-031 must be complete (CSV import routes).
- D06-032 must be complete (merge, export, and internal API routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/patient/patient.input.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
