# Task D06-044: Security — PHI leakage prevention

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/test/security/patient/patient.leakage.security.ts`.

**PHN masking in audit logs:**
- Create patient with PHN. Query audit log. PHN in audit detail is masked (123******).
- Update patient PHN. Audit log contains both old and new PHNs masked.

**Error response sanitisation:**
- 401 response body contains only error object, no patient data
- 404 response for cross-physician patient does not confirm patient exists
- 500 error does not expose stack traces, SQL errors, or patient details
- Duplicate PHN error does not reveal existing patient details

**Header checks:**
- No X-Powered-By header
- No Server header revealing version

**Sensitive data not in responses:**
- Patient notes NOT included in export CSV
- Patient notes NOT included in internal claim-context API response
- Search results do not include notes field
- Import error details do not expose existing patient PHI

**Anti-enumeration:**
- PHN search rate-limited to prevent PHN enumeration across requests
- Internal PHN validation endpoint does not expose patient name/DOB in response

**Export security:**
- Export download URL is time-limited (1 hour expiry)
- Export download URL requires authentication

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 5 (check `apps/api/test/security/provider/provider.leakage.security.ts` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D06-030 must be complete (patient CRUD and search routes).
- D06-031 must be complete (CSV import routes).
- D06-032 must be complete (merge, export, and internal API routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/patient/patient.leakage.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
