# Task D06-099: Full domain test suite — all unit + integration + security tests

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Run the complete test suite for Domain 6 Patient Registry. Do NOT write new code unless tests fail.

1. Run all unit tests:
```bash
pnpm --filter api vitest run src/domains/patient/
```

2. Run all integration tests:
```bash
pnpm --filter api vitest run test/integration/patient/
```

3. Run all security tests:
```bash
pnpm --filter api vitest run test/security/patient/
```

If any tests fail: read the failure output, diagnose the root cause, fix the source code (not the tests unless the test itself is incorrect), and re-run the failing test file.

After all individual suites pass, run the full suite one final time:
```bash
pnpm --filter api vitest run src/domains/patient/ test/integration/patient/ test/security/patient/
```

**Verify these security test files exist and are non-empty:**
- `apps/api/test/security/patient/patient.authn.security.ts`
- `apps/api/test/security/patient/patient.authz.security.ts`
- `apps/api/test/security/patient/patient.scoping.security.ts`
- `apps/api/test/security/patient/patient.input.security.ts`
- `apps/api/test/security/patient/patient.leakage.security.ts`
- `apps/api/test/security/patient/patient.audit.security.ts`

**Verify these source files exist:**
- `packages/shared/src/constants/patient.constants.ts`
- `packages/shared/src/utils/phn.utils.ts`
- `packages/shared/src/schemas/db/patient.schema.ts`
- `packages/shared/src/schemas/patient.schema.ts`
- `apps/api/src/domains/patient/patient.repository.ts`
- `apps/api/src/domains/patient/patient.service.ts`
- `apps/api/src/domains/patient/patient.routes.ts`
- `apps/api/src/domains/patient/patient.handlers.ts`

**Verify these integration test files exist:**
- `apps/api/test/integration/patient/crud.integration.ts`
- `apps/api/test/integration/patient/search.integration.ts`
- `apps/api/test/integration/patient/import.integration.ts`
- `apps/api/test/integration/patient/merge.integration.ts`
- `apps/api/test/integration/patient/export.integration.ts`
- `apps/api/test/integration/patient/internal.integration.ts`

If any file is missing, investigate which prior task failed to create it and report the issue.

## Security Requirements

- All 6 security test files must exist and pass.
- No test should be skipped or commented out.
- Security tests must not be weakened to make them pass -- fix the source code instead.

## Dependencies

- All previous Domain 6 tasks must be complete:
  - D06-040 through D06-045 (all security tests).
  - D06-030 through D06-032 (all routes and integration tests).
  - D06-020 through D06-024 (all service layer tasks).
  - D06-010 through D06-014 (all repository tasks).
  - D06-001 through D06-005 (all shared types, schemas, and migration).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/ test/integration/patient/ test/security/patient/
```

All tests must pass before outputting [TASK_COMPLETE].
