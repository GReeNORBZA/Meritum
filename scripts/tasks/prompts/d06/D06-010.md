# Task D06-010: Repository — patient CRUD operations

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/src/domains/patient/patient.repository.ts` with patient operations:

- `createPatient(data: InsertPatient)` — insert patient record. If PHN provided, validate uniqueness within physician_id.
- `findPatientById(patientId: string, physicianId: string)` — find patient scoped to physician. Return null if not found or belongs to different physician.
- `findPatientByPhn(physicianId: string, phn: string)` — exact match on (physician_id, phn). Used for duplicate check and import matching.
- `updatePatient(patientId: string, physicianId: string, data: Partial<InsertPatient>)` — update fields. Set updated_at to now(). Scoped to physician.
- `deactivatePatient(patientId: string, physicianId: string)` — set is_active = false.
- `reactivatePatient(patientId: string, physicianId: string)` — set is_active = true.
- `updateLastVisitDate(patientId: string, physicianId: string, date: Date)` — update last_visit_date. Called when a claim is created for this patient.

**CRITICAL:** All queries MUST include `physician_id = :physicianId` in the WHERE clause. No repository function should accept patient_id alone without physician_id scoping.

Use Drizzle ORM query builder with the patient schema from `packages/shared/src/schemas/db/patient.schema.ts`. Accept a Drizzle database instance via dependency injection (constructor parameter or function parameter). Follow existing repository patterns in the codebase (check `apps/api/src/domains/iam/` for reference).

Create `apps/api/src/domains/patient/patient.test.ts` with unit tests.

## Security Requirements

- Every query includes physician_id — this is the HIA custodian isolation boundary.
- findPatientById returns null (not 403) when patient belongs to different physician — prevents existence confirmation.

## Required Tests

Create tests in `apps/api/src/domains/patient/patient.test.ts`:

- createPatient inserts patient record
- createPatient rejects duplicate PHN for same physician
- createPatient allows same PHN for different physicians
- createPatient allows null PHN
- findPatientById returns patient scoped to physician
- findPatientById returns null for different physician's patient
- findPatientByPhn returns exact match
- updatePatient updates fields and updated_at
- deactivatePatient sets is_active false
- reactivatePatient sets is_active true
- updateLastVisitDate updates date

## Dependencies

- D06-005 must be complete (database migration applied, all tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
