# Task D06-014: Repository — patient export and internal API queries

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.repository.ts`:

**Export:**
- `exportActivePatients(physicianId: string)` — return all active patients for the physician as an array (for CSV generation). Select: phn, first_name, last_name, date_of_birth, gender, phone, address fields. No notes (never in export).
- `countActivePatients(physicianId: string)` — return count for export metadata.

**Internal API (consumed by Domain 4):**
- `getPatientClaimContext(patientId: string, physicianId: string)` — return minimal payload for claim creation: patient_id, phn, phn_province, first_name, last_name, date_of_birth, gender. No notes, no address, no phone.
- `validatePhnExists(physicianId: string, phn: string)` — validate PHN format (Luhn) and check if a patient with this PHN exists in the physician's registry. Return { valid: boolean, exists: boolean, patient_id?: string }.

## Security Requirements

- Export excludes notes field — notes are physician's private clinical observations, never exported.
- Internal claim context returns minimal PHI — only what's required for claim creation.
- validatePhnExists scoped to physician_id — cannot check other physicians' patient lists.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- exportActivePatients returns all active patients without notes
- exportActivePatients excludes inactive patients
- countActivePatients returns correct count
- getPatientClaimContext returns minimal claim fields
- getPatientClaimContext returns null for different physician's patient
- validatePhnExists returns valid and exists for known PHN
- validatePhnExists returns valid but not exists for unknown PHN
- validatePhnExists returns invalid for bad Luhn check

## Dependencies

- D06-005 must be complete (database migration applied, all tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
