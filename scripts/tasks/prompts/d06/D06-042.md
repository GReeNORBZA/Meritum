# Task D06-042: Security — cross-physician patient isolation (HIA custodian scoping) -- MOST CRITICAL

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/test/security/patient/patient.scoping.security.ts`.

Create two physician accounts (physician1, physician2) using createSecurityPair fixture. Create patients for each.

**Patient record isolation:**
- Physician1 cannot see physician2's patient via GET /patients/:id -> 404
- Physician1 cannot update physician2's patient via PUT /patients/:id -> 404
- Physician1 cannot deactivate physician2's patient -> 404

**Search isolation:**
- Physician1's search (by PHN, name, DOB) never returns physician2's patients
- Physician1's recent patients list never includes physician2's patients
- Same PHN exists for both physicians — search returns only the authenticated physician's patient

**Import isolation:**
- Physician1 cannot access physician2's import batch via GET /patients/imports/:id -> 404
- Patients created during import scoped to importing physician

**Merge isolation:**
- Physician1 cannot merge physician2's patients -> 404 for both preview and execute
- Cannot merge one of physician1's patients with one of physician2's patients -> 404

**Export isolation:**
- Physician1 cannot access physician2's export -> 404

**Delegate cross-context isolation:**
- Delegate linked to physician1 only cannot see physician2's patients
- Delegate linked to both: patients in physician1 context do not leak into physician2 context

**IMPORTANT:** All cross-physician access attempts return 404, not 403 (do not confirm resource existence).

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 5 (check `apps/api/test/security/provider/provider.scoping.security.ts` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D06-030 must be complete (patient CRUD and search routes).
- D06-031 must be complete (CSV import routes).
- D06-032 must be complete (merge, export, and internal API routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/patient/patient.scoping.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
