# Task D06-031: Routes — CSV import endpoints

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.routes.ts` and handlers:

**Import routes (auth required, PATIENT_IMPORT):**
- POST /api/v1/patients/imports -> uploadHandler (multipart file upload)
- GET /api/v1/patients/imports/:id/preview -> previewHandler (params: importIdParamSchema)
- PUT /api/v1/patients/imports/:id/mapping -> mappingHandler (body: importMappingSchema, params: importIdParamSchema)
- POST /api/v1/patients/imports/:id/commit -> commitHandler (params: importIdParamSchema)
- GET /api/v1/patients/imports/:id -> statusHandler (params: importIdParamSchema)

**File upload handling:** Use @fastify/multipart. Accept .csv and .txt files. Max file size: 10MB. Rate limit: 5 uploads per minute per user.

Create `apps/api/test/integration/patient/import.integration.ts`.

Use the test helpers/fixtures from the project for creating test app instances. Follow the route and handler patterns established in Domain 5 (check `apps/api/src/domains/provider/` for reference). See `CLAUDE.md` for coding conventions.

## Security Requirements

- PATIENT_IMPORT permission required for all import endpoints.
- File upload rate-limited to 5 per minute per user.
- CSV file processed in memory. Temporary storage encrypted. Deleted after import completion.
- Max file size 10MB to prevent resource exhaustion.

## Required Tests

Create tests in `apps/api/test/integration/patient/import.integration.ts`:

- POST /patients/imports uploads CSV and returns import_id
- POST /patients/imports rejects non-CSV file
- POST /patients/imports rejects file exceeding 10MB
- GET /patients/imports/:id/preview returns column mapping
- PUT /patients/imports/:id/mapping updates mapping
- POST /patients/imports/:id/commit processes all rows
- POST /patients/imports/:id/commit handles PHN duplicates correctly
- GET /patients/imports/:id returns status and counts

## Dependencies

- D06-022 must be complete (CSV bulk import service).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/patient/
```

All tests must pass before outputting [TASK_COMPLETE].
