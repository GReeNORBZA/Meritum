# Task D06-045: Security — audit trail completeness

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/test/security/patient/patient.audit.security.ts`.

Verify that each state-changing action produces an audit record with correct fields.

**Patient CRUD events:**
- Create patient -> patient.created with PHN (masked), creator, source = MANUAL
- Update patient -> patient.updated with field-level diff (PHNs masked)
- Deactivate patient -> patient.deactivated with patient_id, actor
- Reactivate patient -> patient.reactivated with patient_id, actor

**Merge events:**
- Execute merge -> patient.merged with surviving_id, merged_id, claims_transferred, field_conflicts, actor

**Import events:**
- Commit import -> patient.import_completed with import_id, file_hash, created/updated/skipped/error counts, actor

**Export events:**
- Request export -> patient.export_requested with export_id, row_count, actor

**Search audit:**
- PHN search -> patient.searched with search_type = PHN_LOOKUP, parameters (no results logged)

**Audit log integrity:**
- Audit entries are append-only (no UPDATE/DELETE from this domain)
- PHN values in audit details are always masked

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 5 (check `apps/api/test/security/provider/provider.audit.security.ts` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D06-030 must be complete (patient CRUD and search routes).
- D06-031 must be complete (CSV import routes).
- D06-032 must be complete (merge, export, and internal API routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/patient/patient.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
