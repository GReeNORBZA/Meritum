# Task D06-040: Security — authentication enforcement on every route

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/test/security/patient/patient.authn.security.ts`.

Test every authenticated route in the Patient Registry domain returns 401 without a valid session cookie:

- POST /api/v1/patients
- GET /api/v1/patients/:id
- PUT /api/v1/patients/:id
- POST /api/v1/patients/:id/deactivate
- POST /api/v1/patients/:id/reactivate
- GET /api/v1/patients/search
- GET /api/v1/patients/recent
- POST /api/v1/patients/imports
- GET /api/v1/patients/imports/:id/preview
- PUT /api/v1/patients/imports/:id/mapping
- POST /api/v1/patients/imports/:id/commit
- GET /api/v1/patients/imports/:id
- POST /api/v1/patients/merge/preview
- POST /api/v1/patients/merge/execute
- POST /api/v1/patients/exports
- GET /api/v1/patients/exports/:id

For each route: send request with no cookie, with expired cookie, and with tampered cookie. All must return 401.

**Verification for each test:**
1. Response status is 401.
2. Response body contains only an error object (e.g., `{ error: "Unauthorized" }`).
3. Response body does NOT contain any patient data or internal details.
4. No `Set-Cookie` header in 401 responses (don't create sessions for unauthenticated requests).

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference) and Domain 5 (check `apps/api/test/security/provider/` for reference). See `CLAUDE.md` for coding conventions.

## Security Requirements

- 401 responses must not contain any data beyond the error object.
- Tampered cookies must be rejected.
- Expired sessions must return 401.

## Dependencies

- D06-030 must be complete (patient CRUD and search routes).
- D06-031 must be complete (CSV import routes).
- D06-032 must be complete (merge, export, and internal API routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/patient/patient.authn.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
