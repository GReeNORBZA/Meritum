# Task D06-032: Routes — merge, export, and internal API endpoints

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.routes.ts` and handlers:

**Merge routes (auth required, PATIENT_EDIT):**
- POST /api/v1/patients/merge/preview -> mergePreviewHandler (body: mergePreviewSchema)
- POST /api/v1/patients/merge/execute -> mergeExecuteHandler (body: mergeExecuteSchema)

**Export routes (auth required, PATIENT_VIEW + REPORT_EXPORT):**
- POST /api/v1/patients/exports -> requestExportHandler
- GET /api/v1/patients/exports/:id -> exportStatusHandler (params: exportIdParamSchema)

**Internal API routes (service-to-service):**
- GET /api/v1/internal/patients/:id/claim-context -> claimContextHandler (params: internalPatientIdParamSchema)
- GET /api/v1/internal/patients/validate-phn/:phn -> validatePhnHandler (params: validatePhnParamSchema)

Internal routes require internal API key authentication (same pattern as Domain 5).

Create `apps/api/test/integration/patient/merge.integration.ts`, `export.integration.ts`, `internal.integration.ts`.

Use the test helpers/fixtures from the project for creating test app instances. Follow the route and handler patterns established in Domain 5 (check `apps/api/src/domains/provider/` for reference). See `CLAUDE.md` for coding conventions.

## Security Requirements

- Merge requires PATIENT_EDIT permission. Merge is irreversible in UI.
- Export uses authenticated, time-limited download link. Never emailed.
- Internal API routes not accessible from public API.
- Internal routes still scope data to physician_id passed as context.

## Required Tests

Create tests in `apps/api/test/integration/patient/merge.integration.ts`, `export.integration.ts`, and `internal.integration.ts`:

- POST /patients/merge/preview returns side-by-side comparison
- POST /patients/merge/preview rejects cross-physician patients
- POST /patients/merge/execute transfers claims and soft-deletes
- POST /patients/exports generates export and returns export_id
- GET /patients/exports/:id returns download URL when ready
- GET /internal/patients/:id/claim-context returns minimal context
- GET /internal/patients/:id/claim-context returns 404 for unknown patient
- GET /internal/patients/validate-phn/:phn validates format and existence
- Internal routes reject requests without internal API key

## Dependencies

- D06-023 must be complete (patient merge service).
- D06-024 must be complete (patient export and internal API service).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/patient/
```

All tests must pass before outputting [TASK_COMPLETE].
