# Task D06-011: Repository — patient search (PHN, name with pg_trgm, DOB, combined, recent)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.repository.ts`:

- `searchByPhn(physicianId: string, phn: string)` — exact match on (physician_id, phn) where is_active = true. Returns 0 or 1 result.
- `searchByName(physicianId: string, nameQuery: string, page: number, pageSize: number)` — case-insensitive prefix match using pg_trgm similarity on (first_name, last_name). Minimum 2 characters. Ranked by similarity score. Only active patients. Paginated.
- `searchByDob(physicianId: string, dob: Date, page: number, pageSize: number)` — exact match on date_of_birth. Only active patients. Paginated.
- `searchCombined(physicianId: string, filters: { phn?: string, name?: string, dob?: Date }, page: number, pageSize: number)` — AND all provided criteria. Only active patients. Paginated.
- `getRecentPatients(physicianId: string, limit: number)` — return patients ordered by last_visit_date DESC, limited to `limit` (default 20). Only active patients with a non-null last_visit_date.

**pg_trgm usage:** Use `similarity()` or `ILIKE` with the GIN trigram index for name search. The query should be: `WHERE physician_id = :id AND is_active = true AND (first_name ILIKE :pattern OR last_name ILIKE :pattern) ORDER BY similarity(last_name || ' ' || first_name, :nameQuery) DESC`.

All search functions are scoped to physician_id and return only active patients.

## Security Requirements

- All search queries include physician_id — no cross-physician patient results.
- Deactivated patients excluded from all search results.
- Name search minimum 2 characters prevents overly broad queries.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- searchByPhn returns exact match for physician's patient
- searchByPhn returns empty for different physician
- searchByName returns case-insensitive prefix matches
- searchByName ranks results by similarity
- searchByName requires minimum 2 characters
- searchByName excludes inactive patients
- searchByDob returns matching patients
- searchCombined ANDs all criteria
- getRecentPatients returns ordered by last_visit_date DESC
- getRecentPatients respects limit
- getRecentPatients excludes patients with null last_visit_date

## Dependencies

- D06-005 must be complete (database migration applied, all tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
