# Task D06-013: Repository — patient merge operations

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.repository.ts`:

- `getMergePreview(physicianId: string, survivingId: string, mergedId: string)` — return side-by-side comparison of both patient records plus count of claims that would be transferred. Both patients must belong to the physician.
- `executeMerge(physicianId: string, survivingId: string, mergedId: string, mergedBy: string)` — in a single transaction:
  1. Transfer draft/validated claims from merged patient to surviving patient (UPDATE claims SET patient_id = survivingId WHERE patient_id = mergedId AND status IN ('draft','validated')).
  2. Soft-delete the merged patient (is_active = false).
  3. Record in patient_merge_history: surviving_patient_id, merged_patient_id, claims_transferred count, field_conflicts JSONB.
  4. Return merge_id and counts.
- `listMergeHistory(physicianId: string, page: number, pageSize: number)` — list merge history for physician, newest first.

**Critical merge rules:**
- Only draft/validated claims have patient_id updated. Submitted/assessed/paid claims retain original patient_id (audit integrity).
- Surviving record's values are kept for all conflicting fields.
- Merge is irreversible in the application (history preserved for admin recovery).

## Security Requirements

- Both patients must belong to the same physician — cross-physician merge is impossible.
- Submitted claims retain original patient_id for audit trail integrity.
- Merge runs in a single transaction — no partial state.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- getMergePreview returns side-by-side comparison
- getMergePreview returns correct claim transfer count
- getMergePreview rejects if either patient belongs to different physician
- executeMerge transfers draft/validated claims to surviving patient
- executeMerge does NOT transfer submitted/assessed claims
- executeMerge soft-deletes merged patient
- executeMerge records merge history with field conflicts
- executeMerge runs in single transaction (rollback on failure)

## Dependencies

- D06-005 must be complete (database migration applied, all tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
