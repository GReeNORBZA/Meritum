# Task D06-023: Service — patient merge workflow

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.service.ts`:

- `getMergePreview(physicianId: string, survivingId: string, mergedId: string)` — verify both patients belong to physician and are active. Return side-by-side comparison highlighting field differences and claim transfer count (draft/validated claims only).

- `executeMerge(physicianId: string, survivingId: string, mergedId: string, actorId: string)` — delegate to repository executeMerge (transactional). Emit patient.merged audit event with: surviving_patient_id, merged_patient_id, claims_transferred count, field_conflicts, actor. Return merge_id.

- `getMergeHistory(physicianId: string, page: number, pageSize: number)` — return paginated merge history for the physician.

**Merge rules enforced:**
- Both patients must belong to the same physician.
- Both patients must be active (cannot merge already-deactivated patient).
- Surviving record's field values are kept for all conflicts.
- Only draft/validated claims transferred. Submitted claims retain original patient_id.

## FRD References

- Domain 6 Section 6.1-6.2: Merge workflow and merge rules.
- Domain 6 Section 10.4: Merge test requirements.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- getMergePreview returns side-by-side comparison with field diffs
- getMergePreview returns correct claim count (draft/validated only)
- getMergePreview rejects if patient belongs to different physician
- getMergePreview rejects if either patient is inactive
- executeMerge transfers claims and soft-deletes merged patient
- executeMerge emits audit event with full merge details
- executeMerge records in merge history
- getMergeHistory returns paginated results

## Dependencies

- D06-013 must be complete (patient merge repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
