# Task D06-012: Repository — CSV import batch operations

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.repository.ts`:

- `createImportBatch(data: InsertImportBatch)` — insert import batch record with PENDING status.
- `findImportBatchById(importId: string, physicianId: string)` — find import batch scoped to physician.
- `findImportByFileHash(physicianId: string, fileHash: string)` — check for duplicate file upload by SHA-256 hash.
- `updateImportStatus(importId: string, status: string, counts?: { created, updated, skipped, error }, errorDetails?: any)` — update status and result counts.
- `listImportBatches(physicianId: string, page: number, pageSize: number)` — list imports for physician, newest first.
- `bulkCreatePatients(physicianId: string, patients: InsertPatient[])` — batch insert multiple patients in a single transaction. Return array of created patient_ids.
- `bulkUpsertPatients(physicianId: string, patients: { phn: string, data: Partial<InsertPatient> }[])` — for rows with PHN match: update. For rows without match: insert. Return counts.

## Security Requirements

- Import batches scoped to physician_id.
- bulkCreatePatients and bulkUpsertPatients must all run within a transaction — partial imports are not acceptable.
- CSV file content is processed in memory; the uploaded file is stored temporarily and deleted after import.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- createImportBatch inserts with PENDING status
- findImportByFileHash detects duplicate file upload
- updateImportStatus updates status and counts
- bulkCreatePatients inserts all patients in transaction
- bulkCreatePatients rolls back on failure
- bulkUpsertPatients creates new and updates existing by PHN match
- listImportBatches returns newest first for physician

## Dependencies

- D06-005 must be complete (database migration applied, all tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
