# Task D06-021: Service — patient search orchestration

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.service.ts`:

- `searchPatients(physicianId: string, query: PatientSearchInput, actorId: string)` — orchestrate search based on provided criteria:
  1. If phn provided: exact PHN lookup.
  2. If name provided (no phn): trigram name search.
  3. If dob provided (no phn, no name): DOB search.
  4. If multiple criteria: combined search with AND logic.
  5. Return paginated results with total count.
  Emit patient.searched audit event with search parameters (NOT results). Rate-limit PHN searches to prevent enumeration.

- `getRecentPatients(physicianId: string, limit: number)` — delegate to repository. Return recent patients. No audit log for this (it's a default view, not an active search).

**Search result format:** Return { patients: SelectPatient[], total: number, page: number, page_size: number }.

## FRD References

- Domain 6 Section 4.1: 5 search modes — PHN lookup, name search, DOB search, combined, recent patients.
- Domain 6 Section 4.2: All searches scoped to physician. Never returns other physicians' patients.
- Domain 6 Section 4.3: Expected 500-20,000 patients per physician. pg_trgm for name search.

## Security Requirements

- PHN search logged for PHI access audit — rate-limited to prevent enumeration.
- Search results scoped to physician — enforced at repository layer.
- Search audit logs parameters only, never result contents.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- searchPatients routes to PHN lookup when phn provided
- searchPatients routes to name search when name provided
- searchPatients routes to DOB search when dob provided
- searchPatients combines criteria with AND logic
- searchPatients returns paginated results with total count
- searchPatients emits audit event with search parameters
- getRecentPatients returns ordered list
- getRecentPatients does not emit audit event

## Dependencies

- D06-011 must be complete (patient search repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
