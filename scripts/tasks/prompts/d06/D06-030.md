# Task D06-030: Routes — patient CRUD and search endpoints

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/src/domains/patient/patient.routes.ts` and `apps/api/src/domains/patient/patient.handlers.ts`.

**Patient CRUD routes (auth required):**
- POST /api/v1/patients -> createPatientHandler (body: createPatientSchema, requires PATIENT_CREATE)
- GET /api/v1/patients/:id -> getPatientHandler (params: patientIdParamSchema, requires PATIENT_VIEW)
- PUT /api/v1/patients/:id -> updatePatientHandler (body: updatePatientSchema, params: patientIdParamSchema, requires PATIENT_EDIT)
- POST /api/v1/patients/:id/deactivate -> deactivateHandler (params: patientIdParamSchema, requires PATIENT_EDIT)
- POST /api/v1/patients/:id/reactivate -> reactivateHandler (params: patientIdParamSchema, requires PATIENT_EDIT)

**Patient search routes (auth required, PATIENT_VIEW):**
- GET /api/v1/patients/search -> searchHandler (query: patientSearchQuerySchema)
- GET /api/v1/patients/recent -> recentHandler (query: recentPatientsQuerySchema)

**Handlers extract physician_id from auth context (physician's own ID or delegate's active physician context).**

Create `apps/api/test/integration/patient/crud.integration.ts` and `search.integration.ts`.

Use the test helpers/fixtures from the project for creating test app instances. Follow the route and handler patterns established in Domain 5 (check `apps/api/src/domains/provider/` for reference). See `CLAUDE.md` for coding conventions.

## Security Requirements

- All patient routes derive physician_id from auth context — never from URL parameter.
- PATIENT_CREATE, PATIENT_VIEW, PATIENT_EDIT permissions enforced via Domain 1 RBAC middleware.
- PHN search rate-limited to prevent enumeration.

## Required Tests

Create tests in `apps/api/test/integration/patient/crud.integration.ts` and `search.integration.ts`:

- POST /patients creates patient with valid PHN
- POST /patients rejects invalid Luhn PHN with 400
- POST /patients rejects duplicate PHN with 409
- GET /patients/:id returns patient for physician
- GET /patients/:id returns 404 for other physician's patient
- PUT /patients/:id updates demographics
- POST /patients/:id/deactivate soft-deletes
- POST /patients/:id/reactivate restores
- GET /patients/search?phn=123456789 returns exact match
- GET /patients/search?name=Sm returns name prefix results
- GET /patients/recent returns last 20 by visit date

## Dependencies

- D06-020 must be complete (patient CRUD service).
- D06-021 must be complete (patient search service).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/patient/
```

All tests must pass before outputting [TASK_COMPLETE].
