# Task D06-005: Generate and apply database migration for all patient tables

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Run the Drizzle migration generator for Patient Registry tables:

```bash
cd apps/api
pnpm drizzle-kit generate
pnpm drizzle-kit migrate
```

Before running migrations, ensure the pg_trgm extension is enabled:
```sql
CREATE EXTENSION IF NOT EXISTS pg_trgm;
```

Add this extension creation to the migration if Drizzle doesn't handle it automatically.

Verify that the migration file was created in `apps/api/drizzle/migrations/`.
Verify that all 3 tables exist: patients, patient_import_batches, patient_merge_history.
Verify all indexes including the partial unique index on (physician_id, phn) WHERE phn IS NOT NULL.
Verify the pg_trgm GIN index on (last_name, first_name) exists.
Verify FK from patients.physician_id → providers.provider_id.

## Dependencies

- D06-002 must be complete (patients table schema).
- D06-003 must be complete (import batches and merge history schemas).

## Run After Completion

```bash
cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1
```

All tests must pass before outputting [TASK_COMPLETE].
