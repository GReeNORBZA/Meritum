# Task D06-002: Drizzle schema for patients table

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `packages/shared/src/schemas/db/patient.schema.ts` starting with the patients table.

**patients table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| patient_id | UUID | PK | Default: gen_random_uuid() |
| physician_id | UUID FK | NOT NULL, FK → providers | HIA custodian. Scopes all access |
| phn | VARCHAR(9) | NULLABLE | Alberta PHN. 9 digits. Null for newborns, out-of-province (use phn_province), WCB no-PHN |
| phn_province | VARCHAR(2) | NULLABLE, DEFAULT 'AB' | Province of PHN issuance. Set for out-of-province reciprocal billing |
| first_name | VARCHAR(50) | NOT NULL | Patient first name |
| middle_name | VARCHAR(50) | NULLABLE | Patient middle name |
| last_name | VARCHAR(50) | NOT NULL | Patient last name |
| date_of_birth | DATE | NOT NULL | Required for age-based fee calcs and WCB forms |
| gender | VARCHAR(1) | NOT NULL | M, F, or X |
| phone | VARCHAR(24) | NULLABLE | Primary phone number |
| email | VARCHAR(100) | NULLABLE | Email address (not used in claim submission) |
| address_line_1 | VARCHAR(100) | NULLABLE | Mailing address |
| address_line_2 | VARCHAR(100) | NULLABLE | |
| city | VARCHAR(50) | NULLABLE | |
| province | VARCHAR(2) | NULLABLE | |
| postal_code | VARCHAR(7) | NULLABLE | |
| notes | TEXT | NULLABLE | Physician's private notes. Not transmitted in claims. Encrypted at rest |
| is_active | BOOLEAN | NOT NULL, DEFAULT true | Active patients appear in search |
| last_visit_date | DATE | NULLABLE | Updated when claims are created. Drives recent patients list |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |
| created_by | UUID FK | NOT NULL | Creator (physician or delegate) |

**Indexes:**
- UNIQUE on (physician_id, phn) WHERE phn IS NOT NULL — partial unique index
- (physician_id, last_name, first_name) — name search
- (physician_id, date_of_birth) — DOB search
- (physician_id, last_visit_date DESC) — recent patients
- (physician_id, is_active) — active filter

**pg_trgm index:** Create GIN trigram index on (last_name, first_name) for efficient prefix/fuzzy name matching.
Note: pg_trgm extension must be enabled: `CREATE EXTENSION IF NOT EXISTS pg_trgm;`

Export the table and its inferred types (InsertPatient, SelectPatient).

## FRD References

- Domain 6 Section 2.1: Patients table. One row per patient per physician. Physician-scoped. PHN unique per physician (partial unique index). pg_trgm for name search.

## Security Requirements

- Patient records are PHI — encrypted at rest (AES-256) and in transit (TLS 1.3).
- physician_id is the tenant isolation key. All queries MUST include physician_id in WHERE clause.
- notes field may contain sensitive clinical observations — encrypted at rest, never transmitted in claims.
- Partial unique index on (physician_id, phn) WHERE phn IS NOT NULL allows multiple null-PHN patients per physician.

## Dependencies

- D06-001 must be complete (patient constants and enums).

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
