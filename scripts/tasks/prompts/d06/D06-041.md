# Task D06-041: Security — authorization and role enforcement

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/test/security/patient/patient.authz.security.ts`.

Test delegate permission enforcement:

**Delegate with PATIENT_VIEW only:**
- GET /patients/:id -> 200 (allowed)
- GET /patients/search -> 200 (allowed)
- POST /patients -> 403 (requires PATIENT_CREATE)
- PUT /patients/:id -> 403 (requires PATIENT_EDIT)
- POST /patients/imports -> 403 (requires PATIENT_IMPORT)
- POST /patients/merge/execute -> 403 (requires PATIENT_EDIT)

**Delegate with PATIENT_CREATE only:**
- POST /patients -> 200 (allowed)
- PUT /patients/:id -> 403 (requires PATIENT_EDIT)

**Delegate with no patient permissions:**
- All patient routes -> 403

**Internal API access control:**
- GET /internal/patients/:id/claim-context without internal API key -> 401 or 403
- Regular user session cannot access internal routes

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 5 (check `apps/api/test/security/provider/` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D06-030 must be complete (patient CRUD and search routes).
- D06-031 must be complete (CSV import routes).
- D06-032 must be complete (merge, export, and internal API routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/patient/patient.authz.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
