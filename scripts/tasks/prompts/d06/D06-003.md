# Task D06-003: Drizzle schema for patient_import_batches and patient_merge_history tables

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `packages/shared/src/schemas/db/patient.schema.ts`:

**patient_import_batches table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| import_id | UUID | PK | Default: gen_random_uuid() |
| physician_id | UUID FK | NOT NULL, FK → providers | |
| file_name | VARCHAR(255) | NOT NULL | Original uploaded filename |
| file_hash | VARCHAR(64) | NOT NULL | SHA-256 hash for deduplication |
| total_rows | INTEGER | NOT NULL, DEFAULT 0 | Total rows in import file |
| created_count | INTEGER | NOT NULL, DEFAULT 0 | New patient records created |
| updated_count | INTEGER | NOT NULL, DEFAULT 0 | Existing records updated (matched by PHN) |
| skipped_count | INTEGER | NOT NULL, DEFAULT 0 | Rows skipped (duplicate PHN in file, no changes) |
| error_count | INTEGER | NOT NULL, DEFAULT 0 | Rows that failed validation |
| error_details | JSONB | NULLABLE | Per-row error details: [{row, field, error}] |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'PENDING' | PENDING, PROCESSING, COMPLETED, FAILED |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |
| created_by | UUID FK | NOT NULL | |

Indexes: (physician_id, created_at DESC), (physician_id, file_hash).

**patient_merge_history table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| merge_id | UUID | PK | Default: gen_random_uuid() |
| physician_id | UUID FK | NOT NULL, FK → providers | |
| surviving_patient_id | UUID FK | NOT NULL, FK → patients | The record that remains |
| merged_patient_id | UUID FK | NOT NULL, FK → patients | The record absorbed (soft-deleted after merge) |
| claims_transferred | INTEGER | NOT NULL | Number of claims re-linked |
| field_conflicts | JSONB | NULLABLE | Fields where records differed. Surviving values kept |
| merged_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |
| merged_by | UUID FK | NOT NULL | Who performed the merge |

Indexes: (physician_id, merged_at DESC), (surviving_patient_id), (merged_patient_id).

Export tables and inferred types.

## FRD References

- Domain 6 Section 2.2: Patient Import Batches table. Tracks CSV imports with row-level result counts and error details.
- Domain 6 Section 2.3: Patient Merge History table. Records merge operations with claim transfer count and field conflicts.

## Dependencies

- D06-002 must be complete (patients table schema).

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
