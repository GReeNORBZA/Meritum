# Task D06-020: Service — patient CRUD with PHN validation and audit logging

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Create `apps/api/src/domains/patient/patient.service.ts` with patient CRUD functions:

- `createPatient(physicianId: string, data: CreatePatientInput, actorId: string)` — if PHN provided: validate Alberta format (9 digits + Luhn check), check uniqueness within physician's patients. Create record. Emit patient.created audit event with PHN (masked), actor, source = MANUAL.
- `getPatient(patientId: string, physicianId: string)` — return patient record. Return null if not found/wrong physician.
- `updatePatient(patientId: string, physicianId: string, data: UpdatePatientInput, actorId: string)` — if PHN changed: re-validate Luhn, re-check uniqueness. Update record. Emit patient.updated audit event with field-level diff (old vs new, PHNs masked).
- `deactivatePatient(patientId: string, physicianId: string, actorId: string)` — soft-delete. Emit patient.deactivated audit event. Existing claims unaffected.
- `reactivatePatient(patientId: string, physicianId: string, actorId: string)` — reactivate. Emit patient.reactivated.

**PHN validation rules:**
1. If phn provided and phn_province = 'AB': validate 9-digit Luhn.
2. If phn provided and phn_province != 'AB': accept any 9-12 digit numeric (out-of-province reciprocal).
3. If phn is null: accept (newborns, uninsured, WCB no-PHN scenarios).
4. If phn provided: check unique within physician's active patients.

Import repository functions from `patient.repository.ts`. Import audit action identifiers from `packages/shared/src/constants/patient.constants.ts`. Import PHN utilities from `packages/shared/src/utils/phn.utils.ts`. Follow existing service patterns in the codebase (check `apps/api/src/domains/iam/` or `apps/api/src/domains/provider/` for reference). See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 6 Section 3.1-3.2: PHN validation (Luhn) and PHN-optional scenarios (newborns, out-of-province, WCB, uninsured).
- Domain 6 Section 7 PAT-001, PAT-006, PAT-008: CRUD user stories.

## Security Requirements

- PHN is masked in all audit log entries — first 3 digits shown, remaining 6 asterisks.
- PHN changes are logged with both old (masked) and new (masked) values.
- Patient notes are never included in audit log detail payloads.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- createPatient with valid Alberta PHN succeeds
- createPatient rejects invalid Luhn check digit
- createPatient rejects 8-digit PHN
- createPatient rejects non-numeric PHN
- createPatient rejects duplicate PHN for same physician
- createPatient allows same PHN for different physicians
- createPatient allows null PHN
- createPatient with out-of-province PHN skips Luhn check
- createPatient emits audit event with masked PHN
- updatePatient re-validates PHN on change
- updatePatient emits audit with field-level diff
- deactivatePatient soft-deletes patient
- reactivatePatient restores patient

## Dependencies

- D06-010 must be complete (patient CRUD repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
