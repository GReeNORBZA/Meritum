# Task D06-024: Service — patient export and internal API

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- PHN is PHI — mask as 123****** in all logs and audit entries

## What to Build

Add to `apps/api/src/domains/patient/patient.service.ts`:

**Export:**
- `requestExport(physicianId: string, actorId: string)` — generate CSV of all active patients (phn, first_name, last_name, date_of_birth, gender, phone, address fields — NO notes). Store as temporary file in DigitalOcean Spaces with time-limited (1 hour) authenticated download URL. Emit patient.export_requested audit event with row count. Return { export_id, row_count, status: 'PROCESSING' }.
- `getExportStatus(exportId: string, physicianId: string)` — return export status and download URL (if ready). Emit patient.export_downloaded when URL is first accessed.

**Internal API (consumed by Domain 4):**
- `getPatientClaimContext(patientId: string, physicianId: string)` — return minimal claim context: patient_id, phn, phn_province, first_name, last_name, date_of_birth, gender.
- `validatePhn(physicianId: string, phn: string)` — validate PHN format (Luhn if AB) and check existence in physician's registry. Return { valid, format_ok, exists, patient_id? }.

## FRD References

- Domain 6 Section 8.5: Patient export — CSV via authenticated, time-limited download link. Not emailed.
- Domain 6 Section 8.6: Internal patient API for claim lifecycle.

## Security Requirements

- Export files delivered via authenticated, time-limited download link (1 hour). NOT emailed.
- Export excludes notes field — never in export.
- Internal API returns minimal PHI needed for claim creation.
- Download URL is one-time use or time-limited for security.

## Required Tests

Add tests in `apps/api/src/domains/patient/patient.test.ts`:

- requestExport generates CSV without notes field
- requestExport emits audit event with row count
- getExportStatus returns download URL when ready
- getPatientClaimContext returns minimal claim fields
- getPatientClaimContext returns null for wrong physician
- validatePhn returns valid for correct Luhn
- validatePhn returns exists for known patient
- validatePhn returns not exists for unknown PHN

## Dependencies

- D06-014 must be complete (patient export and internal API repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/patient/patient.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
