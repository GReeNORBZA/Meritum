# D04W-026: Service: WCB return file parsing, claim matching, and state transitions

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add return file processing to WCB service:

- `processReturnFile(physicianId: string, fileContent: string)` — parse and process WCB return file:
  1. Parse tab-delimited text file:
     - Batch header: BatchID, ReportCount, SubmitterID, SubmitDate.
     - Per-report block: ReportTxnID, SubmitterTxnID, ProcessedClaim#, ClaimDecision, ReportStatus, TxnSubmissionDate.
     - For Complete reports: per-invoice-line rows (InvoiceSequence#, ServiceDate, HSC, InvoiceStatus).
     - For Invalid reports: error rows (ErrorNumber: ErrorDescription).
  2. Match batch via BatchID -> wcb_batches.batch_control_id.
  3. For each report:
     a. Match to claim via SubmitterTxnID -> wcb_claim_details.submitter_txn_id.
     b. Store in wcb_return_records.
     c. If Complete: store invoice lines in wcb_return_invoice_lines. Transition claim to 'assessed' (Domain 4.0 state machine).
     d. If Invalid: parse error format 'error_code: message'. Store errors JSONB. Map to Meritum fields. Transition claim to 'rejected'.
     e. If ProcessedClaim# provided and claim has no wcb_claim_number: store it.
  4. Emit notifications: WCB_RETURN_RECEIVED, WCB_CLAIM_ACCEPTED (per claim), WCB_CLAIM_REJECTED (per claim).
  5. Update batch: RETURN_RECEIVED. If all reports processed -> RECONCILED.
  6. Emit audit: wcb.return_processed.

  Handle unmatched SubmitterTxnIDs gracefully: store with wcb_claim_detail_id = null, emit WCB_RETURN_UNMATCHED alert.

  Return: { matched_count, complete_count, invalid_count, unmatched_count, errors: [] }.

## FRD References
- Domain 4.2 Section 6: Return file format (tab-delimited, two sections per report), ingestion workflow (8 steps), error handling (error_code:message format, mapped_field, correction guidance).

## Dependencies
This task depends on: D04W-014, D04W-020

## Tests
- processReturnFile parses valid return file
- processReturnFile matches batch by BatchID
- processReturnFile matches reports by SubmitterTxnID
- Complete report transitions claim to assessed
- Invalid report transitions claim to rejected with errors
- ProcessedClaim# stored on claim when provided
- Unmatched SubmitterTxnID stored with null claim reference
- Mixed Complete and Invalid handled independently
- Notifications emitted for each outcome
- Batch status updated to RETURN_RECEIVED

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
