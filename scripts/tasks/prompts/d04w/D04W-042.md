# D04W-042: Security: cross-physician tenant isolation (MOST CRITICAL)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/test/security/wcb/wcb.scoping.security.ts`.

Create two physicians (physician1, physician2) using createSecurityPair fixture.

**Claim isolation:**
- Physician1 creates WCB claim -> physician2 GET /wcb/claims/:id -> 404 (not 403)
- Physician1 creates WCB claim -> physician2 PUT /wcb/claims/:id -> 404
- Physician1 creates WCB claim -> physician2 DELETE /wcb/claims/:id -> 404
- Physician1's claim list does not include physician2's claims

**Batch isolation:**
- Physician1 creates batch -> physician2 GET /wcb/batches/:id -> 404
- Physician1's batch -> physician2 cannot download XML
- Physician1's batch -> physician2 cannot confirm upload
- Physician1 batch list does not include physician2's batches

**Return/remittance isolation:**
- Physician2 cannot access physician1's return results
- Physician2 cannot access physician1's remittance discrepancies

**Child record isolation:**
- Physician2 cannot access physician1's claim attachments

**Delegate cross-context isolation:**
- Delegate linked to physician1 only -> cannot access physician2's WCB claims
- Delegate linked to both -> physician1 context shows only physician1's data

**Important:** All cross-physician access attempts return 404, not 403 (do not confirm resource existence).

## Dependencies
This task depends on: D04W-030, D04W-031

## Security Requirements
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
No specific unit tests for this task — verified by build/migration command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/wcb/wcb.scoping.security.ts
```
Fix any errors before finishing.
