# D04W-030: Routes and handlers for WCB claim CRUD + validation + form schema endpoints

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/src/domains/wcb/wcb.routes.ts` and `wcb.handlers.ts`:

Register under `/api/v1/wcb/` prefix. All routes require authentication (session cookie). All routes are physician-scoped.

**Claim CRUD routes:**
- POST /api/v1/wcb/claims — Create WCB claim. Body validated with wcbClaimCreateSchema. Permission: CLAIM_CREATE.
- GET /api/v1/wcb/claims/:id — Retrieve claim + all child records. Permission: CLAIM_VIEW.
- PUT /api/v1/wcb/claims/:id — Update claim (partial). Permission: CLAIM_EDIT.
- DELETE /api/v1/wcb/claims/:id — Soft delete (draft only). Permission: CLAIM_DELETE.
- POST /api/v1/wcb/claims/:id/validate — Run validation pipeline, return results. Permission: CLAIM_VIEW.
- GET /api/v1/wcb/claims/:id/form-schema — Return form field schema for form_id. Permission: CLAIM_VIEW.

**Handler pattern:** Thin handlers that extract params, call service, format response. Consistent error formatting.

**Delegate support:** Delegates with appropriate permissions can access these routes. The physician context (from Domain 1 delegate context switch) determines scoping.

## Dependencies
This task depends on: D04W-020, D04W-021

## Security Requirements
- All routes require session cookie and permission checks per Domain 1 RBAC.
- UUID params validated with Zod before service call.
- Responses must not leak cross-physician data — service layer enforces scoping.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- POST /wcb/claims creates claim and returns IDs
- GET /wcb/claims/:id returns claim with child records
- PUT /wcb/claims/:id updates claim
- DELETE /wcb/claims/:id soft-deletes draft claim
- DELETE /wcb/claims/:id returns 400 for non-draft
- POST /wcb/claims/:id/validate returns validation results
- GET /wcb/claims/:id/form-schema returns schema

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
