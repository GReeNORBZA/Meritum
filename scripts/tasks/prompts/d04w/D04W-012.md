# D04W-012: Repository: invoice line and attachment operations

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add to `apps/api/src/domains/wcb/wcb.repository.ts`:

**Invoice Lines:**
- `upsertInvoiceLines(wcbClaimDetailId: string, lines: InvoiceLineInput[])` — delete and replace. Enforce sequential invoice_detail_id. Max 25 lines.
- `getInvoiceLines(wcbClaimDetailId: string)` — return ordered by invoice_detail_id.
- `validateC570Pairing(wcbClaimDetailId: string)` — verify every WAS line has exactly one SHOULD_BE pair with matching invoice_detail_id. Return validation result.

**Attachments:**
- `upsertAttachments(wcbClaimDetailId: string, attachments: AttachmentInput[])` — delete and replace. Max 3.
- `getAttachments(wcbClaimDetailId: string)` — return ordered by ordinal.
- `getAttachmentContent(wcbAttachmentId: string, physicianId: string)` — return single attachment with content. Scoped to physician.

Note: file_content_b64 can be large. getWcbClaim (D04W-010) should NOT include file_content_b64 in the default join — only ordinal, file_name, file_type, file_description, file_size_bytes. Full content fetched separately.

## Dependencies
This task depends on: D04W-009

## Security Requirements
- Invoice line upsert must validate sequential numbering — no gaps in invoice_detail_id.
- C570 Was/Should Be pairing is a hard business rule. The repository provides a validation helper; the service layer enforces it.
- Attachment content is PHI — only served via getAttachmentContent with physician scoping.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- upsertInvoiceLines inserts sequential lines
- upsertInvoiceLines enforces max 25
- upsertInvoiceLines replaces existing lines in transaction
- validateC570Pairing returns valid for correct pairing
- validateC570Pairing returns errors for missing pair
- upsertAttachments inserts up to 3
- upsertAttachments enforces max 3
- getAttachmentContent scoped to physician

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
