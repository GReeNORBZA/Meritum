# D04W-021: Service: WCB validation engine — required fields, conditional logic, data type/length checks

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add to `apps/api/src/domains/wcb/wcb.service.ts` (or create `wcb.validation.ts`):

- `validateWcbClaim(wcbClaimDetailId: string, physicianId: string)` — run full 16-check WCB validation pipeline:

  **Error checks (blocking):**
  1. Form ID valid (one of 8 types)
  2. Contract ID / Role / Form ID permitted (per matrix)
  3. Required fields present (form-type-specific 'Always Required' fields)
  4. Conditional field logic (trigger field -> dependent fields cascade)
  5. Data type / length enforcement per field spec
  6. Date validation (valid dates, exam >= injury, completion >= exam)
  7. POB-NOI combination check (382 exclusion matrix)
  8. Side of Body required check (per POB flag)
  9. Code table value validation (all coded fields against reference tables)
  10. Submitter txn ID format (prefix + length + uniqueness)
  11. PHN logic (no_phn_flag = N -> 9-digit PHN required; Y -> blank)
  12. Invoice line integrity (at least 1 line, sequential, form-specific fields)

  **Warning checks (flagging):**
  13. Attachment constraints (max 3, valid file types)
  14. Timing deadline (tier calculation and warning)
  15. Expedite eligibility (Category/Type permits expedite)
  16. Duplicate detection (same patient + date of injury + form type)

  Return: { errors: ValidationIssue[], warnings: ValidationIssue[], passed: boolean, timing_tier, validation_timestamp, reference_data_version }.

**Conditional field engine:** Implement the trigger -> dependent field map. Key chains:
- narcotics_prescribed = Y -> prescriptions required; on C151/S -> 16 opioid + pain estimates
- missed_work = Y -> returned_to_work required -> cascade to hours/duties/restrictions
- patient_no_phn_flag = N -> patient_phn required (9 digits)
- prior_conditions_flag = Y -> prior_conditions_desc required
- diagnosis_changed = Y -> diagnosis_changed_desc required
- consultation_letter_format = TEXT -> letter_text required; ATTCH -> attachment required
- OIS: grasp_X_level = LIMITED -> sub-fields; environment_restricted = Y -> 7 env fields

## FRD References
- Domain 4.2 Section 4.1: 16-check validation pipeline with severity levels. Section 4.2: Conditional field optionality engine with trigger chains.

## Dependencies
This task depends on: D04W-020

## Tests
- validateWcbClaim passes for valid C050E with all required fields
- validateWcbClaim error for missing required field
- validateWcbClaim enforces conditional: narcotics=Y but no prescriptions -> error
- validateWcbClaim enforces conditional: missed_work=Y -> returned_to_work required
- validateWcbClaim enforces PHN logic: no_phn_flag=N, missing PHN -> error
- validateWcbClaim enforces data type: alphabetic field with numbers -> error
- validateWcbClaim enforces max length
- validateWcbClaim enforces date ordering: exam < injury -> error
- validateWcbClaim returns timing tier as warning

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
