# D04W-034: Integration tests: batch XML generation, XSD validation, return file and remittance processing

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/test/integration/wcb/wcb-pipeline.integration.ts`:

**XML Generation:**
- Generate XML for each form type -> validate structure against expected HL7 segments
- Batch with multiple reports (mixed form types) -> correct segment ordering
- XML element ordering matches XSD requirements
- Special character encoding (&, <, >, ") in free-text fields
- Base64 encoding of file attachments in OBX segments
- Batch with and without attachments
- Header values: FHS/BHS/MSH contain correct vendor credentials

**XSD Validation:**
- Valid XML passes both XSD schemas
- XML with missing required element fails structural XSD
- XML with invalid data format fails validation XSD
- Failed validation stores errors in xsd_validation_errors

**Return File Processing:**
- Parse successful return file: all claims matched, states -> assessed
- Parse error return file: errors extracted, claims -> rejected
- Unmatched SubmitterTxnID: graceful handling, alert emitted
- Mixed Complete/Invalid: each handled independently
- WCB claim number stored when provided

**Remittance Processing:**
- Parse remittance XML: all records stored
- Match via ElectronicReportTransactionID chain
- Detect payment discrepancy
- Handle all 7 payment status codes
- Overpayment recovery tracked

## Dependencies
This task depends on: D04W-031

## Tests
No specific unit tests for this task — verified by build/migration command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/integration/wcb/
```
Fix any errors before finishing.
