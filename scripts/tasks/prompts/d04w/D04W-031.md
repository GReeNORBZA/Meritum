# D04W-031: Routes and handlers for WCB batch management, return file, remittance, and MVP endpoints

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add to `apps/api/src/domains/wcb/wcb.routes.ts`:

**Batch Management routes:**
- POST /api/v1/wcb/batches — Initiate batch generation. Permission: BATCH_APPROVE.
- GET /api/v1/wcb/batches/:id — Retrieve batch details. Permission: BATCH_VIEW.
- GET /api/v1/wcb/batches/:id/download — Download XML (signed URL). Permission: BATCH_VIEW + WCB_BATCH_UPLOAD.
- POST /api/v1/wcb/batches/:id/confirm-upload — Confirm portal upload. Permission: WCB_BATCH_UPLOAD.
- GET /api/v1/wcb/batches — List batches with filtering. Permission: BATCH_VIEW.

**Return File routes:**
- POST /api/v1/wcb/returns/upload — Upload return file (multipart). Permission: BATCH_VIEW.
- GET /api/v1/wcb/returns/:batch_id — Get return results for batch. Permission: BATCH_VIEW.

**Remittance routes:**
- POST /api/v1/wcb/remittances/upload — Upload remittance XML (multipart). Permission: REPORT_VIEW.
- GET /api/v1/wcb/remittances — List remittance imports. Permission: REPORT_VIEW.
- GET /api/v1/wcb/remittances/:id/discrepancies — Get discrepancies. Permission: REPORT_VIEW.

**MVP routes (feature-flagged):**
- GET /api/v1/wcb/claims/:id/export — Generate pre-filled export. Permission: CLAIM_VIEW.
- POST /api/v1/wcb/claims/:id/manual-outcome — Record manual outcome. Permission: CLAIM_EDIT.

Total: 14 WCB-specific endpoints.

## Dependencies
This task depends on: D04W-024, D04W-025, D04W-026, D04W-027, D04W-028

## Security Requirements
- Batch download requires both BATCH_VIEW and WCB_BATCH_UPLOAD permissions.
- Return file upload must validate file format before processing.
- Remittance upload must validate XML against XSD before processing.
- MVP routes return 404 when WCB_PHASE != 'mvp'.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- POST /wcb/batches creates batch
- GET /wcb/batches/:id returns batch details
- GET /wcb/batches/:id/download returns signed URL when VALIDATED
- POST /wcb/batches/:id/confirm-upload transitions to UPLOADED
- POST /wcb/returns/upload processes return file
- GET /wcb/returns/:batch_id returns return results
- POST /wcb/remittances/upload processes remittance
- GET /wcb/remittances/:id/discrepancies returns discrepancies
- GET /wcb/claims/:id/export generates PDF (MVP mode)
- POST /wcb/claims/:id/manual-outcome records outcome (MVP mode)

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
