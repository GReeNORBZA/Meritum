# D04W-044: Security: PHI leakage prevention for WCB data

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/test/security/wcb/wcb.leakage.security.ts`.

**PHI not in error responses:**
- 400 validation error does not include patient PHN or name in error message
- 404 response does not confirm whether the WCB claim exists
- 500 error does not expose stack traces, SQL errors, or internal details

**PHI not in headers:**
- No X-Powered-By header
- No Server header revealing version
- HSTS header present
- CSP headers present

**Sensitive WCB data not leaked:**
- Vendor credentials (source ID, submitter ID) not exposed in API responses
- Batch XML file path not exposed in API responses (only signed download URL)
- Return file raw content not exposed in GET response (only parsed/structured data)
- Base64 attachment content not included in claim list responses (only metadata)

**WCB-specific PHI protection:**
- Employer details (name, location, phone) not leaked to unauthorized users
- Opioid prescription details not leaked in error messages
- Injury descriptions not leaked in validation errors
- Worker PHN in remittance records not exposed in discrepancy reports beyond what physician needs

**Audit log sanitisation:**
- Audit entries for WCB operations do not contain plaintext PHN, patient names, or clinical data in detail JSONB

## Dependencies
This task depends on: D04W-030, D04W-031

## Security Requirements
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
No specific unit tests for this task — verified by build/migration command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/wcb/wcb.leakage.security.ts
```
Fix any errors before finishing.
