# D04W-007: Drizzle schema for wcb_batches, wcb_return_records, wcb_return_invoice_lines, wcb_remittance_records pipeline tables

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add to `packages/shared/src/schemas/db/wcb.schema.ts`:

**wcb_batches table:**

| Column | Type | Nullable | Notes |
|--------|------|----------|-------|
| wcb_batch_id | UUID | No | PK |
| physician_id | UUID FK | No | FK -> providers. Per-physician batches |
| batch_control_id | VARCHAR(50) | No | BHS.11. For return file matching |
| file_control_id | VARCHAR(50) | No | FHS.11 |
| status | VARCHAR(20) | No | ASSEMBLING, GENERATED, VALIDATED, UPLOADED, RETURN_RECEIVED, RECONCILED, ERROR |
| report_count | INTEGER | No | |
| xml_file_path | VARCHAR(255) | Yes | Encrypted at rest |
| xml_file_hash | VARCHAR(64) | Yes | SHA-256 |
| xsd_validation_passed | BOOLEAN | Yes | |
| xsd_validation_errors | JSONB | Yes | Array of errors |
| uploaded_at | TIMESTAMPTZ | Yes | |
| uploaded_by | UUID FK | Yes | |
| return_file_received_at | TIMESTAMPTZ | Yes | |
| return_file_path | VARCHAR(255) | Yes | |
| created_at | TIMESTAMPTZ | No | |
| created_by | UUID FK | No | |

Indexes: (physician_id, status), UNIQUE(batch_control_id), UNIQUE(file_control_id).

**wcb_return_records table:**

| Column | Type | Nullable | Notes |
|--------|------|----------|-------|
| wcb_return_record_id | UUID | No | PK |
| wcb_batch_id | UUID FK | No | FK -> wcb_batches |
| wcb_claim_detail_id | UUID FK | Yes | Null if unable to match |
| report_txn_id | VARCHAR(20) | No | WCB-assigned |
| submitter_txn_id | VARCHAR(16) | No | For matching |
| processed_claim_number | VARCHAR(7) | Yes | WCB-assigned claim number |
| claim_decision | VARCHAR(20) | No | Accepted or empty |
| report_status | VARCHAR(20) | No | Complete or Invalid |
| txn_submission_date | DATE | No | |
| errors | JSONB | Yes | Array of {error_number, error_description} |

Index: (wcb_batch_id), (submitter_txn_id).

**wcb_return_invoice_lines table:**

| Column | Type | Nullable | Notes |
|--------|------|----------|-------|
| wcb_return_invoice_line_id | UUID | No | PK |
| wcb_return_record_id | UUID FK | No | FK -> wcb_return_records |
| invoice_sequence | SMALLINT | No | |
| service_date | DATE | Yes | |
| health_service_code | VARCHAR(7) | Yes | |
| invoice_status | VARCHAR(20) | Yes | |

**wcb_remittance_records table:**

| Column | Type | Null | Notes |
|--------|------|------|-------|
| wcb_remittance_id | UUID | No | PK |
| remittance_import_id | UUID FK | No | FK to import batch |
| wcb_claim_detail_id | UUID FK | Yes | Matched claim |
| report_week_start | DATE | No | |
| report_week_end | DATE | No | |
| disbursement_number | VARCHAR(8) | Yes | |
| disbursement_type | VARCHAR(3) | Yes | EFT or AUT |
| disbursement_issue_date | DATE | Yes | |
| disbursement_amount | DECIMAL(11,2) | Yes | |
| disbursement_recipient_billing | VARCHAR(8) | Yes | |
| disbursement_recipient_name | VARCHAR(40) | Yes | |
| payment_payee_billing | VARCHAR(8) | No | |
| payment_payee_name | VARCHAR(40) | No | |
| payment_reason_code | VARCHAR(3) | No | |
| payment_status | VARCHAR(3) | No | ISS, REQ, PAE, PGA, PGD, REJ, DEL |
| payment_start_date | DATE | No | |
| payment_end_date | DATE | No | |
| payment_amount | DECIMAL(11,2) | No | |
| billed_amount | DECIMAL(10,2) | Yes | |
| electronic_report_txn_id | VARCHAR(20) | Yes | For matching chain |
| claim_number | VARCHAR(7) | Yes | |
| worker_phn | VARCHAR(11) | Yes | |
| worker_first_name | VARCHAR(11) | Yes | |
| worker_last_name | VARCHAR(21) | Yes | |
| service_code | VARCHAR(7) | Yes | |
| modifier_1 | VARCHAR(6) | Yes | |
| modifier_2 | VARCHAR(6) | Yes | |
| modifier_3 | VARCHAR(6) | Yes | |
| number_of_calls | SMALLINT | Yes | |
| encounter_number | SMALLINT | Yes | |
| overpayment_recovery | DECIMAL(10,2) | Yes | |

Index: (electronic_report_txn_id), (remittance_import_id), (claim_number).

Export all tables and inferred types.

## FRD References
- Domain 4.2 Section 3.8: wcb_batches (7 statuses). Section 3.9: wcb_return_records. Section 3.10: wcb_return_invoice_lines.
- Domain 4.2 Section 3.11: wcb_remittance_records (31 columns from PaymentRemittanceRecord XML schema).

## Dependencies
This task depends on: D04W-002

## Security Requirements
- xml_file_path references AES-256 encrypted file on disk. Never store plaintext XML in database.
- Return files and remittance files stored encrypted for 7-year audit retention.
- worker_phn in remittance records is PHI — same protections as patient_phn.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
No specific unit tests for this task — verified by build/migration command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter shared build
```
Fix any errors before finishing.
