# D04W-025: Service: XSD validation, batch download with signed URL, and upload confirmation

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add XSD validation and download services:

- `validateBatchXsd(wcbBatchId: string)` — validate generated XML against both XSD schemas:
  1. WCBhl7_v231_modern_v100.xsd (structural validation).
  2. WCBhl7_v231_modern_v100_validate.xsd (data validation).
  3. If passed: transition batch to VALIDATED, set xsd_validation_passed = true.
  4. If failed: transition to ERROR, store errors in xsd_validation_errors JSONB. Map errors back to source claim/field where possible.
  XSD files stored as versioned assets in Reference Data. Use server-side XML validation library.

- `generateDownloadUrl(wcbBatchId: string, physicianId: string)` — generate a signed download URL for the batch XML:
  - Requires batch status = VALIDATED.
  - URL expires after 1 hour.
  - Single-use (mark as downloaded, or use signed URL nonce).
  - Emit audit: wcb.batch_downloaded.

- `confirmBatchUpload(wcbBatchId: string, userId: string)` — confirm the physician/delegate uploaded to myWCB:
  - Requires status = VALIDATED (or already downloaded).
  - Transition to UPLOADED.
  - Set uploaded_at, uploaded_by.
  - Emit audit: wcb.batch_uploaded.
  - Emit notification: WCB_BATCH_UPLOADED.

XSD validation is Phase 2 only. In MVP mode, batch endpoints are not available.

## Dependencies
This task depends on: D04W-024

## Security Requirements
- Download URL is time-limited (1h), single-use, and authenticated. Cannot be shared.
- XSD files themselves are not sensitive but must be versioned to match current WCB schema.
- Upload confirmation requires WCB_BATCH_UPLOAD permission (RBAC from Domain 1).
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- validateBatchXsd passes for valid XML
- validateBatchXsd fails and stores errors for invalid XML
- validateBatchXsd transitions to ERROR on failure
- generateDownloadUrl requires VALIDATED status
- generateDownloadUrl returns signed URL with 1h expiry
- confirmBatchUpload transitions to UPLOADED
- confirmBatchUpload rejects if not VALIDATED

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
