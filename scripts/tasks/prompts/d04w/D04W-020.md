# D04W-020: Service: WCB claim creation with form-type routing and practitioner snapshot

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/src/domains/wcb/wcb.service.ts` with claim lifecycle functions:

- `createWcbClaim(physicianId: string, data: CreateWcbClaimInput)` — orchestrates claim creation:
  1. Load practitioner from Provider Management (Domain 5) -> snapshot billing number, contract_id, role_code, names, skill_code, facility_type.
  2. Load patient from Patient Registry (Domain 6) -> snapshot PHN, demographics, employer if applicable.
  3. Validate Contract ID / Role / Form ID permission (gating check).
  4. For follow-up forms: validate parent_wcb_claim_id exists, parent is in terminal state, parent form type is in 'Can Create From' list, parent practitioner matches.
  5. Create base claim record in claims table (Domain 4.0) with claim_type = 'WCB'.
  6. Create wcb_claim_details with snapshot fields + form data.
  7. Create child records (injuries, prescriptions, consultations, restrictions, invoice_lines, attachments).
  8. Emit audit event: wcb.claim_created.
  Return { claim_id, wcb_claim_detail_id }.

- `updateWcbClaim(physicianId: string, wcbClaimDetailId: string, data: UpdateWcbClaimInput)` — partial update including child table upserts. Triggers revalidation. Emit audit: wcb.claim_updated.

- `deleteWcbClaim(physicianId: string, wcbClaimDetailId: string)` — soft delete. Only draft state. Emit audit: wcb.claim_deleted.

- `getFormSchema(formId: string, existingData?: Partial<WcbClaimDetail>)` — return form field schema: active sections, field requirements (always required / conditionally required / optional), current conditional states based on existing data values.

## Dependencies
This task depends on: D04W-010, D04W-011, D04W-012

## Security Requirements
- Contract/Role/Form validation is a gating check — reject before any data is written.
- Follow-up chain validation prevents cross-practitioner claim chaining.
- Practitioner and patient snapshots ensure submitted data integrity even if source records change later.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- createWcbClaim with valid GP + C050E creates claim with snapshots
- createWcbClaim rejects invalid Contract/Role/Form combination
- createWcbClaim for C151 requires valid parent_wcb_claim_id
- createWcbClaim for C151 rejects parent in non-terminal state
- createWcbClaim for C151 rejects parent from different practitioner
- updateWcbClaim updates claim and child records
- updateWcbClaim rejects non-draft claim
- deleteWcbClaim soft-deletes draft claim
- getFormSchema returns correct sections for C050E vs C568 vs C569

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
