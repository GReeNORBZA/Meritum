# D04W-028: Service: MVP export (pre-filled PDF) and manual outcome recording

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add MVP-specific services:

- `generateMvpExport(physicianId: string, wcbClaimDetailId: string)` — generate pre-filled export for manual portal entry:
  1. Load full claim with all child records.
  2. Run validation pipeline (Section 4). Warn on errors but allow export.
  3. Calculate fees and timing tier.
  4. Generate structured PDF/printable HTML that mirrors myWCB form layout.
  5. Include: all form fields organised by section, calculated fees, timing tier indicator, deadline countdown.
  6. Emit audit: wcb.mvp_export_generated.
  Return: file buffer + content type.

- `recordManualOutcome(physicianId: string, wcbClaimDetailId: string, data: ManualOutcomeInput)` — physician records WCB portal outcome:
  1. Store wcb_claim_number if provided.
  2. Update claim state: if accepted -> 'assessed'. If rejected -> 'rejected'.
  3. Store payment_amount if provided.
  4. Emit audit: wcb.manual_outcome_recorded.

These endpoints are MVP-only and deprecated after vendor accreditation. The service should check a feature flag (WCB_PHASE) to determine availability.

- `getTimingDashboard(physicianId: string)` — return all draft/queued WCB claims with their current timing tier, deadline, and fee difference to motivate timely submission. Key AI Coach integration point: 'Submit within [X hours] to earn [$Y] more.'

## Dependencies
This task depends on: D04W-020, D04W-023

## Tests
- generateMvpExport produces PDF/HTML for C050E claim
- generateMvpExport includes all form sections
- generateMvpExport includes fee calculation and timing
- recordManualOutcome stores WCB claim number
- recordManualOutcome transitions claim state
- getTimingDashboard returns claims with deadline info
- MVP endpoints return 404 when WCB_PHASE = 2

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
