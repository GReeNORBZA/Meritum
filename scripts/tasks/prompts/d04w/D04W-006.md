# D04W-006: Drizzle schema for wcb_invoice_lines and wcb_attachments child tables

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add to `packages/shared/src/schemas/db/wcb.schema.ts`:

**wcb_invoice_lines table (1-25 per claim, all form types):**

| Column | Type | Nullable | Notes |
|--------|------|----------|-------|
| wcb_invoice_line_id | UUID | No | PK |
| wcb_claim_detail_id | UUID FK | No | FK -> wcb_claim_details |
| invoice_detail_id | SMALLINT | No | Sequential 1-based line number |
| line_type | VARCHAR(10) | No | STANDARD, DATED, SUPPLY, WAS, SHOULD_BE |
| health_service_code | VARCHAR(7) | Yes | Required for STANDARD, DATED |
| diagnostic_code_1 | VARCHAR(8) | Yes | C568/A DATED lines |
| diagnostic_code_2 | VARCHAR(8) | Yes | |
| diagnostic_code_3 | VARCHAR(8) | Yes | |
| modifier_1 | VARCHAR(6) | Yes | |
| modifier_2 | VARCHAR(6) | Yes | |
| modifier_3 | VARCHAR(6) | Yes | |
| calls | SMALLINT | Yes | 0-7 |
| encounters | SMALLINT | Yes | 0 or 1 |
| date_of_service_from | DATE | Yes | C568/A DATED lines |
| date_of_service_to | DATE | Yes | C568/A DATED lines |
| facility_type_override | VARCHAR(1) | Yes | Per-line override C568/A |
| skill_code_override | VARCHAR(10) | Yes | Per-line override C568/A |
| invoice_detail_type_code | VARCHAR(10) | Yes | C568/A detail type |
| invoice_detail_desc | VARCHAR(50) | Yes | C568/A detail description |
| quantity | SMALLINT | Yes | C569 supply lines |
| supply_description | VARCHAR(50) | Yes | C569 |
| amount | DECIMAL(10,2) | Yes | Fee amount (C568/A, C569) |
| adjustment_indicator | VARCHAR(10) | Yes | C570 Was/Should Be pairing |
| billing_number_override | VARCHAR(8) | Yes | C570 per-line billing number |
| correction_pair_id | SMALLINT | Yes | C570: links Was line to Should Be line |

Constraint: UNIQUE(wcb_claim_detail_id, invoice_detail_id). Max 25 lines per claim.
Index: (wcb_claim_detail_id).

**wcb_attachments table (up to 3 per claim):**

| Column | Type | Nullable | Notes |
|--------|------|----------|-------|
| wcb_attachment_id | UUID | No | PK |
| wcb_claim_detail_id | UUID FK | No | FK -> wcb_claim_details |
| ordinal | SMALLINT | No | Position 1-3 |
| file_name | VARCHAR(255) | No | Original file name |
| file_type | VARCHAR(10) | No | PDF, DOC, DOCX, JPG, PNG, TIF |
| file_content_b64 | TEXT | No | Base64-encoded. Encrypted at rest |
| file_description | VARCHAR(60) | No | |
| file_size_bytes | INTEGER | No | For validation and display |

Constraint: UNIQUE(wcb_claim_detail_id, ordinal). CHECK ordinal BETWEEN 1 AND 3.

Export tables and inferred types.

## FRD References
- Domain 4.2 Section 3.6: wcb_invoice_lines — 5 line types with form-specific field requirements. C570 Was/Should Be pairing via correction_pair_id.
- Domain 4.2 Section 3.7: wcb_attachments — max 3 per form, base64-encoded for HL7 XML inclusion.

## Dependencies
This task depends on: D04W-002

## Security Requirements
- file_content_b64 contains PHI (clinical documents). Must be encrypted at rest using AES-256.
- Attachment file type must be validated against permitted types for the form_id. Arbitrary file types are rejected.
- File size limits must be enforced before base64 encoding to prevent memory exhaustion.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
No specific unit tests for this task — verified by build/migration command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter shared build
```
Fix any errors before finishing.
