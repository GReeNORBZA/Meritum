# D04W-011: Repository: child table CRUD (injuries, prescriptions, consultations, work restrictions)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add to `apps/api/src/domains/wcb/wcb.repository.ts`:

**Injuries:**
- `upsertInjuries(wcbClaimDetailId: string, injuries: InjuryInput[])` — delete existing and bulk insert 1-5 entries. Validate ordinal uniqueness.
- `getInjuries(wcbClaimDetailId: string)` — return ordered by ordinal.

**Prescriptions:**
- `upsertPrescriptions(wcbClaimDetailId: string, prescriptions: PrescriptionInput[])` — delete and replace 1-5.
- `getPrescriptions(wcbClaimDetailId: string)` — return ordered by ordinal.

**Consultations:**
- `upsertConsultations(wcbClaimDetailId: string, consultations: ConsultationInput[])` — delete and replace 1-5.
- `getConsultations(wcbClaimDetailId: string)` — return ordered by ordinal.

**Work Restrictions:**
- `upsertWorkRestrictions(wcbClaimDetailId: string, restrictions: RestrictionInput[])` — delete and replace. Max 11 (one per activity type).
- `getWorkRestrictions(wcbClaimDetailId: string)` — return all.

All upsert operations use transaction: delete existing rows then bulk insert replacement set. This avoids partial updates.

## Dependencies
This task depends on: D04W-009

## Tests
- upsertInjuries inserts 3 injury entries
- upsertInjuries replaces existing entries
- upsertInjuries enforces max 5
- upsertPrescriptions inserts and replaces
- upsertConsultations inserts and replaces
- upsertWorkRestrictions inserts up to 11 activity types
- upsertWorkRestrictions rejects duplicate activity_type

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
