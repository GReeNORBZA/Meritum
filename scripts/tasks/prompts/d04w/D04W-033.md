# D04W-033: Integration tests: WCB validation engine (all 16 checks, conditional cascades, POB-NOI matrix)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/test/integration/wcb/wcb-validation.integration.ts`:

**Form type validation:**
- Each of 8 form types with minimum required fields -> passes
- Each form type with maximum fields (all conditionals triggered) -> passes
- Contract/Role not permitted for form type -> error
- Follow-up chain: C151 from C050E (valid), C151 from C568A for GP (invalid)

**Conditional field cascades (via API):**
- narcotics = Y but no prescriptions -> error
- narcotics = Y on C151 but missing opioid monitoring fields -> error
- missed_work = Y but returned_to_work missing -> error
- returned_to_work = Y but date/hours/duties missing -> error
- modified_duties = Y but no restriction entries -> error
- patient_no_phn_flag = N but PHN missing -> error
- prior_conditions_flag = Y but desc missing -> error
- consultation_letter_format = TEXT but text missing -> error

**POB-NOI matrix (representative set):**
- Sprain(02100) + Brain(01100) -> rejected
- Fracture(01200) + Personal effects(91000) -> rejected
- Valid combination -> passes
- Side of Body required for Knee(41200) — missing -> error

**Data type and length:**
- Alphabetic field with numbers -> error
- Field exceeding max length by 1 -> error
- Invalid date format -> error
- Date of exam before date of injury -> error

**Timing and fees (via validate endpoint):**
- Same-day submission -> correct tier in response
- Near-deadline submission -> warning with hours remaining

## Dependencies
This task depends on: D04W-030

## Tests
No specific unit tests for this task — verified by build/migration command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/integration/wcb/
```
Fix any errors before finishing.
