# D04W-032: Integration tests: WCB claim lifecycle (create, validate, submit, return, reconcile)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/test/integration/wcb/wcb-lifecycle.integration.ts`:

**End-to-end lifecycle scenarios:**

1. **GP First Report (C050E) — happy path:**
   Create physician -> create C050E claim with injuries, invoice lines -> validate (passes) -> queue -> batch assembly -> XML generation -> XSD validation -> download -> confirm upload -> return file (Complete) -> claim assessed -> remittance -> claim paid.

2. **GP Progress Report (C151) chained from C050E:**
   Create C050E (assessed) -> create C151 linked to C050E -> add opioid monitoring fields -> validate -> submit lifecycle.

3. **OIS First Report (C050S) with expanded restrictions:**
   Create OIS practitioner (000053/OIS) -> create C050S -> fill all grasping, zone lifting, reaching, environmental, assessment summary fields -> validate -> verify all OIS fields pass.

4. **Specialist Consultation (C568A) with attachment:**
   Create specialist -> C568A with consultation_letter_format = ATTCH -> add attachment -> validate -> batch -> XML includes base64 attachment.

5. **Invoice Correction (C570) with Was/Should Be pairing:**
   Create C568 (assessed) -> create C570 -> add WAS line + SHOULD_BE line with matching pair -> validate pairing -> submit.

6. **Rejected claim -> correct -> resubmit:**
   Create claim -> batch -> return file (Invalid with errors) -> claim rejected -> physician corrects fields -> revalidate -> new batch -> return file (Complete).

7. **Batch with mixed form types:**
   Queue C050E + C568 + C569 -> single batch -> XML with 3 reports -> return file with mixed outcomes.

8. **MVP flow:**
   Create claim -> validate -> export PDF -> manual outcome recording.

## FRD References
- Domain 4.2 Section 11.7: WCB billing scenarios — 10 end-to-end scenarios covering all form types, rejection recovery, mixed batches, and MVP flow.

## Dependencies
This task depends on: D04W-030, D04W-031

## Tests
No specific unit tests for this task — verified by build/migration command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/integration/wcb/
```
Fix any errors before finishing.
