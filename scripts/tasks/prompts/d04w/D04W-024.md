# D04W-024: Service: WCB batch assembly and HL7 v2.3.1 XML generation

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add batch assembly and XML generation to WCB service:

- `assembleAndGenerateBatch(physicianId: string, userId: string)` — end-to-end batch pipeline:
  1. Create batch record (ASSEMBLING).
  2. Fetch all queued WCB claims for physician.
  3. For each claim: run validation. Skip claims that fail.
  4. Assign validated claims to batch.
  5. Generate HL7 v2.3.1 XML batch file.
  6. Store encrypted XML file. Set xml_file_path, xml_file_hash.
  7. Transition batch to GENERATED.
  8. Emit audit: wcb.batch_generated.
  Return wcb_batch_id.

- `generateBatchXml(batchId: string, claims: WcbClaimDetail[])` — generate HL7 XML:
  **Document structure (exact nesting order):**
  - ZRPT_P03 (root, namespace urn:WCBhl7_v231-schema_modern_v100)
    - FHS (file header: sending/receiving app+facility, timestamp, filename, file_control_id)
    - ZRPT_P03.LST.6 > ZRPT_P03.GRP.4 (batch wrapper)
      - BHS (batch header: batch_control_id)
      - ZRPT_P03.LST.5 > ZRPT_P03.GRP.3 > ZRPT_P03.GRP.2 (per report)
        - MSH (message header: submitter_txn_id)
        - EVN (event: form_id, report_completion_date)
        - PRD (provider: name, skill_code, fax)
        - PID (patient: PHN, DOB, demographics)
        - PV1 (visit: clinic_reference_number)
        - FT1 (financial: billing number, contract_id, exam date, diagnosis, invoice lines — repeats per line)
        - ACC (accident: date_of_injury)
        - NTE (notes: additional_comments)
        - OBX (observations: all clinical data — repeats per observation type)
      - BTS (batch trailer: report count)
    - FTS (file trailer: batch count = 1)

  **Header values:** FHS.3/BHS.3/MSH.3 = vendor source ID (from secrets). FHS.5/BHS.5 = 'WCB-EDM'. FHS.6/BHS.6 = 'RAPID-RPT'. Timestamps in Mountain Time.
  **OBX mapping:** Each clinical observation is a separate OBX with coded identifier (PRACTITIONER_ROLE, EMPNAME, JOBTITL, INJSYMP, OBJFIND, etc.).
  **Special character encoding:** Escape &, <, >, " in all free-text fields.
  **Attachments:** Base64-encoded file content in OBX segments.

## Dependencies
This task depends on: D04W-013, D04W-020

## Security Requirements
- XML file contains PHI (PHN, name, DOB, diagnosis, employer). Encrypt at rest.
- Vendor source ID and submitter ID loaded from secrets management — never hardcoded.
- Batch generation audit-logged with actor, timestamp, batch reference.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- assembleAndGenerateBatch creates batch and assigns claims
- assembleAndGenerateBatch skips claims that fail validation
- generateBatchXml produces valid XML structure
- XML contains correct namespace
- XML header values match vendor credentials
- XML timestamps in Mountain Time format
- XML escapes special characters in free-text fields
- XML includes base64 attachments correctly
- XML FT1 segments repeat per invoice line
- XML OBX segments map clinical fields correctly

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
