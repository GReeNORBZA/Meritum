# D04W-010: Repository: WCB claim CRUD operations (create, read, update, soft-delete)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Create `apps/api/src/domains/wcb/wcb.repository.ts` with WCB claim CRUD:

- `createWcbClaim(data: CreateWcbClaimInput)` — insert into wcb_claim_details. Generate submitter_txn_id (vendor prefix + unique). Return wcb_claim_detail_id.
- `getWcbClaim(wcbClaimDetailId: string, physicianId: string)` — fetch wcb_claim_details with ALL child records (injuries, prescriptions, consultations, restrictions, invoice_lines, attachments) via joins or subqueries. Scope to physician.
- `updateWcbClaim(wcbClaimDetailId: string, physicianId: string, data: UpdateWcbClaimInput)` — partial update. Only allowed in draft state (check via join to claims table). Set updated_at, updated_by.
- `softDeleteWcbClaim(wcbClaimDetailId: string, physicianId: string)` — set deleted_at. Only allowed in draft state.
- `getWcbClaimBySubmitterTxnId(submitterTxnId: string)` — for return file matching.
- `updateWcbClaimNumber(wcbClaimDetailId: string, claimNumber: string)` — store WCB-assigned claim number after return file processing.
- `listWcbClaimsForPhysician(physicianId: string, filters: { status?, form_id?, page, page_size })` — paginated list with join to claims table for status.

## Dependencies
This task depends on: D04W-009

## Security Requirements
- All read/write operations scope to physicianId — no cross-physician access.
- getWcbClaim returns 11 tables of data — ensure no N+1 queries. Use efficient joins.
- submitter_txn_id generation must be cryptographically unique and include vendor prefix.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- createWcbClaim inserts claim with generated submitter_txn_id
- createWcbClaim submitter_txn_id starts with vendor prefix
- getWcbClaim returns all child records (injuries, prescriptions, consultations, restrictions, invoice_lines, attachments)
- getWcbClaim scoped to physician returns null for other physician's claim
- updateWcbClaim updates fields and sets updated_at
- updateWcbClaim rejects update when claim not in draft state
- softDeleteWcbClaim sets deleted_at
- softDeleteWcbClaim rejects when not in draft state
- getWcbClaimBySubmitterTxnId finds claim by txn ID
- listWcbClaimsForPhysician returns only this physician's claims

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
