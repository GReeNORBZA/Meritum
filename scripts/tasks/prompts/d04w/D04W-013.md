# D04W-013: Repository: WCB batch operations (create, status transitions, download tracking)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add to `apps/api/src/domains/wcb/wcb.repository.ts`:

- `createBatch(physicianId: string, createdBy: string)` — insert wcb_batch with ASSEMBLING status. Generate batch_control_id (format: MER-B-{UUID short}) and file_control_id (format: MER-{YYYYMMDD}-{sequence}). Return wcb_batch_id.
- `getBatch(wcbBatchId: string, physicianId: string)` — fetch batch with physician scoping. Include report_count.
- `listBatches(physicianId: string, filters: { status?, page, page_size })` — paginated list, reverse chronological.
- `updateBatchStatus(wcbBatchId: string, status: string, additionalFields?: Partial<WcbBatch>)` — transition status. Set xml_file_path, xml_file_hash, xsd_validation_passed, etc. as appropriate.
- `setBatchUploaded(wcbBatchId: string, uploadedBy: string)` — set status UPLOADED, uploaded_at, uploaded_by. Only from VALIDATED.
- `setBatchReturnReceived(wcbBatchId: string, returnFilePath: string)` — set status RETURN_RECEIVED.
- `getQueuedClaimsForBatch(physicianId: string)` — fetch all queued WCB claims for physician (join claims table status = 'queued', claim_type = 'WCB').
- `assignClaimsToBatch(wcbBatchId: string, claimIds: string[])` — link claims to batch (via batch_id on claims table or junction).

## Dependencies
This task depends on: D04W-009

## Security Requirements
- All batch operations scoped to physicianId.
- Status transitions enforced: ASSEMBLING -> GENERATED -> VALIDATED -> UPLOADED -> RETURN_RECEIVED -> RECONCILED. ERROR can occur from ASSEMBLING, GENERATED, or VALIDATED.
- batch_control_id and file_control_id must be globally unique.
- All queries touching PHI (patient data, claims, billing) MUST be scoped to the authenticated physician's tenant
- Never log PHN, patient names, or clinical data in plaintext
- PHN displayed as 123****** (first 3 + 6 asterisks)

## Tests
- createBatch creates batch with ASSEMBLING status
- createBatch generates unique batch_control_id and file_control_id
- getBatch returns null for other physician's batch
- listBatches returns reverse chronological
- listBatches filters by status
- updateBatchStatus transitions correctly
- setBatchUploaded only from VALIDATED status
- getQueuedClaimsForBatch returns only queued WCB claims

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
