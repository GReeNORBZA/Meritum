# D04W-022: Service: POB-NOI validation, Contract/Role/Form enforcement, and timing deadline calculations

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add specialised validation modules to WCB service:

**POB-NOI Combination Validator:**
- Load 382-entry exclusion matrix from Reference Data into in-memory Set<string> of 'NOI_code:POB_code' tuples.
- For each injury entry on the claim, check if (NOI, POB) tuple is in exclusion set.
- On match: error with 'The combination of [NOI description] and [POB description] is not permitted by WCB' referencing the injury ordinal.
- Matrix is versioned in Reference Data. Cache and reload on version change.

**Side of Body Required Enforcer:**
- Reference the 30 POB codes with their 'Side of Body Required' flag (17 of 30 require side).
- For each injury entry, if POB requires side and side_of_body_code is null -> error.

**Contract ID / Role / Form ID Enforcer:**
- Load permission matrix from constants (D04W-001).
- For initial reports: validate (contract_id, role_code) permits form_id.
- For follow-up reports: additionally validate parent chain — parent exists, terminal state, form type in 'Can Create From', same practitioner billing number.

**Timing Deadline Calculator:**
- `calculateTimingTier(dateOfExamination: Date, currentTimestamp: Date, formId: string)` — returns { tier: SAME_DAY | ON_TIME | LATE, deadline: Date, hoursRemaining: number }.
- Business day calculation: M-F excluding 10 Alberta statutory holidays.
- Date of examination = Day 0 (not counted).
- 10:00 MT cutoff on deadline day.
- Form-specific deadlines: C050E = 3 biz days, C151/C568A = 4 biz days.
- Helper: `getAlbertaStatutoryHolidays(year: number)` — compute floating holidays (Family Day, Good Friday, Victoria Day, Labour Day, Thanksgiving) and fixed holidays.

## Dependencies
This task depends on: D04W-021

## Tests
- POB-NOI rejects Sprain(02100) + Brain(01100)
- POB-NOI allows valid combination
- Side of Body required for Ankle(42000) — missing -> error
- Side of Body not required for Head(00000) — missing -> no error
- Contract/Role/Form rejects GP + C050S
- Contract/Role/Form allows GP + C050E
- Follow-up chain: C151 from C050E (valid)
- Follow-up chain: C151 from C568A for GP (invalid)
- Timing: exam today, submit today -> SAME_DAY
- Timing: exam 3 biz days ago for C050E -> ON_TIME
- Timing: exam 4 biz days ago for C050E -> LATE
- Timing: holiday excluded from business day count
- Timing: 10:00 MT cutoff respected

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
