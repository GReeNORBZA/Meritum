# D04W-027: Service: WCB payment remittance XML parsing and reconciliation

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add remittance processing to WCB service:

- `processRemittanceFile(physicianId: string, xmlContent: string)` — parse and reconcile WCB remittance:
  1. Parse XML against Schema_RRPaymentRemittanceReport_2_01_00.xsd (namespace http://www.wcb.ab.ca/schemas/RR/RRPaymentRemittanceReport-2.01.00).
  2. Extract ReportWeek (StartDate, EndDate) and all PaymentRemittanceRecord elements.
  3. Create remittance import record.
  4. For each PaymentRemittanceRecord:
     a. Store in wcb_remittance_records.
     b. Match to claim: ElectronicReportTransactionID -> wcb_return_records.report_txn_id -> wcb_claim_details.
     c. Compare payment_amount to expected fee (from D04W-023 fee calculator). Flag discrepancies.
     d. Handle payment_status codes: ISS -> claim to 'paid'. REQ/PAE/PGA/PGD -> no state change, notify. REJ/DEL -> flag for review.
     e. Track overpayment_recovery amounts.
  5. Emit: WCB_PAYMENT_RECEIVED notification with summary.
  6. Emit audit: wcb.remittance_processed.

  **Discrepancy detection reasons:**
  - WCB applied different timing tier
  - WCB disallowed modifier/premium code
  - Overpayment recovery deducted
  - Fee schedule change between submission and payment

  Return: { import_id, record_count, matched_count, total_payment, discrepancy_count }.

## FRD References
- Domain 4.2 Section 7: Remittance XML schema (namespace, structure), reconciliation workflow (6 steps), 7 payment status codes, discrepancy detection causes.

## Dependencies
This task depends on: D04W-014, D04W-023

## Tests
- processRemittanceFile parses valid remittance XML
- Remittance records stored with all 31 fields
- Match via ElectronicReportTransactionID chain works
- ISS status transitions claim to paid
- REJ status flags claim for review
- Discrepancy detected when payment != expected
- Overpayment recovery tracked
- Unmatched records handled gracefully

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
