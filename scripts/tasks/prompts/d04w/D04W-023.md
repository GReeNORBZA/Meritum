# D04W-023: Service: WCB fee calculation — timing tiers, 351 premium codes, expedited services, unbundling, RRNP

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

## What to Build
Add fee calculation module to WCB service:

- `calculateWcbFees(wcbClaimDetailId: string)` — calculates total expected fee for a WCB claim:

  **Report fee (timing-based):**
  - Determine timing tier (same-day / on-time / late) from D04W-022.
  - Look up report fee from schedule: C050E ($94.15/$85.80/$54.08), C151 ($57.19/$52.12/$32.86), RF01E specialist ($115.05/$104.87/$66.09), RF03E specialist follow-up ($57.19/$52.12/$32.86).
  - Fee schedule versioned in Reference Data (Domain 2).

  **Invoice line fees:**
  - Each HSC is looked up in WCB fee schedule (subset of SOMB codes).
  - **Premium code check:** If HSC is in the 351 premium code list -> fee = SOMB_base x 2.
  - **Premium exclusion:** Premium codes excluded when date_of_service within 4 calendar days of date_of_injury.
  - **Premium limit:** One premium code per operative encounter.
  - **Unbundling:** WCB pays 100% per distinct service — no bundling discounts. Do NOT apply AHCIP bundling rules.

  **Expedited service fees:**
  - If consultation has expedite_requested = Y:
    - Completed within 15 business days -> full expedited fee
    - 16-25 business days -> pro-rated
    - After 25 business days -> no expedited fee

  **RRNP:**
  - Rural/Remote Northern Physician flat fee: $32.77/claim when physician qualifies (from Provider Management).
  - RRNP Variable Fee Premium: quarterly rate from Reference Data.

  Return: { report_fee, report_fee_tier, invoice_line_fees: [{ line_id, hsc, base_rate, premium_applied, fee }], expedited_fees, rrnp_fee, total_expected_fee }.

## FRD References
- Domain 4.2 Section 8: Complete fee calculation rules — timing tiers (Section 8.1), 351 premium codes at 2x SOMB (Section 8.2), expedited service tiers (Section 8.3), unbundling at 100% (Section 8.4), RRNP flat fee and variable premium (Section 8.5).

## Dependencies
This task depends on: D04W-022

## Tests
- Report fee: C050E same-day = $94.15
- Report fee: C050E on-time = $85.80
- Report fee: C050E late = $54.08
- Premium code: HSC in 351 list -> 2x SOMB rate
- Premium exclusion: service within 4 days of injury -> no premium
- Premium limit: only one premium per encounter
- Unbundling: two services same date -> both at 100%
- Expedited fee: completed within 15 biz days -> full fee
- Expedited fee: 20 biz days -> pro-rated
- RRNP: qualifying physician -> $32.77 added
- Total fee aggregation correct

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/wcb/wcb.test.ts
```
Fix any errors before finishing.
