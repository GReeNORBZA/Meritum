# D13-031: Support ticket routes — creation, listing, detail, rating, screenshot upload

**Domain:** 13 — Support System
**Task ID:** D13-031
**Depends on:** D13-021, D13-005
**Verify:** `pnpm --filter api vitest run src/domains/support/routes/ticket.routes.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/support/routes/ticket.routes.ts` and test file.

Register Fastify routes. All require authentication.

**Physician-facing routes:**

1. `POST /api/v1/support/tickets` — multipart form: JSON body validated by CreateTicketSchema + optional screenshot file upload. Creates ticket. Returns ticket (without screenshot_path). Permission: any authenticated physician/delegate.
2. `GET /api/v1/support/tickets` — query validated by TicketListQuerySchema. List physician's tickets. Permission: any authenticated physician/delegate.
3. `GET /api/v1/support/tickets/:id` — param validated by TicketIdParamSchema. Get ticket details. 404 for wrong provider. Permission: any authenticated physician/delegate.
4. `POST /api/v1/support/tickets/:id/rating` — body validated by TicketRatingSchema. Submit rating. 400 if ticket not RESOLVED/CLOSED. 404 for wrong provider. Permission: any authenticated physician/delegate.

**Screenshot upload handling:**
- Accept multipart/form-data on POST /support/tickets.
- Validate file: max 5MB, content-type must be image/png, image/jpeg, or image/webp.
- Store file to encrypted storage.
- Set screenshot_path on ticket record.
- Never return screenshot_path in response -- support team accesses via admin interface.

Route-level unit tests: ticket CRUD, screenshot upload validation (size, type), rating validation, provider scoping.

---

## FRD References

- Domain 13 Section 6: Ticket endpoints (Table 5 rows 4-7).
- Domain 13 Section 3.1: Support form with context pre-fill and screenshot upload.
- Domain 13 Section 5: SUP-003 ticket creation, SUP-005 rating.

---

## Security Requirements

- All ticket endpoints require authentication -- no anonymous ticket creation.
- Provider scoping on all physician-facing endpoints.
- Screenshot upload: max 5MB, image types only, content-type validated server-side (not just from client header).
- Multipart parsing with size limits to prevent DoS.
- screenshot_path never in response body.

---

## Codebase Context

- **Routes location:** `apps/api/src/domains/support/routes/`. Follow existing Fastify route registration patterns.
- **Test co-location:** Unit tests go in the same directory as `ticket.routes.test.ts`.
- **Auth pattern:** All ticket routes use session cookie auth. Access `request.session.user` for `{ id, role, physician_id }`. The `physician_id` (or provider_id from context) is used for ticket scoping.
- **Delegate context:** When a delegate is logged in, `request.session.user.physician_id` contains the physician's provider_id they are acting on behalf of. Use this for ticket scoping, not the delegate's own user ID.
- **Multipart file upload in Fastify:** Use `@fastify/multipart` plugin. Register with size limits: `{ limits: { fileSize: 5 * 1024 * 1024 } }`. Access file via `request.file()` or `request.parts()`.
- **Content-type validation:** Validate the file's content-type server-side. Do not rely solely on the file extension or client-provided content-type header. Consider using magic bytes detection if available.
- **Response filtering:** When returning ticket data, explicitly exclude `screenshot_path` from the response object. Use a response serializer or manual field selection.
- **Validation schemas:** Import from `packages/shared/src/schemas/validation/support.validation.ts` (D13-005).
