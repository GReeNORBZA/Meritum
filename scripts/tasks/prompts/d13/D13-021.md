# D13-021: Support ticket service — creation, lifecycle, notifications, SLA

**Domain:** 13 — Support System
**Task ID:** D13-021
**Depends on:** D13-011
**Verify:** `pnpm --filter api vitest run src/domains/support/services/support-ticket.service.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/support/services/support-ticket.service.ts` and test file.

**Methods:**

- `createTicket(providerId, data, screenshotFile?)` — create support ticket. Auto-detect priority: if context_metadata contains batch_error or error codes, set URGENT. If screenshotFile provided, validate file type (png, jpg, webp, max 5MB), store to encrypted storage, set screenshot_path. Send confirmation email to physician. Send notification via Domain 9. Audit log: support.ticket_created. Return created ticket (without screenshot_path).
- `getTicket(providerId, ticketId)` — fetch ticket scoped to provider. Return ticket details without screenshot_path. Return null for wrong provider.
- `listTickets(providerId, filters)` — list physician's tickets. Paginated.
- `rateTicket(providerId, ticketId, rating, comment?)` — submit satisfaction rating. Validate ticket status is RESOLVED or CLOSED. Validate rating 1-5. Update ticket. Audit log: support.ticket_rated. Return updated ticket.

**Admin methods (support team only):**
- `updateTicket(ticketId, data, actorId)` — update ticket fields (status, category, priority, assigned_to, resolution_notes). On status change to RESOLVED: set resolved_at = now(). Send notification to physician on status changes. Audit log: support.ticket_updated. On RESOLVED: audit log: support.ticket_resolved.
- `closeTicket(ticketId, actorId)` — set status = CLOSED. Audit log: support.ticket_closed. Only if current status is RESOLVED.
- `getTriageQueue(filters)` — list all open/in-progress tickets for support team. Sorted by priority then created_at.
- `getSlaBreach()` — tickets exceeding SLA targets.

**SLA calculation logic:**
Business hours: Mon-Fri 08:00-18:00 MT, Thursday 06:00-22:00 MT.
SLA clock only runs during business hours. Calculate elapsed business hours between created_at and now (for first response) or resolved_at (for resolution).

**Notification triggers:**
- Ticket created -> confirmation email + in-app notification to physician.
- Status changed -> in-app notification + email to physician.
- Ticket resolved -> notification with resolution_notes summary.

Unit tests: create with auto-URGENT, screenshot upload validation, status transitions, rating only on resolved/closed, SLA business hours calculation, notification dispatch.

---

## FRD References

- Domain 13 Section 3.1: Support email flow -- form, context pre-fill, screenshot, confirmation, resolution notification.
- Domain 13 Section 3.2: Ticket lifecycle -- OPEN -> IN_PROGRESS -> RESOLVED -> CLOSED.
- Domain 13 Section 3.3: SLA targets by priority (Table 3). Business hours definition.
- Domain 13 Section 5: SUP-003 ticket creation, SUP-004 status notifications, SUP-005 rating.

---

## Security Requirements

- Screenshot validated: max 5MB, image types only (png, jpg, webp). No executable uploads.
- screenshot_path never returned in API responses -- only used server-side.
- description and context_metadata may contain PHI-adjacent info -- encrypted at rest.
- Confirmation email contains ticket_id and subject only -- no description or context in email body (PHI protection).
- SLA calculation runs during business hours only -- ensures fair SLA tracking.

---

## Codebase Context

- **Service location:** `apps/api/src/domains/support/services/`. Follow existing service patterns.
- **Test co-location:** Unit tests go in the same directory as `support-ticket.service.test.ts`.
- **Notification integration:** Use the existing D09 notification service for sending emails and in-app notifications. Import notification service and call with appropriate event types.
- **Audit logging:** Use the existing D12 audit logging infrastructure. Import audit service and log all support events with the action identifiers from D13-001 constants.
- **File upload handling:** Screenshot files should be validated at the service level (content-type, size) before storage. The storage mechanism should encrypt files at rest. Follow any existing file upload patterns in the codebase.
- **SLA business hours calculation:** Implement a utility function that calculates elapsed business hours between two timestamps, accounting for the custom business hours schedule (Mon-Fri 08:00-18:00 MT, Thursday 06:00-22:00 MT). Consider using a date library (date-fns or luxon) for timezone-aware calculations.
- **Status transition validation:** The service should enforce valid status transitions: OPEN -> IN_PROGRESS -> WAITING_ON_CUSTOMER/RESOLVED, RESOLVED -> CLOSED. Invalid transitions should throw an error.
- **Auth pattern:** Session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. Roles: physician, delegate, admin.
