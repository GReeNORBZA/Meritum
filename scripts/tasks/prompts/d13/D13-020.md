# D13-020: Help centre service — search, context-aware routing, feedback

**Domain:** 13 — Support System
**Task ID:** D13-020
**Depends on:** D13-010
**Verify:** `pnpm --filter api vitest run src/domains/support/services/help-centre.service.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/support/services/help-centre.service.ts` and test file.

**Methods:**

- `searchArticles(query, limit?, offset?)` — sanitise search query (strip special tsquery characters), execute full-text search via repo. Audit log: support.help_searched (rate-limited, max 1 per minute per provider). Return ranked results.
- `getArticle(slug)` — fetch article by slug. Audit log: support.article_viewed (rate-limited). Return article content.
- `listByCategory(category, limit?, offset?)` — list published articles in category.
- `getContextualHelp(contextUrl, contextMetadata?)` — resolve page context to help content:
  1. Match contextUrl against context-aware help mapping from constants.
  2. If matched to a category -> return articles in that category.
  3. If contextMetadata contains a rejection/explanatory code -> search by related_codes.
  4. If no match -> return search page URL.
- `submitFeedback(articleSlug, providerId, isHelpful)` — resolve slug to article_id, create/update feedback, increment article feedback counter. Audit log: support.article_feedback.

**Search query sanitisation:**
- Strip tsquery special characters: & | ! ( ) : * < >
- Trim whitespace, limit to 200 chars.
- Convert to websearch_to_tsquery for natural language input (allows 'common rejection codes' without manual AND/OR).

Unit tests: search returns ranked results, empty query returns empty, context-aware mapping resolves categories, rejection code context finds related articles, feedback recorded and counters updated.

---

## FRD References

- Domain 13 Section 2.2: Full-text search, feedback loop.
- Domain 13 Section 2.3: Context-aware help -- page URL to category mapping, rejection code search.
- Domain 13 Section 5: SUP-001 search, SUP-002 context-aware help, SUP-006 rejection code lookup.

---

## Security Requirements

- Search query sanitised to prevent tsquery injection.
- Rate-limited audit logging for searches and article views to avoid noise.
- Articles are non-PHI but access patterns are logged for analytics.

---

## Codebase Context

- **Service location:** `apps/api/src/domains/support/services/`. Follow existing service patterns from other domains.
- **Test co-location:** Unit tests go in the same directory as `help-centre.service.test.ts`.
- **Audit logging:** Use the existing audit logging infrastructure from D12 (Platform Ops). Import the audit service and call it with the appropriate action identifiers from D13-001 constants.
- **Context-aware help mapping:** Import the URL pattern -> category mapping from `packages/shared/src/constants/support.constants.ts`. Use pattern matching (regex or string matching) to resolve the current page URL to a help category.
- **Rate-limited audit:** Implement a simple in-memory rate limiter (or use existing rate limiting utility) to avoid flooding the audit log with repeated article views or search events. The rate limit is per-provider, not global.
- **websearch_to_tsquery:** This PostgreSQL function converts natural language queries to tsquery format. It is more forgiving than `to_tsquery` and handles spaces as implicit AND. Use this in the repository layer.
