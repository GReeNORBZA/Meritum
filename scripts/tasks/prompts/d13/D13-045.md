# D13-045: Security: audit trail completeness — all events logged, append-only

**Domain:** 13 — Support System
**Task ID:** D13-045
**Depends on:** D13-030, D13-031
**Verify:** `pnpm --filter api vitest run test/security/support/support.audit.security.ts`

---

## Build Instructions

Create `apps/api/test/security/support/support.audit.security.ts`.

**Verify all audit events are logged:**

1. support.ticket_created: Create ticket -> audit entry with ticket_id, provider_id, priority, actor identity.
2. support.ticket_updated: Admin updates ticket -> audit entry with ticket_id, changed fields, actor identity.
3. support.ticket_resolved: Ticket resolved -> audit entry with ticket_id, resolved_at, actor identity.
4. support.ticket_closed: Ticket closed -> audit entry with ticket_id, actor identity.
5. support.ticket_rated: Submit rating -> audit entry with ticket_id, rating value, provider_id.
6. support.article_viewed: View article -> audit entry with article slug, provider_id. Rate-limited.
7. support.article_feedback: Submit feedback -> audit entry with article_id, is_helpful, provider_id.
8. support.help_searched: Search help -> audit entry with search query (sanitised), provider_id. Rate-limited.

**Audit integrity:**
- Audit entries are append-only. No UPDATE or DELETE on audit log table.
- Each audit entry includes actor_id, actor_role, action, resource_id, timestamp, and details JSONB.

**Delegate audit:**
- Delegate creates ticket -> audit shows delegate as actor, physician as context.
- Delegate submits article feedback -> audit shows delegate identity.

**Rate-limited audit:**
- article_viewed: max 1 per article per physician per 5 minutes.
- help_searched: max 1 per physician per minute.

**Audit must NOT contain:**
- Ticket description content (PHI risk).
- Screenshot file content.
- Search result content.

---

## Security Requirements

- Append-only audit log -- no UPDATE or DELETE.
- Audit entries reference ticket_id, not ticket content -- avoids PHI in audit logs.
- Rate-limited help search and article view audits prevent noise.
- Search queries logged but sanitised -- no raw user input with injection payloads.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/support/`.
- **Audit infrastructure:** Use the existing audit logging infrastructure from D12 (Platform Ops). The audit service provides methods to log events and query audit entries.
- **Audit event verification:** After performing an action (e.g., creating a ticket), query the audit log for the corresponding event and verify it contains the expected fields.
- **Append-only verification:** Attempt to UPDATE or DELETE an audit entry and verify it fails (either via database constraint or application-level check).
- **Rate-limited audit testing:** Perform the same action multiple times in quick succession and verify that only one audit entry is created within the rate limit window.
- **Delegate audit testing:** Create a delegate session, perform actions, and verify the audit log records the delegate as the actor with the physician as context.
- **PHI exclusion:** Verify that audit entries for ticket actions contain ticket_id and provider_id but NOT the ticket description, context_metadata content, or screenshot file content.
- **Audit action identifiers:** Use the constants defined in D13-001 (support.ticket_created, support.ticket_updated, etc.) to query for specific audit events.
