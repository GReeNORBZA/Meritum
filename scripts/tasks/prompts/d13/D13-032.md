# D13-032: Integration tests — end-to-end support workflows

**Domain:** 13 — Support System
**Task ID:** D13-032
**Depends on:** D13-030, D13-031
**Verify:** `pnpm --filter api vitest run test/integration/support/`

---

## Build Instructions

Create integration test files in `apps/api/test/integration/support/`:

**File: support.help-centre.integration.ts**
- Seed help articles across categories.
- Search 'thursday batch' -> returns AHCIP_BILLING articles about batch cycle.
- Search 'explanatory code 101' -> returns article with related_codes containing '101'.
- Search nonsense string -> empty results.
- List by category TROUBLESHOOTING -> returns only troubleshooting articles.
- Get article by slug -> full content returned.
- Get unpublished article -> 404.
- Submit feedback (helpful) -> article helpful_count incremented.
- Submit feedback again -> updates existing feedback (doesn't double-count).

**File: support.tickets.integration.ts**
- Create ticket with context -> ticket created with OPEN status. Confirmation notification sent.
- Create ticket with batch failure context -> auto-URGENT priority.
- List tickets -> shows created tickets, ordered by recency.
- Get ticket by ID -> full details without screenshot_path.
- Rate ticket before resolution -> 400.
- Admin resolves ticket -> physician notified. Status = RESOLVED. resolved_at set.
- Rate resolved ticket -> rating stored. 1-5 valid. 0 or 6 -> 400.
- Admin closes ticket -> status = CLOSED.

**File: support.context-aware.integration.ts**
- Simulate help button from claim page -> articles in AHCIP_BILLING category returned.
- Simulate help from rejected claim with explanatory code -> article for that code returned.
- Simulate help from settings page -> ACCOUNT_AND_BILLING articles.
- Simulate help with no context -> search page fallback.

**File: support.delegate.integration.ts**
- Delegate can create support tickets on behalf of physician.
- Delegate can view physician's tickets.
- Delegate-created tickets are linked to the physician's provider_id (not the delegate's).

---

## FRD References

- Domain 13 Section 7: All testing requirements.
- Domain 13 Section 5: User stories and acceptance criteria (Table 4).
- SUP-001 through SUP-006 coverage.

---

## Test Specifications

- Help centre search returns ranked results for 'thursday batch'.
- Rejection code search finds articles with matching related_codes.
- Context-aware help maps claim page to AHCIP_BILLING category.
- Ticket creation captures context and sends confirmation notification.
- Batch failure context auto-sets URGENT priority.
- Ticket lifecycle: OPEN -> IN_PROGRESS -> RESOLVED -> CLOSED with notifications at each step.
- Rating only allowed on RESOLVED or CLOSED tickets.
- Screenshot upload stores file securely, path not in API response.
- Feedback limited to one per physician per article.

---

## Codebase Context

- **Integration test location:** `apps/api/test/integration/support/`. Follow existing integration test patterns from other domains (e.g., `test/integration/claims/`, `test/integration/providers/`).
- **Test setup:** Integration tests typically use a test database, seed data, and make HTTP requests to the Fastify app instance. Follow the existing test setup/teardown pattern.
- **Auth in tests:** Create authenticated test sessions using existing test helpers. For physician tests, create a physician user. For delegate tests, create a delegate user with physician context.
- **Notification assertions:** Mock or spy on the D09 notification service to verify notifications are dispatched without actually sending emails.
- **Database seeding:** Seed help articles with known content, slugs, categories, and related_codes for predictable test assertions.
- **Security test helper:** Use `createSecurityPair()` to create two physician accounts for cross-tenant isolation testing (used in D13-042, but useful context here too).
- **Vitest:** Tests use Vitest with `describe`, `it`, `expect`, `beforeAll`, `afterAll` patterns.
