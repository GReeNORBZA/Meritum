# D13-040: Security: authentication enforcement on every protected route

**Domain:** 13 â€” Support System
**Task ID:** D13-040
**Depends on:** D13-030, D13-031
**Verify:** `pnpm --filter api vitest run test/security/support/support.authn.security.ts`

---

## Build Instructions

Create `apps/api/test/security/support/support.authn.security.ts`.

Test every authenticated route in Domain 13 returns 401 without a valid session cookie:

**Authenticated routes:**
- POST /api/v1/help/articles/:slug/feedback
- POST /api/v1/support/tickets
- GET /api/v1/support/tickets
- GET /api/v1/support/tickets/:id
- POST /api/v1/support/tickets/:id/rating

**Public routes (verify they work WITHOUT auth):**
- GET /api/v1/help/articles -> 200 without cookie
- GET /api/v1/help/articles/:slug -> 200 without cookie (for published articles)

For each authenticated route (5 total): send request with no cookie, with expired cookie, and with tampered cookie. All must return 401 with no data leakage.

For public routes: verify they return valid data WITHOUT any cookie. Verify they do NOT return any user-specific data or session info in response.

Total assertions: 5 authenticated routes x 3 failure modes = 15 + 2 public route verifications.

---

## Security Requirements

- 401 responses must not contain any data beyond the error object.
- Public help routes must not leak session info or user data.
- Public routes return same content regardless of auth status -- no personalisation leakage.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/support/`. Follow existing security test patterns from other domains (e.g., `test/security/claims/`, `test/security/providers/`).
- **Test structure:** Security tests follow a systematic pattern: for each route, test all authentication failure modes (no cookie, expired cookie, tampered cookie).
- **Auth cookie testing:** The test should craft requests with no session cookie, an expired session cookie, and a tampered/invalid session cookie. All should return 401.
- **Public route testing:** For GET /help/articles and GET /help/articles/:slug, make requests without any auth cookie and verify they return 200 with valid article data but no user-specific information.
- **No data leakage check:** Verify that 401 responses contain only a generic error message (e.g., `{ error: 'Unauthorized' }`) and no stack traces, user data, or internal details.
- **Security test helper:** Use `createSecurityPair()` if needed for creating test accounts, though this test primarily focuses on unauthenticated access.
- **Vitest:** Tests use Vitest with `describe`, `it`, `expect` patterns.
