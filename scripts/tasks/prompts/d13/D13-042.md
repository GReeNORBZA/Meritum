# D13-042: Security: cross-physician tenant isolation (MOST CRITICAL)

**Domain:** 13 â€” Support System
**Task ID:** D13-042
**Depends on:** D13-030, D13-031
**Verify:** `pnpm --filter api vitest run test/security/support/support.scoping.security.ts`

---

## Build Instructions

Create `apps/api/test/security/support/support.scoping.security.ts`.

**MOST CRITICAL security test for Domain 13.** Support tickets may contain PHI-adjacent information (claim IDs, error details, physician descriptions of patient issues).

Setup: Create two physicians (Physician A and Physician B) each with support tickets.

**Ticket isolation:**
- Physician A lists tickets -> sees ONLY their own tickets.
- Physician B lists tickets -> sees ONLY their own tickets.
- Physician A calls GET /support/tickets/:id with Physician B's ticket_id -> 404 (not 403).
- Physician A calls POST /support/tickets/:id/rating with Physician B's ticket_id -> 404 (not 403).

**Screenshot isolation:**
- Physician A's screenshot is not accessible to Physician B (file path not exposed, but verify at storage level).

**Article feedback isolation:**
- Article feedback is per-physician. Physician A's feedback does not appear as Physician B's.
- Both can submit feedback on the same article independently.

**Delegate cross-physician:**
- Delegate of Physician A in Physician A's context -> sees Physician A's tickets.
- Delegate cannot access Physician B's tickets if not linked to Physician B.

**Help articles are NOT tenant-scoped** -- they are shared knowledge base content. Verify this is intentional and no physician-specific data leaks through article endpoints.

All cross-physician access attempts MUST return 404, NEVER 403.

---

## Security Requirements

- MOST CRITICAL: All cross-physician ticket access returns 404 not 403.
- Ticket descriptions may contain PHI-adjacent data -- strict isolation required.
- Help articles are intentionally shared -- no tenant isolation needed on articles.
- Screenshot files isolated per physician -- storage-level access control.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/support/`.
- **Security test helper:** Use `createSecurityPair()` to create two physician accounts for cross-tenant isolation testing. This helper is the standard pattern used across all domain security tests.
- **404 not 403 pattern:** This is a critical security pattern used throughout the Meritum platform. When Physician A tries to access Physician B's resource, the response MUST be 404 (not found), not 403 (forbidden). Returning 403 would confirm the resource exists, which is an information leak.
- **Test setup:** Create Physician A with tickets and Physician B with tickets. Then attempt cross-access in both directions.
- **Feedback isolation:** While both physicians can submit feedback on the same public article, each physician's feedback record is independent. Verify Physician A's feedback submission does not overwrite or appear as Physician B's.
- **Delegate testing:** Create a delegate linked to Physician A. The delegate should see Physician A's tickets when in Physician A's context but NOT Physician B's tickets.
