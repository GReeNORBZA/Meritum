# D13-044: Security: PHI leakage prevention in errors, headers, and logs

**Domain:** 13 â€” Support System
**Task ID:** D13-044
**Depends on:** D13-030, D13-031
**Verify:** `pnpm --filter api vitest run test/security/support/support.leakage.security.ts`

---

## Build Instructions

Create `apps/api/test/security/support/support.leakage.security.ts`.

**Error responses must not contain PHI:**
- 404 on ticket access -> no ticket description, no context_metadata.
- 400 on invalid input -> validation error only.
- 500 (simulated) -> generic error, no stack trace, no PHI.

**Response headers:**
- No X-Powered-By header.
- No server version info.
- screenshot_path NEVER in any API response.

**Logs must not contain PHI:**
- Ticket creation logs ticket_id and provider_id but NOT description content.
- Search query logs the query but NOT search results content.
- Error logs are generic -- no ticket descriptions or context_metadata.

**Support-specific leakage vectors:**
- GET /support/tickets/:id -> returns description and context_metadata (intentional -- physician's own data). Verify screenshot_path is excluded.
- GET /support/tickets -> list view returns subject and status only, NOT full description (minimize PHI in list responses).
- Confirmation email contains ticket_id and subject only -- NOT description or context_metadata.
- Status change notification contains ticket_id and new status -- NOT resolution_notes in email.

**Public help endpoint leakage:**
- GET /help/articles -> returns article content only. No user data, no session data, no feedback attribution.
- Article feedback endpoint response confirms action but doesn't reveal other physicians' feedback.

---

## Security Requirements

- Ticket list returns minimal data (subject, status) -- full description only in detail view.
- Emails contain ticket reference only -- no PHI in email body.
- screenshot_path is the most sensitive field -- never exposed in any response.
- Public help endpoints must not leak any user or session data.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/support/`.
- **PHI leakage testing pattern:** These tests verify that sensitive data does not appear in places it should not: error responses, HTTP headers, list views, email notifications, and log output.
- **Response body inspection:** For each endpoint, parse the response body and verify that excluded fields (like screenshot_path) are not present. Use `expect(response.body).not.toHaveProperty('screenshot_path')`.
- **Header inspection:** Check `response.headers` for absence of `x-powered-by`, server version strings, etc.
- **List vs detail response:** The ticket list endpoint (GET /support/tickets) should return minimal fields (ticket_id, subject, status, priority, created_at). The detail endpoint (GET /support/tickets/:id) returns full details including description and context_metadata (physician's own data) but still excludes screenshot_path.
- **Email content testing:** If the notification service is mocked/spied, verify the email payload contains only ticket_id and subject, not the full description or context_metadata.
- **Log testing:** This may require intercepting log output or mocking the logger to verify PHI is not logged.
