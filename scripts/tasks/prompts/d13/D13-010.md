# D13-010: Help articles repository — search, category listing, feedback

**Domain:** 13 — Support System
**Task ID:** D13-010
**Depends on:** D13-006
**Verify:** `pnpm --filter api vitest run src/domains/support/repos/help-articles.repo.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/support/repos/help-articles.repo.ts` and test file.

**Methods:**

- `search(query, limit?, offset?)` — full-text search using `to_tsquery('english', query)` against search_vector. Rank results using `ts_rank`. Only return published articles. Return: article_id, slug, title, category, summary, rank score.
- `getBySlug(slug)` — fetch full article by slug. Only if is_published = true. Return null if not found or unpublished.
- `listByCategory(category, limit?, offset?)` — list published articles in a category, ordered by sort_order. Return article_id, slug, title, summary.
- `findByRelatedCode(code)` — search related_codes JSONB array for the given code. Returns articles where related_codes @> code. For rejection/explanatory code lookups.
- `incrementFeedback(articleId, isHelpful)` — atomically increment helpful_count or not_helpful_count.
- `createFeedback(articleId, providerId, isHelpful)` — insert into article_feedback. On conflict (article_id, provider_id) update the is_helpful value (physician can change their feedback).

**Admin methods (for content management — support team/admin only):**
- `create(data: InsertHelpArticle)` — create new article. Slug auto-generated from title if not provided.
- `update(articleId, data: Partial)` — update article content. search_vector auto-updated by trigger.
- `publish(articleId)` — set is_published = true.
- `unpublish(articleId)` — set is_published = false.

Unit tests: full-text search returns ranked results, category listing, slug lookup, related code search, feedback increment, unpublished articles hidden.

---

## FRD References

- Domain 13 Section 2.2: Searchable full-text, feedback loop, versioned.
- Domain 13 Section 2.3: Context-aware help -- findByRelatedCode for rejection code lookups.
- Domain 13 Section 6: GET /help/articles and GET /help/articles/{slug} endpoints.

---

## Security Requirements

- Only published articles returned to physicians -- draft content hidden.
- Full-text search uses parameterised tsquery -- no raw SQL injection.
- Feedback limited to one per physician per article -- prevents vote manipulation.

---

## Codebase Context

- **Repository location:** `apps/api/src/domains/support/repos/`. Follow existing repository patterns from other domains (e.g., D05 providers, D06 patients).
- **Test co-location:** Unit tests go in the same directory as `help-articles.repo.test.ts`.
- **Drizzle query patterns:** Use `db.select()`, `db.insert()`, `db.update()` with the schema tables from `packages/shared/src/schemas/db/support.schema.ts`.
- **Full-text search in Drizzle:** Use `sql` template literal for tsquery/ts_rank operations. Example: `sql\`ts_rank(${helpArticles.searchVector}, to_tsquery('english', ${query}))\``.
- **JSONB containment query:** For `findByRelatedCode`, use `sql\`${helpArticles.relatedCodes} @> ${JSON.stringify([code])}::jsonb\``.
- **Upsert pattern:** For `createFeedback`, use `db.insert().onConflictDoUpdate()` with the unique constraint on (article_id, provider_id).
- **Vitest:** Tests use Vitest. Follow existing test patterns with `describe`, `it`, `expect`.
