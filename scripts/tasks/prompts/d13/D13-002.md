# D13-002: Drizzle schema for support_tickets table

**Domain:** 13 â€” Support System
**Task ID:** D13-002
**Depends on:** D13-001
**Verify:** `pnpm --filter shared build`

---

## Build Instructions

Create `packages/shared/src/schemas/db/support.schema.ts` starting with support_tickets table.

**support_tickets table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| ticket_id | UUID | PK | Default: gen_random_uuid() |
| provider_id | UUID FK | NOT NULL | FK to providers. Indexed. |
| subject | VARCHAR(200) | NOT NULL | Auto-generated from context or physician-entered |
| description | TEXT | NOT NULL | Physician's description of the issue |
| context_url | VARCHAR(500) | NULLABLE | Page URL where 'Help' was clicked |
| context_metadata | JSONB | NULLABLE | Auto-captured: claim_id, batch_id, error codes, browser info |
| category | VARCHAR(50) | NULLABLE | Assigned by support team: BILLING, TECHNICAL, ACCOUNT, FEATURE_REQUEST |
| priority | VARCHAR(10) | NOT NULL, DEFAULT 'MEDIUM' | LOW, MEDIUM, HIGH, URGENT |
| status | VARCHAR(20) | NOT NULL, DEFAULT 'OPEN' | OPEN, IN_PROGRESS, WAITING_ON_CUSTOMER, RESOLVED, CLOSED |
| assigned_to | VARCHAR(100) | NULLABLE | Support team member handling the ticket |
| resolution_notes | TEXT | NULLABLE | How the issue was resolved |
| resolved_at | TIMESTAMPTZ | NULLABLE | When the ticket was resolved |
| satisfaction_rating | INTEGER | NULLABLE | 1-5 star rating from physician |
| satisfaction_comment | TEXT | NULLABLE | Optional comment with rating |
| screenshot_path | VARCHAR(255) | NULLABLE | Path to uploaded screenshot (encrypted at rest) |
| created_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |
| updated_at | TIMESTAMPTZ | NOT NULL, DEFAULT now() | |

**Indexes:**
- Index on (provider_id, status) for physician's ticket list filtered by status
- Index on (provider_id, created_at DESC) for recent tickets
- Index on (status, priority) for support team triage queue
- Index on (assigned_to, status) for agent workload

**Note:** Added satisfaction_comment and screenshot_path beyond FRD Table 2 spec to support user stories SUP-003 (screenshot upload) and SUP-005 (optional comment with rating).

Export table and inferred types (InsertSupportTicket, SelectSupportTicket).

---

## FRD References

- Domain 13 Section 3.2: support_tickets table schema (Table 2).
- Domain 13 Section 5: SUP-003 screenshot upload, SUP-005 optional comment with rating.

---

## Security Requirements

- provider_id scoping -- physician can only see their own tickets.
- context_metadata may contain claim_id or batch_id -- PHI-adjacent. Encrypted at rest.
- screenshot_path points to encrypted storage. Never expose in API responses.
- description may contain PHI if physician describes a specific patient issue -- treat as sensitive.

---

## Codebase Context

- **DB schemas location:** `packages/shared/src/schemas/db/`. Follow existing Drizzle table definition patterns from other domains.
- **PostgreSQL via Drizzle ORM.** Use `pgTable`, `uuid`, `varchar`, `text`, `timestamp`, `integer`, `jsonb`, `boolean` from `drizzle-orm/pg-core`.
- **FK pattern:** Reference `providers` table from D05 schema. Use `.references(() => providers.provider_id)`.
- **Barrel exports:** Update `packages/shared/src/schemas/db/index.ts` and `packages/shared/src/schemas/index.ts` to re-export support schema types.
- **Type inference pattern:** `export type InsertSupportTicket = typeof supportTickets.$inferInsert;` and `export type SelectSupportTicket = typeof supportTickets.$inferSelect;`.
