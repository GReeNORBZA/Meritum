# D13-041: Security: authorization and permission enforcement

**Domain:** 13 â€” Support System
**Task ID:** D13-041
**Depends on:** D13-030, D13-031
**Verify:** `pnpm --filter api vitest run test/security/support/support.authz.security.ts`

---

## Build Instructions

Create `apps/api/test/security/support/support.authz.security.ts`.

Test permission-based access control:

**Any authenticated user can:**
- Create support tickets (no specific permission required beyond authentication)
- View their own tickets
- Rate their own resolved tickets
- Submit article feedback

**Delegate context:**
- Delegate creates ticket -> ticket linked to physician's provider_id from active context, not delegate's user_id.
- Delegate views tickets -> sees physician's tickets (scoped to active physician context).
- Delegate rates ticket -> rating on physician's ticket (delegate acting on behalf).

**Admin-only operations (if admin endpoints implemented):**
- Non-admin cannot update ticket status, category, priority, or assigned_to.
- Non-admin cannot access triage queue or SLA breach reports.

**No special permissions required for support access** -- support is available to all authenticated users regardless of role/permissions. This is intentional: even a delegate with minimal permissions should be able to seek help.

---

## Security Requirements

- Support is universally accessible to all authenticated users -- no permission gating.
- Delegate tickets linked to physician context -- ensures support team sees physician's account, not delegate's.
- Admin operations restricted -- physicians cannot self-triage or manipulate ticket status.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/support/`. Follow existing authorization security test patterns.
- **Role testing:** Create test users with different roles (physician, delegate, admin) and verify each can or cannot access specific operations.
- **Delegate context pattern:** When testing delegate access, the session should contain the delegate's user ID but the physician's provider_id in the context. This mirrors the actual delegate authentication flow.
- **Auth pattern:** Session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. Roles: physician, delegate, admin.
- **Admin endpoint testing:** If admin ticket management endpoints exist, verify that physician and delegate roles receive 403 when attempting to access them.
- **Universal support access:** This is a deliberate design decision -- support should never be gated behind specific permissions. The test should verify that all authenticated roles (physician, delegate, admin) can create tickets and submit feedback.
