# D13-043: Security: input validation — injection, file upload, boundary values

**Domain:** 13 — Support System
**Task ID:** D13-043
**Depends on:** D13-030, D13-031
**Verify:** `pnpm --filter api vitest run test/security/support/support.input.security.ts`

---

## Build Instructions

Create `apps/api/test/security/support/support.input.security.ts`.

**SQL injection attempts:**
- search query: `'; DROP TABLE help_articles; --` -> 400 or sanitised (tsquery special chars stripped)
- subject: injection payload -> 400
- article slug: `../../../etc/passwd` -> 400 (slug validated: alphanumeric + hyphens only)
- ticket_id param: injection payload -> 400

**XSS attempts:**
- description: `<script>alert('xss')</script>` -> 400 or stored safely (HTML escaped on output)
- subject: HTML injection -> 400 or sanitised
- search query: `<img onerror=alert(1)>` -> sanitised before tsquery
- satisfaction_comment: script tags -> 400 or sanitised

**File upload attacks:**
- Screenshot > 5MB -> 400
- Screenshot with executable extension (.exe, .sh, .js) -> 400
- Screenshot with valid image extension but executable content -> validate content-type server-side
- Screenshot with path traversal filename (../../evil.png) -> filename sanitised
- No screenshot (optional field) -> valid, ticket created without screenshot
- Multiple screenshots -> only first accepted (single file upload)

**Type coercion:**
- rating: 0 -> 400 (must be 1-5)
- rating: 6 -> 400
- rating: 'five' -> 400
- rating: 3.5 -> 400 (must be integer)
- is_helpful: 'true' as string -> should be boolean

**Boundary values:**
- subject: 201 chars -> 400 (max 200)
- description: 5001 chars -> 400 (max 5000)
- context_url: non-HTTPS URL -> 400
- context_url: javascript:alert(1) -> 400
- slug: special characters -> 400 (alphanumeric + hyphens only)
- search: 201 chars -> 400 (max 200)

All invalid inputs return 400 with generic error messages.

---

## Security Requirements

- tsquery injection prevented by sanitising special characters before search.
- File upload validation must check content-type server-side, not rely on client-provided extension.
- Path traversal in filenames sanitised -- filename stripped to safe characters.
- context_url must be HTTPS -- prevents javascript: and data: URI injection.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/support/`.
- **Input validation tests:** These tests verify that the Zod validation schemas (D13-005) correctly reject invalid input at the route level. Each test sends a malformed request and expects a 400 response.
- **File upload testing:** Create test files with various sizes and content types. For oversized files, generate a buffer > 5MB. For wrong content types, send a file with an image extension but non-image content.
- **Boundary value testing:** Test at the exact boundaries (200 chars OK, 201 chars rejected) to verify the Zod schema constraints are correctly configured.
- **Generic error messages:** Verify that 400 responses contain validation error details but do not expose internal schema structure, database column names, or stack traces.
- **tsquery sanitisation:** The search endpoint should strip special tsquery characters before passing to PostgreSQL. Test that payloads containing `& | ! ( ) : * < >` are handled safely.
