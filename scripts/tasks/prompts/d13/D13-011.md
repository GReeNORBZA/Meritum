# D13-011: Support tickets repository — CRUD, status tracking, SLA queries

**Domain:** 13 — Support System
**Task ID:** D13-011
**Depends on:** D13-006
**Verify:** `pnpm --filter api vitest run src/domains/support/repos/support-tickets.repo.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/support/repos/support-tickets.repo.ts` and test file.

**Methods (physician-facing — require providerId):**

- `create(data: InsertSupportTicket)` — create new ticket with status OPEN. Auto-set priority to URGENT if context_metadata contains batch failure indicators.
- `getById(ticketId, providerId)` — fetch ticket by ID scoped to provider. Return null for wrong provider (404 pattern).
- `listByProvider(providerId, filters?)` — list tickets with optional status filter. Paginated. Ordered by created_at DESC.
- `addRating(ticketId, providerId, rating, comment?)` — set satisfaction_rating and satisfaction_comment. Only if status is RESOLVED or CLOSED. Return null for wrong provider.

**Admin methods (support team — no provider scoping):**
- `updateTicket(ticketId, data: Partial)` — update status, category, priority, assigned_to, resolution_notes, resolved_at. Set updated_at.
- `listAllTickets(filters?)` — list all tickets with status/priority/category/assigned_to filters. For support team triage queue.
- `getSlaBreach()` — return tickets that have exceeded their SLA first-response or resolution targets based on priority and created_at/resolved_at.

**Screenshot handling:**
- `setScreenshotPath(ticketId, providerId, path)` — store screenshot file path after upload processing.

Unit tests: create sets OPEN status, auto-URGENT for batch failures, provider scoping returns null for wrong provider, status transitions, rating only on resolved tickets, SLA breach detection.

---

## FRD References

- Domain 13 Section 3.2: support_tickets table and status lifecycle.
- Domain 13 Section 3.3: SLA targets by priority (Table 3).
- Domain 13 Section 6: Ticket CRUD endpoints (Table 5).
- Domain 13 Section 5: SUP-005 satisfaction rating after resolution.

---

## Security Requirements

- Physician-facing methods require providerId -- no cross-physician ticket access.
- getById returns null for wrong provider -- 404 pattern, don't confirm existence.
- Admin methods used by support team only -- access controlled at route level.
- screenshot_path never returned in physician-facing API responses.
- Rating only allowed on RESOLVED or CLOSED tickets -- prevents premature rating.

---

## Codebase Context

- **Repository location:** `apps/api/src/domains/support/repos/`. Follow existing repository patterns from other domains.
- **Test co-location:** Unit tests go in the same directory as `support-tickets.repo.test.ts`.
- **Provider scoping pattern:** Always include `providerId` in WHERE clause for physician-facing queries. This is the primary tenant isolation mechanism. Follow the pattern used in D04 claims and D06 patients.
- **404 pattern (not 403):** When a physician requests a ticket they don't own, return null (which the route converts to 404). Never return 403 -- that would confirm the ticket exists.
- **Auto-URGENT detection:** Check `context_metadata` for keys like `batch_error`, `batch_id` with error indicators, or specific error codes that signal batch submission failures.
- **SLA calculation:** Business hours are Mon-Fri 08:00-18:00 MT, with Thursday extended to 06:00-22:00 MT. SLA breach detection compares elapsed business hours against the thresholds from D13-001 constants.
- **Drizzle update pattern:** Use `db.update().set({ ...data, updated_at: new Date() }).where(...)` to ensure updated_at is always refreshed.
