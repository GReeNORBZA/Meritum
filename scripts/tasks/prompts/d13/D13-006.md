# D13-006: Database migration for all Domain 13 tables

**Domain:** 13 â€” Support System
**Task ID:** D13-006
**Depends on:** D13-002, D13-003, D13-004
**Verify:** `pnpm --filter api drizzle-kit generate && pnpm --filter api drizzle-kit migrate`

---

## Build Instructions

Generate and run Drizzle migration for Domain 13 tables.

The migration should create:
1. support_tickets table with all columns, indexes, FK to providers
2. help_articles table with all columns, indexes, full-text search vector and trigger
3. article_feedback table with all columns, indexes, FKs to help_articles and providers

**Full-text search setup:**
Create trigger on help_articles:
```sql
CREATE OR REPLACE FUNCTION update_article_search_vector() RETURNS trigger AS $$
BEGIN
  NEW.search_vector := to_tsvector('english', COALESCE(NEW.title, '') || ' ' || COALESCE(NEW.content, ''));
  RETURN NEW;
END
$$ LANGUAGE plpgsql;

CREATE TRIGGER articles_search_vector_update
  BEFORE INSERT OR UPDATE ON help_articles
  FOR EACH ROW EXECUTE FUNCTION update_article_search_vector();
```

Run `pnpm --filter api drizzle-kit generate` then `pnpm --filter api drizzle-kit migrate`.
Verify all tables exist, full-text search trigger fires on article insert.

---

## FRD References

- Domain 13 Section 2.2: Full-text search across all articles.
- Domain 13 Section 3.2: support_tickets table.
- Domain 13 Section 2.2: Feedback loop -- article_feedback table.

---

## Security Requirements

- FK constraints ensure referential integrity.
- Full-text search uses built-in PostgreSQL tsvector -- no external search engine required at MVP.

---

## Codebase Context

- **Migration generation:** Use `pnpm --filter api drizzle-kit generate` to auto-generate the SQL migration from the Drizzle schema definitions.
- **Migration execution:** Use `pnpm --filter api drizzle-kit migrate` to apply migrations.
- **Custom SQL in migrations:** The full-text search trigger function and trigger creation may need to be added as custom SQL in the generated migration file, since Drizzle ORM does not natively generate trigger DDL.
- **Existing migration pattern:** Check existing migrations in the project for how custom SQL (triggers, functions) has been added in prior domains.
- **PostgreSQL tsvector:** The `search_vector` column uses PostgreSQL's native full-text search. The trigger auto-populates this column on INSERT and UPDATE, so application code does not need to set it manually.
