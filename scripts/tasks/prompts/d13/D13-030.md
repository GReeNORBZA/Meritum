# D13-030: Help centre routes — article search, category listing, feedback

**Domain:** 13 — Support System
**Task ID:** D13-030
**Depends on:** D13-020, D13-005
**Verify:** `pnpm --filter api vitest run src/domains/support/routes/help.routes.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/support/routes/help.routes.ts` and test file.

Register Fastify routes. Article listing and search are public (no auth required for help.meritum.ca). Feedback requires authentication.

**Routes:**

1. `GET /api/v1/help/articles` — query validated by ArticleListQuerySchema. Search or list articles. Public endpoint (no auth). If search param provided -> full-text search. If category param -> category listing. Returns article list with slug, title, category, summary.
2. `GET /api/v1/help/articles/:slug` — param validated by ArticleSlugParamSchema. Get full article content. Public endpoint. 404 if slug not found or unpublished.
3. `POST /api/v1/help/articles/:slug/feedback` — body validated by ArticleFeedbackSchema. Submit feedback. **Requires authentication.** Permission: any authenticated user. 404 if article not found.

Route-level unit tests: search returns results, category filter works, slug lookup, feedback requires auth, 404 for unknown slug.

---

## FRD References

- Domain 13 Section 6: Help centre endpoints (Table 5 rows 1-3).
- Domain 13 Section 2.2: Searchable, feedback loop.
- Domain 13 Open Questions #1: Hybrid approach -- help articles publicly accessible for SEO.

---

## Security Requirements

- Article listing and viewing are public -- no auth required (supports help.meritum.ca public access).
- Feedback requires authentication -- prevents anonymous vote manipulation.
- Public endpoints must not leak any user data or session info.

---

## Codebase Context

- **Routes location:** `apps/api/src/domains/support/routes/`. Follow existing Fastify route registration patterns from other domains.
- **Test co-location:** Unit tests go in the same directory as `help.routes.test.ts`.
- **Fastify 5 route pattern:** Register routes as a Fastify plugin. Use `fastify.get()`, `fastify.post()` with schema validation via Zod schemas from D13-005.
- **Public vs authenticated routes:** For public routes, do NOT apply the auth preHandler hook. For the feedback route, apply the session auth middleware that checks `request.session.user`.
- **Auth pattern:** Session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. The auth preHandler returns 401 if no valid session.
- **Validation integration:** Import Zod schemas from `packages/shared/src/schemas/validation/support.validation.ts` and use them for request validation (query, params, body).
- **Response pattern:** Follow existing API response patterns (likely `{ data: ... }` or `{ success: true, data: ... }` wrapper).
- **Existing domains for route reference:** Check D04 claims routes or D06 patient routes for the standard Fastify route registration pattern used in the monorepo.
