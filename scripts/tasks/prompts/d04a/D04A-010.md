# Task D04A-010: Repository — AHCIP claim details CRUD (create, read, update with base claim join)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/src/domains/ahcip/ahcip.repository.ts`:

- `createAhcipDetail(data: InsertAhcipClaimDetail)` — insert AHCIP extension row linked to base claim. Return ahcip_detail_id.
- `findAhcipDetailByClaimId(claimId: string, physicianId: string)` — join ahcip_claim_details with claims to get full claim + AHCIP detail. Scoped to physician via claims.physician_id. Return null if not found or wrong physician.
- `updateAhcipDetail(claimId: string, physicianId: string, data: Partial<InsertAhcipClaimDetail>)` — update AHCIP-specific fields. Verify physician ownership via join.
- `findAhcipClaimWithDetails(claimId: string, physicianId: string)` — full claim + AHCIP details + patient info (name, PHN, DOB) via joins. For display/validation.
- `listAhcipClaimsForBatch(physicianId: string, baNumber: string, isClean?: boolean)` — find queued AHCIP claims for batch assembly. Filtered by BA number for PCPCM dual-BA routing.
- `updateAssessmentResult(claimId: string, assessedFee: number, explanatoryCodes: any)` — set assessed_fee and assessment_explanatory_codes after assessment ingestion.

**CRITICAL:** All queries MUST include `physician_id` scoping via the claims table join. No repository function should query ahcip_claim_details without physician scoping.

Use Drizzle ORM query builder with the AHCIP schema from `packages/shared/src/schemas/db/ahcip.schema.ts`. Accept a Drizzle database instance via dependency injection. Follow existing repository patterns in the codebase (check `apps/api/src/domains/claim/` for reference).

Create `apps/api/src/domains/ahcip/ahcip.test.ts` with unit tests.

## Security Requirements

- All queries join through claims.physician_id for tenant isolation. Never query ahcip_claim_details without physician scoping.
- findAhcipDetailByClaimId returns null (not 403) for wrong physician.
- listAhcipClaimsForBatch must verify claims are in QUEUED state and claim_type = AHCIP.

## Required Tests

Create tests in `apps/api/src/domains/ahcip/ahcip.test.ts`:

- createAhcipDetail creates extension row linked to base claim
- findAhcipDetailByClaimId returns detail for owning physician
- findAhcipDetailByClaimId returns null for different physician
- updateAhcipDetail updates AHCIP fields
- updateAhcipDetail rejects update for wrong physician
- findAhcipClaimWithDetails returns joined claim + detail + patient
- listAhcipClaimsForBatch returns only queued AHCIP claims for BA
- listAhcipClaimsForBatch filters by ba_number for PCPCM routing
- updateAssessmentResult stores assessed fee and explanatory codes

## Dependencies

- D04A-005 must be complete (database migration applied, AHCIP tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
