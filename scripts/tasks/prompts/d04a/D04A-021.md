# Task D04A-021: Service — AHCIP validation module (A1–A19 checks, pathway delegation interface)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:

- `validateAhcipClaim(claimId: string, physicianId: string)` — implements the pathway delegation interface from Domain 4.0. Runs AHCIP-specific validation checks A1–A19 after shared checks have passed.

**AHCIP validation pipeline (ordered):**
A1: HSC code valid — exists in current SOMB schedule (version-aware by DOS). Calls Reference Data.
A2: HSC active on DOS — code was active on date_of_service. Check effective date ranges.
A3: BA number valid — ba_number is valid, active BA for physician. Calls Provider Management.
A4: Governing rules — evaluate all applicable GRs for the HSC code. Calls Reference Data for GR definitions.
A5: Modifier eligibility — each modifier valid for the HSC code and context.
A6: Modifier combination — modifier pairs are valid (no mutually exclusive combinations).
A7: Diagnostic code required — if HSC category requires ICD-9, validate present and valid.
A8: Facility required — hospital-based encounters need facility_number.
A9: Referral required (GR 8) — specialist consultations need referring practitioner.
A10: DI surcharge eligibility — DI code surcharge conditions met (Warning).
A11: PCPCM routing — basket classification correct for PCPCM physicians (Warning).
A12: After-hours eligibility — HSC permits after-hours premium and time qualifies (Warning).
A13: 90-day window — error if expired, warning if within 7 days (shared S6 overlap, AHCIP-specific).
A14: Time-based code duration — time_spent present and within valid range for time-based codes.
A15: Call count valid — calls within valid range for HSC code.
A16: Shadow billing consistency — TM modifier ↔ shadow_billing_flag consistency (Warning).
A17: RRNP eligibility — calculate and note RRNP premium if physician qualifies (Info).
A18: Premium eligibility (351) — check 351 premium code list (Info).
A19: Bundling check — potential bundling with other claims, same patient same DOS (Warning).

Return AHCIP-specific ValidationResult entries to merge with shared results.

Follow existing service patterns in the codebase. See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 5.1: AHCIP validation pipeline — 19 checks with severity assignments.
- Domain 4.1 Section 5.2: Governing rules overview — GR 1,3,5,8,10,14,18.
- Domain 4.1 Table 6: Full check table with severity and descriptions.

## Security Requirements

- Validation always uses current Reference Data version — no caching stale SOMB rules.
- reference_data_version recorded for audit traceability on every validation run.
- Governing rule evaluation must be deterministic — same input always produces same result.

## Required Tests

Add tests to `apps/api/src/domains/ahcip/ahcip.test.ts`:

- A1: valid HSC code passes
- A1: invalid HSC code returns error
- A2: HSC active on DOS passes
- A2: retired HSC code on DOS returns error
- A3: valid BA number passes
- A3: invalid BA number returns error
- A4: GR 3 visit limit exceeded returns error
- A4: GR 8 referral missing returns error
- A5: valid modifier for HSC passes
- A5: invalid modifier for HSC returns error
- A6: mutually exclusive modifiers returns error
- A7: missing required diagnostic code returns error
- A8: missing facility for hospital claim returns error
- A9: missing referral for specialist consultation returns error
- A13: expired 90-day window returns error
- A13: within 7 days of deadline returns warning
- A14: missing time_spent for time-based code returns error
- A16: shadow billing inconsistency returns warning
- A19: potential bundling returns warning

## Dependencies

- D04A-010 must be complete (AHCIP claim details repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
