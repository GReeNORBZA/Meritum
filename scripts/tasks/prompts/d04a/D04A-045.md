# Task D04A-045: Security — audit trail completeness for AHCIP batch lifecycle

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/test/security/ahcip/ahcip.audit.security.ts`.

Verify every significant AHCIP action produces audit records.

**Batch lifecycle audit:**
- Batch assembled → audit entry with claim count and total value
- Batch generated (H-Link file) → audit entry with file_hash
- Batch submitted (transmitted) → audit entry with submission_reference and timestamp
- Batch transmission failed → audit entry with error details
- Batch retry initiated → audit entry
- Assessment ingested → audit entry with accepted/rejected/adjusted counts
- Payment reconciled → audit entry with batch total

**Claim-level audit (via Domain 4.0 claim_audit_history):**
- AHCIP claim created → CREATED with claim_type = AHCIP
- AHCIP detail updated → EDITED with field-level changes
- Fee calculated → audit entry with fee breakdown
- Assessment result applied → ASSESSED/REJECTED with details

**Submission preference audit:**
- Auto-submission mode change → audit entry with old and new mode

**Audit log integrity:**
- No UPDATE/DELETE operations on audit entries
- H-Link transmission logs contain no PHI (no patient data, only batch references)

Use the test helpers/fixtures from the project. Follow the security test patterns established in Domain 4.0 (check `apps/api/test/security/claim/claim.audit.security.ts` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D04A-030 must be complete (all AHCIP routes registered).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/ahcip/ahcip.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
