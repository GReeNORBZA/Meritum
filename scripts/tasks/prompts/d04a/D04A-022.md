# Task D04A-022: Service — AHCIP fee calculation engine (base fee, modifiers, premiums, RRNP, PCPCM, shadow billing)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:

- `calculateFee(claimId: string, physicianId: string)` — calculate submitted_fee for an AHCIP claim. Store result on ahcip_claim_details.submitted_fee.
- `calculateFeePreview(physicianId: string, data: FeeCalculateInput)` — calculate fee without saving. For UI preview/estimation.
- `getFeeBreakdown(claimId: string, physicianId: string)` — return detailed breakdown: { base_fee, calls, modifier_adjustments: [{modifier, effect, amount}], premiums: [{type, amount}], rrnp_premium, total_fee }.

**Fee formula:**
submitted_fee = (base_fee x calls) + modifier_adjustments + premiums

**Steps:**
1. Look up base_fee from SOMB schedule for HSC code (version-aware by DOS). Calls Reference Data.
2. Apply modifier adjustments in SOMB-defined priority order. Each modifier: percentage-based or additive. Calls Reference Data for modifier fee impact matrix.
3. Calculate premiums independently:
   - CMGP premium: if CMGP modifier present and HSC qualifies
   - After-hours premium: based on after_hours_type and HSC category
   - RRNP premium: flat addition if physician qualifies (from Provider Mgmt) and community rate (from Reference Data)
   - ED surcharge (13.99H): if applicable
4. Shadow billing override: if shadow_billing_flag = true (TM modifier), set total to $0.00.
5. PCPCM in-basket: for capitated codes, fee is calculated for tracking but may be $0 depending on billing arrangement.

Follow existing service patterns in the codebase. See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 6.1: Fee formula — base_fee x calls + modifier_adjustments + premiums.
- Domain 4.1 Section 6.2: Modifier fee impact matrix — from Reference Data.
- Domain 4.1 Section 6.3: RRNP premium — flat addition by community code, quarterly rates.
- Domain 4.1 Section 6.4: PCPCM fee routing — in-basket vs out-of-basket.
- Domain 4.1 Section 6.5: After-hours premium by time slot.
- Domain 4.1 Table 8: Modifier codes and fee impacts.

## Required Tests

Add tests to `apps/api/src/domains/ahcip/ahcip.test.ts`:

- calculateFee returns correct base fee from SOMB
- calculateFee applies modifier adjustments in priority order
- calculateFee adds CMGP premium for qualifying code
- calculateFee adds after-hours premium for evening
- calculateFee adds after-hours premium for weekend
- calculateFee adds after-hours premium for stat holiday
- calculateFee adds RRNP premium for qualifying physician
- calculateFee returns $0 for shadow billing (TM modifier)
- calculateFee handles multiple calls correctly
- calculateFeePreview returns result without saving
- getFeeBreakdown returns itemised breakdown
- calculateFee applies ED surcharge (13.99H)
- calculateFee handles PCPCM in-basket code

## Dependencies

- D04A-010 must be complete (AHCIP claim details repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
