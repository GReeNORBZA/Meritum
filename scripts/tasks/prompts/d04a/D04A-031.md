# Task D04A-031: Integration tests — AHCIP billing scenarios end-to-end

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/test/integration/ahcip/billing-scenarios.integration.ts`.

**End-to-end billing scenarios (each is a full lifecycle: create → validate → queue → batch → assess → paid):**

1. FFS clinic visit with CMGP + after-hours + RRNP premium
2. Shadow billing (ARP with TM modifier) — fee = $0, claim recorded, tracked
3. PCPCM hybrid dual-BA — in-basket code → PCPCM BA batch, out-of-basket → FFS BA batch
4. ED shift with surcharge (13.99H) + after-hours (AFHR) + CMGP
5. Hospital inpatient with GR 3 visit limits — test limit exceeded rejection
6. Specialist consultation with GR 8 referral — test missing referral rejection
7. Virtual care visit — correct encounter_type and modifiers
8. Rejected claim → correct → resubmit → paid lifecycle

**Batch cycle tests:**
- Claims queued before Thursday cutoff included in batch
- Claims queued after cutoff held until next Thursday
- PCPCM physician gets two separate batches (FFS BA + PCPCM BA)
- Pre-submission validation removes invalid claims from batch

**Assessment ingestion:**
- Mixed results batch: some accepted, some rejected, some adjusted
- Explanatory codes resolved to descriptions
- Payment reconciliation transitions to PAID

Follow existing integration test patterns in the codebase (check `apps/api/test/integration/claim/` for reference). See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 10.5: 13 billing scenario tests — FFS, shadow billing, PCPCM, ED shift, hospital, specialist, obstetric, virtual, reciprocal, locum, radiologist, rejection, deadline.

## Required Tests

- Scenario: FFS clinic visit with CMGP + after-hours + RRNP
- Scenario: Shadow billing produces $0 fee
- Scenario: PCPCM dual-BA creates two batches
- Scenario: ED shift with surcharge + after-hours
- Scenario: GR 3 visit limit rejection
- Scenario: GR 8 missing referral rejection
- Scenario: Virtual care visit
- Scenario: Rejected → correct → resubmit → paid
- Batch: cutoff enforcement
- Batch: pre-submission validation removes invalid
- Assessment: mixed results processing
- Assessment: payment reconciliation

## Dependencies

- D04A-030 must be complete (all AHCIP routes registered).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/ahcip/
```

All tests must pass before outputting [TASK_COMPLETE].
