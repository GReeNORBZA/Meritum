# Task D04A-024: Service — assessment response ingestion (file parsing, claim matching, state transitions, payment reconciliation)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:

- `ingestAssessmentFile(batchId: string)` — retrieve assessment file from H-Link (SFTP pull / API). Parse per H-Link response format. Match each record to submitted claims by submission reference. Process results.
- `processAssessmentRecord(record: AssessmentRecord)` — for each record in the assessment file:
  - Accepted: transition claim SUBMITTED → ASSESSED. Store assessed_fee. If assessed_fee === submitted_fee, clean acceptance.
  - Rejected: transition claim SUBMITTED → REJECTED. Store assessment_explanatory_codes. Resolve codes to descriptions via Reference Data. Emit CLAIM_REJECTED notification.
  - Adjusted: transition claim SUBMITTED → ASSESSED. Store assessed_fee (differs from submitted_fee). Flag for physician review. Emit notification.
- `reconcilePayment(batchId: string)` — when payment confirmed (Friday deposit): transition ASSESSED claims to PAID. Update batch status to RECONCILED. Emit CLAIM_PAID notifications.
- `getAssessmentResults(batchId: string, physicianId: string)` — return batch assessment results with per-claim status.
- `listBatchesAwaitingResponse(physicianId: string)` — list SUBMITTED batches.

**Explanatory code resolution:** Lookup each code in Reference Data to get human-readable description and corrective guidance. For common rejections, generate one-click corrective actions.

**Unmatched records:** If an assessment record cannot be matched to a submitted claim, log as anomaly and alert for manual resolution.

Follow existing service patterns in the codebase. See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 7.1: Assessment file retrieval — SFTP pull or API per H-Link spec.
- Domain 4.1 Section 7.2: Ingestion workflow — parse, match, accepted/rejected/adjusted transitions, notifications, batch status update.
- Domain 4.1 Section 7.3: Explanatory codes — resolved via Reference Data, corrective guidance, one-click actions.

## Security Requirements

- Assessment files retrieved via secure channel. Raw files retained encrypted for audit.
- Assessment files contain PHI — processed on Meritum infrastructure within Canadian data residency.
- Unmatched records logged for manual review — no silent data loss.
- Payment reconciliation is final — paid claims enter terminal state.

## Required Tests

Add tests to `apps/api/src/domains/ahcip/ahcip.test.ts`:

- ingestAssessmentFile parses assessment file correctly
- processAssessmentRecord transitions accepted claim to ASSESSED
- processAssessmentRecord stores assessed_fee on accepted claim
- processAssessmentRecord transitions rejected claim to REJECTED
- processAssessmentRecord stores explanatory codes on rejected claim
- processAssessmentRecord handles adjusted claim (different fee)
- processAssessmentRecord resolves explanatory codes via Reference Data
- ingestAssessmentFile handles unmatched records gracefully
- ingestAssessmentFile handles mixed results (accepted + rejected + adjusted)
- reconcilePayment transitions ASSESSED claims to PAID
- reconcilePayment updates batch status to RECONCILED
- getAssessmentResults returns per-claim results for physician
- listBatchesAwaitingResponse returns only SUBMITTED batches

## Dependencies

- D04A-010 must be complete (AHCIP claim details repository).
- D04A-011 must be complete (AHCIP batches repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
