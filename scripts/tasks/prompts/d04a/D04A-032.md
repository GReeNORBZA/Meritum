# Task D04A-032: Integration tests — validation pipeline, fee calculation, and H-Link file generation

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/test/integration/ahcip/validation.integration.ts`, `fee-calculation.integration.ts`, `hlink-file.integration.ts`.

**Validation pipeline tests:**
- Each AHCIP check A1–A19 with positive and negative cases
- GR 3 visit limit: boundary cases (at limit, over limit)
- GR 8 referral: present vs missing
- Modifier eligibility: valid and invalid for representative codes
- Modifier combinations: valid pairs and mutually exclusive pairs
- 90-day window: exactly 90 days, 91 days, DST transition dates
- PCPCM routing: in-basket and out-of-basket codes
- After-hours: standard, evening, weekend, stat holiday, DST transition

**Fee calculation tests:**
- Base fee from SOMB for representative HSC codes
- Each modifier type's fee impact (TM=$0, AFHR=premium, CMGP=premium)
- RRNP premium for qualifying vs non-qualifying community
- PCPCM in-basket vs out-of-basket fee handling
- Shadow billing: TM produces $0 total
- Bundling discount per governing rules

**H-Link file generation tests:**
- File header: correct submitter prefix, date, count, vendor ID
- File trailer: record count matches header, total value checksum correct
- Claim records ordered by DOS ascending
- Special character handling in patient names
- Empty optional fields correctly handled

Follow existing integration test patterns in the codebase. See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 10.1: Validation tests — each A1–A19 check, governing rules, modifiers, 90-day window, PCPCM, after-hours, DI surcharge.
- Domain 4.1 Section 10.2: Fee calculation tests — base fee, modifier impacts, RRNP, PCPCM, shadow billing, bundling.
- Domain 4.1 Section 10.3: H-Link file tests — format, header/trailer, field positioning, special chars, empty fields.

## Required Tests

- Validation: A1–A19 positive and negative cases
- Validation: GR 3 visit limit boundary
- Validation: modifier combination validity
- Validation: 90-day window boundary including DST
- Fee: base fee from SOMB schedule
- Fee: modifier adjustments applied in order
- Fee: RRNP premium added for qualifying community
- Fee: shadow billing produces $0
- Fee: PCPCM routing fee handling
- H-Link: header structure correct
- H-Link: trailer checksum correct
- H-Link: claim ordering by DOS

## Dependencies

- D04A-030 must be complete (all AHCIP routes registered).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/ahcip/
```

All tests must pass before outputting [TASK_COMPLETE].
