# Task D04A-020: Service — AHCIP claim creation with extension data, BA resolution, and PCPCM routing

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/src/domains/ahcip/ahcip.service.ts`:

- `createAhcipClaim(physicianId: string, actorId: string, actorContext: string, baseData: CreateClaimInput, ahcipData: CreateAhcipDetailInput)` — call Domain 4.0 createClaim for base, then create AHCIP extension row. Resolve BA number via Provider Management (PCPCM routing if applicable). Set submission_deadline = DOS + 90 calendar days. Determine pcpcm_basket_flag from Reference Data basket classification. Determine after_hours_flag from service time context.

**BA resolution logic:**
- If physician is NOT PCPCM-enrolled: use their single FFS BA number.
- If physician IS PCPCM-enrolled: lookup HSC basket classification from Reference Data. In-basket → PCPCM BA. Out-of-basket → FFS BA.

**After-hours auto-detection:**
- For ED shift claims: derive from shift start_time/end_time.
- For manual claims: if service time provided, classify per time slot definitions.
- Stat holiday check: call Reference Data for stat holiday list.

**Shadow billing:** If modifier_1 = TM, set shadow_billing_flag = true.

Follow existing service patterns in the codebase (check `apps/api/src/domains/claim/` for reference). See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 6.4: PCPCM fee routing — in-basket to PCPCM BA, out-of-basket to FFS BA.
- Domain 4.1 Section 6.5: After-hours auto-calculation from service time and stat holiday check.
- Domain 4.1 Table 8: TM modifier = shadow billing, fee $0.

## Security Requirements

- BA resolution must come from Provider Management — physician cannot specify arbitrary BA numbers.
- pcpcm_basket_flag derived from Reference Data, not user input — prevents misrouting.
- Shadow billing detection is automatic from TM modifier — cannot be manually overridden to bypass.

## Required Tests

Add tests to `apps/api/src/domains/ahcip/ahcip.test.ts`:

- createAhcipClaim creates base claim + AHCIP detail
- createAhcipClaim resolves FFS BA for non-PCPCM physician
- createAhcipClaim resolves PCPCM BA for in-basket code
- createAhcipClaim resolves FFS BA for out-of-basket code on PCPCM physician
- createAhcipClaim sets submission_deadline to DOS + 90 days
- createAhcipClaim auto-detects after-hours from shift times
- createAhcipClaim detects stat holiday after-hours
- createAhcipClaim sets shadow_billing_flag for TM modifier

## Dependencies

- D04A-010 must be complete (AHCIP claim details repository).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
