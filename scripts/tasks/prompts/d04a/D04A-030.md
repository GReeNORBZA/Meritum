# Task D04A-030: Routes — AHCIP batch management, assessment, fee calculation endpoints

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/src/domains/ahcip/ahcip.routes.ts` and `apps/api/src/domains/ahcip/ahcip.handlers.ts`.

**Batch management (auth required, physician-scoped):**
- GET /api/v1/ahcip/batches → listBatchesHandler (query: listBatchesSchema)
- GET /api/v1/ahcip/batches/next → previewNextBatchHandler
- GET /api/v1/ahcip/batches/:id → getBatchHandler (params: batchIdParamSchema)
- POST /api/v1/ahcip/batches/:id/retry → retryBatchHandler (ERROR status only)

**Assessment (auth required, physician-scoped):**
- GET /api/v1/ahcip/assessments/:batch_id → getAssessmentResultsHandler (params: batchAssessmentParamSchema)
- GET /api/v1/ahcip/assessments/pending → listPendingAssessmentsHandler

**Fee calculation (auth required):**
- POST /api/v1/ahcip/fee-calculate → feeCalculateHandler (body: feeCalculateSchema)
- GET /api/v1/ahcip/claims/:id/fee-breakdown → feeBreakdownHandler (params: claimIdParamSchema)

**Handlers are thin:** validate input via Zod schema on route, call service function, format response.

Create `apps/api/test/integration/ahcip/batches.integration.ts`, `assessment.integration.ts`, and `fee.integration.ts`.

Follow existing route and handler patterns in the codebase (check `apps/api/src/domains/claim/` for reference). See `CLAUDE.md` for coding conventions.

## FRD References

None specific beyond endpoint definitions above.

## Security Requirements

- All endpoints require authentication and are physician-scoped.
- Batch retry only from ERROR status — prevent duplicate submissions.
- Fee calculation preview does not save data — safe for estimation.
- Assessment results contain PHI — scoped to physician.

## Required Tests

Create integration tests:

- GET /ahcip/batches lists physician's batches
- GET /ahcip/batches/next previews next Thursday batch
- GET /ahcip/batches/:id returns batch details
- GET /ahcip/batches/:id returns 404 for different physician
- POST /ahcip/batches/:id/retry retries ERROR batch
- POST /ahcip/batches/:id/retry rejects non-ERROR batch
- GET /ahcip/assessments/:batch_id returns assessment results
- GET /ahcip/assessments/pending returns SUBMITTED batches
- POST /ahcip/fee-calculate returns fee preview
- GET /ahcip/claims/:id/fee-breakdown returns itemised breakdown

## Dependencies

- D04A-020 must be complete (AHCIP claim creation service).
- D04A-021 must be complete (AHCIP validation service).
- D04A-022 must be complete (AHCIP fee calculation service).
- D04A-023 must be complete (batch cycle service).
- D04A-024 must be complete (assessment ingestion service).

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/ahcip/
```

All tests must pass before outputting [TASK_COMPLETE].
