# Task D04A-044: Security — data leakage prevention for AHCIP (PHI in claims, files, assessments)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/test/security/ahcip/ahcip.leakage.security.ts`.

**PHI not in error responses:**
- Validation errors do not expose patient PHN or DOB
- 404 for cross-physician AHCIP claim does not confirm existence
- Fee calculation errors do not leak internal SOMB data structure
- 500 errors expose no internals

**H-Link file security:**
- Generated H-Link files not accessible via direct URL
- file_path not exposed in batch API responses
- H-Link submission_reference not exposed in client-facing API (internal tracking only)

**Assessment data:**
- Assessment results scoped to physician — no cross-physician leakage
- Explanatory codes resolved to descriptions — raw AHCIP response codes not leaked

**Header checks:**
- No X-Powered-By, no Server version
- HSTS and CSP headers present

**H-Link credentials:**
- Submitter prefix and transmission credentials never in API responses
- Credentials never in logs or error messages

Use the test helpers/fixtures from the project. Follow the security test patterns established in Domain 4.0 (check `apps/api/test/security/claim/claim.leakage.security.ts` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D04A-030 must be complete (all AHCIP routes registered).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/ahcip/ahcip.leakage.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
