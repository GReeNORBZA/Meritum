# Task D04A-023: Service — Thursday batch cycle (assembly, H-Link file generation, transmission, retry logic)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Add to `apps/api/src/domains/ahcip/ahcip.service.ts`:

- `assembleBatch(physicianId: string, batchWeek: string)` — group queued AHCIP claims by BA number. For PCPCM physicians, create separate batches per BA. Run pre-submission validation on every claim. Remove failed claims (return to validated, notify). Calculate fee for each claim. Create ahcip_batch record with ASSEMBLING status. Link claims to batch. Transition claims to SUBMITTED. Emit BATCH_ASSEMBLED notification.
- `generateHlinkFile(batchId: string)` — generate H-Link file per Electronic Claims Submission Specifications Manual format. File structure: header (submitter prefix, batch date, record count, vendor ID), claim records (ordered by DOS ascending), trailer (record count, total value checksum). Store encrypted file, set file_path and file_hash. Update batch status to GENERATED.
- `transmitBatch(batchId: string)` — transmit H-Link file via secure channel (SFTP/API). Log transmission result. Update batch status to SUBMITTED with submitted_at timestamp and submission_reference. On failure: retry with exponential backoff (1m, 5m, 15m, 1h). After 4 failures: status = ERROR, emit notification.
- `previewNextBatch(physicianId: string)` — preview what next Thursday's batch will contain without actually assembling.
- `retryFailedBatch(batchId: string, physicianId: string)` — retry transmission for ERROR status batch.

**Batch assembly rules:**
- Claims grouped by physician_id + ba_number
- Only QUEUED + AHCIP claims included
- Auto-submission mode respected (clean/flagged per physician preference)
- Claims ordered by date_of_service ascending within file
- Pre-submission validation runs final time; failed claims removed with notification

**No off-cycle submissions.** Claims queued after Thursday 12:00 MT wait until next Thursday.

Follow existing service patterns in the codebase. See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 3.1: Cycle timeline — Thursday 12:00 cutoff, assembly 12:00–14:00, transmission 14:00+.
- Domain 4.1 Section 3.2: Batch assembly rules — grouped by physician + BA, PCPCM dual-BA, pre-submission validation, DOS ordering.
- Domain 4.1 Section 3.3: No off-cycle submission. Retry with exponential backoff on transmission failure.
- Domain 4.1 Section 4.1: H-Link file structure — header, claim records, trailer.
- Domain 4.1 Section 4.3: Transmission — secure channel, credentials in secrets, retry logic, file stored encrypted.

## Security Requirements

- H-Link credentials (submitter prefix, transmission credentials) from secrets management — never in code or DB.
- Generated files encrypted at rest (AES-256). Stored with batch record for audit and resubmission.
- Transmission via secure channel (SFTP with key auth or TLS 1.3).
- Transmission logged: timestamp, file reference, record count, result.
- Pre-submission validation prevents sending invalid claims to AHCIP.

## Required Tests

Add tests to `apps/api/src/domains/ahcip/ahcip.test.ts`:

- assembleBatch groups claims by BA number
- assembleBatch creates separate batches for PCPCM dual-BA
- assembleBatch removes claims failing pre-submission validation
- assembleBatch calculates fee for each claim
- assembleBatch transitions claims to SUBMITTED
- assembleBatch emits BATCH_ASSEMBLED notification
- generateHlinkFile creates correct header structure
- generateHlinkFile orders claims by DOS ascending
- generateHlinkFile creates correct trailer with count and checksum
- generateHlinkFile stores encrypted file with hash
- transmitBatch updates status to SUBMITTED on success
- transmitBatch retries with exponential backoff on failure
- transmitBatch sets ERROR after max retries
- previewNextBatch returns preview without assembly
- retryFailedBatch retransmits ERROR status batch

## Dependencies

- D04A-010 must be complete (AHCIP claim details repository).
- D04A-011 must be complete (AHCIP batches repository).
- D04A-022 must be complete (fee calculation engine).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
