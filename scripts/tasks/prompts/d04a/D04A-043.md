# Task D04A-043: Security — input validation and injection prevention for AHCIP endpoints

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/test/security/ahcip/ahcip.input.security.ts`.

**SQL injection payloads:**
- health_service_code: `' OR 1=1--`, `03.03A'; DROP TABLE ahcip_claim_details;--`
- ba_number: SQL injection payloads
- diagnostic_code: SQL injection payloads
- referral_practitioner: SQL injection payloads
- functional_centre: SQL injection payloads

**XSS payloads:**
- health_service_code: `<script>alert(1)</script>`
- facility_number: `<img onerror=alert(1) src=x>`

**Type coercion:**
- calls as string where number expected → 400
- calls as negative number → 400
- calls as 0 → 400
- time_spent as negative → 400
- modifier fields exceeding max length → 400

**UUID validation:**
- Non-UUID in batch_id path param → 400
- Non-UUID in claim_id for fee breakdown → 400

**Enum validation:**
- Invalid encounter_type → 400
- Invalid batch status filter → 400

Use the test helpers/fixtures from the project. Follow the security test patterns established in Domain 4.0 (check `apps/api/test/security/claim/claim.input.security.ts` for reference). See `CLAUDE.md` for coding conventions.

## Dependencies

- D04A-030 must be complete (all AHCIP routes registered).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/ahcip/ahcip.input.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
