# Task D04A-011: Repository — AHCIP batches (create, status updates, query, claim-batch linking)

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Add to `apps/api/src/domains/ahcip/ahcip.repository.ts`:

- `createAhcipBatch(data: InsertAhcipBatch)` — insert batch with ASSEMBLING status. Return ahcip_batch_id.
- `findBatchById(batchId: string, physicianId: string)` — physician-scoped batch lookup.
- `updateBatchStatus(batchId: string, status: string, extraFields?: Partial<InsertAhcipBatch>)` — update status and optional fields (file_path, file_hash, submission_reference, submitted_at, response_received_at).
- `listBatches(physicianId: string, filters: ListBatchesFilters)` — paginated list with status and date range filters. Reverse chronological.
- `findNextBatchPreview(physicianId: string)` — preview what the next Thursday batch would contain: list queued AHCIP claims grouped by BA number with counts and total values.
- `findBatchesAwaitingResponse(physicianId: string)` — batches in SUBMITTED status (awaiting assessment).
- `findBatchByWeek(physicianId: string, baNumber: string, batchWeek: string)` — find batch for a specific Thursday cycle + BA.
- `linkClaimsToBatch(claimIds: string[], batchId: string)` — update claims.submitted_batch_id for all claims in the batch.

Use Drizzle ORM query builder. Follow existing repository patterns in the codebase. Add tests to `apps/api/src/domains/ahcip/ahcip.test.ts`.

## Security Requirements

- All batch queries scoped to physician_id. No cross-physician batch access.
- Unique constraint on (physician_id, ba_number, batch_week) enforced at DB level.
- linkClaimsToBatch must run in same transaction as batch assembly.

## Required Tests

Add tests to `apps/api/src/domains/ahcip/ahcip.test.ts`:

- createAhcipBatch creates batch with ASSEMBLING status
- findBatchById returns batch for owning physician
- findBatchById returns null for different physician
- updateBatchStatus transitions status correctly
- listBatches filters by status and date range
- listBatches paginates correctly
- findNextBatchPreview returns queued claims grouped by BA
- findBatchesAwaitingResponse returns only SUBMITTED batches
- findBatchByWeek returns batch for specific cycle
- findBatchByWeek rejects duplicate (unique constraint)
- linkClaimsToBatch sets submitted_batch_id on all claims

## Dependencies

- D04A-005 must be complete (database migration applied, AHCIP tables exist).

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/ahcip/ahcip.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
