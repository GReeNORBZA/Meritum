# Task D04A-002: Drizzle schema for ahcip_claim_details table

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `packages/shared/src/schemas/db/ahcip.schema.ts` starting with the ahcip_claim_details table.

**ahcip_claim_details table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| ahcip_detail_id | UUID | PK | Default: gen_random_uuid() |
| claim_id | UUID FK | NOT NULL, UNIQUE, FK → claims.claim_id | 1:1 with base claim |
| ba_number | VARCHAR(10) | NOT NULL | Resolved from Provider Mgmt based on PCPCM routing |
| functional_centre | VARCHAR(10) | NOT NULL | Hospital, clinic, community code |
| health_service_code | VARCHAR(10) | NOT NULL | Primary HSC code from SOMB |
| modifier_1 | VARCHAR(6) | NULLABLE | Primary modifier (AFHR, TM, CMGP, etc.) |
| modifier_2 | VARCHAR(6) | NULLABLE | Secondary modifier |
| modifier_3 | VARCHAR(6) | NULLABLE | Tertiary modifier |
| diagnostic_code | VARCHAR(8) | NULLABLE | ICD-9, required for certain HSC categories |
| facility_number | VARCHAR(10) | NULLABLE | Required for hospital-based claims |
| referral_practitioner | VARCHAR(10) | NULLABLE | Referring physician billing # (GR 8) |
| encounter_type | VARCHAR(10) | NOT NULL | Consultation, follow-up, procedure, etc. |
| calls | SMALLINT | NOT NULL, DEFAULT 1 | Number of calls billed |
| time_spent | SMALLINT | NULLABLE | Minutes for time-based HSC codes |
| patient_location | VARCHAR(10) | NULLABLE | Inpatient, outpatient, community, virtual |
| shadow_billing_flag | BOOLEAN | NOT NULL, DEFAULT false | True for ARP claims with TM modifier |
| pcpcm_basket_flag | BOOLEAN | NOT NULL, DEFAULT false | True = PCPCM BA, False = FFS BA |
| after_hours_flag | BOOLEAN | NOT NULL, DEFAULT false | Auto-calculated from service time |
| after_hours_type | VARCHAR(20) | NULLABLE | EVENING, WEEKEND, NIGHT, STAT_HOLIDAY |
| submitted_fee | DECIMAL(10,2) | NULLABLE | Calculated fee at submission |
| assessed_fee | DECIMAL(10,2) | NULLABLE | Fee from assessment response |
| assessment_explanatory_codes | JSONB | NULLABLE | Array of explanatory codes |

**Indexes:** unique on claim_id (1:1), (ba_number, health_service_code), (pcpcm_basket_flag).

Export table and inferred types (InsertAhcipClaimDetail, SelectAhcipClaimDetail).

Use Drizzle ORM schema definition patterns consistent with existing schemas in `packages/shared/src/schemas/db/`. See `CLAUDE.md` for coding conventions.

## FRD References

- Domain 4.1 Section 2.1: ahcip_claim_details table — 22 columns. One row per AHCIP claim, linked 1:1 to base claims table. Contains all H-Link file fields.

## Security Requirements

- ahcip_claim_details contain PHI (diagnostic codes, service details). Encrypted at rest.
- claim_id FK enforces 1:1 with base claims — no orphaned AHCIP details.
- assessment_explanatory_codes JSONB may contain payer-specific rejection details — treat as sensitive.

## Dependencies

- D04A-001 must be complete (AHCIP constants for encounter types, after-hours types, etc.).
- Domain 4.0 claims table schema must exist (`packages/shared/src/schemas/db/claim.schema.ts`).

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
