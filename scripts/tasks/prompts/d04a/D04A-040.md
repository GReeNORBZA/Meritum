# Task D04A-040: Security — authentication enforcement on every AHCIP route

## Project Context
- Monorepo: Turborepo + pnpm workspaces
- API: `apps/api` (Fastify 5, TypeScript)
- Shared: `packages/shared` (Drizzle schemas, Zod validators, constants)
- DB: PostgreSQL 16 with Drizzle ORM
- Test: Vitest + Supertest
- Auth: Lucia sessions with RBAC middleware from Domain 1
- All queries MUST include physician_id for tenant isolation (HIA custodian boundary)
- Claims contain PHI — no PHI in logs, errors, or emails. PHN masked as 123******
- Domain 4.0 (Claim Lifecycle Core) provides base claims table, state machine, shared validation (S1-S7)
- This domain extends D04 Core with AHCIP-specific validation (A1-A19), fee calculation, batch cycle, and H-Link file generation

## What to Build

Create `apps/api/test/security/ahcip/ahcip.authn.security.ts`.

Test every authenticated AHCIP route returns 401 without a valid session cookie:

- GET /api/v1/ahcip/batches
- GET /api/v1/ahcip/batches/next
- GET /api/v1/ahcip/batches/:id
- POST /api/v1/ahcip/batches/:id/retry
- GET /api/v1/ahcip/assessments/:batch_id
- GET /api/v1/ahcip/assessments/pending
- POST /api/v1/ahcip/fee-calculate
- GET /api/v1/ahcip/claims/:id/fee-breakdown

For each route: no cookie, expired cookie, tampered cookie → 401 with no data leakage.

**Verification for each test:**
1. Response status is 401.
2. Response body contains only an error object (e.g., `{ error: "Unauthorized" }`).
3. Response body does NOT contain any claim data or internal details.
4. No `Set-Cookie` header in 401 responses (don't create sessions for unauthenticated requests).

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference) and Domain 4.0 (check `apps/api/test/security/claim/` for reference). See `CLAUDE.md` for coding conventions.

## Security Requirements

- 401 responses must not contain any data beyond the error object.
- Tampered cookies must be rejected.
- Expired sessions must return 401.

## Dependencies

- D04A-030 must be complete (all AHCIP routes registered).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/ahcip/ahcip.authn.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
