# D07-011: Repository: ai_provider_learning operations (get/upsert learning state, suppression management)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-006** (database migration must be applied).

## What to Build
Add to `apps/api/src/domains/intel/intel.repository.ts`:

**Provider learning state:**
- `getLearningState(providerId: string, ruleId: string)` — get or return null (lazy creation).
- `getOrCreateLearningState(providerId: string, ruleId: string)` — get existing or insert default state.
- `incrementShown(providerId: string, ruleId: string)` — increment times_shown, set last_shown_at. Create if not exists.
- `recordAcceptance(providerId: string, ruleId: string)` — increment times_accepted. Reset consecutive_dismissals to 0. If is_suppressed, set to false. Set last_feedback_at.
- `recordDismissal(providerId: string, ruleId: string)` — increment times_dismissed and consecutive_dismissals. If consecutive_dismissals >= SUPPRESSION_THRESHOLD (5), set is_suppressed = true. Set last_feedback_at.
- `unsuppressRule(providerId: string, ruleId: string)` — set is_suppressed = false, reset consecutive_dismissals to 0.
- `getSuppressedRules(providerId: string)` — list all suppressed rules for physician.
- `getLearningStateSummary(providerId: string)` — aggregate: suppressed_count, top_accepted_categories (top 3 by acceptance count), total_suggestions_shown, overall_acceptance_rate.
- `getProviderLearningForRules(providerId: string, ruleIds: string[])` — batch fetch learning states for multiple rules. Used during Tier 1 evaluation to check suppression.

**Priority adjustment:**
- `updatePriorityAdjustment(providerId: string, ruleId: string, adjustment: -1 | 0 | 1)` — set priority_adjustment. Derived from acceptance rate thresholds (>70% accepted -> +1, <30% accepted -> -1, else 0).

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- getOrCreateLearningState creates on first call
- getOrCreateLearningState returns existing on second call
- incrementShown increments counter and sets timestamp
- recordAcceptance resets consecutive_dismissals
- recordAcceptance unsuppresses if suppressed
- recordDismissal increments consecutive_dismissals
- recordDismissal auto-suppresses at threshold 5
- unsuppressRule clears suppression and resets counter
- getSuppressedRules returns only suppressed
- getProviderLearningForRules batch fetches correctly

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
