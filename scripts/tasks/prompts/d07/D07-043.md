# D07-043: Security: input validation and injection prevention

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-030** (suggestion routes), **D07-031** (admin routes).

## What to Build
Create `apps/api/test/security/intelligence/intelligence.input.security.ts`.

**SQL injection payloads:**
- dismissed_reason field: `' OR 1=1--`
- rule name field: `'; DROP TABLE ai_rules;--`
- conditions JSONB: attempt to embed SQL in condition values

**XSS payloads:**
- dismissed_reason: `<script>alert(1)</script>`
- rule suggestion_template title: `<img onerror=alert(1) src=x>`
- preferences JSON: XSS in category names

**Type coercion:**
- Send string where number expected for tier
- Send array where string expected for dismissed_reason
- Send null where required
- Send negative value for priority_thresholds

**UUID validation:**
- Non-UUID in /intelligence/suggestions/not-a-uuid/accept -> 400
- Non-UUID in /intelligence/rules/not-a-uuid -> 400
- Non-UUID in /intelligence/claims/not-a-uuid/suggestions -> 400

**Condition tree injection prevention:**
- Rule with condition containing SQL injection in value field -> condition evaluator operates on pre-fetched context, not raw SQL. Verify no SQL executed.
- Rule with cross_claim condition attempting to access other physician's data -> scoped to current physician.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/intelligence/intelligence.input.security.ts
```
Fix any errors before finishing.
