# D07-024: Service: main analyse endpoint — orchestrate Tier 1 sync + Tier 2 async + store on claim

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-021** (Tier 1 execution), **D07-022** (Tier 2 LLM), **D07-023** (Tier 3 + lifecycle).

## What to Build
Add main analysis orchestrator to `apps/api/src/domains/intel/intel.service.ts`:

- `analyseClaim(claimId: string, providerId: string)` — full analysis pipeline:
  1. **Tier 1 (synchronous):** evaluateTier1Rules -> immediate Suggestion[].
  2. **Store Tier 1 results:** write suggestions to claim's ai_coach_suggestions JSONB (Domain 4.0 update).
  3. **Return Tier 1 results** to caller immediately.
  4. **Tier 2 (asynchronous):** fire-and-forget analyseTier2 call:
     - On completion: append Tier 2 suggestions to claim's JSONB.
     - Notify via WebSocket (if connected) or make available via polling.
     - On timeout or failure: no degradation — Tier 1 results already delivered.
  5. **Tier 3:** any Tier 3 flags generated during Tier 1 evaluation or Tier 2 low-confidence are included in the suggestion set.

- `reanalyseClaim(claimId: string, providerId: string)` — re-run analysis after claim update. Clear previous PENDING suggestions, run full pipeline. Preserve ACCEPTED/DISMISSED suggestions.

**WebSocket integration:**
Use @fastify/websocket for real-time Tier 2 result delivery. Channel: `intelligence:claim:{claim_id}`. Event: `tier2_complete` with new suggestions.

**Audit:** all analyse calls logged: intelligence.claim_analysed with claim_id, tier1_count, tier2_triggered, tier3_count.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- analyseClaim returns Tier 1 suggestions synchronously
- analyseClaim stores suggestions on claim JSONB
- analyseClaim triggers Tier 2 asynchronously
- analyseClaim includes Tier 3 flags in results
- Tier 2 results appended to claim JSONB on completion
- Tier 2 timeout does not affect Tier 1 delivery
- reanalyseClaim clears PENDING but preserves ACCEPTED/DISMISSED
- reanalyseClaim runs full pipeline

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
