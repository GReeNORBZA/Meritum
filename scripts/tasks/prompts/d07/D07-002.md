# D07-002: Drizzle schema for ai_rules table

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-001** (Intelligence constants must exist).

## What to Build
Create `packages/shared/src/schemas/db/intelligence.schema.ts` with the ai_rules table:

**ai_rules table:**

| Column | Type | Nullable | Description |
|--------|------|----------|-------------|
| rule_id | UUID | No | PK, gen_random_uuid() |
| name | VARCHAR(100) | No | Human-readable (e.g., 'CMGP Modifier Eligibility') |
| category | VARCHAR(30) | No | Maps to suggestion category enum |
| claim_type | VARCHAR(10) | No | AHCIP, WCB, or BOTH |
| conditions | JSONB | No | Structured condition tree evaluated against claim context |
| suggestion_template | JSONB | No | Template: title, description (with placeholders), revenue_impact formula, source_reference |
| specialty_filter | JSONB | Yes | Array of specialty codes. Null = all specialties |
| priority_formula | VARCHAR(100) | No | Priority calculation expression (e.g., 'revenue_impact > 20 ? HIGH : MEDIUM') |
| is_active | BOOLEAN | No | DEFAULT true. Inactive rules skipped |
| somb_version | VARCHAR(20) | Yes | SOMB version this rule was derived from |
| created_at | TIMESTAMPTZ | No | DEFAULT now() |
| updated_at | TIMESTAMPTZ | No | DEFAULT now() |

**Indexes:** index on (category, is_active), index on (claim_type, is_active), index on somb_version.

**Condition tree JSONB structure (document as TypeScript interface):**
```
type Condition = {
  type: 'field_compare' | 'existence' | 'set_membership' | 'temporal' | 'cross_claim' | 'and' | 'or' | 'not';
  field?: string;  // dot-notation path into claim context
  operator?: '==' | '!=' | '>' | '<' | '>=' | '<=' | 'IS NULL' | 'IS NOT NULL' | 'IN' | 'NOT IN';
  value?: any;  // literal or ref.{reference_data_key}
  children?: Condition[];  // for and/or/not combinators
  query?: CrossClaimQuery;  // for cross_claim type
}
```

**Suggestion template JSONB structure:**
```
type SuggestionTemplate = {
  title: string;  // with {{field}} placeholders
  description: string;  // with {{field}} placeholders
  revenue_impact_formula?: string;  // expression or fixed value
  source_reference: string;
  source_url?: string;
  suggested_changes?: { field: string; value_formula: string }[];
}
```

Export table and inferred types.

## FRD References
- Domain 7 Section 7.1: ai_rules table (12 columns). Section 3.2: Rule structure with condition tree and suggestion template.
- Domain 7 Section 3.3: Rule condition language — 6 condition types (field compare, existence, set membership, temporal, cross-claim, combinators).

## Tests
No specific unit tests for this task — verified by build command.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter shared build
```
Fix any errors before finishing.
