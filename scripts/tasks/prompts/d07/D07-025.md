# D07-025: Service: learning loop — priority adjustment, rejection feedback, specialty cohort recalculation

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-011** (provider learning repository), **D07-012** (cohorts and events repository).

## What to Build
Add learning loop services to `apps/api/src/domains/intel/intel.service.ts`:

**Priority adjustment (called after each accept/dismiss):**
- `recalculatePriorityAdjustment(providerId: string, ruleId: string)` —
  Read learning state. Calculate acceptance_rate = times_accepted / times_shown.
  If acceptance_rate > 0.70 and times_shown >= 5 -> priority_adjustment = +1 (promote).
  If acceptance_rate < 0.30 and times_shown >= 5 -> priority_adjustment = -1 (demote).
  Else -> priority_adjustment = 0.
  Priority never promoted above rule-defined maximum.

**Rejection feedback (called when AHCIP/WCB returns rejection):**
- `processRejectionFeedback(claimId: string, rejectionReason: string)` —
  1. Find dismissed REJECTION_RISK suggestions for this claim.
  2. If a dismissed suggestion predicted this rejection:
     a. Re-enable the rule (unsuppress if suppressed).
     b. Set priority_adjustment = +1 permanently.
     c. Log feedback event for learning analysis.

**Specialty cohort recalculation (nightly job):**
- `recalculateSpecialtyCohorts()` — callable from admin endpoint or scheduled job:
  1. For each (specialty, rule) combination in ai_provider_learning:
     a. Count distinct providers (physician_count).
     b. If physician_count >= 10: calculate aggregate acceptance_rate, median_revenue_impact.
     c. Upsert into ai_specialty_cohorts.
  2. Cohorts with < 10 physicians are not created or are deleted if previously existing.

**New physician initialisation:**
- `getDefaultPriorityForNewProvider(specialtyCode: string, ruleId: string)` — check specialty cohort. If exists and physician_count >= 10, use cohort's acceptance_rate to set initial priority_adjustment. Otherwise use default (0).

## FRD References
- Domain 7 Section 6.1: Learning signals (acceptance, dismissal, rejection history, billing patterns, specialty cohort).
- Domain 7 Section 6.2: Adaptation mechanisms — priority adjustment, suppression, specialty calibration, rejection feedback, seasonal patterns.
- Domain 7 Section 6.3: Privacy — billing patterns only, min 10 physicians per cohort.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- recalculatePriorityAdjustment promotes at >70% acceptance
- recalculatePriorityAdjustment demotes at <30% acceptance
- recalculatePriorityAdjustment requires min 5 times_shown
- processRejectionFeedback re-enables suppressed rule
- processRejectionFeedback increases priority permanently
- processRejectionFeedback ignores claims without dismissed REJECTION_RISK
- recalculateSpecialtyCohorts computes correct aggregates
- recalculateSpecialtyCohorts excludes cohorts < 10 physicians
- getDefaultPriorityForNewProvider uses cohort when available
- getDefaultPriorityForNewProvider returns 0 when no cohort

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
