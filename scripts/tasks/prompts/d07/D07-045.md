# D07-045: Security: audit trail completeness for Intelligence Engine operations

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-030** (suggestion routes), **D07-031** (admin routes).

## What to Build
Create `apps/api/test/security/intelligence/intelligence.audit.security.ts`.

**Suggestion lifecycle events (ai_suggestion_events, append-only):**
- Claim analysed -> GENERATED events for each suggestion
- Suggestion accepted -> ACCEPTED event with revenue_impact
- Suggestion dismissed -> DISMISSED event with dismissed_reason
- Rule suppressed -> SUPPRESSED event
- Rule unsuppressed -> UNSUPPRESSED event

**Domain audit log (Domain 1 audit_log):**
- Claim analysed -> intelligence.claim_analysed with claim_id, suggestion_count
- Suggestion accepted -> intelligence.suggestion_accepted
- Suggestion dismissed -> intelligence.suggestion_dismissed
- Rule created -> intelligence.rule_created (admin)
- Rule updated -> intelligence.rule_updated (admin)
- Rule activated/deactivated -> intelligence.rule_toggled
- SOMB change analysis -> intelligence.somb_analysis_triggered
- Cohort recalculation -> intelligence.cohorts_recalculated

**Audit log integrity:**
- No UPDATE on ai_suggestion_events
- No DELETE on ai_suggestion_events
- Events contain correct provider_id (physician or delegate acting in context)

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/intelligence/intelligence.audit.security.ts
```
Fix any errors before finishing.
