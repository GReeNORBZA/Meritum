# D07-041: Security: authorization and role/permission enforcement

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-030** (suggestion routes), **D07-031** (admin routes).

## What to Build
Create `apps/api/test/security/intelligence/intelligence.authz.security.ts`.

**Permission enforcement:**
- POST /intelligence/analyse without AI_COACH_VIEW -> 403
- POST /intelligence/suggestions/:id/accept without AI_COACH_MANAGE -> 403
- POST /intelligence/suggestions/:id/dismiss without AI_COACH_MANAGE -> 403
- PUT /intelligence/me/preferences without AI_COACH_MANAGE -> 403

**Admin-only enforcement:**
- POST /intelligence/rules as non-admin -> 403
- PUT /intelligence/rules/:id as non-admin -> 403
- PUT /intelligence/rules/:id/activate as non-admin -> 403
- GET /intelligence/rules/:id/stats as non-admin -> 403
- POST /intelligence/cohorts/recalculate as non-admin -> 403
- POST /intelligence/somb-change-analysis as non-admin -> 403

**Physician transparency (non-admin sees limited rule data):**
- GET /intelligence/rules as physician -> returns name + category only, no conditions JSONB
- GET /intelligence/rules as admin -> returns full rule including conditions

**Delegate permissions:**
- Delegate with AI_COACH_VIEW -> can view suggestions
- Delegate without AI_COACH_MANAGE -> cannot accept/dismiss suggestions

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/intelligence/intelligence.authz.security.ts
```
Fix any errors before finishing.
