# D07-020: Service: Tier 1 deterministic rules engine — condition evaluator and claim context builder

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-010**, **D07-011** (repository layer for rules and learning state).

## What to Build
Create `apps/api/src/domains/intel/intel.service.ts` with the Tier 1 rules engine:

**Claim context builder:**
- `buildClaimContext(claimId: string, providerId: string)` — assemble the context object from:
  - Claim fields (Domain 4.0): HSC, modifiers, DI codes, dates, time_spent, etc.
  - Patient demographics (anonymised — no PHN, no name, just age/gender for rule evaluation)
  - Provider context (specialty, practice location, billing patterns from Domain 5)
  - Reference Data lookups (SOMB code details, governing rules, modifier eligibility lists)
  - Claim history for cross-claim queries (same patient, same period)

**Condition evaluator:**
- `evaluateCondition(condition: Condition, context: ClaimContext)` — recursive evaluator for condition tree:
  - field_compare: extract field value from context via dot-notation path, compare with operator
  - existence: check IS NULL / IS NOT NULL
  - set_membership: check if value is IN or NOT IN a reference set (resolved from ref.{key})
  - temporal: evaluate time-based conditions (weekday, time ranges, date arithmetic)
  - cross_claim: execute pre-fetched cross-claim aggregation (COUNT/SUM with filters)
  - and/or/not: recursive evaluation of children array
  Return boolean.

**IMPORTANT:** The evaluator operates on a pre-fetched context object, NOT raw database queries. This prevents SQL injection from condition JSONB. All Reference Data lookups are resolved during context building, not during evaluation.

## Security Requirements
- Condition evaluator NEVER executes raw SQL. All data is pre-fetched into the context object.
- Cross-claim queries are parameterised and scoped to the current physician's data.
- Patient PHN and name are excluded from claim context — only age/gender for demographic rules.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- buildClaimContext assembles claim, provider, and reference data
- buildClaimContext anonymises patient (no PHN, no name)
- evaluateCondition: field_compare == returns true for match
- evaluateCondition: field_compare > returns true for greater
- evaluateCondition: existence IS NULL returns true for null field
- evaluateCondition: set_membership IN returns true for member
- evaluateCondition: temporal weekday check works
- evaluateCondition: cross_claim COUNT returns correct count
- evaluateCondition: AND combinator short-circuits on false
- evaluateCondition: OR combinator short-circuits on true
- evaluateCondition: nested conditions evaluate correctly

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
