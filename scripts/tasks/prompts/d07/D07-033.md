# D07-033: Integration tests: Tier 1 rule evaluation with MVP rules (modifier, rejection, WCB, patterns)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-027** (MVP rule seed), **D07-030** (routes).

## What to Build
Create `apps/api/test/integration/intelligence/intelligence-rules.integration.ts`:

**Modifier Eligibility Tests:**
- CMGP eligible claim without CMGP -> suggestion generated
- CMGP claim already with CMGP -> no suggestion
- AFHR eligible (after 17:00 weekday) -> suggestion generated
- AFHR on weekend -> suggestion generated
- AFHR during normal hours -> no suggestion
- RRNP eligible provider -> RRNP suggestion
- Shadow billing ARP physician -> TM modifier suggestion
- Time-based code without time_spent -> DOCUMENTATION_GAP

**Rejection Prevention Tests:**
- GR 3 limit exceeded -> HIGH priority REJECTION_RISK
- GR 3 at limit (not exceeded) -> MEDIUM warning
- GR 8 specialist without referral -> REJECTION_RISK
- Missing DI code for category requiring it -> REJECTION_RISK
- Mutually exclusive modifiers -> REJECTION_RISK

**WCB-Specific Tests:**
- C050E same-day tier -> WCB_TIMING with correct fees
- C050E approaching on-time deadline -> WCB_TIMING with hours remaining
- WCB premium code eligible but not claimed -> MODIFIER_ADD
- WCB follow-up not created within window -> MISSED_BILLING

**Specialty Filter Tests:**
- Rule with specialty_filter = ['GP'] fires for GP
- Rule with specialty_filter = ['GP'] does NOT fire for specialist
- Rule with specialty_filter = null fires for all specialties

**Priority and Deduplication:**
- Multiple suggestions sorted by priority then revenue_impact
- Same modifier suggested by two rules -> highest priority kept

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/integration/intelligence/
```
Fix any errors before finishing.
