# D07-027: Service: MVP rule seeding — initial ~105 rules for modifier eligibility, rejection prevention, WCB, and patterns

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-021** (Tier 1 rule execution must work for rule evaluation testing).

## What to Build
Create `apps/api/src/domains/intel/intel.seed.ts` with MVP rule definitions:

**Modifier Eligibility Rules (~30):**
- CMGP eligibility: HSC in CMGP-eligible list AND modifier_1/2/3 not CMGP -> suggest MODIFIER_ADD, revenue = CMGP_fee_addition
- After-hours (AFHR): DOS time > 17:00 or < 08:00 or weekend AND no AFHR modifier -> suggest
- RRNP eligibility: provider location in RRNP-qualified list AND RRNP not applied -> note
- Shadow billing (TM): ARP physician AND no TM modifier -> suggest
- Time-based code: HSC is time-based AND time_spent missing/below threshold -> DOCUMENTATION_GAP
- Additional modifier rules per specialty patterns

**Rejection Prevention Rules (~40):**
- GR 3 visit limits: COUNT same patient + same code + same period >= limit -> REJECTION_RISK HIGH
- GR 8 referral: specialist consultation without referring practitioner -> REJECTION_RISK HIGH
- DI code required: HSC requires diagnostic code AND none present -> REJECTION_RISK
- Modifier conflicts: mutually exclusive modifiers both present -> REJECTION_RISK
- 90-day window: DOS within 7 days of deadline -> timing WARNING
- Sex mismatch: procedure code sex-specific but patient gender doesn't match -> REJECTION_RISK
- Age limit: HSC has age restriction AND patient age outside range -> REJECTION_RISK

**WCB-Specific Rules (~20):**
- WCB timing tier: calculate current tier, show deadline for next -> WCB_TIMING
- Form completeness: optional fields that improve acceptance rates -> WCB_COMPLETENESS
- Premium code eligible: HSC in 351 list AND not excluded by 4-day rule AND not claimed -> suggest
- Follow-up reminder: parent claim assessed but follow-up not created within expected window -> MISSED_BILLING

**Pattern-Based Rules (~15):**
- Missed billing: physician consistently bills Code A but never Code B (commonly paired) -> MISSED_BILLING LOW
- Under-utilised modifiers: physician modifier usage below specialty average -> FEE_OPTIMISATION LOW
- High rejection code: physician >20% rejection on specific HSC -> REJECTION_RISK MEDIUM

Create a `seedMvpRules()` function that idempotently inserts all rules (skip if name already exists). Each rule includes conditions JSONB, suggestion_template JSONB, claim_type, specialty_filter, and priority_formula.

Export the seed function for use in setup scripts.

## FRD References
- Domain 7 Section 3.4: MVP rule library — modifier eligibility (~30), rejection prevention (~40), WCB-specific (~20), pattern-based (~15). Total ~105 rules.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- seedMvpRules inserts ~105 rules
- seedMvpRules is idempotent (second run inserts 0)
- CMGP rule conditions parse and evaluate correctly
- GR 3 rule uses cross_claim condition type
- WCB timing rule produces correct fee values
- Pattern rules use specialty_filter correctly

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
