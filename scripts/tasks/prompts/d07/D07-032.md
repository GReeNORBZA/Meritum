# D07-032: Integration tests: full analysis pipeline (Tier 1 + Tier 2 + Tier 3 + learning loop)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-030** (suggestion routes), **D07-031** (admin routes).

## What to Build
Create `apps/api/test/integration/intelligence/intelligence-pipeline.integration.ts`:

**End-to-end scenarios:**

1. **AHCIP claim -> Tier 1 suggestions -> accept -> claim updated:**
   Create AHCIP claim without CMGP modifier -> analyse -> CMGP suggestion returned -> accept -> modifier added to claim -> revalidation passes.

2. **WCB claim approaching deadline -> WCB_TIMING suggestion:**
   Create WCB C050E claim with date_of_examination 2 business days ago -> analyse -> WCB_TIMING suggestion with correct fee tiers ($94.15 vs $85.80 vs $54.08).

3. **GR 3 rejection risk -> dismiss -> later rejection -> feedback loop:**
   Create claim exceeding GR 3 limit -> REJECTION_RISK suggestion -> physician dismisses -> claim submitted -> rejection returned -> processRejectionFeedback -> rule re-enabled.

4. **Learning loop suppression:**
   Dismiss same rule 5 consecutive times -> rule suppressed -> new claim does not generate that suggestion -> un-suppress -> suggestion appears again.

5. **Tier 2 LLM analysis (mock):**
   Create claim needing nuanced analysis -> Tier 1 returns base suggestions -> Tier 2 async returns additional CODE_ALTERNATIVE suggestion with explanation -> appended to claim JSONB.

6. **Tier 2 timeout fallback:**
   Mock LLM timeout -> Tier 1 suggestions delivered -> no Tier 2 suggestions -> no error.

7. **Tier 3 escalation:**
   Mock LLM confidence 0.45 -> suggestion routed to Tier 3 -> REVIEW_RECOMMENDED with source link, no suggested_changes.

8. **Specialty cohort:**
   Create 10+ physicians of same specialty with learning data -> recalculate cohorts -> new physician inherits defaults.

9. **SOMB version change:**
   Update SOMB version in Reference Data -> trigger analysis -> affected physicians identified -> impact summaries generated.

10. **Multiple rules on same claim:**
    Claim triggers CMGP + GR 3 + missing DI code -> 3 suggestions returned in priority order, no duplicates.

## FRD References
- Domain 7 Section 11: Testing requirements — Tier 1 tests (rule evaluation), Tier 2 tests (timeout, confidence, hallucination), learning loop tests (acceptance, suppression, feedback), integration tests (end-to-end scenarios).

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/integration/intelligence/
```
Fix any errors before finishing.
