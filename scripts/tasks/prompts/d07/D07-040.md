# D07-040: Security: authentication enforcement on every Intelligence Engine route

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-030** (suggestion routes), **D07-031** (admin routes).

## What to Build
Create `apps/api/test/security/intelligence/intelligence.authn.security.ts`.

Test every authenticated Intelligence Engine route returns 401 without valid session cookie:

- POST /api/v1/intelligence/analyse
- GET /api/v1/intelligence/claims/:claim_id/suggestions
- POST /api/v1/intelligence/suggestions/:id/accept
- POST /api/v1/intelligence/suggestions/:id/dismiss
- GET /api/v1/intelligence/me/learning-state
- POST /api/v1/intelligence/me/rules/:rule_id/unsuppress
- PUT /api/v1/intelligence/me/preferences
- GET /api/v1/intelligence/rules
- POST /api/v1/intelligence/rules
- PUT /api/v1/intelligence/rules/:id
- PUT /api/v1/intelligence/rules/:id/activate
- GET /api/v1/intelligence/rules/:id/stats
- POST /api/v1/intelligence/cohorts/recalculate
- POST /api/v1/intelligence/somb-change-analysis

For each: no cookie -> 401, expired cookie -> 401, tampered cookie -> 401.
All 401 responses contain no data beyond error object.

## Security Requirements
- 14 HTTP endpoints x 3 auth failure modes = 42 test cases.
- 401 responses must not leak rule conditions, suggestions, or learning state.

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/intelligence/intelligence.authn.security.ts
```
Fix any errors before finishing.
