# D07-030: Routes and handlers for suggestion endpoints and learning/preferences endpoints

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-024** (analysis orchestrator), **D07-025** (learning loop).

## What to Build
Create `apps/api/src/domains/intel/intel.routes.ts` and `apps/api/src/domains/intel/intel.handlers.ts`:

Register under `/api/v1/intelligence/` prefix. All routes require authentication.

**Suggestion Endpoints (consumed by Domain 4):**
- POST /api/v1/intelligence/analyse — submit claim context for analysis. Returns Tier 1 suggestions synchronously. Triggers Tier 2 async. Permission: AI_COACH_VIEW.
- GET /api/v1/intelligence/claims/:claim_id/suggestions — get all suggestions for a claim (from JSONB). Permission: AI_COACH_VIEW.
- POST /api/v1/intelligence/suggestions/:id/accept — accept suggestion, apply changes. Permission: AI_COACH_MANAGE.
- POST /api/v1/intelligence/suggestions/:id/dismiss — dismiss suggestion with optional reason. Permission: AI_COACH_MANAGE.

**Learning & Preferences (Physician-facing):**
- GET /api/v1/intelligence/me/learning-state — get learning summary (suppressed rules, top categories). Permission: AI_COACH_VIEW.
- POST /api/v1/intelligence/me/rules/:rule_id/unsuppress — un-suppress a rule. Permission: AI_COACH_MANAGE.
- PUT /api/v1/intelligence/me/preferences — set AI Coach preferences. Permission: AI_COACH_MANAGE.

**WebSocket route for Tier 2 real-time delivery:**
- WS /api/v1/intelligence/ws — authenticate via session cookie. Subscribe to claim analysis channels.

Total: 7 HTTP endpoints + 1 WebSocket endpoint.

## Security Requirements
- AI_COACH_VIEW permission required for read endpoints.
- AI_COACH_MANAGE permission required for accept/dismiss/unsuppress/preferences.
- Delegates with AI_COACH_MANAGE can accept/dismiss suggestions in physician context.
- WebSocket requires session authentication.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- POST /intelligence/analyse returns Tier 1 suggestions
- GET /intelligence/claims/:id/suggestions returns suggestions
- POST /intelligence/suggestions/:id/accept applies changes
- POST /intelligence/suggestions/:id/dismiss updates status
- GET /intelligence/me/learning-state returns summary
- POST /intelligence/me/rules/:id/unsuppress clears suppression
- PUT /intelligence/me/preferences updates preferences

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
