# D07-026: Service: SOMB change impact analysis and contextual help

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-010** (rule repository), **D07-021** (Tier 1 rule execution).

## What to Build
Add SOMB change analysis and contextual help services to `apps/api/src/domains/intel/intel.service.ts`:

**SOMB Change Impact Analysis:**
- `analyseSombChange(oldVersion: string, newVersion: string)` — compare SOMB versions and generate per-physician impact:
  1. Fetch rules with somb_version = oldVersion.
  2. Identify changed codes/rules between versions (from Reference Data version diff).
  3. For each affected rule:
     a. Identify physicians who have used this rule (from ai_provider_learning, times_shown > 0).
     b. Assess impact: rule still valid? conditions changed? revenue impact changed?
  4. Generate per-physician impact summary:
     - affected_rules: list of rules with change type (updated, deprecated, new)
     - affected_codes: list of HSC codes that changed
     - estimated_revenue_impact: aggregate across affected rules
     - plain_language_summary: use Tier 2 LLM to generate physician-friendly summary (or template if LLM unavailable)
  5. Emit notification events per Domain 9 (Notification Service): SOMB_CHANGE_IMPACT per affected physician.
  Return: { physician_impacts: PhysicianImpact[], total_affected_physicians, total_affected_rules }.

**Contextual Help (consumed by frontend):**
- `getFieldHelp(fieldName: string, context?: { hsc?, modifier?, form_id? })` — return help content from Reference Data: help_text, source_reference, source_url. Context narrows to specific code/modifier if provided.
- `getGoverningRuleSummary(grNumber: string)` — return plain-language GR summary with official link.
- `getCodeHelp(hscCode: string)` — return code description, fee, eligible modifiers, applicable GRs, tips.

Help content is read-only from Reference Data — Intelligence Engine does NOT generate it.

## FRD References
- Domain 7 Section 9: Contextual help system — 5 content types (field tooltips, validation help, GR summaries, WCB guidance, SOMB change alerts). Content from Reference Data help_text fields.
- Domain 7 Section 8.4: SOMB change analysis endpoint. Impact analysis per physician.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- analyseSombChange identifies affected rules by version
- analyseSombChange generates per-physician impact
- analyseSombChange skips physicians with no usage of affected rules
- analyseSombChange emits notification events
- getFieldHelp returns help text from Reference Data
- getFieldHelp narrows by HSC context
- getGoverningRuleSummary returns summary with link
- getCodeHelp returns fee, modifiers, and GRs

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
