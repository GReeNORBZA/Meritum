# D07-042: Security: cross-physician tenant isolation for suggestions and learning state

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-030** (suggestion routes), **D07-031** (admin routes).

## What to Build
Create `apps/api/test/security/intelligence/intelligence.scoping.security.ts`.

Create two physicians (physician1, physician2).

**Suggestion isolation:**
- Physician1 analyses claim -> physician2 GET /intelligence/claims/:claim_id/suggestions -> 404
- Physician1's suggestions cannot be accepted/dismissed by physician2 -> 404

**Learning state isolation:**
- Physician1 GET /intelligence/me/learning-state -> only physician1's state
- Physician2 cannot access physician1's learning state
- Physician1 unsuppress rule -> only affects physician1's suppression

**Claim analysis isolation:**
- Physician2 cannot trigger analysis on physician1's claim -> 404

**Delegate isolation:**
- Delegate in physician1 context -> sees physician1's suggestions only
- Delegate switches to physician2 context -> sees physician2's suggestions only

**All cross-physician access returns 404, not 403.**

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/intelligence/intelligence.scoping.security.ts
```
Fix any errors before finishing.
