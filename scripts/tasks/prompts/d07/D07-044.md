# D07-044: Security: PHI leakage prevention (especially LLM context isolation)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-030** (suggestion routes), **D07-031** (admin routes).

## What to Build
Create `apps/api/test/security/intelligence/intelligence.leakage.security.ts`.

**LLM PHI isolation (MOST CRITICAL):**
- Verify stripPhi replaces patient PHN with 'XXXNNNNNN' in LLM prompt
- Verify stripPhi removes patient name from LLM prompt
- Verify LLM prompt contains billing codes but no patient identity
- Verify LLM response processing does not re-inject PHI

**Suggestion responses do not leak PHI:**
- Suggestion description does not contain patient PHN
- Suggestion description does not contain patient name
- Suggestion JSONB on claim does not store raw LLM prompts

**Error responses:**
- 500 error from LLM does not expose patient data in error body
- 400 validation error does not include claim PHI
- 404 does not confirm claim existence

**Headers:**
- No X-Powered-By, no Server version, HSTS present, CSP present

**Learning data does not contain PHI:**
- ai_provider_learning contains no patient data (only rule IDs and counters)
- ai_suggestion_events contains no PHI (only suggestion IDs, categories, revenue impacts)
- ai_specialty_cohorts contains no PHI (only aggregate rates)
- dismissed_reason field: verify no PHI stored even if physician types it (sanitise)

**Rule conditions JSONB not exposed to non-admin:**
- GET /intelligence/rules as physician -> conditions field absent

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run test/security/intelligence/intelligence.leakage.security.ts
```
Fix any errors before finishing.
