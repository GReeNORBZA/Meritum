# D07-031: Routes and handlers for admin rule management and SOMB change analysis

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-010** (rule repository), **D07-026** (SOMB change analysis service).

## What to Build
Add to `apps/api/src/domains/intel/intel.routes.ts`:

**Rule Management (Admin only):**
- GET /api/v1/intelligence/rules — list rules with status and stats. Permission: AI_COACH_VIEW (viewable by physicians for transparency) + ADMIN for full stats.
- POST /api/v1/intelligence/rules — create rule. Permission: ADMIN only.
- PUT /api/v1/intelligence/rules/:id — update rule. Permission: ADMIN only.
- PUT /api/v1/intelligence/rules/:id/activate — activate/deactivate. Permission: ADMIN only.
- GET /api/v1/intelligence/rules/:id/stats — rule performance stats. Permission: ADMIN only.
- POST /api/v1/intelligence/cohorts/recalculate — trigger cohort recalculation. Permission: ADMIN only.

**SOMB Change Analysis:**
- POST /api/v1/intelligence/somb-change-analysis — generate per-physician impact. Permission: ADMIN only.

**Physician rule list (transparency):**
- GET /intelligence/rules for non-admin: returns rule name, category, description only. No conditions JSONB. No stats.

Total additional: 7 HTTP endpoints.

## Security Requirements
- Rule creation/modification is ADMIN only. Physicians can view rules (name + category) for transparency but not modify.
- Rule conditions JSONB not exposed to non-admin users (prevents reverse-engineering of billing rules).
- SOMB change analysis is ADMIN only — triggers notifications to many physicians.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- GET /intelligence/rules returns rules for physician (name+category only)
- POST /intelligence/rules creates rule as admin
- POST /intelligence/rules as non-admin -> 403
- PUT /intelligence/rules/:id updates rule
- PUT /intelligence/rules/:id/activate toggles active
- GET /intelligence/rules/:id/stats returns aggregate metrics
- POST /intelligence/cohorts/recalculate triggers recalc
- POST /intelligence/somb-change-analysis generates impact

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
