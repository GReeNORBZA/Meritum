# D07-012: Repository: ai_specialty_cohorts and ai_suggestion_events operations

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-006** (database migration must be applied).

## What to Build
Add to `apps/api/src/domains/intel/intel.repository.ts`:

**Specialty cohort operations:**
- `getCohortDefaults(specialtyCode: string, ruleId: string)` — get aggregate for specialty+rule. Return null if physician_count < MIN_COHORT_SIZE (10).
- `upsertCohortAggregate(specialtyCode: string, ruleId: string, data: CohortAggregateInput)` — insert or update aggregate. Called by nightly recalculation job.
- `recalculateAllCohorts()` — compute aggregates for every (specialty, rule) pair from ai_provider_learning. Group by specialty (from provider table join), calculate acceptance_rate = times_accepted / times_shown, median_revenue_impact from ai_suggestion_events. Only include cohorts with physician_count >= 10.
- `listCohorts(filters: { specialty_code?, rule_id? })` — for admin review.

**Suggestion events (append-only):**
- `appendSuggestionEvent(event: SuggestionEventInput)` — insert single event. The ONLY write operation.
- `getSuggestionEventsForClaim(claimId: string)` — all events for a claim, chronological.
- `getSuggestionEventsForProvider(providerId: string, filters: { category?, tier?, event_type?, start_date?, end_date?, page, page_size })` — paginated, reverse chronological.
- `getRulePerformanceEvents(ruleId: string, filters: { event_type?, start_date?, end_date? })` — for rule stats dashboard.

**CRITICAL:** ai_suggestion_events has NO update or delete functions. Append-only.

## Security Requirements
- ai_suggestion_events is append-only. No UPDATE, no DELETE. Hard requirement.
- Cohort aggregation requires physician_count >= 10. Smaller cohorts are excluded to prevent de-identification.
- Specialty cohort data contains no PHI — only billing pattern aggregates.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- getCohortDefaults returns null when physician_count < 10
- getCohortDefaults returns data when physician_count >= 10
- recalculateAllCohorts computes correct acceptance_rate
- recalculateAllCohorts excludes small cohorts
- appendSuggestionEvent inserts event
- getSuggestionEventsForClaim returns chronological
- getSuggestionEventsForProvider filters by category
- ai_suggestion_events has no update function
- ai_suggestion_events has no delete function

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
