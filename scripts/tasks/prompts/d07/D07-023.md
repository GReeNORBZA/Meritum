# D07-023: Service: Tier 3 review flagging and suggestion lifecycle (accept/dismiss)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-021** (Tier 1 rule execution), **D07-022** (Tier 2 LLM integration).

## What to Build
Add Tier 3 and lifecycle management to `apps/api/src/domains/intel/intel.service.ts`:

**Tier 3 Review Flagging:**
- `generateTier3Suggestion(trigger: string, context: ClaimContext, sourceReference: string, sourceUrl?: string)` — create Tier 3 suggestion:
  - tier = 3, category = REVIEW_RECOMMENDED
  - suggested_changes = null (no one-click accept)
  - revenue_impact = null (cannot calculate for ambiguous)
  - confidence = null (explicitly null — human review needed)
  - title: describes area of concern
  - description: plain-language explanation of ambiguity
  - source_reference + source_url populated

**Tier 3 triggers:** LLM confidence < 0.60, complex GR interactions, novel code combinations, conflicting rules, complex SOMB change impact.

**Suggestion Lifecycle:**
- `acceptSuggestion(claimId: string, suggestionId: string, providerId: string)` —
  1. Find suggestion in claim's ai_coach_suggestions JSONB.
  2. Apply suggested_changes to the claim (call Domain 4 update).
  3. Set suggestion status = ACCEPTED, resolved_at, resolved_by.
  4. Record ACCEPTED event in ai_suggestion_events.
  5. Update learning state: recordAcceptance (resets consecutive_dismissals).
  6. Trigger claim revalidation (Domain 4.0).

- `dismissSuggestion(claimId: string, suggestionId: string, providerId: string, reason?: string)` —
  1. Set suggestion status = DISMISSED, dismissed_reason, resolved_at, resolved_by.
  2. Record DISMISSED event with reason.
  3. Update learning state: recordDismissal (increment consecutive, check suppression threshold).

- `getClaimSuggestions(claimId: string)` — read from claim's ai_coach_suggestions JSONB. Fast read, no analysis.

## FRD References
- Domain 7 Section 5: Tier 3 triggers, review suggestion format (no suggested_changes, no revenue_impact, no confidence).
- Domain 7 Section 2.1: Suggestion lifecycle — PENDING -> ACCEPTED or DISMISSED.

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- generateTier3Suggestion has null confidence and suggested_changes
- generateTier3Suggestion has REVIEW_RECOMMENDED category
- acceptSuggestion applies changes to claim
- acceptSuggestion sets status ACCEPTED
- acceptSuggestion records ACCEPTED event
- acceptSuggestion updates learning state (resets dismissals)
- acceptSuggestion triggers claim revalidation
- dismissSuggestion sets status DISMISSED with reason
- dismissSuggestion records DISMISSED event
- dismissSuggestion increments consecutive_dismissals
- dismissSuggestion auto-suppresses at threshold 5
- getClaimSuggestions reads from JSONB

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
