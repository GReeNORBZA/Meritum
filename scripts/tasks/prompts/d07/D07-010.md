# D07-010: Repository: ai_rules CRUD operations (list, get, create, update, activate/deactivate)

## Project Context
You are building **Meritum Health Technologies**, a self-serve medical billing platform for Alberta physicians (AHCIP + WCB claims). This is a monorepo with:
- `apps/api` — Fastify 5 REST API with Drizzle ORM, PostgreSQL 16
- `apps/web` — Next.js 15 frontend
- `packages/shared` — Shared Drizzle schemas, Zod validators, constants, utilities

Tech stack: TypeScript, Fastify 5, Drizzle ORM, PostgreSQL 16, Vitest + Supertest, Lucia auth.

Read `CLAUDE.md` in the project root for full conventions (naming, structure, error handling, security, testing).

## Dependencies
This task depends on: **D07-006** (database migration must be applied).

## What to Build
Create `apps/api/src/domains/intel/intel.repository.ts`:

**Rule operations:**
- `listRules(filters: { category?, claim_type?, is_active?, specialty_code?, page, page_size })` — paginated list with optional filters. When specialty_code provided, include rules where specialty_filter IS NULL or contains the code.
- `getRule(ruleId: string)` — single rule by ID.
- `createRule(data: CreateRuleInput)` — insert new rule. Admin only (enforced at route level).
- `updateRule(ruleId: string, data: UpdateRuleInput)` — partial update. Set updated_at.
- `activateRule(ruleId: string, isActive: boolean)` — toggle is_active.
- `getActiveRulesForClaim(claimType: string, specialtyCode: string)` — fetch all active rules matching claim_type (BOTH or specific) and specialty_filter (null or includes specialty). Optimised query for Tier 1 evaluation.
- `getRuleStats(ruleId: string)` — aggregate stats: total_shown, total_accepted, total_dismissed, acceptance_rate, suppression_count across all physicians. Join ai_provider_learning.
- `getRulesByVersion(sombVersion: string)` — fetch rules derived from a specific SOMB version. For change analysis.

**Note:** The domain folder is `intel` per CLAUDE.md project structure (`apps/api/src/domains/intel/`).

## Expected Tests
Add tests in `apps/api/src/domains/intel/intel.test.ts`:
- listRules returns paginated results
- listRules filters by category
- listRules filters by claim_type
- listRules filters by specialty (null filter matches all)
- getActiveRulesForClaim returns rules for AHCIP + BOTH
- getActiveRulesForClaim respects specialty_filter
- createRule inserts rule with condition tree
- updateRule updates conditions and template
- activateRule toggles is_active
- getRuleStats returns aggregate acceptance rate

## Run After Completion
After completing your changes, run:
```bash
pnpm --filter api vitest run src/domains/intel/intel.test.ts
```
Fix any errors before finishing.
