# Task D02-012: Repository â€” DI codes, RRNP communities, PCPCM baskets, holidays, explanatory codes

## What to Build

Add to `apps/api/src/domains/reference/reference.repository.ts`:

**DI codes:**
- `searchDiCodes(query: string, versionId: string, filters?: { specialty?: string }, limit: number)` -- full-text + pg_trgm search on di_code and description. If specialty provided, boost results where common_in_specialty JSONB contains the specialty. Return: id, di_code, description, category, qualifies_surcharge, qualifies_bcp, help_text. Order by relevance (specialty-weighted first).
- `findDiByCode(diCode: string, versionId: string)` -- full detail including all fields. Return single record or null.

**RRNP communities:**
- `findRrnpRate(communityId: string, versionId: string)` -- return community_name and rrnp_percentage for the specified community and version.
- `listRrnpCommunities(versionId: string)` -- all communities for a version, ordered by community_name.

**PCPCM baskets:**
- `findPcpcmBasket(hscCode: string, versionId: string)` -- return basket classification (in_basket, out_of_basket, facility) for HSC code and version.

**Functional centres:**
- `listFunctionalCentres(versionId: string, facilityType?: string)` -- list functional centres for a version. Optionally filter by facility_type. Return: code, name, facility_type, location_city, location_region, active.
- `findFunctionalCentre(code: string, versionId: string)` -- single centre detail including rrnp_community_id.

**Statutory holidays:**
- `listHolidaysByYear(year: number)` -- return all holidays for a given year, ordered by date.
- `isHoliday(date: Date)` -- check if a specific date is a statutory holiday. Return `{ is_holiday: boolean, holiday_name?: string, jurisdiction?: string, affects_billing_premiums?: boolean }`.
- `createHoliday(data: InsertStatutoryHoliday)` -- insert a new holiday record.
- `updateHoliday(holidayId: string, data: Partial<InsertStatutoryHoliday>)` -- update holiday fields.
- `deleteHoliday(holidayId: string)` -- remove holiday record.

**Explanatory codes:**
- `findExplanatoryCode(code: string, versionId: string)` -- full detail including common_cause and suggested_action. Return single record or null.

Use Drizzle ORM query builder. Follow existing repository patterns.

## Prerequisites

- D02-009 must be complete (database migration applied, tables exist).
- D02-010 should be complete (base repository file created).

## Tests to Write

Add tests to `apps/api/src/domains/reference/reference.test.ts`:

- searchDiCodes returns results weighted by specialty
- searchDiCodes flags surcharge and BCP qualifying codes
- findRrnpRate returns correct percentage for community
- findPcpcmBasket returns correct basket for HSC
- listFunctionalCentres filters by facility_type
- listHolidaysByYear returns all holidays for year
- isHoliday returns true for statutory holiday
- isHoliday returns false for regular day
- createHoliday inserts holiday
- findExplanatoryCode returns full detail

## FRD Reference

- Domain 2 Section 2.6: DI codes ~14,000 with surcharge/BCP flags.
- Domain 2 Section 2.7: RRNP ~100-200 communities with percentage rates.
- Domain 2 Section 2.8: PCPCM ~3,000-4,000 HSC classifications.
- Domain 2 Section 2.5: Functional centres ~2,000-3,000 codes.
- Domain 2 Section 2.9: Statutory holidays -- 11 Alberta holidays.
- Domain 2 Section 2.10: Explanatory codes with severity, common cause, suggested action.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
