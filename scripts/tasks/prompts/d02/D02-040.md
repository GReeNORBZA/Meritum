# Task D02-040: Security â€” authentication enforcement on every route

## What to Build

Create `apps/api/test/security/reference/reference.authn.security.ts`.

Test every route in Reference Data returns 401 without valid session cookie:

**User-facing routes (13 search/lookup):**
- GET /api/v1/ref/hsc/search -- no cookie -> 401
- GET /api/v1/ref/hsc/search -- expired cookie -> 401
- GET /api/v1/ref/hsc/search -- tampered cookie -> 401
- GET /api/v1/ref/hsc/favourites -- no cookie -> 401
- GET /api/v1/ref/hsc/favourites -- expired cookie -> 401
- GET /api/v1/ref/hsc/:code -- no cookie -> 401
- GET /api/v1/ref/hsc/:code -- expired cookie -> 401
- GET /api/v1/ref/di/search -- no cookie -> 401
- GET /api/v1/ref/di/search -- expired cookie -> 401
- GET /api/v1/ref/di/:code -- no cookie -> 401
- GET /api/v1/ref/modifiers -- no cookie -> 401
- GET /api/v1/ref/modifiers -- expired cookie -> 401
- GET /api/v1/ref/modifiers/:code -- no cookie -> 401
- GET /api/v1/ref/functional-centres -- no cookie -> 401
- GET /api/v1/ref/explanatory-codes/:code -- no cookie -> 401
- GET /api/v1/ref/rrnp/:id -- no cookie -> 401
- GET /api/v1/ref/pcpcm/:code -- no cookie -> 401
- GET /api/v1/ref/holidays -- no cookie -> 401
- GET /api/v1/ref/holidays -- expired cookie -> 401
- GET /api/v1/ref/holidays/check -- no cookie -> 401

**Change summary routes (3):**
- GET /api/v1/ref/changes -- no cookie -> 401
- GET /api/v1/ref/changes -- expired cookie -> 401
- GET /api/v1/ref/changes/:id/detail -- no cookie -> 401
- GET /api/v1/ref/changes/:id/physician-impact -- no cookie -> 401

**Internal validation routes (4):**
- GET /api/v1/ref/rules/validate-context -- no cookie -> 401
- GET /api/v1/ref/rules/validate-context -- expired cookie -> 401
- GET /api/v1/ref/rules/:id -- no cookie -> 401
- GET /api/v1/ref/somb/version -- no cookie -> 401
- POST /api/v1/ref/rules/evaluate-batch -- no cookie -> 401
- POST /api/v1/ref/rules/evaluate-batch -- expired cookie -> 401

**Admin routes (9):**
- POST /api/v1/admin/ref/somb/upload -- no cookie -> 401
- POST /api/v1/admin/ref/somb/upload -- expired cookie -> 401
- POST /api/v1/admin/ref/somb/upload -- tampered cookie -> 401
- GET /api/v1/admin/ref/somb/staging/:id/diff -- no cookie -> 401
- POST /api/v1/admin/ref/somb/staging/:id/publish -- no cookie -> 401
- DELETE /api/v1/admin/ref/somb/staging/:id -- no cookie -> 401
- GET /api/v1/admin/ref/somb/versions -- no cookie -> 401
- POST /api/v1/admin/ref/holidays -- no cookie -> 401
- PUT /api/v1/admin/ref/holidays/:id -- no cookie -> 401
- DELETE /api/v1/admin/ref/holidays/:id -- no cookie -> 401
- POST /api/v1/admin/ref/rules/:id/dry-run -- no cookie -> 401

**Verification for each test:**
1. Response status is 401.
2. Response body contains only an error object (e.g., `{ error: "Unauthorized" }`).
3. Response body does NOT contain any reference data, code details, or internal details.
4. No `Set-Cookie` header in 401 responses (don't create sessions for unauthenticated requests).

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference).

## Critical Security Rules

- 401 responses contain only error object, no reference data.
- Tampered cookies must be detected and rejected -- do not fall through to a default user.
- Every single route must be tested -- no exceptions.

## Prerequisites

- D02-030 must be complete (search/lookup routes).
- D02-031 must be complete (admin routes).
- D02-032 must be complete (internal validation and change summary routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/reference/reference.authn.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
