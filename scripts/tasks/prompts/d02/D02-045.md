# Task D02-045: Security â€” audit trail completeness for all reference data operations

## What to Build

Create `apps/api/test/security/reference/reference.audit.security.ts`.

Verify each reference data action produces an audit record with the correct action identifier and metadata:

**Data management events:**
- Version staged -> `ref.version_staged` audit entry with:
  - admin_id (who uploaded)
  - data_set (which data set)
  - staging_id (staging record ID)
  - record_count (number of records in upload)
  - file_hash (SHA-256 of uploaded file)

- Diff reviewed -> `ref.version_diff_reviewed` audit entry with:
  - admin_id (who reviewed)
  - staging_id (staging record ID)
  - diff_stats (summary: added, modified, deprecated counts)

- Version published -> `ref.version_published` audit entry with:
  - admin_id (who published)
  - version_id (new version ID)
  - data_set (which data set)
  - effective_from (when version takes effect)

- Version rolled back -> `ref.version_rolled_back` audit entry with:
  - admin_id (who rolled back)
  - version_id (version that was deactivated)
  - data_set (which data set)
  - reason (human-readable reason for rollback)

- Staging discarded -> `ref.staging_discarded` audit entry with:
  - admin_id (who discarded)
  - staging_id (staging record ID)
  - data_set (which data set)

- Rule dry-run -> `ref.rule_dry_run` audit entry with:
  - admin_id (who ran the dry-run)
  - rule_id (which rule was tested)
  - claims_sampled (number of claims tested)

**Holiday events:**
- Holiday created -> `ref.holiday_created` audit entry with:
  - admin_id (who created)
  - date (holiday date)
  - name (holiday name)

- Holiday updated -> `ref.holiday_updated` audit entry with:
  - admin_id (who updated)
  - old_values (previous field values)
  - new_values (updated field values)

- Holiday deleted -> `ref.holiday_deleted` audit entry with:
  - admin_id (who deleted)
  - holiday_id (which holiday)
  - date (holiday date for reference)

**Audit log integrity:**
- Published versions cannot be edited after publication (immutability enforced). Attempt to modify a published version's records directly should fail.
- Audit entries contain only metadata -- they do NOT contain the full staged data (no 14,000 DI code records in audit log). Verify audit entry size is reasonable (< 10KB per entry).

**Test approach:**
For each audit action:
1. Perform the action (upload, review diff, publish, rollback, discard, dry-run, create/update/delete holiday).
2. Query the audit log for the action.
3. Verify the audit entry exists with the correct action identifier.
4. Verify the metadata fields are present and contain expected values.
5. Verify no extra sensitive data is present in the audit entry.

Use the test helpers/fixtures from the project. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference).

## Critical Security Rules

- Every mutating operation on reference data must produce an audit entry.
- Audit entries must not contain full data payloads (only metadata).
- All 9 audit action types must be verified.

## Prerequisites

- D02-030 must be complete (search/lookup routes).
- D02-031 must be complete (admin routes).
- D02-032 must be complete (internal validation and change summary routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/reference/reference.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
