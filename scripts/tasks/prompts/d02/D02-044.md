# Task D02-044: Security â€” data leakage prevention

## What to Build

Create `apps/api/test/security/reference/reference.leakage.security.ts`.

**Staging data isolation:**
- Unpublished staging data does NOT appear in GET /api/v1/ref/hsc/search results
- Unpublished staging data does NOT appear in GET /api/v1/ref/di/search results
- Unpublished staging data does NOT appear in GET /api/v1/admin/ref/somb/versions for non-admin users (admin endpoint returns 403 for non-admin, so staging never visible to physicians)
- Discarded staging data is completely removed from all queries (verify staging record no longer exists after DELETE)

**Version isolation:**
- Search with date parameter returns only data from the correct version
  - Create two versions with different effective dates. Search with date in first version range returns first version's data. Search with date in second version range returns second version's data.
- Future-dated versions do not appear in current searches
  - Create a version with effective_from in the future. Search without date (uses active version) does not return future version data.

**Error response sanitisation:**
- GET /api/v1/ref/hsc/nonexistent-code returns 404 with generic message, not revealing which codes exist
  - Response body: `{ error: "Not found" }` or similar, not `"HSC code 'nonexistent-code' does not exist in version xyz"`
- Trigger a 500 error (e.g., via malformed internal state) -> response does not expose SQL queries, table names, or database connection details
- Schema validation errors from file upload do not expose internal table column names
  - Error messages reference field names from the upload format, not database column names

**Header checks:**
- No `X-Powered-By` header in any response
- HSTS header (`Strict-Transport-Security`) present in responses

**Sensitive fields not leaked:**
- User-facing search results include version_id (needed for version tracking) but do NOT include:
  - staged_data JSONB from reference_data_staging
  - Internal published_by user ID (admin identity)
  - file_hash from staging records
- Admin-authored change summaries are sanitised for XSS before display in change summary endpoints
- The validate-context endpoint returns rule_logic (needed by Claim Lifecycle) but does NOT return internal fields like source_reference or source_url

Use the test helpers/fixtures from the project. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference).

## Critical Security Rules

- Staging data must never leak to non-admin users or to search endpoints.
- Error responses must not reveal internal system details.
- Version isolation must be airtight -- wrong version data is a critical billing error.

## Prerequisites

- D02-030 must be complete (search/lookup routes).
- D02-031 must be complete (admin routes).
- D02-032 must be complete (internal validation and change summary routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/reference/reference.leakage.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
