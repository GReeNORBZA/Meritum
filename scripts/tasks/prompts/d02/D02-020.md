# Task D02-020: Service â€” HSC code search with version resolution and frequency weighting

## What to Build

Create `apps/api/src/domains/reference/reference.service.ts` with search functions:

**Version resolution (core utility):**
- `resolveVersion(dataSet: string, dateOfService?: Date)` -- if date provided, find version effective on that date via `findVersionForDate`. If not, find active version via `findActiveVersion`. Throw `NotFoundError` if no version found. This is the single point of version resolution used by all service functions.

**HSC code search:**
- `searchHscCodes(query: string, options: { specialty?: string, facility?: string, dateOfService?: Date, limit?: number })` --
  1. Resolve SOMB version for date of service using `resolveVersion('SOMB', dateOfService)`.
  2. Execute search via repository `searchHscCodes`.
  3. If physician context available (userId from request context): boost results by usage frequency. Join to claim history/stats to rank frequently-used codes higher.
  4. Mark deprecated codes: if a code exists in the previous version but not the current version, flag it as deprecated. Include replacement suggestion if available.
  5. Return results: `{ code, description, base_fee, fee_type, help_text, deprecated: boolean, replacement?: string }[]`.

**HSC detail:**
- `getHscDetail(hscCode: string, dateOfService?: Date)` -- resolve SOMB version, return full HSC detail including applicable modifiers (from modifier_eligibility), specialty_restrictions, facility_restrictions, combination_group, surcharge_eligible, pcpcm_basket, and help_text.

**HSC favourites:**
- `getHscFavourites(userId: string)` -- return physician's top-N (default 20) favourite HSC codes ranked by billing frequency. Calculate from claim history. Return same fields as search results.

**DI code search:**
- `searchDiCodes(query: string, options: { specialty?: string, limit?: number })` -- resolve DI_CODES version. Search DI codes with specialty weighting. Flag surcharge and BCP qualifiers in results.

**DI detail:**
- `getDiDetail(diCode: string)` -- resolve version, return full DI code detail including category, subcategory, qualifies_surcharge, qualifies_bcp, common_in_specialty.

**Performance target:** <200ms for first page of search results. Use efficient queries and avoid N+1 patterns.

Use dependency injection for the repository. Follow existing service patterns in the codebase (check `apps/api/src/domains/iam/` for reference). See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- Version resolution must use date of service, not current date. This is critical for correct claim validation across version boundaries.
- Search results must not leak data from versions the user should not see (e.g., unpublished staging data).

## Prerequisites

- D02-010 must be complete (repository with version management and HSC queries).

## Tests to Write

Add tests to `apps/api/src/domains/reference/reference.test.ts`:

- resolveVersion returns correct version for date of service
- resolveVersion returns active version when no date specified
- resolveVersion throws when no version exists
- searchHscCodes returns version-appropriate results
- searchHscCodes marks deprecated codes with replacement
- searchHscCodes filters by specialty
- getHscDetail returns full detail with modifiers
- getHscFavourites returns frequency-ranked codes
- searchDiCodes flags surcharge and BCP qualifiers

## FRD Reference

- Domain 2 Section 1.5: Effective-date versioning. Queries filter by version effective on date of service.
- Domain 2 Section 4.1: 13 search/lookup endpoints with date-of-service parameter.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
