# Task D02-002: Drizzle schema for reference_data_versions and hsc_codes tables

## What to Build

Create `packages/shared/src/schemas/db/reference.schema.ts` with version management and SOMB tables.

**reference_data_versions table:**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| version_id | UUID | PK | Default: gen_random_uuid() |
| data_set | VARCHAR(30) | NOT NULL | Enum from reference.constants.ts (SOMB, WCB, etc.) |
| version_label | VARCHAR(50) | NOT NULL | Human-readable label (e.g., "2026-Q1") |
| effective_from | DATE | NOT NULL | Date this version becomes effective |
| effective_to | DATE | NULLABLE | NULL = currently active version |
| published_by | UUID FK | NOT NULL, FK -> users | Admin who published |
| published_at | TIMESTAMPTZ | NOT NULL | Timestamp of publication |
| source_document | TEXT | NULLABLE | Reference to source document |
| change_summary | TEXT | NULLABLE | Human-readable change summary |
| records_added | INTEGER | NOT NULL, DEFAULT 0 | Count of new records |
| records_modified | INTEGER | NOT NULL, DEFAULT 0 | Count of modified records |
| records_deprecated | INTEGER | NOT NULL, DEFAULT 0 | Count of deprecated records |
| is_active | BOOLEAN | NOT NULL, DEFAULT false | Only one active per data_set |

**Indexes:** (data_set, is_active), (data_set, effective_from DESC).

**Constraint:** At most one is_active=true per data_set. Implement via partial unique index: `CREATE UNIQUE INDEX ON reference_data_versions (data_set) WHERE is_active = true`.

**hsc_codes table (~6,000+ records):**

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| id | UUID | PK | Default: gen_random_uuid() |
| hsc_code | VARCHAR(10) | NOT NULL | Health Service Code |
| description | TEXT | NOT NULL | Full description |
| base_fee | DECIMAL(10,2) | NULLABLE | NULL for calculated codes |
| fee_type | VARCHAR(20) | NOT NULL | fixed, calculated, time_based, unit_based |
| specialty_restrictions | JSONB | NOT NULL, DEFAULT '[]' | Array of specialty codes |
| facility_restrictions | JSONB | NOT NULL, DEFAULT '[]' | Array of facility types |
| max_per_day | INTEGER | NULLABLE | Max billings per day |
| max_per_visit | INTEGER | NULLABLE | Max billings per visit |
| requires_referral | BOOLEAN | NOT NULL, DEFAULT false | Whether referral needed |
| referral_validity_days | INTEGER | NULLABLE | Days referral is valid |
| combination_group | VARCHAR(20) | NULLABLE | Code combination group ID |
| modifier_eligibility | JSONB | NOT NULL, DEFAULT '[]' | Array of applicable modifier codes |
| surcharge_eligible | BOOLEAN | NOT NULL, DEFAULT false | Whether surcharge applies |
| pcpcm_basket | VARCHAR(20) | NOT NULL, DEFAULT 'not_applicable' | in_basket, out_of_basket, facility, not_applicable |
| shadow_billing_eligible | BOOLEAN | NOT NULL, DEFAULT false | For APP shadow billing |
| notes | TEXT | NULLABLE | Internal notes |
| help_text | TEXT | NULLABLE | User-facing contextual help |
| version_id | UUID FK | NOT NULL, FK -> reference_data_versions | Parent version |
| effective_from | DATE | NOT NULL | Denormalised from version |
| effective_to | DATE | NULLABLE | Denormalised from version |

**Indexes:** (hsc_code, version_id), (version_id), GIN index on description for full-text search, pg_trgm index on hsc_code and description for fuzzy search.

Use Drizzle ORM's `pgTable` with `uuid`, `varchar`, `text`, `decimal`, `integer`, `boolean`, `jsonb`, `date`, `timestamp` column types. Follow the same patterns used in existing schemas (e.g., `packages/shared/src/schemas/db/user.schema.ts`).

Export tables and inferred types (InsertVersion, SelectVersion, InsertHscCode, SelectHscCode).

## Critical Security Rules

- reference_data_versions enforces single active version per data_set via partial unique index or application-level check.
- Published versions are immutable -- records cannot be edited after publication. Corrections require a new version.

## Prerequisites

- D02-001 must be complete (reference constants for data_set, fee_type, and pcpcm_basket enums).
- The `packages/shared/src/schemas/db/` directory must exist (created by Domain 1).
- User schema must exist for the FK reference to users table.

## FRD Reference

- Domain 2 Section 1.5: Effective-date versioning. Each data set has versions table. Queries filter by version effective on date of service.
- Domain 2 Section 2.1: SOMB fee schedule with 20 fields per HSC record. ~6,000+ records.

## Run After Completion

```bash
pnpm --filter shared build
```

All tests must pass before outputting [TASK_COMPLETE].
