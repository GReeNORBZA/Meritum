# Task D02-032: Routes â€” internal validation endpoints and change summary endpoints

## What to Build

Add to `apps/api/src/domains/reference/reference.routes.ts` and `apps/api/src/domains/reference/reference.handlers.ts`:

**Internal validation routes (authenticated, all roles -- consumed by other domains):**

| Method | Path | Handler | Validation |
|--------|------|---------|------------|
| GET | /api/v1/ref/rules/validate-context | validateContextHandler | query: validateContextSchema |
| GET | /api/v1/ref/rules/:rule_id | ruleDetailHandler | params: ruleDetailSchema, query: ruleDetailQuerySchema |
| GET | /api/v1/ref/somb/version | sombVersionHandler | query: versionQuerySchema |
| POST | /api/v1/ref/rules/evaluate-batch | evaluateBatchHandler | body: evaluateBatchSchema |

**Change summary routes (authenticated, active subscription):**

| Method | Path | Handler | Validation |
|--------|------|---------|------------|
| GET | /api/v1/ref/changes | changeSummaryListHandler | query: changeListSchema |
| GET | /api/v1/ref/changes/:version_id/detail | changeDetailHandler | params: changeDetailParamSchema, query: changeDetailQuerySchema |
| GET | /api/v1/ref/changes/:version_id/physician-impact | physicianImpactHandler | params: changeDetailParamSchema |

**Handler implementations:**

`validateContextHandler`: Parse query params (hsc as comma-separated array or repeated params), call `getValidationContext(hsc, di, facility, date, modifiers)`. Return full validation context.

`ruleDetailHandler`: Call `getRuleDetail(rule_id, date)`. Return full rule with rule_logic or 404.

`sombVersionHandler`: Call `resolveVersion('SOMB', date)`. Return version info.

`evaluateBatchHandler`: Validate body (max 500 claims enforced by schema), call `evaluateRulesBatch(claims)`. Return per-claim applicable rules.

`changeSummaryListHandler`: Call `getChangeSummaries(dataset, since)`. Return version list with change stats.

`changeDetailHandler`: Call `getChangeDetail(version_id, specialty)`. Return code-level changes.

`physicianImpactHandler`: Get userId from request.user, call `getPhysicianImpact(version_id, userId)`. Return personalised impact. **Important:** This endpoint is scoped to the authenticated user -- the userId comes from the session, not from a query parameter.

**Route ordering note:** Register `/api/v1/ref/rules/validate-context` and `/api/v1/ref/rules/evaluate-batch` BEFORE `/api/v1/ref/rules/:rule_id` to prevent path parameter matching on "validate-context" and "evaluate-batch".

## Critical Security Rules

- Internal validation routes are authenticated but available to all roles (consumed by other domains like Claim Lifecycle).
- evaluate-batch limited to 500 claims per request to prevent DoS (enforced by Zod schema).
- physician-impact endpoint scoped to the authenticated user -- no cross-user data. userId comes from session, not URL.

## Prerequisites

- D02-021 must be complete (service with validation context and rule queries).
- D02-024 must be complete (service with change summaries).

## Tests to Write

Create `apps/api/test/integration/reference/validation.integration.ts`:
- GET /ref/rules/validate-context returns applicable rules for claim
- GET /ref/rules/:id returns full rule with rule_logic
- GET /ref/somb/version returns version for date
- POST /ref/rules/evaluate-batch handles multiple claims
- POST /ref/rules/evaluate-batch rejects > 500 claims

Create `apps/api/test/integration/reference/changes.integration.ts`:
- GET /ref/changes returns version publications
- GET /ref/changes/:id/detail filters by specialty
- GET /ref/changes/:id/physician-impact returns personalised data

## FRD Reference

- Domain 2 Section 4.2: 4 internal validation endpoints. getValidationContext is the primary interface for Claim Lifecycle.
- Domain 2 Section 4.4: 3 change summary endpoints.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/reference/
```

All tests must pass before outputting [TASK_COMPLETE].
