# Task D02-010: Repository â€” version management and HSC code queries (version-aware)

## What to Build

Create `apps/api/src/domains/reference/reference.repository.ts` with version and HSC operations:

**Version management:**
- `findActiveVersion(dataSet: string)` -- find the currently active version for a data set. Query: `WHERE data_set = ? AND is_active = true`.
- `findVersionForDate(dataSet: string, date: Date)` -- find the version effective on a specific date: `WHERE data_set = ? AND effective_from <= date AND (effective_to IS NULL OR effective_to > date)`. Return single version or null.
- `listVersions(dataSet: string)` -- list all versions for a data set, ordered by effective_from DESC.
- `createVersion(data: InsertVersion)` -- insert new version record. Return created version.
- `activateVersion(versionId: string, previousVersionId?: string)` -- set is_active=true on new version. If previousVersionId provided, set previous version's is_active=false and effective_to to new version's effective_from. Must be atomic (wrap in transaction).
- `deactivateVersion(versionId: string)` -- rollback: set is_active=false. Used by rollback flow.

**HSC code queries:**
- `searchHscCodes(query: string, versionId: string, filters?: { specialty?: string, facility?: string }, limit: number)` -- full-text + pg_trgm search on hsc_code and description. Filter by version_id. Optionally filter by specialty_restrictions and facility_restrictions JSONB contains. Return: id, hsc_code, description, base_fee, fee_type, help_text, effective_to (for deprecated flag). Order by relevance.
- `findHscByCode(hscCode: string, versionId: string)` -- full detail including all fields: modifiers (modifier_eligibility), restrictions (specialty_restrictions, facility_restrictions), combination_group, surcharge_eligible, pcpcm_basket, help_text. Return single record or null.
- `listHscByVersion(versionId: string, pagination: { limit: number, offset: number })` -- all codes for a version with pagination (admin use).

Use Drizzle ORM query builder with the reference schema from `packages/shared/src/schemas/db/reference.schema.ts`. Accept a Drizzle database instance via dependency injection (constructor parameter or function parameter). Follow existing repository patterns in the codebase (check `apps/api/src/domains/iam/` for reference).

Create `apps/api/src/domains/reference/reference.test.ts` with unit tests.

## Critical Security Rules

- findVersionForDate is the critical function -- incorrect version selection means incorrect claim validation. Must handle boundary conditions precisely: claim on effective_from date uses new version, claim on day before uses old.
- activateVersion must be atomic: at no point should two versions be active simultaneously for the same data set.

## Prerequisites

- D02-009 must be complete (database migration applied, all tables exist).
- Drizzle database connection must be available (set up in app bootstrap).

## Tests to Write

Create tests in `apps/api/src/domains/reference/reference.test.ts`:

- findActiveVersion returns the active version for data set
- findVersionForDate returns correct version for date within range
- findVersionForDate returns correct version at boundary (effective_from date)
- findVersionForDate returns previous version for day before effective_from
- activateVersion atomically swaps active version
- activateVersion sets previous version's effective_to
- searchHscCodes returns results for code prefix match
- searchHscCodes returns results for keyword match
- searchHscCodes filters by specialty
- searchHscCodes respects version_id (different versions return different results)
- findHscByCode returns full detail with modifiers

## FRD Reference

- Domain 2 Section 1.5: Effective-date versioning. Queries filter by version effective on date of service.
- Domain 2 Section 2.1: SOMB fee schedule with ~6,000+ HSC records.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
