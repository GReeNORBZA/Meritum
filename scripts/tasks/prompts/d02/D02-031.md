# Task D02-031: Routes â€” admin data management endpoints (upload, diff, publish, holidays)

## What to Build

Add to `apps/api/src/domains/reference/reference.routes.ts` and `apps/api/src/domains/reference/reference.handlers.ts`:

**Admin data management routes (admin role required):**

| Method | Path | Handler | Validation |
|--------|------|---------|------------|
| POST | /api/v1/admin/ref/:dataset/upload | uploadHandler | params: adminUploadParamSchema, multipart file |
| GET | /api/v1/admin/ref/:dataset/staging/:id/diff | diffHandler | params: adminStagingParamSchema |
| POST | /api/v1/admin/ref/:dataset/staging/:id/publish | publishHandler | params: adminStagingParamSchema, body: adminPublishSchema |
| DELETE | /api/v1/admin/ref/:dataset/staging/:id | discardStagingHandler | params: adminStagingParamSchema |
| GET | /api/v1/admin/ref/:dataset/versions | listVersionsHandler | params: adminVersionListSchema |
| POST | /api/v1/admin/ref/holidays | createHolidayHandler | body: createHolidaySchema |
| PUT | /api/v1/admin/ref/holidays/:id | updateHolidayHandler | params: holidayParamSchema, body: updateHolidaySchema |
| DELETE | /api/v1/admin/ref/holidays/:id | deleteHolidayHandler | params: holidayParamSchema |
| POST | /api/v1/admin/ref/rules/:rule_id/dry-run | dryRunHandler | params: dryRunParamSchema, body: dryRunSchema |

**File upload handling:**
Use `@fastify/multipart` for file uploads. Accept CSV and JSON files. Max file size: 50MB.

`uploadHandler`:
1. Register multipart support on the route.
2. Read uploaded file from multipart request.
3. Validate file size (reject > 50MB with 400).
4. Validate content type: accept `text/csv`, `application/json`, `application/octet-stream`.
5. Get adminUserId from request.user, dataset from params.
6. Call `uploadDataSet(adminUserId, dataset, fileBuffer, fileName)`.
7. Return `{ staging_id, validation_result, record_count, status }`.

`diffHandler`: Get staging diff via `getStagingDiff(adminUserId, dataset, id)`. Return diff result.

`publishHandler`: Validate body, call `publishVersion(adminUserId, dataset, id, body)`. Return `{ version_id }`.

`discardStagingHandler`: Call `discardStaging(adminUserId, dataset, id)`. Return `{ success: true }`.

`listVersionsHandler`: Call `listVersions(dataset)`. Return `{ versions: Version[] }`.

`createHolidayHandler`: Validate body, call `createHoliday(adminUserId, body)`. Return created holiday. Status 201.

`updateHolidayHandler`: Validate params and body, call `updateHoliday(adminUserId, id, body)`. Return updated holiday.

`deleteHolidayHandler`: Call `deleteHoliday(adminUserId, id)`. Return `{ success: true }`.

`dryRunHandler`: Validate params and body, call `dryRunRule(adminUserId, rule_id, updated_rule_logic)`. Return dry-run results.

**Route-level middleware:**
- All admin routes use `authenticate` + `requireRole('admin')` preHandlers.
- Follow the admin route registration pattern from other domains.

## Critical Security Rules

- All admin routes require admin role. Physician and delegate roles get 403.
- File uploads validated for size (50MB max), content type, and schema before staging.
- Publication requires diff review step -- cannot publish directly from upload (status must be DIFF_GENERATED).

## Prerequisites

- D02-022 must be complete (service with upload and diff functions).
- D02-023 must be complete (service with publish and rollback functions).
- D02-024 must be complete (service with holiday management).

## Tests to Write

Create `apps/api/test/integration/reference/admin.integration.ts`:

- POST /admin/ref/somb/upload accepts CSV file
- POST /admin/ref/somb/upload accepts JSON file
- POST /admin/ref/somb/upload rejects invalid schema
- GET /admin/ref/somb/staging/:id/diff returns diff
- POST /admin/ref/somb/staging/:id/publish creates live version
- DELETE /admin/ref/somb/staging/:id discards staged data
- POST /admin/ref/holidays creates holiday
- POST /admin/ref/rules/:id/dry-run returns affected claims
- All admin routes reject non-admin users

## FRD Reference

- Domain 2 Section 4.3: 9 admin data management endpoints.
- Domain 2 Section 6.2: Staging workflow -- upload, validate, diff, publish/discard.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/reference/
```

All tests must pass before outputting [TASK_COMPLETE].
