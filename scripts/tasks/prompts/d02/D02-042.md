# Task D02-042: Security â€” cross-user isolation (tenant scoping)

## What to Build

Create `apps/api/test/security/reference/reference.scoping.security.ts`.

Create two physician accounts using the `createSecurityPair` fixture (or equivalent test helper).

**Reference data is shared (read-only) -- no tenant isolation needed for code lookups:**
- Both physicians see the same HSC codes when searching (this is correct -- reference data is global)
- Both physicians see the same DI codes, governing rules, modifiers
- Both physicians see the same holiday calendar
- Both physicians see the same version publications in change summaries

**Physician-specific data IS isolated:**
- GET /api/v1/ref/hsc/favourites for physician1 returns physician1's favourites only
- GET /api/v1/ref/hsc/favourites for physician2 returns physician2's favourites only
- physician1 cannot see physician2's favourites (result sets are different based on billing history)
- GET /api/v1/ref/changes/:version_id/physician-impact for physician1 returns physician1's impact only
- GET /api/v1/ref/changes/:version_id/physician-impact for physician2 returns physician2's impact only
- physician1's impact reflects physician1's billing history, not physician2's

**Admin actions are scoped:**
- Staging records created by admin1 are visible to admin2 (admin-level collaboration is acceptable -- not tenant-isolated)
- This is by design: admins collaborate on reference data management

**Important behaviour:**
- Cross-user access to personalised endpoints (favourites, physician-impact) returns the authenticated user's own data, not another user's data. There is no way to request another user's personalised data via the API.
- If a user somehow provides another user's ID, the endpoint ignores it and uses the session userId.

Use the test helpers/fixtures from the project. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference).

## Critical Security Rules

- Personalised endpoints (favourites, physician-impact) are scoped to the authenticated user's ID from the session.
- There is no URL parameter to access another user's personalised data.
- Reference data lookups are intentionally shared -- all authenticated users see the same codes.

## Prerequisites

- D02-030 must be complete (search/lookup routes including favourites).
- D02-031 must be complete (admin routes).
- D02-032 must be complete (change summary routes including physician-impact).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/reference/reference.scoping.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
