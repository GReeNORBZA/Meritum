# Task D02-043: Security â€” input validation and injection prevention

## What to Build

Create `apps/api/test/security/reference/reference.input.security.ts`.

**SQL injection payloads on search queries:**
- GET /api/v1/ref/hsc/search?q=' OR 1=1-- -> returns 0 results (not all records)
- GET /api/v1/ref/hsc/search?q='; DROP TABLE hsc_codes;-- -> returns 0 results (table not dropped)
- GET /api/v1/ref/hsc/search?q=1 UNION SELECT * FROM users-- -> returns 0 results (no user data leaked)
- GET /api/v1/ref/di/search?q=' OR 1=1-- -> returns 0 results
- specialty parameter with SQL injection payload -> 400 or safe empty results
- date parameter with SQL injection payload -> 400

**XSS payloads on admin-authored text fields:**
- POST /api/v1/admin/ref/holidays with name=`<script>alert(1)</script>` -> stored without script execution (sanitised or escaped on output)
- POST /api/v1/admin/ref/somb/staging/:id/publish with change_summary=`<script>alert(1)</script>` -> sanitised
- Uploaded data file with help_text containing `<img onerror=alert(1) src=x>` -> sanitised or escaped

**Type coercion attacks:**
- GET /api/v1/ref/hsc/search?limit=-1 -> 400 (negative limit rejected)
- GET /api/v1/ref/hsc/search?limit=100 -> capped at 50 or 400 (exceeds max)
- GET /api/v1/ref/hsc/search?limit=abc -> 400 (not a number)
- GET /api/v1/ref/hsc/search?q= -> 400 (empty query, min length 1)
- Send array where string expected in query params -> 400
- Send number where string expected -> 400
- Invalid date format (e.g., "2026-13-45") in date params -> 400
- Valid ISO date format required (YYYY-MM-DD)

**UUID parameter validation:**
- GET /api/v1/ref/rrnp/not-a-uuid -> 400 (invalid UUID)
- GET /api/v1/ref/changes/not-a-uuid/detail -> 400 (invalid UUID)
- DELETE /api/v1/admin/ref/somb/staging/not-a-uuid -> 400 (invalid UUID)

**File upload attacks:**
- POST /admin/ref/somb/upload with file > 50MB -> 400 (file too large)
- POST /admin/ref/somb/upload with executable file disguised as CSV -> 400 (invalid content)
- POST /admin/ref/somb/upload with mismatched content type header -> 400
- POST /admin/ref/somb/upload with malformed CSV (unterminated quotes) -> descriptive validation error
- POST /admin/ref/somb/upload with wrong encoding (non-UTF-8) -> descriptive error

**Rule_logic JSON validation:**
- POST /admin/ref/rules/:id/dry-run with invalid JSON in body -> 400
- POST /admin/ref/rules/:id/dry-run with unexpected keys in rule_logic -> validation warning (accepted but logged)

Use the test helpers/fixtures from the project. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference).

## Critical Security Rules

- SQL injection payloads must never execute -- parameterised queries only.
- XSS payloads must be sanitised or escaped before storage/output.
- All input validation enforced at the Zod schema level before reaching service/repository.
- File uploads thoroughly validated before processing.

## Prerequisites

- D02-030 must be complete (search/lookup routes).
- D02-031 must be complete (admin routes including file upload).
- D02-032 must be complete (internal validation and change summary routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/reference/reference.input.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
