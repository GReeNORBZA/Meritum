# Task D02-030: Routes â€” search and lookup endpoints (13 public user-facing routes)

## What to Build

Create `apps/api/src/domains/reference/reference.routes.ts` and `apps/api/src/domains/reference/reference.handlers.ts`.

**Routes (all require authentication and active subscription):**

| Method | Path | Handler | Validation |
|--------|------|---------|------------|
| GET | /api/v1/ref/hsc/search | searchHscHandler | query: hscSearchSchema |
| GET | /api/v1/ref/hsc/favourites | hscFavouritesHandler | none |
| GET | /api/v1/ref/hsc/:code | hscDetailHandler | params: hscDetailParamSchema, query: hscDetailQuerySchema |
| GET | /api/v1/ref/di/search | searchDiHandler | query: diSearchSchema |
| GET | /api/v1/ref/di/:code | diDetailHandler | params: diDetailParamSchema |
| GET | /api/v1/ref/modifiers | modifierListHandler | query: modifierLookupSchema |
| GET | /api/v1/ref/modifiers/:code | modifierDetailHandler | params: modifierDetailParamSchema |
| GET | /api/v1/ref/functional-centres | fcListHandler | query: fcListSchema |
| GET | /api/v1/ref/explanatory-codes/:code | explCodeHandler | params: explCodeParamSchema |
| GET | /api/v1/ref/rrnp/:community_id | rrnpHandler | params: rrnpParamSchema, query: rrnpLookupSchema |
| GET | /api/v1/ref/pcpcm/:hsc_code | pcpcmHandler | params: pcpcmParamSchema, query: pcpcmLookupSchema |
| GET | /api/v1/ref/holidays | holidayListHandler | query: holidayListSchema |
| GET | /api/v1/ref/holidays/check | holidayCheckHandler | query: holidayCheckSchema |

**Route registration:**
In `reference.routes.ts`, export a Fastify plugin function that registers all routes. Use the `authenticate` preHandler hook from Domain 1 middleware on all routes. Follow the route registration pattern used by other domains (check `apps/api/src/domains/iam/` for reference).

**Handler implementations:**

`searchHscHandler`: Validate query, call `searchHscCodes(q, { specialty, facility, date, limit })`, return `{ results: HscSearchResult[] }`.

`hscFavouritesHandler`: Get userId from request.user, call `getHscFavourites(userId)`, return `{ favourites: HscSearchResult[] }`.

`hscDetailHandler`: Validate params/query, call `getHscDetail(code, date)`, return full detail or 404.

`searchDiHandler`: Validate query, call `searchDiCodes(q, { specialty, limit })`, return `{ results: DiSearchResult[] }`.

`diDetailHandler`: Call `getDiDetail(code)`, return full detail or 404.

`modifierListHandler`: Validate query, call `getModifiersForHsc(hsc, date)` or `listAllModifiers` if no HSC specified, return `{ modifiers: ModifierResult[] }`.

`modifierDetailHandler`: Call `getModifierDetail(code)`, return full detail or 404.

`fcListHandler`: Validate query, resolve version, call `listFunctionalCentres(versionId, facility_type)`, return `{ centres: FunctionalCentreResult[] }`.

`explCodeHandler`: Call `getExplanatoryCode(code)`, return full detail or 404.

`rrnpHandler`: Validate params/query, call `getRrnpRate(community_id, date)`, return rate or 404.

`pcpcmHandler`: Validate params/query, call `getPcpcmBasket(hsc_code, date)`, return basket or 404.

`holidayListHandler`: Validate query, call `listHolidays(year)`, return `{ holidays: Holiday[] }`.

`holidayCheckHandler`: Validate query, call `isHoliday(date)`, return `{ is_holiday: boolean, holiday_name?: string }`.

**Error handling:** Return 400 for validation errors, 404 for not found, 401 for missing auth.

## Critical Security Rules

- All search/lookup routes require authentication and active subscription.
- Version-aware routes must use the date query parameter for version resolution, not the current date.
- Search results must not include data from unpublished staging versions.

## Prerequisites

- D02-020 must be complete (service with search functions).
- D02-021 must be complete (service with modifier/rule/supporting lookups).
- D02-024 must be complete (service with holiday management).

## Tests to Write

Create `apps/api/test/integration/reference/search.integration.ts`:

- GET /ref/hsc/search returns HSC results for keyword
- GET /ref/hsc/search returns version-appropriate results for date param
- GET /ref/hsc/:code returns full HSC detail
- GET /ref/di/search returns DI results with surcharge flags
- GET /ref/modifiers returns applicable modifiers for HSC
- GET /ref/rrnp/:id returns RRNP rate for community
- GET /ref/pcpcm/:code returns basket classification
- GET /ref/holidays returns holidays for year
- GET /ref/holidays/check correctly identifies holiday
- All routes return 401 without auth

## FRD Reference

- Domain 2 Section 4.1: 13 search/lookup endpoints with date-of-service parameter for version awareness.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/reference/
```

All tests must pass before outputting [TASK_COMPLETE].
