# Task D02-011: Repository â€” WCB codes, modifier definitions, and governing rules queries

## What to Build

Add to `apps/api/src/domains/reference/reference.repository.ts`:

**WCB codes:**
- `searchWcbCodes(query: string, versionId: string, limit: number)` -- full-text + pg_trgm search on wcb_code and description. Filter by version_id. Return: id, wcb_code, description, base_fee, fee_type, help_text. Order by relevance.
- `findWcbByCode(wcbCode: string, versionId: string)` -- full detail including all fields: requires_claim_number, requires_employer, documentation_requirements, help_text. Return single record or null.

**Modifier definitions:**
- `findModifiersForHsc(hscCode: string, versionId: string)` -- find applicable modifiers based on applicable_hsc_filter JSONB matching against the given HSC code. Filter by version_id. Return array of modifier definitions.
- `findModifierByCode(modifierCode: string, versionId: string)` -- full detail including combinable_with, exclusive_with, calculation_params, governing_rule_reference. Return single record or null.
- `listAllModifiers(versionId: string)` -- all modifiers for a version.

**Governing rules:**
- `findRulesForContext(hscCodes: string[], diCode: string | null, facilityType: string | null, versionId: string)` -- return all rules applicable to a claim context. Filter by version_id. Match rules where rule_logic JSONB references any of the provided HSC codes, DI code, or facility type. Also return rules in general category.
- `findRuleById(ruleId: string, versionId: string)` -- full detail with rule_logic JSON. Return single record or null.
- `listRulesByCategory(category: string, versionId: string)` -- all rules in a category for a version.

Use Drizzle ORM query builder. Follow existing repository patterns.

## Critical Security Rules

- Rule_logic JSONB is data only -- it is never evaluated in the Reference Data domain. The Claim Lifecycle validation engine evaluates it.
- Modifier applicability filtering must be accurate -- incorrect modifiers on claims lead to rejections.

## Prerequisites

- D02-009 must be complete (database migration applied, tables exist).
- D02-010 should be complete (base repository file created).

## Tests to Write

Add tests to `apps/api/src/domains/reference/reference.test.ts`:

- searchWcbCodes returns results for code prefix
- searchWcbCodes returns results for keyword
- findModifiersForHsc returns applicable modifiers only
- findModifiersForHsc excludes incompatible modifiers
- findRulesForContext returns relevant rules for HSC codes
- findRulesForContext filters by category
- findRuleById returns full rule_logic JSON
- All queries respect version_id parameter

## FRD Reference

- Domain 2 Section 2.2: WCB fee schedule with ~500-1,000 records.
- Domain 2 Section 2.3: Modifier definitions with ~15-20 modifiers including CMGP, LSCD, AFHR, BCP, RRNP, TM, ANE, AST.
- Domain 2 Section 2.4: Governing rules ~50-80 rules across GR 1-13 + surcharge rules.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
