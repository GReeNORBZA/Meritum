# Task D02-024: Service â€” holiday management, change summaries, and contextual help

## What to Build

Add to `apps/api/src/domains/reference/reference.service.ts`:

**Holiday management (admin):**
- `createHoliday(adminUserId: string, data: { date: string, name: string, jurisdiction: string, affects_billing_premiums: boolean })` -- create holiday via repository. Audit log: `ref.holiday_created` with admin_id, date, name. Return created holiday.
- `updateHoliday(adminUserId: string, holidayId: string, data: Partial<{ date: string, name: string, jurisdiction: string, affects_billing_premiums: boolean }>)` -- update holiday via repository. Audit log: `ref.holiday_updated` with admin_id, old_values, new_values. Return updated holiday.
- `deleteHoliday(adminUserId: string, holidayId: string)` -- delete holiday via repository. Audit log: `ref.holiday_deleted` with admin_id, holiday_id, date. Return success.
- `listHolidays(year: number)` -- list holidays for year via repository. No audit (read-only).
- `checkHolidayCalendarPopulated(nextYear: number)` -- check if holidays exist for the next year. Return `{ populated: boolean, count: number }`. Used by the annual November reminder to alert admins if next year's calendar is not yet entered.

**Change summaries:**
- `getChangeSummaries(dataSet?: string, sinceDate?: Date)` -- list version publications with change stats. Query reference_data_versions ordered by published_at DESC. Optionally filter by data_set and/or since date. Return: `{ versions: Array<{ version_id, data_set, version_label, effective_from, published_at, records_added, records_modified, records_deprecated, change_summary }> }`.
- `getChangeDetail(versionId: string, specialty?: string)` -- detailed diff for a specific version. Show code-level changes. If specialty provided, filter to codes relevant to that specialty (using specialty_restrictions). Return: `{ added: [...], modified: [...], deprecated: [...] }` with full code details.
- `getPhysicianImpact(versionId: string, userId: string)` -- personalised impact assessment for a physician:
  1. Find deprecated codes the physician has billed in the last 12 months.
  2. Find fee changes on frequently-used codes.
  3. Find new codes relevant to the physician's specialties.
  4. Return: `{ deprecated_codes_used: [...], fee_changes: [...], new_relevant_codes: [...] }`.

**Contextual help:**
- Help text is served as part of existing endpoints (included in HSC detail, modifier detail, rule detail, etc.). No separate help endpoint needed.
- Ensure all help_text fields are included in search results and detail responses from D02-020 and D02-021.

## Prerequisites

- D02-012 must be complete (repository with holiday, functional centre, and explanatory code operations).

## Tests to Write

Add tests to `apps/api/src/domains/reference/reference.test.ts`:

- createHoliday inserts holiday with audit log
- updateHoliday modifies holiday fields
- deleteHoliday removes holiday with audit log
- listHolidays returns correct holidays for year
- checkHolidayCalendarPopulated detects missing next year
- getChangeSummaries filters by data set and date
- getChangeDetail filters by specialty
- getPhysicianImpact highlights deprecated codes the physician used

## FRD Reference

- Domain 2 Section 2.9: Statutory holidays -- admin can create, update, delete holidays.
- Domain 2 Section 4.4: Change summary endpoints -- list publications, detail with specialty filter, physician impact.
- Domain 2 Section 7: Contextual help text served with all detail endpoints.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
