# Task D02-021: Service â€” modifier lookup, validation support, and governing rule queries

## What to Build

Add to `apps/api/src/domains/reference/reference.service.ts`:

**Modifier lookup:**
- `getModifiersForHsc(hscCode: string, dateOfService?: Date)` -- resolve MODIFIERS version for date of service. Return applicable modifiers with calculation details (calculation_method, calculation_params) and help text. Filter by applicable_hsc_filter matching the given HSC code.

- `getModifierDetail(modifierCode: string)` -- resolve active MODIFIERS version. Return full modifier detail including combinable_with, exclusive_with, calculation_method, calculation_params, governing_rule_reference, help_text.

**Validation context (primary interface for Claim Lifecycle):**
- `getValidationContext(hscCodes: string[], diCode: string | null, facilityCode: string | null, dateOfService: Date, modifiers?: string[])` --
  1. Resolve all relevant versions: SOMB, MODIFIERS, GOVERNING_RULES, FUNCTIONAL_CENTRES for the date of service.
  2. For each HSC code: look up full details (restrictions, combination group).
  3. Look up applicable governing rules via `findRulesForContext`.
  4. Look up modifier applicability for each HSC code.
  5. Validate facility code against functional_centres if provided.
  6. Return comprehensive context: `{ hscDetails: [...], applicableRules: [...], modifierApplicability: [...], facilityValidation: {...}, versionInfo: {...} }`.
  This is the primary interface that Claim Lifecycle's validation engine calls. It does NOT evaluate rules -- it returns the rule data.

**Rule queries:**
- `getRuleDetail(ruleId: string, dateOfService?: Date)` -- resolve GOVERNING_RULES version. Return full rule detail with rule_logic JSON.

- `evaluateRulesBatch(claims: Array<{ hscCodes: string[], diCode?: string, facilityCode?: string, dateOfService: Date, modifiers?: string[] }>)` -- for batch import: resolve versions per claim date and return all applicable rules per claim. Does NOT evaluate rules -- just returns the rule data for Claim Lifecycle to evaluate. Group claims by date to minimise version lookups.

**Supporting lookups:**
- `getRrnpRate(communityId: string, dateOfService?: Date)` -- resolve RRNP version for date. Return community name and percentage rate.
- `getPcpcmBasket(hscCode: string, dateOfService?: Date)` -- resolve PCPCM version for date. Return basket classification.
- `isHoliday(date: Date)` -- check statutory holiday calendar. Return `{ is_holiday: boolean, holiday_name?: string }`.
- `getExplanatoryCode(code: string)` -- resolve EXPLANATORY_CODES active version. Return full detail with common_cause and suggested_action.

## Critical Security Rules

- getValidationContext is called by other domains. It must only return published, version-appropriate data.
- evaluateRulesBatch is limited to 500 claims per request (enforced by Zod schema) to prevent DoS.

## Prerequisites

- D02-010 must be complete (repository with version management).
- D02-011 must be complete (repository with WCB, modifier, and rule queries).

## Tests to Write

Add tests to `apps/api/src/domains/reference/reference.test.ts`:

- getModifiersForHsc returns applicable modifiers only
- getModifiersForHsc excludes incompatible modifiers
- getValidationContext returns all rules for claim context
- getValidationContext resolves correct version for date
- evaluateRulesBatch handles multiple claims with different dates
- getRrnpRate returns correct rate for community and date
- getPcpcmBasket returns correct basket classification
- isHoliday correctly identifies Alberta statutory holidays
- getExplanatoryCode returns common cause and suggested action

## FRD Reference

- Domain 2 Section 4.2: 4 internal validation endpoints. getValidationContext is the primary data interface for Claim Lifecycle.
- Domain 2 Section 2.3: Modifier definitions with calculation methods and applicability filtering.
- Domain 2 Section 2.4: Governing rules with machine-readable rule_logic JSONB.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
