# Task D02-022: Service â€” admin data ingestion (upload, schema validation, diff generation)

## What to Build

Add to `apps/api/src/domains/reference/reference.service.ts`:

**Upload and validate:**
- `uploadDataSet(adminUserId: string, dataSet: string, fileBuffer: Buffer, fileName: string)` --
  1. Parse file: determine format from file extension or content sniffing. Support CSV (using a CSV parser) and JSON (JSON.parse).
  2. Schema-validate each record against expected fields for the data set. Use per-data-set validation schemas:
     - SOMB: validate hsc_code format (alphanumeric, max 10), non-negative base_fee, valid fee_type enum, valid JSONB arrays.
     - WCB: validate wcb_code format, non-negative base_fee, valid fee_type enum.
     - MODIFIERS: validate modifier_code, valid type enum, valid calculation_method enum.
     - GOVERNING_RULES: validate rule_id format, valid rule_category enum, valid severity enum, rule_logic is valid JSON.
     - FUNCTIONAL_CENTRES: validate code format, valid facility_type enum.
     - DI_CODES: validate di_code format, boolean flags.
     - RRNP: validate community_name, non-negative rrnp_percentage.
     - PCPCM: validate hsc_code, valid basket enum.
     - EXPLANATORY_CODES: validate expl_code, valid severity enum.
  3. Collect validation errors with field name and line number: `{ line: number, field: string, message: string }[]`.
  4. Compute SHA-256 hash of file buffer for integrity.
  5. Store in staging table via `createStagingRecord` with status=UPLOADED.
  6. If validation errors exist: update status to VALIDATED with validation_result containing errors. Return errors.
  7. If clean: auto-generate diff against active version (call `generateDiff`). Update status to DIFF_GENERATED.
  8. Audit log: `ref.version_staged` with admin_id, data_set, staging_id, record_count, file_hash.
  9. Return `{ staging_id, validation_result, record_count, status }`.

**Diff generation:**
- `getStagingDiff(adminUserId: string, dataSet: string, stagingId: string)` --
  1. Find staging record. Verify it belongs to the specified data set.
  2. Generate or retrieve diff against the active version: compare staged records to current live records.
  3. Diff result: `{ added: Record[], modified: Record[], deprecated: Record[], summary_stats: { added: number, modified: number, deprecated: number } }`.
  4. For modified records: include field-level changes: `{ field: string, old_value: unknown, new_value: unknown }[]`.
  5. Audit log: `ref.version_diff_reviewed` with admin_id, staging_id, diff_stats.
  6. Return diff result.

**Discard:**
- `discardStaging(adminUserId: string, dataSet: string, stagingId: string)` --
  1. Delete staging record via repository.
  2. Audit log: `ref.staging_discarded` with admin_id, staging_id, data_set.

**Schema validation rules per data set:** Validate required fields, data types, code formats (alphanumeric, max length), non-negative fees, valid enum values. Generate clear error messages: `"Line 42, field 'base_fee': must be a non-negative number"`.

## Critical Security Rules

- Uploaded files must be validated thoroughly -- reject invalid data before it reaches staging.
- File hash prevents duplicate uploads and supports integrity verification.
- All staging operations are admin-only and audit-logged.

## Prerequisites

- D02-010 must be complete (repository with version management for diff generation).
- D02-013 must be complete (repository with staging operations).

## Tests to Write

Add tests to `apps/api/src/domains/reference/reference.test.ts`:

- uploadDataSet parses CSV correctly
- uploadDataSet parses JSON correctly
- uploadDataSet rejects invalid schema with line-specific errors
- uploadDataSet rejects negative fees
- uploadDataSet computes correct file hash
- getStagingDiff generates correct diff
- getStagingDiff highlights field-level changes
- discardStaging removes staging record
- All operations create audit log entries

## FRD Reference

- Domain 2 Section 6.2: Staging workflow -- data uploaded to staging, validated, diff generated, then published or discarded.
- Domain 2 Section 8.2: Audit actions ref.version_staged, ref.version_diff_reviewed, ref.staging_discarded.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
