# Task D02-023: Service â€” admin publishing (stage -> publish, rollback, event emission)

## What to Build

Add to `apps/api/src/domains/reference/reference.service.ts`:

**Publish version:**
- `publishVersion(adminUserId: string, dataSet: string, stagingId: string, metadata: { versionLabel: string, effectiveFrom: string, sourceDocument?: string, changeSummary?: string })` --
  1. Find staging record. Verify status is DIFF_GENERATED. Reject if not.
  2. **Large change safety gate:** If diff shows >500 modified records or >100 deprecated codes, require an additional `confirmLargeChange: true` flag in the request. Return 409 with warning if flag not present.
  3. Create new version record in reference_data_versions via `createVersion`.
  4. Parse staged_data JSONB from staging record.
  5. Bulk insert records from staging into the appropriate live table (transactional via repository bulk insert functions). Route to correct bulk insert based on data_set.
  6. Activate new version via `activateVersion` (set is_active=true, set previous version's effective_to).
  7. Delete staging record (now published).
  8. Emit `reference_data.version_published` event for Notification Service: `{ dataSet, versionId, versionLabel, effectiveFrom, changeSummary, recordsAdded, recordsModified, recordsDeprecated }`.
  9. If any deprecated codes were billed by physicians in last 12 months: emit `reference_data.code_deprecated` event with affected codes and physician IDs.
  10. Audit log: `ref.version_published` with admin_id, version_id, data_set, effective_from.
  11. Return `{ version_id }`.

**Rollback version:**
- `rollbackVersion(adminUserId: string, versionId: string, reason: string)` --
  1. Find the version. Verify it is currently active.
  2. Find the previous version for the same data_set (the one with the most recent effective_from before this version).
  3. Deactivate current version via `deactivateVersion`.
  4. Re-activate previous version: set previous version's effective_to back to NULL, set is_active=true.
  5. Audit log: `ref.version_rolled_back` with admin_id, version_id, data_set, reason.
  Note: Rollback does NOT delete the erroneous version. It deactivates it and re-activates the previous version. The erroneous version is preserved for audit trail.

**Dry-run rule evaluation:**
- `dryRunRule(adminUserId: string, ruleId: string, updatedRuleLogic: object)` --
  1. Find the current rule by ruleId.
  2. Run updated rule_logic against a sample of recent claims (last 30 days, up to 1,000 claims).
  3. Return `{ claims_affected: number, sample_results: Array<{ claim_id: string, would_trigger: boolean, details: string }> }`.
  4. Audit log: `ref.rule_dry_run` with admin_id, rule_id, claims_sampled.

## Critical Security Rules

- Publication is atomic -- all records go live simultaneously or none do.
- Published versions are immutable. No editing individual records after publication.
- Rollback does not delete the erroneous version -- it deactivates it and re-activates the previous version. Audit trail is preserved.
- Large change safety gate prevents accidental publication of corrupted data.

## Prerequisites

- D02-010 must be complete (repository with version management).
- D02-013 must be complete (repository with staging and bulk insert operations).
- D02-022 must be complete (staging diff is available for safety gate check).

## Tests to Write

Add tests to `apps/api/src/domains/reference/reference.test.ts`:

- publishVersion creates version and inserts all records
- publishVersion activates new version and deactivates old
- publishVersion emits version_published event
- publishVersion emits code_deprecated for billed codes
- publishVersion requires large-change confirmation when threshold exceeded
- rollbackVersion re-activates previous version
- rollbackVersion preserves deactivated version for audit
- dryRunRule returns affected claims count
- Publication is atomic -- failure rolls back all inserts

## FRD Reference

- Domain 2 Section 6.2: Staging workflow -- publish step creates version and bulk inserts records.
- Domain 2 Section 6.3: Rollback re-activates previous version without deleting current.
- Domain 2 Section 8.2: Audit actions ref.version_published, ref.version_rolled_back, ref.rule_dry_run.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/reference/reference.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
