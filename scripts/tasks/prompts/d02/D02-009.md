# Task D02-009: Generate and apply database migration for all Reference Data tables

## What to Build

Run the Drizzle migration generator for all Reference Data tables:

```bash
cd apps/api
pnpm drizzle-kit generate
pnpm drizzle-kit migrate
```

**Verify migration file created in `apps/api/drizzle/migrations/`.**

**Verify all 12 tables exist:**
1. reference_data_versions
2. hsc_codes
3. wcb_codes
4. modifier_definitions
5. governing_rules
6. functional_centres
7. di_codes
8. rrnp_communities
9. pcpcm_baskets
10. statutory_holidays
11. explanatory_codes
12. reference_data_staging

**Verify pg_trgm extension is enabled:**
Ensure `CREATE EXTENSION IF NOT EXISTS pg_trgm` is included in the migration or already exists. This is required for fuzzy search indexes on hsc_codes, wcb_codes, and di_codes.

**Verify GIN and pg_trgm indexes:**
- GIN index on hsc_codes.description for full-text search
- pg_trgm index on hsc_codes.hsc_code and description for fuzzy search
- pg_trgm index on wcb_codes.wcb_code and description
- GIN index on di_codes.description for full-text search
- pg_trgm index on di_codes.di_code and description

**Verify all FK relationships:**
- hsc_codes.version_id -> reference_data_versions.version_id
- wcb_codes.version_id -> reference_data_versions.version_id
- modifier_definitions.version_id -> reference_data_versions.version_id
- governing_rules.version_id -> reference_data_versions.version_id
- functional_centres.version_id -> reference_data_versions.version_id
- functional_centres.rrnp_community_id -> rrnp_communities.community_id
- di_codes.version_id -> reference_data_versions.version_id
- rrnp_communities.version_id -> reference_data_versions.version_id
- pcpcm_baskets.version_id -> reference_data_versions.version_id
- explanatory_codes.version_id -> reference_data_versions.version_id
- reference_data_versions.published_by -> users.user_id
- reference_data_staging.uploaded_by -> users.user_id

**Verify constraints:**
- Partial unique index for single active version per data_set: `UNIQUE (data_set) WHERE is_active = true`
- Unique constraint on statutory_holidays.date

If the migration fails, review the schema file for errors, fix them, and re-run.

## Prerequisites

- D02-002 through D02-006 must all be complete (all table schemas defined).
- Database must be running and accessible.

## Run After Completion

```bash
cd apps/api && pnpm drizzle-kit generate 2>&1 && pnpm drizzle-kit migrate 2>&1
```

All migrations must apply cleanly before outputting [TASK_COMPLETE].
