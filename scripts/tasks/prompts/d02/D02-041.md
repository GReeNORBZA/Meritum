# Task D02-041: Security â€” authorization and role enforcement

## What to Build

Create `apps/api/test/security/reference/reference.authz.security.ts`.

**Admin routes reject non-admin users:**
- POST /api/v1/admin/ref/somb/upload as physician -> 403
- POST /api/v1/admin/ref/somb/staging/:id/publish as physician -> 403
- DELETE /api/v1/admin/ref/somb/staging/:id as physician -> 403
- GET /api/v1/admin/ref/somb/staging/:id/diff as physician -> 403
- GET /api/v1/admin/ref/somb/versions as physician -> 403
- POST /api/v1/admin/ref/holidays as physician -> 403
- PUT /api/v1/admin/ref/holidays/:id as physician -> 403
- DELETE /api/v1/admin/ref/holidays/:id as physician -> 403
- POST /api/v1/admin/ref/rules/:id/dry-run as physician -> 403
- All admin routes as delegate -> 403

**Search routes allow delegate with appropriate permissions:**
- Delegate with CLAIM_VIEW permission can access GET /api/v1/ref/hsc/search -> 200
- Delegate with CLAIM_VIEW permission can access GET /api/v1/ref/di/search -> 200
- Delegate with CLAIM_VIEW permission can access GET /api/v1/ref/modifiers -> 200
- Delegate without CLAIM_VIEW permission cannot access search routes -> 403

**Subscription-gated access:**
- SUSPENDED user: read-only access to reference data (search and lookup allowed, no write operations)
  - GET /api/v1/ref/hsc/search as SUSPENDED -> 200
  - GET /api/v1/ref/hsc/:code as SUSPENDED -> 200
  - GET /api/v1/ref/holidays as SUSPENDED -> 200
- CANCELLED user: no access to any reference data routes
  - GET /api/v1/ref/hsc/search as CANCELLED -> 403
  - GET /api/v1/ref/di/search as CANCELLED -> 403

**Admin routes accept admin users:**
- POST /api/v1/admin/ref/somb/upload as admin -> accepted (not 403)
- POST /api/v1/admin/ref/holidays as admin -> accepted (not 403)

Use the test helpers/fixtures from the project. Create test users with appropriate roles (physician, delegate, admin). Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference).

## Critical Security Rules

- Admin routes are strictly admin-only. No exceptions for physician or delegate roles.
- Delegates access reference data within their permission boundaries only.
- Subscription status gates access appropriately.

## Prerequisites

- D02-030 must be complete (search/lookup routes).
- D02-031 must be complete (admin routes).
- D02-032 must be complete (internal validation and change summary routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/reference/reference.authz.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
