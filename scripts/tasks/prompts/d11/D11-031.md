# D11-031 — Routes: IMA, AHC11236, PIA Document Endpoints

**Task ID:** D11-031
**Domain:** 11 — Onboarding
**Section:** Routes & Integration Tests
**Depends on:** D11-021, D11-030
**Verify:** `pnpm --filter api vitest run test/integration/onboarding/`

---

## Build Instructions

Add to `apps/api/src/domains/onboarding/onboarding.routes.ts` the document endpoints.

### Routes

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | /api/v1/onboarding/ima | Physician | Get rendered IMA document content and hash |
| POST | /api/v1/onboarding/ima/acknowledge | Physician | Record IMA acknowledgement |
| GET | /api/v1/onboarding/ima/download | Physician | Download acknowledged IMA as PDF |
| GET | /api/v1/onboarding/ahc11236/download | Physician | Download pre-filled AHC11236 as PDF |
| GET | /api/v1/onboarding/pia/download | Physician | Download PIA appendix as PDF |

### Handler Details

**GET /ima** handler:
- Call `renderIma(providerId)`
- Return `{ content: string, hash: string, template_version: string }`

**POST /ima/acknowledge** handler:
- Validate body with `imaAcknowledgeSchema` (document_hash)
- Extract IP address and user agent from request
- Call `acknowledgeIma(providerId, clientHash, ipAddress, userAgent)`
- Return IMA record

**GET /ima/download** handler:
- Call `downloadImaPdf(providerId)`
- Set `Content-Type: application/pdf`
- Set `Content-Disposition: attachment; filename="IMA-{provider_name}.pdf"`
- Return PDF buffer

**GET /ahc11236/download** handler:
- Call `generateAhc11236Pdf(providerId)`
- Set PDF headers (`Content-Type: application/pdf`, `Content-Disposition: attachment`)
- Return PDF buffer

**GET /pia/download** handler:
- Call `downloadPiaPdf()`
- Set PDF headers
- Return static PIA PDF

### Integration Tests

Create `apps/api/test/integration/onboarding/onboarding-documents.integration.ts`.

---

## FRD References

- **Domain 11 Section 9:** All IMA, AHC11236, and PIA endpoints.
- **Domain 11 Section 3.3:** IMA acknowledge stores hash, timestamp, IP, user agent.

---

## Security Requirements

- IMA download only returns PDFs belonging to the authenticated physician's provider.
- IMA acknowledge verifies hash match before storing — prevents acknowledging a tampered document.
- All document downloads require authentication — no public access.

---

## Test Specifications

Create `apps/api/test/integration/onboarding/onboarding-documents.integration.ts`:

1. GET /ima returns rendered IMA with hash
2. POST /ima/acknowledge with matching hash creates IMA record
3. POST /ima/acknowledge with mismatched hash returns 400
4. GET /ima/download returns PDF for provider with acknowledged IMA
5. GET /ima/download returns 404 if no IMA acknowledged
6. GET /ahc11236/download returns pre-filled PDF
7. GET /ahc11236/download after step 3 includes correct BA number
8. GET /pia/download returns PIA PDF

---

## Codebase Context

- **Module location:** `apps/api/src/domains/onboarding/onboarding.routes.ts` (same file as D11-030)
- **PDF response pattern:** Use Fastify's `.type('application/pdf')` and `.header('Content-Disposition', ...)` for PDF responses.
- **IP extraction:** Use `request.ip` or `request.headers['x-forwarded-for']` depending on proxy setup.
- **User agent:** Use `request.headers['user-agent']`.
- **Integration test location:** `apps/api/test/integration/onboarding/`
- **Mock Spaces:** Mock DigitalOcean Spaces in integration tests to avoid external calls.
