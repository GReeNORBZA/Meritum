# D11-030 — Routes: Onboarding Progress, Step Completion, and Middleware Gate

**Task ID:** D11-030
**Domain:** 11 — Onboarding
**Section:** Routes & Integration Tests
**Depends on:** D11-020
**Verify:** `pnpm --filter api vitest run test/integration/onboarding/`

---

## Build Instructions

Create `apps/api/src/domains/onboarding/onboarding.routes.ts` and `onboarding.handlers.ts`.

### Routes

| Method | Path | Auth | Description |
|--------|------|------|-------------|
| GET | /api/v1/onboarding/progress | Physician | Get current onboarding progress |
| POST | /api/v1/onboarding/steps/:step_number | Physician | Complete a step with step-specific data |

### GET /progress

Returns:
- All step booleans (`step_1_completed` through `step_7_completed`)
- `patient_import_completed`, `guided_tour_completed`, `guided_tour_dismissed`
- `started_at`, `completed_at`
- Computed: `current_step`, `is_complete`, `required_steps_remaining`

### POST /steps/:step_number

Handler:
1. Parse `step_number` from params (1-7) using `stepNumberParamSchema`
2. Validate body against step-specific Zod schema (step1Schema for step 1, etc.)
3. Call corresponding `completeStepN` service method
4. Return updated progress

### Onboarding Gate Middleware

**This is critical.** Register a Fastify `onRequest` hook on all non-onboarding API routes.

**Implementation:**
- The middleware should be a Fastify `onRequest` hook
- For authenticated physician users, check onboarding status via `getOnboardingStatus`
- If onboarding not complete, return **403** with `{ error: 'onboarding_required', current_step: N }`
- **Skip for:** onboarding routes themselves (`/api/v1/onboarding/*`)
- **Skip for:** auth routes (`/api/v1/auth/*`)
- **Skip for:** subscription routes
- **Skip for:** delegate users (they don't go through onboarding)
- **Skip for:** admin users

The gate ensures physicians cannot access platform features (claims, patients, etc.) until they complete onboarding.

---

## FRD References

- **Domain 11 Section 9:** GET /api/v1/onboarding/progress and POST /api/v1/onboarding/steps/{step_number}.
- **Domain 11 Section 2.1:** Platform blocks claim creation until `onboarding_completed = true`.

---

## Security Requirements

- Onboarding routes require physician role — delegates cannot modify onboarding state.
- Step completion validates input server-side — client cannot skip validation.
- Onboarding gate middleware prevents access to platform features until onboarding is complete.

---

## Test Specifications

Create integration tests in `apps/api/test/integration/onboarding/onboarding-progress.integration.ts`:

1. GET /progress returns onboarding status for authenticated physician
2. GET /progress returns 404 if no provider record exists
3. POST /steps/1 with valid data marks step 1 complete
4. POST /steps/1 with invalid billing number returns 400
5. POST /steps/3 with PCPCM but missing dual-BA returns 400
6. POST /steps/8 returns 400 (invalid step number)
7. Completing steps 1, 2, 3, 4, 7 in sequence sets onboarding complete
8. Onboarding gate blocks /api/v1/claims when onboarding incomplete
9. Onboarding gate allows /api/v1/onboarding routes through
10. Onboarding gate skips check for delegate users

---

## Codebase Context

- **Module location:** `apps/api/src/domains/onboarding/`
- **Route registration:** Follow the existing Fastify route registration pattern used by other domains. Typically a plugin function registered in the main app setup.
- **Handler pattern:** Thin handlers that extract data from request and delegate to service. Handlers in separate file from routes.
- **Auth pattern:** Session cookie auth with `request.session.user` containing `{ id, role, physician_id }`. Roles: physician, delegate, admin.
- **Zod validation:** Use schemas from `packages/shared` for request body validation.
- **Integration test location:** `apps/api/test/integration/onboarding/`
- **Integration test pattern:** Look at existing integration tests in `apps/api/test/integration/` for the established pattern (app setup, authenticated requests, assertions).
- **Onboarding gate:** This is a global hook, not per-route. Register it at the app level but with path-based skip logic.
