# D11-011 — Repository: IMA Records (Append-Only Acknowledgements)

**Task ID:** D11-011
**Domain:** 11 — Onboarding
**Section:** Repository Layer
**Depends on:** D11-005
**Verify:** `pnpm --filter api vitest run src/domains/onboarding/onboarding.test.ts`

---

## Build Instructions

Add to `apps/api/src/domains/onboarding/onboarding.repository.ts` the IMA record operations.

### Repository Functions

- **`createImaRecord(data: { providerId, templateVersion, documentHash, ipAddress, userAgent })`** — Insert IMA acknowledgement record with `acknowledged_at = now()`.

- **`findLatestImaRecord(providerId: string)`** — Return the most recent IMA record for this provider (by `acknowledged_at DESC`). Used to check if current template version is acknowledged.

- **`listImaRecords(providerId: string)`** — Return all IMA records for this provider in reverse chronological order.

### CRITICAL: Append-Only

IMA records are **append-only**. There must be **NO UPDATE or DELETE operations** exposed by the repository. Each re-acknowledgement creates a new row.

---

## Security Requirements

- IMA records are append-only — no update or delete. This preserves the regulatory audit trail.
- All IMA queries are scoped to `provider_id` — no cross-physician access.
- `document_hash` provides tamper evidence for the acknowledged IMA document.

---

## Test Specifications

Add to `apps/api/src/domains/onboarding/onboarding.test.ts`:

1. `createImaRecord` inserts record with correct fields and `acknowledged_at`
2. `findLatestImaRecord` returns most recent for provider
3. `findLatestImaRecord` returns null for provider with no IMA records
4. `listImaRecords` returns all records in reverse chronological order
5. `ima_records` has no update function (verify the repository module does not export any update/delete for IMA)
6. `ima_records` has no delete function

---

## Codebase Context

- **Module location:** `apps/api/src/domains/onboarding/onboarding.repository.ts` (same file as D11-010)
- **DB:** PostgreSQL via Drizzle ORM
- **Append-only pattern:** This is a regulatory audit trail requirement. The repository must not expose any mutation operations beyond `createImaRecord`.
- **Existing pattern:** Look at other domain repositories for query ordering patterns (e.g., `.orderBy(desc(table.column))`).
- **Test file:** Same test file as D11-010 (`onboarding.test.ts`). Add new describe block for IMA repository tests.
