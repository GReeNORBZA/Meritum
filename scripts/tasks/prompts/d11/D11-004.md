# D11-004 — Zod Validation Schemas for Onboarding Step Inputs and API Responses

**Task ID:** D11-004
**Domain:** 11 — Onboarding
**Section:** Shared Types & Constants
**Depends on:** D11-001
**Verify:** `pnpm --filter shared build`

---

## Build Instructions

Create `packages/shared/src/schemas/onboarding.schema.ts` with Zod schemas for all onboarding endpoints.

### Step 1 — Professional Identity

```typescript
step1Schema: {
  billing_number: string().regex(/^\d{5}$/)  // 5-digit AHCIP practitioner ID
  cpsa_number: string().min(1).max(20),
  legal_first_name: string().min(1).max(100),
  legal_last_name: string().min(1).max(100)
}
```

### Step 2 — Specialty & Type

```typescript
step2Schema: {
  specialty_code: string().min(1).max(10),  // validated against Reference Data
  physician_type: enum(['gp', 'specialist', 'locum'])
}
```

### Step 3 — Business Arrangement

```typescript
step3Schema: {
  primary_ba_number: string().min(1).max(20),
  is_pcpcm_enrolled: boolean(),
  pcpcm_ba_number: string().max(20).optional(),
  ffs_ba_number: string().max(20).optional()
}
```

**Refinement:** If `is_pcpcm_enrolled` is true, both `pcpcm_ba_number` and `ffs_ba_number` are required.

### Step 4 — Practice Location

```typescript
step4Schema: {
  location_name: string().min(1).max(200),
  functional_centre_code: string().min(1).max(10),
  facility_number: string().max(20).optional(),
  address: addressSchema,
  community_code: string().min(1).max(10)
}

addressSchema: {
  street: string().min(1).max(200),
  city: string().min(1).max(100),
  province: string().length(2).default('AB'),
  postal_code: string().regex(/^[A-Z]\d[A-Z]\s?\d[A-Z]\d$/i)
}
```

### Step 5 — WCB Configuration

```typescript
step5Schema: {
  contract_id: string().min(1).max(20),
  role: string().min(1).max(50),
  skill_code: string().min(1).max(10)
}
```

### Step 6 — Submission Preferences

```typescript
step6Schema: {
  ahcip_mode: enum(['auto_clean', 'require_approval']).default('auto_clean'),
  wcb_mode: enum(['auto_clean', 'require_approval']).default('require_approval')
}
```

### Step Number Param

```typescript
stepNumberParamSchema: {
  step_number: coerce.number().int().min(1).max(7)
}
```

### IMA Acknowledge

```typescript
imaAcknowledgeSchema: {
  document_hash: string().length(64)  // client sends hash of displayed document; server verifies match
}
```

### Response Schemas

```typescript
onboardingProgressResponseSchema: {
  // progress object with all step booleans, started_at, completed_at
}
```

### Exports

Export all schemas and inferred types. Update `packages/shared/src/schemas/index.ts` to re-export from `./onboarding.schema`.

---

## FRD References

- **Domain 11 Section 2.1:** Step 1 requires billing number (5-digit numeric), CPSA number, legal name. Step 2: specialty code from AHCIP list, physician type GP/Specialist/Locum. Step 3: BA number, optional PCPCM dual-BA. Step 4: location with functional centre code, facility number, address, community code.
- **Domain 11 Section 3.3:** IMA acknowledgement stores document_hash (SHA-256 of rendered IMA).

---

## Codebase Context

- **Zod schema location:** `packages/shared/src/schemas/`
- **Barrel export:** Update `packages/shared/src/schemas/index.ts`
- **Existing pattern:** Look at other Zod schema files in `packages/shared/src/schemas/` for the established pattern (e.g., schema naming, type inference with `z.infer<typeof schema>`).
- **Refinement pattern:** Use `.refine()` or `.superRefine()` for cross-field validation (Step 3 PCPCM dual-BA check).
- **Step number coercion:** Use `z.coerce.number()` for the step_number path parameter since Fastify delivers path params as strings.
