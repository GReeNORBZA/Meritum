# D11-043 — Security: Input Validation and Injection Prevention

**Task ID:** D11-043
**Domain:** 11 — Onboarding
**Section:** Security Tests
**Depends on:** D11-030, D11-031, D11-032
**Verify:** `pnpm --filter api vitest run test/security/onboarding/onboarding.input.security.ts`

---

## Build Instructions

Create `apps/api/test/security/onboarding/onboarding.input.security.ts`.

### SQL Injection Payloads on String Inputs

Test that SQL injection payloads are rejected (return 400) or safely handled:

- `billing_number`: `' OR 1=1--`, `12345; DROP TABLE providers;--`
- `cpsa_number`: SQL injection payloads
- `legal_first_name`, `legal_last_name`: SQL injection payloads
- `ba_number` (primary_ba_number): SQL injection payloads
- `location_name`: SQL injection payloads

### XSS Payloads on Stored Text Fields

Test that XSS payloads are properly handled:

- `legal_first_name`: `<script>alert(1)</script>`
- `location_name`: `<img onerror=alert(1) src=x>`
- All text fields echoed back in IMA template must be escaped

### Format Validation

- `billing_number` with 4 digits -> 400
- `billing_number` with 6 digits -> 400
- `billing_number` with letters -> 400
- `step_number` with 0 -> 400
- `step_number` with 8 -> 400
- `step_number` with non-integer -> 400
- `postal_code` with invalid format -> 400

### Type Coercion Attacks

- Send number where string expected -> 400
- Send array where string expected -> 400
- Send null where required field expected -> 400
- Send step body for wrong step number (step 1 body to step 3) -> 400

### UUID Parameter Validation

- Non-UUID in `ba_id` path param -> 400

### IMA Hash Tampering

- POST /ima/acknowledge with empty hash -> 400
- POST /ima/acknowledge with wrong-length hash -> 400
- POST /ima/acknowledge with valid-format but wrong hash -> 400

---

## Codebase Context

- **Security test location:** `apps/api/test/security/onboarding/`
- **Zod validation:** The Zod schemas from D11-004 should reject most of these at the validation layer before reaching the service.
- **Drizzle ORM:** Parameterized queries prevent SQL injection at the DB layer, but validation should reject malformed inputs before they reach the query layer.
- **IMA template escaping:** If using Handlebars, ensure triple-stache `{{{var}}}` is NOT used — always use double-stache `{{var}}` for auto-escaping.
- **Existing pattern:** Look at existing input security tests in `apps/api/test/security/` for the established pattern.
