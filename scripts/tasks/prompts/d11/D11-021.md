# D11-021 — Service: IMA Generation, Acknowledgement, and Document Downloads

**Task ID:** D11-021
**Domain:** 11 — Onboarding
**Section:** Service Layer
**Depends on:** D11-011, D11-020
**Verify:** `pnpm --filter api vitest run src/domains/onboarding/onboarding.test.ts`

---

## Build Instructions

Add to `apps/api/src/domains/onboarding/onboarding.service.ts` the IMA, AHC11236, and PIA operations.

### IMA Operations

- **`renderIma(providerId: string)`** — Generate IMA document from Handlebars/Mustache template. Pre-fill with physician's legal name, CPSA number, BA number(s), Meritum corporate details, effective date. Return rendered HTML/text content and SHA-256 hash.

- **`acknowledgeIma(providerId: string, clientHash: string, ipAddress: string, userAgent: string)`** — Render the IMA, compute server-side hash, verify `clientHash` matches. Create IMA record. Generate and store IMA PDF immutably (DigitalOcean Spaces). Call `completeStep7`. Emit `onboarding.ima_acknowledged` audit event. Return IMA record.

- **`downloadImaPdf(providerId: string)`** — Retrieve stored IMA PDF from DigitalOcean Spaces. Emit `onboarding.ima_downloaded` audit event. Return PDF buffer.

- **`checkImaCurrentVersion(providerId: string)`** — Find latest IMA record. Compare `template_version` to current `IMA_TEMPLATE_VERSION`. Return `{ is_current: boolean, needs_reacknowledgement: boolean }`.

### AHC11236 Operations

- **`generateAhc11236Pdf(providerId: string)`** — Pre-fill AHC11236 form with physician's billing number, BA number, Meritum submitter prefix. Generate PDF using pdfkit or similar. Emit `onboarding.ahc11236_downloaded` audit event. Return PDF buffer.

### PIA Operations

- **`downloadPiaPdf()`** — Return PIA appendix PDF (static document, same for all physicians). Emit `onboarding.pia_downloaded` audit event.

### IMA Template

Stored as a Handlebars/Mustache template in the codebase (e.g., `apps/api/src/domains/onboarding/templates/ima.hbs`). Template version tracked in constants (`IMA_TEMPLATE_VERSION` from D11-001).

---

## FRD References

- **Domain 11 Section 3:** IMA generated from template pre-filled with physician details. Digital acknowledgement stores timestamp, hash, IP, user agent. Rendered PDF stored immutably.
- **Domain 11 Section 3.4:** PIA appendix downloadable PDF. Informational, no acknowledgement required.
- **Domain 11 Section 4:** AHC11236 pre-filled with physician details and Meritum submitter prefix. PDF for download, print, wet signature, and mail/fax.

---

## Security Requirements

- **Hash verification:** IMA document hash verified on both client and server — prevents tampering between render and acknowledgement.
- **Immutable storage:** IMA PDF stored immutably in DigitalOcean Spaces — cannot be modified after acknowledgement.
- **AHC11236 safety:** AHC11236 PDF must not expose Meritum's internal system details beyond the submitter prefix.
- **Scoped access:** All document downloads are scoped to the authenticated physician's `provider_id`.

---

## Test Specifications

Add to `apps/api/src/domains/onboarding/onboarding.test.ts`:

1. `renderIma` pre-fills physician details correctly
2. `renderIma` returns consistent SHA-256 hash for same input
3. `acknowledgeIma` verifies client hash matches server hash
4. `acknowledgeIma` rejects mismatched hash
5. `acknowledgeIma` creates IMA record with correct fields
6. `acknowledgeIma` stores PDF to Spaces (mock DigitalOcean Spaces client)
7. `acknowledgeIma` triggers step 7 completion
8. `downloadImaPdf` returns stored PDF
9. `checkImaCurrentVersion` detects outdated template version
10. `generateAhc11236Pdf` pre-fills correct physician and submitter details
11. `downloadPiaPdf` returns static PIA document

---

## Codebase Context

- **Module location:** `apps/api/src/domains/onboarding/onboarding.service.ts` (same file as D11-020)
- **Template engine:** Handlebars or Mustache for IMA template rendering. Install if not already present.
- **PDF generation:** Use pdfkit or similar library for generating IMA, AHC11236 PDFs.
- **Object storage:** DigitalOcean Spaces (S3-compatible). Mock in tests. Use environment variables for Spaces credentials/bucket name.
- **SHA-256 hashing:** Use Node.js `crypto.createHash('sha256')` for document hashing.
- **Existing pattern:** Look at other domains for PDF generation or file storage patterns if they exist.
- **Test mocking:** Mock DigitalOcean Spaces client in tests. Verify that the correct key/buffer is passed to the upload function.
