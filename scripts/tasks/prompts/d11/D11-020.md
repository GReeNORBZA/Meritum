# D11-020 — Service: Onboarding Progress Management and Step Completion

**Task ID:** D11-020
**Domain:** 11 — Onboarding
**Section:** Service Layer
**Depends on:** D11-010
**Verify:** `pnpm --filter api vitest run src/domains/onboarding/onboarding.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/onboarding/onboarding.service.ts` with onboarding orchestration logic.

### Progress Management

- **`getOrCreateProgress(providerId: string)`** — Find existing progress or create new one. Return progress with computed fields:
  - `current_step` — first incomplete required step
  - `is_complete` — all required steps done
  - `required_steps_remaining` — count of incomplete required steps

- **`getOnboardingStatus(userId: string)`** — Look up provider for user. Return onboarding status:
  ```typescript
  {
    has_provider: boolean,
    progress: OnboardingProgress | null,
    is_complete: boolean,
    ba_status: string | null
  }
  ```
  Used by the onboarding gate middleware to enforce the onboarding requirement.

### Step Completion Functions

- **`completeStep1(providerId: string, data: Step1Input)`** — Validate billing number format (5-digit numeric). Create or update provider record in Provider Management (calls provider service). Mark step 1 complete. Emit `onboarding.step_completed` audit event.

- **`completeStep2(providerId: string, data: Step2Input)`** — Validate `specialty_code` against Reference Data (D02). Update provider with specialty and `physician_type`. Mark step 2 complete. Emit audit event.

- **`completeStep3(providerId: string, data: Step3Input)`** — Validate BA number format. If PCPCM enrolled, enforce both `pcpcm_ba_number` and `ffs_ba_number` present. Create BA record(s) in Provider Management with status PENDING. Pre-generate AHC11236 data. Mark step 3 complete. Emit audit event.

- **`completeStep4(providerId: string, data: Step4Input)`** — Validate `functional_centre_code` and `community_code` against Reference Data (D02). Calculate RRNP eligibility from community code. Create practice location in Provider Management. Mark step 4 complete. Emit audit event.

- **`completeStep5(providerId: string, data: Step5Input)`** — Create WCB configuration in Provider Management. Auto-populate permitted form types from role/skill. Mark step 5 complete. Emit audit event.

- **`completeStep6(providerId: string, data: Step6Input)`** — Set submission preferences in Provider Management. Mark step 6 complete. Emit audit event.

- **`completeStep7(providerId: string, ipAddress: string, userAgent: string)`** — Called after IMA acknowledgement (see D11-021). Mark step 7 complete. Check if all required steps done; if so, call `markOnboardingCompleted`. Emit `onboarding.completed` if complete.

### Important Behaviors

- **Step navigation:** Physician can go back to edit completed steps. Re-completing a step updates the underlying provider data.
- **Progress persistence:** Each step writes immediately on completion. No transaction across multiple steps.

---

## FRD References

- **Domain 11 Section 2.1:** Steps 1-4 and 7 required. Steps 5-6 optional. Each step writes to Provider Management tables.
- **Domain 11 Section 2.2:** Progress persistence — completed steps saved immediately, resume on next login at first incomplete required step.

---

## Security Requirements

- All step completions are scoped to the authenticated physician's `provider_id`.
- Reference Data validation (specialty codes, functional centre codes, community codes) prevents injection of invalid codes.
- Billing number format validation (5-digit numeric) prevents malformed AHCIP practitioner IDs.

---

## Test Specifications

Add to `apps/api/src/domains/onboarding/onboarding.test.ts`:

1. `getOrCreateProgress` creates new progress on first call
2. `getOrCreateProgress` returns existing progress on subsequent calls
3. `getOnboardingStatus` returns `is_complete` false when steps incomplete
4. `completeStep1` creates provider record and marks step complete
5. `completeStep1` validates billing number format (rejects non-5-digit)
6. `completeStep2` validates `specialty_code` against Reference Data
7. `completeStep3` creates BA record with PENDING status
8. `completeStep3` with PCPCM enforces dual-BA present
9. `completeStep3` without PCPCM allows single BA
10. `completeStep4` validates `functional_centre_code` against Reference Data
11. `completeStep4` calculates RRNP eligibility from community code
12. `completeStep5` creates WCB configuration (optional step)
13. `completeStep6` sets submission preferences (optional step)
14. Completing steps 1, 2, 3, 4, 7 sets `onboarding_completed`
15. Completing steps 1, 2, 3, 4 without 7 does NOT set `onboarding_completed`
16. Re-completing a step updates provider data

---

## Codebase Context

- **Module location:** `apps/api/src/domains/onboarding/onboarding.service.ts`
- **Cross-domain calls:** This service calls into:
  - Provider Management (D05) — create/update provider, BA records, practice locations, WCB config, submission preferences
  - Reference Data (D02) — validate specialty codes, functional centre codes, community codes
  - Audit Logging (D12) — emit audit events using the existing audit infrastructure
- **Audit events:** Use the existing audit logging infrastructure from D12. Pattern: `auditLog.emit('onboarding.step_completed', { provider_id, step_number })`.
- **Test file:** Same `onboarding.test.ts`. Add new describe block for service tests. Mock cross-domain service calls.
- **Existing pattern:** Look at other domain service files for the established pattern (dependency injection, error handling, cross-domain service calls).
