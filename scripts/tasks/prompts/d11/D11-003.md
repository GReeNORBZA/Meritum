# D11-003 — Drizzle Schema for ima_records Table

**Task ID:** D11-003
**Domain:** 11 — Onboarding
**Section:** Shared Types & Constants
**Depends on:** D11-002
**Verify:** `pnpm --filter shared build`

---

## Build Instructions

Add to `packages/shared/src/schemas/db/onboarding.schema.ts` the `ima_records` table.

### ima_records Table

| Column | Type | Constraints | Notes |
|--------|------|-------------|-------|
| ima_id | UUID | PK | Default: gen_random_uuid() |
| provider_id | UUID FK | NOT NULL, FK -> providers | Multiple rows possible (re-acknowledgement after template update) |
| template_version | VARCHAR(20) | NOT NULL | IMA template version used |
| document_hash | VARCHAR(64) | NOT NULL | SHA-256 hash of rendered IMA document at acknowledgement time |
| acknowledged_at | TIMESTAMPTZ | NOT NULL | Timestamp of acknowledgement |
| ip_address | VARCHAR(45) | NOT NULL | IP at acknowledgement |
| user_agent | VARCHAR(500) | NOT NULL | Browser user agent at acknowledgement |

### Indexes

- Composite index on `(provider_id, acknowledged_at DESC)` for finding the latest acknowledgement.

### Exports

Export the table definition and its inferred types:
- `InsertImaRecord`
- `SelectImaRecord`

Barrel export is already handled by D11-002's update to `packages/shared/src/schemas/db/index.ts` (same file).

---

## FRD References

- **Domain 11 Section 3.3:** IMA digital acknowledgement stores ima_id, provider_id, template_version, document_hash (SHA-256), acknowledged_at, ip_address, user_agent. One row per acknowledgement — multiple if re-acknowledged after template update.

---

## Security Requirements

- **Tamper evidence:** IMA document hash (SHA-256) provides tamper evidence — the rendered document at acknowledgement time can be verified against the stored hash.
- **Audit trail:** IP address and user agent captured for audit trail of the regulatory acknowledgement.
- **Immutability:** The rendered IMA PDF is stored immutably. Existing acknowledgements are never modified.

---

## Codebase Context

- **DB schema location:** `packages/shared/src/schemas/db/onboarding.schema.ts` (already created in D11-002)
- **DB:** PostgreSQL via Drizzle ORM
- **Note:** `provider_id` is NOT unique here (unlike onboarding_progress). A provider can have multiple IMA records if they re-acknowledge after a template version update.
- **FK reference:** Same providers table FK as in D11-002.
- **Existing pattern:** Look at other schema files in `packages/shared/src/schemas/db/` for index creation patterns in Drizzle.
