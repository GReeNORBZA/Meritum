# D11-022 — Service: Guided Tour and Patient Import Orchestration

**Task ID:** D11-022
**Domain:** 11 — Onboarding
**Section:** Service Layer
**Depends on:** D11-010, D11-020
**Verify:** `pnpm --filter api vitest run src/domains/onboarding/onboarding.test.ts`

---

## Build Instructions

Add to `apps/api/src/domains/onboarding/onboarding.service.ts` the guided tour, patient import, and BA status operations.

### Guided Tour

- **`completeGuidedTour(providerId: string)`** — Mark tour completed. Emit `onboarding.guided_tour_completed` audit event.

- **`dismissGuidedTour(providerId: string)`** — Mark tour dismissed. Emit `onboarding.guided_tour_dismissed` audit event.

- **`shouldShowGuidedTour(providerId: string)`** — Return true if onboarding is complete AND tour is neither completed nor dismissed.

### Patient Import During Onboarding

- **`completePatientImport(providerId: string)`** — Mark `patient_import_completed` on progress. Emit `onboarding.patient_import_completed` audit event.

- **Note:** The actual CSV import logic is in Domain 6 (Patient Registry). This service only tracks that the import step was completed during onboarding.

### BA Status Update

- **`confirmBaActive(providerId: string, baId: string)`** — Update BA status from PENDING to ACTIVE in Provider Management (D05). Emit `onboarding.ba_status_updated` audit event. This is the manual confirmation endpoint used after Alberta Health processes the AHC11236.

- **Validation:** Throw error if BA is not in PENDING state. Throw 404 if BA does not belong to the given provider.

---

## FRD References

- **Domain 11 Section 5:** Optional patient import during onboarding. Same CSV import as Domain 6, surfaced as convenience.
- **Domain 11 Section 6:** Guided tour with 6 stops. Dismissible. Does not reappear. Replay from settings.
- **Domain 11 Section 4.2:** BA status tracking. PENDING after AHC11236 submitted. Manual confirm to ACTIVE.

---

## Test Specifications

Add to `apps/api/src/domains/onboarding/onboarding.test.ts`:

1. `completeGuidedTour` marks tour completed
2. `completeGuidedTour` is idempotent
3. `dismissGuidedTour` marks tour dismissed
4. `shouldShowGuidedTour` returns true when onboarding complete and tour not done
5. `shouldShowGuidedTour` returns false when tour completed
6. `shouldShowGuidedTour` returns false when tour dismissed
7. `shouldShowGuidedTour` returns false when onboarding not complete
8. `completePatientImport` marks import completed on progress
9. `confirmBaActive` updates BA status from PENDING to ACTIVE
10. `confirmBaActive` rejects if BA not in PENDING state

---

## Codebase Context

- **Module location:** `apps/api/src/domains/onboarding/onboarding.service.ts` (same file as D11-020, D11-021)
- **Cross-domain calls:**
  - Provider Management (D05) — update BA status
  - Audit Logging (D12) — emit audit events
  - Patient Registry (D06) — the actual import is handled by D06; this service only tracks completion
- **Audit events:** Use the existing audit logging infrastructure from D12.
- **Idempotency:** `completeGuidedTour` and `dismissGuidedTour` should be idempotent (calling multiple times is a no-op after the first).
- **Test file:** Same `onboarding.test.ts`. Add new describe block for supplementary service tests.
