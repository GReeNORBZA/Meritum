# D11-044 — Security: Data Leakage Prevention

**Task ID:** D11-044
**Domain:** 11 — Onboarding
**Section:** Security Tests
**Depends on:** D11-030, D11-031, D11-032
**Verify:** `pnpm --filter api vitest run test/security/onboarding/onboarding.leakage.security.ts`

---

## Build Instructions

Create `apps/api/test/security/onboarding/onboarding.leakage.security.ts`.

### PHI Not in Error Responses

- 400 validation errors do not echo back the invalid input values (especially billing_number, CPSA number)
- 403 responses contain generic "Insufficient permissions" only
- 404 responses do not confirm resource existence
- 500 errors expose no stack traces, SQL errors, or internal details

### Header Checks

- No `X-Powered-By` header in any response
- No `Server` header revealing version
- HSTS header present
- PDF download responses have correct `Content-Type` (`application/pdf`) and `Content-Disposition`

### IMA Document Security

- IMA rendering does not leak other physicians' details
- AHC11236 PDF does not expose internal system IDs or database identifiers
- PIA download does not reveal physician-specific information (it is a static document)

### Sensitive Data Not in Responses

- GET /progress does not expose provider internal IDs beyond what's needed
- IMA record responses do not include other physicians' IMA data
- Error responses from step completion do not reveal provider data from other steps

---

## Codebase Context

- **Security test location:** `apps/api/test/security/onboarding/`
- **PHN masking:** Display PHN as `123******` (first 3 digits visible, rest masked). Ensure this pattern is followed if any PHN appears in responses.
- **Error handling pattern:** Look at the existing global error handler in the API for the established pattern of sanitizing error responses.
- **Header security:** Fastify may need explicit configuration to remove `X-Powered-By`. Check if the app already has this configured.
- **Existing pattern:** Look at existing leakage security tests in `apps/api/test/security/` for the established pattern.
