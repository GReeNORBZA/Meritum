# D11-040 — Security: Authentication Enforcement on Every Onboarding Route

**Task ID:** D11-040
**Domain:** 11 — Onboarding
**Section:** Security Tests
**Depends on:** D11-030, D11-031, D11-032
**Verify:** `pnpm --filter api vitest run test/security/onboarding/onboarding.authn.security.ts`

---

## Build Instructions

Create `apps/api/test/security/onboarding/onboarding.authn.security.ts`.

Test every authenticated route in the Onboarding domain returns **401** without a valid session cookie.

### Routes to Test

- GET /api/v1/onboarding/progress
- POST /api/v1/onboarding/steps/1
- POST /api/v1/onboarding/steps/2
- POST /api/v1/onboarding/steps/3
- POST /api/v1/onboarding/steps/4
- POST /api/v1/onboarding/steps/5
- POST /api/v1/onboarding/steps/6
- POST /api/v1/onboarding/steps/7
- GET /api/v1/onboarding/ima
- POST /api/v1/onboarding/ima/acknowledge
- GET /api/v1/onboarding/ima/download
- GET /api/v1/onboarding/ahc11236/download
- GET /api/v1/onboarding/pia/download
- POST /api/v1/onboarding/guided-tour/complete
- POST /api/v1/onboarding/guided-tour/dismiss
- POST /api/v1/onboarding/patient-import/complete
- POST /api/v1/onboarding/ba/:ba_id/confirm-active

### Test Scenarios for Each Route

1. **No cookie** — Send request with no session cookie. Must return 401.
2. **Expired cookie** — Send request with an expired session cookie. Must return 401.
3. **Tampered cookie** — Send request with a tampered/invalid cookie. Must return 401.

### Assertions

- All must return 401 with no data leakage in the response body.
- Response body should contain only a generic error object (e.g., `{ error: 'Unauthorized' }`).

---

## Security Requirements

- 401 responses must not contain any data in the response body beyond the error object.
- Tampered cookies must be rejected (invalid signature / hash mismatch).
- Expired sessions must return 401 (not 200 with stale data).

---

## Codebase Context

- **Security test location:** `apps/api/test/security/onboarding/`
- **Test pattern:** Look at existing security test files in `apps/api/test/security/` for the established pattern.
- **Auth pattern:** Session cookie auth. The test framework should provide helpers for creating valid/invalid/expired cookies.
- **All 17 routes** must be covered — do not skip any.
