# D11-045 — Security: Audit Trail Completeness for Onboarding

**Task ID:** D11-045
**Domain:** 11 — Onboarding
**Section:** Security Tests
**Depends on:** D11-030, D11-031, D11-032
**Verify:** `pnpm --filter api vitest run test/security/onboarding/onboarding.audit.security.ts`

---

## Build Instructions

Create `apps/api/test/security/onboarding/onboarding.audit.security.ts`.

Verify that each onboarding action produces an audit record. Run the action, then query the audit log and verify the entry exists with correct fields.

### Onboarding Lifecycle Events

- Start onboarding -> `onboarding.started` with `provider_id`
- Complete step 1 -> `onboarding.step_completed` with `step_number: 1`
- Complete step 2 -> `onboarding.step_completed` with `step_number: 2`
- Complete step 3 -> `onboarding.step_completed` with `step_number: 3`, `ba_number(s)`
- Complete step 4 -> `onboarding.step_completed` with `step_number: 4`
- Complete step 5 -> `onboarding.step_completed` with `step_number: 5` (optional)
- Complete step 6 -> `onboarding.step_completed` with `step_number: 6` (optional)
- Complete all required steps -> `onboarding.completed`

### IMA Events

- IMA acknowledged -> `onboarding.ima_acknowledged` with `template_version`, `document_hash`
- IMA downloaded -> `onboarding.ima_downloaded`

### Document Events

- AHC11236 downloaded -> `onboarding.ahc11236_downloaded`
- PIA downloaded -> `onboarding.pia_downloaded`

### Supplementary Events

- Patient import completed -> `onboarding.patient_import_completed`
- Guided tour completed -> `onboarding.guided_tour_completed`
- Guided tour dismissed -> `onboarding.guided_tour_dismissed`
- BA status confirmed active -> `onboarding.ba_status_updated` with `ba_id`, `new_status`

### Audit Log Integrity

- Audit entries for onboarding are scoped to the physician's `user_id`
- Audit detail field does not contain PHI beyond what's necessary (no patient data)

---

## Codebase Context

- **Security test location:** `apps/api/test/security/onboarding/`
- **Audit logging infrastructure:** From Domain 12 (D12). Use the existing audit log query functions to verify entries after actions.
- **Audit event pattern:** Each action should emit an audit event with: `action` (string), `user_id`, `details` (JSON object with relevant context).
- **PHI in audit logs:** Audit logs may contain `provider_id`, `step_number`, `template_version`, `ba_id`, etc. They should NOT contain patient data (PHN, patient names, etc.) since onboarding does not involve patient-specific operations.
- **Existing pattern:** Look at existing audit security tests in `apps/api/test/security/` for the established pattern of querying and asserting on audit log entries.
