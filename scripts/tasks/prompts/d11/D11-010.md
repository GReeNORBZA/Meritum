# D11-010 — Repository: Onboarding Progress CRUD

**Task ID:** D11-010
**Domain:** 11 — Onboarding
**Section:** Repository Layer
**Depends on:** D11-005
**Verify:** `pnpm --filter api vitest run src/domains/onboarding/onboarding.test.ts`

---

## Build Instructions

Create `apps/api/src/domains/onboarding/onboarding.repository.ts` with onboarding progress operations.

### Repository Functions

- **`createProgress(providerId: string)`** — Insert new progress record with all steps false and `started_at = now()`. Enforce unique `provider_id` (handle unique constraint violation gracefully).

- **`findProgressByProviderId(providerId: string)`** — Return progress record or null.

- **`markStepCompleted(providerId: string, stepNumber: number)`** — Set `step_{n}_completed = true`. Return updated progress. Use dynamic column name based on stepNumber (e.g., `step_${stepNumber}_completed`).

- **`markOnboardingCompleted(providerId: string)`** — Set `completed_at = now()`. Only callable when all required steps (1, 2, 3, 4, 7) are true. Throw an error if required steps are incomplete.

- **`markPatientImportCompleted(providerId: string)`** — Set `patient_import_completed = true`.

- **`markGuidedTourCompleted(providerId: string)`** — Set `guided_tour_completed = true`.

- **`markGuidedTourDismissed(providerId: string)`** — Set `guided_tour_dismissed = true`.

All queries scoped by `provider_id` (which maps to the physician's provider record).

---

## Security Requirements

- All progress queries are scoped to the `provider_id` derived from the authenticated user's context — no cross-physician access.
- `markOnboardingCompleted` checks required steps server-side; client cannot bypass by setting `completed_at` directly.

---

## Test Specifications

Create co-located tests in `apps/api/src/domains/onboarding/onboarding.test.ts`:

1. `createProgress` creates record with all steps false
2. `createProgress` rejects duplicate `provider_id`
3. `findProgressByProviderId` returns progress for existing provider
4. `findProgressByProviderId` returns null for non-existent provider
5. `markStepCompleted` sets specific step to true
6. `markStepCompleted` is idempotent (re-completing a step is no-op)
7. `markOnboardingCompleted` sets `completed_at` when required steps done
8. `markOnboardingCompleted` throws when required steps incomplete
9. `markGuidedTourCompleted` sets tour completed
10. `markGuidedTourDismissed` sets tour dismissed

---

## Codebase Context

- **Module location:** `apps/api/src/domains/onboarding/`
- **DB:** PostgreSQL via Drizzle ORM. Import table definitions from `packages/shared`.
- **Test pattern:** Unit tests co-located as `*.test.ts`. Use Vitest.
- **Existing pattern:** Look at other domain repository files (e.g., `apps/api/src/domains/providers/`, `apps/api/src/domains/patients/`) for the established repository pattern (dependency injection of db instance, query patterns).
- **Required steps constant:** Import `REQUIRED_ONBOARDING_STEPS` from `packages/shared` constants (created in D11-001).
