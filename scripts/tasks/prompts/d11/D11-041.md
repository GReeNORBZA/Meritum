# D11-041 — Security: Authorization and Role Enforcement for Onboarding

**Task ID:** D11-041
**Domain:** 11 — Onboarding
**Section:** Security Tests
**Depends on:** D11-030, D11-031, D11-032
**Verify:** `pnpm --filter api vitest run test/security/onboarding/onboarding.authz.security.ts`

---

## Build Instructions

Create `apps/api/test/security/onboarding/onboarding.authz.security.ts`.

### Delegate Cannot Access Onboarding Routes

Test that delegate users receive 403 on all onboarding modification routes:

- POST /onboarding/steps/1 as delegate -> 403
- POST /onboarding/ima/acknowledge as delegate -> 403
- POST /onboarding/guided-tour/complete as delegate -> 403
- POST /onboarding/ba/:ba_id/confirm-active as delegate -> 403
- GET /onboarding/progress as delegate -> 403

### Onboarding Gate Enforcement

Test that the onboarding gate middleware correctly blocks/allows access:

- Physician with incomplete onboarding accessing /api/v1/claims -> 403 with `{ error: 'onboarding_required' }`
- Physician with incomplete onboarding accessing /api/v1/patients -> 403 with `{ error: 'onboarding_required' }`
- Physician with complete onboarding accessing /api/v1/claims -> allowed (2xx or other expected code)
- Delegate accessing /api/v1/claims with complete physician context -> allowed (gate skipped for delegates)

### Step Sequence Not Enforced via Authorization

Test that physicians can navigate freely between steps:

- Physician can POST /steps/3 then POST /steps/1 (editing earlier step) -> 200

This confirms that step completion order is not enforced — physicians can go back and edit.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/onboarding/`
- **Auth roles:** physician, delegate, admin. Use test helpers to create authenticated sessions for each role.
- **Onboarding gate:** The middleware from D11-030. It should return 403 with `{ error: 'onboarding_required', current_step: N }` for physicians who haven't completed onboarding.
- **Existing pattern:** Look at existing authorization security tests in `apps/api/test/security/` for the established pattern.
