# D11-042 — Security: Cross-Physician Isolation (Tenant Scoping)

**Task ID:** D11-042
**Domain:** 11 — Onboarding
**Section:** Security Tests
**Depends on:** D11-030, D11-031, D11-032
**Verify:** `pnpm --filter api vitest run test/security/onboarding/onboarding.scoping.security.ts`

---

## Build Instructions

Create `apps/api/test/security/onboarding/onboarding.scoping.security.ts`.

Create two physician accounts (physician1, physician2) using the `createSecurityPair()` test fixture.

### Onboarding Progress Isolation

- Physician1 GET /progress returns only physician1's progress
- Physician1 cannot see physician2's onboarding progress

### Step Completion Isolation

- Physician1 completing step 1 does not affect physician2's progress
- Physician1 cannot complete steps for physician2

### IMA Isolation

- Physician1 GET /ima returns IMA pre-filled with physician1's details only
- Physician1 GET /ima/download returns only physician1's IMA PDF
- Physician1 cannot download physician2's IMA

### AHC11236 Isolation

- Physician1 GET /ahc11236/download returns PDF with physician1's details only

### BA Confirmation Isolation

- Physician1 POST /ba/:ba_id/confirm-active with physician2's BA ID -> **404** (not 403)

### Important

All cross-physician access attempts must return **404**, not 403. This prevents confirming resource existence to unauthorized users.

---

## Codebase Context

- **Security test location:** `apps/api/test/security/onboarding/`
- **Security test helper:** `createSecurityPair()` creates two physician accounts for cross-tenant isolation testing. Import from the existing test helpers.
- **Isolation pattern:** Every query must be scoped by `provider_id`. The API should never accept a `provider_id` parameter from the client — it must always derive it from the authenticated session.
- **404 vs 403:** Use 404 for cross-tenant access attempts to avoid information leakage about resource existence.
- **Existing pattern:** Look at existing scoping security tests in `apps/api/test/security/` for the established pattern.
