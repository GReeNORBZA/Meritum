# Task D12-040: Security: authentication enforcement on every protected route

## What to Build

Create `apps/api/test/security/platform/platform.authn.security.ts`.

Test every authenticated route in Platform Operations returns 401 without a valid session cookie:

- POST /api/v1/subscriptions/checkout
- POST /api/v1/subscriptions/portal
- GET /api/v1/subscriptions/current
- GET /api/v1/subscriptions/payments
- GET /api/v1/admin/subscriptions
- PATCH /api/v1/admin/subscriptions/:id/status
- POST /api/v1/admin/incidents
- POST /api/v1/admin/incidents/:id/updates
- PATCH /api/v1/admin/components/:id/status

For each route: send request with no cookie, with expired cookie, and with tampered cookie. All must return 401.

**Also verify public routes DO NOT require auth:**
- GET /api/v1/status → 200 without cookie
- GET /api/v1/status/incidents → 200 without cookie
- GET /api/v1/status/incidents/:id → 200 without cookie
- POST /api/v1/webhooks/stripe → does not return 401 (uses signature verification instead)

## Critical Security Rules

- 401 responses must not contain any data beyond the error object.
- Public routes must genuinely be accessible without authentication.
- Webhook route must not return 401 — it has its own signature-based authentication.

## Prerequisites

This task depends on the following completed tasks: D12-031, D12-032

## Run After Completion

```bash
pnpm --filter api vitest run test/security/platform/platform.authn.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
