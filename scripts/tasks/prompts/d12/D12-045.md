# Task D12-045: Security: audit trail completeness for billing and subscription events

## What to Build

Create `apps/api/test/security/platform/platform.audit.security.ts`.

Verify each billing/subscription action produces an audit record:

**Subscription events:**
- Checkout session created → subscription.checkout_initiated with plan
- Subscription created (via webhook) → subscription.created with plan, stripe_subscription_id
- Subscription status changed → subscription.status_changed with old_status, new_status
- Plan changed → subscription.plan_changed with old_plan, new_plan

**Payment events:**
- Payment succeeded → payment.succeeded with amount, total_cad
- Payment failed → payment.failed with amount

**Dunning events:**
- Account suspended → subscription.suspended with reason
- Account cancelled → subscription.cancelled with reason

**Deletion events:**
- Deletion scheduled → account.deletion_scheduled with deletion_date
- Data deleted → account.data_deleted

**Incident events:**
- Incident created → incident.created with title, severity
- Incident updated → incident.updated with new_status
- Component status changed → component.status_updated with old_status, new_status

**Audit log integrity:**
- No UPDATE endpoints exist for payment_history
- No DELETE endpoints exist for payment_history (financial records are immutable)
- Audit entries do not contain Stripe API keys or webhook secrets

## Prerequisites

This task depends on the following completed tasks: D12-031, D12-032

## Run After Completion

```bash
pnpm --filter api vitest run test/security/platform/platform.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
