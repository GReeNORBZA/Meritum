# Task D12-031: Routes: subscription and billing endpoints + integration tests

## What to Build

Create `apps/api/src/domains/platform/platform.routes.ts` and `apps/api/src/domains/platform/platform.handlers.ts`.

**Webhook route (no auth — Stripe signature only):**
- POST /api/v1/webhooks/stripe → stripeWebhookHandler (raw body, signature verification)

**Subscription routes (auth required, physician role):**
- POST /api/v1/subscriptions/checkout → createCheckoutHandler (body: createCheckoutSessionSchema)
- POST /api/v1/subscriptions/portal → createPortalHandler (body: createPortalSessionSchema)
- GET /api/v1/subscriptions/current → getCurrentSubscriptionHandler
- GET /api/v1/subscriptions/payments → listPaymentsHandler (query: pagination)

**Admin routes (auth required, admin role):**
- GET /api/v1/admin/subscriptions → listAllSubscriptionsHandler (query: adminSubscriptionQuerySchema)
- PATCH /api/v1/admin/subscriptions/:id/status → adminUpdateStatusHandler (for manual intervention)

**Handlers are thin:** validate input, call service, format response.

Create `apps/api/test/integration/platform/subscriptions.integration.ts` with full integration tests.
Use Stripe test mode / mock Stripe SDK for integration tests.

## Critical Security Rules

- Webhook route has NO auth middleware — only Stripe signature verification.
- All subscription routes require physician role (delegates cannot manage subscriptions).
- Admin routes require admin role.
- getCurrentSubscriptionHandler must scope to the authenticated user's subscription only.
- listPaymentsHandler must scope to the authenticated user's subscription only.

## Prerequisites

This task depends on the following completed tasks: D12-020, D12-021, D12-022, D12-030

## Tests to Write

```typescript
  it('POST /webhooks/stripe with valid signature processes event');
  it('POST /webhooks/stripe with invalid signature returns 400');
  it('POST /subscriptions/checkout returns checkout URL');
  it('POST /subscriptions/checkout rejects delegate role');
  it('POST /subscriptions/portal returns portal URL for active subscriber');
  it('GET /subscriptions/current returns subscription for authenticated user');
  it('GET /subscriptions/payments returns paginated payment history');
  it('GET /admin/subscriptions returns all subscriptions for admin');
  it('GET /admin/subscriptions rejects non-admin');
```

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/platform/
```

All tests must pass before outputting [TASK_COMPLETE].
