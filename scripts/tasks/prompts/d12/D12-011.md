# Task D12-011: Repository: payment history

## What to Build

Add to `apps/api/src/domains/platform/platform.repository.ts` — payment history operations:

- `recordPayment(data: InsertPayment)` — insert payment record.
- `findPaymentByStripeInvoiceId(stripeInvoiceId: string)` — find payment by Stripe invoice reference (idempotency check for webhooks).
- `listPaymentsForSubscription(subscriptionId: string, pagination: { page, pageSize })` — paginated payment history, reverse chronological.
- `updatePaymentStatus(paymentId: string, status: string, paidAt?: Date)` — update payment status (e.g., FAILED → PAID on retry success).
- `getPaymentSummary(subscriptionId: string)` — aggregate: total paid, total GST, payment count, last payment date.

## Critical Security Rules

- listPaymentsForSubscription scopes to the subscription — no cross-user payment leakage.
- findPaymentByStripeInvoiceId is used for webhook idempotency — prevents duplicate payment records.
- No card numbers or payment method details stored. Only Stripe invoice reference.

## Prerequisites

This task depends on the following completed tasks: D12-006

## Tests to Write

```typescript
  it('recordPayment inserts payment with GST calculation');
  it('findPaymentByStripeInvoiceId returns correct payment');
  it('findPaymentByStripeInvoiceId returns null for unknown invoice');
  it('listPaymentsForSubscription returns paginated results');
  it('listPaymentsForSubscription returns reverse chronological');
  it('updatePaymentStatus updates status and paid_at');
  it('getPaymentSummary returns correct aggregates');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/platform/platform.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
