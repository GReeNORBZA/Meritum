# Task D12-022: Service: dunning sequence and subscription lifecycle jobs

## What to Build

Add to `apps/api/src/domains/platform/platform.service.ts`:

- `runDunningCheck()` — scheduled job (daily) that processes the dunning sequence:
  1. Find PAST_DUE subscriptions with failed_payment_count > 0.
  2. For each, calculate days since first failure.
  3. Day 3: emit PAYMENT_RETRY_FAILED notification if Stripe retry also failed.
  4. Day 7: emit PAYMENT_SUSPENSION_WARNING notification.
  5. Day 14: update status to SUSPENDED. Set suspended_at. Emit ACCOUNT_SUSPENDED notification. Update user.subscription_status to 'suspended'.
  6. Log each dunning action to audit trail.

- `runCancellationCheck()` — scheduled job (daily):
  1. Find SUSPENDED subscriptions where suspended_at + 16 days <= now() (30 total from first failure).
  2. Cancel Stripe subscription via API.
  3. Update status to CANCELLED. Set cancelled_at, deletion_scheduled_at = now() + 30 days.
  4. Emit SUBSCRIPTION_CANCELLED notification.

- `runDeletionCheck()` — scheduled job (daily):
  1. Find CANCELLED subscriptions where deletion_scheduled_at <= now().
  2. Execute data deletion: remove all PHI (claims, patients, reports). Strip PII from audit logs (retain for 10 years). Delete Stripe customer data via API.
  3. Deactivate user account. Emit ACCOUNT_DATA_DELETED event.

- `getSubscriptionStatus(userId: string)` — return current subscription with access level for middleware use.

**Data retention after deletion (per FRD):**
- Claims, patients, provider profile: deleted
- Audit logs: retained 10 years, PII stripped (provider_id hashed, PHN removed)
- IMA records: retained 10 years
- AI learning data: anonymised, retained for cohort aggregates
- Stripe references: deleted

## Critical Security Rules

- Data deletion must be thorough: no PHI residue in any table. Use a deletion checklist.
- Audit logs retained for HIA compliance but PII-stripped (hash provider_id, remove patient PHN).
- IMA records retained as contractual evidence for 10 years.
- Scheduled jobs must be idempotent — safe to run multiple times.
- Stripe customer data deletion via API (remove payment methods, redact metadata).

## Prerequisites

This task depends on the following completed tasks: D12-010, D12-021

## Tests to Write

```typescript
  it('runDunningCheck emits Day 7 warning for 7-day overdue');
  it('runDunningCheck suspends account at Day 14');
  it('runDunningCheck updates user.subscription_status on suspension');
  it('runCancellationCheck cancels Stripe subscription at Day 30');
  it('runCancellationCheck schedules deletion 30 days out');
  it('runDeletionCheck deletes PHI data');
  it('runDeletionCheck strips PII from audit logs');
  it('runDeletionCheck retains IMA records');
  it('runDeletionCheck deletes Stripe customer data');
  it('getSubscriptionStatus returns correct access level per status');
  it('All scheduled jobs are idempotent');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/platform/platform.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
