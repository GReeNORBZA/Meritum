# Task D12-020: Service: Stripe Checkout session creation and subscription provisioning

## What to Build

Create `apps/api/src/domains/platform/platform.service.ts` with Stripe Checkout functions:

- `createCheckoutSession(userId: string, plan: string, successUrl: string, cancelUrl: string)` —
  1. Check if user already has active subscription → error if so.
  2. If plan is EARLY_BIRD_MONTHLY: check countEarlyBirdSubscriptions() < 100. If at cap, reject with EARLY_BIRD_SOLD_OUT.
  3. Create or retrieve Stripe Customer (stripe.customers.create with email, name from user).
  4. Create Stripe Checkout Session with: mode 'subscription', correct Price ID for plan, GST as tax rate (5%), success/cancel URLs.
  5. Return { checkout_url: session.url }.

- `createPortalSession(userId: string, returnUrl: string)` —
  1. Find subscription for userId.
  2. Create Stripe Billing Portal session with stripe_customer_id and return_url.
  3. Return { portal_url: session.url }.

**Stripe SDK:** Use `stripe` npm package. API key from environment variable STRIPE_SECRET_KEY.
**Price IDs:** From environment variables: STRIPE_PRICE_STANDARD_MONTHLY, STRIPE_PRICE_STANDARD_ANNUAL, STRIPE_PRICE_EARLY_BIRD_MONTHLY.
**Tax:** Use Stripe Tax Rate object (5% GST, inclusive=false) or manual tax line item.

## Critical Security Rules

- Stripe secret key stored in environment variable, never in code or logs.
- No PHI sent to Stripe. Only physician name and email.
- Early bird cap enforced server-side. Race condition: use transaction or SELECT FOR UPDATE when checking count.
- Checkout session URL is single-use and time-limited (Stripe manages this).

## Prerequisites

This task depends on the following completed tasks: D12-010

## Tests to Write

```typescript
  it('createCheckoutSession returns checkout URL for valid plan');
  it('createCheckoutSession rejects if active subscription exists');
  it('createCheckoutSession rejects EARLY_BIRD_MONTHLY when cap reached');
  it('createCheckoutSession creates Stripe customer with correct email');
  it('createPortalSession returns portal URL for active subscriber');
  it('createPortalSession rejects if no subscription found');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/platform/platform.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
