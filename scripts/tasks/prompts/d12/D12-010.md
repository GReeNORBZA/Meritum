# Task D12-010: Repository: subscription CRUD operations

## What to Build

Create `apps/api/src/domains/platform/platform.repository.ts` with subscription operations:

- `createSubscription(data: InsertSubscription)` — insert new subscription record.
- `findSubscriptionByProviderId(providerId: string)` — find subscription for physician.
- `findSubscriptionByStripeCustomerId(stripeCustomerId: string)` — find by Stripe reference (for webhook processing).
- `findSubscriptionByStripeSubscriptionId(stripeSubId: string)` — find by Stripe subscription ID.
- `updateSubscriptionStatus(subscriptionId: string, status: string, metadata?: { suspended_at?, cancelled_at?, deletion_scheduled_at? })` — update status with optional timestamps.
- `updateSubscriptionPeriod(subscriptionId: string, periodStart: Date, periodEnd: Date)` — update billing period from webhook.
- `updateSubscriptionPlan(subscriptionId: string, plan: string)` — update plan after portal change.
- `incrementFailedPaymentCount(subscriptionId: string)` — increment failed_payment_count.
- `resetFailedPaymentCount(subscriptionId: string)` — set to 0 on successful payment.
- `findSubscriptionsDueForSuspension()` — find PAST_DUE subscriptions where failed_payment_count >= threshold and first failure was 14+ days ago.
- `findSubscriptionsDueForCancellation()` — find SUSPENDED subscriptions suspended 16+ days ago (30 total from first failure).
- `findSubscriptionsDueForDeletion()` — find CANCELLED subscriptions where deletion_scheduled_at <= now().
- `countEarlyBirdSubscriptions()` — count subscriptions with plan = EARLY_BIRD_MONTHLY for cap enforcement.

Create `apps/api/src/domains/platform/platform.test.ts` with unit tests for each function.

## Critical Security Rules

- findSubscriptionByProviderId only returns the subscription for the specified provider — physician-scoped.
- Webhook-facing queries (by Stripe IDs) are used only by the webhook handler, never exposed to user-facing routes.
- countEarlyBirdSubscriptions must be accurate for the 100-physician cap (race condition: use SELECT FOR UPDATE or similar).

## Prerequisites

This task depends on the following completed tasks: D12-006

## Tests to Write

```typescript
  it('createSubscription inserts record with correct defaults');
  it('findSubscriptionByProviderId returns correct subscription');
  it('findSubscriptionByProviderId returns null for non-existent provider');
  it('findSubscriptionByStripeCustomerId returns correct subscription');
  it('updateSubscriptionStatus updates status and timestamps');
  it('incrementFailedPaymentCount increments correctly');
  it('resetFailedPaymentCount resets to 0');
  it('findSubscriptionsDueForSuspension returns overdue subscriptions');
  it('findSubscriptionsDueForCancellation returns long-suspended subscriptions');
  it('findSubscriptionsDueForDeletion returns expired-grace subscriptions');
  it('countEarlyBirdSubscriptions returns accurate count');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/platform/platform.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
