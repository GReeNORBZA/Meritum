# Task D12-021: Service: Stripe webhook event processing

## What to Build

Add to `apps/api/src/domains/platform/platform.service.ts`:

- `processWebhookEvent(rawBody: string, signature: string)` —
  1. Verify webhook signature using STRIPE_WEBHOOK_SECRET. Reject if invalid.
  2. Parse event. Dispatch to handler by event type.

- `handleCheckoutCompleted(event)` —
  Link Stripe customer_id and subscription_id to Meritum user. Create subscription record with status ACTIVE. Record initial payment. Emit SUBSCRIPTION_CREATED event for notification service.

- `handleInvoicePaid(event)` —
  Record payment in payment_history (idempotent: check stripe_invoice_id). Reset failed_payment_count. If status was PAST_DUE: update to ACTIVE. Clear any dunning state. Emit PAYMENT_SUCCEEDED event.

- `handleInvoicePaymentFailed(event)` —
  Increment failed_payment_count. Record failed payment. Emit PAYMENT_FAILED notification event. If count hits dunning thresholds, escalate (handled by dunning service).

- `handleInvoiceCreated(event)` —
  Verify GST line item present. If missing, add via Stripe API (stripe.invoiceItems.create with tax).

- `handleSubscriptionUpdated(event)` —
  Sync status, plan, billing period from Stripe. Update local record.

- `handleSubscriptionDeleted(event)` —
  Set status to CANCELLED. Set cancelled_at = now(). Set deletion_scheduled_at = now() + 30 days. Emit SUBSCRIPTION_CANCELLED event.

**CRITICAL:** All webhook handlers must be idempotent. Stripe may deliver the same event multiple times.

## Critical Security Rules

- Webhook signature verification is mandatory. Reject unsigned or tampered payloads with 400.
- STRIPE_WEBHOOK_SECRET stored in environment variable.
- Idempotency: check if event has already been processed (by stripe_invoice_id or event ID). Skip if duplicate.
- Webhook endpoint is unauthenticated (Stripe calls it directly) but signature-verified.

## Prerequisites

This task depends on the following completed tasks: D12-010, D12-011

## Tests to Write

```typescript
  it('processWebhookEvent rejects invalid signature');
  it('processWebhookEvent rejects missing signature');
  it('handleCheckoutCompleted creates subscription record');
  it('handleCheckoutCompleted links Stripe IDs to user');
  it('handleInvoicePaid records payment and clears past_due');
  it('handleInvoicePaid is idempotent (duplicate invoice_id ignored)');
  it('handleInvoicePaymentFailed increments failure count');
  it('handleInvoicePaymentFailed emits notification event');
  it('handleSubscriptionUpdated syncs status and period');
  it('handleSubscriptionDeleted sets cancelled status and schedules deletion');
  it('handleInvoiceCreated verifies GST presence');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/platform/platform.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
