# Task D12-030: Stripe webhook middleware and signature verification plugin

## What to Build

Create `apps/api/src/plugins/stripe-webhook.plugin.ts` as a Fastify plugin:

**Raw body parsing:**
The Stripe webhook endpoint needs the raw request body (not parsed JSON) for signature verification. Configure Fastify to preserve raw body for the webhook route.

Options:
- Use Fastify's `addContentTypeParser` to capture raw body for the webhook path
- Or use `fastify-raw-body` plugin scoped to the webhook route

**Signature verification middleware:**
- Extract `stripe-signature` header
- Call `stripe.webhooks.constructEvent(rawBody, signature, STRIPE_WEBHOOK_SECRET)`
- If verification fails: return 400 with generic error (no details about what failed)
- If verification succeeds: attach parsed event to request

**Rate limiting:**
- Stripe webhook endpoint: exempt from standard rate limiting (Stripe controls call frequency)
- But add a reasonable ceiling (e.g., 100 req/min) to prevent abuse if endpoint is discovered

## Critical Security Rules

- Webhook signature verification is the ONLY authentication for this endpoint. It must never be bypassed.
- Raw body must be preserved exactly — any modification breaks signature verification.
- STRIPE_WEBHOOK_SECRET must be in environment variables, never hardcoded.
- Error responses on the webhook endpoint must be generic — do not reveal verification failure details.

## Prerequisites

This task depends on the following completed tasks: D12-021

## Tests to Write

```typescript
  it('Webhook plugin preserves raw body for signature verification');
  it('Valid signature passes verification');
  it('Invalid signature returns 400');
  it('Missing signature header returns 400');
  it('Tampered body with valid header returns 400');
```

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/platform/platform.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
