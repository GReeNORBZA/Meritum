# Task D05-026: Service â€” submission preferences and H-Link configuration

## What to Build

Add to `apps/api/src/domains/provider/provider.service.ts`:

**Submission Preferences:**
- `getSubmissionPreferences(providerId: string)` -- return current preferences.
- `updateSubmissionPreferences(providerId: string, data: UpdatePreferencesInput, actorId: string)` -- update modes and reminder settings. Emit submission_preference.changed audit event with old vs new values.
- `initDefaultPreferences(providerId: string, actorId: string)` -- create default preferences during onboarding: AHCIP = AUTO_CLEAN, WCB = REQUIRE_APPROVAL, batch_review_reminder = true, deadline_reminder_days = 7.

**H-Link Configuration:**
- `getHlinkConfig(providerId: string)` -- return H-Link config. NEVER return credential_secret_ref to the client -- only submitter_prefix, accreditation_status, accreditation_date, last_successful_transmission.
- `updateHlinkConfig(providerId: string, data: UpdateHlinkInput, actorId: string)` -- update submitter_prefix, accreditation_status. Credential rotation routes to secrets management (out of scope for this service -- emit event). Emit hlink_config.updated audit event.
- `isSubmissionAllowed(providerId: string)` -- check: onboarding_completed = true, provider status = ACTIVE, H-Link accreditation_status = ACTIVE. Return boolean + reason if false.

**isSubmissionAllowed return type:**
```typescript
{
  allowed: boolean;
  reasons: string[];  // Empty if allowed, populated with reason codes if not
  // Possible reasons: 'ONBOARDING_INCOMPLETE', 'PROVIDER_SUSPENDED', 'PROVIDER_INACTIVE', 'HLINK_NOT_ACTIVE', 'HLINK_NOT_CONFIGURED'
}
```

Import repository functions and audit constants. Follow existing service patterns. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- H-Link credential_secret_ref is NEVER returned in API responses. Only submitter_prefix and accreditation_status are exposed.
- Credential changes logged as 'credential rotated' in audit -- no actual values in audit detail.

## Prerequisites

- D05-015 must be complete (submission preferences and H-Link repository).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- getSubmissionPreferences returns current preferences
- updateSubmissionPreferences updates modes and emits audit
- initDefaultPreferences creates defaults (AUTO_CLEAN, REQUIRE_APPROVAL)
- getHlinkConfig returns config without credential_secret_ref
- updateHlinkConfig updates prefix and accreditation status
- isSubmissionAllowed returns true for fully configured provider
- isSubmissionAllowed returns false with reason for incomplete onboarding
- isSubmissionAllowed returns false for SUSPENDED provider
- isSubmissionAllowed returns false for PENDING H-Link accreditation

## FRD Reference

- Domain 5 Section 2.7-2.8: Submission preferences and H-Link configuration.
- Domain 5 Section 4.3 PRV-011: Submission preference user story.
- Domain 5 Section 11.6: Submission preference test requirements.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
