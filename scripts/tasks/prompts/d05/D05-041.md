# Task D05-041: Security â€” authorization and role enforcement

## What to Build

Create `apps/api/test/security/provider/provider.authz.security.ts`.

Test role-based access control:

**Delegate cannot access physician-only routes:**
- POST /api/v1/providers/me/delegates/invite as delegate -> 403
- PUT /api/v1/providers/me/delegates/:rel_id/permissions as delegate -> 403
- POST /api/v1/providers/me/delegates/:rel_id/revoke as delegate -> 403
- POST /api/v1/providers/me/complete-onboarding as delegate -> 403
- PUT /api/v1/providers/me/hlink as delegate -> 403

**Physician cannot access delegate-only routes:**
- GET /api/v1/delegates/me/physicians as physician -> 403
- POST /api/v1/delegates/me/switch-context/:id as physician -> 403

**Delegate permission boundary tests:**
- Create delegate with CLAIM_VIEW only. Delegate cannot POST /api/v1/providers/me/bas (requires PROVIDER_EDIT-level access) -> 403.
- Create delegate with PREFERENCE_VIEW only. Delegate cannot PUT /api/v1/providers/me/submission-preferences (requires PREFERENCE_EDIT) -> 403.

**Internal API access control:**
- GET /api/v1/internal/providers/:id/claim-context without internal API key -> 401 or 403.
- GET /api/v1/internal/providers/:id/ba-for-claim without internal API key -> 401 or 403.
- GET /api/v1/internal/providers/:id/wcb-config-for-form without internal API key -> 401 or 403.
- Regular user session cannot access internal routes -> 401 or 403.

**Verification for each test:**
1. Response status is 403 (or 401 for internal routes without key).
2. Response body contains only an error object with descriptive message.
3. No provider data leaked in 403 responses.

Use the test helpers/fixtures for creating physician and delegate accounts. Follow the security test patterns established in prior domains. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-030 must be complete (profile, BA, location routes).
- D05-031 must be complete (WCB, preferences, H-Link routes).
- D05-032 must be complete (delegate routes).
- D05-033 must be complete (internal routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/provider/provider.authz.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
