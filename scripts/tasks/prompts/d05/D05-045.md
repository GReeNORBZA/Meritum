# Task D05-045: Security â€” audit trail completeness

## What to Build

Create `apps/api/test/security/provider/provider.audit.security.ts`.

Verify that each state-changing action produces an audit record with correct fields.

**Provider profile events:**
- Update profile -> provider.profile_updated with field-level diff (old and new values for each changed field)
- Complete onboarding -> provider.onboarding_completed with timestamp and provider_id

**BA events:**
- Add BA -> ba.added with ba_number, ba_type, provider_id
- Update BA -> ba.updated with changed fields (old and new values)
- Deactivate BA -> ba.deactivated with ba_number, provider_id

**Location events:**
- Add location -> location.added with location name, functional_centre, provider_id
- Update location -> location.updated with changed fields, RRNP eligibility change if applicable
- Deactivate location -> location.deactivated with location_id, provider_id

**WCB events:**
- Add WCB config -> wcb_config.added with contract_id, role_code, provider_id
- Update WCB config -> wcb_config.updated with changed fields
- Remove WCB config -> wcb_config.removed with contract_id, role_code, provider_id

**Delegate events:**
- Invite delegate -> delegate.invited with email (NOT password), permissions granted, physician_id
- Accept invitation -> delegate.accepted with delegate_user_id, physician_id
- Permissions changed -> delegate.permissions_changed with old permissions array and new permissions array
- Revoke delegate -> delegate.revoked with delegate_user_id, actor (who revoked), physician_id

**Preference/H-Link events:**
- Update submission preferences -> submission_preference.changed with old and new modes
- Update H-Link config -> hlink_config.updated (credential changes logged as 'credential rotated' without actual values)

**Audit log integrity:**
- Verify audit entries are append-only (no UPDATE/DELETE on audit_log from this domain)
- Each audit entry includes: action, actor_id, timestamp, resource_id, detail (JSONB with context)
- Verify actor_id is the authenticated user (physician or delegate), not a system user

**Verification for each test:**
1. Perform the action via API call.
2. Query the audit_log table for the expected action.
3. Verify the audit detail JSONB contains the expected fields.
4. Verify no sensitive data (credentials, password hashes) appears in audit detail.

Use the test helpers/fixtures for creating authenticated sessions and test data. Follow the security test patterns established in prior domains. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-030 must be complete (profile, BA, location routes).
- D05-031 must be complete (WCB, preferences routes).
- D05-032 must be complete (delegate routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/provider/provider.audit.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
