# Task D05-011: Repository â€” business arrangement management

## What to Build

Add to `apps/api/src/domains/provider/provider.repository.ts`:

- `createBa(data: InsertBa)` -- insert business arrangement.
- `findBaById(baId: string, providerId: string)` -- find BA scoped to provider.
- `listBasForProvider(providerId: string)` -- list all BAs (active, pending, inactive).
- `listActiveBasForProvider(providerId: string)` -- list only active BAs.
- `countActiveBasForProvider(providerId: string)` -- count active BAs (for max 2 enforcement).
- `updateBa(baId: string, providerId: string, data: Partial<InsertBa>)` -- update BA fields scoped to provider.
- `deactivateBa(baId: string, providerId: string)` -- set status = INACTIVE, end_date = now().
- `findBaByNumber(baNumber: string)` -- find active BA by number (for uniqueness check across system).

Use Drizzle ORM query builder with the provider schema. All queries scoped to providerId where applicable. Follow existing repository patterns. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- All BA queries scoped to providerId -- physician can only see their own BAs.
- deactivateBa is a soft operation -- the record is preserved for audit and historical claim references.

## Prerequisites

- D05-009 must be complete (database migration applied).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- createBa inserts BA record
- listBasForProvider returns only this provider's BAs
- listActiveBasForProvider excludes INACTIVE BAs
- countActiveBasForProvider returns correct count
- updateBa updates fields scoped to provider
- updateBa rejects if BA belongs to different provider
- deactivateBa sets INACTIVE and end_date
- findBaByNumber finds active BA across system

## FRD Reference

- Domain 5 Section 2.2: Business Arrangements table. Max 2 active BAs per provider. ba_number unique across active records.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
