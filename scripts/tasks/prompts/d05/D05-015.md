# Task D05-015: Repository â€” submission preferences and H-Link configuration

## What to Build

Add to `apps/api/src/domains/provider/provider.repository.ts`:

**Submission Preferences:**
- `createSubmissionPreferences(data: InsertSubmissionPreferences)` -- insert default preferences during onboarding.
- `findSubmissionPreferences(providerId: string)` -- find preferences for provider.
- `updateSubmissionPreferences(providerId: string, data: Partial<InsertSubmissionPreferences>, updatedBy: string)` -- update preferences. Set updated_by.

**H-Link Configuration:**
- `createHlinkConfig(data: InsertHlinkConfig)` -- insert H-Link configuration.
- `findHlinkConfig(providerId: string)` -- find H-Link config for provider.
- `updateHlinkConfig(providerId: string, data: Partial<InsertHlinkConfig>)` -- update H-Link fields.
- `updateLastTransmission(providerId: string, timestamp: Date)` -- update last_successful_transmission.

Use Drizzle ORM query builder with the provider schema. All queries scoped to providerId. Follow existing repository patterns. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- H-Link config never returns or accepts actual credentials -- only the credential_secret_ref.
- Submission preferences and H-Link config scoped to providerId.

## Prerequisites

- D05-009 must be complete (database migration applied).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- createSubmissionPreferences inserts with defaults
- findSubmissionPreferences returns correct preferences
- updateSubmissionPreferences updates modes and sets updated_by
- createHlinkConfig inserts H-Link config
- findHlinkConfig returns config without actual credentials
- updateHlinkConfig updates submitter_prefix and accreditation_status
- updateLastTransmission updates timestamp

## FRD Reference

- Domain 5 Section 2.7: Submission Preferences table. One row per physician. Defaults: AUTO_CLEAN for AHCIP, REQUIRE_APPROVAL for WCB.
- Domain 5 Section 2.8: H-Link Configuration table. One row per physician. Credentials are references to secrets management.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
