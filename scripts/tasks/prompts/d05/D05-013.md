# Task D05-013: Repository â€” PCPCM enrolment and WCB configuration

## What to Build

Add to `apps/api/src/domains/provider/provider.repository.ts`:

**PCPCM Enrolment:**
- `createPcpcmEnrolment(data: InsertPcpcmEnrolment)` -- insert enrolment linking PCPCM and FFS BAs.
- `findPcpcmEnrolmentForProvider(providerId: string)` -- find active enrolment.
- `updatePcpcmEnrolment(enrolmentId: string, providerId: string, data: Partial<InsertPcpcmEnrolment>)` -- update panel size or status.

**WCB Configuration:**
- `createWcbConfig(data: InsertWcbConfig)` -- insert WCB configuration.
- `findWcbConfigById(wcbConfigId: string, providerId: string)` -- find WCB config scoped to provider.
- `listWcbConfigsForProvider(providerId: string)` -- list all WCB configurations.
- `updateWcbConfig(wcbConfigId: string, providerId: string, data: Partial<InsertWcbConfig>)` -- update fields.
- `deleteWcbConfig(wcbConfigId: string, providerId: string)` -- hard delete (WCB configs are not soft-deleted).
- `setDefaultWcbConfig(wcbConfigId: string, providerId: string)` -- unset current default, set new. Transaction.
- `getAggregatedFormPermissions(providerId: string)` -- union all permitted_form_types across all Contract IDs.

Use Drizzle ORM query builder with the provider schema. All queries scoped to providerId. Follow existing repository patterns. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- WCB configuration queries scoped to providerId.
- permitted_form_types is stored as JSONB -- validate it's a string array on insert.

## Prerequisites

- D05-009 must be complete (database migration applied).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- createPcpcmEnrolment inserts enrolment record
- findPcpcmEnrolmentForProvider returns active enrolment
- createWcbConfig inserts WCB config
- createWcbConfig rejects duplicate (provider_id, contract_id)
- listWcbConfigsForProvider returns only this provider's configs
- deleteWcbConfig removes config scoped to provider
- setDefaultWcbConfig unsets previous default
- getAggregatedFormPermissions unions all permitted form types

## FRD Reference

- Domain 5 Section 2.4: PCPCM Enrolments table. Tracks dual-BA linkage and panel size.
- Domain 5 Section 2.5: WCB Configuration table. Multiple Contract IDs per provider. Each maps to Role code and permitted form types from WCB matrix.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
