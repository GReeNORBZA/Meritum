# Task D05-014: Repository â€” delegate relationships

## What to Build

Add to `apps/api/src/domains/provider/provider.repository.ts`:

- `createDelegateRelationship(data: InsertDelegateRelationship)` -- insert relationship with status INVITED.
- `findRelationshipById(relationshipId: string, physicianId: string)` -- find scoped to physician.
- `findActiveRelationship(physicianId: string, delegateUserId: string)` -- find active relationship.
- `listDelegatesForPhysician(physicianId: string)` -- list all delegate relationships (ACTIVE, INVITED, REVOKED) with delegate user info (join to Domain 1 users table).
- `listPhysiciansForDelegate(delegateUserId: string)` -- list all physicians the delegate serves (ACTIVE only) with permissions per physician.
- `updateDelegatePermissions(relationshipId: string, physicianId: string, permissions: string[])` -- update permissions JSONB.
- `acceptRelationship(relationshipId: string)` -- set status = ACTIVE, accepted_at = now().
- `revokeRelationship(relationshipId: string, physicianId: string, revokedBy: string)` -- set status = REVOKED, revoked_at = now(), revoked_by.

Use Drizzle ORM query builder with the provider schema. Join to Domain 1 users table for delegate user info in list queries. Follow existing repository patterns. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- listDelegatesForPhysician scoped to physicianId -- physician can only see their own delegates.
- listPhysiciansForDelegate scoped to delegateUserId -- delegate only sees physicians they serve.
- UNIQUE constraint on (physician_id, delegate_user_id) for active relationships prevents duplicates.

## Prerequisites

- D05-009 must be complete (database migration applied).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- createDelegateRelationship inserts with status INVITED
- createDelegateRelationship rejects duplicate active (physician, delegate) pair
- listDelegatesForPhysician returns only this physician's delegates
- listPhysiciansForDelegate returns only ACTIVE relationships
- updateDelegatePermissions replaces permission set
- updateDelegatePermissions rejects if relationship belongs to different physician
- acceptRelationship sets ACTIVE and accepted_at
- revokeRelationship sets REVOKED with revoked_at and revoked_by

## FRD Reference

- Domain 5 Section 2.6: Delegate Relationships table. Tracks physician-delegate linkage with JSONB permissions. Statuses: ACTIVE, INVITED, REVOKED.
- Domain 5 Section 3: Delegate permission model. 24 permissions, 4 templates, multi-physician delegation.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
