# Task D05-030: Routes â€” provider profile, onboarding, BA, and location endpoints

## What to Build

Create `apps/api/src/domains/provider/provider.routes.ts` and `apps/api/src/domains/provider/provider.handlers.ts`.

**Provider profile routes (auth required, physician or delegate with PROVIDER_VIEW/PROVIDER_EDIT):**
- `GET /api/v1/providers/me` -> getProfileHandler
- `PUT /api/v1/providers/me` -> updateProfileHandler (body: updateProviderSchema)
- `GET /api/v1/providers/me/onboarding-status` -> onboardingStatusHandler
- `POST /api/v1/providers/me/complete-onboarding` -> completeOnboardingHandler

**BA routes (auth required, physician or delegate with appropriate permission):**
- `GET /api/v1/providers/me/bas` -> listBasHandler
- `POST /api/v1/providers/me/bas` -> addBaHandler (body: createBaSchema)
- `PUT /api/v1/providers/me/bas/:id` -> updateBaHandler (body: updateBaSchema, params: baIdParamSchema)
- `DELETE /api/v1/providers/me/bas/:id` -> deactivateBaHandler (params: baIdParamSchema)

**Location routes (auth required):**
- `GET /api/v1/providers/me/locations` -> listLocationsHandler
- `POST /api/v1/providers/me/locations` -> addLocationHandler (body: createLocationSchema)
- `PUT /api/v1/providers/me/locations/:id` -> updateLocationHandler (body: updateLocationSchema, params: locationIdParamSchema)
- `PUT /api/v1/providers/me/locations/:id/set-default` -> setDefaultLocationHandler (params: locationIdParamSchema)
- `DELETE /api/v1/providers/me/locations/:id` -> deactivateLocationHandler (params: locationIdParamSchema)

**Handlers are thin:** validate input (via Zod schema on route), extract providerId from auth context (physician's own ID or delegate's active physician context), call service, format response.

Register routes in the Fastify plugin pattern used by the project. Apply authentication middleware. Apply Zod schema validation on request body/params/query. Follow existing route patterns (check `apps/api/src/domains/iam/` or `apps/api/src/domains/reference/` for reference). See `CLAUDE.md` for coding conventions.

Create integration test files:
- `apps/api/test/integration/provider/profile.integration.ts`
- `apps/api/test/integration/provider/ba.integration.ts`
- `apps/api/test/integration/provider/locations.integration.ts`

## Critical Security Rules

- All /providers/me routes derive providerId from the auth context -- never from a URL parameter. Physician uses their own ID; delegate uses their active physician context.
- PUT /providers/me requires physician role or delegate with PREFERENCE_EDIT permission.
- POST /providers/me/complete-onboarding requires physician role.

## Prerequisites

- D05-020 must be complete (provider profile service).
- D05-021 must be complete (BA service).
- D05-022 must be complete (location service).

## Tests to Write

Create integration tests:

- GET /providers/me returns full profile for authenticated physician
- PUT /providers/me updates profile and returns updated data
- GET /providers/me/onboarding-status returns missing fields for incomplete provider
- POST /providers/me/complete-onboarding succeeds when all required fields set
- POST /providers/me/complete-onboarding fails with missing fields list
- GET /providers/me/bas returns all BAs
- POST /providers/me/bas creates BA with valid data
- POST /providers/me/bas rejects third active BA
- DELETE /providers/me/bas/:id deactivates BA
- POST /providers/me/locations creates location with RRNP lookup
- PUT /providers/me/locations/:id/set-default swaps default
- DELETE /providers/me/locations/:id deactivates location

## FRD Reference

- Domain 5 Section 5.1-5.4: API contracts for provider profile, BAs, locations endpoints.
- Domain 5 Section 9.1-9.2: Onboarding wizard endpoints.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/provider/
```

All tests must pass before outputting [TASK_COMPLETE].
