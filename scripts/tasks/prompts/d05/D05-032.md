# Task D05-032: Routes â€” delegate management endpoints

## What to Build

Add to `apps/api/src/domains/provider/provider.routes.ts` and handlers:

**Delegate routes (auth required, physician role):**
- `GET /api/v1/providers/me/delegates` -> listDelegatesHandler
- `POST /api/v1/providers/me/delegates/invite` -> inviteDelegateHandler (body: inviteDelegateSchema)
- `PUT /api/v1/providers/me/delegates/:rel_id/permissions` -> updateDelegatePermissionsHandler (body: updateDelegatePermissionsSchema, params: delegateRelIdParamSchema)
- `POST /api/v1/providers/me/delegates/:rel_id/revoke` -> revokeDelegateHandler (params: delegateRelIdParamSchema)

**Delegate self-service routes (auth required, delegate role):**
- `GET /api/v1/delegates/me/physicians` -> listPhysiciansHandler
- `POST /api/v1/delegates/me/switch-context/:provider_id` -> switchContextHandler (params: switchContextParamSchema)

**Invitation acceptance (no auth required -- token-based):**
- `POST /api/v1/delegates/invitations/:token/accept` -> acceptInvitationHandler (body: acceptInvitationSchema)

All handlers follow the thin handler pattern. Register routes in the Fastify plugin. Note that delegate management routes require physician role, delegate self-service routes require delegate role, and invitation acceptance is unauthenticated. Follow existing route patterns. See `CLAUDE.md` for coding conventions.

Create integration test file:
- `apps/api/test/integration/provider/delegates.integration.ts`

## Critical Security Rules

- Physician delegate management routes require physician role.
- Delegate self-service routes require delegate role.
- Invitation acceptance is unauthenticated -- secured by the token.
- Context switching logs audit event and verifies active relationship.

## Prerequisites

- D05-025 must be complete (delegate management service).

## Tests to Write

Create integration tests:

- GET /providers/me/delegates returns all delegate relationships
- POST /providers/me/delegates/invite creates invitation
- POST /providers/me/delegates/invite as delegate returns 403
- PUT /providers/me/delegates/:rel_id/permissions updates permissions
- POST /providers/me/delegates/:rel_id/revoke sets REVOKED
- GET /delegates/me/physicians returns linked physicians for delegate
- POST /delegates/me/switch-context/:id succeeds with active relationship
- POST /delegates/me/switch-context/:id fails without active relationship
- POST /delegates/invitations/:token/accept activates relationship
- POST /delegates/invitations/:token/accept rejects expired token

## FRD Reference

- Domain 5 Section 3: Delegate permission model. 24 permissions, 4 templates, multi-physician delegation.
- Domain 5 Section 4.2 PRV-005 through PRV-009: Delegate user stories.
- Domain 5 Section 5.5: Delegate management API contracts.

## Run After Completion

```bash
pnpm --filter api vitest run test/integration/provider/
```

All tests must pass before outputting [TASK_COMPLETE].
