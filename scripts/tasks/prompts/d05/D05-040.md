# Task D05-040: Security â€” authentication enforcement on every route

## What to Build

Create `apps/api/test/security/provider/provider.authn.security.ts`.

Test every authenticated route in the Provider Management domain returns 401 without a valid session cookie:

**Provider profile routes:**
- GET /api/v1/providers/me -- no cookie -> 401
- GET /api/v1/providers/me -- expired cookie -> 401
- GET /api/v1/providers/me -- tampered cookie -> 401
- PUT /api/v1/providers/me -- no cookie -> 401
- GET /api/v1/providers/me/onboarding-status -- no cookie -> 401
- GET /api/v1/providers/me/onboarding-status -- expired cookie -> 401
- POST /api/v1/providers/me/complete-onboarding -- no cookie -> 401
- POST /api/v1/providers/me/complete-onboarding -- expired cookie -> 401

**BA routes:**
- GET /api/v1/providers/me/bas -- no cookie -> 401
- GET /api/v1/providers/me/bas -- expired cookie -> 401
- POST /api/v1/providers/me/bas -- no cookie -> 401
- PUT /api/v1/providers/me/bas/:id -- no cookie -> 401
- DELETE /api/v1/providers/me/bas/:id -- no cookie -> 401

**Location routes:**
- GET /api/v1/providers/me/locations -- no cookie -> 401
- GET /api/v1/providers/me/locations -- expired cookie -> 401
- POST /api/v1/providers/me/locations -- no cookie -> 401
- PUT /api/v1/providers/me/locations/:id -- no cookie -> 401
- PUT /api/v1/providers/me/locations/:id/set-default -- no cookie -> 401
- DELETE /api/v1/providers/me/locations/:id -- no cookie -> 401

**WCB routes:**
- GET /api/v1/providers/me/wcb -- no cookie -> 401
- POST /api/v1/providers/me/wcb -- no cookie -> 401
- PUT /api/v1/providers/me/wcb/:id -- no cookie -> 401
- DELETE /api/v1/providers/me/wcb/:id -- no cookie -> 401
- GET /api/v1/providers/me/wcb/form-permissions -- no cookie -> 401

**Delegate routes:**
- GET /api/v1/providers/me/delegates -- no cookie -> 401
- POST /api/v1/providers/me/delegates/invite -- no cookie -> 401
- PUT /api/v1/providers/me/delegates/:rel_id/permissions -- no cookie -> 401
- POST /api/v1/providers/me/delegates/:rel_id/revoke -- no cookie -> 401

**Preferences and H-Link routes:**
- GET /api/v1/providers/me/submission-preferences -- no cookie -> 401
- PUT /api/v1/providers/me/submission-preferences -- no cookie -> 401
- GET /api/v1/providers/me/hlink -- no cookie -> 401
- PUT /api/v1/providers/me/hlink -- no cookie -> 401

**Delegate self-service routes:**
- GET /api/v1/delegates/me/physicians -- no cookie -> 401
- POST /api/v1/delegates/me/switch-context/:provider_id -- no cookie -> 401

**Verification for each test:**
1. Response status is 401.
2. Response body contains only an error object (e.g., `{ error: "Unauthorized" }`).
3. Response body does NOT contain any provider data or internal details.
4. No `Set-Cookie` header in 401 responses (don't create sessions for unauthenticated requests).

Note: POST /api/v1/delegates/invitations/:token/accept is intentionally unauthenticated (token-based) and is NOT tested here.

Use the test helpers/fixtures from the project for creating test app instances. Follow the security test patterns established in Domain 1 (check `apps/api/test/security/iam/` for reference). See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- 401 responses must not contain any data in the response body beyond the error object.
- Tampered cookies must be rejected (invalid signature / hash mismatch).
- Expired sessions must return 401 (not 200 with stale data).

## Prerequisites

- D05-030 must be complete (profile, BA, location routes).
- D05-031 must be complete (WCB, preferences, H-Link routes).
- D05-032 must be complete (delegate routes).
- D05-033 must be complete (internal routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/provider/provider.authn.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
