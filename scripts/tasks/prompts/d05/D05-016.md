# Task D05-016: Repository â€” provider context queries (internal API)

## What to Build

Add to `apps/api/src/domains/provider/provider.repository.ts`:

- `getFullProviderContext(providerId: string)` -- single query (or optimised multi-query) that returns the complete ProviderContext object: provider record, all active BAs, default location, all active locations, PCPCM enrolment status, all WCB configs, default WCB config, submission preferences, H-Link config.
- `getBaForClaim(providerId: string, claimType: 'AHCIP' | 'WCB', hscCode?: string)` -- return the correct BA number. For AHCIP: if PCPCM enrolled and hscCode provided, look up basket classification (via Reference Data) to determine PCPCM vs FFS BA. For WCB: return primary BA.
- `getWcbConfigForForm(providerId: string, formId: string)` -- find the WCB configuration whose permitted_form_types includes the given formId. Return Contract ID, Role code, or null if not permitted.

These are the core queries consumed by Domain 4 (Claim Lifecycle) via the internal API.

Use Drizzle ORM query builder. Join across provider tables to assemble the full context efficiently. Follow existing repository patterns. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- Internal API queries are still scoped to providerId -- no cross-provider data access even for service-to-service calls.
- PCPCM basket routing lookup should use the SOMB version effective at the date of service, not current.

## Prerequisites

- D05-010 must be complete (provider CRUD).
- D05-011 must be complete (BA management).
- D05-012 must be complete (location management).
- D05-013 must be complete (PCPCM and WCB configuration).
- D05-015 must be complete (submission preferences and H-Link).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- getFullProviderContext returns complete context for active provider
- getFullProviderContext returns null for unknown provider
- getBaForClaim returns FFS BA for non-PCPCM physician
- getBaForClaim returns PCPCM BA for in-basket HSC code
- getBaForClaim returns FFS BA for out-of-basket HSC code
- getBaForClaim returns FFS BA when HSC code has no basket classification
- getWcbConfigForForm returns matching config for permitted form
- getWcbConfigForForm returns null for non-permitted form

## FRD Reference

- Domain 5 Section 6: Provider Context Object -- 17 fields consumed by Domain 4 (Claim Lifecycle).
- Domain 5 Section 7.1: PCPCM routing decision -- in-basket -> PCPCM BA, out-of-basket -> FFS BA.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
