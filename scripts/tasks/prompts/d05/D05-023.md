# Task D05-023: Service â€” PCPCM routing logic

## What to Build

Add to `apps/api/src/domains/provider/provider.service.ts`:

- `routeClaimToBa(providerId: string, claimType: 'AHCIP' | 'WCB', hscCode?: string, dateOfService?: string)` -- determine the correct BA for a claim:
  1. If claimType = WCB: return primary BA number.
  2. If claimType = AHCIP and physician NOT PCPCM-enrolled: return FFS BA number.
  3. If claimType = AHCIP and physician IS PCPCM-enrolled:
     a. Look up HSC code's PCPCM basket classification from Reference Data (using SOMB version effective at dateOfService).
     b. If in-basket: return PCPCM BA number.
     c. If out-of-basket: return FFS BA number.
     d. If no classification (rare edge case): return FFS BA number + warning flag.

- `isPcpcmEnrolled(providerId: string)` -- check if provider has active PCPCM enrolment.

**Critical:** The SOMB version in effect at the date of service governs the basket classification, NOT the current SOMB version. This prevents retroactive reclassification.

**Return type for routeClaimToBa:**
```typescript
{
  ba_number: string;
  ba_type: 'FFS' | 'PCPCM';
  routing_reason: 'WCB_PRIMARY' | 'NON_PCPCM' | 'IN_BASKET' | 'OUT_OF_BASKET' | 'UNCLASSIFIED';
  warning?: string;  // Only set for UNCLASSIFIED edge case
}
```

Import repository functions and Reference Data service for PCPCM basket lookups. Follow existing service patterns. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-011 must be complete (BA repository).
- D05-013 must be complete (PCPCM enrolment repository).
- D05-016 must be complete (provider context queries).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- routeClaimToBa returns FFS BA for non-PCPCM physician
- routeClaimToBa returns PCPCM BA for in-basket HSC code
- routeClaimToBa returns FFS BA for out-of-basket HSC code
- routeClaimToBa returns FFS BA with warning for unclassified HSC code
- routeClaimToBa uses SOMB version effective at dateOfService
- routeClaimToBa returns primary BA for WCB claims
- isPcpcmEnrolled returns true for enrolled provider
- isPcpcmEnrolled returns false for non-enrolled provider

## FRD Reference

- Domain 5 Section 7.1: PCPCM routing decision -- in-basket -> PCPCM BA, out-of-basket -> FFS BA, no classification -> FFS BA with warning.
- Domain 5 Section 7.2: Batch assembly impact -- PCPCM physicians generate two separate batches per Thursday cycle.
- Domain 5 Section 7.3: BA routing displayed in UI, updates in real-time on HSC code change.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
