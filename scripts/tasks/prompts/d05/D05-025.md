# Task D05-025: Service â€” delegate management (invitation, acceptance, revocation)

## What to Build

Add to `apps/api/src/domains/provider/provider.service.ts`:

- `inviteDelegate(physicianId: string, email: string, permissions: string[], actorId: string)` -- validate permissions are from the 24-key catalogue. Create delegate_relationships record with status INVITED. Generate single-use invitation token (7-day expiry, hash stored). Emit DELEGATE_INVITED notification event. Emit delegate.invited audit event.
- `acceptInvitation(token: string, delegateUserId: string)` -- validate token (hash comparison), check not expired (7 days), check not already accepted. Set status = ACTIVE, accepted_at = now(). Emit delegate.accepted audit event.
- `listDelegates(physicianId: string)` -- return all delegates with permissions, status, invited_at, accepted_at.
- `updateDelegatePermissions(physicianId: string, relationshipId: string, permissions: string[], actorId: string)` -- validate permissions from catalogue. Update JSONB. Emit delegate.permissions_changed audit event with old vs new permissions.
- `revokeDelegate(physicianId: string, relationshipId: string, actorId: string)` -- set REVOKED. Emit delegate.revoked audit event. Emit DELEGATE_REVOKED notification. Note: actual session revocation handled by Domain 1 -- emit event for Domain 1 to consume.
- `listPhysiciansForDelegate(delegateUserId: string)` -- return list of physicians with permissions per physician.
- `switchPhysicianContext(delegateUserId: string, physicianId: string)` -- verify active relationship exists. Return updated auth context data for Domain 1. Emit delegate.context_switched audit event.

**Invitation token flow:**
1. Generate a cryptographically random token (e.g., `crypto.randomBytes(32).toString('hex')`).
2. Hash the token (SHA-256) and store the hash in the database alongside the relationship.
3. Send the raw token to the delegate via email (Domain 9 notification).
4. On acceptance: hash the incoming token and compare to stored hash.
5. Token expires after 7 days from invited_at.

Import repository functions, provider constants (DELEGATE_PERMISSION_KEYS), and audit constants. Follow existing service patterns. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- Invitation tokens are single-use, 7-day expiry, stored as hash.
- Permission changes take effect immediately -- next API call uses new permissions.
- Delegate revocation must trigger session invalidation in Domain 1 (event-driven).
- Context switching is explicit and logged -- no implicit cross-physician access.

## Prerequisites

- D05-014 must be complete (delegate relationships repository).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- inviteDelegate creates relationship with INVITED status
- inviteDelegate validates permissions against catalogue
- inviteDelegate rejects invalid permission keys
- acceptInvitation activates relationship
- acceptInvitation rejects expired token (>7 days)
- acceptInvitation rejects already-accepted invitation
- updateDelegatePermissions updates JSONB and logs old/new diff
- updateDelegatePermissions rejects if relationship not owned by physician
- revokeDelegate sets REVOKED and emits events
- listPhysiciansForDelegate returns only ACTIVE relationships
- switchPhysicianContext succeeds with active relationship
- switchPhysicianContext fails without active relationship

## FRD Reference

- Domain 5 Section 3: Delegate permission model. 24 permissions, 4 templates, multi-physician delegation.
- Domain 5 Section 4.2 PRV-005 through PRV-009: Delegate user stories.
- Domain 5 Section 11.5: Delegate test requirements.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
