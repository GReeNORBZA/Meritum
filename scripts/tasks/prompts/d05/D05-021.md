# Task D05-021: Service â€” business arrangement management with PCPCM constraints

## What to Build

Add to `apps/api/src/domains/provider/provider.service.ts`:

- `addBa(providerId: string, data: CreateBaInput, actorId: string)` -- validate: max 2 active BAs, ba_number format, ba_number uniqueness. If ba_type = PCPCM: validate a FFS BA exists (or is being added simultaneously). Emit ba.added audit event.
- `updateBa(providerId: string, baId: string, data: UpdateBaInput, actorId: string)` -- update BA fields. Validate status transitions: PENDING -> ACTIVE -> INACTIVE. Emit ba.updated audit event.
- `deactivateBa(providerId: string, baId: string, actorId: string)` -- set INACTIVE. If this is the PCPCM BA: also withdraw the PCPCM enrolment. Verify no pending claims reference this BA. Emit ba.deactivated audit event.
- `listBas(providerId: string)` -- return all BAs for the provider.

**PCPCM Dual-BA Flow:**
When a physician adds a PCPCM BA, the service enforces:
1. A FFS BA must already exist OR be provided in the same request.
2. A pcpcm_enrolments record is created linking both BAs.
3. The FFS BA is marked as primary.

**Status transitions:**
- PENDING -> ACTIVE (valid)
- ACTIVE -> INACTIVE (valid, via deactivateBa)
- ACTIVE -> PENDING (invalid -- rejected)
- INACTIVE -> any (invalid -- rejected)

Import repository functions and audit constants. Follow existing service patterns. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-011 must be complete (BA repository).
- D05-013 must be complete (PCPCM enrolment repository).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- addBa creates BA with valid data
- addBa rejects third active BA
- addBa rejects PCPCM without existing FFS BA
- addBa creates PCPCM enrolment when adding PCPCM BA
- addBa rejects duplicate ba_number across system
- updateBa validates status transitions (PENDING -> ACTIVE OK, ACTIVE -> PENDING rejected)
- deactivateBa sets INACTIVE and end_date
- deactivateBa withdraws PCPCM enrolment when deactivating PCPCM BA
- deactivateBa emits audit event

## FRD Reference

- Domain 5 Section 2.2: Max 2 active BAs. PCPCM requires paired FFS BA. ba_number unique across active records.
- Domain 5 Section 4.1 PRV-002: BA setup during onboarding with validation.
- Domain 5 Section 11.2: BA test requirements including PCPCM constraints and status transitions.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
