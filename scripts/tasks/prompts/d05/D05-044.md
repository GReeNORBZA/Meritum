# Task D05-044: Security â€” data leakage prevention

## What to Build

Create `apps/api/test/security/provider/provider.leakage.security.ts`.

**Credential leakage prevention:**
- GET /api/v1/providers/me/hlink response does NOT contain credential_secret_ref
- GET /api/v1/providers/me (full profile) does NOT contain credential_secret_ref
- GET /api/v1/internal/providers/:id/claim-context does NOT contain credential_secret_ref
- Verify by checking response body keys recursively -- credential_secret_ref must not appear at any nesting level

**Error response sanitisation:**
- 401 response body contains only error object, no provider data
- 404 response for cross-user resource does not confirm resource exists (same error shape as genuinely missing resource)
- 500 error does not expose stack traces, SQL errors, or internal details (trigger a 500 via malformed internal state if possible, or verify error handler configuration)
- Validation errors (400) do not expose database column names (e.g., should say "Invalid billing number" not "column billing_number constraint violation")

**Header checks:**
- Verify no X-Powered-By header in responses
- Verify no Server header revealing version/technology
- All responses include appropriate Content-Type header (application/json)

**Sensitive data not in responses:**
- Delegate list response (GET /api/v1/providers/me/delegates) does not expose delegate's password_hash from joined users table
- Delegate list response does not expose delegate's email verification tokens or session data
- Audit log entries for credential changes do not contain actual credential values
- Internal API responses do not leak other providers' data in error messages

**Anti-enumeration:**
- POST /api/v1/providers/me/delegates/invite with existing delegate's email returns consistent response timing and shape (no leakage of whether email is already a delegate for this or another physician)
- Invalid provider_id in internal routes returns same error shape regardless of whether the ID format is valid but non-existent vs. actually existing for another provider

**Verification for each test:**
1. Sensitive fields are absent from response bodies.
2. Error responses are generic and do not reveal internal state.
3. Response headers do not leak technology details.

Use the test helpers/fixtures for creating authenticated sessions and test data. Follow the security test patterns established in prior domains. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-030 must be complete (profile, BA, location routes).
- D05-031 must be complete (WCB, preferences, H-Link routes).
- D05-032 must be complete (delegate routes).
- D05-033 must be complete (internal routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/provider/provider.leakage.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
