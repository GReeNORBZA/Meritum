# Task D05-022: Service â€” practice location management with RRNP eligibility

## What to Build

Add to `apps/api/src/domains/provider/provider.service.ts`:

- `addLocation(providerId: string, data: CreateLocationInput, actorId: string)` -- create location. If community_code provided: look up RRNP eligibility and rate from Reference Data (Domain 2). Set rrnp_eligible and rrnp_rate. If no community_code: rrnp_eligible = false. If this is the first location: auto-set as default. Emit location.added audit event.
- `updateLocation(providerId: string, locationId: string, data: UpdateLocationInput, actorId: string)` -- update fields. If community_code changed: re-derive RRNP eligibility and rate. Emit location.updated audit event with changes.
- `setDefaultLocation(providerId: string, locationId: string, actorId: string)` -- set as default. Unset previous default in transaction.
- `deactivateLocation(providerId: string, locationId: string, actorId: string)` -- soft-delete. If was default, clear default. Emit location.deactivated. Existing claims using this location are unaffected.
- `listLocations(providerId: string)` -- return all locations.
- `listActiveLocations(providerId: string)` -- return active locations (for claim creation dropdown).
- `refreshRrnpRates(providerId: string)` -- re-derive RRNP eligibility and rates for all active locations from Reference Data. Called quarterly or on demand.

**RRNP eligibility lookup:**
When a community_code is provided, call the Reference Data domain (Domain 2) RRNP community lookup to determine if the community qualifies for Rural/Remote Northern Program rates. Cache the rate on the location record. Re-derive quarterly or when Reference Data publishes a new RRNP version.

Import repository functions and audit constants. Follow existing service patterns. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-012 must be complete (location repository).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- addLocation creates location and derives RRNP eligibility
- addLocation without community_code sets rrnp_eligible false
- addLocation auto-sets default for first location
- updateLocation re-derives RRNP when community_code changes
- setDefaultLocation swaps default in transaction
- deactivateLocation clears default if was default
- deactivateLocation does not affect existing claims
- refreshRrnpRates updates all active locations

## FRD Reference

- Domain 5 Section 2.3: Practice locations with RRNP eligibility derived from community_code.
- Domain 5 Section 8: Locum support -- multi-location management with per-claim location selection.
- Domain 5 Section 11.3: Location test requirements.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
