# Task D05-020: Service â€” provider profile management and onboarding

## What to Build

Create `apps/api/src/domains/provider/provider.service.ts` with provider profile functions:

- `getProviderProfile(providerId: string)` -- return full provider profile including BAs, locations, WCB configs, PCPCM status, RRNP eligibility, submission preferences, H-Link config. Compose from repository calls.
- `updateProviderProfile(providerId: string, data: UpdateProviderInput, actorId: string)` -- update profile fields. Emit provider.profile_updated audit event with field-level diff (old vs new). If specialty changes, note that validation context updates for future claims.
- `getOnboardingStatus(providerId: string)` -- return checklist of required fields (billing_number, cpsa_registration, specialty, physician_type, at least 1 BA, at least 1 location, IMA acknowledgement) with completion status per field.
- `completeOnboarding(providerId: string)` -- validate all required fields are set (steps 1-4 and 7). If valid: set onboarding_completed = true, emit provider.onboarding_completed audit event. If invalid: return list of missing fields.
- `createProviderFromOnboarding(userId: string, data: OnboardingProfileInput)` -- create the provider record during the onboarding wizard. Called from the first onboarding step. Sets provider_id = userId.

**Onboarding steps (reference):**
1. Professional Identity (billing_number, cpsa_registration_number)
2. Specialty & Type (specialty_code, physician_type)
3. Business Arrangement (at least 1 BA)
4. Primary Location (at least 1 location)
5. WCB Config (optional)
6. Submission Preferences (defaults applied automatically)
7. IMA Generation (acknowledgement required)

Import repository functions from `provider.repository.ts`. Import audit action identifiers from `packages/shared/src/constants/provider.constants.ts`. Follow existing service patterns in the codebase (check `apps/api/src/domains/iam/` or `apps/api/src/domains/reference/` for reference). See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- createProviderFromOnboarding sets provider_id = userId, establishing the 1:1 link between IAM and Provider.
- updateProviderProfile logs field-level diffs to audit trail -- captures old and new values.

## Prerequisites

- D05-010 must be complete (provider CRUD repository).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- getProviderProfile returns complete profile for active provider
- updateProviderProfile updates fields and emits audit event
- updateProviderProfile captures field-level diff in audit detail
- getOnboardingStatus reports missing fields accurately
- completeOnboarding succeeds when all required fields populated
- completeOnboarding fails listing missing fields
- createProviderFromOnboarding creates provider with provider_id = userId

## FRD Reference

- Domain 5 Section 9.1-9.2: 7-step onboarding wizard. Steps 1-4 and 7 required. Steps 5-6 optional. Onboarding_completed blocks claim creation until true.
- Domain 5 Section 4.1 PRV-001: Guided wizard for professional identity setup.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
