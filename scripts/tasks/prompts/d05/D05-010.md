# Task D05-010: Repository â€” provider CRUD operations

## What to Build

Create `apps/api/src/domains/provider/provider.repository.ts` with provider operations:

- `createProvider(data: InsertProvider)` -- insert provider record. provider_id must match the user_id from Domain 1.
- `findProviderById(providerId: string)` -- find provider by ID. Return null if not found.
- `findProviderByBillingNumber(billingNumber: string)` -- find provider by billing number. Used for uniqueness validation.
- `findProviderByCpsaNumber(cpsaNumber: string)` -- find by CPSA registration number.
- `updateProvider(providerId: string, data: Partial<InsertProvider>)` -- update provider fields. Set updated_at to now().
- `completeOnboarding(providerId: string)` -- set onboarding_completed = true. Validate all required fields are populated before setting.
- `getOnboardingStatus(providerId: string)` -- return which required fields are populated and which are missing.

All queries are scoped to a single provider_id -- no cross-provider queries at this layer.

Use Drizzle ORM query builder with the provider schema from `packages/shared/src/schemas/db/provider.schema.ts`. Accept a Drizzle database instance via dependency injection (constructor parameter or function parameter). Follow existing repository patterns in the codebase (check `apps/api/src/domains/iam/` for reference).

Create `apps/api/src/domains/provider/provider.test.ts` with unit tests.

## Critical Security Rules

- All queries must be parameterised -- no string interpolation for provider_id or billing_number.
- findProviderById returns null if not found -- callers must check and return 404.

## Prerequisites

- D05-009 must be complete (database migration applied, all tables exist).

## Tests to Write

Create tests in `apps/api/src/domains/provider/provider.test.ts`:

- createProvider inserts provider record
- createProvider rejects duplicate billing_number
- createProvider rejects duplicate cpsa_registration_number
- findProviderById returns provider for valid ID
- findProviderById returns null for unknown ID
- updateProvider updates fields and updated_at
- completeOnboarding sets onboarding_completed true
- completeOnboarding fails if required fields missing
- getOnboardingStatus reports missing fields accurately

## FRD Reference

- Domain 5 Section 2.1: Providers table. One row per physician. Linked 1:1 to users table.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
