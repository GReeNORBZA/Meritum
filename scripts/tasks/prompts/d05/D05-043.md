# Task D05-043: Security â€” input validation and injection prevention

## What to Build

Create `apps/api/test/security/provider/provider.input.security.ts`.

**SQL injection payloads on all string inputs:**
- billing_number: `'; DROP TABLE providers;--` -> 400 (rejected by validation)
- ba_number: `' OR 1=1--` -> 400
- functional_centre: SQL injection payloads -> 400
- name fields (first_name, last_name, location name): SQL injection payloads -> 400 or stored safely (parameterised queries prevent execution)
- contract_id: `'; DELETE FROM wcb_configurations;--` -> 400

**XSS payloads on all stored text fields:**
- first_name: `<script>alert(1)</script>` -> stored safely, never rendered as HTML
- location name: `<img onerror=alert(1) src=x>` -> stored safely
- specialty_description: XSS payloads -> stored safely
- Verify that if XSS payloads are stored (after passing length validation), they are returned as-is (not executed) and the response Content-Type is application/json

**Type coercion attacks:**
- Send number where string expected (e.g., `{ "first_name": 12345 }`) -> 400
- Send array where string expected (e.g., `{ "billing_number": ["a","b"] }`) -> 400
- Send null where required field expected -> 400
- Send negative panel_size to PCPCM enrolment update -> 400
- Send deadline_reminder_days = 0 -> 400 (min is 1)
- Send deadline_reminder_days = 31 -> 400 (max is 30)
- Send deadline_reminder_days = 15.5 (float) -> 400 (must be int)

**Format validation:**
- billing_number with letters (e.g., "ABC123") -> 400
- billing_number exceeding 10 characters -> 400
- ba_type with invalid value (e.g., "INVALID") -> 400
- physician_type with invalid value (e.g., "NURSE") -> 400
- submission_mode with invalid value (e.g., "AUTO") -> 400
- accreditation_status with invalid value -> 400

**UUID parameter validation:**
- PUT /api/v1/providers/me/bas/not-a-uuid -> 400
- PUT /api/v1/providers/me/locations/not-a-uuid -> 400
- DELETE /api/v1/providers/me/wcb/not-a-uuid -> 400
- PUT /api/v1/providers/me/delegates/not-a-uuid/permissions -> 400

**Permission array validation:**
- Delegate invite with empty permissions array `{ "permissions": [] }` -> 400
- Delegate invite with invalid permission key `{ "permissions": ["INVALID_PERM"] }` -> 400
- Delegate invite with duplicate permission keys -> deduplicated or rejected
- Delegate invite with permissions as string instead of array -> 400

**Verification for each test:**
1. Malicious input is rejected with 400 status.
2. Error response does not expose internal details (no SQL error messages, no stack traces).
3. Database is not corrupted by any injection attempt.

Use the test helpers/fixtures for creating authenticated sessions. Follow the security test patterns established in prior domains. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-030 must be complete (profile, BA, location routes).
- D05-031 must be complete (WCB, preferences routes).
- D05-032 must be complete (delegate routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/provider/provider.input.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
