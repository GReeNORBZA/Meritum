# Task D05-042: Security â€” cross-user isolation (physician tenant scoping) -- MOST CRITICAL

## What to Build

Create `apps/api/test/security/provider/provider.scoping.security.ts`.

Create two physician accounts (physician1, physician2) using createSecurityPair fixture or equivalent test setup.

**Provider profile isolation:**
- GET /api/v1/providers/me as physician1 returns physician1's data, not physician2's

**BA isolation:**
- Physician1 cannot see physician2's BAs via GET /api/v1/providers/me/bas
- Physician1 cannot update physician2's BA by guessing ba_id via PUT /api/v1/providers/me/bas/:id -> 404
- Physician1 cannot deactivate physician2's BA via DELETE /api/v1/providers/me/bas/:id -> 404

**Location isolation:**
- Physician1 cannot see physician2's locations via GET /api/v1/providers/me/locations
- Physician1 cannot modify physician2's location by guessing location_id via PUT /api/v1/providers/me/locations/:id -> 404
- Physician1 cannot set physician2's location as default via PUT /api/v1/providers/me/locations/:id/set-default -> 404
- Physician1 cannot deactivate physician2's location via DELETE /api/v1/providers/me/locations/:id -> 404

**WCB config isolation:**
- Physician1 cannot see physician2's WCB configs via GET /api/v1/providers/me/wcb
- Physician1 cannot delete physician2's WCB config via DELETE /api/v1/providers/me/wcb/:id -> 404
- Physician1 cannot update physician2's WCB config via PUT /api/v1/providers/me/wcb/:id -> 404

**Delegate isolation:**
- Physician1 cannot see physician2's delegates via GET /api/v1/providers/me/delegates
- Physician1 cannot revoke physician2's delegate via POST /api/v1/providers/me/delegates/:rel_id/revoke -> 404
- Physician1 cannot modify physician2's delegate permissions via PUT /api/v1/providers/me/delegates/:rel_id/permissions -> 404

**Delegate cross-context isolation:**
- Create delegate linked to physician1 only
- Delegate cannot switch to physician2 context (no active relationship) -> 403
- If delegate linked to both: data in physician1 context does not leak into physician2 context (verify separate data sets returned for each context)

**Submission preferences and H-Link isolation:**
- Physician1 cannot see physician2's submission preferences
- Physician1 cannot see physician2's H-Link config

**IMPORTANT:** All cross-user access attempts return 404, not 403 (do not confirm resource existence to unauthorized users).

Use the test helpers/fixtures for creating isolated physician accounts with separate data. Follow the security test patterns established in prior domains. See `CLAUDE.md` for coding conventions.

## Critical Security Rules

- This is the MOST CRITICAL security test file. Tenant isolation failure = data breach.
- Cross-user access must always return 404 (not 403) to prevent resource enumeration.
- Delegate context switching must enforce active relationship check.

## Prerequisites

- D05-030 must be complete (profile, BA, location routes).
- D05-031 must be complete (WCB, preferences, H-Link routes).
- D05-032 must be complete (delegate routes).
- D05-033 must be complete (internal routes).

## Run After Completion

```bash
pnpm --filter api vitest run test/security/provider/provider.scoping.security.ts
```

All tests must pass before outputting [TASK_COMPLETE].
