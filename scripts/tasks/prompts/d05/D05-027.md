# Task D05-027: Service â€” provider context (internal API for claim lifecycle)

## What to Build

Add to `apps/api/src/domains/provider/provider.service.ts`:

- `getProviderContext(providerId: string)` -- assemble the full ProviderContext object (Section 6 of FRD). Cached per request, invalidated on any provider data change. Returns all 17 fields:
  - provider_id, billing_number, specialty_code, physician_type
  - bas[] (all active BAs)
  - default_location, all_locations[] (all active locations)
  - pcpcm_enrolled, pcpcm_ba_number, ffs_ba_number
  - wcb_configs[], default_wcb_config
  - submission_preferences
  - hlink_accreditation_status, hlink_submitter_prefix
  - onboarding_completed, status

- `getBaForClaim(providerId: string, claimType: string, hscCode?: string, dateOfService?: string)` -- delegate to routeClaimToBa. Return `{ ba_number, ba_type, routing_reason }`.

- `getWcbConfigForForm(providerId: string, formId: string)` -- delegate to repository. Return `{ contract_id, role_code, skill_code }` or throw if not permitted.

**Caching strategy:**
- Provider context is computed once per request and stored on the Fastify request object (e.g., `request.providerContext`).
- Invalidated when any provider data changes (profile, BA, location, WCB config, preferences).
- RRNP rate changes (quarterly) and PCPCM basket classification updates (SOMB update) trigger a cache refresh.

Import repository functions, routeClaimToBa from this service, and the ProviderContext type from shared schemas. Follow existing service patterns. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-016 must be complete (provider context repository queries).
- D05-023 must be complete (PCPCM routing logic).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- getProviderContext returns complete context with all 17 fields
- getProviderContext returns null for unknown provider
- getProviderContext reflects latest BA changes
- getBaForClaim delegates to PCPCM routing logic
- getWcbConfigForForm returns matching config
- getWcbConfigForForm throws for non-permitted form

## FRD Reference

- Domain 5 Section 6: Provider Context Object -- 17 fields consumed by Domain 4.
- Domain 5 Section 5.8: Internal Provider Context API endpoints.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
