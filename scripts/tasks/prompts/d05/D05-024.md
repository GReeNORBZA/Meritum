# Task D05-024: Service â€” WCB configuration management

## What to Build

Add to `apps/api/src/domains/provider/provider.service.ts`:

- `addWcbConfig(providerId: string, data: CreateWcbConfigInput, actorId: string)` -- validate contract_id and role_code against WCB Contract ID/Role/Form ID matrix (from Reference Data Domain 2). Auto-populate permitted_form_types from the matrix. Emit wcb_config.added audit event.
- `updateWcbConfig(providerId: string, wcbConfigId: string, data: UpdateWcbConfigInput, actorId: string)` -- update skill_code or default status. Emit wcb_config.updated.
- `removeWcbConfig(providerId: string, wcbConfigId: string, actorId: string)` -- delete WCB config. Verify no pending WCB claims reference this config. Emit wcb_config.removed with Contract ID and Role in audit detail.
- `listWcbConfigs(providerId: string)` -- list all configs.
- `getFormPermissions(providerId: string)` -- return aggregated permitted form types across all Contract IDs.
- `getWcbConfigForForm(providerId: string, formId: string)` -- find the matching Contract ID/Role for a given form type. Return null if not permitted.

**WCB Matrix validation:**
When adding a WCB configuration, the service must:
1. Validate that the (contract_id, role_code) combination exists in the WCB matrix from Reference Data.
2. Auto-populate permitted_form_types from the matrix for that combination.
3. Reject invalid combinations with a descriptive error.

Import repository functions, Reference Data service for WCB matrix lookup, and audit constants. Follow existing service patterns. See `CLAUDE.md` for coding conventions.

## Prerequisites

- D05-013 must be complete (WCB configuration repository).

## Tests to Write

Add tests in `apps/api/src/domains/provider/provider.test.ts`:

- addWcbConfig validates against WCB matrix
- addWcbConfig auto-populates permitted_form_types
- addWcbConfig rejects duplicate (provider, contract_id)
- updateWcbConfig updates skill_code
- removeWcbConfig deletes config scoped to provider
- removeWcbConfig rejects if pending claims reference config
- getFormPermissions returns union of all permitted forms
- getWcbConfigForForm returns matching config
- getWcbConfigForForm returns null for non-permitted form

## FRD Reference

- Domain 5 Section 2.5: WCB configurations. Multiple Contract IDs per provider.
- Domain 5 Section 4.1 PRV-004: WCB setup with Contract ID dropdown and auto-populated form types.
- Domain 5 Section 11.4: WCB configuration test requirements.

## Run After Completion

```bash
pnpm --filter api vitest run src/domains/provider/provider.test.ts
```

All tests must pass before outputting [TASK_COMPLETE].
